name: Policy
display_name: Insurance Policy
description: |
  Core insurance policy record representing a contract between
  insurer and policyholder. Tracks coverage, premiums, and lifecycle.

domain: insurance
subdomain: policy
category: entities
version: "1.0.0"
status: active

database:
  table_name: policies
  primary_key: id
  indexes:
    - columns: [policy_number]
      unique: true
    - columns: [policyholder_id]
    - columns: [product_id]
    - columns: [status]
    - columns: [effective_date]
    - columns: [expiry_date]
    - columns: [agent_id]

attributes:
  # Identifiers
  - name: id
    type: uuid
    required: true
    generated: true

  - name: policy_number
    type: string
    description: Human-readable policy number
    pattern: "POL-[A-Z0-9]{8}"
    example: "POL-LF2024001"
    required: true
    unique: true

  - name: product_id
    type: uuid
    description: Insurance product
    required: true

  - name: quote_id
    type: uuid
    description: Original quote

  - name: application_id
    type: uuid
    description: Originating application

  # Status
  - name: status
    type: enum
    description: Policy status
    values:
      - draft
      - pending_payment
      - pending_approval
      - active
      - lapsed
      - reinstated
      - cancelled
      - expired
      - matured
      - surrendered
      - paid_up
    default: draft

  - name: policy_type
    type: enum
    description: Policy category
    values:
      - individual
      - group
      - corporate
    default: individual

  # Parties
  - name: policyholder_id
    type: uuid
    description: Policy owner
    required: true

  - name: insured_ids
    type: array
    description: Persons covered by policy
    items:
      type: uuid

  - name: primary_insured_id
    type: uuid
    description: Main insured person

  - name: beneficiary_ids
    type: array
    description: Policy beneficiaries
    items:
      type: uuid

  # Sales channel
  - name: agent_id
    type: uuid
    description: Selling agent

  - name: broker_id
    type: uuid
    description: Insurance broker

  - name: channel
    type: enum
    description: Sales channel
    values:
      - direct
      - agent
      - broker
      - bancassurance
      - online
      - telesales
      - partnership

  # Dates
  - name: issue_date
    type: date
    description: When policy was issued

  - name: effective_date
    type: date
    description: Coverage start date
    required: true

  - name: expiry_date
    type: date
    description: Coverage end date
    required: true

  - name: inception_date
    type: date
    description: Original policy start (for renewals)

  - name: policy_term_months
    type: integer
    description: Policy term in months
    minimum: 1

  - name: policy_term_years
    type: integer
    description: Policy term in years
    computed: "policy_term_months / 12"

  # Coverage
  - name: coverage_ids
    type: array
    description: Coverages included
    items:
      type: uuid

  - name: rider_ids
    type: array
    description: Optional riders added
    items:
      type: uuid

  - name: sum_insured
    type: decimal
    description: Total sum insured
    precision: 15
    scale: 2
    required: true

  - name: sum_insured_currency
    type: string
    description: Sum insured currency
    default: "VND"

  - name: deductible
    type: decimal
    description: Policy deductible
    precision: 12
    scale: 2
    default: 0

  - name: deductible_type
    type: enum
    description: Deductible calculation
    values:
      - fixed
      - percentage
      - per_claim
      - annual_aggregate

  - name: coverage_territory
    type: array
    description: Geographic coverage
    items:
      type: string
    default: ["VN"]

  # Premium
  - name: annual_premium
    type: decimal
    description: Annual premium amount
    precision: 12
    scale: 2
    required: true

  - name: premium_currency
    type: string
    description: Premium currency
    default: "VND"

  - name: payment_frequency
    type: enum
    description: Premium payment frequency
    values:
      - single
      - monthly
      - quarterly
      - semi_annual
      - annual
    default: annual

  - name: modal_premium
    type: decimal
    description: Premium per payment frequency
    precision: 12
    scale: 2
    computed: "annual_premium / frequency_factor"

  - name: premium_due_date
    type: date
    description: Next premium due date

  - name: last_premium_paid_date
    type: date
    description: Last premium payment date

  - name: grace_period_days
    type: integer
    description: Grace period for payment
    default: 30

  # Payment
  - name: payment_method
    type: enum
    description: Payment method
    values:
      - bank_transfer
      - credit_card
      - debit_card
      - auto_debit
      - cash
      - cheque
      - e_wallet

  - name: bank_account_id
    type: uuid
    description: Linked bank account

  - name: auto_pay_enabled
    type: boolean
    description: Auto payment enabled
    default: false

  # Documents
  - name: policy_document_url
    type: string
    description: Policy document PDF
    format: uri

  - name: schedule_url
    type: string
    description: Policy schedule PDF
    format: uri

  - name: terms_conditions_url
    type: string
    description: T&C document URL
    format: uri

  # Versioning
  - name: version
    type: integer
    description: Policy version number
    default: 1

  - name: previous_version_id
    type: uuid
    description: Previous policy version

  - name: effective_version_date
    type: date
    description: When this version became effective

  - name: renewal_count
    type: integer
    description: Number of times renewed
    default: 0

  # Claims
  - name: claims_count
    type: integer
    description: Total claims filed
    default: 0

  - name: total_claims_paid
    type: decimal
    description: Total claims amount paid
    precision: 15
    scale: 2
    default: 0

  - name: no_claims_years
    type: integer
    description: Years without claims
    default: 0

  # Underwriting
  - name: underwriting_class
    type: enum
    description: Risk classification
    values:
      - standard
      - preferred
      - substandard
      - declined
    default: standard

  - name: risk_score
    type: decimal
    description: Calculated risk score
    precision: 5
    scale: 2

  - name: loadings
    type: array
    description: Premium loadings applied
    items:
      type: object
      properties:
        type:
          type: string
        percentage:
          type: decimal
        reason:
          type: string

  # Audit
  - name: created_at
    type: timestamp
    required: true
    auto_generate: true

  - name: updated_at
    type: timestamp
    auto_update: true

  - name: created_by
    type: uuid
    description: User who created

  - name: approved_by
    type: uuid
    description: User who approved

  - name: approved_at
    type: timestamp

relationships:
  - name: product
    type: belongs_to
    entity: Product
    foreign_key: product_id

  - name: policyholder
    type: belongs_to
    entity: Policyholder
    foreign_key: policyholder_id

  - name: insureds
    type: has_many
    entity: Insured
    foreign_key: policy_id

  - name: beneficiaries
    type: has_many
    entity: Beneficiary
    foreign_key: policy_id

  - name: coverages
    type: has_many
    entity: PolicyCoverage
    through: policy_coverages

  - name: riders
    type: has_many
    entity: PolicyRider
    through: policy_riders

  - name: premiums
    type: has_many
    entity: Premium
    foreign_key: policy_id

  - name: endorsements
    type: has_many
    entity: Endorsement
    foreign_key: policy_id

  - name: renewals
    type: has_many
    entity: Renewal
    foreign_key: policy_id

  - name: agent
    type: belongs_to
    entity: Agent
    foreign_key: agent_id

  - name: commissions
    type: has_many
    entity: Commission
    foreign_key: policy_id

  - name: claims
    type: has_many
    entity: Claim
    foreign_key: policy_id

state_machine:
  initial: draft
  states:
    - name: draft
      description: Policy being prepared
    - name: pending_payment
      description: Awaiting initial premium
    - name: pending_approval
      description: Under review/underwriting
    - name: active
      description: Policy in force
    - name: lapsed
      description: Lapsed due to non-payment
    - name: reinstated
      description: Reinstated after lapse
    - name: cancelled
      description: Cancelled by policyholder or insurer
    - name: expired
      description: Term ended naturally
    - name: matured
      description: Reached maturity (life/endowment)
    - name: surrendered
      description: Voluntarily surrendered
    - name: paid_up
      description: No more premiums due

  transitions:
    - from: draft
      to: pending_payment
      event: submit

    - from: pending_payment
      to: pending_approval
      event: payment_received

    - from: pending_approval
      to: active
      event: approve

    - from: pending_approval
      to: draft
      event: decline

    - from: active
      to: lapsed
      event: lapse
      condition: grace_period_expired

    - from: lapsed
      to: reinstated
      event: reinstate

    - from: reinstated
      to: active
      event: activate

    - from: active
      to: cancelled
      event: cancel

    - from: active
      to: expired
      event: expire

    - from: active
      to: matured
      event: mature

    - from: active
      to: surrendered
      event: surrender

    - from: active
      to: paid_up
      event: paid_up

business_rules:
  - rule: BR-POL-001
    description: Policy must have at least one insured
    validation: COUNT(insured_ids) >= 1

  - rule: BR-POL-002
    description: Expiry date must be after effective date
    validation: expiry_date > effective_date

  - rule: BR-POL-003
    description: Sum insured must be within product limits
    validation: sum_insured BETWEEN product.min_sum_insured AND product.max_sum_insured

  - rule: BR-POL-004
    description: Grace period applies before lapse
    validation: IF premium_overdue THEN allow_grace_period(grace_period_days)

events:
  - name: policy.created
    description: New policy created
    payload: [policy_id, policy_number, product_id]

  - name: policy.issued
    description: Policy issued and active
    payload: [policy_id, effective_date]

  - name: policy.premium_due
    description: Premium payment due
    payload: [policy_id, amount, due_date]

  - name: policy.lapsed
    description: Policy lapsed
    payload: [policy_id, lapse_date]

  - name: policy.renewed
    description: Policy renewed
    payload: [policy_id, new_expiry_date, renewal_premium]

  - name: policy.cancelled
    description: Policy cancelled
    payload: [policy_id, cancellation_date, refund_amount]

  - name: policy.matured
    description: Policy reached maturity
    payload: [policy_id, maturity_amount]

api_endpoints:
  - method: GET
    path: /policies
    description: List policies

  - method: GET
    path: /policies/{id}
    description: Get policy details

  - method: POST
    path: /policies
    description: Create new policy

  - method: PUT
    path: /policies/{id}
    description: Update policy

  - method: POST
    path: /policies/{id}/issue
    description: Issue policy

  - method: POST
    path: /policies/{id}/renew
    description: Renew policy

  - method: POST
    path: /policies/{id}/cancel
    description: Cancel policy
