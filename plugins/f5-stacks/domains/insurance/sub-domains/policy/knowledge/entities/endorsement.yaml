name: Endorsement
display_name: Policy Endorsement
description: |
  Policy modification or amendment record.
  Tracks changes to coverage, beneficiaries, or policy terms.

domain: insurance
subdomain: policy
category: entities
version: "1.0.0"
status: active

database:
  table_name: endorsements
  primary_key: id
  indexes:
    - columns: [policy_id]
    - columns: [endorsement_number]
      unique: true
    - columns: [status]
    - columns: [effective_date]
    - columns: [endorsement_type]

attributes:
  # Identifiers
  - name: id
    type: uuid
    required: true
    generated: true

  - name: endorsement_number
    type: string
    description: Endorsement reference
    pattern: "END-[A-Z0-9]{8}"
    example: "END-2024A001"
    required: true
    unique: true

  - name: policy_id
    type: uuid
    description: Parent policy
    required: true

  - name: policy_number
    type: string
    description: Policy reference

  - name: policy_version
    type: integer
    description: Policy version before change

  # Type
  - name: endorsement_type
    type: enum
    description: Type of endorsement
    values:
      - coverage_increase
      - coverage_decrease
      - add_coverage
      - remove_coverage
      - add_rider
      - remove_rider
      - add_insured
      - remove_insured
      - change_beneficiary
      - address_change
      - name_change
      - payment_change
      - sum_insured_change
      - term_extension
      - reinstatement
      - conversion
      - assignment
      - other
    required: true

  - name: endorsement_category
    type: enum
    description: Category classification
    values:
      - coverage_change
      - party_change
      - administrative
      - financial
      - regulatory
    required: true

  # Status
  - name: status
    type: enum
    description: Endorsement status
    values:
      - draft
      - pending_review
      - pending_approval
      - pending_payment
      - approved
      - rejected
      - cancelled
      - completed
    default: draft

  # Dates
  - name: request_date
    type: date
    description: When requested
    required: true

  - name: effective_date
    type: date
    description: When change takes effect
    required: true

  - name: expiry_date
    type: date
    description: When change expires (if temporary)

  - name: processed_date
    type: date
    description: When processed

  - name: completed_date
    type: date
    description: When completed

  # Requestor
  - name: requested_by_type
    type: enum
    description: Who requested
    values:
      - policyholder
      - insured
      - agent
      - insurer
      - regulator
    required: true

  - name: requested_by_id
    type: uuid
    description: Requestor ID

  - name: requested_by_name
    type: string
    description: Requestor name

  - name: request_channel
    type: enum
    description: Request channel
    values:
      - online
      - agent_portal
      - call_center
      - branch
      - email
      - mail

  # Change details
  - name: description
    type: text
    description: Change description
    required: true

  - name: reason
    type: text
    description: Reason for change

  - name: change_details
    type: object
    description: Detailed change data
    properties:
      before:
        type: object
      after:
        type: object
      fields_changed:
        type: array

  # Coverage changes
  - name: coverage_changes
    type: array
    description: Coverage modifications
    items:
      type: object
      properties:
        coverage_id:
          type: uuid
        action:
          type: enum
          values: [add, remove, modify]
        previous_sum_insured:
          type: decimal
        new_sum_insured:
          type: decimal
        previous_premium:
          type: decimal
        new_premium:
          type: decimal

  # Insured changes
  - name: insured_changes
    type: array
    description: Insured person changes
    items:
      type: object
      properties:
        insured_id:
          type: uuid
        action:
          type: enum
          values: [add, remove, modify]
        changes:
          type: object

  # Beneficiary changes
  - name: beneficiary_changes
    type: array
    description: Beneficiary changes
    items:
      type: object
      properties:
        beneficiary_id:
          type: uuid
        action:
          type: enum
          values: [add, remove, modify]
        previous_allocation:
          type: decimal
        new_allocation:
          type: decimal

  # Financial impact
  - name: premium_impact
    type: enum
    description: Premium effect
    values:
      - increase
      - decrease
      - no_change
    default: no_change

  - name: premium_adjustment
    type: decimal
    description: Premium change amount
    precision: 12
    scale: 2

  - name: annual_premium_change
    type: decimal
    description: Annual premium difference
    precision: 12
    scale: 2

  - name: prorated_premium
    type: decimal
    description: Prorated premium for period
    precision: 12
    scale: 2

  - name: refund_amount
    type: decimal
    description: Refund if decrease
    precision: 12
    scale: 2

  - name: additional_premium
    type: decimal
    description: Additional premium if increase
    precision: 12
    scale: 2

  - name: fee
    type: decimal
    description: Endorsement processing fee
    precision: 10
    scale: 2
    default: 0

  - name: total_amount_due
    type: decimal
    description: Total payable
    precision: 12
    scale: 2
    computed: "additional_premium + fee - refund_amount"

  # Payment
  - name: payment_required
    type: boolean
    description: Requires payment
    default: false

  - name: payment_status
    type: enum
    description: Payment status
    values:
      - not_required
      - pending
      - paid
      - waived
    default: not_required

  - name: payment_date
    type: date
    description: When paid

  - name: payment_reference
    type: string
    description: Payment reference

  # Underwriting
  - name: requires_underwriting
    type: boolean
    description: Needs underwriting review
    default: false

  - name: underwriting_status
    type: enum
    description: UW status
    values:
      - not_required
      - pending
      - approved
      - declined
    default: not_required

  - name: underwriting_notes
    type: text
    description: Underwriter notes

  - name: underwriter_id
    type: uuid
    description: Assigned underwriter

  # Approval
  - name: requires_approval
    type: boolean
    description: Needs approval
    default: false

  - name: approval_level
    type: enum
    description: Approval authority needed
    values:
      - auto
      - supervisor
      - manager
      - underwriter
      - executive
    default: auto

  - name: approved_by
    type: uuid
    description: Approver

  - name: approved_at
    type: timestamp
    description: Approval time

  - name: approval_notes
    type: text
    description: Approval notes

  - name: rejection_reason
    type: text
    description: Why rejected

  # Documents
  - name: required_documents
    type: array
    description: Documents needed
    items:
      type: object
      properties:
        document_type:
          type: string
        is_mandatory:
          type: boolean
        status:
          type: enum
          values: [pending, received, verified]

  - name: supporting_documents
    type: array
    description: Uploaded documents
    items:
      type: object
      properties:
        document_type:
          type: string
        file_name:
          type: string
        file_url:
          type: string
        uploaded_at:
          type: timestamp

  - name: endorsement_document_url
    type: string
    description: Endorsement document PDF
    format: uri

  # Signatures
  - name: policyholder_signature
    type: object
    description: Policyholder consent
    properties:
      required:
        type: boolean
      signed:
        type: boolean
      signed_at:
        type: timestamp
      signature_method:
        type: string
      ip_address:
        type: string

  - name: insured_signature
    type: object
    description: Insured consent
    properties:
      required:
        type: boolean
      signed:
        type: boolean
      signed_at:
        type: timestamp

  # Previous values (for audit)
  - name: snapshot_before
    type: object
    description: Policy state before endorsement

  - name: snapshot_after
    type: object
    description: Policy state after endorsement

  # Notes
  - name: internal_notes
    type: text
    description: Internal processing notes

  - name: customer_notes
    type: text
    description: Notes for customer

  # Audit
  - name: created_at
    type: timestamp
    required: true
    auto_generate: true

  - name: updated_at
    type: timestamp
    auto_update: true

  - name: created_by
    type: uuid

  - name: processed_by
    type: uuid

relationships:
  - name: policy
    type: belongs_to
    entity: Policy
    foreign_key: policy_id

  - name: underwriter
    type: belongs_to
    entity: User
    foreign_key: underwriter_id

  - name: approver
    type: belongs_to
    entity: User
    foreign_key: approved_by

state_machine:
  initial: draft
  states:
    - name: draft
      description: Being prepared
    - name: pending_review
      description: Under review
    - name: pending_approval
      description: Awaiting approval
    - name: pending_payment
      description: Awaiting payment
    - name: approved
      description: Approved
    - name: rejected
      description: Rejected
    - name: cancelled
      description: Cancelled
    - name: completed
      description: Applied to policy

  transitions:
    - from: draft
      to: pending_review
      event: submit

    - from: pending_review
      to: pending_approval
      event: review_complete

    - from: pending_review
      to: rejected
      event: reject

    - from: pending_approval
      to: approved
      event: approve

    - from: pending_approval
      to: rejected
      event: reject

    - from: approved
      to: pending_payment
      event: require_payment
      condition: payment_required

    - from: approved
      to: completed
      event: complete
      condition: no_payment_required

    - from: pending_payment
      to: completed
      event: payment_received

    - from: [draft, pending_review, pending_approval]
      to: cancelled
      event: cancel

business_rules:
  - rule: BR-END-001
    description: Effective date cannot be in past
    validation: effective_date >= request_date

  - rule: BR-END-002
    description: Coverage increase may require underwriting
    validation: IF endorsement_type = 'coverage_increase' AND change > threshold THEN requires_underwriting = true

  - rule: BR-END-003
    description: Beneficiary change needs policyholder signature
    validation: IF endorsement_type = 'change_beneficiary' THEN policyholder_signature.required = true

  - rule: BR-END-004
    description: Payment required for additional premium
    validation: IF additional_premium > 0 THEN payment_required = true

events:
  - name: endorsement.requested
    payload: [endorsement_id, policy_id, endorsement_type]

  - name: endorsement.approved
    payload: [endorsement_id, approved_by]

  - name: endorsement.rejected
    payload: [endorsement_id, rejection_reason]

  - name: endorsement.completed
    payload: [endorsement_id, effective_date, changes]

  - name: endorsement.payment_due
    payload: [endorsement_id, amount]

api_endpoints:
  - method: POST
    path: /endorsements
    description: Create endorsement

  - method: GET
    path: /endorsements/{id}
    description: Get endorsement details

  - method: POST
    path: /endorsements/{id}/submit
    description: Submit for review

  - method: POST
    path: /endorsements/{id}/approve
    description: Approve endorsement

  - method: POST
    path: /endorsements/{id}/reject
    description: Reject endorsement

  - method: POST
    path: /endorsements/{id}/complete
    description: Complete endorsement
