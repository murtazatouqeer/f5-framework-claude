name: Quote
display_name: Insurance Quote
description: |
  Premium quotation for prospective insurance coverage.
  Generated during sales process before application.

domain: insurance
subdomain: policy
category: entities
version: "1.0.0"
status: active

database:
  table_name: quotes
  primary_key: id
  indexes:
    - columns: [quote_number]
      unique: true
    - columns: [product_id]
    - columns: [status]
    - columns: [prospect_email]
    - columns: [created_at]
    - columns: [valid_until]

attributes:
  # Identifiers
  - name: id
    type: uuid
    required: true
    generated: true

  - name: quote_number
    type: string
    description: Quote reference number
    pattern: "QT-[A-Z0-9]{8}"
    example: "QT-2024A001"
    required: true
    unique: true

  - name: product_id
    type: uuid
    description: Insurance product
    required: true

  - name: channel_id
    type: uuid
    description: Sales channel

  # Status
  - name: status
    type: enum
    description: Quote status
    values:
      - draft
      - calculating
      - generated
      - sent
      - viewed
      - accepted
      - expired
      - declined
      - superseded
    default: draft

  - name: quote_type
    type: enum
    description: Quote purpose
    values:
      - new_business
      - renewal
      - endorsement
      - reinstatement
    default: new_business

  # Prospect/Customer
  - name: prospect_id
    type: uuid
    description: Prospect or existing customer

  - name: policyholder_id
    type: uuid
    description: Existing policyholder (for renewals)

  - name: prospect_name
    type: string
    description: Prospect full name
    max_length: 150

  - name: prospect_email
    type: string
    description: Contact email
    format: email

  - name: prospect_phone
    type: string
    description: Contact phone

  - name: prospect_type
    type: enum
    description: Prospect type
    values:
      - individual
      - corporate
    default: individual

  # Risk information
  - name: primary_insured
    type: object
    description: Main person to be insured
    properties:
      name:
        type: string
      date_of_birth:
        type: date
      age:
        type: integer
      gender:
        type: enum
        values: [male, female]
      national_id:
        type: string

  - name: occupation
    type: string
    description: Occupation

  - name: occupation_class
    type: integer
    description: Occupation risk class
    minimum: 1
    maximum: 4
    default: 1

  - name: smoker_status
    type: enum
    description: Smoking status
    values:
      - non_smoker
      - smoker
      - ex_smoker
    default: non_smoker

  - name: health_declaration
    type: object
    description: Health questionnaire answers
    properties:
      has_medical_conditions:
        type: boolean
      conditions:
        type: array
      hospitalized_last_5_years:
        type: boolean
      taking_medication:
        type: boolean

  - name: risk_details
    type: object
    description: Product-specific risk info (varies)
    example:
      motor: { vehicle_make, model, year, value }
      property: { construction, area_sqm, location }
      travel: { destination, trip_days }

  # Coverage selection
  - name: sum_insured
    type: decimal
    description: Requested sum insured
    precision: 15
    scale: 2
    required: true

  - name: sum_insured_currency
    type: string
    description: Currency
    default: "VND"

  - name: policy_term_months
    type: integer
    description: Requested term
    required: true

  - name: coverages_selected
    type: array
    description: Selected coverages
    items:
      type: object
      properties:
        coverage_id:
          type: uuid
        coverage_code:
          type: string
        sum_insured:
          type: decimal
        deductible:
          type: decimal

  - name: riders_selected
    type: array
    description: Selected riders
    items:
      type: object
      properties:
        rider_id:
          type: uuid
        rider_code:
          type: string
        sum_insured:
          type: decimal

  - name: payment_frequency
    type: enum
    description: Payment frequency
    values:
      - monthly
      - quarterly
      - semi_annual
      - annual
      - single
    default: annual

  # Premium calculation
  - name: base_premium
    type: decimal
    description: Base premium before adjustments
    precision: 12
    scale: 2

  - name: loadings
    type: array
    description: Premium loadings applied
    items:
      type: object
      properties:
        type:
          type: string
        amount:
          type: decimal
        percentage:
          type: decimal
        reason:
          type: string

  - name: total_loading
    type: decimal
    description: Total loading amount
    precision: 12
    scale: 2

  - name: discounts
    type: array
    description: Discounts applied
    items:
      type: object
      properties:
        type:
          type: string
        amount:
          type: decimal
        percentage:
          type: decimal
        reason:
          type: string

  - name: total_discount
    type: decimal
    description: Total discount amount
    precision: 12
    scale: 2

  - name: net_premium
    type: decimal
    description: Premium after loadings/discounts
    precision: 12
    scale: 2

  - name: taxes
    type: array
    description: Applicable taxes
    items:
      type: object
      properties:
        tax_type:
          type: string
        rate:
          type: decimal
        amount:
          type: decimal

  - name: total_tax
    type: decimal
    description: Total tax amount
    precision: 12
    scale: 2

  - name: stamp_duty
    type: decimal
    description: Stamp duty if applicable
    precision: 10
    scale: 2

  - name: gross_premium
    type: decimal
    description: Final premium payable
    precision: 12
    scale: 2
    required: true

  - name: modal_premium
    type: decimal
    description: Premium per payment frequency
    precision: 12
    scale: 2

  # Validity
  - name: quoted_at
    type: timestamp
    description: When quote was generated

  - name: valid_until
    type: timestamp
    description: Quote expiry date/time

  - name: validity_days
    type: integer
    description: Quote valid for X days
    default: 30

  - name: quoted_by
    type: uuid
    description: User who created quote

  - name: agent_id
    type: uuid
    description: Selling agent

  # Comparison
  - name: is_comparison
    type: boolean
    description: Part of multi-quote comparison
    default: false

  - name: comparison_group_id
    type: uuid
    description: Comparison group ID

  - name: compared_quotes
    type: array
    description: Related quotes for comparison
    items:
      type: uuid

  # Documents
  - name: quote_document_url
    type: string
    description: Quote PDF document
    format: uri

  - name: illustration_url
    type: string
    description: Benefit illustration PDF
    format: uri

  # Tracking
  - name: sent_at
    type: timestamp
    description: When sent to prospect

  - name: sent_to
    type: string
    description: Email sent to

  - name: viewed_at
    type: timestamp
    description: First viewed by prospect

  - name: view_count
    type: integer
    description: Number of views
    default: 0

  - name: accepted_at
    type: timestamp
    description: When accepted

  - name: declined_at
    type: timestamp
    description: When declined

  - name: decline_reason
    type: string
    description: Why prospect declined

  # Conversion
  - name: converted_to_application
    type: boolean
    description: Converted to application
    default: false

  - name: application_id
    type: uuid
    description: Resulting application

  # Source
  - name: source
    type: enum
    description: Quote source
    values:
      - website
      - mobile_app
      - agent_portal
      - call_center
      - partner
      - api
    default: website

  - name: campaign_id
    type: string
    description: Marketing campaign

  - name: referral_code
    type: string
    description: Referral/promo code

  # Audit
  - name: created_at
    type: timestamp
    required: true
    auto_generate: true

  - name: updated_at
    type: timestamp
    auto_update: true

relationships:
  - name: product
    type: belongs_to
    entity: Product
    foreign_key: product_id

  - name: prospect
    type: belongs_to
    entity: Prospect
    foreign_key: prospect_id

  - name: application
    type: has_one
    entity: Application
    foreign_key: quote_id

  - name: agent
    type: belongs_to
    entity: Agent
    foreign_key: agent_id

business_rules:
  - rule: BR-QT-001
    description: Quote must not be expired for acceptance
    validation: status = 'accepted' ONLY IF NOW() <= valid_until

  - rule: BR-QT-002
    description: Sum insured must be within product limits
    validation: sum_insured BETWEEN product.min_sum_insured AND product.max_sum_insured

  - rule: BR-QT-003
    description: Gross premium = net premium + taxes + stamp duty
    validation: gross_premium = net_premium + total_tax + stamp_duty

events:
  - name: quote.created
    payload: [quote_id, quote_number, product_id]

  - name: quote.generated
    payload: [quote_id, gross_premium]

  - name: quote.sent
    payload: [quote_id, sent_to]

  - name: quote.viewed
    payload: [quote_id, viewed_at]

  - name: quote.accepted
    payload: [quote_id, accepted_at]

  - name: quote.expired
    payload: [quote_id, valid_until]

  - name: quote.converted
    payload: [quote_id, application_id]

api_endpoints:
  - method: POST
    path: /quotes
    description: Create quote

  - method: GET
    path: /quotes/{id}
    description: Get quote details

  - method: POST
    path: /quotes/{id}/calculate
    description: Calculate premium

  - method: POST
    path: /quotes/{id}/send
    description: Send quote to prospect

  - method: POST
    path: /quotes/{id}/accept
    description: Accept quote

  - method: POST
    path: /quotes/{id}/convert
    description: Convert to application
