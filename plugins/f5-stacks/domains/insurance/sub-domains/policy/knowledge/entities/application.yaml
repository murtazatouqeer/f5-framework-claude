name: Application
display_name: Insurance Application
description: |
  Insurance policy application submitted by prospect.
  Contains declarations, documents, and underwriting information.

domain: insurance
subdomain: policy
category: entities
version: "1.0.0"
status: active

database:
  table_name: applications
  primary_key: id
  indexes:
    - columns: [application_number]
      unique: true
    - columns: [quote_id]
    - columns: [status]
    - columns: [policyholder_id]
    - columns: [submitted_at]

attributes:
  # Identifiers
  - name: id
    type: uuid
    required: true
    generated: true

  - name: application_number
    type: string
    description: Application reference
    pattern: "APP-[A-Z0-9]{8}"
    example: "APP-2024B001"
    required: true
    unique: true

  - name: quote_id
    type: uuid
    description: Originating quote

  - name: product_id
    type: uuid
    description: Insurance product
    required: true

  # Status
  - name: status
    type: enum
    description: Application status
    values:
      - draft
      - submitted
      - documents_pending
      - under_review
      - underwriting
      - additional_info_required
      - approved
      - approved_with_loading
      - approved_with_exclusion
      - declined
      - withdrawn
      - referred
      - on_hold
    default: draft

  - name: application_type
    type: enum
    description: Application type
    values:
      - new_business
      - conversion
      - reinstatement
      - top_up
      - upgrade
    default: new_business

  # Policyholder
  - name: policyholder_id
    type: uuid
    description: Policy owner
    required: true

  - name: policyholder_details
    type: object
    description: Policyholder information
    properties:
      customer_type:
        type: enum
        values: [individual, corporate]
      title:
        type: string
      first_name:
        type: string
      last_name:
        type: string
      full_name:
        type: string
      gender:
        type: string
      date_of_birth:
        type: date
      national_id:
        type: string
      passport_number:
        type: string
      tax_id:
        type: string
      email:
        type: string
      phone:
        type: string
      mobile:
        type: string
      address:
        type: object

  # Insured details
  - name: insured_details
    type: array
    description: People to be insured
    items:
      type: object
      properties:
        insured_id:
          type: uuid
        relationship:
          type: enum
          values: [self, spouse, child, parent, employee, other]
        first_name:
          type: string
        last_name:
          type: string
        full_name:
          type: string
        gender:
          type: string
        date_of_birth:
          type: date
        age_at_inception:
          type: integer
        national_id:
          type: string
        occupation:
          type: string
        occupation_class:
          type: integer
        sum_insured:
          type: decimal
        coverages:
          type: array

  # Beneficiaries
  - name: beneficiary_details
    type: array
    description: Nominated beneficiaries
    items:
      type: object
      properties:
        beneficiary_type:
          type: enum
          values: [primary, contingent]
        first_name:
          type: string
        last_name:
          type: string
        full_name:
          type: string
        relationship:
          type: string
        date_of_birth:
          type: date
        national_id:
          type: string
        allocation_percent:
          type: decimal
        contact_phone:
          type: string
        contact_email:
          type: string
        is_irrevocable:
          type: boolean

  # Coverage
  - name: sum_insured
    type: decimal
    description: Total sum insured
    precision: 15
    scale: 2

  - name: policy_term_months
    type: integer
    description: Requested policy term

  - name: coverages_applied
    type: array
    description: Coverages requested
    items:
      type: uuid

  - name: riders_applied
    type: array
    description: Riders requested
    items:
      type: uuid

  - name: payment_frequency
    type: enum
    description: Payment frequency
    values:
      - monthly
      - quarterly
      - semi_annual
      - annual
      - single

  # Declarations
  - name: health_declaration
    type: object
    description: Health questionnaire
    properties:
      has_medical_conditions:
        type: boolean
      conditions_list:
        type: array
      hospitalized_5_years:
        type: boolean
      hospitalization_details:
        type: text
      taking_medication:
        type: boolean
      medication_details:
        type: text
      disabled:
        type: boolean
      disability_details:
        type: text
      pending_tests:
        type: boolean
      test_details:
        type: text
      family_history:
        type: object
      smoker:
        type: boolean
      smoking_details:
        type: object
      alcohol:
        type: boolean
      alcohol_frequency:
        type: string
      height_cm:
        type: decimal
      weight_kg:
        type: decimal
      bmi:
        type: decimal

  - name: lifestyle_declaration
    type: object
    description: Lifestyle questionnaire
    properties:
      hazardous_occupation:
        type: boolean
      hazardous_activities:
        type: array
      travel_high_risk:
        type: boolean
      military_service:
        type: boolean
      criminal_record:
        type: boolean

  - name: financial_declaration
    type: object
    description: Financial information
    properties:
      annual_income:
        type: decimal
      source_of_income:
        type: string
      employer:
        type: string
      existing_insurance:
        type: array
      total_existing_coverage:
        type: decimal
      net_worth:
        type: decimal

  - name: occupation_declaration
    type: object
    description: Occupation details
    properties:
      occupation:
        type: string
      occupation_class:
        type: integer
      employer_name:
        type: string
      employer_address:
        type: string
      job_duties:
        type: text
      works_at_height:
        type: boolean
      works_with_machinery:
        type: boolean

  # Motor-specific (if applicable)
  - name: motor_declaration
    type: object
    description: Motor insurance details
    properties:
      vehicle_make:
        type: string
      vehicle_model:
        type: string
      vehicle_year:
        type: integer
      registration_number:
        type: string
      engine_capacity:
        type: integer
      vehicle_value:
        type: decimal
      usage:
        type: string
      drivers:
        type: array
      claims_history:
        type: array
      ncb_years:
        type: integer

  # Documents
  - name: required_documents
    type: array
    description: Documents required
    items:
      type: object
      properties:
        document_type:
          type: string
        description:
          type: string
        is_mandatory:
          type: boolean
        status:
          type: enum
          values: [pending, uploaded, verified, rejected]

  - name: supporting_documents
    type: array
    description: Uploaded documents
    items:
      type: object
      properties:
        document_type:
          type: string
        file_name:
          type: string
        file_url:
          type: string
        uploaded_at:
          type: timestamp
        verified:
          type: boolean
        verified_by:
          type: uuid
        verified_at:
          type: timestamp
        rejection_reason:
          type: string

  # Underwriting
  - name: underwriting_status
    type: enum
    description: Underwriting progress
    values:
      - not_started
      - pending
      - in_progress
      - completed
      - referred

  - name: underwriting_decision
    type: enum
    description: Final underwriting decision
    values:
      - standard
      - preferred
      - substandard
      - declined
      - postponed

  - name: assigned_underwriter_id
    type: uuid
    description: Assigned underwriter

  - name: referral_reasons
    type: array
    description: Why referred to underwriting
    items:
      type: string

  - name: underwriting_notes
    type: text
    description: Underwriter notes

  - name: loadings_applied
    type: array
    description: Premium loadings
    items:
      type: object
      properties:
        type:
          type: string
        percentage:
          type: decimal
        reason:
          type: string
        duration:
          type: string

  - name: exclusions_applied
    type: array
    description: Coverage exclusions
    items:
      type: object
      properties:
        exclusion:
          type: string
        reason:
          type: string
        duration:
          type: string

  # Premium
  - name: quoted_premium
    type: decimal
    description: Original quoted premium
    precision: 12
    scale: 2

  - name: final_premium
    type: decimal
    description: Final premium after UW
    precision: 12
    scale: 2

  # Submission
  - name: submitted_at
    type: timestamp
    description: Submission date/time

  - name: submitted_by
    type: uuid
    description: Who submitted

  - name: channel
    type: enum
    description: Submission channel
    values:
      - online
      - agent
      - branch
      - bancassurance
      - call_center
      - partner_api

  - name: agent_id
    type: uuid
    description: Selling agent

  # E-signature
  - name: signature_status
    type: enum
    description: Electronic signature status
    values:
      - not_required
      - pending
      - signed
      - expired
    default: pending

  - name: signed_at
    type: timestamp
    description: When signed

  - name: signature_ip
    type: string
    description: IP address of signer

  # Approval
  - name: approved_at
    type: timestamp
    description: When approved

  - name: approved_by
    type: uuid
    description: Who approved

  - name: approval_notes
    type: text
    description: Approval notes

  # Conversion to policy
  - name: converted_to_policy
    type: boolean
    description: Converted to policy
    default: false

  - name: policy_id
    type: uuid
    description: Resulting policy

  # Audit
  - name: created_at
    type: timestamp
    required: true
    auto_generate: true

  - name: updated_at
    type: timestamp
    auto_update: true

relationships:
  - name: quote
    type: belongs_to
    entity: Quote
    foreign_key: quote_id

  - name: product
    type: belongs_to
    entity: Product
    foreign_key: product_id

  - name: policyholder
    type: belongs_to
    entity: Policyholder
    foreign_key: policyholder_id

  - name: policy
    type: has_one
    entity: Policy
    foreign_key: application_id

  - name: agent
    type: belongs_to
    entity: Agent
    foreign_key: agent_id

state_machine:
  initial: draft
  states:
    - name: draft
      description: Application being prepared
    - name: submitted
      description: Submitted for review
    - name: documents_pending
      description: Awaiting documents
    - name: under_review
      description: Initial review
    - name: underwriting
      description: Underwriting in progress
    - name: additional_info_required
      description: Need more information
    - name: approved
      description: Approved for issue
    - name: declined
      description: Application declined
    - name: withdrawn
      description: Applicant withdrew

  transitions:
    - from: draft
      to: submitted
      event: submit

    - from: submitted
      to: documents_pending
      event: request_documents

    - from: submitted
      to: under_review
      event: start_review

    - from: documents_pending
      to: under_review
      event: documents_complete

    - from: under_review
      to: underwriting
      event: refer_to_underwriting

    - from: under_review
      to: approved
      event: approve

    - from: underwriting
      to: approved
      event: approve

    - from: underwriting
      to: declined
      event: decline

    - from: [draft, submitted, documents_pending, under_review]
      to: withdrawn
      event: withdraw

events:
  - name: application.submitted
    payload: [application_id, product_id, sum_insured]

  - name: application.documents_requested
    payload: [application_id, documents]

  - name: application.referred
    payload: [application_id, reasons]

  - name: application.approved
    payload: [application_id, decision, final_premium]

  - name: application.declined
    payload: [application_id, reasons]

  - name: application.policy_issued
    payload: [application_id, policy_id]
