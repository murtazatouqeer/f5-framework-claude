name: recovery
display_name: Claim Recovery
description: |
  Recovery actions for claims including salvage collection, subrogation,
  and third-party recoveries.

domain: insurance
subdomain: claims
category: entities
version: "1.0.0"
status: active

attributes:
  identification:
    - name: id
      type: uuid
      primary_key: true
      description: Unique recovery identifier

    - name: claim_id
      type: uuid
      foreign_key: claim.id
      required: true
      description: Associated claim

    - name: recovery_number
      type: string
      format: "REC-{YYYYMMDD}-{NNNN}"
      unique: true
      description: Recovery reference

  classification:
    - name: recovery_type
      type: enum
      values:
        - salvage
        - subrogation
        - contribution
        - reinsurance
        - deductible_recovery
        - fraud_recovery
        - overpayment
      required: true
      description: Type of recovery

    - name: recovery_category
      type: enum
      values:
        - motor_salvage
        - property_salvage
        - goods_salvage
        - third_party_liability
        - co_insurance
        - reinsurance_recovery
        - other
      description: Recovery category

  status:
    - name: status
      type: enum
      values:
        - identified
        - under_investigation
        - pursuing
        - negotiating
        - agreed
        - collection_pending
        - partially_recovered
        - fully_recovered
        - written_off
        - abandoned
      default: identified
      description: Recovery status

    - name: priority
      type: enum
      values:
        - high
        - medium
        - low
      default: medium
      description: Recovery priority

  amounts:
    - name: currency
      type: string
      default: VND
      description: Currency

    - name: estimated_recovery
      type: decimal
      precision: 2
      required: true
      description: Estimated recoverable amount

    - name: agreed_amount
      type: decimal
      precision: 2
      description: Agreed settlement amount

    - name: recovered_amount
      type: decimal
      precision: 2
      default: 0
      description: Amount actually recovered

    - name: recovery_costs
      type: decimal
      precision: 2
      default: 0
      description: Costs incurred for recovery

    - name: net_recovery
      type: decimal
      precision: 2
      computed: true
      formula: "recovered_amount - recovery_costs"
      description: Net recovery amount

    - name: outstanding_amount
      type: decimal
      precision: 2
      computed: true
      formula: "agreed_amount - recovered_amount"
      description: Amount still outstanding

    - name: recovery_ratio
      type: decimal
      precision: 4
      computed: true
      formula: "recovered_amount / estimated_recovery"
      description: Recovery success ratio

  salvage_details:
    - name: salvage_type
      type: enum
      values:
        - vehicle
        - property
        - goods
        - equipment
        - other
      description: Type of salvage

    - name: salvage_description
      type: text
      description: Description of salvage

    - name: salvage_location
      type: object
      properties:
        address: string
        city: string
        province: string
        contact_person: string
        contact_phone: string
      description: Salvage location

    - name: salvage_condition
      type: enum
      values:
        - good
        - fair
        - poor
        - scrap
      description: Salvage condition

    - name: valuation_method
      type: enum
      values:
        - auction
        - direct_sale
        - dealer_quote
        - expert_valuation
      description: How valued

    - name: valuation_amount
      type: decimal
      precision: 2
      description: Salvage valuation

    - name: buyer_name
      type: string
      description: Salvage buyer

    - name: sale_date
      type: date
      description: Salvage sale date

    - name: sale_amount
      type: decimal
      precision: 2
      description: Actual sale amount

  subrogation_details:
    - name: third_party_name
      type: string
      description: Third party name

    - name: third_party_contact
      type: object
      properties:
        address: string
        phone: string
        email: string
      description: Third party contact

    - name: third_party_insurer
      type: string
      description: Third party's insurer

    - name: third_party_policy
      type: string
      description: Third party policy number

    - name: liability_percentage
      type: integer
      min: 0
      max: 100
      description: Third party liability %

    - name: demand_letter_sent
      type: boolean
      default: false
      description: Demand letter sent

    - name: demand_letter_date
      type: date
      description: When demand sent

    - name: demand_amount
      type: decimal
      precision: 2
      description: Amount demanded

    - name: response_received
      type: boolean
      default: false
      description: Response received

    - name: response_date
      type: date
      description: Response date

    - name: settlement_offer
      type: decimal
      precision: 2
      description: Third party offer

  legal_action:
    - name: legal_action_required
      type: boolean
      default: false
      description: Legal action needed

    - name: litigation_id
      type: uuid
      foreign_key: litigation.id
      description: Related litigation

    - name: statute_of_limitations
      type: date
      description: Legal deadline

    - name: legal_counsel
      type: string
      description: Assigned legal counsel

    - name: court_case_number
      type: string
      description: Court case reference

  collection:
    - name: collection_method
      type: enum
      values:
        - direct_payment
        - bank_transfer
        - cheque
        - offset_against_premium
        - legal_enforcement
      description: Collection method

    - name: payment_schedule
      type: array
      items:
        type: object
        properties:
          installment_number: integer
          due_date: date
          amount: decimal
          paid: boolean
          paid_date: date
      description: Payment schedule

    - name: collection_agent
      type: string
      description: Collection agency if used

    - name: collection_fee_percentage
      type: decimal
      precision: 2
      description: Collection agency fee %

  receipts:
    - name: receipts
      type: array
      items:
        type: object
        properties:
          receipt_date: date
          amount: decimal
          method: string
          reference: string
          received_by: uuid
      description: Recovery receipts

  documents:
    - name: demand_letter_url
      type: string
      format: url
      description: Demand letter document

    - name: settlement_agreement_url
      type: string
      format: url
      description: Settlement agreement

    - name: supporting_documents
      type: array
      items:
        type: object
        properties:
          document_type: string
          url: string
          description: string
      description: Supporting documents

  assignment:
    - name: assigned_to
      type: uuid
      foreign_key: user.id
      description: Recovery handler

    - name: assigned_at
      type: datetime
      description: Assignment date

    - name: external_agency
      type: string
      description: External recovery agency

  timestamps:
    - name: identified_at
      type: datetime
      description: When identified

    - name: created_at
      type: datetime
      auto: true
      description: Creation timestamp

    - name: updated_at
      type: datetime
      auto: true
      on_update: true
      description: Update timestamp

    - name: closed_at
      type: datetime
      description: When closed

relationships:
  - name: claim
    type: belongs_to
    entity: claim
    foreign_key: claim_id
    description: Associated claim

  - name: litigation
    type: belongs_to
    entity: litigation
    foreign_key: litigation_id
    description: Related litigation

  - name: handler
    type: belongs_to
    entity: user
    foreign_key: assigned_to
    description: Recovery handler

state_machine:
  initial_state: identified

  states:
    - identified:
        description: Recovery opportunity identified
        allowed_transitions: [under_investigation, pursuing, abandoned]

    - under_investigation:
        description: Investigating recovery potential
        allowed_transitions: [pursuing, abandoned]

    - pursuing:
        description: Actively pursuing recovery
        allowed_transitions: [negotiating, abandoned]

    - negotiating:
        description: Negotiating settlement
        allowed_transitions: [agreed, pursuing, abandoned]

    - agreed:
        description: Recovery terms agreed
        allowed_transitions: [collection_pending]

    - collection_pending:
        description: Awaiting collection
        allowed_transitions: [partially_recovered, fully_recovered, written_off]

    - partially_recovered:
        description: Partial recovery received
        allowed_transitions: [fully_recovered, written_off]

    - fully_recovered:
        description: Full recovery complete
        final: true

    - written_off:
        description: Recovery written off
        final: true

    - abandoned:
        description: Recovery abandoned
        final: true

business_rules:
  - rule: BR-REC-001
    name: Statute of limitations
    condition: "NOW() < statute_of_limitations"
    when: "recovery_type = 'subrogation'"
    warning_message: "Approaching statute of limitations"

  - rule: BR-REC-002
    name: Cost-benefit check
    condition: "estimated_recovery > recovery_costs * 2"
    warning_message: "Recovery may not be cost-effective"

  - rule: BR-REC-003
    name: Legal review for large recoveries
    condition: "estimated_recovery > 500000000 IMPLIES legal_counsel IS NOT NULL"
    error_message: "Legal review required for large recoveries"

events:
  - name: recovery.identified
    description: Recovery opportunity identified
    payload: [recovery_id, claim_id, recovery_type, estimated_recovery]

  - name: recovery.agreed
    description: Recovery terms agreed
    payload: [recovery_id, agreed_amount]

  - name: recovery.received
    description: Recovery payment received
    payload: [recovery_id, amount, total_recovered]

  - name: recovery.completed
    description: Recovery completed
    payload: [recovery_id, total_recovered, net_recovery]

  - name: recovery.written_off
    description: Recovery written off
    payload: [recovery_id, write_off_reason]

api_endpoints:
  - method: POST
    path: /claims/{claim_id}/recoveries
    description: Create recovery
    request_body: RecoveryCreateRequest
    response: RecoveryResponse

  - method: GET
    path: /claims/{claim_id}/recoveries
    description: List recoveries
    response: RecoveryListResponse

  - method: GET
    path: /claims/{claim_id}/recoveries/{id}
    description: Get recovery details
    response: RecoveryResponse

  - method: PUT
    path: /claims/{claim_id}/recoveries/{id}
    description: Update recovery
    request_body: RecoveryUpdateRequest
    response: RecoveryResponse

  - method: POST
    path: /claims/{claim_id}/recoveries/{id}/record-receipt
    description: Record recovery receipt
    request_body: ReceiptRequest
    response: RecoveryResponse

  - method: POST
    path: /claims/{claim_id}/recoveries/{id}/write-off
    description: Write off recovery
    request_body: WriteOffRequest
    response: RecoveryResponse
