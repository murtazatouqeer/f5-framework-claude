name: payment
display_name: Claim Payment
description: |
  Payment transactions for claim settlements including beneficiary details,
  payment methods, and transaction tracking.

domain: insurance
subdomain: claims
category: entities
version: "1.0.0"
status: active

attributes:
  identification:
    - name: id
      type: uuid
      primary_key: true
      description: Unique payment identifier

    - name: claim_id
      type: uuid
      foreign_key: claim.id
      required: true
      description: Associated claim

    - name: settlement_id
      type: uuid
      foreign_key: settlement.id
      description: Related settlement

    - name: claimant_id
      type: uuid
      foreign_key: claimant.id
      required: true
      description: Payment recipient

    - name: payment_number
      type: string
      format: "PAY-{YYYYMMDD}-{NNNNNN}"
      unique: true
      description: Payment reference

  classification:
    - name: payment_type
      type: enum
      values:
        - indemnity
        - medical_expense
        - hospitalization
        - surgery
        - death_benefit
        - disability_benefit
        - property_damage
        - third_party
        - expense_reimbursement
        - legal_cost
        - interim_payment
        - final_payment
      required: true
      description: Type of payment

    - name: payment_category
      type: enum
      values:
        - settlement
        - advance
        - interim
        - supplementary
        - correction
        - refund
      default: settlement
      description: Payment category

  amounts:
    - name: currency
      type: string
      default: VND
      required: true
      description: Currency code

    - name: gross_amount
      type: decimal
      precision: 2
      required: true
      description: Gross payment amount

    - name: tax_withheld
      type: decimal
      precision: 2
      default: 0
      description: Tax withholding

    - name: other_deductions
      type: decimal
      precision: 2
      default: 0
      description: Other deductions

    - name: net_amount
      type: decimal
      precision: 2
      computed: true
      formula: "gross_amount - tax_withheld - other_deductions"
      description: Net payment amount

    - name: exchange_rate
      type: decimal
      precision: 6
      description: Exchange rate if applicable

    - name: original_currency
      type: string
      description: Original currency if converted

    - name: original_amount
      type: decimal
      precision: 2
      description: Amount in original currency

  status:
    - name: status
      type: enum
      values:
        - draft
        - pending_approval
        - approved
        - scheduled
        - processing
        - completed
        - failed
        - cancelled
        - reversed
      default: draft
      description: Payment status

    - name: failure_reason
      type: text
      description: Reason for failure

    - name: retry_count
      type: integer
      default: 0
      description: Number of retry attempts

  payment_method:
    - name: payment_method
      type: enum
      values:
        - bank_transfer
        - cheque
        - cash
        - mobile_payment
        - card
        - direct_to_provider
      required: true
      description: Payment method

    - name: bank_name
      type: string
      description: Recipient bank

    - name: bank_branch
      type: string
      description: Bank branch

    - name: account_number
      type: string
      sensitive: true
      description: Bank account number

    - name: account_holder_name
      type: string
      description: Account holder name

    - name: swift_code
      type: string
      description: SWIFT/BIC code

    - name: cheque_number
      type: string
      description: Cheque number

    - name: cheque_date
      type: date
      description: Cheque date

  direct_provider:
    - name: is_direct_payment
      type: boolean
      default: false
      description: Direct to service provider

    - name: provider_type
      type: enum
      values:
        - hospital
        - clinic
        - repair_shop
        - legal_firm
        - other
      description: Provider type

    - name: provider_name
      type: string
      description: Provider name

    - name: provider_account
      type: string
      description: Provider account details

    - name: invoice_reference
      type: string
      description: Provider invoice reference

  approval:
    - name: requires_approval
      type: boolean
      default: true
      description: Needs approval

    - name: approval_level
      type: enum
      values:
        - handler
        - senior_handler
        - supervisor
        - manager
        - director
        - committee
      description: Required approval level

    - name: approved_by
      type: uuid
      foreign_key: user.id
      description: Approver

    - name: approved_at
      type: datetime
      description: Approval timestamp

    - name: approval_notes
      type: text
      description: Approval comments

  processing:
    - name: scheduled_date
      type: date
      description: Scheduled payment date

    - name: processed_date
      type: datetime
      description: Actual processing date

    - name: value_date
      type: date
      description: Value date

    - name: batch_id
      type: string
      description: Payment batch reference

    - name: transaction_reference
      type: string
      description: Bank transaction reference

    - name: processed_by
      type: uuid
      foreign_key: user.id
      description: Who processed payment

  verification:
    - name: verified
      type: boolean
      default: false
      description: Payment verified received

    - name: verified_at
      type: datetime
      description: Verification timestamp

    - name: verified_by
      type: uuid
      foreign_key: user.id
      description: Who verified

    - name: verification_method
      type: enum
      values:
        - bank_confirmation
        - recipient_confirmation
        - auto_reconciliation
        - manual_check
      description: How verified

    - name: recipient_confirmation
      type: object
      properties:
        confirmed: boolean
        confirmed_date: datetime
        confirmation_reference: string
      description: Recipient confirmation

  documents:
    - name: payment_voucher_url
      type: string
      format: url
      description: Payment voucher

    - name: receipt_url
      type: string
      format: url
      description: Payment receipt

    - name: bank_advice_url
      type: string
      format: url
      description: Bank advice document

    - name: supporting_documents
      type: array
      items: string
      description: Supporting document URLs

  audit:
    - name: created_by
      type: uuid
      foreign_key: user.id
      required: true
      description: Creator

    - name: created_at
      type: datetime
      auto: true
      description: Creation timestamp

    - name: updated_at
      type: datetime
      auto: true
      on_update: true
      description: Update timestamp

    - name: completed_at
      type: datetime
      description: Completion timestamp

relationships:
  - name: claim
    type: belongs_to
    entity: claim
    foreign_key: claim_id
    description: Associated claim

  - name: settlement
    type: belongs_to
    entity: settlement
    foreign_key: settlement_id
    description: Related settlement

  - name: claimant
    type: belongs_to
    entity: claimant
    foreign_key: claimant_id
    description: Payment recipient

state_machine:
  initial_state: draft

  states:
    - draft:
        description: Payment being prepared
        allowed_transitions: [pending_approval, cancelled]

    - pending_approval:
        description: Awaiting approval
        allowed_transitions: [approved, draft, cancelled]

    - approved:
        description: Payment approved
        allowed_transitions: [scheduled, processing, cancelled]

    - scheduled:
        description: Payment scheduled
        allowed_transitions: [processing, cancelled]

    - processing:
        description: Payment being processed
        allowed_transitions: [completed, failed]

    - completed:
        description: Payment successful
        allowed_transitions: [reversed]

    - failed:
        description: Payment failed
        allowed_transitions: [processing, cancelled]

    - cancelled:
        description: Payment cancelled
        final: true

    - reversed:
        description: Payment reversed
        final: true

  transitions:
    - name: submit_for_approval
      from: draft
      to: pending_approval
      action: validate_payment_details

    - name: approve
      from: pending_approval
      to: approved
      condition: "approver_authority >= required_authority"

    - name: schedule
      from: approved
      to: scheduled
      action: schedule_in_batch

    - name: process
      from: [approved, scheduled, failed]
      to: processing
      action: execute_payment

    - name: complete
      from: processing
      to: completed
      action: record_completion

    - name: fail
      from: processing
      to: failed
      action: record_failure

    - name: reverse
      from: completed
      to: reversed
      action: process_reversal

business_rules:
  - rule: BR-PAY-001
    name: Bank details required
    condition: "payment_method = 'bank_transfer' IMPLIES account_number IS NOT NULL"
    error_message: "Bank account required for transfers"

  - rule: BR-PAY-002
    name: Authority limit
    condition: "gross_amount <= approval_authority(approved_by)"
    error_message: "Amount exceeds approval authority"

  - rule: BR-PAY-003
    name: Settlement required
    condition: "settlement_id IS NOT NULL OR payment_category = 'advance'"
    error_message: "Settlement required for payment"

  - rule: BR-PAY-004
    name: Claimant verified
    condition: "claimant.identity_verified = true"
    before: processing
    error_message: "Claimant identity not verified"

  - rule: BR-PAY-005
    name: Bank verified for large payments
    condition: "gross_amount > 100000000 IMPLIES claimant.bank_verified = true"
    error_message: "Bank verification required for large payments"

events:
  - name: payment.created
    description: Payment created
    payload: [payment_id, claim_id, gross_amount]

  - name: payment.approved
    description: Payment approved
    payload: [payment_id, approved_by, gross_amount]

  - name: payment.processing
    description: Payment processing started
    payload: [payment_id, batch_id]

  - name: payment.completed
    description: Payment completed
    payload: [payment_id, transaction_reference, net_amount]

  - name: payment.failed
    description: Payment failed
    payload: [payment_id, failure_reason]

  - name: payment.reversed
    description: Payment reversed
    payload: [payment_id, reversal_reason]

api_endpoints:
  - method: POST
    path: /claims/{claim_id}/payments
    description: Create payment
    request_body: PaymentCreateRequest
    response: PaymentResponse

  - method: GET
    path: /claims/{claim_id}/payments
    description: List payments
    response: PaymentListResponse

  - method: GET
    path: /claims/{claim_id}/payments/{id}
    description: Get payment details
    response: PaymentResponse

  - method: PUT
    path: /claims/{claim_id}/payments/{id}
    description: Update payment
    request_body: PaymentUpdateRequest
    response: PaymentResponse

  - method: POST
    path: /claims/{claim_id}/payments/{id}/approve
    description: Approve payment
    request_body: ApprovalRequest
    response: PaymentResponse

  - method: POST
    path: /claims/{claim_id}/payments/{id}/process
    description: Process payment
    response: PaymentResponse

  - method: POST
    path: /claims/{claim_id}/payments/{id}/verify
    description: Verify payment received
    request_body: VerificationRequest
    response: PaymentResponse

  - method: POST
    path: /claims/{claim_id}/payments/{id}/reverse
    description: Reverse payment
    request_body: ReversalRequest
    response: PaymentResponse
