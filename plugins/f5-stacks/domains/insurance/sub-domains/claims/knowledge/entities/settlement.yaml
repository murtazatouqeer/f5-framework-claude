name: settlement
display_name: Claim Settlement
description: |
  Settlement decision and offer for insurance claims including approval,
  negotiation, and final settlement terms.

domain: insurance
subdomain: claims
category: entities
version: "1.0.0"
status: active

attributes:
  identification:
    - name: id
      type: uuid
      primary_key: true
      description: Unique settlement identifier

    - name: claim_id
      type: uuid
      foreign_key: claim.id
      required: true
      description: Associated claim

    - name: assessment_id
      type: uuid
      foreign_key: assessment.id
      description: Supporting assessment

    - name: settlement_number
      type: string
      format: "SET-{YYYYMMDD}-{NNNN}"
      unique: true
      description: Settlement reference

  classification:
    - name: settlement_type
      type: enum
      values:
        - full_payment
        - partial_payment
        - ex_gratia
        - compromise
        - denial
        - withdrawal
      required: true
      description: Type of settlement

    - name: settlement_basis
      type: enum
      values:
        - policy_terms
        - negotiation
        - court_order
        - arbitration
        - mediation
        - ex_gratia
      required: true
      description: Basis for settlement

  status:
    - name: status
      type: enum
      values:
        - draft
        - pending_approval
        - approved
        - offer_sent
        - negotiating
        - accepted
        - rejected
        - finalized
        - cancelled
      default: draft
      description: Settlement status

    - name: decision_date
      type: datetime
      description: When decision was made

  amounts:
    - name: currency
      type: string
      default: VND
      description: Currency code

    - name: claimed_amount
      type: decimal
      precision: 2
      description: Original claimed amount

    - name: assessed_amount
      type: decimal
      precision: 2
      description: Assessment amount

    - name: offered_amount
      type: decimal
      precision: 2
      required: true
      description: Settlement offer amount

    - name: accepted_amount
      type: decimal
      precision: 2
      description: Final accepted amount

    - name: deductible_amount
      type: decimal
      precision: 2
      default: 0
      description: Deductible applied

    - name: co_payment_amount
      type: decimal
      precision: 2
      default: 0
      description: Co-payment amount

    - name: salvage_deduction
      type: decimal
      precision: 2
      default: 0
      description: Salvage value deducted

    - name: other_deductions
      type: decimal
      precision: 2
      default: 0
      description: Other deductions

    - name: net_settlement
      type: decimal
      precision: 2
      computed: true
      formula: "offered_amount - deductible_amount - co_payment_amount - salvage_deduction - other_deductions"
      description: Net payable amount

  breakdown:
    - name: item_breakdown
      type: array
      items:
        type: object
        properties:
          claim_item_id: uuid
          description: string
          claimed: decimal
          approved: decimal
          reason: text
      description: Item-by-item settlement

  approval:
    - name: requires_approval
      type: boolean
      default: true
      description: Needs approval

    - name: approval_level_required
      type: enum
      values:
        - handler
        - senior_handler
        - supervisor
        - manager
        - director
        - committee
      description: Required approval level

    - name: approved_by
      type: uuid
      foreign_key: user.id
      description: Approver

    - name: approved_at
      type: datetime
      description: Approval timestamp

    - name: approval_notes
      type: text
      description: Approval comments

    - name: committee_decision
      type: object
      properties:
        meeting_date: date
        attendees: array
        decision: string
        minutes_url: string
      description: Committee decision details

  offer:
    - name: offer_date
      type: datetime
      description: When offer was sent

    - name: offer_method
      type: enum
      values:
        - email
        - letter
        - phone
        - in_person
        - portal
      description: How offer was communicated

    - name: offer_document_url
      type: string
      format: url
      description: Settlement offer letter

    - name: offer_expiry_date
      type: date
      description: Offer validity period

    - name: offer_conditions
      type: array
      items: string
      description: Conditions attached to offer

  negotiation:
    - name: negotiation_history
      type: array
      items:
        type: object
        properties:
          date: datetime
          our_offer: decimal
          counter_offer: decimal
          notes: text
          negotiator: uuid
      description: Negotiation history

    - name: negotiation_rounds
      type: integer
      default: 0
      description: Number of negotiation rounds

    - name: final_negotiated_amount
      type: decimal
      precision: 2
      description: Final negotiated amount

  response:
    - name: claimant_response
      type: enum
      values:
        - pending
        - accepted
        - counter_offered
        - rejected
        - no_response
      default: pending
      description: Claimant response

    - name: response_date
      type: datetime
      description: When claimant responded

    - name: response_notes
      type: text
      description: Claimant response details

    - name: acceptance_document_url
      type: string
      format: url
      description: Signed acceptance document

  denial:
    - name: denial_reason_code
      type: string
      description: Standard denial code

    - name: denial_reason
      type: text
      description: Detailed denial reason

    - name: denial_letter_url
      type: string
      format: url
      description: Denial letter document

    - name: appeal_eligible
      type: boolean
      default: true
      description: Can appeal decision

    - name: appeal_deadline
      type: date
      description: Appeal deadline

  release:
    - name: full_and_final
      type: boolean
      default: true
      description: Full and final settlement

    - name: release_signed
      type: boolean
      default: false
      description: Release document signed

    - name: release_document_url
      type: string
      format: url
      description: Signed release document

    - name: release_date
      type: datetime
      description: Release sign date

  processed_by:
    - name: prepared_by
      type: uuid
      foreign_key: user.id
      required: true
      description: Who prepared settlement

    - name: reviewed_by
      type: uuid
      foreign_key: user.id
      description: Reviewer

    - name: finalized_by
      type: uuid
      foreign_key: user.id
      description: Who finalized

  timestamps:
    - name: created_at
      type: datetime
      auto: true
      description: Creation timestamp

    - name: updated_at
      type: datetime
      auto: true
      on_update: true
      description: Update timestamp

    - name: finalized_at
      type: datetime
      description: When settlement finalized

relationships:
  - name: claim
    type: belongs_to
    entity: claim
    foreign_key: claim_id
    description: Associated claim

  - name: assessment
    type: belongs_to
    entity: assessment
    foreign_key: assessment_id
    description: Supporting assessment

  - name: payments
    type: has_many
    entity: payment
    foreign_key: settlement_id
    description: Related payments

state_machine:
  initial_state: draft

  states:
    - draft:
        description: Settlement being prepared
        allowed_transitions: [pending_approval]

    - pending_approval:
        description: Awaiting approval
        allowed_transitions: [approved, draft]

    - approved:
        description: Settlement approved
        allowed_transitions: [offer_sent, cancelled]

    - offer_sent:
        description: Offer communicated to claimant
        allowed_transitions: [accepted, rejected, negotiating]

    - negotiating:
        description: In negotiation
        allowed_transitions: [accepted, rejected, offer_sent]

    - accepted:
        description: Claimant accepted
        allowed_transitions: [finalized]

    - rejected:
        description: Claimant rejected
        allowed_transitions: [negotiating, cancelled]

    - finalized:
        description: Settlement complete
        final: true

    - cancelled:
        description: Settlement cancelled
        final: true

business_rules:
  - rule: BR-SET-001
    name: Assessment required
    condition: "assessment_id IS NOT NULL"
    before: approval
    error_message: "Assessment required before settlement"

  - rule: BR-SET-002
    name: Authority limit check
    condition: "offered_amount <= approval_authority(prepared_by)"
    error_message: "Amount exceeds authority limit"

  - rule: BR-SET-003
    name: Release required for payment
    condition: "full_and_final = true IMPLIES release_signed = true"
    before: finalized
    error_message: "Release document required"

  - rule: BR-SET-004
    name: Offer expiry check
    condition: "NOW() <= offer_expiry_date"
    when: "status = 'offer_sent'"
    warning_message: "Settlement offer has expired"

events:
  - name: settlement.created
    description: Settlement created
    payload: [settlement_id, claim_id, offered_amount]

  - name: settlement.approved
    description: Settlement approved
    payload: [settlement_id, approved_by, offered_amount]

  - name: settlement.offer_sent
    description: Offer sent to claimant
    payload: [settlement_id, offer_date, offered_amount]

  - name: settlement.accepted
    description: Settlement accepted
    payload: [settlement_id, accepted_amount]

  - name: settlement.rejected
    description: Settlement rejected
    payload: [settlement_id, response_notes]

  - name: settlement.finalized
    description: Settlement finalized
    payload: [settlement_id, net_settlement]

api_endpoints:
  - method: POST
    path: /claims/{claim_id}/settlements
    description: Create settlement
    request_body: SettlementCreateRequest
    response: SettlementResponse

  - method: GET
    path: /claims/{claim_id}/settlements
    description: List settlements
    response: SettlementListResponse

  - method: GET
    path: /claims/{claim_id}/settlements/{id}
    description: Get settlement details
    response: SettlementResponse

  - method: PUT
    path: /claims/{claim_id}/settlements/{id}
    description: Update settlement
    request_body: SettlementUpdateRequest
    response: SettlementResponse

  - method: POST
    path: /claims/{claim_id}/settlements/{id}/approve
    description: Approve settlement
    request_body: ApprovalRequest
    response: SettlementResponse

  - method: POST
    path: /claims/{claim_id}/settlements/{id}/send-offer
    description: Send offer to claimant
    request_body: OfferRequest
    response: SettlementResponse

  - method: POST
    path: /claims/{claim_id}/settlements/{id}/record-response
    description: Record claimant response
    request_body: ResponseRequest
    response: SettlementResponse

  - method: POST
    path: /claims/{claim_id}/settlements/{id}/finalize
    description: Finalize settlement
    response: SettlementResponse
