name: underwriting_decision
display_name: Underwriting Decision
description: |
  Final underwriting decision record capturing the outcome, terms,
  and conditions for an underwriting case.

domain: insurance
subdomain: underwriting
category: entities
version: "1.0.0"
status: active

attributes:
  identification:
    - name: id
      type: uuid
      primary_key: true
      description: Unique decision identifier

    - name: case_id
      type: uuid
      required: true
      foreign_key: underwriting_cases.id
      unique: true
      description: Reference to underwriting case

    - name: decision_number
      type: string
      format: "DEC-{case_number}"
      unique: true
      generated: true
      description: Decision reference number

  decision:
    - name: decision_type
      type: enum
      values:
        - final
        - counter_offer
        - referral
        - postponement
      required: true
      description: Type of decision

    - name: decision
      type: enum
      values:
        - accept_standard
        - accept_preferred
        - accept_rated
        - accept_with_exclusion
        - accept_rated_with_exclusion
        - decline
        - postpone
        - counter_offer
      required: true
      description: Decision outcome

    - name: decision_date
      type: timestamp
      required: true
      description: Date and time of decision

    - name: decision_reason
      type: text
      description: Detailed decision rationale

  status:
    - name: status
      type: enum
      values:
        - pending_approval
        - approved
        - communicated
        - accepted
        - rejected
        - expired
      default: pending_approval
      description: Decision status

    - name: applicant_response
      type: enum
      values:
        - pending
        - accepted
        - rejected
        - negotiating
        - expired
      default: pending
      description: Applicant's response

  original_request:
    - name: requested_sum_insured
      type: decimal
      precision: 15
      scale: 2
      description: Originally requested sum

    - name: requested_coverages
      type: array
      items:
        type: object
        properties:
          coverage_code:
            type: string
          coverage_name:
            type: string
          sum_insured:
            type: decimal
      description: Originally requested coverages

    - name: requested_premium
      type: decimal
      precision: 15
      scale: 2
      description: Premium at standard rates

  approved_terms:
    - name: approved_sum_insured
      type: decimal
      precision: 15
      scale: 2
      description: Approved sum insured

    - name: approved_coverages
      type: array
      items:
        type: object
        properties:
          coverage_code:
            type: string
          coverage_name:
            type: string
          sum_insured:
            type: decimal
          loading_percent:
            type: decimal
          exclusions:
            type: array
      description: Approved coverages with terms

    - name: risk_classification
      type: enum
      values:
        - preferred
        - standard
        - substandard_1
        - substandard_2
        - substandard_3
        - substandard_4
      description: Final risk classification

  loadings:
    - name: loading_ids
      type: array
      items:
        type: uuid
      description: Applied loading IDs

    - name: total_loading_percent
      type: decimal
      precision: 5
      scale: 2
      computed: true
      description: Combined loading percentage

    - name: loading_summary
      type: array
      items:
        type: object
        properties:
          reason:
            type: string
          loading_type:
            type: string
          loading_percent:
            type: decimal
          duration:
            type: string
      description: Loading summary

  exclusions:
    - name: exclusion_ids
      type: array
      items:
        type: uuid
      description: Applied exclusion IDs

    - name: exclusion_summary
      type: array
      items:
        type: object
        properties:
          exclusion_code:
            type: string
          exclusion_title:
            type: string
          applies_to:
            type: array
      description: Exclusion summary

  premium:
    - name: standard_premium
      type: decimal
      precision: 15
      scale: 2
      description: Premium at standard rates

    - name: loading_premium
      type: decimal
      precision: 15
      scale: 2
      description: Additional premium from loadings

    - name: final_premium
      type: decimal
      precision: 15
      scale: 2
      description: Total final premium

    - name: premium_frequency
      type: enum
      values:
        - annual
        - semi_annual
        - quarterly
        - monthly
      description: Premium payment frequency

    - name: modal_premium
      type: decimal
      precision: 15
      scale: 2
      description: Premium per payment period

    - name: currency
      type: string
      default: VND
      description: Premium currency

  counter_offer:
    - name: is_counter_offer
      type: boolean
      default: false
      description: Whether this is a counter offer

    - name: original_terms
      type: object
      properties:
        sum_insured:
          type: decimal
        coverages:
          type: array
        premium:
          type: decimal
      description: Original requested terms

    - name: counter_offer_terms
      type: object
      properties:
        sum_insured:
          type: decimal
        coverages:
          type: array
        loadings:
          type: array
        exclusions:
          type: array
        premium:
          type: decimal
      description: Counter offer terms

    - name: negotiation_room
      type: text
      description: Room for negotiation notes

  postponement:
    - name: postpone_until
      type: date
      description: Review date for postponement

    - name: postpone_reason
      type: text
      description: Reason for postponement

    - name: reapplication_conditions
      type: text
      description: Conditions for reapplication

  decline:
    - name: decline_reason_code
      type: string
      description: Decline reason code

    - name: decline_reason
      type: text
      description: Detailed decline reason

    - name: appeal_allowed
      type: boolean
      default: true
      description: Whether appeal is allowed

    - name: appeal_deadline
      type: date
      description: Deadline for appeal

  approval:
    - name: decision_authority
      type: enum
      values:
        - underwriter
        - senior_underwriter
        - chief_underwriter
        - committee
      required: true
      description: Authority level for decision

    - name: decided_by
      type: uuid
      foreign_key: users.id
      required: true
      description: Decision maker

    - name: approved_by
      type: uuid
      foreign_key: users.id
      description: Approver (if different)

    - name: approved_at
      type: timestamp
      description: Approval timestamp

    - name: approval_notes
      type: text
      description: Approval notes

  communication:
    - name: communicated_at
      type: timestamp
      description: When decision was communicated

    - name: communicated_via
      type: enum
      values:
        - email
        - letter
        - portal
        - phone
        - agent
      description: Communication channel

    - name: decision_letter_url
      type: string
      format: url
      description: Decision letter document

    - name: acceptance_deadline
      type: date
      description: Deadline for applicant response

  response:
    - name: response_received_at
      type: timestamp
      description: When response was received

    - name: response_type
      type: enum
      values:
        - accepted
        - rejected
        - counter_negotiation
        - no_response
      description: Type of response

    - name: response_notes
      type: text
      description: Response details

    - name: policy_issued_at
      type: timestamp
      description: Policy issue date if accepted

    - name: policy_id
      type: uuid
      foreign_key: policies.id
      description: Issued policy reference

  reinsurance:
    - name: reinsurance_approved
      type: boolean
      default: false
      description: Whether RI is in place

    - name: facultative_case_id
      type: uuid
      foreign_key: facultative_cases.id
      description: Facultative case if applicable

    - name: retention
      type: decimal
      precision: 15
      scale: 2
      description: Company retention

    - name: cession
      type: decimal
      precision: 15
      scale: 2
      description: Amount ceded

  validity:
    - name: decision_valid_until
      type: date
      description: Decision validity expiry

    - name: expired
      type: boolean
      computed: true
      description: Whether decision has expired

  audit:
    - name: created_at
      type: timestamp
      default: now()

    - name: updated_at
      type: timestamp

    - name: version
      type: integer
      default: 1
      description: Decision version (for amendments)

relationships:
  - name: underwriting_case
    type: belongs_to
    entity: underwriting_case
    foreign_key: case_id
    description: Parent underwriting case

  - name: loadings
    type: has_many
    entity: loading
    inverse: decision
    description: Applied loadings

  - name: exclusions
    type: has_many
    entity: exclusion
    inverse: decision
    description: Applied exclusions

  - name: decider
    type: belongs_to
    entity: user
    foreign_key: decided_by
    description: Decision maker

  - name: approver
    type: belongs_to
    entity: user
    foreign_key: approved_by
    description: Approving authority

  - name: policy
    type: has_one
    entity: policy
    foreign_key: policy_id
    description: Resulting policy

  - name: facultative_case
    type: belongs_to
    entity: facultative_case
    foreign_key: facultative_case_id
    description: Related facultative case

state_machine:
  initial: pending_approval
  states:
    pending_approval:
      description: Awaiting authority approval
      allowed_transitions: [approved]

    approved:
      description: Decision approved
      allowed_transitions: [communicated]

    communicated:
      description: Communicated to applicant
      allowed_transitions: [accepted, rejected, expired]

    accepted:
      description: Applicant accepted terms
      terminal: true

    rejected:
      description: Applicant rejected terms
      terminal: true

    expired:
      description: Decision validity expired
      terminal: true

decision_letters:
  accept_standard:
    template: UW-LTR-001
    content_includes:
      - Congratulations message
      - Policy terms
      - Premium details
      - Next steps

  accept_rated:
    template: UW-LTR-002
    content_includes:
      - Acceptance with conditions
      - Loading explanation
      - Premium breakdown
      - Acceptance form

  accept_with_exclusion:
    template: UW-LTR-003
    content_includes:
      - Acceptance with conditions
      - Exclusion details
      - Exclusion consent form
      - Premium details

  decline:
    template: UW-LTR-004
    content_includes:
      - Regret message
      - Reason (general)
      - Appeal rights
      - Contact information

  counter_offer:
    template: UW-LTR-005
    content_includes:
      - Alternative terms offered
      - Comparison to request
      - Premium for alternative
      - Response deadline

indexes:
  - columns: [case_id]
    unique: true
  - columns: [decision]
  - columns: [status]
  - columns: [decided_by]
  - columns: [decision_date]
  - columns: [acceptance_deadline]

business_rules:
  - rule: Decision must match authority level
  - rule: Decline requires senior approval
  - rule: Decision letter within 24 hours of approval
  - rule: Applicant response window 30 days
  - rule: Expired decisions require new assessment
