name: medical_exam
display_name: Medical Exam
description: |
  Individual medical examination record tracking the ordering, scheduling,
  completion, and results of medical tests for underwriting cases.

domain: insurance
subdomain: underwriting
category: entities
version: "1.0.0"
status: active

attributes:
  identification:
    - name: id
      type: uuid
      primary_key: true
      description: Unique exam identifier

    - name: exam_number
      type: string
      format: "ME-{YYYYMMDD}-{NNNNNN}"
      unique: true
      generated: true
      description: Exam reference number

    - name: case_id
      type: uuid
      required: true
      foreign_key: underwriting_cases.id
      description: Reference to underwriting case

    - name: requirement_id
      type: uuid
      foreign_key: medical_requirements.id
      description: Reference to requirement being fulfilled

  type:
    - name: exam_type
      type: enum
      values:
        - general_medical
        - basic_medical
        - full_medical
        - blood_test
        - urine_test
        - ecg
        - treadmill_stress_test
        - chest_xray
        - hiv_test
        - lipid_profile
        - liver_function_test
        - kidney_function_test
        - hba1c
        - fasting_glucose
        - psa
        - pap_smear
        - mammogram
        - specialist_consultation
        - attending_physician_statement
      required: true
      description: Type of examination

    - name: exam_category
      type: enum
      values:
        - physical
        - laboratory
        - diagnostic
        - specialist
        - records
      description: Exam category

  status:
    - name: status
      type: enum
      values:
        - ordered
        - scheduled
        - completed
        - results_received
        - reviewed
        - expired
        - cancelled
      default: ordered
      description: Current exam status

    - name: substatus
      type: string
      description: Detailed status info

  scheduling:
    - name: medical_provider_id
      type: uuid
      foreign_key: medical_providers.id
      description: Assigned medical provider

    - name: provider_name
      type: string
      description: Provider name

    - name: provider_location
      type: string
      description: Exam location

    - name: ordered_date
      type: date
      description: Date exam was ordered

    - name: scheduled_date
      type: date
      description: Scheduled appointment date

    - name: scheduled_time
      type: time
      description: Scheduled appointment time

    - name: completed_date
      type: date
      description: Date exam was completed

    - name: applicant_notified
      type: boolean
      default: false
      description: Whether applicant was notified

    - name: notification_sent_at
      type: timestamp
      description: Notification timestamp

  results:
    - name: results_received_at
      type: timestamp
      description: When results were received

    - name: results_summary
      type: jsonb
      description: Structured results data

    - name: overall_result
      type: enum
      values:
        - normal
        - abnormal
        - borderline
        - critical
      description: Overall result classification

    - name: abnormal_findings
      type: array
      items:
        type: object
        properties:
          finding:
            type: string
          severity:
            type: enum
            values: [mild, moderate, severe]
          clinical_significance:
            type: string
          follow_up_recommended:
            type: boolean
      description: Abnormal findings list

    - name: normal_range_deviations
      type: array
      items:
        type: object
        properties:
          test_name:
            type: string
          result_value:
            type: string
          normal_range:
            type: string
          deviation_percentage:
            type: decimal
      description: Values outside normal range

  physical_exam_results:
    - name: height_cm
      type: decimal
      precision: 5
      scale: 1
      description: Height in centimeters

    - name: weight_kg
      type: decimal
      precision: 5
      scale: 1
      description: Weight in kilograms

    - name: bmi
      type: decimal
      precision: 4
      scale: 1
      computed: true
      description: Body Mass Index

    - name: blood_pressure
      type: object
      properties:
        systolic:
          type: integer
        diastolic:
          type: integer
        position:
          type: enum
          values: [sitting, standing, lying]
        arm:
          type: enum
          values: [left, right]
      description: Blood pressure reading

    - name: pulse_rate
      type: integer
      description: Pulse rate per minute

    - name: respiratory_rate
      type: integer
      description: Respiratory rate per minute

    - name: general_appearance
      type: text
      description: General appearance notes

    - name: systems_review
      type: object
      properties:
        cardiovascular:
          type: object
          properties:
            finding:
              type: string
            normal:
              type: boolean
        respiratory:
          type: object
          properties:
            finding:
              type: string
            normal:
              type: boolean
        gastrointestinal:
          type: object
          properties:
            finding:
              type: string
            normal:
              type: boolean
        neurological:
          type: object
          properties:
            finding:
              type: string
            normal:
              type: boolean
        musculoskeletal:
          type: object
          properties:
            finding:
              type: string
            normal:
              type: boolean
      description: Systems review findings

  lab_results:
    - name: cholesterol
      type: object
      properties:
        total:
          type: decimal
        hdl:
          type: decimal
        ldl:
          type: decimal
        triglycerides:
          type: decimal
        ratio:
          type: decimal
        unit:
          type: string
          default: "mg/dL"
      description: Cholesterol panel

    - name: blood_glucose
      type: object
      properties:
        fasting:
          type: decimal
        random:
          type: decimal
        hba1c:
          type: decimal
        unit:
          type: string
          default: "mg/dL"
      description: Blood glucose results

    - name: liver_function
      type: object
      properties:
        sgot:
          type: decimal
        sgpt:
          type: decimal
        ggt:
          type: decimal
        bilirubin_total:
          type: decimal
        bilirubin_direct:
          type: decimal
        albumin:
          type: decimal
      description: Liver function panel

    - name: kidney_function
      type: object
      properties:
        creatinine:
          type: decimal
        bun:
          type: decimal
        egfr:
          type: decimal
        uric_acid:
          type: decimal
      description: Kidney function panel

    - name: complete_blood_count
      type: object
      properties:
        hemoglobin:
          type: decimal
        hematocrit:
          type: decimal
        wbc:
          type: decimal
        platelets:
          type: decimal
        rbc:
          type: decimal
      description: CBC results

    - name: urinalysis
      type: object
      properties:
        protein:
          type: string
        glucose:
          type: string
        blood:
          type: string
        ph:
          type: decimal
        specific_gravity:
          type: decimal
      description: Urinalysis results

    - name: hiv_status
      type: object
      properties:
        result:
          type: enum
          values: [negative, positive, indeterminate]
        test_type:
          type: string
        confirmatory_done:
          type: boolean
      description: HIV test result

  ecg_results:
    - name: ecg_findings
      type: object
      properties:
        rhythm:
          type: string
        rate:
          type: integer
        axis:
          type: string
        intervals:
          type: object
          properties:
            pr:
              type: decimal
            qrs:
              type: decimal
            qt:
              type: decimal
            qtc:
              type: decimal
        findings:
          type: array
          items:
            type: string
        interpretation:
          type: string
        normal:
          type: boolean
      description: ECG results

  stress_test_results:
    - name: stress_test
      type: object
      properties:
        protocol:
          type: string
        duration_minutes:
          type: decimal
        max_heart_rate:
          type: integer
        target_heart_rate:
          type: integer
        percent_target_achieved:
          type: decimal
        mets_achieved:
          type: decimal
        symptoms:
          type: array
          items:
            type: string
        ecg_changes:
          type: array
          items:
            type: string
        blood_pressure_response:
          type: string
        interpretation:
          type: string
        result:
          type: enum
          values: [negative, positive, inconclusive]
      description: Stress test results

  imaging_results:
    - name: chest_xray
      type: object
      properties:
        findings:
          type: text
        heart_size:
          type: string
        lung_fields:
          type: string
        abnormalities:
          type: array
          items:
            type: string
        impression:
          type: string
        normal:
          type: boolean
      description: Chest X-ray results

  review:
    - name: reviewed_by
      type: uuid
      foreign_key: users.id
      description: Medical officer who reviewed

    - name: reviewed_at
      type: timestamp
      description: Review timestamp

    - name: medical_opinion
      type: text
      description: Medical officer's opinion

    - name: impairment_rating
      type: string
      description: Assigned impairment rating

    - name: recommended_action
      type: enum
      values:
        - accept_standard
        - accept_with_loading
        - accept_with_exclusion
        - decline
        - postpone
        - additional_tests_needed
      description: Recommended underwriting action

    - name: additional_tests_requested
      type: array
      items:
        type: string
      description: Additional tests if needed

  documents:
    - name: report_url
      type: string
      format: url
      description: Main report document URL

    - name: lab_results_url
      type: string
      format: url
      description: Lab results document URL

    - name: additional_documents
      type: array
      items:
        type: object
        properties:
          document_type:
            type: string
          url:
            type: string
          uploaded_at:
            type: timestamp
      description: Additional documents

  cost:
    - name: exam_cost
      type: decimal
      precision: 10
      scale: 2
      description: Cost of examination

    - name: currency
      type: string
      default: VND
      description: Cost currency

    - name: paid_by
      type: enum
      values:
        - insurer
        - applicant
        - shared
      description: Who paid for exam

  validity:
    - name: valid_until
      type: date
      computed: true
      description: Results valid until date

    - name: expired
      type: boolean
      computed: true
      description: Whether results have expired

  audit:
    - name: created_at
      type: timestamp
      default: now()

    - name: updated_at
      type: timestamp

    - name: notes
      type: text
      description: General notes

relationships:
  - name: underwriting_case
    type: belongs_to
    entity: underwriting_case
    foreign_key: case_id
    description: Parent underwriting case

  - name: requirement
    type: belongs_to
    entity: medical_requirement
    foreign_key: requirement_id
    description: Requirement being fulfilled

  - name: provider
    type: belongs_to
    entity: medical_provider
    foreign_key: medical_provider_id
    description: Medical provider

  - name: reviewer
    type: belongs_to
    entity: user
    foreign_key: reviewed_by
    description: Reviewing medical officer

state_machine:
  initial: ordered
  states:
    ordered:
      description: Exam ordered, pending scheduling
      allowed_transitions: [scheduled, cancelled]

    scheduled:
      description: Appointment scheduled
      allowed_transitions: [completed, cancelled, ordered]

    completed:
      description: Exam completed, awaiting results
      allowed_transitions: [results_received]

    results_received:
      description: Results received, pending review
      allowed_transitions: [reviewed]

    reviewed:
      description: Results reviewed by medical officer
      terminal: true

    expired:
      description: Results have expired
      terminal: true

    cancelled:
      description: Exam cancelled
      terminal: true

indexes:
  - columns: [exam_number]
    unique: true
  - columns: [case_id]
  - columns: [status]
  - columns: [exam_type]
  - columns: [scheduled_date]
  - columns: [created_at]
