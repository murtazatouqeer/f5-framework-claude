name: medical_requirement
display_name: Medical Requirement
description: |
  Configuration entity defining medical examination and testing requirements
  based on age, sum insured, and other risk indicators.

domain: insurance
subdomain: underwriting
category: entities
version: "1.0.0"
status: active

attributes:
  identification:
    - name: id
      type: uuid
      primary_key: true
      description: Unique requirement identifier

    - name: requirement_code
      type: string
      required: true
      unique: true
      description: Unique requirement code

    - name: requirement_name
      type: string
      required: true
      description: Requirement display name

    - name: description
      type: text
      description: Detailed description

    - name: status
      type: enum
      values:
        - active
        - discontinued
        - under_review
      default: active
      description: Requirement status

  type:
    - name: requirement_type
      type: enum
      values:
        - health_declaration
        - basic_medical_exam
        - full_medical_exam
        - blood_test
        - urine_test
        - ecg
        - stress_test
        - chest_xray
        - hiv_test
        - lipid_profile
        - liver_function
        - kidney_function
        - hba1c
        - fasting_glucose
        - psa_test
        - pap_smear
        - mammogram
        - specialist_report
        - attending_physician_statement
        - hospital_records
      required: true
      description: Type of medical requirement

    - name: category
      type: enum
      values:
        - declaration
        - physical_exam
        - laboratory
        - diagnostic
        - specialist
        - medical_records
      description: Requirement category

  triggers:
    - name: age_trigger
      type: object
      properties:
        min_age:
          type: integer
          description: Minimum age (inclusive)
        max_age:
          type: integer
          description: Maximum age (inclusive)
        applies_to_all_ages:
          type: boolean
          default: false
      description: Age-based trigger

    - name: sum_insured_trigger
      type: object
      properties:
        min_sum:
          type: decimal
          description: Minimum sum insured
        max_sum:
          type: decimal
          description: Maximum sum insured
        currency:
          type: string
          default: VND
      description: Sum insured trigger

    - name: product_triggers
      type: array
      items:
        type: object
        properties:
          product_code:
            type: string
          product_name:
            type: string
      description: Product-specific triggers

    - name: medical_history_triggers
      type: array
      items:
        type: object
        properties:
          condition:
            type: string
          icd_codes:
            type: array
          description:
            type: string
      description: Conditions that trigger requirement

    - name: always_required
      type: boolean
      default: false
      description: Whether always required regardless of triggers

  details:
    - name: tests_included
      type: array
      items:
        type: object
        properties:
          test_code:
            type: string
          test_name:
            type: string
          description:
            type: string
      description: Specific tests within requirement

    - name: specimen_type
      type: enum
      values:
        - blood
        - urine
        - saliva
        - none
      description: Specimen type for lab tests

    - name: fasting_required
      type: boolean
      default: false
      description: Whether fasting is required

    - name: fasting_hours
      type: integer
      description: Hours of fasting required

  logistics:
    - name: typical_cost
      type: decimal
      precision: 10
      scale: 2
      description: Typical cost for budgeting

    - name: currency
      type: string
      default: VND
      description: Cost currency

    - name: who_pays
      type: enum
      values:
        - insurer
        - applicant
        - shared
      default: insurer
      description: Cost responsibility

    - name: turnaround_days
      type: integer
      description: Expected turnaround time

    - name: valid_for_days
      type: integer
      description: How long result remains valid

    - name: can_use_existing
      type: boolean
      default: true
      description: Can use existing recent results

    - name: existing_valid_days
      type: integer
      description: Age limit for existing results

  providers:
    - name: approved_providers
      type: array
      items:
        type: object
        properties:
          provider_id:
            type: uuid
          provider_name:
            type: string
          provider_type:
            type: string
          locations:
            type: array
      description: List of approved providers

    - name: home_collection_available
      type: boolean
      default: false
      description: Whether home collection available

  gender_specific:
    - name: gender_applicability
      type: enum
      values:
        - all
        - male_only
        - female_only
      default: all
      description: Gender-specific requirement

    - name: alternative_for_gender
      type: object
      properties:
        gender:
          type: enum
          values: [male, female]
        alternative_requirement_code:
          type: string
      description: Alternative for opposite gender

  waiver:
    - name: waiver_allowed
      type: boolean
      default: false
      description: Whether requirement can be waived

    - name: waiver_conditions
      type: text
      description: Conditions for waiver

    - name: waiver_authority
      type: enum
      values:
        - underwriter
        - senior_underwriter
        - chief_underwriter
        - not_allowed
      description: Who can approve waiver

  audit:
    - name: effective_date
      type: date
      description: When requirement became effective

    - name: expiry_date
      type: date
      description: When requirement expires

    - name: created_at
      type: timestamp
      default: now()

    - name: updated_at
      type: timestamp

relationships:
  - name: products
    type: many_to_many
    entity: product
    through: product_medical_requirements
    description: Products requiring this

  - name: medical_exams
    type: has_many
    entity: medical_exam
    inverse: requirement
    description: Exams fulfilling requirement

requirement_matrices:
  life_insurance:
    description: Standard life insurance requirements
    matrix:
      - age_range: "18-30"
        tiers:
          - max_sum: 500000000
            requirements: [health_declaration]
          - max_sum: 1000000000
            requirements: [health_declaration, basic_medical_exam, blood_test, urine_test]
          - max_sum: 3000000000
            requirements: [health_declaration, full_medical_exam, blood_test, urine_test, ecg, lipid_profile]
          - max_sum: null
            requirements: [health_declaration, full_medical_exam, blood_test, urine_test, ecg, stress_test, chest_xray, lipid_profile]

      - age_range: "31-40"
        tiers:
          - max_sum: 300000000
            requirements: [health_declaration]
          - max_sum: 500000000
            requirements: [health_declaration, basic_medical_exam, blood_test, urine_test]
          - max_sum: 2000000000
            requirements: [health_declaration, full_medical_exam, blood_test, urine_test, ecg, lipid_profile]
          - max_sum: null
            requirements: [health_declaration, full_medical_exam, blood_test, urine_test, ecg, stress_test, chest_xray, lipid_profile]

      - age_range: "41-50"
        tiers:
          - max_sum: 200000000
            requirements: [health_declaration, basic_medical_exam]
          - max_sum: 500000000
            requirements: [health_declaration, full_medical_exam, blood_test, urine_test, ecg]
          - max_sum: 1000000000
            requirements: [health_declaration, full_medical_exam, blood_test, urine_test, ecg, stress_test, lipid_profile]
          - max_sum: null
            requirements: [health_declaration, full_medical_exam, blood_test, urine_test, ecg, stress_test, chest_xray, lipid_profile, specialist_report]

      - age_range: "51+"
        tiers:
          - max_sum: 0
            requirements: [health_declaration, full_medical_exam, blood_test, urine_test, ecg, stress_test, chest_xray, lipid_profile]

  critical_illness:
    description: Critical illness specific requirements
    additional_requirements:
      - all_sums: [hba1c, lipid_profile]
      - above_1b: [stress_test]

indexes:
  - columns: [requirement_code]
    unique: true
  - columns: [requirement_type]
  - columns: [status]
  - columns: [category]

business_rules:
  - rule: HIV test requires specific consent
  - rule: Stress test contraindicated for certain conditions
  - rule: Results validity based on requirement type
  - rule: Age at nearest birthday for calculations
