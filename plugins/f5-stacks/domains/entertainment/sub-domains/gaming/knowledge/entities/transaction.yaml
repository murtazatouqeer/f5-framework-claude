name: transaction
display_name: Transaction
description: |
  Records all financial transactions including purchases,
  trades, gifts, and currency exchanges.

domain: entertainment
subdomain: gaming
category: entities
version: "1.0.0"
status: active

attributes:
  # Identity
  - name: id
    type: uuid
    required: true
    description: Unique transaction identifier

  - name: transaction_id
    type: string
    required: true
    unique: true
    description: Public transaction ID
    example: "TXN-20240115-ABC123XYZ"

  - name: player_id
    type: uuid
    required: true
    description: Player who initiated transaction

  - name: game_id
    type: uuid
    required: false
    description: Game context (if game-specific)

  # Type
  - name: transaction_type
    type: enum
    values: [purchase, subscription, trade, gift_sent, gift_received, refund, currency_exchange, reward, admin_grant, admin_revoke]
    required: true

  - name: status
    type: enum
    values: [pending, processing, completed, failed, cancelled, refunded, disputed]
    required: true
    default: pending

  # Items/Products
  - name: items
    type: json
    required: false
    description: |
      Items involved:
      - item_id: "...", quantity: 1, price: 500
      - item_id: "...", quantity: 2, price: 100

  - name: product_sku
    type: string
    required: false
    description: Store product SKU

  - name: product_name
    type: string
    required: false
    description: Product display name

  # Currency - What was paid
  - name: payment_method
    type: enum
    values: [premium_currency, soft_currency, real_money, trade, gift, reward, free]
    required: true

  - name: payment_amount
    type: decimal
    required: true
    description: Amount paid

  - name: payment_currency
    type: string
    required: true
    description: Currency type
    example: "gems" or "USD"

  # Currency - What was received (for exchanges)
  - name: received_amount
    type: decimal
    required: false

  - name: received_currency
    type: string
    required: false

  # Real Money Details
  - name: real_money_amount
    type: decimal
    required: false

  - name: real_money_currency
    type: string
    required: false
    default: "USD"

  - name: payment_provider
    type: enum
    values: [stripe, paypal, apple_iap, google_play, steam, xbox, playstation, direct]
    required: false

  - name: payment_provider_id
    type: string
    required: false
    description: Provider's transaction ID

  - name: payment_method_last4
    type: string
    required: false
    description: Last 4 digits of payment method

  # Tax
  - name: tax_amount
    type: decimal
    required: false
    default: 0

  - name: tax_rate
    type: decimal
    required: false

  - name: tax_country
    type: string
    required: false

  # Discounts
  - name: discount_amount
    type: decimal
    required: false
    default: 0

  - name: discount_code
    type: string
    required: false

  - name: discount_reason
    type: string
    required: false

  # Totals
  - name: subtotal
    type: decimal
    required: true

  - name: total
    type: decimal
    required: true
    description: Final amount after tax/discounts

  # Trade Details
  - name: trade_partner_id
    type: uuid
    required: false
    description: Other player in trade

  - name: items_given
    type: json
    required: false

  - name: items_received
    type: json
    required: false

  # Gift Details
  - name: gift_recipient_id
    type: uuid
    required: false

  - name: gift_message
    type: string
    required: false
    max_length: 500

  - name: gift_anonymous
    type: boolean
    required: false
    default: false

  # Subscription Details
  - name: subscription_id
    type: uuid
    required: false

  - name: subscription_period
    type: string
    required: false
    description: "monthly", "yearly", etc.

  - name: subscription_start
    type: datetime
    required: false

  - name: subscription_end
    type: datetime
    required: false

  - name: is_renewal
    type: boolean
    required: false
    default: false

  # Refund Details
  - name: original_transaction_id
    type: uuid
    required: false
    description: Original transaction (for refunds)

  - name: refund_reason
    type: string
    required: false

  - name: refund_amount
    type: decimal
    required: false

  # Balance Changes
  - name: balance_before
    type: json
    required: false
    description: Balances before transaction

  - name: balance_after
    type: json
    required: false
    description: Balances after transaction

  # Metadata
  - name: platform
    type: enum
    values: [pc, ps5, xbox, switch, mobile_ios, mobile_android, web]
    required: false

  - name: ip_address
    type: string
    required: false

  - name: device_id
    type: string
    required: false

  - name: session_id
    type: string
    required: false

  - name: notes
    type: text
    required: false

  # Timestamps
  - name: created_at
    type: datetime
    required: true
    auto: true

  - name: processed_at
    type: datetime
    required: false

  - name: completed_at
    type: datetime
    required: false

  - name: updated_at
    type: datetime
    required: true
    auto: true

relationships:
  - name: player
    type: belongs_to
    target: player
    foreign_key: player_id

  - name: game
    type: belongs_to
    target: game
    foreign_key: game_id

  - name: trade_partner
    type: belongs_to
    target: player
    foreign_key: trade_partner_id

  - name: gift_recipient
    type: belongs_to
    target: player
    foreign_key: gift_recipient_id

  - name: original_transaction
    type: belongs_to
    target: transaction
    foreign_key: original_transaction_id

indexes:
  - name: idx_txn_player
    fields: [player_id]
    type: btree

  - name: idx_txn_game
    fields: [game_id]
    type: btree

  - name: idx_txn_type
    fields: [transaction_type]
    type: btree

  - name: idx_txn_status
    fields: [status]
    type: btree

  - name: idx_txn_created
    fields: [created_at]
    type: btree

  - name: idx_txn_provider
    fields: [payment_provider, payment_provider_id]
    type: btree

validations:
  - name: valid_total
    condition: "total >= 0"
    message: "Total cannot be negative"

  - name: trade_has_partner
    condition: "transaction_type != 'trade' OR trade_partner_id IS NOT NULL"
    message: "Trade transactions need a partner"

business_rules:
  - rule: economy-rules
    description: Purchase and transaction rules
