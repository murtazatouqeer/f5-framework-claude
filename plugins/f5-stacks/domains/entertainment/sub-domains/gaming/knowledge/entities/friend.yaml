name: friend
display_name: Friend Relationship
description: |
  Represents friend connections between players.
  Manages friend requests, status, and interaction.

domain: entertainment
subdomain: gaming
category: entities
version: "1.0.0"
status: active

attributes:
  # Identity
  - name: id
    type: uuid
    required: true
    description: Unique friendship identifier

  - name: player_id
    type: uuid
    required: true
    description: Player who owns this relationship

  - name: friend_id
    type: uuid
    required: true
    description: The friend player

  # Status
  - name: status
    type: enum
    values: [pending_sent, pending_received, accepted, blocked, removed]
    required: true
    default: pending_sent

  # Categorization
  - name: nickname
    type: string
    required: false
    max_length: 30
    description: Custom nickname for friend

  - name: group
    type: string
    required: false
    description: Friend group/category
    example: "Work Friends"

  - name: favorite
    type: boolean
    required: true
    default: false
    description: Marked as favorite/close friend

  # Privacy
  - name: can_see_activity
    type: boolean
    required: true
    default: true
    description: Friend can see online activity

  - name: can_see_games
    type: boolean
    required: true
    default: true
    description: Friend can see game library

  - name: can_invite_to_game
    type: boolean
    required: true
    default: true
    description: Friend can send game invites

  - name: can_message
    type: boolean
    required: true
    default: true
    description: Friend can send direct messages

  # Interaction
  - name: games_played_together
    type: integer
    required: true
    default: 0
    description: Games played together

  - name: time_played_together_hours
    type: decimal
    required: true
    default: 0
    description: Hours played together

  - name: last_played_together_at
    type: datetime
    required: false

  - name: last_interaction_at
    type: datetime
    required: false
    description: Last message/activity

  # Request Details
  - name: request_message
    type: string
    required: false
    max_length: 200
    description: Friend request message

  - name: request_source
    type: enum
    values: [search, in_game, mutual, import, suggested]
    required: false
    description: How they connected

  - name: mutual_friends_count
    type: integer
    required: false
    default: 0

  # Timestamps
  - name: created_at
    type: datetime
    required: true
    auto: true
    description: When request was sent

  - name: accepted_at
    type: datetime
    required: false
    description: When friendship was accepted

  - name: blocked_at
    type: datetime
    required: false

  - name: updated_at
    type: datetime
    required: true
    auto: true

relationships:
  - name: player
    type: belongs_to
    target: player
    foreign_key: player_id

  - name: friend
    type: belongs_to
    target: player
    foreign_key: friend_id

indexes:
  - name: idx_friend_player
    fields: [player_id]
    type: btree

  - name: idx_friend_pair
    fields: [player_id, friend_id]
    type: unique

  - name: idx_friend_status
    fields: [player_id, status]
    type: btree

  - name: idx_friend_favorite
    fields: [player_id, favorite]
    type: btree

validations:
  - name: not_self_friend
    condition: "player_id != friend_id"
    message: "Cannot friend yourself"

state_machine:
  initial: pending_sent
  states:
    - name: pending_sent
      description: Request sent, awaiting response
      allowed_transitions: [accepted, removed]

    - name: pending_received
      description: Request received from other player
      allowed_transitions: [accepted, blocked, removed]

    - name: accepted
      description: Active friendship
      allowed_transitions: [blocked, removed]

    - name: blocked
      description: Player blocked
      allowed_transitions: [removed]

    - name: removed
      description: Friendship ended
      allowed_transitions: []
      terminal: true

business_rules:
  - rule: moderation-rules
    description: Friend request and blocking rules
