name: match
display_name: Match
description: |
  Represents a multiplayer game match/lobby.
  Tracks players, teams, timeline, and results.

domain: entertainment
subdomain: gaming
category: entities
version: "1.0.0"
status: active

attributes:
  # Identity
  - name: id
    type: uuid
    required: true
    description: Unique match identifier

  - name: match_id
    type: string
    required: true
    unique: true
    description: Public match ID
    example: "MTH-20240115-ABC123XYZ"

  - name: game_id
    type: uuid
    required: true
    description: Game this match belongs to

  # Status
  - name: status
    type: enum
    values: [creating, waiting, ready, starting, in_progress, paused, completed, cancelled, abandoned]
    required: true
    default: creating

  - name: match_type
    type: enum
    values: [ranked, casual, private, custom, tournament, practice]
    required: true

  # Configuration
  - name: game_mode
    type: string
    required: true
    description: Game mode played
    example: "team_deathmatch"

  - name: map_id
    type: string
    required: false
    description: Map/arena identifier

  - name: map_name
    type: string
    required: false
    description: Map display name

  - name: settings
    type: json
    required: false
    description: Custom match settings

  # Player Configuration
  - name: max_players
    type: integer
    required: true
    description: Maximum players allowed

  - name: min_players
    type: integer
    required: true
    description: Minimum players to start

  - name: current_players
    type: integer
    required: true
    default: 0

  - name: team_size
    type: integer
    required: false
    description: Players per team

  - name: team_count
    type: integer
    required: false
    description: Number of teams

  - name: allow_join_in_progress
    type: boolean
    required: true
    default: false

  # Region
  - name: region
    type: string
    required: true
    description: Server region
    example: "us-east-1"

  - name: server_id
    type: string
    required: false
    description: Game server identifier

  # Timeline
  - name: created_at
    type: datetime
    required: true
    auto: true

  - name: ready_at
    type: datetime
    required: false
    description: When enough players joined

  - name: started_at
    type: datetime
    required: false
    description: Match start time

  - name: ended_at
    type: datetime
    required: false
    description: Match end time

  - name: duration_seconds
    type: integer
    required: false
    description: Match duration

  # Results
  - name: winner_type
    type: enum
    values: [player, team, draw, none]
    required: false

  - name: winner_team_id
    type: string
    required: false
    description: Winning team ID

  - name: winner_player_ids
    type: array
    items: uuid
    required: false
    description: Winning player(s)

  - name: final_scores
    type: json
    required: false
    description: Final score breakdown

  - name: mvp_player_id
    type: uuid
    required: false
    description: Most valuable player

  # Match Data
  - name: rounds_played
    type: integer
    required: false
    default: 1

  - name: total_kills
    type: integer
    required: false
    default: 0

  - name: match_events
    type: json
    required: false
    description: Key match events log

  # Anti-cheat
  - name: cheat_detected
    type: boolean
    required: true
    default: false

  - name: flagged_players
    type: array
    items: uuid
    required: false
    description: Players flagged for review

  - name: anti_cheat_version
    type: string
    required: false

  # Replay
  - name: replay_available
    type: boolean
    required: true
    default: false

  - name: replay_url
    type: string
    required: false

  - name: replay_expiry
    type: datetime
    required: false

  # Tournament
  - name: tournament_id
    type: uuid
    required: false

  - name: tournament_round
    type: integer
    required: false

  - name: bracket_position
    type: string
    required: false

  # Audit
  - name: updated_at
    type: datetime
    required: true
    auto: true

relationships:
  - name: game
    type: belongs_to
    target: game
    foreign_key: game_id

  - name: tournament
    type: belongs_to
    target: tournament
    foreign_key: tournament_id

  - name: sessions
    type: has_many
    target: game_session
    foreign_key: match_id

  - name: participants
    type: has_many
    target: match_participant
    foreign_key: match_id

  - name: teams
    type: has_many
    target: match_team
    foreign_key: match_id

indexes:
  - name: idx_match_game
    fields: [game_id]
    type: btree

  - name: idx_match_status
    fields: [status]
    type: btree

  - name: idx_match_type
    fields: [match_type]
    type: btree

  - name: idx_match_tournament
    fields: [tournament_id]
    type: btree

  - name: idx_match_created
    fields: [created_at]
    type: btree

# Embedded entities
embedded_entities:
  - name: match_participant
    attributes:
      - name: id
        type: uuid
        required: true

      - name: match_id
        type: uuid
        required: true

      - name: player_id
        type: uuid
        required: true

      - name: team_id
        type: string
        required: false

      - name: status
        type: enum
        values: [invited, joined, ready, playing, finished, left, kicked, disconnected]
        required: true
        default: joined

      - name: slot
        type: integer
        required: false
        description: Player slot number

      - name: character
        type: string
        required: false

      - name: loadout
        type: json
        required: false

      # Performance
      - name: score
        type: integer
        required: false
        default: 0

      - name: kills
        type: integer
        required: false
        default: 0

      - name: deaths
        type: integer
        required: false
        default: 0

      - name: assists
        type: integer
        required: false
        default: 0

      - name: damage_dealt
        type: integer
        required: false
        default: 0

      - name: healing_done
        type: integer
        required: false
        default: 0

      - name: objectives_completed
        type: integer
        required: false
        default: 0

      - name: placement
        type: integer
        required: false

      - name: custom_stats
        type: json
        required: false

      # Rewards
      - name: xp_earned
        type: integer
        required: false
        default: 0

      - name: mmr_change
        type: integer
        required: false

      - name: rank_change
        type: string
        required: false

      # Timing
      - name: joined_at
        type: datetime
        required: true

      - name: left_at
        type: datetime
        required: false

  - name: match_team
    attributes:
      - name: id
        type: uuid
        required: true

      - name: match_id
        type: uuid
        required: true

      - name: team_id
        type: string
        required: true

      - name: name
        type: string
        required: false

      - name: color
        type: string
        required: false

      - name: score
        type: integer
        required: false
        default: 0

      - name: placement
        type: integer
        required: false

      - name: is_winner
        type: boolean
        required: false
        default: false

business_rules:
  - rule: matchmaking-rules
    description: Player matching and balance
  - rule: tournament-rules
    description: Tournament match rules
