name: recommendation_generation_rules
display_name: Recommendation Generation Rules
description: |
  Business rules for generating, displaying, and optimizing
  personalized content recommendations.

domain: entertainment
subdomain: streaming
category: business-rules
version: "1.0.0"
status: active

rule_categories:
  - personalization
  - content_filtering
  - diversity_requirements
  - freshness_rules
  - business_priorities

rules:
  # ============================================
  # Personalization Rules
  # ============================================
  - id: RGR-001
    name: Minimum Watch History for Personalization
    description: Require minimum viewing data before personalized recommendations
    category: personalization
    severity: medium

    parameters:
      minimum_titles_watched: 5
      minimum_watch_time_hours: 3

    conditions:
      when:
        - field: profile.titles_watched
          operator: less_than
          value: 5

    actions:
      on_insufficient_data:
        - use_popularity_based_recommendations
        - show_genre_preference_survey
        - include_trending_content
        - display_editorial_picks
      on_sufficient_data:
        - enable_collaborative_filtering
        - enable_content_based_filtering
        - enable_hybrid_algorithms

  - id: RGR-002
    name: Profile-Specific Recommendations
    description: Generate recommendations per profile, not account
    category: personalization
    severity: high

    conditions:
      always:
        - evaluate: "Each profile has independent recommendation model"
        - evaluate: "No cross-profile data leakage"
        - evaluate: "Kids profiles use age-appropriate algorithm"

    actions:
      enforcement:
        - isolate_profile_data
        - train_separate_models
        - apply_profile_maturity_filter

  - id: RGR-003
    name: Recency Weighting
    description: Recent viewing behavior weighted more heavily
    category: personalization
    severity: low

    parameters:
      time_decay:
        last_7_days: 1.0
        last_30_days: 0.7
        last_90_days: 0.4
        older: 0.1

    conditions:
      when:
        - event: recommendation_generation

    actions:
      on_generation:
        - apply_time_decay_weights
        - favor_recent_preferences
        - detect_preference_shifts

  - id: RGR-004
    name: Completion-Based Preference
    description: Weight completed content higher in preference modeling
    category: personalization
    severity: low

    parameters:
      completion_weights:
        completed: 1.0
        more_than_75_percent: 0.8
        more_than_50_percent: 0.5
        less_than_25_percent: 0.1
        abandoned: -0.3

    conditions:
      when:
        - event: preference_calculation

    actions:
      on_calculation:
        - apply_completion_weights
        - penalize_abandoned_genres
        - boost_binge_watched_patterns

  # ============================================
  # Content Filtering
  # ============================================
  - id: RGR-010
    name: Age Rating Filter
    description: Filter recommendations by profile maturity setting
    category: content_filtering
    severity: critical

    parameters:
      maturity_mappings:
        all: [G, TV-Y]
        children: [G, PG, TV-Y, TV-G, TV-PG]
        teens: [G, PG, PG-13, TV-Y, TV-G, TV-PG, TV-14]
        adults: [G, PG, PG-13, R, NC-17, TV-Y, TV-G, TV-PG, TV-14, TV-MA]

    conditions:
      when:
        - event: recommendation_generation

    actions:
      enforcement:
        - filter_by_maturity_level
        - never_override_for_kids
        - log_filtered_content

  - id: RGR-011
    name: Already Watched Filter
    description: Exclude recently watched content from recommendations
    category: content_filtering
    severity: medium

    parameters:
      exclusion_periods:
        completed_movie: 90 days
        completed_series: 180 days
        in_progress: never_exclude
        abandoned: 30 days

    conditions:
      when:
        - event: recommendation_generation

    actions:
      on_generation:
        - exclude_completed_content
        - boost_continue_watching
        - allow_rewatch_suggestions_section

  - id: RGR-012
    name: Watchlist Integration
    description: Include watchlist items in recommendations
    category: content_filtering
    severity: low

    conditions:
      when:
        - field: profile.watchlist
          operator: is_not_empty

    actions:
      on_generation:
        - boost_watchlist_items: "1.5x"
        - include_similar_to_watchlist
        - prioritize_newly_available_watchlist

  - id: RGR-013
    name: Explicit Dismissal Handling
    description: Respect user dismissals in recommendations
    category: content_filtering
    severity: high

    conditions:
      when:
        - field: content.dismissed_by_user
          operator: equals
          value: true

    actions:
      on_dismissal:
        - exclude_from_recommendations: 365 days
        - reduce_similar_content_score
        - learn_negative_preference

  # ============================================
  # Diversity Requirements
  # ============================================
  - id: RGR-020
    name: Genre Diversity
    description: Ensure recommendations span multiple genres
    category: diversity_requirements
    severity: medium

    parameters:
      minimum_genres: 3
      max_same_genre_percent: 40

    conditions:
      when:
        - event: recommendation_list_generation

    actions:
      on_generation:
        - ensure_genre_mix
        - introduce_exploration_genres
        - prevent_filter_bubble

  - id: RGR-021
    name: Content Type Diversity
    description: Mix movies, series, and other content types
    category: diversity_requirements
    severity: low

    parameters:
      target_mix:
        movies: 40-60%
        series: 30-50%
        documentaries: 5-15%
        other: 0-10%

    conditions:
      when:
        - event: homepage_recommendations

    actions:
      on_generation:
        - balance_content_types
        - respect_user_preferences
        - adjust_based_on_time_of_day

  - id: RGR-022
    name: Discovery vs Relevance Balance
    description: Balance safe recommendations with discovery
    category: diversity_requirements
    severity: low

    parameters:
      safe_recommendations: 70%
      discovery_recommendations: 20%
      serendipity_recommendations: 10%

    conditions:
      when:
        - event: recommendation_generation

    actions:
      on_generation:
        - include_high_confidence_matches
        - add_exploration_content
        - inject_serendipitous_picks

  # ============================================
  # Freshness Rules
  # ============================================
  - id: RGR-030
    name: New Release Boosting
    description: Boost new and recently added content
    category: freshness_rules
    severity: medium

    parameters:
      boost_factors:
        released_this_week: 2.0
        released_this_month: 1.5
        added_this_week: 1.8
        added_this_month: 1.3

    conditions:
      when:
        - event: recommendation_scoring

    actions:
      on_scoring:
        - apply_freshness_boost
        - ensure_new_content_visibility
        - balance_with_relevance

  - id: RGR-031
    name: Trending Content Integration
    description: Include currently trending content
    category: freshness_rules
    severity: medium

    parameters:
      trending_slots: 2-3 per row
      trending_threshold: top 100

    conditions:
      when:
        - event: homepage_generation

    actions:
      on_generation:
        - include_trending_content
        - show_trending_indicators
        - update_trending_hourly

  - id: RGR-032
    name: Recommendation Refresh Rate
    description: Refresh recommendations regularly
    category: freshness_rules
    severity: low

    parameters:
      refresh_intervals:
        homepage: 6 hours
        category_pages: 12 hours
        search_suggestions: 24 hours
        email_recommendations: weekly

    actions:
      scheduled:
        - invalidate_stale_recommendations
        - regenerate_on_schedule
        - shuffle_position_slightly

  # ============================================
  # Business Priorities
  # ============================================
  - id: RGR-040
    name: Original Content Promotion
    description: Prioritize platform original content
    category: business_priorities
    severity: medium

    parameters:
      original_content_boost: 1.3
      exclusive_content_boost: 1.2
      max_original_percent: 30

    conditions:
      when:
        - field: content.is_original
          operator: equals
          value: true

    actions:
      on_scoring:
        - apply_original_boost
        - cap_at_maximum_percent
        - maintain_relevance_threshold

  - id: RGR-041
    name: Licensed Content Promotion
    description: Promote content nearing license expiration
    category: business_priorities
    severity: low

    parameters:
      expiring_boost:
        within_30_days: 1.2
        within_7_days: 1.4

    conditions:
      when:
        - field: content.license_expires_soon
          operator: equals
          value: true

    actions:
      on_scoring:
        - apply_expiring_boost
        - show_leaving_soon_badge
        - create_leaving_soon_row

  - id: RGR-042
    name: A/B Test Integration
    description: Support recommendation algorithm A/B testing
    category: business_priorities
    severity: low

    conditions:
      when:
        - field: profile.experiment_bucket
          operator: is_not_null

    actions:
      on_generation:
        - apply_experiment_variant
        - track_experiment_metrics
        - log_variant_assignment

  - id: RGR-043
    name: Contextual Recommendations
    description: Adjust recommendations based on context
    category: business_priorities
    severity: low

    parameters:
      time_of_day_preferences:
        morning: [news, documentary, short_form]
        afternoon: [family, comedy]
        evening: [drama, thriller, movie]
        night: [movie, binge_worthy_series]
      weekend_boost:
        - movies
        - family_content
        - binge_watching

    conditions:
      when:
        - event: recommendation_generation

    actions:
      on_generation:
        - detect_time_context
        - apply_contextual_adjustments
        - learn_user_time_patterns

algorithm_pipeline:
  stages:
    - name: candidate_generation
      description: Generate broad set of candidates
      methods:
        - collaborative_filtering
        - content_based_filtering
        - popularity_based
        - trending
      output: 1000+ candidates

    - name: filtering
      description: Apply hard filters
      filters:
        - maturity_rating
        - availability
        - already_watched
        - user_dismissals
      output: 200-500 candidates

    - name: scoring
      description: Score and rank candidates
      factors:
        - relevance_score: 0.4
        - freshness_score: 0.2
        - diversity_score: 0.15
        - business_score: 0.15
        - serendipity_score: 0.1
      output: ranked list

    - name: reranking
      description: Apply business rules
      rules:
        - diversity_requirements
        - position_rules
        - row_composition
      output: final recommendations

    - name: personalization
      description: Final personalization
      adjustments:
        - user_position_preferences
        - time_context
        - device_context
      output: personalized feed

metrics:
  - name: recommendation_click_rate
    calculation: "(clicks / impressions) * 100"

  - name: recommendation_conversion_rate
    calculation: "(started_watching / clicks) * 100"

  - name: recommendation_completion_rate
    calculation: "(completed / started) * 100"

  - name: catalog_coverage
    calculation: "(recommended_titles / total_titles) * 100"

  - name: diversity_score
    calculation: "entropy(genre_distribution)"

  - name: personalization_score
    calculation: "1 - jaccard_similarity(user_recs, popular_items)"
