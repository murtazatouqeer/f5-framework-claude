name: episode
display_name: Episode
description: |
  Individual episode entity for TV series.
  Contains episode-specific content and playback information.

domain: entertainment
subdomain: streaming
category: entities
version: "1.0.0"
status: active

attributes:
  # Identity
  - name: id
    type: uuid
    required: true
    description: Unique episode identifier

  - name: content_id
    type: uuid
    required: true
    description: Parent series content ID

  - name: season_id
    type: uuid
    required: true
    description: Parent season ID

  - name: episode_number
    type: integer
    required: true
    min: 1
    description: Episode number in season

  - name: absolute_number
    type: integer
    required: false
    description: Overall episode number in series

  # Details
  - name: title
    type: string
    required: true
    max_length: 300
    description: Episode title
    example: "Pilot"

  - name: description
    type: text
    required: false
    max_length: 2000
    description: Episode synopsis

  - name: duration_minutes
    type: integer
    required: true
    description: Episode runtime
    example: 45

  # Release
  - name: air_date
    type: date
    required: false
    description: Original air date

  - name: release_date
    type: datetime
    required: false
    description: Streaming release datetime

  - name: production_code
    type: string
    required: false
    description: Production episode code

  # Media Assets
  - name: thumbnail_url
    type: url
    required: false
    description: Episode thumbnail

  - name: still_images
    type: array
    items: url
    required: false
    description: Episode still images

  # Video Files
  - name: video_files
    type: array
    required: true
    items:
      type: object
      properties:
        quality: enum
        codec: string
        bitrate: integer
        url: string
        file_size: integer
        drm_protected: boolean
    description: Available video streams

  - name: quality_options
    type: array
    items: enum
    values: [SD, HD, FHD, 4K, HDR]
    required: true
    description: Available qualities

  # Audio & Subtitles
  - name: audio_tracks
    type: array
    items:
      type: object
      properties:
        language: string
        format: enum
        is_default: boolean
        is_descriptive: boolean
    required: true
    description: Available audio tracks

  - name: subtitle_tracks
    type: array
    items:
      type: object
      properties:
        language: string
        format: enum
        is_default: boolean
        is_cc: boolean
        url: string
    required: false
    description: Available subtitles

  # Chapters & Markers
  - name: chapters
    type: array
    items:
      type: object
      properties:
        title: string
        start_time: integer
        end_time: integer
        thumbnail_url: url
    required: false
    description: Chapter markers

  - name: skip_intro
    type: object
    properties:
      start_time: integer
      end_time: integer
    required: false
    description: Skip intro timing

  - name: skip_recap
    type: object
    properties:
      start_time: integer
      end_time: integer
    required: false
    description: Skip recap timing

  - name: skip_credits
    type: object
    properties:
      start_time: integer
    required: false
    description: Skip credits start time

  - name: next_episode_prompt
    type: integer
    required: false
    description: Seconds before end to show next episode

  # Guest Stars
  - name: guest_stars
    type: array
    items:
      type: object
      properties:
        name: string
        person_id: uuid
        character_name: string
    required: false
    description: Guest appearances

  - name: directors
    type: array
    items:
      type: object
      properties:
        name: string
        person_id: uuid
    required: false
    description: Episode directors

  - name: writers
    type: array
    items:
      type: object
      properties:
        name: string
        person_id: uuid
    required: false
    description: Episode writers

  # Ratings
  - name: average_rating
    type: decimal
    required: false
    min: 0
    max: 10
    description: User rating

  - name: total_ratings
    type: integer
    required: false
    default: 0
    description: Rating count

  - name: view_count
    type: integer
    required: false
    default: 0
    description: Total views

  # Status
  - name: status
    type: enum
    values: [processing, ready, published, unavailable, error]
    required: true
    default: processing
    description: Episode status

  - name: is_available
    type: boolean
    required: true
    default: false
    description: Available for streaming

  - name: is_premium
    type: boolean
    required: false
    default: false
    description: Premium-only content

  - name: available_from
    type: datetime
    required: false
    description: Availability start

  - name: available_until
    type: datetime
    required: false
    description: Availability end

  # External IDs
  - name: tmdb_id
    type: integer
    required: false
    description: TMDB episode ID

  - name: imdb_id
    type: string
    required: false
    description: IMDB episode ID

  # Audit
  - name: created_at
    type: datetime
    required: true
    auto: true

  - name: updated_at
    type: datetime
    required: true
    auto: true

  - name: processed_at
    type: datetime
    required: false
    description: Video processing completion

relationships:
  - name: content
    type: belongs_to
    target: content
    foreign_key: content_id
    description: Parent series

  - name: season
    type: belongs_to
    target: season
    foreign_key: season_id
    description: Parent season

  - name: watch_history
    type: has_many
    target: watch_history
    foreign_key: episode_id
    description: Watch records

  - name: downloads
    type: has_many
    target: download
    foreign_key: episode_id
    description: Download records

state_machine:
  initial: processing
  states:
    - name: processing
      description: Video being processed
      allowed_transitions: [ready, error]

    - name: ready
      description: Ready for publishing
      allowed_transitions: [published]

    - name: published
      description: Live and streamable
      allowed_transitions: [unavailable]

    - name: unavailable
      description: Temporarily unavailable
      allowed_transitions: [published]

    - name: error
      description: Processing error
      allowed_transitions: [processing]

indexes:
  - name: idx_episode_season
    fields: [season_id, episode_number]
    type: unique

  - name: idx_episode_content
    fields: [content_id, absolute_number]
    type: btree

  - name: idx_episode_status
    fields: [status, is_available]
    type: btree

  - name: idx_episode_release
    fields: [release_date]
    type: btree

validations:
  - name: valid_episode_number
    condition: "episode_number >= 1"
    message: "Episode number must be positive"

  - name: valid_duration
    condition: "duration_minutes > 0"
    message: "Duration must be positive"

  - name: has_video_files
    condition: "status = 'published' IMPLIES video_files IS NOT NULL"
    message: "Published episodes must have video files"
