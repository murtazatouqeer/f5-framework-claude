name: rating_review
display_name: Rating & Review
description: |
  User ratings and reviews for streaming content.
  Supports star ratings, written reviews, and moderation.

domain: entertainment
subdomain: streaming
category: entities
version: "1.0.0"
status: active

attributes:
  # Identity
  - name: id
    type: uuid
    required: true
    description: Unique rating/review identifier

  - name: profile_id
    type: uuid
    required: true
    description: Rating user profile

  - name: content_id
    type: uuid
    required: true
    description: Rated content

  - name: episode_id
    type: uuid
    required: false
    description: Specific episode rated

  - name: season_id
    type: uuid
    required: false
    description: Specific season rated

  # Rating
  - name: rating_type
    type: enum
    values: [star, thumbs, percentage, like_dislike]
    required: true
    default: star
    description: Rating system used

  - name: rating_value
    type: decimal
    required: true
    min: 0
    max: 10
    precision: 3
    scale: 1
    description: Rating value (normalized 0-10)

  - name: original_rating
    type: decimal
    required: false
    description: Original scale rating

  - name: original_scale
    type: integer
    required: false
    description: Original rating scale
    example: 5

  # Review Content
  - name: has_review
    type: boolean
    required: true
    default: false
    description: Includes written review

  - name: review_title
    type: string
    required: false
    max_length: 200
    description: Review headline

  - name: review_text
    type: text
    required: false
    max_length: 5000
    description: Review body text

  - name: review_language
    type: string
    required: false
    description: Review language code

  - name: contains_spoilers
    type: boolean
    required: false
    default: false
    description: Spoiler warning

  - name: word_count
    type: integer
    required: false
    description: Review word count

  # Viewing Context
  - name: watch_completion_percent
    type: decimal
    required: false
    description: How much user watched

  - name: rated_after_completion
    type: boolean
    required: false
    description: Rated after finishing

  - name: watch_date
    type: date
    required: false
    description: When user watched

  - name: rewatch
    type: boolean
    required: false
    default: false
    description: User rewatched content

  - name: viewing_platform
    type: enum
    values: [web, mobile, tv, other]
    required: false
    description: Where user watched

  # Categories
  - name: aspect_ratings
    type: object
    required: false
    properties:
      story: decimal
      acting: decimal
      direction: decimal
      cinematography: decimal
      music: decimal
      pacing: decimal
      entertainment: decimal
    description: Detailed aspect ratings

  - name: tags
    type: array
    items: string
    required: false
    description: User-applied tags
    example: ["binge-worthy", "thought-provoking"]

  - name: mood_tags
    type: array
    items: string
    required: false
    description: Mood/feel tags

  # Engagement
  - name: helpful_count
    type: integer
    required: true
    default: 0
    description: Helpful votes

  - name: not_helpful_count
    type: integer
    required: true
    default: 0
    description: Not helpful votes

  - name: funny_count
    type: integer
    required: false
    default: 0
    description: Funny votes

  - name: comment_count
    type: integer
    required: false
    default: 0
    description: Reply comments

  - name: report_count
    type: integer
    required: false
    default: 0
    description: Times reported

  # Verification
  - name: is_verified_view
    type: boolean
    required: true
    default: true
    description: User watched on platform

  - name: verified_view_percent
    type: decimal
    required: false
    description: Verified watch percentage

  # Display
  - name: is_featured
    type: boolean
    required: false
    default: false
    description: Featured review

  - name: featured_at
    type: datetime
    required: false
    description: When featured

  - name: featured_by
    type: uuid
    required: false
    description: Featured by admin

  - name: display_order
    type: integer
    required: false
    description: Display priority

  # Moderation
  - name: status
    type: enum
    values: [pending, approved, rejected, flagged, hidden, deleted]
    required: true
    default: pending
    description: Review status

  - name: moderation_status
    type: enum
    values: [not_reviewed, auto_approved, auto_flagged, manually_reviewed]
    required: true
    default: not_reviewed
    description: Moderation state

  - name: moderation_notes
    type: text
    required: false
    description: Moderator notes

  - name: moderated_by
    type: uuid
    required: false
    description: Moderator user ID

  - name: moderated_at
    type: datetime
    required: false
    description: Moderation timestamp

  - name: rejection_reason
    type: enum
    values: [spam, inappropriate, off_topic, personal_attack, spoilers_unmarked, other]
    required: false
    description: Why rejected

  - name: auto_moderation_score
    type: decimal
    required: false
    description: ML moderation confidence

  - name: toxicity_score
    type: decimal
    required: false
    description: Content toxicity score

  # Edit History
  - name: is_edited
    type: boolean
    required: false
    default: false
    description: Review was edited

  - name: edit_count
    type: integer
    required: false
    default: 0
    description: Number of edits

  - name: last_edited_at
    type: datetime
    required: false
    description: Last edit timestamp

  - name: original_review_text
    type: text
    required: false
    description: Pre-edit text backup

  # Timestamps
  - name: created_at
    type: datetime
    required: true
    auto: true

  - name: updated_at
    type: datetime
    required: true
    auto: true

  - name: deleted_at
    type: datetime
    required: false
    description: Soft delete timestamp

relationships:
  - name: profile
    type: belongs_to
    target: user_profile
    foreign_key: profile_id
    description: Rating user

  - name: content
    type: belongs_to
    target: content
    foreign_key: content_id
    description: Rated content

  - name: episode
    type: belongs_to
    target: episode
    foreign_key: episode_id
    description: Rated episode

  - name: season
    type: belongs_to
    target: season
    foreign_key: season_id
    description: Rated season

  - name: votes
    type: has_many
    target: review_vote
    foreign_key: review_id
    description: Helpfulness votes

  - name: comments
    type: has_many
    target: review_comment
    foreign_key: review_id
    description: Review comments

state_machine:
  initial: pending
  states:
    - name: pending
      description: Awaiting moderation
      allowed_transitions: [approved, rejected, flagged]

    - name: approved
      description: Published and visible
      allowed_transitions: [flagged, hidden, deleted]

    - name: rejected
      description: Did not pass moderation
      allowed_transitions: [pending]

    - name: flagged
      description: Requires manual review
      allowed_transitions: [approved, rejected, hidden]

    - name: hidden
      description: Temporarily hidden
      allowed_transitions: [approved, deleted]

    - name: deleted
      description: Removed
      allowed_transitions: []
      terminal: true

indexes:
  - name: idx_rating_profile_content
    fields: [profile_id, content_id]
    type: unique

  - name: idx_rating_content
    fields: [content_id, status]
    type: btree

  - name: idx_rating_value
    fields: [content_id, rating_value]
    type: btree

  - name: idx_rating_helpful
    fields: [content_id, helpful_count]
    type: btree

  - name: idx_rating_status
    fields: [status, created_at]
    type: btree

  - name: idx_rating_moderation
    fields: [moderation_status, created_at]
    type: btree

  - name: idx_rating_featured
    fields: [is_featured, content_id]
    type: btree

validations:
  - name: valid_rating
    condition: "rating_value >= 0 AND rating_value <= 10"
    message: "Rating must be between 0 and 10"

  - name: review_requires_content
    condition: "has_review = false OR review_text IS NOT NULL"
    message: "Review text required when has_review is true"

  - name: one_per_content
    condition: "episode_id IS NULL OR season_id IS NULL"
    message: "Can rate episode or season, not both"

business_rules:
  - rule: rating-review-rules
    description: Rules for user ratings and reviews
