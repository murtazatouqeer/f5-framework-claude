name: watch_history
display_name: Watch History
description: |
  Tracks user viewing history and progress for content.
  Enables continue watching and completion tracking.

domain: entertainment
subdomain: streaming
category: entities
version: "1.0.0"
status: active

attributes:
  # Identity
  - name: id
    type: uuid
    required: true
    description: Unique history record identifier

  - name: profile_id
    type: uuid
    required: true
    description: User profile ID

  - name: content_id
    type: uuid
    required: true
    description: Content being watched

  - name: episode_id
    type: uuid
    required: false
    description: Specific episode (for series)

  # Progress Tracking
  - name: progress_seconds
    type: integer
    required: true
    default: 0
    description: Current playback position

  - name: duration_seconds
    type: integer
    required: true
    description: Total content duration

  - name: progress_percent
    type: decimal
    required: true
    default: 0
    precision: 5
    scale: 2
    description: Progress percentage

  - name: watch_time_seconds
    type: integer
    required: true
    default: 0
    description: Actual time spent watching

  # Completion Status
  - name: is_completed
    type: boolean
    required: true
    default: false
    description: Content marked as completed

  - name: completion_threshold
    type: decimal
    required: true
    default: 90.0
    description: Percent to mark complete

  - name: completed_at
    type: datetime
    required: false
    description: Completion timestamp

  # Series Progress
  - name: last_watched_season
    type: integer
    required: false
    description: Last watched season number

  - name: last_watched_episode
    type: integer
    required: false
    description: Last watched episode number

  - name: episodes_watched
    type: integer
    required: false
    default: 0
    description: Total episodes watched

  - name: series_progress_percent
    type: decimal
    required: false
    description: Overall series progress

  # Session Info
  - name: device_type
    type: enum
    values: [web, mobile_ios, mobile_android, smart_tv, game_console, streaming_device, desktop_app]
    required: false
    description: Last watching device

  - name: device_id
    type: string
    required: false
    description: Device identifier

  - name: video_quality_watched
    type: enum
    values: [SD, HD, FHD, 4K]
    required: false
    description: Quality streamed

  - name: audio_language_used
    type: string
    required: false
    description: Audio track used

  - name: subtitle_language_used
    type: string
    required: false
    description: Subtitle track used

  # Timestamps
  - name: started_at
    type: datetime
    required: true
    description: First watch timestamp

  - name: last_watched_at
    type: datetime
    required: true
    description: Most recent watch

  - name: watch_count
    type: integer
    required: true
    default: 1
    description: Number of watch sessions

  # Analytics
  - name: skip_intro_used
    type: boolean
    required: false
    default: false
    description: Used skip intro feature

  - name: skip_credits_used
    type: boolean
    required: false
    default: false
    description: Skipped end credits

  - name: playback_speed
    type: decimal
    required: false
    default: 1.0
    description: Playback speed used

  - name: paused_count
    type: integer
    required: false
    default: 0
    description: Number of pauses

  - name: seek_count
    type: integer
    required: false
    default: 0
    description: Number of seeks/skips

  # Status
  - name: is_hidden
    type: boolean
    required: true
    default: false
    description: Hidden from history display

  - name: show_in_continue_watching
    type: boolean
    required: true
    default: true
    description: Show in continue watching

  # Audit
  - name: created_at
    type: datetime
    required: true
    auto: true

  - name: updated_at
    type: datetime
    required: true
    auto: true

relationships:
  - name: profile
    type: belongs_to
    target: user_profile
    foreign_key: profile_id
    description: Viewing profile

  - name: content
    type: belongs_to
    target: content
    foreign_key: content_id
    description: Watched content

  - name: episode
    type: belongs_to
    target: episode
    foreign_key: episode_id
    description: Specific episode

indexes:
  - name: idx_history_profile_content
    fields: [profile_id, content_id]
    type: btree

  - name: idx_history_profile_episode
    fields: [profile_id, episode_id]
    type: unique

  - name: idx_history_last_watched
    fields: [profile_id, last_watched_at]
    type: btree

  - name: idx_history_continue_watching
    fields: [profile_id, show_in_continue_watching, is_completed]
    type: btree

  - name: idx_history_completed
    fields: [profile_id, is_completed]
    type: btree

validations:
  - name: valid_progress
    condition: "progress_seconds <= duration_seconds"
    message: "Progress cannot exceed duration"

  - name: valid_percent
    condition: "progress_percent >= 0 AND progress_percent <= 100"
    message: "Progress percent must be 0-100"

  - name: episode_for_series
    condition: "episode_id IS NOT NULL IMPLIES content_id IS NOT NULL"
    message: "Episode must have content reference"

business_rules:
  - rule: playback-tracking-rules
    description: Rules for tracking and updating watch history
