name: download
display_name: Download
description: |
  Offline content download management for mobile viewing.
  Tracks download state, DRM licenses, and expiration.

domain: entertainment
subdomain: streaming
category: entities
version: "1.0.0"
status: active

attributes:
  # Identity
  - name: id
    type: uuid
    required: true
    description: Unique download identifier

  - name: profile_id
    type: uuid
    required: true
    description: Downloading profile

  - name: subscription_id
    type: uuid
    required: true
    description: Active subscription

  - name: content_id
    type: uuid
    required: true
    description: Downloaded content

  - name: episode_id
    type: uuid
    required: false
    description: Specific episode

  # Device Info
  - name: device_id
    type: string
    required: true
    description: Target device identifier

  - name: device_type
    type: enum
    values: [mobile_ios, mobile_android, tablet_ios, tablet_android, laptop, desktop]
    required: true
    description: Device category

  - name: device_name
    type: string
    required: false
    description: Device friendly name

  - name: app_version
    type: string
    required: true
    description: App version used

  # Download Settings
  - name: quality
    type: enum
    values: [SD, HD, FHD]
    required: true
    description: Download quality

  - name: audio_tracks
    type: array
    items: string
    required: true
    description: Downloaded audio languages

  - name: subtitle_tracks
    type: array
    items: string
    required: false
    description: Downloaded subtitle languages

  - name: include_bonus_content
    type: boolean
    required: false
    default: false
    description: Include extras

  # File Info
  - name: file_size_bytes
    type: bigint
    required: true
    description: Download size in bytes

  - name: file_format
    type: enum
    values: [mp4, mkv, webm]
    required: true
    description: Container format

  - name: video_codec
    type: enum
    values: [h264, h265, vp9, av1]
    required: true
    description: Video codec

  - name: audio_codec
    type: enum
    values: [aac, eac3, ac3, opus]
    required: true
    description: Audio codec

  - name: bitrate_kbps
    type: integer
    required: true
    description: Download bitrate

  - name: duration_seconds
    type: integer
    required: true
    description: Content duration

  - name: storage_path
    type: string
    required: false
    description: Local storage path

  # Download Progress
  - name: status
    type: enum
    values: [queued, downloading, paused, completed, failed, expired, deleted]
    required: true
    default: queued
    description: Download status

  - name: progress_percent
    type: decimal
    required: true
    default: 0
    precision: 5
    scale: 2
    description: Download progress

  - name: bytes_downloaded
    type: bigint
    required: true
    default: 0
    description: Bytes downloaded

  - name: download_speed_kbps
    type: integer
    required: false
    description: Current download speed

  - name: estimated_time_remaining
    type: integer
    required: false
    description: Seconds remaining

  # Download Session
  - name: requested_at
    type: datetime
    required: true
    description: Download request time

  - name: started_at
    type: datetime
    required: false
    description: Download start time

  - name: completed_at
    type: datetime
    required: false
    description: Download completion time

  - name: paused_at
    type: datetime
    required: false
    description: When paused

  - name: retry_count
    type: integer
    required: true
    default: 0
    description: Retry attempts

  - name: last_error
    type: string
    required: false
    description: Last error message

  - name: error_code
    type: string
    required: false
    description: Error code

  # Network Settings
  - name: wifi_only
    type: boolean
    required: true
    default: true
    description: Download only on WiFi

  - name: cellular_allowed
    type: boolean
    required: false
    default: false
    description: Allow cellular download

  - name: background_download
    type: boolean
    required: true
    default: true
    description: Continue in background

  # DRM
  - name: drm_type
    type: enum
    values: [widevine, fairplay, playready]
    required: true
    description: DRM system

  - name: license_id
    type: string
    required: false
    description: Offline DRM license ID

  - name: license_acquired_at
    type: datetime
    required: false
    description: When license was acquired

  - name: license_expires_at
    type: datetime
    required: false
    description: License expiration

  - name: license_renewal_available
    type: boolean
    required: false
    default: true
    description: Can renew license

  # Playback Tracking
  - name: play_count
    type: integer
    required: true
    default: 0
    description: Times played offline

  - name: last_played_at
    type: datetime
    required: false
    description: Last offline playback

  - name: playback_position_seconds
    type: integer
    required: false
    default: 0
    description: Resume position

  - name: is_completed
    type: boolean
    required: false
    default: false
    description: Fully watched offline

  # Expiration
  - name: download_expires_at
    type: datetime
    required: true
    description: Content expiration

  - name: first_playback_deadline
    type: datetime
    required: false
    description: Must start watching by

  - name: playback_expires_at
    type: datetime
    required: false
    description: Expires after first play

  - name: expiration_warning_sent
    type: boolean
    required: false
    default: false
    description: Expiration warning sent

  # Smart Downloads
  - name: is_smart_download
    type: boolean
    required: false
    default: false
    description: Auto-downloaded

  - name: auto_delete_when_watched
    type: boolean
    required: false
    default: true
    description: Delete after watching

  - name: replaced_download_id
    type: uuid
    required: false
    description: Replaced previous download

  # Audit
  - name: created_at
    type: datetime
    required: true
    auto: true

  - name: updated_at
    type: datetime
    required: true
    auto: true

  - name: deleted_at
    type: datetime
    required: false
    description: Soft delete timestamp

relationships:
  - name: profile
    type: belongs_to
    target: user_profile
    foreign_key: profile_id
    description: Owner profile

  - name: subscription
    type: belongs_to
    target: subscription
    foreign_key: subscription_id
    description: Active subscription

  - name: content
    type: belongs_to
    target: content
    foreign_key: content_id
    description: Downloaded content

  - name: episode
    type: belongs_to
    target: episode
    foreign_key: episode_id
    description: Downloaded episode

state_machine:
  initial: queued
  states:
    - name: queued
      description: Waiting to download
      allowed_transitions: [downloading, deleted]

    - name: downloading
      description: Actively downloading
      allowed_transitions: [paused, completed, failed]

    - name: paused
      description: Download paused
      allowed_transitions: [downloading, deleted]

    - name: completed
      description: Download complete
      allowed_transitions: [expired, deleted]

    - name: failed
      description: Download failed
      allowed_transitions: [queued, deleted]

    - name: expired
      description: Content expired
      allowed_transitions: [deleted]

    - name: deleted
      description: Download removed
      allowed_transitions: []
      terminal: true

  transitions:
    - name: start_download
      from: queued
      to: downloading
      triggers:
        - acquire_drm_license

    - name: pause_download
      from: downloading
      to: paused

    - name: resume_download
      from: paused
      to: downloading

    - name: complete_download
      from: downloading
      to: completed
      triggers:
        - update_storage_usage

    - name: fail_download
      from: downloading
      to: failed
      triggers:
        - log_error

    - name: expire_download
      from: completed
      to: expired
      triggers:
        - send_expiration_notice

    - name: delete_download
      from: [queued, paused, completed, expired, failed]
      to: deleted
      triggers:
        - release_storage
        - revoke_license

indexes:
  - name: idx_download_profile
    fields: [profile_id, status]
    type: btree

  - name: idx_download_device
    fields: [device_id, status]
    type: btree

  - name: idx_download_content
    fields: [content_id]
    type: btree

  - name: idx_download_subscription
    fields: [subscription_id]
    type: btree

  - name: idx_download_expiry
    fields: [download_expires_at]
    type: btree

  - name: idx_download_license_expiry
    fields: [license_expires_at]
    type: btree

validations:
  - name: valid_progress
    condition: "bytes_downloaded <= file_size_bytes"
    message: "Downloaded bytes cannot exceed file size"

  - name: valid_quality_subscription
    condition: "quality IN (subscription.allowed_qualities)"
    message: "Quality must match subscription tier"

business_rules:
  - rule: download-management-rules
    description: Rules for offline download management
