name: user_profile
display_name: User Profile
description: |
  Individual viewing profile within a subscription account.
  Manages preferences, parental controls, and personalization.

domain: entertainment
subdomain: streaming
category: entities
version: "1.0.0"
status: active

attributes:
  # Identity
  - name: id
    type: uuid
    required: true
    description: Unique profile identifier

  - name: account_id
    type: uuid
    required: true
    description: Parent account ID

  - name: profile_type
    type: enum
    values: [primary, adult, child, guest]
    required: true
    default: adult
    description: Profile type

  # Basic Info
  - name: name
    type: string
    required: true
    max_length: 50
    description: Profile display name
    example: "John"

  - name: avatar_url
    type: url
    required: false
    description: Profile avatar image

  - name: avatar_id
    type: string
    required: false
    description: System avatar identifier

  - name: language
    type: string
    required: true
    default: "en"
    description: Preferred language code

  - name: subtitle_language
    type: string
    required: false
    description: Preferred subtitle language

  - name: audio_language
    type: string
    required: false
    description: Preferred audio language

  # Preferences
  - name: autoplay_next
    type: boolean
    required: true
    default: true
    description: Auto-play next episode

  - name: autoplay_previews
    type: boolean
    required: true
    default: true
    description: Auto-play previews while browsing

  - name: skip_intro
    type: boolean
    required: true
    default: false
    description: Auto-skip intro sequences

  - name: skip_recap
    type: boolean
    required: true
    default: false
    description: Auto-skip recaps

  - name: default_video_quality
    type: enum
    values: [auto, SD, HD, FHD, 4K]
    required: true
    default: auto
    description: Preferred video quality

  - name: download_quality
    type: enum
    values: [standard, high, highest]
    required: true
    default: high
    description: Download quality preference

  - name: data_saver_mode
    type: boolean
    required: true
    default: false
    description: Reduce data usage

  # Parental Controls
  - name: maturity_rating
    type: enum
    values: [all, children, teens, adults]
    required: true
    default: adults
    description: Maximum content rating

  - name: pin_protected
    type: boolean
    required: true
    default: false
    description: Requires PIN to access

  - name: pin_hash
    type: string
    required: false
    description: Hashed profile PIN

  - name: blocked_content_ids
    type: array
    items: uuid
    required: false
    description: Manually blocked content

  - name: allowed_genres
    type: array
    items: string
    required: false
    description: Allowed genres (for kids)

  # Personalization
  - name: favorite_genres
    type: array
    items: string
    required: false
    description: Preferred genres

  - name: taste_profile
    type: object
    required: false
    properties:
      action_affinity: decimal
      comedy_affinity: decimal
      drama_affinity: decimal
      horror_affinity: decimal
      romance_affinity: decimal
      documentary_affinity: decimal
      animation_affinity: decimal
    description: ML-generated taste profile

  - name: viewing_history_enabled
    type: boolean
    required: true
    default: true
    description: Track viewing history

  - name: personalized_recommendations
    type: boolean
    required: true
    default: true
    description: Enable personalized recommendations

  # Notifications
  - name: new_release_notifications
    type: boolean
    required: true
    default: true
    description: Notify on new releases

  - name: continue_watching_reminders
    type: boolean
    required: true
    default: false
    description: Remind to continue watching

  - name: watchlist_updates
    type: boolean
    required: true
    default: true
    description: Notify on watchlist availability

  # Usage Stats
  - name: total_watch_time_minutes
    type: integer
    required: false
    default: 0
    description: Total minutes watched

  - name: titles_watched
    type: integer
    required: false
    default: 0
    description: Unique titles watched

  - name: last_active_at
    type: datetime
    required: false
    description: Last profile activity

  - name: favorite_watch_time
    type: enum
    values: [morning, afternoon, evening, night]
    required: false
    description: Most common watch time

  # Status
  - name: is_active
    type: boolean
    required: true
    default: true
    description: Profile is active

  - name: is_primary
    type: boolean
    required: true
    default: false
    description: Primary account profile

  - name: created_by_user_id
    type: uuid
    required: true
    description: Creator user ID

  # Audit
  - name: created_at
    type: datetime
    required: true
    auto: true

  - name: updated_at
    type: datetime
    required: true
    auto: true

relationships:
  - name: account
    type: belongs_to
    target: account
    foreign_key: account_id
    description: Parent account

  - name: watch_history
    type: has_many
    target: watch_history
    foreign_key: profile_id
    description: Viewing history

  - name: watchlist
    type: has_many
    target: watchlist
    foreign_key: profile_id
    description: Saved items

  - name: ratings
    type: has_many
    target: rating_review
    foreign_key: profile_id
    description: User ratings

  - name: recommendations
    type: has_many
    target: recommendation
    foreign_key: profile_id
    description: Personalized recommendations

  - name: downloads
    type: has_many
    target: download
    foreign_key: profile_id
    description: Downloaded content

  - name: playback_sessions
    type: has_many
    target: playback_session
    foreign_key: profile_id
    description: Active sessions

indexes:
  - name: idx_profile_account
    fields: [account_id]
    type: btree

  - name: idx_profile_type
    fields: [profile_type]
    type: btree

  - name: idx_profile_active
    fields: [is_active]
    type: btree

validations:
  - name: valid_pin
    condition: "pin_protected = false OR pin_hash IS NOT NULL"
    message: "PIN required when protection enabled"

  - name: valid_child_settings
    condition: "profile_type != 'child' OR maturity_rating IN ('all', 'children')"
    message: "Child profiles must have appropriate maturity rating"

business_rules:
  - rule: profile-management-rules
    description: Profile creation and management rules
