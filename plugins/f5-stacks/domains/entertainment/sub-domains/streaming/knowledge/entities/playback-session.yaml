name: playback_session
display_name: Playback Session
description: |
  Active video playback session tracking for concurrent stream
  management, DRM validation, and quality optimization.

domain: entertainment
subdomain: streaming
category: entities
version: "1.0.0"
status: active

attributes:
  # Identity
  - name: id
    type: uuid
    required: true
    description: Unique session identifier

  - name: profile_id
    type: uuid
    required: true
    description: Viewing profile ID

  - name: subscription_id
    type: uuid
    required: true
    description: Active subscription

  - name: content_id
    type: uuid
    required: true
    description: Content being played

  - name: episode_id
    type: uuid
    required: false
    description: Episode being played

  # Session Info
  - name: session_token
    type: string
    required: true
    unique: true
    description: Secure session token

  - name: session_start
    type: datetime
    required: true
    description: Session start time

  - name: session_end
    type: datetime
    required: false
    description: Session end time

  - name: last_heartbeat
    type: datetime
    required: true
    description: Last activity heartbeat

  - name: heartbeat_interval_seconds
    type: integer
    required: true
    default: 30
    description: Expected heartbeat interval

  # Device Info
  - name: device_id
    type: string
    required: true
    description: Device identifier

  - name: device_type
    type: enum
    values: [web, mobile_ios, mobile_android, smart_tv, game_console, streaming_device, desktop_app]
    required: true
    description: Device category

  - name: device_name
    type: string
    required: false
    description: Device friendly name
    example: "John's iPhone"

  - name: device_model
    type: string
    required: false
    description: Device model
    example: "iPhone 15 Pro"

  - name: os_name
    type: string
    required: false
    description: Operating system

  - name: os_version
    type: string
    required: false
    description: OS version

  - name: app_version
    type: string
    required: false
    description: Player app version

  - name: browser_name
    type: string
    required: false
    description: Browser (for web)

  - name: browser_version
    type: string
    required: false
    description: Browser version

  # Network Info
  - name: ip_address
    type: string
    required: true
    description: Client IP address

  - name: country_code
    type: string
    required: false
    description: Geo-located country

  - name: region
    type: string
    required: false
    description: Geo-located region

  - name: connection_type
    type: enum
    values: [wifi, cellular, ethernet, unknown]
    required: false
    description: Network connection type

  - name: bandwidth_estimate_kbps
    type: integer
    required: false
    description: Estimated bandwidth

  # Playback State
  - name: playback_status
    type: enum
    values: [initializing, buffering, playing, paused, seeking, stopped, error]
    required: true
    default: initializing
    description: Current playback state

  - name: current_position_seconds
    type: integer
    required: true
    default: 0
    description: Current playback position

  - name: playback_rate
    type: decimal
    required: true
    default: 1.0
    description: Playback speed

  - name: volume_level
    type: decimal
    required: false
    description: Volume 0-1

  - name: is_muted
    type: boolean
    required: false
    default: false
    description: Audio muted

  - name: is_fullscreen
    type: boolean
    required: false
    default: false
    description: Fullscreen mode

  # Quality Settings
  - name: requested_quality
    type: enum
    values: [auto, SD, HD, FHD, 4K, HDR]
    required: true
    default: auto
    description: User-selected quality

  - name: current_quality
    type: enum
    values: [SD, HD, FHD, 4K, HDR]
    required: false
    description: Active quality level

  - name: current_bitrate_kbps
    type: integer
    required: false
    description: Current stream bitrate

  - name: quality_switches
    type: integer
    required: false
    default: 0
    description: ABR quality switch count

  # Audio/Subtitle
  - name: audio_track
    type: string
    required: false
    description: Selected audio language

  - name: subtitle_track
    type: string
    required: false
    description: Selected subtitle language

  - name: subtitle_enabled
    type: boolean
    required: false
    default: false
    description: Subtitles displayed

  # DRM
  - name: drm_type
    type: enum
    values: [widevine, fairplay, playready, none]
    required: true
    description: DRM system used

  - name: drm_license_id
    type: string
    required: false
    description: DRM license identifier

  - name: drm_license_expiry
    type: datetime
    required: false
    description: License expiration

  - name: hdcp_level
    type: enum
    values: [none, hdcp_1_4, hdcp_2_2, hdcp_2_3]
    required: false
    description: HDCP protection level

  # CDN Info
  - name: cdn_server
    type: string
    required: false
    description: CDN edge server

  - name: manifest_url
    type: url
    required: false
    description: Stream manifest URL

  - name: stream_protocol
    type: enum
    values: [HLS, DASH, SMOOTH]
    required: true
    description: Streaming protocol

  # Analytics
  - name: buffer_count
    type: integer
    required: false
    default: 0
    description: Buffering events

  - name: total_buffer_time_ms
    type: integer
    required: false
    default: 0
    description: Total buffering time

  - name: startup_time_ms
    type: integer
    required: false
    description: Time to first frame

  - name: seek_count
    type: integer
    required: false
    default: 0
    description: Seek operations

  - name: error_count
    type: integer
    required: false
    default: 0
    description: Playback errors

  - name: watch_duration_seconds
    type: integer
    required: false
    default: 0
    description: Actual watch time

  # Status
  - name: status
    type: enum
    values: [active, paused, ended, expired, terminated]
    required: true
    default: active
    description: Session status

  - name: end_reason
    type: enum
    values: [completed, user_stopped, timeout, concurrent_limit, license_expired, error, force_terminated]
    required: false
    description: Why session ended

  - name: error_code
    type: string
    required: false
    description: Last error code

  - name: error_message
    type: string
    required: false
    description: Last error message

  # Audit
  - name: created_at
    type: datetime
    required: true
    auto: true

  - name: updated_at
    type: datetime
    required: true
    auto: true

relationships:
  - name: profile
    type: belongs_to
    target: user_profile
    foreign_key: profile_id
    description: Viewing profile

  - name: subscription
    type: belongs_to
    target: subscription
    foreign_key: subscription_id
    description: Active subscription

  - name: content
    type: belongs_to
    target: content
    foreign_key: content_id
    description: Content played

  - name: episode
    type: belongs_to
    target: episode
    foreign_key: episode_id
    description: Episode played

state_machine:
  initial: active
  states:
    - name: active
      description: Actively streaming
      allowed_transitions: [paused, ended, expired, terminated]

    - name: paused
      description: Playback paused
      allowed_transitions: [active, ended, expired, terminated]

    - name: ended
      description: Normal session end
      allowed_transitions: []
      terminal: true

    - name: expired
      description: Session timed out
      allowed_transitions: []
      terminal: true

    - name: terminated
      description: Force terminated
      allowed_transitions: []
      terminal: true

indexes:
  - name: idx_session_token
    fields: [session_token]
    type: unique

  - name: idx_session_profile
    fields: [profile_id, status]
    type: btree

  - name: idx_session_subscription
    fields: [subscription_id, status]
    type: btree

  - name: idx_session_device
    fields: [device_id, status]
    type: btree

  - name: idx_session_heartbeat
    fields: [last_heartbeat]
    type: btree

  - name: idx_session_content
    fields: [content_id, status]
    type: btree

validations:
  - name: valid_heartbeat
    condition: "last_heartbeat >= session_start"
    message: "Heartbeat must be after session start"

  - name: valid_position
    condition: "current_position_seconds >= 0"
    message: "Position cannot be negative"

business_rules:
  - rule: concurrent-stream-rules
    description: Rules for managing concurrent playback sessions
