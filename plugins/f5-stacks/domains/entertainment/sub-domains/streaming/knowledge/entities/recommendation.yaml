name: recommendation
display_name: Recommendation
description: |
  Personalized content recommendations generated by ML algorithms.
  Tracks recommendation sources, scores, and user interactions.

domain: entertainment
subdomain: streaming
category: entities
version: "1.0.0"
status: active

attributes:
  # Identity
  - name: id
    type: uuid
    required: true
    description: Unique recommendation identifier

  - name: profile_id
    type: uuid
    required: true
    description: Target user profile

  - name: content_id
    type: uuid
    required: true
    description: Recommended content

  # Algorithm Info
  - name: algorithm_type
    type: enum
    values: [collaborative_filtering, content_based, hybrid, trending, editorial, contextual, similar_users, watch_next]
    required: true
    description: Recommendation algorithm used

  - name: algorithm_version
    type: string
    required: true
    description: Algorithm version
    example: "cf-v2.3.1"

  - name: model_id
    type: string
    required: false
    description: ML model identifier

  # Scoring
  - name: relevance_score
    type: decimal
    required: true
    precision: 5
    scale: 4
    description: Overall relevance score (0-1)

  - name: confidence_score
    type: decimal
    required: false
    precision: 5
    scale: 4
    description: Prediction confidence (0-1)

  - name: diversity_score
    type: decimal
    required: false
    precision: 5
    scale: 4
    description: Diversity contribution

  - name: novelty_score
    type: decimal
    required: false
    precision: 5
    scale: 4
    description: Content novelty for user

  - name: serendipity_score
    type: decimal
    required: false
    precision: 5
    scale: 4
    description: Unexpected relevance

  # Feature Contributions
  - name: feature_weights
    type: object
    required: false
    properties:
      genre_match: decimal
      actor_preference: decimal
      director_preference: decimal
      mood_match: decimal
      recency: decimal
      popularity: decimal
      social_signal: decimal
    description: Feature contribution breakdown

  # Context
  - name: recommendation_context
    type: enum
    values: [homepage, after_watch, search, category, similar, because_you_watched, trending, new_releases]
    required: true
    description: Where recommendation appears

  - name: source_content_id
    type: uuid
    required: false
    description: Content that triggered recommendation

  - name: source_content_title
    type: string
    required: false
    description: Source content title for "Because you watched"

  - name: display_reason
    type: string
    required: false
    description: User-facing explanation
    example: "Because you watched The Matrix"

  - name: reason_type
    type: enum
    values: [similar_genre, same_director, same_actor, trending_in_region, friends_watching, highly_rated, new_release, continue_series]
    required: false
    description: Categorized reason

  # Targeting
  - name: position
    type: integer
    required: true
    description: Position in recommendation list

  - name: row_id
    type: string
    required: false
    description: UI row identifier

  - name: row_title
    type: string
    required: false
    description: Row display title

  - name: experiment_id
    type: string
    required: false
    description: A/B test experiment ID

  - name: variant
    type: string
    required: false
    description: A/B test variant

  # Time Context
  - name: time_of_day
    type: enum
    values: [morning, afternoon, evening, night]
    required: false
    description: Time context

  - name: day_of_week
    type: integer
    required: false
    description: Day context (0-6)

  - name: is_weekend
    type: boolean
    required: false
    description: Weekend context

  # Validity
  - name: generated_at
    type: datetime
    required: true
    description: When recommendation was generated

  - name: expires_at
    type: datetime
    required: false
    description: Recommendation expiration

  - name: is_valid
    type: boolean
    required: true
    default: true
    description: Still valid recommendation

  - name: invalidation_reason
    type: enum
    values: [expired, content_unavailable, user_watched, user_dismissed, model_updated]
    required: false
    description: Why invalidated

  # User Interaction
  - name: was_impressed
    type: boolean
    required: false
    default: false
    description: Shown to user

  - name: impression_count
    type: integer
    required: false
    default: 0
    description: Times shown

  - name: first_impression_at
    type: datetime
    required: false
    description: First display time

  - name: last_impression_at
    type: datetime
    required: false
    description: Last display time

  - name: was_clicked
    type: boolean
    required: false
    default: false
    description: User clicked

  - name: clicked_at
    type: datetime
    required: false
    description: Click timestamp

  - name: was_watched
    type: boolean
    required: false
    default: false
    description: User watched content

  - name: watch_completion_percent
    type: decimal
    required: false
    description: How much user watched

  - name: was_added_to_list
    type: boolean
    required: false
    default: false
    description: Added to watchlist

  - name: was_dismissed
    type: boolean
    required: false
    default: false
    description: User dismissed

  - name: dismissed_at
    type: datetime
    required: false
    description: Dismissal timestamp

  - name: dismissal_reason
    type: enum
    values: [not_interested, already_watched, not_relevant, other]
    required: false
    description: Why dismissed

  # Feedback
  - name: user_rating
    type: decimal
    required: false
    description: Post-watch rating

  - name: feedback_score
    type: integer
    required: false
    min: -1
    max: 1
    description: Implicit feedback (-1/0/1)

  # Audit
  - name: created_at
    type: datetime
    required: true
    auto: true

  - name: updated_at
    type: datetime
    required: true
    auto: true

relationships:
  - name: profile
    type: belongs_to
    target: user_profile
    foreign_key: profile_id
    description: Target profile

  - name: content
    type: belongs_to
    target: content
    foreign_key: content_id
    description: Recommended content

  - name: source_content
    type: belongs_to
    target: content
    foreign_key: source_content_id
    description: Trigger content

  - name: watchlist_item
    type: has_one
    target: watchlist
    foreign_key: recommendation_id
    description: Resulting watchlist item

indexes:
  - name: idx_rec_profile_context
    fields: [profile_id, recommendation_context, is_valid]
    type: btree

  - name: idx_rec_profile_content
    fields: [profile_id, content_id]
    type: btree

  - name: idx_rec_generated
    fields: [generated_at]
    type: btree

  - name: idx_rec_expires
    fields: [expires_at]
    type: btree

  - name: idx_rec_score
    fields: [profile_id, relevance_score]
    type: btree

  - name: idx_rec_experiment
    fields: [experiment_id, variant]
    type: btree

validations:
  - name: valid_scores
    condition: "relevance_score >= 0 AND relevance_score <= 1"
    message: "Scores must be between 0 and 1"

  - name: valid_position
    condition: "position >= 0"
    message: "Position must be non-negative"

business_rules:
  - rule: recommendation-generation-rules
    description: Rules for generating and displaying recommendations
