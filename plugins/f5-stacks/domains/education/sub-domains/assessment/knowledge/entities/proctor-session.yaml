# Proctor Session Entity
# F5 Framework v2.0 - Education/Assessment
# Proctoring session for exam monitoring

entity:
  id: proctor_session
  name: Proctor Session
  name_ja: 監督セッション
  description: Proctoring session for monitoring exam integrity
  domain: education
  subdomain: assessment
  version: "1.0.0"

  attributes:
    id:
      type: uuid
      primary_key: true
      
    session_code:
      type: string
      max_length: 50
      unique: true
      pattern: "^PRC-[0-9]{8}-[A-Z0-9]{6}$"
      
    # References
    exam_attempt_id:
      type: uuid
      references: exam_attempt
      required: true
      
    # Proctoring Type
    proctoring_type:
      type: enum
      values:
        - live           # Real-time human proctor
        - recorded       # Recording for later review
        - ai_based       # Automated AI monitoring
        - hybrid         # AI + human review
      required: true
      
    # Status
    status:
      type: enum
      values:
        - pending
        - setup
        - active
        - paused
        - completed
        - flagged
        - reviewed
      default: pending
      
    # Proctor (for live proctoring)
    proctor_id:
      type: uuid
      references: user
      
    # Session Timing
    session_start:
      type: datetime
      
    session_end:
      type: datetime
      
    active_monitoring_duration_seconds:
      type: integer
      default: 0
      
    # Identity Verification
    identity_verified:
      type: boolean
      default: false
      
    verification_method:
      type: enum
      values: [photo_id, face_match, multi_factor, manual]
      
    verification_timestamp:
      type: datetime
      
    verification_score:
      type: decimal
      precision: 5
      scale: 2
      description: Face match confidence score
      
    id_document_type:
      type: string
      max_length: 50
      
    id_document_url:
      type: string
      format: url
      
    # Environment Check
    environment_check:
      type: object
      properties:
        completed: boolean
        timestamp: datetime
        room_scan_url: string
        webcam_working: boolean
        microphone_working: boolean
        screen_share_working: boolean
        browser_requirements_met: boolean
        notes: text
        
    # Recording URLs
    video_recording_url:
      type: string
      format: url
      
    screen_recording_url:
      type: string
      format: url
      
    audio_recording_url:
      type: string
      format: url
      
    recording_duration_seconds:
      type: integer
      
    # AI Monitoring Metrics
    ai_confidence_score:
      type: decimal
      precision: 5
      scale: 2
      description: Overall AI confidence in exam integrity
      
    face_detection_score:
      type: decimal
      precision: 5
      scale: 2
      
    eye_tracking_score:
      type: decimal
      precision: 5
      scale: 2
      
    audio_analysis_score:
      type: decimal
      precision: 5
      scale: 2
      
    # Flags and Incidents
    total_flags:
      type: integer
      default: 0
      
    flags:
      type: array
      items:
        type: object
        properties:
          id: uuid
          timestamp: datetime
          type:
            type: enum
            values:
              - face_not_detected
              - multiple_faces
              - face_mismatch
              - looking_away
              - phone_detected
              - person_in_background
              - tab_switch
              - browser_unfocused
              - copy_paste_attempt
              - screenshot_attempt
              - external_device
              - audio_anomaly
              - suspicious_movement
              - extended_absence
              - other
          severity: enum[info, low, medium, high, critical]
          details: text
          screenshot_url: string
          video_clip_url: string
          ai_generated: boolean
          reviewed: boolean
          reviewed_by: uuid
          resolution: text
          
    critical_flags_count:
      type: integer
      default: 0
      computed: true
      
    # Browser/Tab Events
    tab_switches:
      type: integer
      default: 0
      
    browser_unfocus_count:
      type: integer
      default: 0
      
    browser_unfocus_duration_seconds:
      type: integer
      default: 0
      
    # Communication Log (for live proctoring)
    chat_messages:
      type: array
      items:
        type: object
        properties:
          timestamp: datetime
          sender_type: enum[candidate, proctor, system]
          message: text
          
    # Proctor Actions
    proctor_actions:
      type: array
      items:
        type: object
        properties:
          timestamp: datetime
          action: enum[warning_issued, break_granted, time_extended, session_paused, session_resumed, session_terminated]
          reason: text
          
    # Final Assessment
    integrity_score:
      type: decimal
      precision: 5
      scale: 2
      description: Final integrity score (0-100)
      
    recommendation:
      type: enum
      values: [pass, review_required, fail]
      
    review_priority:
      type: enum
      values: [low, medium, high, urgent]
      
    # Review
    reviewed_by:
      type: uuid
      references: user
      
    reviewed_at:
      type: datetime
      
    review_notes:
      type: text
      
    final_decision:
      type: enum
      values: [valid, flagged, voided]
      
    # Technical Issues
    technical_issues:
      type: array
      items:
        type: object
        properties:
          timestamp: datetime
          issue_type: string
          description: text
          resolution: text
          time_lost_seconds: integer
          
    # Metadata
    user_agent:
      type: string
      max_length: 500
      
    ip_address:
      type: string
      max_length: 45
      
    proctoring_provider:
      type: string
      max_length: 100
      
    provider_session_id:
      type: string
      max_length: 255
      
    # Timestamps
    created_at:
      type: datetime
      auto_set: create
      
    updated_at:
      type: datetime
      auto_set: update

  computed_fields:
    duration_minutes:
      formula: "(session_end - session_start) / 60"
      type: integer
      
    requires_review:
      formula: "critical_flags_count > 0 OR recommendation = 'review_required'"
      type: boolean
      
    is_clean:
      formula: "total_flags = 0 AND integrity_score >= 80"
      type: boolean

  state_machine:
    field: status
    initial: pending
    transitions:
      - from: pending
        to: setup
        action: begin_setup
        
      - from: setup
        to: active
        action: start_monitoring
        conditions:
          - identity_verified
          - environment_check_passed
          
      - from: active
        to: paused
        action: pause
        
      - from: paused
        to: active
        action: resume
        
      - from: active
        to: completed
        action: complete
        
      - from: active
        to: flagged
        action: flag_critical
        conditions:
          - critical_violation_detected
          
      - from: [completed, flagged]
        to: reviewed
        action: review
        roles: [proctor, admin]

  relationships:
    exam_attempt:
      type: belongs_to
      entity: exam_attempt
      foreign_key: exam_attempt_id
      
    proctor:
      type: belongs_to
      entity: user
      foreign_key: proctor_id
      
    reviewer:
      type: belongs_to
      entity: user
      foreign_key: reviewed_by

  indexes:
    - columns: [session_code]
      unique: true
    - columns: [exam_attempt_id]
      unique: true
    - columns: [proctor_id, status]
    - columns: [status, review_priority]
    - columns: [recommendation]

  audit:
    enabled: true
    track_changes: true
    sensitive_fields: [ip_address, video_recording_url, id_document_url]
