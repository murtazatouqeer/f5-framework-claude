# Response Entity
# F5 Framework v2.0 - Education/Assessment
# Candidate responses to individual questions

entity:
  id: response
  name: Response
  name_ja: 回答
  description: Individual candidate response to a question within an exam attempt
  domain: education
  subdomain: assessment
  version: "1.0.0"

  attributes:
    id:
      type: uuid
      primary_key: true
      
    # References
    attempt_id:
      type: uuid
      references: exam_attempt
      required: true
      
    question_id:
      type: uuid
      references: question
      required: true
      
    # Question Position
    question_index:
      type: integer
      description: Position in the attempt sequence
      
    section_id:
      type: uuid
      description: Section this response belongs to
      
    # Response Status
    status:
      type: enum
      values:
        - not_viewed
        - viewed
        - answered
        - flagged
        - skipped
      default: not_viewed
      
    is_flagged:
      type: boolean
      default: false
      
    # Response Content by Question Type
    
    # Multiple Choice / Multiple Select / True-False
    selected_option_ids:
      type: array
      items: uuid
      description: Selected option IDs for choice questions
      
    # Fill in Blank
    blank_answers:
      type: array
      items:
        type: object
        properties:
          blank_id: uuid
          answer: string
      description: Answers for fill-in-blank questions
      
    # Matching
    matches:
      type: array
      items:
        type: object
        properties:
          premise_id: uuid
          response_id: uuid
      description: Matched pairs for matching questions
      
    # Ordering
    ordered_items:
      type: array
      items: uuid
      description: Items in candidate's order
      
    # Short Answer / Essay
    text_response:
      type: text
      supports_html: true
      description: Free-text response
      
    word_count:
      type: integer
      computed: true
      
    # Numeric
    numeric_response:
      type: decimal
      precision: 15
      scale: 6
      
    # Hotspot
    hotspot_selections:
      type: array
      items:
        type: object
        properties:
          region_id: uuid
          coordinates: array
          
    # Drag and Drop
    drag_drop_placements:
      type: json
      description: Mapping of draggable items to drop zones
      
    # File Upload
    uploaded_files:
      type: array
      items:
        type: object
        properties:
          file_id: uuid
          filename: string
          file_size: integer
          mime_type: string
          url: string
          uploaded_at: datetime
          
    # Timing
    first_viewed_at:
      type: datetime
      
    last_modified_at:
      type: datetime
      
    time_spent_seconds:
      type: integer
      default: 0
      
    # Grading
    grading_status:
      type: enum
      values: [pending, auto_graded, manually_graded, reviewed]
      default: pending
      
    is_correct:
      type: boolean
      
    partial_credit:
      type: boolean
      default: false
      
    points_earned:
      type: decimal
      precision: 6
      scale: 2
      default: 0
      
    points_possible:
      type: decimal
      precision: 6
      scale: 2
      
    # Auto-grading details
    auto_grade_result:
      type: json
      description: Details of automatic grading
      example:
        matched: 3
        total: 4
        deductions: []
        
    # Manual Grading
    graded_by:
      type: uuid
      references: user
      
    graded_at:
      type: datetime
      
    grader_feedback:
      type: text
      supports_html: true
      
    rubric_scores:
      type: array
      items:
        type: object
        properties:
          criterion_id: uuid
          level_id: uuid
          points: decimal
          feedback: text
      description: Rubric-based scoring breakdown
      
    # Review
    needs_review:
      type: boolean
      default: false
      
    review_reason:
      type: string
      max_length: 500
      
    reviewed_by:
      type: uuid
      references: user
      
    reviewed_at:
      type: datetime
      
    # Confidence (optional feature)
    confidence_level:
      type: enum
      values: [very_low, low, medium, high, very_high]
      description: Candidate's self-reported confidence
      
    # Version tracking
    response_version:
      type: integer
      default: 1
      
    previous_responses:
      type: array
      items:
        type: object
        properties:
          version: integer
          response_data: json
          modified_at: datetime
      description: History of response changes
      
    # Timestamps
    created_at:
      type: datetime
      auto_set: create
      
    updated_at:
      type: datetime
      auto_set: update

  computed_fields:
    score_percentage:
      formula: "points_earned / points_possible * 100"
      type: decimal

  relationships:
    attempt:
      type: belongs_to
      entity: exam_attempt
      foreign_key: attempt_id
      
    question:
      type: belongs_to
      entity: question
      foreign_key: question_id
      
    grader:
      type: belongs_to
      entity: user
      foreign_key: graded_by
      
    reviewer:
      type: belongs_to
      entity: user
      foreign_key: reviewed_by

  indexes:
    - columns: [attempt_id, question_id]
      unique: true
    - columns: [attempt_id, question_index]
    - columns: [grading_status]
    - columns: [attempt_id, is_flagged]
    - columns: [graded_by, graded_at]

  validations:
    - name: response_matches_question_type
      condition: "validates response format matches question.question_type"
      message: "Response format must match question type"

  audit:
    enabled: true
    track_changes: true
