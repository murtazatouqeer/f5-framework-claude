# Question Entity
# F5 Framework v2.0 - Education/Assessment
# Assessment question with multiple types support

entity:
  id: question
  name: Question
  name_ja: å•é¡Œ
  description: Assessment question with support for multiple question types and scoring options
  domain: education
  subdomain: assessment
  version: "1.0.0"

  attributes:
    id:
      type: uuid
      primary_key: true
      
    question_code:
      type: string
      max_length: 50
      unique: true
      pattern: "^Q-[A-Z]{3}-[0-9]{5}$"
      
    # Organization
    question_bank_id:
      type: uuid
      references: question_bank
      required: true
      
    category_id:
      type: uuid
      references: question_category
      
    # Status
    status:
      type: enum
      values: [draft, active, retired, flagged]
      default: draft
      
    # Question Type
    question_type:
      type: enum
      values:
        - multiple_choice
        - multiple_select
        - true_false
        - fill_blank
        - matching
        - ordering
        - short_answer
        - essay
        - numeric
        - hotspot
        - drag_drop
      required: true
      
    # Content
    question_text:
      type: text
      required: true
      supports_html: true
      supports_latex: true
      
    question_media:
      type: array
      items:
        type: object
        properties:
          type:
            type: enum
            values: [image, audio, video]
          url: string
          alt_text: string
          caption: string
          
    explanation:
      type: text
      supports_html: true
      description: Explanation shown after answer
      
    hint:
      type: text
      description: Optional hint for candidate
      
    # Difficulty & Taxonomy
    difficulty_level:
      type: enum
      values: [very_easy, easy, medium, hard, very_hard]
      default: medium
      
    difficulty_index:
      type: decimal
      precision: 4
      scale: 3
      min: 0
      max: 1
      description: Calculated from item analysis (0-1)
      
    discrimination_index:
      type: decimal
      precision: 4
      scale: 3
      min: -1
      max: 1
      description: How well question discriminates (-1 to 1)
      
    bloom_level:
      type: enum
      values:
        - remember
        - understand
        - apply
        - analyze
        - evaluate
        - create
      description: Bloom's taxonomy level
      
    # Scoring
    points:
      type: decimal
      precision: 6
      scale: 2
      default: 1.0
      min: 0
      
    max_points:
      type: decimal
      precision: 6
      scale: 2
      
    partial_credit_enabled:
      type: boolean
      default: false
      
    grading_type:
      type: enum
      values: [auto, manual, hybrid]
      default: auto
      
    # Multiple Choice/Select Options
    options:
      type: array
      items:
        type: object
        properties:
          id: uuid
          text: text
          media_url: string
          is_correct: boolean
          points: decimal
          feedback: text
      description: For choice-based questions
      
    correct_option_ids:
      type: array
      items: uuid
      
    min_selections:
      type: integer
      min: 1
      description: For multiple select
      
    max_selections:
      type: integer
      description: For multiple select
      
    # Matching Question
    premises:
      type: array
      items:
        type: object
        properties:
          id: uuid
          text: text
          media_url: string
          
    responses:
      type: array
      items:
        type: object
        properties:
          id: uuid
          text: text
          media_url: string
          
    correct_matches:
      type: array
      items:
        type: object
        properties:
          premise_id: uuid
          response_id: uuid
          
    # Fill in Blank
    blanks:
      type: array
      items:
        type: object
        properties:
          id: uuid
          position: integer
          correct_answers: array
          case_sensitive: boolean
          partial_credit: boolean
          
    # Numeric Question
    numeric_answer:
      type: decimal
      precision: 15
      scale: 6
      
    numeric_tolerance:
      type: decimal
      precision: 10
      scale: 6
      
    tolerance_type:
      type: enum
      values: [absolute, percentage]
      default: absolute
      
    # Ordering
    correct_order:
      type: array
      items: uuid
      description: Correct sequence of item IDs
      
    ordering_items:
      type: array
      items:
        type: object
        properties:
          id: uuid
          text: text
          media_url: string
          
    # Hotspot
    hotspot_image_url:
      type: string
      format: url
      
    hotspot_regions:
      type: array
      items:
        type: object
        properties:
          id: uuid
          shape: enum[rectangle, circle, polygon]
          coordinates: array
          is_correct: boolean
          
    # Essay/Short Answer
    word_limit_min:
      type: integer
      
    word_limit_max:
      type: integer
      
    rubric_id:
      type: uuid
      references: grading_rubric
      
    # Metadata
    tags:
      type: array
      items: string
      
    learning_objective_id:
      type: uuid
      
    source:
      type: string
      max_length: 500
      description: Question source/reference
      
    author_id:
      type: uuid
      references: user
      
    # Usage Statistics
    usage_count:
      type: integer
      default: 0
      
    last_used_at:
      type: datetime
      
    times_answered:
      type: integer
      default: 0
      
    times_correct:
      type: integer
      default: 0
      
    average_time_seconds:
      type: integer
      
    # Version Control
    version:
      type: integer
      default: 1
      
    previous_version_id:
      type: uuid
      references: question
      
    # QTI Export
    qti_identifier:
      type: string
      max_length: 255
      
    # Timestamps
    created_at:
      type: datetime
      auto_set: create
      
    updated_at:
      type: datetime
      auto_set: update

  computed_fields:
    success_rate:
      formula: "times_correct / times_answered * 100"
      type: decimal
      
    is_auto_gradable:
      formula: "question_type NOT IN ('essay', 'short_answer', 'file_upload')"
      type: boolean

  relationships:
    question_bank:
      type: belongs_to
      entity: question_bank
      foreign_key: question_bank_id
      
    category:
      type: belongs_to
      entity: question_category
      foreign_key: category_id
      
    author:
      type: belongs_to
      entity: user
      foreign_key: author_id
      
    rubric:
      type: belongs_to
      entity: grading_rubric
      foreign_key: rubric_id
      
    responses:
      type: has_many
      entity: response
      foreign_key: question_id
      
    item_analyses:
      type: has_many
      entity: item_analysis
      foreign_key: question_id
      
    previous_version:
      type: belongs_to
      entity: question
      foreign_key: previous_version_id
      
    exams:
      type: has_many
      entity: exam
      through: exam_questions

  indexes:
    - columns: [question_code]
      unique: true
    - columns: [question_bank_id, status]
    - columns: [category_id]
    - columns: [question_type, difficulty_level]
    - columns: [author_id]
    - columns: [status, difficulty_level]

  validations:
    - name: multiple_choice_options
      condition: "question_type != 'multiple_choice' OR options.length >= 2"
      message: "Multiple choice must have at least 2 options"
      
    - name: correct_answer_required
      condition: "question_type IN ('essay', 'short_answer') OR correct_option_ids.length > 0 OR correct_matches.length > 0 OR correct_order.length > 0 OR numeric_answer IS NOT NULL OR blanks.length > 0"
      message: "Correct answer must be defined"

  audit:
    enabled: true
    track_changes: true
