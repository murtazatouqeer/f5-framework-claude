# Item Analysis Entity
# F5 Framework v2.0 - Education/Assessment
# Psychometric analysis for questions

entity:
  id: item_analysis
  name: Item Analysis
  name_ja: 項目分析
  description: Psychometric analysis results for exam questions
  domain: education
  subdomain: assessment
  version: "1.0.0"

  attributes:
    id:
      type: uuid
      primary_key: true
      
    # References
    question_id:
      type: uuid
      references: question
      required: true
      
    exam_id:
      type: uuid
      references: exam
      required: true
      
    # Analysis Period
    analysis_period_start:
      type: datetime
      required: true
      
    analysis_period_end:
      type: datetime
      required: true
      
    # Sample Size
    total_responses:
      type: integer
      required: true
      
    valid_responses:
      type: integer
      description: Responses after excluding incomplete attempts
      
    # Classical Test Theory (CTT) Metrics
    
    # Difficulty Index (P-value)
    difficulty_index:
      type: decimal
      precision: 5
      scale: 4
      description: "Proportion correct (0-1), higher = easier"
      
    difficulty_category:
      type: enum
      values: [very_easy, easy, medium, hard, very_hard]
      computed: true
      
    # Discrimination Index
    discrimination_index:
      type: decimal
      precision: 5
      scale: 4
      description: "Upper-lower 27% method (-1 to 1)"
      
    discrimination_quality:
      type: enum
      values: [excellent, good, acceptable, poor, negative]
      computed: true
      
    # Point-Biserial Correlation
    point_biserial:
      type: decimal
      precision: 5
      scale: 4
      description: "Correlation with total score (-1 to 1)"
      
    # Corrected Item-Total Correlation
    corrected_item_total:
      type: decimal
      precision: 5
      scale: 4
      
    # Response Time Analysis
    mean_response_time_seconds:
      type: decimal
      precision: 10
      scale: 2
      
    median_response_time_seconds:
      type: decimal
      precision: 10
      scale: 2
      
    std_dev_response_time:
      type: decimal
      precision: 10
      scale: 2
      
    # Option Analysis (for multiple choice)
    option_analysis:
      type: array
      items:
        type: object
        properties:
          option_id: uuid
          option_label: string
          selection_count: integer
          selection_percentage: decimal
          point_biserial: decimal
          upper_group_selection: decimal
          lower_group_selection: decimal
          is_correct: boolean
          distractor_effectiveness: enum[effective, weak, non_functioning]
          
    # Distractor Analysis
    distractors_functioning:
      type: integer
      description: Count of effective distractors
      
    distractors_total:
      type: integer
      
    distractor_efficiency:
      type: decimal
      precision: 5
      scale: 2
      description: Percentage of functioning distractors
      
    # Answer Change Analysis
    answer_changes:
      type: object
      properties:
        total_changes: integer
        wrong_to_right: integer
        right_to_wrong: integer
        wrong_to_wrong: integer
        net_gain: integer
        
    # Skip/Flag Analysis
    skip_rate:
      type: decimal
      precision: 5
      scale: 4
      
    flag_rate:
      type: decimal
      precision: 5
      scale: 4
      
    # Item Response Theory (IRT) Parameters
    irt_model:
      type: enum
      values: [rasch, 2pl, 3pl, grm]
      description: IRT model used
      
    # IRT Difficulty (b parameter)
    irt_difficulty:
      type: decimal
      precision: 6
      scale: 4
      
    irt_difficulty_se:
      type: decimal
      precision: 6
      scale: 4
      description: Standard error
      
    # IRT Discrimination (a parameter)
    irt_discrimination:
      type: decimal
      precision: 6
      scale: 4
      
    irt_discrimination_se:
      type: decimal
      precision: 6
      scale: 4
      
    # IRT Guessing (c parameter) for 3PL
    irt_guessing:
      type: decimal
      precision: 6
      scale: 4
      
    irt_guessing_se:
      type: decimal
      precision: 6
      scale: 4
      
    # Item Fit Statistics
    infit_mnsq:
      type: decimal
      precision: 6
      scale: 4
      description: Infit mean square
      
    outfit_mnsq:
      type: decimal
      precision: 6
      scale: 4
      description: Outfit mean square
      
    item_fit_status:
      type: enum
      values: [good_fit, acceptable, overfit, underfit]
      
    # Information Function
    max_information:
      type: decimal
      precision: 6
      scale: 4
      
    theta_at_max_info:
      type: decimal
      precision: 6
      scale: 4
      description: Ability level at maximum information
      
    # DIF Analysis (Differential Item Functioning)
    dif_analyzed:
      type: boolean
      default: false
      
    dif_results:
      type: array
      items:
        type: object
        properties:
          group_variable: string
          reference_group: string
          focal_group: string
          method: enum[mh, lr, irt]
          dif_statistic: decimal
          p_value: decimal
          effect_size: decimal
          dif_classification: enum[negligible, slight, moderate, large]
          
    # Quality Indicators
    quality_flags:
      type: array
      items:
        type: object
        properties:
          flag_type: enum[too_easy, too_hard, low_discrimination, negative_discrimination, non_functioning_distractors, high_skip_rate, potential_dif, poor_fit]
          severity: enum[info, warning, critical]
          details: text
          
    overall_quality:
      type: enum
      values: [excellent, good, acceptable, needs_review, problematic]
      
    # Recommendations
    recommendations:
      type: array
      items:
        type: object
        properties:
          type: enum[retire, revise, replace_distractor, review_content, flag_for_bias, accept]
          priority: enum[low, medium, high]
          details: text
          
    # Comparison
    previous_analysis_id:
      type: uuid
      references: item_analysis
      
    difficulty_trend:
      type: enum
      values: [stable, increasing, decreasing]
      
    discrimination_trend:
      type: enum
      values: [stable, improving, declining]
      
    # Metadata
    analysis_version:
      type: string
      max_length: 20
      
    analyzed_by:
      type: uuid
      references: user
      
    notes:
      type: text
      
    # Timestamps
    created_at:
      type: datetime
      auto_set: create
      
    updated_at:
      type: datetime
      auto_set: update

  computed_fields:
    has_quality_issues:
      formula: "quality_flags.any(f => f.severity = 'critical')"
      type: boolean
      
    is_statistically_valid:
      formula: "valid_responses >= 100"
      type: boolean

  relationships:
    question:
      type: belongs_to
      entity: question
      foreign_key: question_id
      
    exam:
      type: belongs_to
      entity: exam
      foreign_key: exam_id
      
    analyst:
      type: belongs_to
      entity: user
      foreign_key: analyzed_by
      
    previous_analysis:
      type: belongs_to
      entity: item_analysis
      foreign_key: previous_analysis_id

  indexes:
    - columns: [question_id, exam_id]
    - columns: [question_id, analysis_period_end]
    - columns: [exam_id, overall_quality]
    - columns: [discrimination_index]
    - columns: [difficulty_index]

  validations:
    - name: valid_period
      condition: "analysis_period_start < analysis_period_end"
      message: "Analysis period end must be after start"
      
    - name: min_responses
      condition: "total_responses >= 30"
      message: "Minimum 30 responses required for meaningful analysis"

  audit:
    enabled: true
    track_changes: false
