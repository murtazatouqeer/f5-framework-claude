# Exam Entity
# F5 Framework v2.0 - Education/Assessment
# Core examination entity

entity:
  id: exam
  name: Exam
  name_ja: 試験
  description: Examination or test definition with questions, settings, and delivery configuration
  domain: education
  subdomain: assessment
  version: "1.0.0"

  attributes:
    id:
      type: uuid
      primary_key: true
      
    exam_code:
      type: string
      max_length: 50
      unique: true
      pattern: "^EX-[0-9]{4}-[0-9]{3}$"
      description: "Unique exam code (e.g., EX-2024-001)"
      
    # Basic Information
    title:
      type: string
      max_length: 300
      required: true
      
    description:
      type: text
      supports_markdown: true
      
    instructions:
      type: text
      supports_markdown: true
      description: Exam instructions shown before start
      
    # Classification
    exam_type:
      type: enum
      values:
        - quiz
        - test
        - midterm
        - final
        - certification
        - practice
        - diagnostic
      required: true
      
    category_id:
      type: uuid
      references: question_category
      
    # Status
    status:
      type: enum
      values: [draft, scheduled, active, completed, archived]
      default: draft
      
    # Creator
    created_by:
      type: uuid
      references: user
      required: true
      
    organization_id:
      type: uuid
      references: organization
      
    # Question Structure
    total_questions:
      type: integer
      min: 1
      computed: true
      
    total_points:
      type: decimal
      precision: 10
      scale: 2
      computed: true
      
    sections:
      type: array
      items:
        type: object
        properties:
          id: uuid
          title: string
          description: text
          question_count: integer
          points: decimal
          instructions: text
          
    # Question Source
    question_source:
      type: enum
      values:
        - fixed           # Specific questions selected
        - pool_random     # Random from question pool
        - adaptive        # Adaptive based on performance
      default: fixed
      
    question_pool_id:
      type: uuid
      references: exam_pool
      description: Pool for random selection
      
    pool_selection_rules:
      type: json
      description: Rules for random question selection
      
    # Timing
    duration_minutes:
      type: integer
      min: 1
      max: 480
      
    time_limit_enabled:
      type: boolean
      default: true
      
    auto_submit_on_timeout:
      type: boolean
      default: true
      
    extra_time_allowed:
      type: boolean
      default: true
      description: Allow accommodations for extra time
      
    warning_intervals:
      type: array
      items: integer
      default: [30, 10, 5, 1]
      description: Minutes remaining to show warning
      
    # Attempts
    max_attempts:
      type: integer
      min: 1
      default: 1
      
    attempt_interval_hours:
      type: integer
      min: 0
      default: 0
      description: Cooldown between attempts
      
    best_score_policy:
      type: enum
      values: [highest, latest, average, first]
      default: highest
      
    # Scoring
    passing_score:
      type: decimal
      precision: 10
      scale: 2
      
    passing_percentage:
      type: decimal
      precision: 5
      scale: 2
      min: 0
      max: 100
      
    scoring_type:
      type: enum
      values: [points, percentage, pass_fail, grade]
      default: percentage
      
    negative_marking:
      type: boolean
      default: false
      
    negative_mark_value:
      type: decimal
      precision: 5
      scale: 2
      description: Points deducted per wrong answer
      
    partial_credit:
      type: boolean
      default: true
      
    # Display Settings
    question_display:
      type: enum
      values:
        - all_at_once
        - one_per_page
        - section_by_section
      default: one_per_page
      
    question_order:
      type: enum
      values: [fixed, random]
      default: fixed
      
    answer_order:
      type: enum
      values: [fixed, random]
      default: fixed
      
    show_question_number:
      type: boolean
      default: true
      
    show_points_per_question:
      type: boolean
      default: true
      
    # Navigation
    allow_navigation:
      type: boolean
      default: true
      description: Allow going back to previous questions
      
    allow_review:
      type: boolean
      default: true
      description: Allow review before submission
      
    allow_flag:
      type: boolean
      default: true
      description: Allow flagging questions for review
      
    require_all_answered:
      type: boolean
      default: false
      
    # Feedback Settings
    show_score:
      type: enum
      values:
        - immediately
        - after_deadline
        - manual_release
        - never
      default: immediately
      
    show_answers:
      type: enum
      values:
        - never
        - after_attempt
        - after_deadline
        - after_all_attempts
      default: after_attempt
      
    show_feedback:
      type: boolean
      default: true
      
    show_correct_answers:
      type: boolean
      default: true
      
    # Security
    requires_proctoring:
      type: boolean
      default: false
      
    proctoring_type:
      type: enum
      values: [live, recorded, ai_based]
      
    proctoring_config:
      type: json
      description: Proctoring provider configuration
      
    browser_lockdown:
      type: boolean
      default: false
      
    copy_paste_disabled:
      type: boolean
      default: true
      
    right_click_disabled:
      type: boolean
      default: true
      
    screen_capture_blocked:
      type: boolean
      default: false
      
    # Access Control
    access_code_required:
      type: boolean
      default: false
      
    access_code:
      type: string
      max_length: 50
      
    ip_restriction:
      type: array
      items: string
      description: Allowed IP addresses/ranges
      
    allowed_devices:
      type: array
      items: string
      description: Allowed device types
      
    # Scheduling
    available_from:
      type: datetime
      
    available_until:
      type: datetime
      
    schedule_id:
      type: uuid
      references: exam_schedule
      
    # Publication
    published_at:
      type: datetime
      
    # Metadata
    tags:
      type: array
      items: string
      
    created_at:
      type: datetime
      auto_set: create
      
    updated_at:
      type: datetime
      auto_set: update

  state_machine:
    field: status
    initial: draft
    transitions:
      - from: draft
        to: scheduled
        action: schedule
        conditions:
          - has_questions
          - schedule_set
          
      - from: draft
        to: active
        action: activate
        conditions:
          - has_questions
          
      - from: scheduled
        to: active
        action: start
        trigger: schedule_reached
        
      - from: active
        to: completed
        action: complete
        trigger: availability_ended
        
      - from: [draft, scheduled, completed]
        to: archived
        action: archive

  relationships:
    questions:
      type: has_many
      entity: question
      through: exam_questions
      
    question_pool:
      type: belongs_to
      entity: exam_pool
      foreign_key: question_pool_id
      
    attempts:
      type: has_many
      entity: exam_attempt
      foreign_key: exam_id
      
    results:
      type: has_many
      entity: exam_result
      foreign_key: exam_id
      
    schedule:
      type: belongs_to
      entity: exam_schedule
      foreign_key: schedule_id
      
    creator:
      type: belongs_to
      entity: user
      foreign_key: created_by
      
    category:
      type: belongs_to
      entity: question_category
      foreign_key: category_id

  indexes:
    - columns: [exam_code]
      unique: true
    - columns: [status, available_from]
    - columns: [created_by]
    - columns: [organization_id, status]
    - columns: [exam_type]

  validations:
    - name: valid_dates
      condition: "available_until IS NULL OR available_from <= available_until"
      message: "End date must be after start date"
      
    - name: passing_criteria
      condition: "passing_score IS NOT NULL OR passing_percentage IS NOT NULL"
      message: "Must define passing criteria for non-practice exams"
      applies_when: "exam_type != 'practice'"

  audit:
    enabled: true
    track_changes: true
