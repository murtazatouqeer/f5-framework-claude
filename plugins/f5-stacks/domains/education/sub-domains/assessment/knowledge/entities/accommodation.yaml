# Accommodation Entity
# F5 Framework v2.0 - Education/Assessment
# Special accommodations for candidates

entity:
  id: accommodation
  name: Accommodation
  name_ja: 配慮措置
  description: Special accommodations for candidates with disabilities or special needs
  domain: education
  subdomain: assessment
  version: "1.0.0"

  attributes:
    id:
      type: uuid
      primary_key: true
      
    accommodation_code:
      type: string
      max_length: 50
      unique: true
      pattern: "^ACC-[A-Z]{2}-[0-9]{6}$"
      
    # Candidate Reference
    candidate_id:
      type: uuid
      references: user
      required: true
      
    # Status
    status:
      type: enum
      values:
        - requested
        - under_review
        - approved
        - denied
        - expired
        - revoked
      default: requested
      
    # Accommodation Type
    accommodation_type:
      type: enum
      values:
        - time_extension
        - separate_room
        - reader_assistance
        - scribe_assistance
        - assistive_technology
        - breaks
        - alternate_format
        - sign_language
        - enlarged_text
        - audio_format
        - physical_access
        - reduced_distractions
        - other
      required: true
      
    # Time Extensions
    extra_time_percentage:
      type: integer
      min: 0
      max: 300
      description: Additional time as percentage (e.g., 50 = 50% extra time)
      
    extra_time_minutes:
      type: integer
      min: 0
      description: Fixed additional minutes
      
    unlimited_time:
      type: boolean
      default: false
      
    # Break Accommodations
    break_frequency_minutes:
      type: integer
      description: Break every N minutes
      
    break_duration_minutes:
      type: integer
      
    breaks_count:
      type: integer
      
    break_type:
      type: enum
      values: [timed, untimed, as_needed]
      
    # Format Accommodations
    font_size:
      type: integer
      min: 12
      max: 72
      
    high_contrast:
      type: boolean
      default: false
      
    screen_reader_compatible:
      type: boolean
      default: false
      
    audio_descriptions:
      type: boolean
      default: false
      
    braille_format:
      type: boolean
      default: false
      
    large_print:
      type: boolean
      default: false
      
    # Assistance
    human_reader:
      type: boolean
      default: false
      
    human_scribe:
      type: boolean
      default: false
      
    sign_language_interpreter:
      type: boolean
      default: false
      
    personal_assistant:
      type: boolean
      default: false
      
    # Technology Accommodations
    assistive_technology_allowed:
      type: array
      items:
        type: object
        properties:
          technology_type: string
          specific_tool: string
          settings: json
      example:
        - technology_type: "screen_reader"
          specific_tool: "JAWS"
        - technology_type: "speech_to_text"
          specific_tool: "Dragon"
          
    calculator_allowed:
      type: boolean
      default: false
      
    calculator_type:
      type: enum
      values: [basic, scientific, graphing]
      
    spell_checker_allowed:
      type: boolean
      default: false
      
    dictionary_allowed:
      type: boolean
      default: false
      
    # Environment
    separate_room:
      type: boolean
      default: false
      
    reduced_distractions:
      type: boolean
      default: false
      
    preferred_seating:
      type: string
      max_length: 200
      
    lighting_requirements:
      type: string
      max_length: 500
      
    noise_cancellation:
      type: boolean
      default: false
      
    # Physical Accommodations
    wheelchair_accessible:
      type: boolean
      default: false
      
    adjustable_desk:
      type: boolean
      default: false
      
    special_seating:
      type: string
      max_length: 500
      
    # Documentation
    disability_type:
      type: string
      max_length: 200
      
    documentation_provided:
      type: boolean
      default: false
      
    documentation_files:
      type: array
      items:
        type: object
        properties:
          file_id: uuid
          filename: string
          upload_date: datetime
          document_type: enum[medical, educational, legal, other]
          
    professional_recommendation:
      type: text
      
    iep_504_plan:
      type: boolean
      default: false
      description: Has IEP or Section 504 Plan
      
    # Validity
    valid_from:
      type: datetime
      
    valid_until:
      type: datetime
      
    requires_renewal:
      type: boolean
      default: true
      
    renewal_reminder_sent:
      type: boolean
      default: false
      
    # Exam Scope
    applies_to:
      type: enum
      values:
        - all_exams
        - specific_exams
        - specific_types
        - specific_subjects
      default: all_exams
      
    applicable_exam_ids:
      type: array
      items: uuid
      
    applicable_exam_types:
      type: array
      items: string
      
    applicable_subjects:
      type: array
      items: string
      
    # Approval Process
    requested_at:
      type: datetime
      
    requested_reason:
      type: text
      
    reviewed_by:
      type: uuid
      references: user
      
    reviewed_at:
      type: datetime
      
    approval_notes:
      type: text
      
    denial_reason:
      type: text
      
    # Proctoring Adjustments
    proctoring_modifications:
      type: json
      description: Adjustments to proctoring for this accommodation
      example:
        disable_face_detection: true
        allow_assistive_device: true
        extended_setup_time: 15
        
    # Usage Tracking
    times_used:
      type: integer
      default: 0
      
    last_used_at:
      type: datetime
      
    # Custom Instructions
    special_instructions:
      type: text
      description: Additional instructions for proctors/administrators
      
    candidate_notes:
      type: text
      description: Notes visible to candidate
      
    # Confidentiality
    confidentiality_level:
      type: enum
      values: [standard, restricted, highly_restricted]
      default: standard
      
    # Metadata
    created_by:
      type: uuid
      references: user
      required: true
      
    # Timestamps
    created_at:
      type: datetime
      auto_set: create
      
    updated_at:
      type: datetime
      auto_set: update

  computed_fields:
    is_active:
      formula: "status = 'approved' AND (valid_until IS NULL OR valid_until > NOW())"
      type: boolean
      
    needs_renewal:
      formula: "requires_renewal AND valid_until IS NOT NULL AND valid_until < NOW() + INTERVAL '30 days'"
      type: boolean

  state_machine:
    field: status
    initial: requested
    transitions:
      - from: requested
        to: under_review
        action: start_review
        roles: [accommodation_coordinator, admin]
        
      - from: under_review
        to: approved
        action: approve
        roles: [accommodation_coordinator, admin]
        
      - from: under_review
        to: denied
        action: deny
        roles: [accommodation_coordinator, admin]
        
      - from: approved
        to: expired
        action: expire
        trigger: valid_until_passed
        
      - from: approved
        to: revoked
        action: revoke
        roles: [admin]
        
      - from: denied
        to: under_review
        action: appeal
        conditions:
          - within_appeal_period

  relationships:
    candidate:
      type: belongs_to
      entity: user
      foreign_key: candidate_id
      
    reviewer:
      type: belongs_to
      entity: user
      foreign_key: reviewed_by
      
    creator:
      type: belongs_to
      entity: user
      foreign_key: created_by
      
    exam_attempts:
      type: has_many
      entity: exam_attempt
      foreign_key: accommodation_id

  indexes:
    - columns: [accommodation_code]
      unique: true
    - columns: [candidate_id, status]
    - columns: [candidate_id, accommodation_type]
    - columns: [status, valid_until]
    - columns: [reviewed_by]

  validations:
    - name: valid_date_range
      condition: "valid_until IS NULL OR valid_from <= valid_until"
      message: "Valid until must be after valid from"
      
    - name: extra_time_specified
      condition: "accommodation_type != 'time_extension' OR extra_time_percentage IS NOT NULL OR extra_time_minutes IS NOT NULL OR unlimited_time = true"
      message: "Time extension accommodation must specify extra time"

  audit:
    enabled: true
    track_changes: true
    sensitive_fields: [disability_type, documentation_files, professional_recommendation]
