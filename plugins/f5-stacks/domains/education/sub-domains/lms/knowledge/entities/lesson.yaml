# Lesson Entity
# F5 Framework v2.0 - Education/LMS
# Individual learning unit within a module

entity:
  id: lesson
  name: Lesson
  name_ja: レッスン
  description: Single learning unit containing content and activities
  domain: education
  subdomain: lms
  version: "1.0.0"

  attributes:
    id:
      type: uuid
      primary_key: true
      
    module_id:
      type: uuid
      references: module
      required: true
      
    course_id:
      type: uuid
      references: course
      required: true
      
    # Basic Information
    title:
      type: string
      max_length: 200
      required: true
      
    description:
      type: text
      max_length: 2000
      supports_markdown: true
      
    # Ordering
    sequence_order:
      type: integer
      required: true
      min: 1
      
    # Status
    status:
      type: enum
      values: [draft, published, hidden]
      default: draft
      
    # Lesson Type
    lesson_type:
      type: enum
      values:
        - video
        - article
        - quiz
        - assignment
        - discussion
        - live_session
        - scorm
        - external_link
        - interactive
        - audio
        - document
      required: true
      
    # Duration
    duration_minutes:
      type: integer
      min: 0
      
    estimated_time_minutes:
      type: integer
      min: 0
      description: Estimated time to complete
      
    # Content
    content_items:
      type: array
      items: uuid
      description: Ordered content items
      
    # Video Specific
    video_url:
      type: string
      format: url
      
    video_provider:
      type: enum
      values: [internal, youtube, vimeo, wistia, cloudflare]
      
    video_duration_seconds:
      type: integer
      
    video_thumbnail_url:
      type: string
      format: url
      
    chapters:
      type: array
      items:
        type: object
        properties:
          time_seconds: integer
          title: string
          
    transcript:
      type: text
      
    captions:
      type: array
      items:
        type: object
        properties:
          language: string
          url: string
          
    # Article Specific
    article_content:
      type: text
      supports_markdown: true
      
    # External Link
    external_url:
      type: string
      format: url
      
    open_in_new_tab:
      type: boolean
      default: true
      
    # SCORM/xAPI
    scorm_package_id:
      type: uuid
      
    xapi_activity_id:
      type: string
      format: iri
      
    # Completion Criteria
    completion_criteria:
      type: enum
      values:
        - view         # Just accessing counts
        - time_spent   # Minimum time required
        - video_watched # Video percentage watched
        - quiz_pass    # Pass associated quiz
        - assignment_submit # Submit assignment
        - manual       # Manually mark complete
        - scorm_complete # SCORM completion status
      default: view
      
    min_time_required_seconds:
      type: integer
      description: For time_spent completion
      
    video_watch_threshold_percent:
      type: integer
      min: 0
      max: 100
      default: 90
      description: Percentage of video that must be watched
      
    quiz_pass_percentage:
      type: integer
      min: 0
      max: 100
      description: Required score to pass
      
    # Access Control
    is_preview:
      type: boolean
      default: false
      description: Available without enrollment
      
    is_required:
      type: boolean
      default: true
      description: Required for module completion
      
    unlock_type:
      type: enum
      values: [immediate, sequential, date_based, prerequisite]
      default: immediate
      
    unlock_date:
      type: datetime
      
    prerequisite_lesson_ids:
      type: array
      items: uuid
      
    # Attachments
    resources:
      type: array
      items: uuid
      references: resource
      
    downloadable:
      type: boolean
      default: false
      description: Allow content download
      
    # Live Session (for live_session type)
    session_datetime:
      type: datetime
      
    session_duration_minutes:
      type: integer
      
    meeting_url:
      type: string
      format: url
      
    recording_available:
      type: boolean
      default: false
      
    recording_url:
      type: string
      format: url
      
    # Metadata
    created_at:
      type: datetime
      auto_set: create
      
    updated_at:
      type: datetime
      auto_set: update

  relationships:
    module:
      type: belongs_to
      entity: module
      foreign_key: module_id
      
    course:
      type: belongs_to
      entity: course
      foreign_key: course_id
      
    content_items:
      type: has_many
      entity: content_item
      foreign_key: lesson_id
      order_by: sequence_order
      
    resources:
      type: has_many
      entity: resource
      foreign_key: lesson_id
      
    progress_records:
      type: has_many
      entity: progress
      foreign_key: lesson_id
      
    bookmarks:
      type: has_many
      entity: bookmark
      foreign_key: lesson_id
      
    notes:
      type: has_many
      entity: note
      foreign_key: lesson_id
      
    discussions:
      type: has_many
      entity: discussion
      foreign_key: lesson_id

  indexes:
    - columns: [module_id, sequence_order]
      unique: true
    - columns: [course_id, status]
    - columns: [lesson_type]
    - columns: [is_preview]

  validations:
    - name: video_fields_for_video_type
      condition: "lesson_type == 'video'"
      validation: "video_url IS NOT NULL"
      message: "Video URL required for video lessons"
      
    - name: external_url_for_external_type
      condition: "lesson_type == 'external_link'"
      validation: "external_url IS NOT NULL"
      message: "External URL required for external link lessons"
      
    - name: session_datetime_for_live
      condition: "lesson_type == 'live_session'"
      validation: "session_datetime IS NOT NULL"
      message: "Session datetime required for live sessions"

  audit:
    enabled: true
    track_changes: true
