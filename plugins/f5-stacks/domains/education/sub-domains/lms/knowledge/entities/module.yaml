# Module Entity
# F5 Framework v2.0 - Education/LMS
# Course module/section container

entity:
  id: module
  name: Module
  name_ja: モジュール
  description: Logical grouping of lessons within a course
  domain: education
  subdomain: lms
  version: "1.0.0"

  attributes:
    id:
      type: uuid
      primary_key: true
      
    course_id:
      type: uuid
      references: course
      required: true
      
    # Basic Information
    title:
      type: string
      max_length: 200
      required: true
      
    description:
      type: text
      max_length: 2000
      supports_markdown: true
      
    # Ordering
    sequence_order:
      type: integer
      required: true
      min: 1
      
    # Status
    status:
      type: enum
      values: [draft, published, hidden]
      default: draft
      
    # Content
    lessons:
      type: array
      items: uuid
      description: Ordered list of lesson IDs
      
    total_lessons:
      type: integer
      default: 0
      computed: true
      
    total_duration_minutes:
      type: integer
      default: 0
      computed: true
      
    # Completion Rules
    completion_type:
      type: enum
      values: [all_lessons, percentage, specific_lessons, manual]
      default: all_lessons
      
    completion_threshold_percent:
      type: integer
      min: 0
      max: 100
      default: 100
      description: Required if completion_type is percentage
      
    required_lesson_ids:
      type: array
      items: uuid
      description: Required if completion_type is specific_lessons
      
    is_required:
      type: boolean
      default: true
      description: Required for course completion
      
    # Access Control
    unlock_type:
      type: enum
      values: [immediate, sequential, date_based, prerequisite, manual]
      default: immediate
      
    unlock_date:
      type: datetime
      description: For date_based unlock
      
    unlock_days_after_enrollment:
      type: integer
      description: Days after enrollment to unlock
      
    prerequisite_module_ids:
      type: array
      items: uuid
      description: Modules that must be completed first
      
    # Resources
    resources:
      type: array
      items: uuid
      references: resource
      
    # Metadata
    created_at:
      type: datetime
      auto_set: create
      
    updated_at:
      type: datetime
      auto_set: update

  relationships:
    course:
      type: belongs_to
      entity: course
      foreign_key: course_id
      
    lessons:
      type: has_many
      entity: lesson
      foreign_key: module_id
      order_by: sequence_order
      
    resources:
      type: has_many
      entity: resource
      foreign_key: module_id
      
    progress_records:
      type: has_many
      entity: progress
      foreign_key: module_id
      
    prerequisite_modules:
      type: many_to_many
      entity: module
      through: module_prerequisite

  indexes:
    - columns: [course_id, sequence_order]
      unique: true
    - columns: [course_id, status]
    - columns: [unlock_type]

  validations:
    - name: sequence_positive
      validation: "sequence_order >= 1"
      message: "Sequence order must be at least 1"
      
    - name: threshold_for_percentage
      condition: "completion_type == 'percentage'"
      validation: "completion_threshold_percent IS NOT NULL"
      message: "Threshold required for percentage completion"
      
    - name: unlock_date_for_date_based
      condition: "unlock_type == 'date_based'"
      validation: "unlock_date IS NOT NULL"
      message: "Unlock date required for date-based unlock"

  audit:
    enabled: true
    track_changes: true
