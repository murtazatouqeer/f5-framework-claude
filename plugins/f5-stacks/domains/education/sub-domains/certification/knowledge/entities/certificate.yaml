# Certificate Entity
# F5 Framework v2.0 - Education/Certification
# Core certificate record representing an issued credential

entity:
  id: certificate
  name: Certificate
  name_ja: 証明書
  domain: education
  subdomain: certification
  version: "1.0.0"
  
  description: |
    A formal document or digital credential issued to an individual
    upon successful completion of requirements for a certification program.
    Supports digital issuance, verification, renewal, and sharing.

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true
      description: Unique system identifier
      
    - name: certificate_id
      type: string
      format: "CERT-{XXXXXXXX}"
      unique: true
      indexed: true
      description: Public certificate identifier
      
    - name: certificate_number
      type: string
      format: "{prefix}-{year}-{sequence}"
      unique: true
      indexed: true
      example: "AWS-2024-00012345"
      description: Human-readable certificate number
      
    # Associations
    - name: program_id
      type: uuid
      foreign_key: certification_program.id
      required: true
      indexed: true
      description: Associated certification program
      
    - name: holder_id
      type: uuid
      foreign_key: credential_holder.id
      required: true
      indexed: true
      description: Certificate holder
      
    - name: template_id
      type: uuid
      foreign_key: certificate_template.id
      description: Template used for rendering

    # Status
    - name: status
      type: enum
      values: [pending, issued, active, expired, revoked, suspended, renewed]
      default: pending
      indexed: true
      description: Current certificate status
      
    - name: status_reason
      type: string
      max_length: 500
      description: Reason for current status

    # Issuance
    - name: issued_at
      type: timestamp
      indexed: true
      description: Date and time of issuance
      
    - name: issued_by
      type: uuid
      foreign_key: user.id
      description: User who issued the certificate
      
    - name: achievement_date
      type: date
      description: Date requirements were met
      
    - name: issue_reason
      type: enum
      values: [course_completion, exam_passed, requirements_met, manual_grant, transfer, reinstatement]
      default: requirements_met
      description: Reason for issuance

    # Validity Period
    - name: valid_from
      type: date
      required: true
      indexed: true
      description: Start of validity period
      
    - name: valid_until
      type: date
      indexed: true
      description: End of validity period (null if lifetime)
      
    - name: is_lifetime
      type: boolean
      default: false
      description: Certificate never expires
      
    - name: expiration_type
      type: enum
      values: [fixed_date, from_issue, from_achievement, calendar_year, never]
      default: from_issue
      description: How expiration is calculated
      
    - name: validity_months
      type: integer
      description: Validity duration in months

    # Verification
    - name: verification_code
      type: string
      length: 12
      unique: true
      indexed: true
      description: Unique URL-safe verification code
      
    - name: verification_url
      type: string
      max_length: 500
      description: Public verification URL
      
    - name: qr_code_url
      type: string
      max_length: 500
      description: URL to QR code image
      
    - name: blockchain_tx_hash
      type: string
      max_length: 100
      indexed: true
      description: Blockchain transaction hash for anchoring
      
    - name: blockchain_network
      type: string
      description: Blockchain network used
      
    - name: digital_signature
      type: text
      description: PKI digital signature

    # Content
    - name: recipient_name
      type: string
      max_length: 200
      required: true
      description: Name as displayed on certificate
      
    - name: title
      type: string
      max_length: 200
      description: Certificate title
      
    - name: description
      type: text
      description: Achievement description
      
    - name: skills_certified
      type: array
      items: uuid
      description: List of certified skill IDs
      
    - name: grade
      type: string
      max_length: 50
      description: Grade achieved (if applicable)
      
    - name: score
      type: decimal
      precision: 5
      scale: 2
      description: Score achieved (if applicable)
      
    - name: honors
      type: string
      max_length: 100
      description: Honors designation (cum laude, etc.)

    # Digital Assets
    - name: pdf_url
      type: string
      max_length: 500
      description: URL to PDF certificate
      
    - name: image_url
      type: string
      max_length: 500
      description: URL to certificate image
      
    - name: thumbnail_url
      type: string
      max_length: 500
      description: URL to thumbnail image
      
    - name: metadata_url
      type: string
      max_length: 500
      description: URL to JSON-LD metadata

    # Renewal
    - name: is_renewable
      type: boolean
      default: true
      description: Can be renewed
      
    - name: renewal_deadline
      type: date
      indexed: true
      description: Deadline for renewal
      
    - name: renewal_count
      type: integer
      default: 0
      description: Number of times renewed
      
    - name: previous_certificate_id
      type: uuid
      foreign_key: certificate.id
      description: Previous certificate if renewed
      
    - name: ceu_required
      type: decimal
      precision: 5
      scale: 2
      description: CEUs required for renewal
      
    - name: ceu_earned
      type: decimal
      precision: 5
      scale: 2
      default: 0
      description: CEUs earned toward renewal

    # Sharing
    - name: public_url
      type: string
      max_length: 500
      description: Public shareable URL
      
    - name: linkedin_share_url
      type: string
      max_length: 500
      description: LinkedIn add-to-profile URL
      
    - name: is_public
      type: boolean
      default: false
      description: Visible in public verification
      
    - name: share_settings
      type: jsonb
      description: Granular sharing preferences

    # Metadata
    - name: metadata
      type: jsonb
      description: Additional metadata
      
    - name: tags
      type: array
      items: string
      description: Searchable tags
      
    - name: created_at
      type: timestamp
      auto: true
      description: Record creation timestamp
      
    - name: updated_at
      type: timestamp
      auto: true
      description: Last update timestamp

  computed_fields:
    - name: days_until_expiry
      formula: "DATEDIFF(valid_until, CURRENT_DATE)"
      description: Days remaining until expiration
      
    - name: is_expired
      formula: "valid_until IS NOT NULL AND valid_until < CURRENT_DATE"
      description: Whether certificate has expired
      
    - name: is_valid
      formula: "status = 'active' AND (is_lifetime OR valid_until >= CURRENT_DATE)"
      description: Whether certificate is currently valid
      
    - name: ceu_progress_percent
      formula: "(ceu_earned / ceu_required) * 100"
      description: Percentage of CEUs earned

  state_machine:
    field: status
    initial: pending
    transitions:
      - from: pending
        to: issued
        event: issue
        
      - from: issued
        to: active
        event: activate
        
      - from: active
        to: expired
        event: expire
        condition: "valid_until < CURRENT_DATE AND NOT is_lifetime"
        
      - from: active
        to: revoked
        event: revoke
        
      - from: active
        to: suspended
        event: suspend
        
      - from: suspended
        to: active
        event: reinstate
        
      - from: expired
        to: renewed
        event: renew
        
      - from: renewed
        to: active
        event: activate
        note: Links to new certificate

  relationships:
    - name: program
      type: belongs_to
      entity: certification_program
      foreign_key: program_id
      
    - name: holder
      type: belongs_to
      entity: credential_holder
      foreign_key: holder_id
      
    - name: template
      type: belongs_to
      entity: certificate_template
      foreign_key: template_id
      
    - name: renewals
      type: has_many
      entity: renewal
      foreign_key: certificate_id
      
    - name: ceu_records
      type: has_many
      entity: ceu_record
      through: holder_id
      
    - name: verifications
      type: has_many
      entity: verification_record
      foreign_key: certificate_id
      
    - name: revocation
      type: has_one
      entity: revocation
      foreign_key: certificate_id
      
    - name: endorsements
      type: has_many
      entity: endorsement
      foreign_key: certificate_id
      
    - name: previous_certificate
      type: belongs_to
      entity: certificate
      foreign_key: previous_certificate_id
      
    - name: renewed_certificate
      type: has_one
      entity: certificate
      foreign_key: previous_certificate_id

  indexes:
    - fields: [holder_id, program_id]
      unique: false
      name: idx_holder_program
      
    - fields: [status, valid_until]
      name: idx_status_expiry
      
    - fields: [verification_code]
      unique: true
      name: idx_verification_code
      
    - fields: [certificate_number]
      unique: true
      name: idx_certificate_number

  validations:
    - field: certificate_number
      rule: unique
      scope: [program_id]
      message: Certificate number must be unique within program
      
    - field: valid_until
      rule: "valid_until >= valid_from"
      when: "valid_until IS NOT NULL"
      message: Valid until must be after valid from
      
    - field: recipient_name
      rule: required
      message: Recipient name is required

  audit:
    enabled: true
    track_changes: true
    retention_years: 10
