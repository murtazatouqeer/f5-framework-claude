# Renewal Entity
# F5 Framework v2.0 - Education/Certification
# Certificate renewal process tracking

entity:
  id: renewal
  name: Renewal
  name_ja: 更新
  domain: education
  subdomain: certification
  version: "1.0.0"
  
  description: |
    Tracks the renewal process for expiring certificates, including
    CEU verification, fee payment, exam requirements, and approval workflow.

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true
      
    - name: renewal_id
      type: string
      format: "RNW-{XXXXXXXX}"
      unique: true
      indexed: true

    # References
    - name: certificate_id
      type: uuid
      foreign_key: certificate.id
      required: true
      indexed: true
      
    - name: holder_id
      type: uuid
      foreign_key: credential_holder.id
      required: true
      indexed: true
      
    - name: program_id
      type: uuid
      foreign_key: certification_program.id
      required: true
      indexed: true

    # Status
    - name: status
      type: enum
      values: [initiated, in_progress, submitted, under_review, approved, denied, cancelled, expired]
      default: initiated
      indexed: true

    # Period
    - name: renewal_period_start
      type: date
      required: true
      description: Start of current certification period
      
    - name: renewal_period_end
      type: date
      required: true
      description: End of current certification period
      
    - name: deadline
      type: date
      required: true
      indexed: true
      description: Renewal deadline (includes grace period)
      
    - name: is_late
      type: boolean
      default: false
      description: Submitted after expiration

    # CEU Requirements
    - name: ceu_required
      type: decimal
      precision: 5
      scale: 2
      required: true
      
    - name: ceu_submitted
      type: decimal
      precision: 5
      scale: 2
      default: 0
      
    - name: ceu_approved
      type: decimal
      precision: 5
      scale: 2
      default: 0
      
    - name: ceu_records
      type: array
      items: uuid
      description: Submitted CEU record IDs
      
    - name: ceu_met
      type: boolean
      default: false
      description: CEU requirement satisfied

    # Exam Requirements
    - name: exam_required
      type: boolean
      default: false
      
    - name: exam_id
      type: uuid
      foreign_key: exam.id
      
    - name: exam_attempt_id
      type: uuid
      foreign_key: exam_attempt.id
      
    - name: exam_passed
      type: boolean
      
    - name: exam_score
      type: decimal
      precision: 5
      scale: 2

    # Fee
    - name: fee_amount
      type: decimal
      precision: 10
      scale: 2
      description: Total renewal fee
      
    - name: late_fee
      type: decimal
      precision: 10
      scale: 2
      default: 0
      
    - name: total_fee
      type: decimal
      precision: 10
      scale: 2
      description: Fee + late fee
      
    - name: fee_paid
      type: boolean
      default: false
      
    - name: payment_id
      type: uuid
      foreign_key: payment.id
      
    - name: paid_at
      type: timestamp

    # Submission
    - name: initiated_at
      type: timestamp
      indexed: true
      
    - name: submitted_at
      type: timestamp
      indexed: true
      
    - name: supporting_documents
      type: jsonb
      description: Uploaded documentation
      schema:
        - document_type: string
          file_url: string
          uploaded_at: timestamp

    # Review
    - name: reviewed_by
      type: uuid
      foreign_key: user.id
      
    - name: reviewed_at
      type: timestamp
      
    - name: review_notes
      type: text
      
    - name: denial_reason
      type: text
      
    - name: denial_code
      type: string
      max_length: 50

    # Result
    - name: approved_at
      type: timestamp
      
    - name: new_certificate_id
      type: uuid
      foreign_key: certificate.id
      description: New certificate if approved
      
    - name: new_valid_from
      type: date
      description: Start of new validity period
      
    - name: new_valid_until
      type: date
      description: End of new validity period

    # Appeals
    - name: appeal_submitted
      type: boolean
      default: false
      
    - name: appeal_notes
      type: text
      
    - name: appeal_reviewed_by
      type: uuid
      foreign_key: user.id
      
    - name: appeal_decision
      type: enum
      values: [pending, approved, denied]

    # Metadata
    - name: reminder_sent
      type: boolean
      default: false
      
    - name: reminder_count
      type: integer
      default: 0
      
    - name: last_reminder_at
      type: timestamp
      
    - name: created_at
      type: timestamp
      auto: true
      
    - name: updated_at
      type: timestamp
      auto: true

  computed_fields:
    - name: days_until_deadline
      formula: "DATEDIFF(deadline, CURRENT_DATE)"
      
    - name: ceu_remaining
      formula: "ceu_required - ceu_approved"
      
    - name: is_complete
      formula: "ceu_met AND (NOT exam_required OR exam_passed) AND fee_paid"

  state_machine:
    field: status
    initial: initiated
    transitions:
      - from: initiated
        to: in_progress
        event: start
        
      - from: in_progress
        to: submitted
        event: submit
        condition: "ceu_submitted >= ceu_required"
        
      - from: submitted
        to: under_review
        event: start_review
        
      - from: under_review
        to: approved
        event: approve
        
      - from: under_review
        to: denied
        event: deny
        
      - from: denied
        to: under_review
        event: appeal
        
      - from: [initiated, in_progress]
        to: cancelled
        event: cancel
        
      - from: [initiated, in_progress]
        to: expired
        event: expire
        condition: "deadline < CURRENT_DATE"

  relationships:
    - name: certificate
      type: belongs_to
      entity: certificate
      foreign_key: certificate_id
      
    - name: holder
      type: belongs_to
      entity: credential_holder
      foreign_key: holder_id
      
    - name: program
      type: belongs_to
      entity: certification_program
      foreign_key: program_id
      
    - name: ceu_record_list
      type: has_many
      entity: ceu_record
      through: ceu_records
      
    - name: new_certificate
      type: belongs_to
      entity: certificate
      foreign_key: new_certificate_id
      
    - name: reviewer
      type: belongs_to
      entity: user
      foreign_key: reviewed_by

  indexes:
    - fields: [holder_id, program_id, renewal_period_end]
      unique: true
      name: idx_holder_program_period
      
    - fields: [status, deadline]
      name: idx_status_deadline

  validations:
    - rule: "new_valid_until > new_valid_from"
      when: "status = 'approved'"
      message: New validity period must be positive
