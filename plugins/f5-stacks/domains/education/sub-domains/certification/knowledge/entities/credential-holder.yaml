# Credential Holder Entity
# F5 Framework v2.0 - Education/Certification
# Individual who earns and holds credentials

entity:
  id: credential_holder
  name: Credential Holder
  name_ja: 資格保持者
  domain: education
  subdomain: certification
  version: "1.0.0"
  
  description: |
    An individual who has earned one or more credentials and maintains
    a portfolio of certificates and badges. Manages their public profile,
    sharing settings, and renewal activities.

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true
      
    - name: holder_id
      type: string
      format: "HLD-{XXXXXXXX}"
      unique: true
      indexed: true
      description: Public holder identifier
      
    - name: user_id
      type: uuid
      foreign_key: user.id
      unique: true
      indexed: true
      description: Associated user account

    # Status
    - name: status
      type: enum
      values: [active, inactive, suspended]
      default: active
      indexed: true

    # Profile
    - name: first_name
      type: string
      max_length: 100
      required: true
      
    - name: last_name
      type: string
      max_length: 100
      required: true
      
    - name: full_name
      type: string
      max_length: 200
      description: Display name on certificates
      
    - name: preferred_name
      type: string
      max_length: 200
      description: Name to use if different from legal
      
    - name: email
      type: string
      max_length: 255
      required: true
      indexed: true
      
    - name: phone
      type: string
      max_length: 50
      
    - name: date_of_birth
      type: date
      description: For identity verification
      
    - name: profile_url
      type: string
      max_length: 500
      description: Public profile page URL
      
    - name: avatar_url
      type: string
      max_length: 500
      
    - name: public_profile_enabled
      type: boolean
      default: true
      description: Allow public portfolio view

    # Professional Info
    - name: title
      type: string
      max_length: 200
      description: Professional title
      
    - name: organization
      type: string
      max_length: 200
      description: Current employer/organization
      
    - name: linkedin_url
      type: string
      max_length: 500
      
    - name: bio
      type: text
      description: Professional biography

    # Identity Verification
    - name: identity_verified
      type: boolean
      default: false
      description: Identity has been verified
      
    - name: verification_method
      type: enum
      values: [id_document, linkedin, email, video, in_person, third_party]
      description: How identity was verified
      
    - name: verified_at
      type: timestamp
      
    - name: verified_by
      type: uuid
      foreign_key: user.id
      
    - name: verification_documents
      type: jsonb
      description: Stored verification evidence

    # Credential Summary
    - name: total_credentials
      type: integer
      default: 0
      description: Total credentials earned
      
    - name: active_credentials
      type: integer
      default: 0
      description: Currently active credentials
      
    - name: expiring_soon
      type: integer
      default: 0
      description: Credentials expiring in 90 days

    # Portfolio
    - name: portfolio_url
      type: string
      max_length: 500
      description: Public credential portfolio URL
      
    - name: portfolio_slug
      type: string
      max_length: 100
      unique: true
      description: Custom URL slug
      
    - name: portfolio_title
      type: string
      max_length: 200
      description: Custom portfolio title
      
    - name: portfolio_description
      type: text
      description: Portfolio intro text
      
    - name: featured_credentials
      type: array
      items: uuid
      description: Highlighted credential IDs

    # Sharing Settings
    - name: share_settings
      type: jsonb
      default: '{}'
      description: Granular sharing preferences
      schema:
        show_scores: boolean
        show_dates: boolean
        show_issuer: boolean
        allow_verification: boolean
        
    - name: default_visibility
      type: enum
      values: [public, unlisted, private]
      default: public

    # CEU Tracking
    - name: total_ceu_earned
      type: decimal
      precision: 10
      scale: 2
      default: 0
      
    - name: ceu_by_program
      type: jsonb
      description: CEU breakdown by program

    # External Connections
    - name: badge_backpack_url
      type: string
      max_length: 500
      description: External badge backpack URL
      
    - name: badge_backpack_email
      type: string
      max_length: 255
      description: Email for badge backpack
      
    - name: external_ids
      type: jsonb
      description: IDs in external systems

    # Preferences
    - name: notification_preferences
      type: jsonb
      default: '{}'
      schema:
        expiration_reminders: boolean
        renewal_reminders: boolean
        new_credentials: boolean
        verification_alerts: boolean
        
    - name: language
      type: string
      length: 5
      default: "en"
      
    - name: timezone
      type: string
      max_length: 50
      default: "UTC"

    # Metadata
    - name: last_activity_at
      type: timestamp
      description: Last profile activity
      
    - name: created_at
      type: timestamp
      auto: true
      
    - name: updated_at
      type: timestamp
      auto: true

  computed_fields:
    - name: display_name
      formula: "COALESCE(preferred_name, full_name, CONCAT(first_name, ' ', last_name))"
      
    - name: credentials_expiring_90_days
      formula: "COUNT(certificates WHERE valid_until BETWEEN NOW() AND NOW() + INTERVAL '90 days')"

  relationships:
    - name: user
      type: belongs_to
      entity: user
      foreign_key: user_id
      
    - name: certificates
      type: has_many
      entity: certificate
      foreign_key: holder_id
      
    - name: badges
      type: has_many
      entity: badge
      foreign_key: holder_id
      
    - name: ceu_records
      type: has_many
      entity: ceu_record
      foreign_key: holder_id
      
    - name: renewals
      type: has_many
      entity: renewal
      foreign_key: holder_id
      
    - name: transcript
      type: has_one
      entity: transcript
      foreign_key: holder_id

  indexes:
    - fields: [email]
      unique: true
      name: idx_holder_email
      
    - fields: [portfolio_slug]
      unique: true
      name: idx_portfolio_slug
      
    - fields: [user_id]
      unique: true
      name: idx_holder_user

  validations:
    - field: email
      rule: email_format
      
    - field: portfolio_slug
      rule: url_safe
      message: Portfolio slug must be URL-safe

  audit:
    enabled: true
    track_changes: true
    pii_fields: [first_name, last_name, email, phone, date_of_birth]
