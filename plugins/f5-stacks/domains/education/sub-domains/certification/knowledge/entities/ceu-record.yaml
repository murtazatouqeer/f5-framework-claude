# CEU Record Entity
# F5 Framework v2.0 - Education/Certification
# Continuing Education Unit tracking

entity:
  id: ceu_record
  name: CEU Record
  name_ja: CEU記録
  domain: education
  subdomain: certification
  version: "1.0.0"
  
  description: |
    Records continuing education activities submitted by credential holders
    toward maintaining their certifications. Tracks various types of
    professional development activities and their credit values.

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true
      
    - name: record_id
      type: string
      format: "CEU-{XXXXXXXX}"
      unique: true
      indexed: true

    # Holder
    - name: holder_id
      type: uuid
      foreign_key: credential_holder.id
      required: true
      indexed: true

    # Type
    - name: record_type
      type: enum
      values: [course, conference, workshop, webinar, self_study, work_experience, publication, teaching, volunteer, research, mentoring, other]
      required: true
      indexed: true

    # Status
    - name: status
      type: enum
      values: [draft, pending, under_review, approved, rejected, expired]
      default: draft
      indexed: true

    # Activity Details
    - name: activity_name
      type: string
      max_length: 300
      required: true
      description: Name of the activity
      
    - name: activity_description
      type: text
      description: Detailed description
      
    - name: provider_name
      type: string
      max_length: 200
      description: Organization providing the activity
      
    - name: provider_id
      type: uuid
      foreign_key: organization.id
      description: If provider is in system
      
    - name: provider_accreditation
      type: string
      max_length: 200
      description: Provider accreditation number

    # Dates
    - name: activity_date
      type: date
      required: true
      indexed: true
      description: Date of activity
      
    - name: completion_date
      type: date
      description: Completion date if multi-day
      
    - name: submission_date
      type: timestamp
      indexed: true

    # Duration
    - name: duration_hours
      type: decimal
      precision: 5
      scale: 2
      description: Activity duration in hours
      
    - name: duration_days
      type: integer
      description: Activity duration in days

    # Credits
    - name: credit_type
      type: enum
      values: [ceu, cpe, pdu, contact_hour, credit_hour, ce, other]
      default: ceu
      description: Type of credit
      
    - name: ceu_claimed
      type: decimal
      precision: 5
      scale: 2
      required: true
      description: Credits claimed by holder
      
    - name: ceu_approved
      type: decimal
      precision: 5
      scale: 2
      default: 0
      description: Credits approved after review
      
    - name: max_allowable
      type: decimal
      precision: 5
      scale: 2
      description: Maximum credits for this type

    # Program Association
    - name: program_id
      type: uuid
      foreign_key: certification_program.id
      indexed: true
      description: Which certification this applies to
      
    - name: renewal_id
      type: uuid
      foreign_key: renewal.id
      indexed: true
      description: Associated renewal

    # Evidence
    - name: certificate_url
      type: string
      max_length: 500
      description: Completion certificate
      
    - name: transcript_url
      type: string
      max_length: 500
      description: Official transcript
      
    - name: evidence_documents
      type: jsonb
      description: Additional evidence
      schema:
        - document_type: string
          file_url: string
          file_name: string
          uploaded_at: timestamp
          
    - name: evidence_notes
      type: text
      description: Description of evidence

    # External Reference
    - name: external_id
      type: string
      max_length: 100
      description: ID from external system
      
    - name: course_id
      type: uuid
      foreign_key: course.id
      description: If from LMS course

    # Review
    - name: reviewed_by
      type: uuid
      foreign_key: user.id
      
    - name: reviewed_at
      type: timestamp
      
    - name: review_notes
      type: text
      
    - name: rejection_reason
      type: text
      
    - name: rejection_code
      type: string
      max_length: 50

    # Auto-Approval
    - name: auto_approved
      type: boolean
      default: false
      description: Automatically approved
      
    - name: auto_approval_rule
      type: string
      max_length: 100
      description: Rule that triggered auto-approval

    # Metadata
    - name: tags
      type: array
      items: string
      
    - name: learning_objectives
      type: array
      items: string
      description: What was learned
      
    - name: created_at
      type: timestamp
      auto: true
      
    - name: updated_at
      type: timestamp
      auto: true

  computed_fields:
    - name: is_approved
      formula: "status = 'approved'"
      
    - name: credits_difference
      formula: "ceu_claimed - ceu_approved"

  state_machine:
    field: status
    initial: draft
    transitions:
      - from: draft
        to: pending
        event: submit
        
      - from: pending
        to: under_review
        event: start_review
        
      - from: pending
        to: approved
        event: auto_approve
        condition: "auto_approval_eligible"
        
      - from: under_review
        to: approved
        event: approve
        
      - from: under_review
        to: rejected
        event: reject
        
      - from: rejected
        to: pending
        event: resubmit

  relationships:
    - name: holder
      type: belongs_to
      entity: credential_holder
      foreign_key: holder_id
      
    - name: program
      type: belongs_to
      entity: certification_program
      foreign_key: program_id
      
    - name: renewal
      type: belongs_to
      entity: renewal
      foreign_key: renewal_id
      
    - name: provider
      type: belongs_to
      entity: organization
      foreign_key: provider_id
      
    - name: reviewer
      type: belongs_to
      entity: user
      foreign_key: reviewed_by
      
    - name: course
      type: belongs_to
      entity: course
      foreign_key: course_id

  indexes:
    - fields: [holder_id, program_id, activity_date]
      name: idx_holder_program_date
      
    - fields: [status, submission_date]
      name: idx_status_submitted

  validations:
    - field: ceu_claimed
      rule: "ceu_claimed > 0"
      message: Credits claimed must be positive
      
    - field: ceu_approved
      rule: "ceu_approved <= ceu_claimed"
      message: Approved credits cannot exceed claimed

  activity_type_limits:
    self_study:
      max_percent: 50
      description: Max 50% of total from self-study
    work_experience:
      max_percent: 25
    other:
      requires_approval: true
