# Credential Verification Workflow
# F5 Framework v2.0 - Education/Certification
# Workflow for verifying certificates and badges

workflow:
  id: credential-verification
  name: Credential Verification Workflow
  name_ja: 資格検証ワークフロー
  domain: education
  subdomain: certification
  version: "1.0.0"
  
  description: |
    Workflow for verifying the authenticity and validity of certificates
    and badges through various methods including public, API, and blockchain.

  triggers:
    - id: public_verification
      name: Public Verification Request
      description: Verification via public URL or code
      event: verification.public.request
      automatic: true
      
    - id: api_verification
      name: API Verification Request
      description: Verification via authenticated API
      event: verification.api.request
      automatic: true
      
    - id: batch_verification
      name: Batch Verification Request
      description: Multiple credentials verified at once
      event: verification.batch.request
      automatic: true

  actors:
    - id: verifier
      name: Verifier
      description: Person or system requesting verification
      
    - id: system
      name: System
      description: Automated verification processes
      
    - id: holder
      name: Credential Holder
      description: Owner of the credential being verified
      
    - id: api_client
      name: API Client
      description: Authenticated API consumer

  states:
    - id: received
      name: Request Received
      name_ja: リクエスト受信
      description: Verification request received
      
    - id: authenticating
      name: Authenticating
      name_ja: 認証中
      description: Validating API credentials if applicable
      
    - id: rate_checking
      name: Rate Check
      name_ja: レート確認
      description: Checking rate limits
      
    - id: retrieving
      name: Retrieving Credential
      name_ja: 資格取得中
      description: Looking up the credential
      
    - id: validating
      name: Validating
      name_ja: 検証中
      description: Checking credential validity
      
    - id: blockchain_verifying
      name: Blockchain Verifying
      name_ja: ブロックチェーン検証中
      description: Verifying against blockchain
      
    - id: formatting
      name: Formatting Response
      name_ja: レスポンス整形
      description: Preparing verification response
      
    - id: completed
      name: Completed
      name_ja: 完了
      description: Verification complete
      
    - id: failed
      name: Failed
      name_ja: 失敗
      description: Verification failed

  transitions:
    - from: received
      to: authenticating
      condition: "verification_type = 'api'"
      action: validate_api_key
      
    - from: received
      to: rate_checking
      condition: "verification_type = 'public'"
      action: check_public_rate_limit
      
    - from: authenticating
      to: rate_checking
      condition: "authentication_passed = true"
      action: check_api_rate_limit
      
    - from: authenticating
      to: failed
      condition: "authentication_passed = false"
      action: return_auth_error
      
    - from: rate_checking
      to: retrieving
      condition: "within_rate_limit = true"
      action: lookup_credential
      
    - from: rate_checking
      to: failed
      condition: "within_rate_limit = false"
      action: return_rate_limit_error
      
    - from: retrieving
      to: validating
      condition: "credential_found = true"
      action: validate_credential
      
    - from: retrieving
      to: completed
      condition: "credential_found = false"
      action: return_not_found
      
    - from: validating
      to: blockchain_verifying
      condition: "credential.blockchain_enabled = true AND include_blockchain = true"
      action: verify_on_blockchain
      
    - from: validating
      to: formatting
      condition: "credential.blockchain_enabled = false OR include_blockchain = false"
      action: format_response
      
    - from: blockchain_verifying
      to: formatting
      action: format_response
      
    - from: formatting
      to: completed
      action: return_result

  steps:
    - step: 1
      name: Receive Verification Request
      name_ja: 検証リクエスト受信
      actor: system
      state: received
      
      input_variants:
        public:
          source: verification_url OR verification_code
          authentication: none
          
        api:
          source: api_endpoint
          authentication: api_key
          headers:
            - X-API-Key: required
            
        batch:
          source: api_endpoint
          authentication: api_key
          body:
            - codes: array of verification codes
            
      actions:
        - parse_request
        - identify_verification_type
        - log_request_receipt
        
      outputs:
        - verification_id
        - verification_type
        - verification_code
        - request_timestamp
        
    - step: 2
      name: Authenticate API Request
      name_ja: APIリクエスト認証
      actor: system
      state: authenticating
      condition: "verification_type IN ('api', 'batch')"
      
      rules_applied:
        - BR-VRF-010  # API authentication
        
      checks:
        - api_key_valid:
            lookup: api_keys
            validate: active AND not_expired
            
        - client_authorized:
            check: client_status = active
            
      outputs:
        - authentication_result: pass/fail
        - client_id
        - client_plan
        
    - step: 3
      name: Check Rate Limits
      name_ja: レート制限確認
      actor: system
      state: rate_checking
      
      rules_applied:
        - BR-VRF-011  # API rate limiting
        
      rate_limits:
        public:
          per_ip_per_minute: 30
          per_ip_per_day: 500
          
        api:
          free:
            per_minute: 10
            per_day: 100
          basic:
            per_minute: 60
            per_day: 1000
          professional:
            per_minute: 300
            per_day: 10000
          enterprise:
            per_minute: 1000
            per_day: unlimited
            
      on_exceeded:
        response:
          status: 429
          message: "Rate limit exceeded"
          retry_after: calculated_seconds
          
      outputs:
        - rate_check_result: pass/fail
        - remaining_requests
        - reset_time
        
    - step: 4
      name: Retrieve Credential
      name_ja: 資格情報取得
      actor: system
      state: retrieving
      
      lookup_methods:
        by_verification_code:
          query: "SELECT * FROM credentials WHERE verification_code = ?"
          
        by_certificate_number:
          query: "SELECT * FROM certificates WHERE certificate_number = ?"
          
        by_badge_assertion_id:
          query: "SELECT * FROM badges WHERE assertion_id = ?"
          
      on_not_found:
        response:
          status: "not_found"
          message: "Credential not found"
          
      outputs:
        - credential_found: boolean
        - credential_data
        - credential_type
        
    - step: 5
      name: Validate Credential
      name_ja: 資格検証
      actor: system
      state: validating
      
      rules_applied:
        - BR-VRF-002  # Display content
        - BR-VRF-003  # Status display
        - BR-VRF-020  # Consent requirement
        
      validations:
        - check_status:
            valid_statuses: [active, expired]
            invalid_statuses: [revoked, suspended, cancelled]
            
        - check_expiration:
            compare: valid_until >= CURRENT_DATE OR valid_until IS NULL
            
        - check_signature:
            condition: "has_digital_signature = true"
            action: verify_pki_signature
            
        - check_privacy_consent:
            lookup: holder_privacy_settings
            apply: visibility_rules
            
      outputs:
        - validation_result
        - credential_status
        - visible_fields
        - privacy_restrictions
        
    - step: 6
      name: Blockchain Verification
      name_ja: ブロックチェーン検証
      actor: system
      state: blockchain_verifying
      condition: "credential.blockchain_enabled = true AND include_blockchain = true"
      
      rules_applied:
        - BR-VRF-030  # Blockchain anchoring
        - BR-VRF-031  # Blockchain verification
        - BR-VRF-032  # Tamper detection
        
      sub_steps:
        - compute_expected_hash:
            algorithm: SHA-256
            data:
              - certificate_id
              - holder_id
              - program_id
              - issued_at
              - certificate_number
              
        - retrieve_blockchain_record:
            network: credential.blockchain_network
            transaction_hash: credential.blockchain_tx_hash
            
        - compare_hashes:
            expected: computed_hash
            actual: blockchain_stored_hash
            
        - verify_chain_integrity:
            check: transaction_confirmed
            min_confirmations: 6
            
      on_mismatch:
        action: flag_potential_tampering
        alert: security_team
        
      outputs:
        - blockchain_verified: boolean
        - blockchain_proof:
            transaction_hash: string
            block_number: number
            verified_at: timestamp
            
    - step: 7
      name: Format Verification Response
      name_ja: 検証レスポンス整形
      actor: system
      state: formatting
      
      rules_applied:
        - BR-VRF-012  # API response format
        
      response_content:
        always_include:
          - verification_status
          - verification_timestamp
          - credential_type
          
        if_valid:
          - holder_display_name
          - program_name
          - issuing_organization
          - issued_at
          - valid_until
          - current_status
          
        optional_if_consented:
          - skills
          - score
          - badge_image
          
        blockchain_proof:
          condition: "blockchain_verified = true"
          include:
            - transaction_hash
            - block_number
            - verified_at
            
      outputs:
        - formatted_response
        
    - step: 8
      name: Complete Verification
      name_ja: 検証完了
      actor: system
      state: completed
      
      rules_applied:
        - BR-VRF-021  # Verification logging
        - BR-VRF-060  # Audit trail
        
      actions:
        - log_verification:
            verification_id: generated
            credential_id: verified
            verification_method: public/api/batch
            verification_result: status
            verifier_info: anonymized
            
        - update_statistics:
            increment: total_verifications
            
        - check_notification_settings:
            if: holder.notify_on_verification
            action: send_notification
            
      notification:
        condition: "holder.notify_api_verifications = true AND verification_type = 'api'"
        to: holder
        template: credential_verified
        include:
          - verification_timestamp
          - verifier_organization
          - credential_verified
          
      outputs:
        - final_response
        - verification_record_id

  error_handling:
    - error: authentication_failed
      response:
        status: 401
        error_code: "AUTH_FAILED"
        message: "Invalid or missing API key"
        
    - error: rate_limit_exceeded
      response:
        status: 429
        error_code: "RATE_LIMITED"
        message: "Too many requests"
        retry_after: calculated_seconds
        
    - error: credential_not_found
      response:
        status: 404
        error_code: "NOT_FOUND"
        message: "Credential not found"
        
    - error: blockchain_verification_failed
      action: return_result_without_blockchain
      include_warning: true
      
    - error: internal_error
      response:
        status: 500
        error_code: "INTERNAL_ERROR"
        message: "Verification service temporarily unavailable"
      action: alert_operations

  batch_processing:
    enabled: true
    max_batch_size:
      basic: 10
      professional: 50
      enterprise: 200
      
    response_format:
      summary:
        total: count
        valid: count
        invalid: count
        not_found: count
      results:
        - code: verification_code
          status: result_status
          credential: credential_summary_if_valid

  metrics:
    - name: verification_latency
      description: Time to complete verification
      target: "< 200ms for cached, < 500ms for blockchain"
      
    - name: success_rate
      description: Percentage of successful verifications
      target: "> 99%"
      
    - name: cache_hit_rate
      description: Percentage of requests served from cache
      target: "> 80%"

  caching:
    enabled: true
    cache_duration_minutes: 5
    cache_key: "verification:{credential_type}:{verification_code}"
    invalidate_on:
      - credential_status_change
      - credential_revocation
      - credential_suspension

  audit:
    enabled: true
    track_all_verifications: true
    anonymize_verifiers: true
    retention_years: 7
