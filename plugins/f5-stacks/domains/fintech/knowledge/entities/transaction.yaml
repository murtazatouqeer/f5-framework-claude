name: Transaction
display_name: Transaction
description: |
  Represents a financial activity that changes account balance.
  Includes: deposits, withdrawals, transfers, payments, and other transaction types.
  Each transaction is recorded with complete information for traceability and reconciliation.

domain: fintech
category: core

attributes:
  - name: id
    type: uuid
    required: true
    description: Unique identifier of the transaction in the system

  - name: transaction_code
    type: string
    required: true
    description: Transaction code displayed to customer (readable, easy to lookup)
    validation:
      pattern: "^TXN[0-9]{12}$"

  - name: reference_number
    type: string
    required: false
    description: Reference code from external system (NAPAS, partners, etc.)
    validation:
      max: 50

  - name: transaction_type
    type: enum
    required: true
    description: Transaction type
    validation:
      values:
        - deposit           # Deposit
        - withdrawal        # Withdrawal
        - internal_transfer # Internal transfer
        - interbank_transfer # Interbank transfer
        - payment           # Bill/service payment
        - purchase          # Purchase
        - refund            # Refund
        - fee               # Service fee
        - interest          # Interest
        - adjustment        # Adjustment
        - reversal          # Transaction reversal

  - name: direction
    type: enum
    required: true
    description: Transaction direction from source account perspective
    validation:
      values: [debit, credit]

  - name: status
    type: enum
    required: true
    description: Transaction processing status
    validation:
      values:
        - pending           # Awaiting processing
        - processing        # Processing
        - completed         # Completed
        - failed            # Failed
        - cancelled         # Cancelled
        - reversed          # Reversed
        - on_hold           # On hold (awaiting approval)

  - name: amount
    type: decimal
    required: true
    description: Transaction amount (always positive)
    validation:
      min: 0.01

  - name: currency
    type: string
    required: true
    description: Transaction currency (ISO 4217)
    validation:
      pattern: "^[A-Z]{3}$"
    default: "VND"

  - name: fee_amount
    type: decimal
    required: true
    description: Transaction fee (if applicable)
    validation:
      min: 0
    default: 0

  - name: fee_currency
    type: string
    required: false
    description: Fee currency (usually same as currency)
    validation:
      pattern: "^[A-Z]{3}$"

  - name: total_amount
    type: decimal
    required: true
    description: Total amount (amount + fee for debit, amount for credit)
    validation:
      min: 0

  - name: exchange_rate
    type: decimal
    required: false
    description: Applied exchange rate (for foreign currency transactions)
    validation:
      min: 0

  - name: balance_before
    type: decimal
    required: true
    description: Balance before transaction

  - name: balance_after
    type: decimal
    required: true
    description: Balance after transaction

  - name: description
    type: string
    required: true
    description: Transaction content/description
    validation:
      max: 500

  - name: memo
    type: string
    required: false
    description: Internal notes (not displayed to customer)
    validation:
      max: 500

  # Source Account Info
  - name: source_account_id
    type: uuid
    required: true
    description: Source account ID

  - name: source_account_number
    type: string
    required: true
    description: Source account number

  - name: source_account_name
    type: string
    required: true
    description: Source account holder name

  # Destination Account Info (for transfers)
  - name: destination_account_id
    type: uuid
    required: false
    description: Destination account ID (for internal transfers)

  - name: destination_account_number
    type: string
    required: false
    description: Destination account number

  - name: destination_account_name
    type: string
    required: false
    description: Destination account holder name

  - name: destination_bank_code
    type: string
    required: false
    description: Destination bank code (for interbank transfers)
    validation:
      pattern: "^[A-Z0-9]{3,11}$"

  - name: destination_bank_name
    type: string
    required: false
    description: Destination bank name

  # Channel & Device Info
  - name: channel
    type: enum
    required: true
    description: Transaction channel
    validation:
      values:
        - mobile_app
        - web_app
        - atm
        - pos
        - branch
        - api
        - auto

  - name: device_id
    type: string
    required: false
    description: Device ID that performed the transaction
    validation:
      max: 100

  - name: ip_address
    type: string
    required: false
    description: IP address of the user
    validation:
      pattern: "^[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}$|^[0-9a-fA-F:]+$"

  - name: location
    type: object
    required: false
    description: Transaction location (if available)
    nested:
      - name: latitude
        type: decimal
      - name: longitude
        type: decimal
      - name: address
        type: string

  # Risk & Compliance
  - name: risk_score
    type: integer
    required: false
    description: Transaction risk score (0-100)
    validation:
      min: 0
      max: 100

  - name: risk_flags
    type: array
    required: false
    description: Flagged risk indicators
    items:
      type: string

  - name: aml_checked
    type: boolean
    required: true
    description: Whether AML check was performed
    default: false

  - name: aml_result
    type: enum
    required: false
    description: AML check result
    validation:
      values: [passed, flagged, blocked]

  - name: requires_approval
    type: boolean
    required: true
    description: Whether transaction requires approval
    default: false

  - name: approved_by
    type: uuid
    required: false
    description: Approver ID (if applicable)

  - name: approved_at
    type: timestamp
    required: false
    description: Approval timestamp

  # Timestamps
  - name: initiated_at
    type: timestamp
    required: true
    description: Transaction initiation timestamp

  - name: processed_at
    type: timestamp
    required: false
    description: Transaction processing timestamp

  - name: completed_at
    type: timestamp
    required: false
    description: Transaction completion timestamp

  - name: created_at
    type: timestamp
    required: true
    description: Record creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

  # Related Transactions
  - name: parent_transaction_id
    type: uuid
    required: false
    description: Parent transaction ID (for reversal, refund)

  - name: batch_id
    type: uuid
    required: false
    description: Batch ID (for batch transactions)

relationships:
  - name: source_account
    type: belongs_to
    entity: Account
    required: true
    description: Account performing the transaction

  - name: destination_account
    type: belongs_to
    entity: Account
    required: false
    description: Destination account (internal transfers)

  - name: customer
    type: belongs_to
    entity: Customer
    required: true
    description: Customer performing the transaction

  - name: parent_transaction
    type: belongs_to
    entity: Transaction
    required: false
    description: Parent transaction (for reversal)

  - name: child_transactions
    type: has_many
    entity: Transaction
    required: false
    description: Dependent transactions

  - name: hold
    type: belongs_to
    entity: Hold
    required: false
    description: Related hold amount

state_machine:
  initial: pending
  states:
    - name: pending
      description: Transaction awaiting processing
    - name: processing
      description: Transaction is being processed
    - name: on_hold
      description: Transaction on hold awaiting approval
    - name: completed
      description: Transaction completed successfully
    - name: failed
      description: Transaction failed
    - name: cancelled
      description: Transaction cancelled
    - name: reversed
      description: Transaction has been reversed
  transitions:
    - from: pending
      to: processing
      trigger: start_processing
      description: Start processing transaction
    - from: pending
      to: on_hold
      trigger: hold_for_approval
      description: Hold for approval
    - from: pending
      to: cancelled
      trigger: cancel
      description: Cancel transaction
    - from: processing
      to: completed
      trigger: complete
      description: Complete successfully
    - from: processing
      to: failed
      trigger: fail
      description: Processing failed
    - from: on_hold
      to: processing
      trigger: approve
      description: Approve and continue processing
    - from: on_hold
      to: cancelled
      trigger: reject
      description: Reject transaction
    - from: completed
      to: reversed
      trigger: reverse
      description: Reverse completed transaction

indexes:
  - [transaction_code]
  - [reference_number]
  - [source_account_id, initiated_at]
  - [destination_account_id]
  - [status, transaction_type]
  - [initiated_at]
  - [completed_at]
  - [channel]
  - [risk_score]
  - [aml_result]

business_rules:
  - BR-TXN-001: Available balance must be >= total transaction amount
  - BR-TXN-002: Transaction must be within daily/monthly limits
  - BR-TXN-003: Transactions > 500 million must undergo AML check
  - BR-TXN-004: Cash transactions > 300 million must file CTR
  - BR-TXN-005: Transactions to high-risk countries require approval
  - BR-TXN-006: Transactions outside business hours may be limited
  - BR-TXN-007: Cannot reverse an already reversed transaction
  - BR-TXN-008: Failed transactions must refund balance within 5 minutes
  - BR-TXN-009: Each transaction must have a unique reference code
  - BR-TXN-010: Velocity check - max 10 transactions/hour from same account
