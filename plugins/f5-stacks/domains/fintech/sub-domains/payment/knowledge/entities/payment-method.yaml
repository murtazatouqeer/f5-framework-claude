# Payment Method Entity - Saved payment instruments
# Domain: fintech/payment
# PCI-DSS Compliant - Card data tokenized

name: PaymentMethod
display_name: Payment Method
description: |
  Represents a saved payment instrument that can be reused for future payments.
  Supports cards, bank accounts, and e-wallets. All sensitive data is tokenized
  and never stored in raw form per PCI-DSS requirements.

  Vietnamese: Phương thức thanh toán đã lưu - thẻ, tài khoản ngân hàng, ví điện tử.
  Dữ liệu nhạy cảm được mã hóa token, không lưu trực tiếp.

domain: fintech
sub_domain: payment
category: core

attributes:
  # Identifiers
  - name: id
    type: uuid
    required: true
    description: Unique identifier

  - name: payment_method_id
    type: string
    required: true
    description: External ID for API reference (PM-XXXXXXXX)
    validation:
      pattern: "^PM-[A-Z0-9]{8}$"

  - name: customer_id
    type: uuid
    required: true
    description: Owner of this payment method

  # Type
  - name: type
    type: enum
    required: true
    description: Payment method type (Loại phương thức)
    validation:
      values: [card, bank_account, e_wallet]

  - name: status
    type: enum
    required: true
    description: Current status of payment method
    validation:
      values: [active, expired, revoked, verification_pending]

  - name: is_default
    type: boolean
    required: true
    description: Default payment method for this type
    default: false

  # ============ CARD SPECIFIC ============
  - name: card_brand
    type: enum
    required: false
    description: Card brand/network (Thương hiệu thẻ)
    validation:
      values: [visa, mastercard, jcb, amex, unionpay, discover, diners]

  - name: card_last4
    type: string
    required: false
    description: Last 4 digits of card number (4 số cuối)
    validation:
      pattern: "^[0-9]{4}$"

  - name: card_exp_month
    type: integer
    required: false
    description: Card expiration month (1-12)
    validation:
      min: 1
      max: 12

  - name: card_exp_year
    type: integer
    required: false
    description: Card expiration year (YYYY)
    validation:
      min: 2024
      max: 2100

  - name: card_fingerprint
    type: string
    required: false
    description: Unique card fingerprint for duplicate detection
    validation:
      max: 64

  - name: card_funding
    type: enum
    required: false
    description: Card funding type (Loại quỹ thẻ)
    validation:
      values: [credit, debit, prepaid, unknown]

  - name: card_issuer
    type: string
    required: false
    description: Issuing bank name
    validation:
      max: 100

  - name: card_issuer_country
    type: string
    required: false
    description: Card issuing country (ISO 3166-1 alpha-2)
    validation:
      pattern: "^[A-Z]{2}$"

  - name: card_3ds_supported
    type: boolean
    required: false
    description: Whether card supports 3D Secure
    default: true

  - name: card_token
    type: string
    required: false
    description: Tokenized card data from vault
    validation:
      max: 255

  - name: card_network_token
    type: string
    required: false
    description: Network token for card-on-file transactions
    validation:
      max: 255

  # ============ BANK ACCOUNT SPECIFIC ============
  - name: bank_code
    type: string
    required: false
    description: Bank code (SWIFT/BIC or local code)
    validation:
      max: 20

  - name: bank_name
    type: string
    required: false
    description: Bank name (Tên ngân hàng)
    validation:
      max: 100

  - name: account_number_last4
    type: string
    required: false
    description: Last 4 digits of account number
    validation:
      pattern: "^[0-9]{4}$"

  - name: account_holder_name
    type: string
    required: false
    description: Account holder name (Tên chủ tài khoản)
    validation:
      max: 100

  - name: account_type
    type: enum
    required: false
    description: Bank account type
    validation:
      values: [checking, savings, current]

  - name: bank_branch
    type: string
    required: false
    description: Bank branch name/code
    validation:
      max: 100

  - name: bank_token
    type: string
    required: false
    description: Tokenized bank account data
    validation:
      max: 255

  # ============ E-WALLET SPECIFIC ============
  - name: wallet_type
    type: enum
    required: false
    description: E-wallet provider (Loại ví điện tử)
    validation:
      values: [momo, zalopay, vnpay, viettelpay, shopeepay, paypal, applepay, googlepay]

  - name: wallet_id
    type: string
    required: false
    description: Wallet user ID or identifier
    validation:
      max: 100

  - name: wallet_phone_last4
    type: string
    required: false
    description: Last 4 digits of registered phone
    validation:
      pattern: "^[0-9]{4}$"

  - name: wallet_email
    type: string
    required: false
    description: Email associated with wallet
    validation:
      pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"

  - name: wallet_token
    type: string
    required: false
    description: Tokenized wallet credentials
    validation:
      max: 255

  # ============ COMMON FIELDS ============
  - name: billing_address
    type: json
    required: false
    description: |
      Associated billing address:
      - line1, line2, city, state, postal_code, country

  - name: nickname
    type: string
    required: false
    description: Customer-set nickname (e.g., "My Visa")
    validation:
      max: 50

  - name: verification_status
    type: enum
    required: true
    description: Verification status of payment method
    validation:
      values: [unverified, pending, verified, failed]
    default: unverified

  - name: verified_at
    type: timestamp
    required: false
    description: When payment method was verified

  # Usage tracking
  - name: usage_count
    type: integer
    required: true
    description: Number of times used successfully
    default: 0

  - name: last_used_at
    type: timestamp
    required: false
    description: Last successful use timestamp

  - name: first_used_at
    type: timestamp
    required: false
    description: First use timestamp

  # Auto-update
  - name: auto_update_enabled
    type: boolean
    required: true
    description: Enable network updates for expired cards
    default: true

  - name: last_auto_update_at
    type: timestamp
    required: false
    description: Last network update timestamp

  # Timestamps
  - name: created_at
    type: timestamp
    required: true
    description: Record creation time

  - name: updated_at
    type: timestamp
    required: true
    description: Last update time

  - name: expires_at
    type: timestamp
    required: false
    description: When payment method expires

  - name: revoked_at
    type: timestamp
    required: false
    description: When payment method was revoked

relationships:
  - name: customer
    type: belongs_to
    entity: Customer
    required: true
    description: Owner of this payment method

  - name: payments
    type: has_many
    entity: Payment
    required: false
    description: Payments made with this method

state_machine:
  initial: verification_pending
  states:
    - name: verification_pending
      description: Awaiting verification (Chờ xác minh)
    - name: active
      description: Active and usable (Đang hoạt động)
    - name: expired
      description: Card/method expired (Đã hết hạn)
    - name: revoked
      description: Revoked by customer or system (Đã thu hồi)

  transitions:
    - from: verification_pending
      to: active
      trigger: verify
      description: Verification successful

    - from: verification_pending
      to: revoked
      trigger: verification_failed
      description: Verification failed

    - from: active
      to: expired
      trigger: expire
      description: Payment method expired

    - from: active
      to: revoked
      trigger: revoke
      description: Customer or system revoked

    - from: expired
      to: active
      trigger: update_expiry
      description: Expiry updated via network

indexes:
  - [payment_method_id]
  - [customer_id, type, is_default]
  - [customer_id, status]
  - [card_fingerprint]
  - [type, status]

events:
  - name: payment_method.created
    description: New payment method saved
    payload: [id, payment_method_id, customer_id, type]

  - name: payment_method.verified
    description: Payment method verified
    payload: [id, payment_method_id, verification_status]

  - name: payment_method.updated
    description: Payment method updated (e.g., expiry)
    payload: [id, payment_method_id, updated_fields]

  - name: payment_method.expired
    description: Payment method expired
    payload: [id, payment_method_id, type]

  - name: payment_method.revoked
    description: Payment method revoked
    payload: [id, payment_method_id, reason]

  - name: payment_method.used
    description: Payment method used for transaction
    payload: [id, payment_method_id, payment_id]

business_rules:
  - id: BR-PMT-001
    description: Card data must be tokenized, never stored raw
    rule: card_token IS NOT NULL AND raw_pan NOT EXISTS
    vietnamese: Dữ liệu thẻ phải được tokenize, không lưu trực tiếp

  - id: BR-PMT-002
    description: Expired cards auto-updated via network Account Updater
    rule: |
      IF card_exp < current_date AND auto_update_enabled = true
      THEN attempt_network_update()
    vietnamese: Thẻ hết hạn được tự động cập nhật qua network

  - id: BR-PMT-003
    description: Only one default payment method per type per customer
    rule: |
      FOR EACH type: COUNT(is_default = true AND customer_id = X) <= 1
    vietnamese: Chỉ 1 phương thức mặc định cho mỗi loại

  - id: BR-PMT-004
    description: Bank accounts require micro-deposit verification
    rule: |
      IF type = 'bank_account'
      THEN verification_method = 'micro_deposit' OR 'instant_verification'
    vietnamese: Tài khoản ngân hàng cần xác minh tiền gửi nhỏ

  - id: BR-PMT-005
    description: Revoked payment methods cannot be reactivated
    rule: |
      IF status = 'revoked'
      THEN transitions_to_active = false
    vietnamese: Phương thức đã thu hồi không thể kích hoạt lại

  - id: BR-PMT-006
    description: Card fingerprint prevents duplicate cards
    rule: |
      UNIQUE(customer_id, card_fingerprint) WHERE status = 'active'
    vietnamese: Fingerprint ngăn thẻ trùng lặp

api_endpoints:
  - method: POST
    path: /v1/payment-methods
    description: Create/save a new payment method

  - method: GET
    path: /v1/payment-methods/{id}
    description: Retrieve payment method details

  - method: POST
    path: /v1/payment-methods/{id}/verify
    description: Verify a payment method

  - method: DELETE
    path: /v1/payment-methods/{id}
    description: Revoke a payment method

  - method: GET
    path: /v1/customers/{customer_id}/payment-methods
    description: List customer's payment methods

security_considerations:
  - Never return full card number or CVV
  - Tokenize all sensitive data before storage
  - Encrypt tokens at rest with AES-256
  - Rate limit payment method creation
  - Require re-authentication for default change
  - Log all access to payment method data
