# Merchant Entity - Business receiving payments
# Domain: fintech/payment
# KYC/AML Compliant

name: Merchant
display_name: Merchant
description: |
  Represents a business entity that receives payments through the platform.
  Includes business verification, fee configuration, and payout settings.
  Subject to KYC (Know Your Customer) and AML (Anti-Money Laundering) requirements.

  Vietnamese: Đại diện cho doanh nghiệp nhận thanh toán qua nền tảng.
  Bao gồm xác minh kinh doanh, cấu hình phí và cài đặt thanh toán.

domain: fintech
sub_domain: payment
category: core

attributes:
  # Identifiers
  - name: id
    type: uuid
    required: true
    description: Unique identifier

  - name: merchant_id
    type: string
    required: true
    description: External merchant ID (MER-XXXXXX)
    validation:
      pattern: "^MER-[A-Z0-9]{6}$"

  # Business Information
  - name: business_name
    type: string
    required: true
    description: Legal business name (Tên doanh nghiệp)
    validation:
      max: 200

  - name: display_name
    type: string
    required: true
    description: Display name shown to customers
    validation:
      max: 100

  - name: business_type
    type: enum
    required: true
    description: Type of business entity
    validation:
      values: [individual, sole_proprietorship, partnership, llc, corporation, non_profit, government]

  - name: business_category
    type: enum
    required: true
    description: Business category (Loại hình kinh doanh)
    validation:
      values: [retail, food_beverage, services, digital_goods, travel, healthcare, education, entertainment, other]

  - name: mcc_code
    type: string
    required: true
    description: Merchant Category Code (4 digits)
    validation:
      pattern: "^[0-9]{4}$"

  # Status
  - name: status
    type: enum
    required: true
    description: Merchant account status (Trạng thái)
    validation:
      values: [pending, active, suspended, under_review, terminated]

  # Contact Information
  - name: email
    type: string
    required: true
    description: Primary contact email
    validation:
      pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"

  - name: phone
    type: string
    required: true
    description: Primary contact phone
    validation:
      pattern: "^\\+?[0-9]{10,15}$"

  - name: support_email
    type: string
    required: false
    description: Customer support email
    validation:
      pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"

  - name: support_phone
    type: string
    required: false
    description: Customer support phone

  - name: website_url
    type: string
    required: false
    description: Business website
    validation:
      max: 500

  # Address
  - name: business_address
    type: json
    required: true
    description: |
      Registered business address:
      - line1, line2, city, state, postal_code, country

  - name: country
    type: string
    required: true
    description: Country of operation (ISO 3166-1 alpha-2)
    validation:
      pattern: "^[A-Z]{2}$"

  - name: timezone
    type: string
    required: true
    description: Business timezone
    default: "Asia/Ho_Chi_Minh"

  # Currency
  - name: default_currency
    type: string
    required: true
    description: Default currency for transactions
    validation:
      pattern: "^[A-Z]{3}$"
    default: "VND"

  - name: supported_currencies
    type: json
    required: true
    description: List of supported currencies
    default: '["VND"]'

  # Legal/Tax Information
  - name: tax_id
    type: string
    required: false
    description: Tax identification number (Mã số thuế)
    validation:
      max: 50

  - name: business_registration_number
    type: string
    required: false
    description: Business registration number (Số đăng ký kinh doanh)
    validation:
      max: 50

  - name: legal_representative
    type: string
    required: false
    description: Legal representative name
    validation:
      max: 100

  # Verification
  - name: verification_status
    type: enum
    required: true
    description: KYC verification status (Trạng thái xác minh)
    validation:
      values: [unverified, pending, document_required, verified, rejected]

  - name: verification_documents
    type: json
    required: false
    description: |
      Submitted documents:
      - business_license, tax_certificate, bank_statement, id_document

  - name: verified_at
    type: timestamp
    required: false
    description: Verification completion timestamp

  - name: verification_notes
    type: string
    required: false
    description: Notes from verification process
    validation:
      max: 1000

  # Risk
  - name: risk_level
    type: enum
    required: true
    description: Risk classification (Mức độ rủi ro)
    validation:
      values: [low, standard, elevated, high]
    default: standard

  - name: risk_score
    type: integer
    required: false
    description: Calculated risk score (0-100)
    validation:
      min: 0
      max: 100

  - name: restricted_categories
    type: json
    required: false
    description: Restricted business categories (if any)

  # Fees
  - name: fee_plan_id
    type: uuid
    required: false
    description: Reference to fee plan

  - name: processing_fee_rate
    type: decimal
    required: true
    description: Processing fee percentage
    default: 2.9

  - name: processing_fee_fixed
    type: decimal
    required: true
    description: Fixed fee per transaction
    default: 2000

  - name: international_fee_rate
    type: decimal
    required: true
    description: Additional fee for international cards
    default: 1.0

  - name: dispute_fee
    type: decimal
    required: true
    description: Fee per dispute/chargeback
    default: 300000

  # Payout Settings
  - name: payout_schedule
    type: enum
    required: true
    description: Payout frequency (Tần suất thanh toán)
    validation:
      values: [daily, weekly, biweekly, monthly, manual]
    default: daily

  - name: payout_delay_days
    type: integer
    required: true
    description: Days before funds available (T+N)
    default: 2

  - name: minimum_payout_amount
    type: decimal
    required: true
    description: Minimum payout threshold
    default: 100000

  - name: payout_currency
    type: string
    required: true
    description: Currency for payouts
    validation:
      pattern: "^[A-Z]{3}$"
    default: "VND"

  # Reserve
  - name: reserve_rate
    type: decimal
    required: true
    description: Reserve percentage (for high-risk)
    default: 0

  - name: reserve_days
    type: integer
    required: true
    description: Reserve holding period (days)
    default: 0

  # Limits
  - name: daily_volume_limit
    type: decimal
    required: false
    description: Maximum daily transaction volume

  - name: monthly_volume_limit
    type: decimal
    required: false
    description: Maximum monthly transaction volume

  - name: single_transaction_limit
    type: decimal
    required: false
    description: Maximum single transaction amount

  # Branding
  - name: branding
    type: json
    required: false
    description: |
      Branding settings:
      - logo_url, icon_url, primary_color, accent_color

  - name: statement_descriptor
    type: string
    required: false
    description: Default statement descriptor
    validation:
      max: 22

  # Integration
  - name: api_key_prefix
    type: string
    required: true
    description: Prefix for API keys
    validation:
      pattern: "^sk_[a-z]+_$"

  - name: webhook_url
    type: string
    required: false
    description: Webhook endpoint URL
    validation:
      max: 500

  - name: webhook_secret
    type: string
    required: false
    description: Webhook signing secret

  # Settings
  - name: settings
    type: json
    required: false
    description: |
      Additional settings:
      - notifications: {email, sms, webhook}
      - checkout: {require_billing, require_shipping}
      - payments: {auto_capture, allowed_methods}

  # Metadata
  - name: metadata
    type: json
    required: false
    description: Custom key-value pairs

  # Timestamps
  - name: created_at
    type: timestamp
    required: true
    description: Account creation time

  - name: updated_at
    type: timestamp
    required: true
    description: Last update time

  - name: activated_at
    type: timestamp
    required: false
    description: Account activation time

  - name: suspended_at
    type: timestamp
    required: false
    description: Suspension timestamp

  - name: terminated_at
    type: timestamp
    required: false
    description: Termination timestamp

relationships:
  - name: merchant_accounts
    type: has_many
    entity: MerchantAccount
    required: false
    description: Bank accounts for payouts

  - name: payments
    type: has_many
    entity: Payment
    required: false
    description: Received payments

  - name: payouts
    type: has_many
    entity: Payout
    required: false
    description: Disbursements

  - name: settlements
    type: has_many
    entity: Settlement
    required: false
    description: Settlement batches

  - name: disputes
    type: has_many
    entity: Dispute
    required: false
    description: Chargebacks and disputes

  - name: api_keys
    type: has_many
    entity: ApiKey
    required: false
    description: API credentials

state_machine:
  initial: pending
  states:
    - name: pending
      description: Application pending review (Chờ xét duyệt)
    - name: active
      description: Account active and operational (Đang hoạt động)
    - name: suspended
      description: Temporarily suspended (Tạm ngưng)
    - name: under_review
      description: Under compliance review (Đang xem xét)
    - name: terminated
      description: Permanently terminated (Đã chấm dứt)

  transitions:
    - from: pending
      to: active
      trigger: approve
      description: Application approved

    - from: pending
      to: terminated
      trigger: reject
      description: Application rejected

    - from: active
      to: suspended
      trigger: suspend
      description: Suspend for violation/issue

    - from: active
      to: under_review
      trigger: flag_for_review
      description: Flag for compliance review

    - from: suspended
      to: active
      trigger: reinstate
      description: Reinstate after resolution

    - from: suspended
      to: terminated
      trigger: terminate
      description: Terminate suspended account

    - from: under_review
      to: active
      trigger: clear_review
      description: Review cleared

    - from: under_review
      to: suspended
      trigger: suspend
      description: Suspend pending review

    - from: under_review
      to: terminated
      trigger: terminate
      description: Terminate after review

indexes:
  - [merchant_id]
  - [email]
  - [status]
  - [business_name]
  - [mcc_code]
  - [verification_status]
  - [country, status]

events:
  - name: merchant.created
    description: Merchant account created
    payload: [id, merchant_id, business_name, status]

  - name: merchant.activated
    description: Merchant account activated
    payload: [id, merchant_id, activated_at]

  - name: merchant.verified
    description: KYC verification completed
    payload: [id, merchant_id, verification_status]

  - name: merchant.suspended
    description: Account suspended
    payload: [id, merchant_id, reason, suspended_at]

  - name: merchant.terminated
    description: Account terminated
    payload: [id, merchant_id, reason, terminated_at]

  - name: merchant.updated
    description: Merchant details updated
    payload: [id, merchant_id, updated_fields]

business_rules:
  - id: BR-MER-001
    description: MCC code required for card payment processing
    rule: |
      IF payment_methods CONTAINS 'card'
      THEN mcc_code IS NOT NULL
    vietnamese: MCC code bắt buộc cho thanh toán thẻ

  - id: BR-MER-002
    description: High-risk merchants have elevated fees
    rule: |
      IF risk_level = 'high'
      THEN processing_fee_rate >= 3.5
           AND reserve_rate >= 10
    vietnamese: Merchant rủi ro cao có phí cao hơn

  - id: BR-MER-003
    description: Verification required before payouts
    rule: |
      IF verification_status != 'verified'
      THEN payouts_enabled = false
    vietnamese: Cần xác minh trước khi thanh toán

  - id: BR-MER-004
    description: Suspended merchants cannot process payments
    rule: |
      IF status = 'suspended'
      THEN payments_enabled = false
    vietnamese: Merchant bị tạm ngưng không thể nhận thanh toán

  - id: BR-MER-005
    description: Monthly volume triggers automatic review
    rule: |
      IF monthly_volume > 1_000_000_000 VND
         AND verification_status = 'verified'
      THEN trigger_periodic_review()
    vietnamese: Doanh số cao tự động xét duyệt lại

  - id: BR-MER-006
    description: Statement descriptor must be recognizable
    rule: |
      statement_descriptor CONTAINS business_name_fragment
      AND length(statement_descriptor) <= 22
    vietnamese: Statement descriptor phải nhận diện được

api_endpoints:
  - method: POST
    path: /v1/merchants
    description: Create merchant account

  - method: GET
    path: /v1/merchants/{id}
    description: Retrieve merchant details

  - method: PATCH
    path: /v1/merchants/{id}
    description: Update merchant

  - method: POST
    path: /v1/merchants/{id}/verify
    description: Submit verification documents

  - method: GET
    path: /v1/merchants/{id}/balance
    description: Get available balance

  - method: GET
    path: /v1/merchants/{id}/dashboard
    description: Get dashboard summary

security_considerations:
  - Encrypt sensitive business documents
  - Rate limit registration to prevent spam
  - Verify business through official registries
  - Monitor for suspicious activity patterns
  - Implement IP whitelisting for API access
  - Two-factor authentication for dashboard
