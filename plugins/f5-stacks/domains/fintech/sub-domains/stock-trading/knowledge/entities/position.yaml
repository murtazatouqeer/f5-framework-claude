name: Position
display_name: Holding Position
description: |
  Represents the quantity of securities held for a specific symbol in an account.
  Includes information about cost basis, P&L, and position tracking metrics.

domain: fintech/stock-trading
category: core

attributes:
  - name: id
    type: uuid
    required: true
    description: Unique identifier of the position

  - name: account_id
    type: uuid
    required: true
    description: Trading account ID that owns the position

  - name: symbol
    type: string
    required: true
    description: Security symbol
    validation:
      pattern: "^[A-Z0-9]{3,10}$"

  - name: exchange
    type: enum
    required: true
    description: Listing exchange
    validation:
      values: [HOSE, HNX, UPCOM]

  - name: security_type
    type: enum
    required: true
    description: Security type
    validation:
      values:
        - stock           # Stock
        - etf             # ETF
        - covered_warrant # Covered warrant
        - bond            # Bond
        - fund_cert       # Fund certificate

  # ===== QUANTITY BREAKDOWN =====
  - name: total_quantity
    type: integer
    required: true
    description: Total quantity held
    validation:
      min: 0

  - name: available_quantity
    type: integer
    required: true
    description: Available quantity (can be sold)
    validation:
      min: 0

  - name: pending_buy_quantity
    type: integer
    required: true
    description: Pending buy quantity (T+2 not yet settled)
    validation:
      min: 0
    default: 0

  - name: pending_sell_quantity
    type: integer
    required: true
    description: Pending sell quantity (pending/partial orders)
    validation:
      min: 0
    default: 0

  - name: hold_quantity
    type: integer
    required: true
    description: Held quantity (pledged, restricted transfer)
    validation:
      min: 0
    default: 0

  - name: margin_quantity
    type: integer
    required: true
    description: Quantity bought with margin
    validation:
      min: 0
    default: 0

  # ===== COST BASIS =====
  - name: average_cost
    type: decimal
    required: true
    description: Average cost basis (including purchase fees)
    validation:
      min: 0

  - name: total_cost
    type: decimal
    required: true
    description: Total cost (average_cost × total_quantity)
    validation:
      min: 0

  - name: realized_pnl
    type: decimal
    required: true
    description: Realized P&L (from filled sell orders)
    default: 0

  - name: realized_pnl_percentage
    type: decimal
    required: false
    description: Realized P&L percentage

  # ===== MARKET VALUE =====
  - name: current_price
    type: decimal
    required: false
    description: Current price (updated realtime)
    validation:
      min: 0

  - name: market_value
    type: decimal
    required: false
    description: Market value (current_price × total_quantity)

  - name: unrealized_pnl
    type: decimal
    required: false
    description: Unrealized P&L

  - name: unrealized_pnl_percentage
    type: decimal
    required: false
    description: Unrealized P&L percentage

  - name: total_pnl
    type: decimal
    required: false
    description: Total P&L (realized + unrealized)

  - name: total_pnl_percentage
    type: decimal
    required: false
    description: Total P&L percentage

  # ===== PRICE TRACKING =====
  - name: highest_price
    type: decimal
    required: false
    description: Highest price since position opened

  - name: lowest_price
    type: decimal
    required: false
    description: Lowest price since position opened

  - name: first_buy_price
    type: decimal
    required: true
    description: First buy price

  - name: last_buy_price
    type: decimal
    required: false
    description: Most recent buy price

  - name: last_sell_price
    type: decimal
    required: false
    description: Most recent sell price

  # ===== DIVIDEND & CORPORATE ACTIONS =====
  - name: dividend_received
    type: decimal
    required: true
    description: Total dividends received from this position
    default: 0

  - name: bonus_shares_received
    type: integer
    required: true
    description: Total bonus shares received
    default: 0

  # ===== ALLOCATION =====
  - name: weight_percentage
    type: decimal
    required: false
    description: Weight in portfolio (%)
    validation:
      min: 0
      max: 100

  - name: target_weight
    type: decimal
    required: false
    description: Target weight (%)
    validation:
      min: 0
      max: 100

  # ===== TIMESTAMPS =====
  - name: first_buy_at
    type: timestamp
    required: true
    description: First buy timestamp (position opened)

  - name: last_buy_at
    type: timestamp
    required: false
    description: Most recent buy timestamp

  - name: last_sell_at
    type: timestamp
    required: false
    description: Most recent sell timestamp

  - name: price_updated_at
    type: timestamp
    required: false
    description: Most recent price update timestamp

  - name: created_at
    type: timestamp
    required: true
    description: Record creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

  - name: closed_at
    type: timestamp
    required: false
    description: Position closed timestamp (if total_quantity = 0)

relationships:
  - name: account
    type: belongs_to
    entity: TradingAccount
    required: true
    description: Account that owns the position

  - name: portfolio
    type: belongs_to
    entity: Portfolio
    required: true
    description: Portfolio containing the position

  - name: trades
    type: has_many
    entity: Trade
    required: false
    description: Trade history for this position

  - name: orders
    type: has_many
    entity: Order
    required: false
    description: Orders related to this position

  - name: security
    type: belongs_to
    entity: Security
    required: true
    description: Security information

indexes:
  - [account_id, symbol]
  - [symbol]
  - [total_quantity]
  - [unrealized_pnl_percentage]
  - [first_buy_at]

calculations:
  - name: available_quantity
    formula: |
      total_quantity
      - pending_sell_quantity
      - hold_quantity
    description: Sellable quantity

  - name: unrealized_pnl
    formula: |
      (current_price - average_cost) × total_quantity
    description: Unrealized P&L

  - name: unrealized_pnl_percentage
    formula: |
      (current_price - average_cost) / average_cost × 100
    description: Unrealized P&L percentage

  - name: market_value
    formula: |
      current_price × total_quantity
    description: Market value

  - name: weight_percentage
    formula: |
      market_value / portfolio.total_value × 100
    description: Weight in portfolio

  - name: average_cost_update
    formula: |
      NEW average_cost =
        (OLD total_cost + buy_value + buy_fee) /
        (OLD total_quantity + buy_quantity)
    description: Update average cost when buying more

business_rules:
  - BR-POS-001: Available quantity cannot be negative
  - BR-POS-002: Can only sell up to available quantity
  - BR-POS-003: Cost basis calculated using weighted average method
  - BR-POS-004: T+2 shares not yet settled cannot be sold
  - BR-POS-005: Position closed when total_quantity = 0
  - BR-POS-006: Update unrealized P&L realtime
