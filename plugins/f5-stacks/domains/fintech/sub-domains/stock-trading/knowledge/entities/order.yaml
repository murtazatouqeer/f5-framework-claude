name: Order
display_name: Trading Order
description: |
  Represents a buy or sell order for securities placed by an investor.
  Orders can be in various states from creation to execution or cancellation.
  Supports multiple order types: LO, MP, ATO, ATC, and conditional orders.

domain: fintech/stock-trading
category: core

attributes:
  - name: id
    type: uuid
    required: true
    description: Unique identifier of the order in the system

  - name: order_number
    type: string
    required: true
    description: Order number displayed to customer, follows brokerage format
    validation:
      pattern: "^ORD[0-9]{12}$"

  - name: exchange_order_id
    type: string
    required: false
    description: Order ID assigned by Exchange after successful submission
    validation:
      max: 50

  - name: account_id
    type: uuid
    required: true
    description: Trading account ID that placed the order

  - name: symbol
    type: string
    required: true
    description: Security code (ticker symbol)
    validation:
      pattern: "^[A-Z0-9]{3,10}$"

  - name: exchange
    type: enum
    required: true
    description: Trading exchange
    validation:
      values: [HOSE, HNX, UPCOM]

  - name: side
    type: enum
    required: true
    description: Order side
    validation:
      values: [buy, sell]

  - name: order_type
    type: enum
    required: true
    description: Order type
    validation:
      values:
        - LO      # Limit Order
        - MP      # Market Price
        - ATO     # At The Open
        - ATC     # At The Close
        - MOK     # Match Or Kill
        - MAK     # Match And Kill
        - MTL     # Market To Limit
        - PLO     # Post Limit Order

  - name: price
    type: decimal
    required: false
    description: Order price (required for LO, not for MP)
    validation:
      min: 0

  - name: quantity
    type: integer
    required: true
    description: Quantity of securities to buy/sell
    validation:
      min: 1

  - name: filled_quantity
    type: integer
    required: true
    description: Filled quantity
    validation:
      min: 0
    default: 0

  - name: remaining_quantity
    type: integer
    required: true
    description: Remaining unfilled quantity
    validation:
      min: 0

  - name: average_price
    type: decimal
    required: false
    description: Average filled price (if filled multiple times)

  - name: status
    type: enum
    required: true
    description: Current order status
    validation:
      values:
        - pending        # Pending processing in brokerage system
        - sent           # Sent to Exchange
        - confirmed      # Exchange confirmed receipt
        - partial_filled # Partially filled
        - filled         # Fully filled
        - cancelled      # Successfully cancelled
        - rejected       # Rejected (by brokerage or Exchange)
        - expired        # Expired (end of session)
        - pending_cancel # Pending cancellation
        - pending_modify # Pending modification

  - name: reject_reason
    type: string
    required: false
    description: Rejection reason (if status = rejected)
    validation:
      max: 500

  - name: time_in_force
    type: enum
    required: true
    description: Order time in force
    validation:
      values:
        - DAY     # Valid for the day
        - GTC     # Good Till Cancelled
        - GTD     # Good Till Date
        - IOC     # Immediate Or Cancel
        - FOK     # Fill Or Kill

  - name: expire_date
    type: date
    required: false
    description: Expiration date (for GTD orders)

  - name: is_margin
    type: boolean
    required: true
    description: Order uses margin (borrowed funds)
    default: false

  - name: margin_ratio
    type: decimal
    required: false
    description: Margin ratio used (%)
    validation:
      min: 0
      max: 100

  # ===== CONDITIONAL ORDER ATTRIBUTES =====
  - name: is_conditional
    type: boolean
    required: true
    description: Is conditional order (Stop, Trailing Stop, ...)
    default: false

  - name: condition_type
    type: enum
    required: false
    description: Condition trigger type
    validation:
      values:
        - stop_loss         # Stop loss
        - take_profit       # Take profit
        - trailing_stop     # Trailing stop
        - oco              # One Cancels Other

  - name: trigger_price
    type: decimal
    required: false
    description: Trigger price for conditional order

  - name: trailing_amount
    type: decimal
    required: false
    description: Trailing distance (amount or %)

  - name: trailing_type
    type: enum
    required: false
    description: Trailing type
    validation:
      values: [amount, percentage]

  - name: linked_order_id
    type: uuid
    required: false
    description: Linked order ID (for OCO)

  # ===== FEES & COSTS =====
  - name: commission
    type: decimal
    required: true
    description: Trading commission
    default: 0

  - name: commission_rate
    type: decimal
    required: false
    description: Commission rate (%)

  - name: tax
    type: decimal
    required: true
    description: Tax (only applied on sell)
    default: 0

  - name: tax_rate
    type: decimal
    required: false
    description: Tax rate (typically 0.1% on sell)

  - name: total_value
    type: decimal
    required: false
    description: Total order value (price Ã— quantity)

  - name: net_value
    type: decimal
    required: false
    description: Net value (after fees and tax)

  # ===== CHANNEL & SOURCE =====
  - name: channel
    type: enum
    required: true
    description: Order placement channel
    validation:
      values:
        - mobile_app
        - web_app
        - phone      # Phone order
        - broker     # Broker-assisted
        - api        # API trading

  - name: device_id
    type: string
    required: false
    description: Device ID that placed the order
    validation:
      max: 100

  - name: ip_address
    type: string
    required: false
    description: IP address

  - name: broker_id
    type: uuid
    required: false
    description: Broker ID (if placed via broker)

  # ===== TIMESTAMPS =====
  - name: created_at
    type: timestamp
    required: true
    description: Order creation time in system

  - name: sent_at
    type: timestamp
    required: false
    description: Time when order was sent to Exchange

  - name: confirmed_at
    type: timestamp
    required: false
    description: Time when Exchange confirmed

  - name: first_filled_at
    type: timestamp
    required: false
    description: First fill time

  - name: last_filled_at
    type: timestamp
    required: false
    description: Last fill time

  - name: completed_at
    type: timestamp
    required: false
    description: Completion time (filled/cancelled/expired)

  - name: updated_at
    type: timestamp
    required: true
    description: Last update time

  # ===== MODIFICATION HISTORY =====
  - name: original_quantity
    type: integer
    required: false
    description: Original quantity (if modified)

  - name: original_price
    type: decimal
    required: false
    description: Original price (if modified)

  - name: modification_count
    type: integer
    required: true
    description: Number of times order was modified
    default: 0

relationships:
  - name: account
    type: belongs_to
    entity: TradingAccount
    required: true
    description: Trading account that placed the order

  - name: customer
    type: belongs_to
    entity: Customer
    required: true
    description: Customer who owns the account

  - name: trades
    type: has_many
    entity: Trade
    required: false
    description: Trades filled from this order

  - name: linked_order
    type: belongs_to
    entity: Order
    required: false
    description: Linked order (OCO)

  - name: child_orders
    type: has_many
    entity: Order
    required: false
    description: Child orders (for basket order)

state_machine:
  initial: pending
  states:
    - name: pending
      description: Order being processed in brokerage system
    - name: sent
      description: Order sent to Exchange
    - name: confirmed
      description: Exchange confirmed order receipt
    - name: partial_filled
      description: Order partially filled
    - name: filled
      description: Order fully filled
    - name: pending_cancel
      description: Waiting for cancellation confirmation from Exchange
    - name: pending_modify
      description: Waiting for modification confirmation from Exchange
    - name: cancelled
      description: Order successfully cancelled
    - name: rejected
      description: Order rejected
    - name: expired
      description: Order expired at end of session

  transitions:
    # Happy path
    - from: pending
      to: sent
      trigger: send_to_exchange
      description: Send order to Exchange
    - from: sent
      to: confirmed
      trigger: exchange_confirm
      description: Exchange confirms order receipt
    - from: confirmed
      to: partial_filled
      trigger: partial_match
      description: Partial fill
    - from: confirmed
      to: filled
      trigger: full_match
      description: Full fill
    - from: partial_filled
      to: partial_filled
      trigger: additional_match
      description: Additional fill
    - from: partial_filled
      to: filled
      trigger: final_match
      description: Fill remaining quantity

    # Cancel flow
    - from: [confirmed, partial_filled]
      to: pending_cancel
      trigger: request_cancel
      description: Request order cancellation
    - from: pending_cancel
      to: cancelled
      trigger: cancel_confirmed
      description: Exchange confirms cancellation
    - from: pending_cancel
      to: confirmed
      trigger: cancel_rejected
      description: Exchange rejects cancellation (already filled)

    # Modify flow
    - from: confirmed
      to: pending_modify
      trigger: request_modify
      description: Request order modification
    - from: pending_modify
      to: confirmed
      trigger: modify_confirmed
      description: Exchange confirms modification
    - from: pending_modify
      to: confirmed
      trigger: modify_rejected
      description: Exchange rejects modification

    # Rejection & Expiry
    - from: pending
      to: rejected
      trigger: ctck_reject
      description: Brokerage rejects (validation fail)
    - from: sent
      to: rejected
      trigger: exchange_reject
      description: Exchange rejects
    - from: [confirmed, partial_filled]
      to: expired
      trigger: session_end
      description: End of session, DAY order expired

indexes:
  - [order_number]
  - [exchange_order_id]
  - [account_id, status]
  - [symbol, status]
  - [created_at]
  - [status, order_type]

business_rules:
  - BR-ORD-001: Order price must be within price limits (floor - ceiling)
  - BR-ORD-002: Quantity must be multiple of trading lot (100 for HOSE/HNX)
  - BR-ORD-003: Sell order must have sufficient securities in account
  - BR-ORD-004: Buy order must have sufficient cash/margin
  - BR-ORD-005: ATO/ATC orders only allowed during respective sessions
  - BR-ORD-006: Cannot modify/cancel fully filled orders
  - BR-ORD-007: Can only modify price/quantity, cannot modify side/symbol
  - BR-ORD-008: Margin orders must maintain margin ratio
