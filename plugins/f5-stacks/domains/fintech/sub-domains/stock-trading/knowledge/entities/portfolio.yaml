name: Portfolio
display_name: Investment Portfolio
description: |
  Collection of all security positions and cash in an account.
  Provides an overview of asset value, investment performance,
  and asset allocation of the investor.

domain: fintech/stock-trading
category: core

attributes:
  - name: id
    type: uuid
    required: true
    description: Unique identifier of the portfolio

  - name: account_id
    type: uuid
    required: true
    description: Trading account ID that owns the portfolio

  - name: name
    type: string
    required: false
    description: Portfolio name set by customer
    validation:
      max: 100
    default: "Main Portfolio"

  # ===== CASH POSITIONS =====
  - name: cash_balance
    type: decimal
    required: true
    description: Cash balance in account
    default: 0

  - name: available_cash
    type: decimal
    required: true
    description: Available cash (can be used for buying)
    default: 0

  - name: pending_cash
    type: decimal
    required: true
    description: Pending cash (T+2 from sell orders)
    default: 0

  - name: hold_cash
    type: decimal
    required: true
    description: Cash held for pending buy orders
    default: 0

  - name: withdrawable_cash
    type: decimal
    required: true
    description: Withdrawable cash
    default: 0

  # ===== MARGIN INFO =====
  - name: margin_used
    type: decimal
    required: true
    description: Margin amount currently used
    default: 0

  - name: margin_available
    type: decimal
    required: true
    description: Remaining margin limit
    default: 0

  - name: margin_ratio
    type: decimal
    required: false
    description: Current margin ratio (%)
    validation:
      min: 0
      max: 100

  - name: maintenance_margin
    type: decimal
    required: false
    description: Minimum maintenance margin level

  - name: margin_call_level
    type: decimal
    required: false
    description: Margin call level (%)

  - name: is_margin_call
    type: boolean
    required: true
    description: In margin call status
    default: false

  # ===== PORTFOLIO VALUE =====
  - name: total_market_value
    type: decimal
    required: true
    description: Total market value of securities
    default: 0

  - name: total_cost_basis
    type: decimal
    required: true
    description: Total cost basis of securities
    default: 0

  - name: nav
    type: decimal
    required: true
    description: Net Asset Value
    default: 0

  - name: total_assets
    type: decimal
    required: true
    description: Total assets (securities + cash)
    default: 0

  - name: total_liabilities
    type: decimal
    required: true
    description: Total liabilities (margin)
    default: 0

  - name: equity
    type: decimal
    required: true
    description: Equity (assets - liabilities)
    default: 0

  # ===== PERFORMANCE METRICS =====
  - name: total_unrealized_pnl
    type: decimal
    required: true
    description: Total unrealized P&L
    default: 0

  - name: total_unrealized_pnl_percentage
    type: decimal
    required: false
    description: Unrealized P&L percentage

  - name: total_realized_pnl
    type: decimal
    required: true
    description: Total realized P&L (YTD)
    default: 0

  - name: total_dividend_received
    type: decimal
    required: true
    description: Total dividends received (YTD)
    default: 0

  - name: total_return
    type: decimal
    required: false
    description: Total return (realized + unrealized + dividend)

  - name: total_return_percentage
    type: decimal
    required: false
    description: Total return percentage

  # ===== PERIOD RETURNS =====
  - name: day_pnl
    type: decimal
    required: false
    description: Daily P&L

  - name: day_pnl_percentage
    type: decimal
    required: false
    description: Daily P&L percentage

  - name: week_pnl
    type: decimal
    required: false
    description: Weekly P&L

  - name: week_pnl_percentage
    type: decimal
    required: false
    description: Weekly P&L percentage

  - name: month_pnl
    type: decimal
    required: false
    description: Monthly P&L (MTD)

  - name: month_pnl_percentage
    type: decimal
    required: false
    description: Monthly P&L percentage

  - name: ytd_pnl
    type: decimal
    required: false
    description: Year-to-date P&L (YTD)

  - name: ytd_pnl_percentage
    type: decimal
    required: false
    description: Year-to-date P&L percentage

  # ===== ALLOCATION BREAKDOWN =====
  - name: stock_allocation
    type: decimal
    required: false
    description: Stock allocation (%)

  - name: etf_allocation
    type: decimal
    required: false
    description: ETF allocation (%)

  - name: bond_allocation
    type: decimal
    required: false
    description: Bond allocation (%)

  - name: cash_allocation
    type: decimal
    required: false
    description: Cash allocation (%)

  - name: sector_allocation
    type: object
    required: false
    description: Sector allocation
    nested:
      - name: sector
        type: string
      - name: percentage
        type: decimal

  # ===== RISK METRICS =====
  - name: beta
    type: decimal
    required: false
    description: Portfolio beta vs VN-Index

  - name: volatility
    type: decimal
    required: false
    description: Volatility (standard deviation)

  - name: sharpe_ratio
    type: decimal
    required: false
    description: Sharpe ratio (risk-adjusted return)

  - name: max_drawdown
    type: decimal
    required: false
    description: Maximum drawdown from peak (%)

  - name: var_95
    type: decimal
    required: false
    description: Value at Risk 95% (1 day)

  # ===== STATISTICS =====
  - name: position_count
    type: integer
    required: true
    description: Number of positions held
    default: 0

  - name: winning_positions
    type: integer
    required: true
    description: Number of profitable positions
    default: 0

  - name: losing_positions
    type: integer
    required: true
    description: Number of losing positions
    default: 0

  - name: largest_position_symbol
    type: string
    required: false
    description: Symbol with largest weight

  - name: largest_position_weight
    type: decimal
    required: false
    description: Weight of largest position (%)

  - name: best_performer_symbol
    type: string
    required: false
    description: Best performing symbol

  - name: best_performer_return
    type: decimal
    required: false
    description: Return of best performer (%)

  - name: worst_performer_symbol
    type: string
    required: false
    description: Worst performing symbol

  - name: worst_performer_return
    type: decimal
    required: false
    description: Return of worst performer (%)

  # ===== BUYING POWER =====
  - name: buying_power
    type: decimal
    required: true
    description: Buying power (cash + margin available)
    default: 0

  - name: max_buy_quantity
    type: object
    required: false
    description: Maximum quantity that can be bought for each symbol
    nested:
      - name: symbol
        type: string
      - name: quantity
        type: integer

  # ===== TIMESTAMPS =====
  - name: last_trade_at
    type: timestamp
    required: false
    description: Last trade timestamp

  - name: last_valuation_at
    type: timestamp
    required: false
    description: Last valuation timestamp

  - name: created_at
    type: timestamp
    required: true
    description: Portfolio creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

relationships:
  - name: account
    type: belongs_to
    entity: TradingAccount
    required: true
    description: Account that owns the portfolio

  - name: positions
    type: has_many
    entity: Position
    required: false
    description: List of positions in portfolio

  - name: orders
    type: has_many
    entity: Order
    required: false
    description: Order history

  - name: trades
    type: has_many
    entity: Trade
    required: false
    description: Trade history

  - name: watchlists
    type: has_many
    entity: Watchlist
    required: false
    description: Watchlists

indexes:
  - [account_id]
  - [nav]
  - [total_return_percentage]
  - [margin_ratio]
  - [updated_at]

calculations:
  - name: nav
    formula: |
      total_market_value + cash_balance - margin_used
    description: Net asset value

  - name: total_assets
    formula: |
      total_market_value + cash_balance + pending_cash
    description: Total assets

  - name: equity
    formula: |
      total_assets - total_liabilities
    description: Equity

  - name: margin_ratio
    formula: |
      IF margin_used > 0 THEN
        equity / margin_used × 100
      ELSE
        NULL
      END IF
    description: Margin ratio

  - name: buying_power
    formula: |
      available_cash + margin_available
    description: Buying power

  - name: total_unrealized_pnl_percentage
    formula: |
      IF total_cost_basis > 0 THEN
        total_unrealized_pnl / total_cost_basis × 100
      ELSE
        0
      END IF
    description: Unrealized P&L percentage

business_rules:
  - BR-PORT-001: Update portfolio value realtime during trading hours
  - BR-PORT-002: Calculate margin ratio continuously, alert when < 50%
  - BR-PORT-003: Trigger margin call when ratio < 35%
  - BR-PORT-004: Do not allow buying when in margin call
  - BR-PORT-005: Calculate risk metrics at end of day
  - BR-PORT-006: Save daily NAV history to calculate performance
