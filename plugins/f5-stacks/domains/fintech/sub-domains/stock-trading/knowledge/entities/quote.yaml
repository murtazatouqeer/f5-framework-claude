name: Quote
display_name: Security Quote
description: |
  Price and volume information for a security.
  Includes realtime data during sessions and end-of-day historical data.

domain: fintech/stock-trading
category: market-data

attributes:
  - name: id
    type: uuid
    required: true
    description: Unique identifier of the quote record

  - name: symbol
    type: string
    required: true
    description: Security symbol
    validation:
      pattern: "^[A-Z0-9]{3,10}$"

  - name: exchange
    type: enum
    required: true
    description: Trading exchange
    validation:
      values: [HOSE, HNX, UPCOM]

  - name: trading_date
    type: date
    required: true
    description: Trading date

  - name: trading_session
    type: enum
    required: true
    description: Current trading session
    validation:
      values:
        - pre_open      # Before market open
        - ato           # ATO session (9:00-9:15)
        - continuous_am # Morning continuous (9:15-11:30)
        - lunch_break   # Lunch break
        - continuous_pm # Afternoon continuous (13:00-14:30)
        - atc           # ATC session (14:30-14:45)
        - plo           # Post-market (14:45-15:00)
        - closed        # Market closed

  - name: status
    type: enum
    required: true
    description: Trading status of the symbol
    validation:
      values:
        - trading       # Trading normally
        - halt          # Trading halted
        - suspended     # Trading suspended
        - delisted      # Delisted

  # ===== PRICE DATA =====
  - name: reference_price
    type: decimal
    required: true
    description: Reference price (previous close)
    validation:
      min: 0

  - name: ceiling_price
    type: decimal
    required: true
    description: Ceiling price (reference × (1 + limit))
    validation:
      min: 0

  - name: floor_price
    type: decimal
    required: true
    description: Floor price (reference × (1 - limit))
    validation:
      min: 0

  - name: open_price
    type: decimal
    required: false
    description: Opening price (ATO price)
    validation:
      min: 0

  - name: high_price
    type: decimal
    required: false
    description: Highest price in session
    validation:
      min: 0

  - name: low_price
    type: decimal
    required: false
    description: Lowest price in session
    validation:
      min: 0

  - name: close_price
    type: decimal
    required: false
    description: Closing price (ATC or last matched price)
    validation:
      min: 0

  - name: last_price
    type: decimal
    required: false
    description: Last matched price (realtime)
    validation:
      min: 0

  - name: average_price
    type: decimal
    required: false
    description: Average price in session
    validation:
      min: 0

  # ===== CHANGE =====
  - name: change
    type: decimal
    required: false
    description: Price change from reference (last - reference)

  - name: change_percentage
    type: decimal
    required: false
    description: Price change percentage

  - name: change_from_open
    type: decimal
    required: false
    description: Change from opening price

  - name: change_from_high
    type: decimal
    required: false
    description: Change from highest price

  # ===== VOLUME DATA =====
  - name: total_volume
    type: integer
    required: true
    description: Total volume traded in session
    default: 0

  - name: total_value
    type: decimal
    required: true
    description: Total value traded (VND)
    default: 0

  - name: buy_volume
    type: integer
    required: false
    description: Active buy volume

  - name: sell_volume
    type: integer
    required: false
    description: Active sell volume

  - name: foreign_buy_volume
    type: integer
    required: false
    description: Foreign buy volume

  - name: foreign_sell_volume
    type: integer
    required: false
    description: Foreign sell volume

  - name: foreign_net_volume
    type: integer
    required: false
    description: Foreign net buy volume

  - name: foreign_room_remaining
    type: integer
    required: false
    description: Remaining foreign room

  # ===== ORDER BOOK (Best Bid/Ask) =====
  - name: bid_price_1
    type: decimal
    required: false
    description: Best bid price (highest)

  - name: bid_volume_1
    type: integer
    required: false
    description: Volume at best bid price

  - name: bid_price_2
    type: decimal
    required: false

  - name: bid_volume_2
    type: integer
    required: false

  - name: bid_price_3
    type: decimal
    required: false

  - name: bid_volume_3
    type: integer
    required: false

  - name: ask_price_1
    type: decimal
    required: false
    description: Best ask price (lowest)

  - name: ask_volume_1
    type: integer
    required: false
    description: Volume at best ask price

  - name: ask_price_2
    type: decimal
    required: false

  - name: ask_volume_2
    type: integer
    required: false

  - name: ask_price_3
    type: decimal
    required: false

  - name: ask_volume_3
    type: integer
    required: false

  - name: spread
    type: decimal
    required: false
    description: Bid-ask spread

  - name: total_bid_volume
    type: integer
    required: false
    description: Total buy side volume

  - name: total_ask_volume
    type: integer
    required: false
    description: Total sell side volume

  # ===== LAST TRADE =====
  - name: last_volume
    type: integer
    required: false
    description: Last trade volume

  - name: last_trade_time
    type: timestamp
    required: false
    description: Last trade timestamp

  - name: trade_count
    type: integer
    required: false
    description: Number of trades in session

  # ===== HISTORICAL COMPARISON =====
  - name: week_high_52
    type: decimal
    required: false
    description: 52-week high

  - name: week_low_52
    type: decimal
    required: false
    description: 52-week low

  - name: avg_volume_10d
    type: integer
    required: false
    description: 10-day average volume

  - name: avg_volume_30d
    type: integer
    required: false
    description: 30-day average volume

  - name: volume_ratio
    type: decimal
    required: false
    description: Volume ratio vs average

  # ===== MARKET CAP & FUNDAMENTALS =====
  - name: market_cap
    type: decimal
    required: false
    description: Market capitalization

  - name: shares_outstanding
    type: integer
    required: false
    description: Shares outstanding

  - name: free_float
    type: decimal
    required: false
    description: Free float percentage (%)

  - name: pe_ratio
    type: decimal
    required: false
    description: P/E ratio

  - name: pb_ratio
    type: decimal
    required: false
    description: P/B ratio

  - name: eps
    type: decimal
    required: false
    description: Earnings per share

  - name: dividend_yield
    type: decimal
    required: false
    description: Dividend yield (%)

  # ===== TECHNICAL INDICATORS =====
  - name: rsi_14
    type: decimal
    required: false
    description: RSI 14 periods
    validation:
      min: 0
      max: 100

  - name: macd
    type: decimal
    required: false
    description: MACD

  - name: ma_5
    type: decimal
    required: false
    description: Moving Average 5 periods

  - name: ma_20
    type: decimal
    required: false
    description: Moving Average 20 periods

  - name: ma_50
    type: decimal
    required: false
    description: Moving Average 50 periods

  - name: ma_200
    type: decimal
    required: false
    description: Moving Average 200 periods

  # ===== TIMESTAMPS =====
  - name: quote_time
    type: timestamp
    required: true
    description: Quote timestamp

  - name: created_at
    type: timestamp
    required: true
    description: Record creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

relationships:
  - name: security
    type: belongs_to
    entity: Security
    required: true
    description: Detailed security information

  - name: trades
    type: has_many
    entity: Trade
    required: false
    description: Matched trades in session

indexes:
  - [symbol, trading_date]
  - [symbol, quote_time]
  - [exchange, trading_date]
  - [change_percentage]
  - [total_volume]
  - [foreign_net_volume]

calculations:
  - name: ceiling_price
    formula: |
      ROUND(reference_price × 1.07, price_tick)  # HOSE +7%
    description: Ceiling price = Reference × (1 + limit)

  - name: floor_price
    formula: |
      ROUND(reference_price × 0.93, price_tick)  # HOSE -7%
    description: Floor price = Reference × (1 - limit)

  - name: change_percentage
    formula: |
      (last_price - reference_price) / reference_price × 100
    description: Price change percentage

  - name: spread
    formula: |
      ask_price_1 - bid_price_1
    description: Bid-ask spread

  - name: volume_ratio
    formula: |
      total_volume / avg_volume_10d
    description: Volume ratio vs 10-day average

price_ticks:
  HOSE:
    - range: [0, 10000]
      tick: 10
    - range: [10000, 50000]
      tick: 50
    - range: [50000, null]
      tick: 100
  HNX:
    - range: [0, null]
      tick: 100
  UPCOM:
    - range: [0, null]
      tick: 100

business_rules:
  - BR-QUO-001: Order price must be within limits (floor <= price <= ceiling)
  - BR-QUO-002: Price must follow price tick rules
  - BR-QUO-003: Limits HOSE ±7%, HNX ±10%, UPCoM ±15%
  - BR-QUO-004: Update quote realtime with latency < 1 second
  - BR-QUO-005: Save quote snapshot at end of each session
  - BR-QUO-006: Foreign room = 0 means foreigners cannot buy
