name: Loan Application
display_name: Loan Application / Đơn vay
description: |
  Loan application entity tracking the complete application process
  from submission through approval, with credit assessment and documentation.

domain: fintech
sub_domain: p2p-lending
version: "1.0"
status: active

# =============================================================================
# ENTITY DEFINITION
# =============================================================================
entity:
  name: LoanApplication
  name_vi: Đơn vay
  table_name: loan_applications

  primary_key: id
  natural_key: application_number

  # ---------------------------------------------------------------------------
  # ATTRIBUTES
  # ---------------------------------------------------------------------------
  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true
      description: Unique application identifier

    - name: application_number
      type: string
      format: "APP-YYYYMM-XXXXXX"
      unique: true
      indexed: true
      description: Human-readable application number
      example: "APP-202501-000001"

    # Applicant Information
    - name: borrower_id
      type: uuid
      required: true
      references: borrowers.id
      indexed: true
      description: The borrower submitting the application

    # Loan Request Details
    - name: requested_amount
      type: decimal
      precision: 15
      scale: 2
      required: true
      min: 1000000
      max: 2000000000
      description: Amount requested by borrower in VND

    - name: approved_amount
      type: decimal
      precision: 15
      scale: 2
      description: Amount approved (may differ from requested)

    - name: requested_term_months
      type: integer
      required: true
      min: 1
      max: 60
      description: Requested loan term in months

    - name: approved_term_months
      type: integer
      min: 1
      max: 60
      description: Approved term (may differ from requested)

    - name: loan_purpose
      type: enum
      values: [personal, business, education, medical, home_improvement, debt_consolidation, auto, other]
      required: true
      description: Purpose of the loan

    - name: purpose_description
      type: text
      max_length: 2000
      description: Detailed description of loan purpose

    # Application Status
    - name: status
      type: enum
      values: [draft, submitted, document_pending, under_review, credit_check, approved, rejected, expired, cancelled, converted]
      default: draft
      indexed: true
      description: Current application status

    - name: rejection_reason
      type: enum
      values: [credit_score_low, income_insufficient, debt_ratio_high, employment_unstable, documentation_incomplete, fraud_detected, policy_violation, other]
      description: Reason for rejection if applicable

    - name: rejection_details
      type: text
      description: Detailed rejection explanation

    # Credit Assessment
    - name: credit_score
      type: integer
      min: 300
      max: 850
      description: Calculated credit score

    - name: assigned_grade
      type: enum
      values: [A, B, C, D, E, F]
      description: Risk grade assigned

    - name: assigned_sub_grade
      type: string
      pattern: "^[A-F][1-5]$"
      description: Sub-grade for finer risk classification

    - name: offered_interest_rate
      type: decimal
      precision: 5
      scale: 2
      description: Interest rate offered based on credit assessment

    - name: risk_assessment_date
      type: timestamp
      description: When credit assessment was performed

    # Income Verification
    - name: declared_monthly_income
      type: decimal
      precision: 15
      scale: 2
      description: Self-declared monthly income

    - name: verified_monthly_income
      type: decimal
      precision: 15
      scale: 2
      description: Income verified through documentation

    - name: income_verification_method
      type: enum
      values: [payslip, bank_statement, tax_return, employer_letter, business_financials]
      description: Method used to verify income

    - name: income_verified
      type: boolean
      default: false
      description: Whether income has been verified

    # Debt Analysis
    - name: existing_debt_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Total existing debt obligations

    - name: monthly_debt_payment
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Monthly payments on existing debt

    - name: debt_to_income_ratio
      type: decimal
      precision: 5
      scale: 2
      computed: "(monthly_debt_payment / verified_monthly_income) * 100"
      description: DTI ratio percentage

    # Employment Information
    - name: employment_status
      type: enum
      values: [employed, self_employed, business_owner, retired, unemployed]
      required: true
      description: Current employment status

    - name: employer_name
      type: string
      max_length: 200
      description: Name of employer

    - name: job_title
      type: string
      max_length: 100
      description: Job title or position

    - name: employment_duration_months
      type: integer
      description: Months at current employer

    - name: employment_verified
      type: boolean
      default: false
      description: Whether employment has been verified

    # Documentation
    - name: documents_required
      type: jsonb
      description: List of required documents
      example: '["id_card", "income_proof", "address_proof", "bank_statement"]'

    - name: documents_submitted
      type: jsonb
      description: List of submitted documents with status

    - name: documents_verified
      type: boolean
      default: false
      description: Whether all required documents verified

    - name: document_verification_notes
      type: text
      description: Notes from document verification

    # eKYC & Identity
    - name: kyc_status
      type: enum
      values: [pending, in_progress, verified, failed]
      default: pending
      description: KYC verification status

    - name: kyc_verification_date
      type: timestamp
      description: When KYC was verified

    - name: identity_verified
      type: boolean
      default: false
      description: Whether identity has been verified

    - name: liveness_check_passed
      type: boolean
      default: false
      description: Whether liveness check was passed

    # Fraud Detection
    - name: fraud_score
      type: integer
      min: 0
      max: 100
      description: Fraud risk score (0=low, 100=high)

    - name: fraud_flags
      type: jsonb
      description: List of fraud indicators detected

    - name: fraud_review_required
      type: boolean
      default: false
      description: Whether manual fraud review is needed

    - name: fraud_review_completed
      type: boolean
      default: false
      description: Whether fraud review is completed

    # Review Process
    - name: auto_decision
      type: boolean
      default: false
      description: Whether decision was made automatically

    - name: reviewer_id
      type: uuid
      references: users.id
      description: Staff member who reviewed application

    - name: review_started_at
      type: timestamp
      description: When manual review started

    - name: review_completed_at
      type: timestamp
      description: When review was completed

    - name: review_notes
      type: text
      description: Notes from reviewer

    # Offer Details
    - name: offer_generated
      type: boolean
      default: false
      description: Whether loan offer has been generated

    - name: offer_amount
      type: decimal
      precision: 15
      scale: 2
      description: Offered loan amount

    - name: offer_rate
      type: decimal
      precision: 5
      scale: 2
      description: Offered interest rate

    - name: offer_term_months
      type: integer
      description: Offered term

    - name: offer_expires_at
      type: timestamp
      description: When the offer expires

    - name: offer_accepted
      type: boolean
      default: false
      description: Whether borrower accepted the offer

    - name: offer_accepted_at
      type: timestamp
      description: When offer was accepted

    # Conversion
    - name: converted_to_loan
      type: boolean
      default: false
      description: Whether application converted to loan

    - name: loan_id
      type: uuid
      references: loans.id
      description: Resulting loan if converted

    # Channel & Source
    - name: application_channel
      type: enum
      values: [web, mobile_app, api, partner, branch]
      default: web
      description: Channel through which application was submitted

    - name: referral_code
      type: string
      max_length: 50
      description: Referral code if applicable

    - name: campaign_id
      type: string
      max_length: 50
      description: Marketing campaign identifier

    - name: partner_id
      type: uuid
      description: Partner who referred the application

    # IP & Device
    - name: ip_address
      type: string
      description: IP address of applicant

    - name: device_fingerprint
      type: string
      description: Device fingerprint for fraud detection

    - name: user_agent
      type: string
      description: Browser/device user agent

    # Timestamps
    - name: created_at
      type: timestamp
      default: now()
      description: When application was created

    - name: submitted_at
      type: timestamp
      description: When application was submitted

    - name: updated_at
      type: timestamp
      default: now()
      on_update: now()
      description: Last update time

    - name: decided_at
      type: timestamp
      description: When final decision was made

    - name: expires_at
      type: timestamp
      description: Application expiry date

  # ---------------------------------------------------------------------------
  # RELATIONSHIPS
  # ---------------------------------------------------------------------------
  relationships:
    - name: borrower
      type: belongs_to
      entity: Borrower
      foreign_key: borrower_id

    - name: loan
      type: has_one
      entity: Loan
      foreign_key: loan_application_id

    - name: credit_scores
      type: has_many
      entity: CreditScore
      foreign_key: loan_application_id
      order_by: created_at desc

    - name: reviewer
      type: belongs_to
      entity: User
      foreign_key: reviewer_id

    - name: documents
      type: has_many
      entity: Document
      foreign_key: loan_application_id

  # ---------------------------------------------------------------------------
  # INDEXES
  # ---------------------------------------------------------------------------
  indexes:
    - name: idx_applications_borrower
      columns: [borrower_id]

    - name: idx_applications_status
      columns: [status]

    - name: idx_applications_submitted
      columns: [submitted_at]

    - name: idx_applications_channel
      columns: [application_channel]

# =============================================================================
# STATE MACHINE
# =============================================================================
state_machine:
  initial_state: draft

  states:
    draft:
      description: Application started but not submitted
      name_vi: Bản nháp
      allowed_actions: [edit, submit, delete]

    submitted:
      description: Application submitted for processing
      name_vi: Đã nộp
      allowed_actions: [request_documents, start_review]

    document_pending:
      description: Waiting for additional documents
      name_vi: Chờ tài liệu
      allowed_actions: [upload_document, cancel]

    under_review:
      description: Application being reviewed
      name_vi: Đang xem xét
      allowed_actions: [request_info, approve, reject]

    credit_check:
      description: Credit assessment in progress
      name_vi: Kiểm tra tín dụng
      allowed_actions: [complete_credit_check]

    approved:
      description: Application approved, offer generated
      name_vi: Đã duyệt
      allowed_actions: [accept_offer, decline_offer]

    rejected:
      description: Application rejected
      name_vi: Bị từ chối
      terminal: true

    expired:
      description: Application or offer expired
      name_vi: Hết hạn
      terminal: true

    cancelled:
      description: Application cancelled by borrower
      name_vi: Đã hủy
      terminal: true

    converted:
      description: Application converted to loan
      name_vi: Đã chuyển đổi
      terminal: true

  transitions:
    - from: draft
      to: submitted
      event: submit
      condition: "all_required_fields_filled"
      actions:
        - validate_application
        - start_kyc
        - create_audit_log

    - from: draft
      to: cancelled
      event: delete
      actions:
        - archive_draft

    - from: submitted
      to: document_pending
      event: request_documents
      actions:
        - send_document_request
        - set_document_deadline

    - from: submitted
      to: under_review
      event: start_review
      condition: "documents_complete"
      actions:
        - assign_reviewer
        - start_fraud_check

    - from: document_pending
      to: under_review
      event: documents_received
      condition: "all_documents_verified"
      actions:
        - assign_reviewer
        - start_fraud_check

    - from: document_pending
      to: expired
      event: document_timeout
      condition: "current_date > document_deadline"
      actions:
        - notify_borrower
        - close_application

    - from: under_review
      to: credit_check
      event: proceed_to_credit
      condition: "fraud_check_passed"
      actions:
        - run_credit_model
        - calculate_score

    - from: under_review
      to: rejected
      event: reject_fraud
      condition: "fraud_detected"
      actions:
        - log_fraud_rejection
        - notify_borrower

    - from: credit_check
      to: approved
      event: approve
      condition: "credit_score >= minimum_threshold"
      actions:
        - calculate_grade
        - generate_offer
        - notify_borrower

    - from: credit_check
      to: rejected
      event: reject_credit
      condition: "credit_score < minimum_threshold"
      actions:
        - set_rejection_reason
        - notify_borrower

    - from: approved
      to: converted
      event: accept_offer
      actions:
        - create_loan
        - create_listing
        - notify_borrower

    - from: approved
      to: cancelled
      event: decline_offer
      actions:
        - log_decline
        - notify_team

    - from: approved
      to: expired
      event: offer_expired
      condition: "current_date > offer_expires_at"
      actions:
        - close_application
        - notify_borrower

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  eligibility:
    - rule: "Minimum age 18 years"
      enforcement: system

    - rule: "Maximum age 60 years at loan maturity"
      enforcement: system

    - rule: "Vietnamese citizen or permanent resident"
      enforcement: system

    - rule: "Valid national ID or passport"
      enforcement: system

  income:
    - rule: "Minimum monthly income 5,000,000 VND"
      enforcement: system

    - rule: "Maximum DTI ratio 50%"
      enforcement: system

    - rule: "Income must be verifiable"
      enforcement: system

  credit:
    - rule: "No active defaults on platform"
      enforcement: system

    - rule: "Maximum 2 active loans on platform"
      enforcement: policy

    - rule: "Minimum credit score 450 for approval"
      enforcement: system

  documents:
    - rule: "ID document required"
      enforcement: system

    - rule: "Income proof required"
      enforcement: system

    - rule: "Documents valid within 3 months"
      enforcement: system

  timing:
    - rule: "Application expires after 30 days"
      enforcement: system

    - rule: "Offer valid for 7 days"
      enforcement: system

    - rule: "Document upload deadline 14 days"
      enforcement: system

# =============================================================================
# SLA CONFIGURATION
# =============================================================================
sla:
  auto_decision:
    target: 5_minutes
    condition: "low_risk_application"

  manual_review:
    target: 24_hours
    escalation: 48_hours

  document_verification:
    target: 4_hours
    escalation: 24_hours

  offer_generation:
    target: 1_hour
    after: approval

# =============================================================================
# VALIDATION RULES
# =============================================================================
validations:
  - field: requested_amount
    rules:
      - min: 1000000
        message: "Minimum loan amount is 1,000,000 VND"
      - max: 2000000000
        message: "Maximum loan amount is 2,000,000,000 VND"

  - field: requested_term_months
    rules:
      - min: 1
        message: "Minimum term is 1 month"
      - max: 60
        message: "Maximum term is 60 months"

  - field: debt_to_income_ratio
    rules:
      - max: 50
        message: "DTI ratio cannot exceed 50%"

# =============================================================================
# AUDIT CONFIGURATION
# =============================================================================
audit:
  enabled: true
  track_changes: true
  sensitive_fields:
    - borrower_id
    - declared_monthly_income
    - verified_monthly_income
    - ip_address
    - device_fingerprint
  retention_years: 7
