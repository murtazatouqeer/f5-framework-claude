name: Investor
display_name: Investor / Nhà đầu tư
description: |
  Investor profile entity managing investment preferences, portfolio allocation,
  auto-invest rules, and investment performance tracking.

domain: fintech
sub_domain: p2p-lending
version: "1.0"
status: active

# =============================================================================
# ENTITY DEFINITION
# =============================================================================
entity:
  name: Investor
  name_vi: Nhà đầu tư
  table_name: investors

  primary_key: id
  natural_key: investor_number

  # ---------------------------------------------------------------------------
  # ATTRIBUTES
  # ---------------------------------------------------------------------------
  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true
      description: Unique investor identifier

    - name: investor_number
      type: string
      format: "INV-XXXXXX"
      unique: true
      indexed: true
      description: Human-readable investor number
      example: "INV-000001"

    - name: user_id
      type: uuid
      required: true
      references: users.id
      unique: true
      description: Associated user account

    # Personal Information
    - name: full_name
      type: string
      max_length: 200
      required: true
      description: Full legal name

    - name: date_of_birth
      type: date
      required: true
      description: Date of birth

    - name: nationality
      type: string
      default: "VN"
      description: Nationality code

    # Identity Documents
    - name: id_type
      type: enum
      values: [national_id, passport, driver_license]
      required: true
      description: Primary ID document type

    - name: id_number
      type: string
      max_length: 50
      required: true
      encrypted: true
      description: ID document number

    - name: id_expiry_date
      type: date
      description: ID document expiry date

    - name: tax_id
      type: string
      max_length: 20
      encrypted: true
      description: Tax identification number

    # Contact Information
    - name: email
      type: string
      format: email
      required: true
      indexed: true
      description: Primary email address

    - name: phone_number
      type: string
      max_length: 20
      required: true
      description: Primary phone number

    - name: phone_verified
      type: boolean
      default: false
      description: Whether phone is verified

    - name: email_verified
      type: boolean
      default: false
      description: Whether email is verified

    # Address
    - name: address
      type: string
      max_length: 500
      description: Residential address

    - name: city
      type: string
      max_length: 100
      description: City/province

    # Investor Classification
    - name: investor_type
      type: enum
      values: [individual, institutional, accredited]
      default: individual
      indexed: true
      description: Type of investor

    - name: accreditation_status
      type: enum
      values: [not_applicable, pending, verified, expired]
      default: not_applicable
      description: Accredited investor status

    - name: accreditation_date
      type: date
      description: When accreditation was verified

    - name: annual_income
      type: decimal
      precision: 18
      scale: 2
      description: Annual income for suitability

    - name: net_worth
      type: decimal
      precision: 18
      scale: 2
      description: Net worth for suitability

    # Risk Profile
    - name: risk_tolerance
      type: enum
      values: [conservative, moderate, aggressive]
      default: moderate
      description: Investor risk tolerance

    - name: investment_experience
      type: enum
      values: [none, beginner, intermediate, advanced]
      default: beginner
      description: Investment experience level

    - name: investment_horizon
      type: enum
      values: [short_term, medium_term, long_term]
      default: medium_term
      description: Investment time horizon

    - name: risk_assessment_date
      type: date
      description: When risk assessment was last completed

    - name: risk_acknowledgment
      type: boolean
      default: false
      description: Whether investor acknowledged P2P risks

    # Account Balance
    - name: available_balance
      type: decimal
      precision: 18
      scale: 2
      default: 0
      description: Available cash balance in VND

    - name: invested_balance
      type: decimal
      precision: 18
      scale: 2
      default: 0
      description: Total amount currently invested

    - name: pending_investment
      type: decimal
      precision: 18
      scale: 2
      default: 0
      description: Amount in pending investments

    - name: total_balance
      type: decimal
      precision: 18
      scale: 2
      computed: "available_balance + invested_balance + pending_investment"
      description: Total account value

    # Portfolio Statistics
    - name: total_invested
      type: decimal
      precision: 18
      scale: 2
      default: 0
      description: Total amount ever invested

    - name: total_principal_returned
      type: decimal
      precision: 18
      scale: 2
      default: 0
      description: Total principal received back

    - name: total_interest_earned
      type: decimal
      precision: 18
      scale: 2
      default: 0
      description: Total interest earned

    - name: total_fees_paid
      type: decimal
      precision: 18
      scale: 2
      default: 0
      description: Total platform fees paid

    - name: net_earnings
      type: decimal
      precision: 18
      scale: 2
      computed: "total_interest_earned - total_fees_paid - total_losses"
      description: Net earnings from investments

    - name: total_losses
      type: decimal
      precision: 18
      scale: 2
      default: 0
      description: Total losses from defaults

    # Portfolio Performance
    - name: active_investments
      type: integer
      default: 0
      description: Number of active investments

    - name: completed_investments
      type: integer
      default: 0
      description: Number of completed investments

    - name: defaulted_investments
      type: integer
      default: 0
      description: Number of defaulted investments

    - name: total_investments
      type: integer
      default: 0
      description: Total number of investments made

    - name: weighted_avg_rate
      type: decimal
      precision: 5
      scale: 2
      description: Weighted average interest rate

    - name: portfolio_yield
      type: decimal
      precision: 5
      scale: 2
      computed: "(total_interest_earned / GREATEST(total_invested, 1)) * 100"
      description: Portfolio yield percentage

    - name: default_rate
      type: decimal
      precision: 5
      scale: 2
      computed: "(defaulted_investments / GREATEST(total_investments, 1)) * 100"
      description: Personal default rate

    # Portfolio Diversification
    - name: avg_investment_size
      type: decimal
      precision: 15
      scale: 2
      description: Average investment amount

    - name: portfolio_by_grade
      type: jsonb
      description: Investment distribution by grade
      example: '{"A": 30, "B": 40, "C": 20, "D": 10}'

    - name: portfolio_by_term
      type: jsonb
      description: Investment distribution by term

    - name: diversification_score
      type: decimal
      precision: 5
      scale: 2
      description: Portfolio diversification score (0-100)

    # Auto-Invest Settings
    - name: auto_invest_enabled
      type: boolean
      default: false
      indexed: true
      description: Whether auto-invest is enabled

    - name: auto_invest_amount
      type: decimal
      precision: 15
      scale: 2
      description: Amount per auto-investment

    - name: auto_invest_min_rate
      type: decimal
      precision: 5
      scale: 2
      description: Minimum acceptable interest rate

    - name: auto_invest_max_rate
      type: decimal
      precision: 5
      scale: 2
      description: Maximum acceptable interest rate

    - name: auto_invest_grades
      type: jsonb
      description: Acceptable loan grades
      example: '["A", "B", "C"]'

    - name: auto_invest_terms
      type: jsonb
      description: Acceptable loan terms in months
      example: '[6, 12, 24]'

    - name: auto_invest_max_per_loan
      type: decimal
      precision: 15
      scale: 2
      description: Maximum investment per single loan

    - name: auto_invest_reserve
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Reserve amount to keep uninvested

    - name: auto_invest_strategy
      type: enum
      values: [balanced, aggressive, conservative, custom]
      default: balanced
      description: Auto-invest strategy preset

    # Bank Account
    - name: primary_bank_name
      type: string
      max_length: 100
      description: Primary bank name

    - name: primary_bank_account
      type: string
      max_length: 50
      encrypted: true
      description: Primary bank account number

    - name: bank_account_holder
      type: string
      max_length: 200
      description: Bank account holder name

    - name: bank_account_verified
      type: boolean
      default: false
      description: Whether bank account is verified

    # Withdrawal Limits
    - name: daily_withdrawal_limit
      type: decimal
      precision: 15
      scale: 2
      default: 500000000
      description: Daily withdrawal limit

    - name: withdrawn_today
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Amount withdrawn today

    # Verification Status
    - name: kyc_status
      type: enum
      values: [pending, partial, verified, expired]
      default: pending
      indexed: true
      description: Overall KYC status

    - name: kyc_verified_date
      type: timestamp
      description: When KYC was verified

    - name: suitability_completed
      type: boolean
      default: false
      description: Whether suitability assessment completed

    # Account Status
    - name: status
      type: enum
      values: [pending, active, suspended, blocked, inactive]
      default: pending
      indexed: true
      description: Investor account status

    - name: status_reason
      type: string
      max_length: 500
      description: Reason for current status

    - name: can_invest
      type: boolean
      default: false
      description: Whether investor can make investments

    - name: can_withdraw
      type: boolean
      default: false
      description: Whether investor can withdraw funds

    # Preferences
    - name: preferred_language
      type: string
      default: "vi"
      description: Preferred communication language

    - name: notification_preferences
      type: jsonb
      description: Notification channel preferences

    - name: statement_frequency
      type: enum
      values: [daily, weekly, monthly]
      default: monthly
      description: Portfolio statement frequency

    # Timestamps
    - name: created_at
      type: timestamp
      default: now()
      description: When account was created

    - name: updated_at
      type: timestamp
      default: now()
      on_update: now()
      description: Last update time

    - name: last_login_at
      type: timestamp
      description: Last login time

    - name: first_investment_date
      type: date
      description: Date of first investment

    - name: last_investment_date
      type: date
      description: Date of most recent investment

    - name: last_withdrawal_date
      type: date
      description: Date of last withdrawal

  # ---------------------------------------------------------------------------
  # RELATIONSHIPS
  # ---------------------------------------------------------------------------
  relationships:
    - name: user
      type: belongs_to
      entity: User
      foreign_key: user_id

    - name: investments
      type: has_many
      entity: Investment
      foreign_key: investor_id
      order_by: created_at desc

    - name: transactions
      type: has_many
      entity: Transaction
      foreign_key: investor_id
      order_by: created_at desc

    - name: documents
      type: has_many
      entity: Document
      foreign_key: investor_id

  # ---------------------------------------------------------------------------
  # INDEXES
  # ---------------------------------------------------------------------------
  indexes:
    - name: idx_investors_user
      columns: [user_id]
      unique: true

    - name: idx_investors_status
      columns: [status]

    - name: idx_investors_type
      columns: [investor_type]

    - name: idx_investors_auto_invest
      columns: [auto_invest_enabled]
      where: "status = 'active'"

    - name: idx_investors_kyc
      columns: [kyc_status]

# =============================================================================
# STATE MACHINE
# =============================================================================
state_machine:
  initial_state: pending

  states:
    pending:
      description: Account created, verification pending
      name_vi: Chờ xác minh
      allowed_actions: [submit_kyc, deactivate]

    active:
      description: Fully verified and active
      name_vi: Hoạt động
      allowed_actions: [invest, withdraw, configure_auto_invest, suspend]

    suspended:
      description: Temporarily suspended
      name_vi: Tạm khóa
      allowed_actions: [reactivate, block]

    blocked:
      description: Permanently blocked
      name_vi: Bị chặn
      terminal: true

    inactive:
      description: Voluntarily deactivated
      name_vi: Ngừng hoạt động
      allowed_actions: [reactivate]

  transitions:
    - from: pending
      to: active
      event: kyc_verified
      condition: "kyc_status = 'verified' AND suitability_completed"
      actions:
        - enable_investing
        - send_welcome
        - set_initial_limits

    - from: pending
      to: inactive
      event: deactivate
      actions:
        - log_deactivation

    - from: active
      to: suspended
      event: suspend
      actions:
        - disable_investing
        - disable_auto_invest
        - notify_investor
        - log_suspension

    - from: active
      to: inactive
      event: deactivate
      condition: "invested_balance = 0 AND pending_investment = 0"
      actions:
        - disable_investing
        - disable_auto_invest
        - log_deactivation

    - from: suspended
      to: active
      event: reactivate
      condition: "suspension_resolved"
      actions:
        - enable_investing
        - notify_investor

    - from: suspended
      to: blocked
      event: block
      actions:
        - freeze_account
        - notify_investor
        - log_blocking

    - from: inactive
      to: active
      event: reactivate
      condition: "kyc_status = 'verified'"
      actions:
        - enable_investing
        - notify_investor

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  eligibility:
    - rule: "Age must be 18+ years"
      enforcement: system

    - rule: "KYC must be verified to invest"
      enforcement: system

    - rule: "Suitability assessment required"
      enforcement: system

    - rule: "Risk acknowledgment required"
      enforcement: system

  investment_limits:
    - rule: "Minimum investment per loan 100,000 VND"
      enforcement: system

    - rule: "Maximum 10% of portfolio in single loan"
      enforcement: system
      investor_type: individual

    - rule: "Maximum single investment 50,000,000 VND"
      enforcement: system
      investor_type: individual

  auto_invest:
    - rule: "Auto-invest requires verified status"
      enforcement: system

    - rule: "Minimum auto-invest amount 100,000 VND"
      enforcement: system

    - rule: "At least one grade must be selected"
      enforcement: system

  withdrawals:
    - rule: "Only available balance can be withdrawn"
      enforcement: system

    - rule: "Daily withdrawal limit applies"
      enforcement: system

    - rule: "Bank account must be verified"
      enforcement: system

# =============================================================================
# COMPUTED FIELDS
# =============================================================================
computed_fields:
  - name: age
    formula: "YEAR(NOW()) - YEAR(date_of_birth)"

  - name: roi
    formula: "(net_earnings / GREATEST(total_invested, 1)) * 100"

  - name: available_for_auto_invest
    formula: "available_balance - auto_invest_reserve"

  - name: withdrawal_remaining
    formula: "daily_withdrawal_limit - withdrawn_today"

# =============================================================================
# VALIDATION RULES
# =============================================================================
validations:
  - field: date_of_birth
    rules:
      - custom: "age >= 18"
        message: "Investor must be at least 18 years old"

  - field: auto_invest_amount
    rules:
      - min: 100000
        message: "Minimum auto-invest amount is 100,000 VND"

  - field: auto_invest_max_per_loan
    rules:
      - max: 50000000
        message: "Maximum per-loan investment is 50,000,000 VND"
        investor_type: individual

  - field: email
    rules:
      - format: email
        message: "Invalid email format"

# =============================================================================
# AUDIT CONFIGURATION
# =============================================================================
audit:
  enabled: true
  track_changes: true
  sensitive_fields:
    - id_number
    - tax_id
    - primary_bank_account
    - annual_income
    - net_worth
    - email
    - phone_number
    - address
  retention_years: 10
