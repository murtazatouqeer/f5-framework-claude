name: Platform Fee
display_name: Platform Fee / Phí nền tảng
description: |
  Platform fee entity tracking all fee types charged by the P2P
  lending platform including origination, service, and transaction fees.

domain: fintech
sub_domain: p2p-lending
version: "1.0"
status: active

# =============================================================================
# ENTITY DEFINITION
# =============================================================================
entity:
  name: PlatformFee
  name_vi: Phí nền tảng
  table_name: platform_fees

  primary_key: id
  natural_key: fee_reference

  # ---------------------------------------------------------------------------
  # ATTRIBUTES
  # ---------------------------------------------------------------------------
  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true
      description: Unique fee identifier

    - name: fee_reference
      type: string
      format: "FEE-YYYYMM-XXXXXX"
      unique: true
      indexed: true
      description: Fee reference number
      example: "FEE-202501-000001"

    # Fee Classification
    - name: fee_type
      type: enum
      values: [origination, service, late_payment, early_payoff, withdrawal, deposit, secondary_market, collection, legal, other]
      required: true
      indexed: true
      description: Type of fee

    - name: fee_category
      type: enum
      values: [borrower, investor, transaction]
      required: true
      indexed: true
      description: Who is charged

    - name: fee_name
      type: string
      max_length: 100
      required: true
      description: Fee name

    - name: fee_name_vi
      type: string
      max_length: 100
      description: Vietnamese fee name

    # References
    - name: loan_id
      type: uuid
      references: loans.id
      indexed: true
      description: Associated loan

    - name: loan_application_id
      type: uuid
      references: loan_applications.id
      description: Associated application

    - name: borrower_id
      type: uuid
      references: borrowers.id
      indexed: true
      description: Borrower if applicable

    - name: investor_id
      type: uuid
      references: investors.id
      indexed: true
      description: Investor if applicable

    - name: repayment_id
      type: uuid
      references: repayments.id
      description: Associated repayment

    - name: investment_id
      type: uuid
      references: investments.id
      description: Associated investment

    - name: transaction_id
      type: uuid
      references: transactions.id
      description: Associated transaction

    # Fee Calculation
    - name: base_amount
      type: decimal
      precision: 15
      scale: 2
      description: Amount fee is calculated on

    - name: fee_rate
      type: decimal
      precision: 7
      scale: 4
      description: Fee rate applied (if percentage)

    - name: fee_amount
      type: decimal
      precision: 15
      scale: 2
      required: true
      description: Calculated fee amount

    - name: tax_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: VAT or tax on fee

    - name: total_amount
      type: decimal
      precision: 15
      scale: 2
      computed: "fee_amount + tax_amount"
      description: Total fee including tax

    - name: calculation_method
      type: enum
      values: [percentage, flat, tiered, hybrid]
      default: percentage
      description: How fee was calculated

    # Timing
    - name: fee_period_start
      type: date
      description: Period start for recurring fees

    - name: fee_period_end
      type: date
      description: Period end for recurring fees

    - name: billing_date
      type: date
      indexed: true
      description: Date fee was billed

    - name: due_date
      type: date
      description: Payment due date

    # Collection Status
    - name: status
      type: enum
      values: [pending, invoiced, collected, waived, written_off, refunded]
      default: pending
      indexed: true
      description: Collection status

    - name: collection_method
      type: enum
      values: [deducted, invoiced, auto_debit, manual]
      description: How fee is collected

    - name: collected_at
      type: timestamp
      description: When fee was collected

    - name: collected_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Amount actually collected

    # Waiver Details
    - name: waived
      type: boolean
      default: false
      description: Whether fee was waived

    - name: waived_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Amount waived

    - name: waiver_reason
      type: enum
      values: [promotion, customer_service, error_correction, goodwill, first_time, loyalty]
      description: Reason for waiver

    - name: waived_by
      type: uuid
      references: users.id
      description: Who approved waiver

    - name: waived_at
      type: timestamp
      description: When waiver was approved

    # Discount Details
    - name: discount_applied
      type: boolean
      default: false
      description: Whether discount applied

    - name: discount_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Discount amount

    - name: discount_code
      type: string
      max_length: 50
      description: Promotion code if used

    - name: original_amount
      type: decimal
      precision: 15
      scale: 2
      description: Original fee before discount

    # Refund Details
    - name: refunded
      type: boolean
      default: false
      description: Whether fee was refunded

    - name: refund_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Amount refunded

    - name: refund_reason
      type: string
      max_length: 500
      description: Reason for refund

    - name: refunded_at
      type: timestamp
      description: When refunded

    # Revenue Recognition
    - name: recognized
      type: boolean
      default: false
      description: Whether revenue recognized

    - name: recognition_date
      type: date
      description: Revenue recognition date

    - name: gl_account
      type: string
      max_length: 20
      description: General ledger account

    # Notes
    - name: description
      type: string
      max_length: 500
      description: Fee description

    - name: notes
      type: text
      description: Internal notes

    # Timestamps
    - name: created_at
      type: timestamp
      default: now()
      indexed: true
      description: When fee was created

    - name: updated_at
      type: timestamp
      default: now()
      on_update: now()
      description: Last update time

  # ---------------------------------------------------------------------------
  # RELATIONSHIPS
  # ---------------------------------------------------------------------------
  relationships:
    - name: loan
      type: belongs_to
      entity: Loan
      foreign_key: loan_id

    - name: borrower
      type: belongs_to
      entity: Borrower
      foreign_key: borrower_id

    - name: investor
      type: belongs_to
      entity: Investor
      foreign_key: investor_id

    - name: repayment
      type: belongs_to
      entity: Repayment
      foreign_key: repayment_id

    - name: investment
      type: belongs_to
      entity: Investment
      foreign_key: investment_id

  # ---------------------------------------------------------------------------
  # INDEXES
  # ---------------------------------------------------------------------------
  indexes:
    - name: idx_fees_type
      columns: [fee_type]

    - name: idx_fees_category
      columns: [fee_category]

    - name: idx_fees_loan
      columns: [loan_id]

    - name: idx_fees_borrower
      columns: [borrower_id]

    - name: idx_fees_investor
      columns: [investor_id]

    - name: idx_fees_status
      columns: [status]

    - name: idx_fees_billing_date
      columns: [billing_date]

# =============================================================================
# FEE SCHEDULE
# =============================================================================
fee_schedule:
  borrower_fees:
    origination_fee:
      name: Origination Fee
      name_vi: Phí khởi tạo khoản vay
      description: One-time fee charged when loan is disbursed
      calculation: percentage
      rates:
        grade_A: 2.0
        grade_B: 2.5
        grade_C: 3.0
        grade_D: 3.5
        grade_E: 4.0
        grade_F: 4.5
      base: loan_principal
      timing: disbursement
      collection: deducted_from_disbursement
      min_amount: 100000
      max_amount: null

    late_payment_fee:
      name: Late Payment Fee
      name_vi: Phí thanh toán trễ
      description: Fee for payments made after grace period
      calculation: percentage
      rate: 0.5
      base: overdue_amount
      per_day: true
      max_rate: 15.0
      timing: payment
      collection: added_to_payment
      grace_period_days: 3

    early_payoff_fee:
      name: Early Payoff Fee
      name_vi: Phí tất toán sớm
      description: Fee for paying off loan early
      calculation: percentage
      rate: 1.0
      base: remaining_principal
      timing: payoff
      collection: deducted_from_payoff
      waived_after_months: 6

  investor_fees:
    service_fee:
      name: Service Fee
      name_vi: Phí dịch vụ
      description: Fee on interest earnings
      calculation: percentage
      rate: 1.0
      base: interest_received
      timing: each_payment
      collection: deducted_from_distribution

    withdrawal_fee:
      name: Withdrawal Fee
      name_vi: Phí rút tiền
      description: Fee for withdrawing funds
      calculation: tiered
      tiers:
        - min: 0
          max: 10000000
          amount: 0
        - min: 10000001
          max: 100000000
          amount: 11000
        - min: 100000001
          max: null
          rate: 0.011
      timing: withdrawal
      collection: deducted_from_withdrawal
      free_withdrawals_monthly: 2

    secondary_market_fee:
      name: Secondary Market Fee
      name_vi: Phí giao dịch thứ cấp
      description: Fee for selling investments
      calculation: percentage
      rate: 1.0
      base: sale_amount
      timing: sale
      collection: deducted_from_proceeds

  transaction_fees:
    deposit_fee:
      name: Deposit Fee
      name_vi: Phí nạp tiền
      description: Fee for depositing funds
      calculation: flat
      amount: 0
      note: "Free deposits"

    bank_transfer_fee:
      name: Bank Transfer Fee
      name_vi: Phí chuyển khoản
      description: Fee for outgoing bank transfers
      calculation: tiered
      tiers:
        - method: same_bank
          amount: 0
        - method: napas
          amount: 5500
        - method: citad
          amount: 11000
      timing: transfer
      collection: deducted_from_amount

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  calculation:
    - rule: "All fees calculated to 2 decimal places"
      enforcement: system

    - rule: "VAT 10% applied to all platform fees"
      enforcement: system

    - rule: "Minimum fee thresholds apply"
      enforcement: system

  collection:
    - rule: "Borrower fees collected at point of transaction"
      enforcement: system

    - rule: "Investor fees deducted from distributions"
      enforcement: system

    - rule: "Failed collection retried 3 times"
      enforcement: system

  waiver:
    - rule: "Waiver requires approval for > 100,000 VND"
      enforcement: workflow

    - rule: "Maximum waiver 100% of fee"
      enforcement: system

    - rule: "First-time borrower origination discount 20%"
      enforcement: promotion

  refund:
    - rule: "Refund within 30 days of collection"
      enforcement: policy

    - rule: "Refund requires manager approval"
      enforcement: workflow

# =============================================================================
# COMPUTED FIELDS
# =============================================================================
computed_fields:
  - name: net_collected
    formula: "collected_amount - refund_amount"

  - name: effective_rate
    formula: "(fee_amount / base_amount) * 100"

  - name: is_fully_collected
    formula: "collected_amount >= total_amount"

# =============================================================================
# REPORTING AGGREGATIONS
# =============================================================================
reporting:
  dimensions:
    - fee_type
    - fee_category
    - status
    - billing_date
    - loan_id
    - borrower_id
    - investor_id

  metrics:
    - total_billed: "SUM(total_amount)"
    - total_collected: "SUM(collected_amount)"
    - total_waived: "SUM(waived_amount)"
    - total_refunded: "SUM(refund_amount)"
    - collection_rate: "(total_collected / total_billed) * 100"
    - average_fee: "AVG(fee_amount)"

  standard_reports:
    - fee_summary_by_type
    - fee_collection_aging
    - waiver_analysis
    - revenue_recognition

# =============================================================================
# VALIDATION RULES
# =============================================================================
validations:
  - field: fee_amount
    rules:
      - min: 0
        message: "Fee amount cannot be negative"

  - field: waived_amount
    rules:
      - custom: "waived_amount <= fee_amount"
        message: "Waived amount cannot exceed fee amount"

  - field: refund_amount
    rules:
      - custom: "refund_amount <= collected_amount"
        message: "Refund cannot exceed collected amount"

# =============================================================================
# AUDIT CONFIGURATION
# =============================================================================
audit:
  enabled: true
  track_changes: true
  sensitive_fields:
    - borrower_id
    - investor_id
    - fee_amount
    - collected_amount
  retention_years: 10
