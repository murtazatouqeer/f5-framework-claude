name: Repayment
display_name: Repayment / Thanh toán
description: |
  Repayment entity tracking individual loan payments including
  principal, interest, fees, and distribution to investors.

domain: fintech
sub_domain: p2p-lending
version: "1.0"
status: active

# =============================================================================
# ENTITY DEFINITION
# =============================================================================
entity:
  name: Repayment
  name_vi: Thanh toán
  table_name: repayments

  primary_key: id
  natural_key: repayment_reference

  # ---------------------------------------------------------------------------
  # ATTRIBUTES
  # ---------------------------------------------------------------------------
  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true
      description: Unique repayment identifier

    - name: repayment_reference
      type: string
      format: "REP-YYYYMM-XXXXXX"
      unique: true
      indexed: true
      description: Human-readable repayment reference
      example: "REP-202501-000001"

    # References
    - name: loan_id
      type: uuid
      required: true
      references: loans.id
      indexed: true
      description: The loan being repaid

    - name: borrower_id
      type: uuid
      required: true
      references: borrowers.id
      indexed: true
      description: The borrower making payment

    - name: schedule_id
      type: uuid
      references: repayment_schedules.id
      description: Associated scheduled payment

    # Payment Details
    - name: payment_date
      type: date
      required: true
      indexed: true
      description: Date payment was received

    - name: payment_time
      type: timestamp
      required: true
      description: Exact timestamp of payment

    - name: due_date
      type: date
      description: Original due date for this payment

    - name: installment_number
      type: integer
      description: Which installment this covers

    # Amount Breakdown
    - name: total_amount
      type: decimal
      precision: 15
      scale: 2
      required: true
      description: Total payment amount in VND

    - name: principal_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Principal portion of payment

    - name: interest_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Interest portion of payment

    - name: fee_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Fee portion (late fees, etc.)

    - name: penalty_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Penalty amount charged

    - name: prepayment_penalty
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Early payoff penalty if applicable

    # Payment Status
    - name: status
      type: enum
      values: [pending, processing, completed, failed, reversed, partial]
      default: pending
      indexed: true
      description: Payment processing status

    - name: failure_reason
      type: string
      max_length: 500
      description: Reason for failure if applicable

    # Payment Timing
    - name: payment_status
      type: enum
      values: [on_time, grace_period, late, very_late]
      indexed: true
      description: Whether payment was on time

    - name: days_past_due
      type: integer
      default: 0
      description: Days past due when payment received

    - name: is_late
      type: boolean
      default: false
      indexed: true
      description: Whether this was a late payment

    # Payment Method
    - name: payment_method
      type: enum
      values: [bank_transfer, auto_debit, manual, cash, wallet, card]
      required: true
      description: Method of payment

    - name: payment_channel
      type: enum
      values: [mobile_app, web, bank, agent, auto]
      description: Channel through which payment made

    - name: bank_reference
      type: string
      max_length: 100
      description: Bank transaction reference

    - name: source_account
      type: string
      max_length: 50
      description: Account payment originated from

    # Distribution Status
    - name: distributed
      type: boolean
      default: false
      indexed: true
      description: Whether distributed to investors

    - name: distribution_date
      type: timestamp
      description: When distributed to investors

    - name: distribution_reference
      type: string
      max_length: 100
      description: Distribution batch reference

    # Investor Distribution Summary
    - name: investor_principal
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Principal distributed to investors

    - name: investor_interest
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Interest distributed to investors

    - name: platform_fee
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Platform fee deducted

    - name: provision_contribution
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Contribution to provision fund

    # Balances After Payment
    - name: principal_balance_after
      type: decimal
      precision: 15
      scale: 2
      description: Principal balance after this payment

    - name: total_balance_after
      type: decimal
      precision: 15
      scale: 2
      description: Total balance after this payment

    # Payment Type
    - name: payment_type
      type: enum
      values: [scheduled, extra, prepayment, full_payoff, recovery, manual_adjustment]
      default: scheduled
      indexed: true
      description: Type of payment

    - name: is_prepayment
      type: boolean
      default: false
      description: Whether this is an early/extra payment

    - name: is_final_payment
      type: boolean
      default: false
      description: Whether this closes the loan

    # Reconciliation
    - name: reconciled
      type: boolean
      default: false
      description: Whether reconciled with bank

    - name: reconciliation_date
      type: date
      description: When reconciled

    - name: reconciliation_reference
      type: string
      max_length: 100
      description: Reconciliation reference

    # Auto-Debit Details
    - name: auto_debit_attempt
      type: integer
      default: 0
      description: Auto-debit attempt number

    - name: auto_debit_mandate_id
      type: uuid
      description: Associated auto-debit mandate

    # Notes
    - name: internal_notes
      type: text
      description: Internal notes about payment

    - name: external_notes
      type: text
      description: Notes visible to borrower

    # Timestamps
    - name: created_at
      type: timestamp
      default: now()
      description: When record was created

    - name: updated_at
      type: timestamp
      default: now()
      on_update: now()
      description: Last update time

    - name: processed_at
      type: timestamp
      description: When payment was processed

  # ---------------------------------------------------------------------------
  # RELATIONSHIPS
  # ---------------------------------------------------------------------------
  relationships:
    - name: loan
      type: belongs_to
      entity: Loan
      foreign_key: loan_id

    - name: borrower
      type: belongs_to
      entity: Borrower
      foreign_key: borrower_id

    - name: schedule
      type: belongs_to
      entity: RepaymentSchedule
      foreign_key: schedule_id

    - name: investor_distributions
      type: has_many
      entity: InvestmentRepayment
      foreign_key: repayment_id

    - name: transactions
      type: has_many
      entity: Transaction
      foreign_key: repayment_id

  # ---------------------------------------------------------------------------
  # INDEXES
  # ---------------------------------------------------------------------------
  indexes:
    - name: idx_repayments_loan
      columns: [loan_id]

    - name: idx_repayments_borrower
      columns: [borrower_id]

    - name: idx_repayments_date
      columns: [payment_date]

    - name: idx_repayments_status
      columns: [status]

    - name: idx_repayments_distributed
      columns: [distributed]
      where: "status = 'completed' AND distributed = false"

    - name: idx_repayments_late
      columns: [is_late, loan_id]
      where: "is_late = true"

# =============================================================================
# STATE MACHINE
# =============================================================================
state_machine:
  initial_state: pending

  states:
    pending:
      description: Payment initiated, awaiting processing
      name_vi: Đang chờ
      allowed_actions: [process, cancel]

    processing:
      description: Payment being processed
      name_vi: Đang xử lý
      allowed_actions: [complete, fail]

    completed:
      description: Payment successfully processed
      name_vi: Hoàn thành
      allowed_actions: [distribute, reverse]

    failed:
      description: Payment failed
      name_vi: Thất bại
      allowed_actions: [retry]
      terminal: true

    reversed:
      description: Payment reversed
      name_vi: Đã đảo ngược
      terminal: true

    partial:
      description: Partial payment received
      name_vi: Thanh toán một phần
      allowed_actions: [complete_remaining]

  transitions:
    - from: pending
      to: processing
      event: process
      actions:
        - validate_payment
        - initiate_transfer

    - from: pending
      to: failed
      event: cancel
      actions:
        - log_cancellation

    - from: processing
      to: completed
      event: complete
      actions:
        - update_loan_balance
        - calculate_distribution
        - update_borrower_history
        - send_receipt

    - from: processing
      to: failed
      event: fail
      actions:
        - record_failure
        - notify_borrower
        - schedule_retry

    - from: processing
      to: partial
      event: partial_received
      actions:
        - apply_partial_payment
        - notify_remaining_due

    - from: completed
      to: reversed
      event: reverse
      actions:
        - undo_distribution
        - restore_loan_balance
        - notify_parties

    - from: failed
      to: pending
      event: retry
      condition: "retry_count < max_retries"
      actions:
        - increment_retry_count
        - reinitiate_payment

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  payment_application:
    - rule: "Fees applied first, then interest, then principal"
      enforcement: system
      order: [fee, penalty, interest, principal]

    - rule: "Late fees applied if payment after grace period"
      enforcement: system
      grace_days: 3

    - rule: "Minimum payment must cover at least interest"
      enforcement: system

  distribution:
    - rule: "Distribution within 24 hours of cleared payment"
      enforcement: sla

    - rule: "Platform fee deducted before investor distribution"
      enforcement: system

    - rule: "Provision fund contribution per policy"
      enforcement: system

  timing:
    - rule: "Grace period: 3 days after due date"
      enforcement: system

    - rule: "Late fee: 0.5% per day after grace period"
      enforcement: system
      max_days: 30
      max_percentage: 15

# =============================================================================
# COMPUTED FIELDS
# =============================================================================
computed_fields:
  - name: late_fee_calculated
    formula: |
      IF days_past_due > 3 THEN
        MIN(total_amount * 0.005 * (days_past_due - 3), total_amount * 0.15)
      ELSE 0

  - name: net_to_investors
    formula: "total_amount - platform_fee - provision_contribution - penalty_amount"

  - name: is_on_time
    formula: "payment_date <= due_date + INTERVAL '3 days'"

# =============================================================================
# VALIDATION RULES
# =============================================================================
validations:
  - field: total_amount
    rules:
      - min: 1
        message: "Payment amount must be positive"

  - field: payment_date
    rules:
      - not_future: true
        message: "Payment date cannot be in the future"

  - field: component_sum
    rules:
      - custom: "principal_amount + interest_amount + fee_amount + penalty_amount <= total_amount"
        message: "Component amounts cannot exceed total amount"

# =============================================================================
# AUDIT CONFIGURATION
# =============================================================================
audit:
  enabled: true
  track_changes: true
  sensitive_fields:
    - borrower_id
    - bank_reference
    - source_account
  retention_years: 10
