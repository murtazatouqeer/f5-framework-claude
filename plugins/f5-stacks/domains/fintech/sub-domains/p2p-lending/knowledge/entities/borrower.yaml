name: Borrower
display_name: Borrower / Người vay
description: |
  Borrower profile entity containing verified personal information,
  credit history, employment details, and borrowing track record.

domain: fintech
sub_domain: p2p-lending
version: "1.0"
status: active

# =============================================================================
# ENTITY DEFINITION
# =============================================================================
entity:
  name: Borrower
  name_vi: Người vay
  table_name: borrowers

  primary_key: id
  natural_key: borrower_number

  # ---------------------------------------------------------------------------
  # ATTRIBUTES
  # ---------------------------------------------------------------------------
  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true
      description: Unique borrower identifier

    - name: borrower_number
      type: string
      format: "BRW-XXXXXX"
      unique: true
      indexed: true
      description: Human-readable borrower number
      example: "BRW-000001"

    - name: user_id
      type: uuid
      required: true
      references: users.id
      unique: true
      description: Associated user account

    # Personal Information
    - name: full_name
      type: string
      max_length: 200
      required: true
      description: Full legal name

    - name: date_of_birth
      type: date
      required: true
      description: Date of birth

    - name: gender
      type: enum
      values: [male, female, other]
      description: Gender

    - name: nationality
      type: string
      default: "VN"
      description: Nationality code

    - name: marital_status
      type: enum
      values: [single, married, divorced, widowed]
      description: Marital status

    - name: number_of_dependents
      type: integer
      default: 0
      description: Number of financial dependents

    # Identity Documents
    - name: id_type
      type: enum
      values: [national_id, passport, driver_license]
      required: true
      description: Primary ID document type

    - name: id_number
      type: string
      max_length: 50
      required: true
      encrypted: true
      description: ID document number

    - name: id_issued_date
      type: date
      description: ID document issue date

    - name: id_expiry_date
      type: date
      description: ID document expiry date

    - name: id_issued_place
      type: string
      max_length: 200
      description: Where ID was issued

    - name: tax_id
      type: string
      max_length: 20
      encrypted: true
      description: Tax identification number

    # Contact Information
    - name: email
      type: string
      format: email
      required: true
      indexed: true
      description: Primary email address

    - name: phone_number
      type: string
      max_length: 20
      required: true
      description: Primary phone number

    - name: phone_verified
      type: boolean
      default: false
      description: Whether phone is verified

    - name: email_verified
      type: boolean
      default: false
      description: Whether email is verified

    # Address - Current
    - name: current_address
      type: string
      max_length: 500
      description: Current residential address

    - name: current_city
      type: string
      max_length: 100
      description: Current city/province

    - name: current_district
      type: string
      max_length: 100
      description: Current district

    - name: current_ward
      type: string
      max_length: 100
      description: Current ward

    - name: address_duration_months
      type: integer
      description: Months at current address

    - name: residence_type
      type: enum
      values: [owned, rented, family, company_provided]
      description: Type of residence

    # Address - Permanent
    - name: permanent_address
      type: string
      max_length: 500
      description: Permanent registered address

    - name: same_as_current
      type: boolean
      default: false
      description: Whether permanent equals current

    # Employment Information
    - name: employment_status
      type: enum
      values: [employed, self_employed, business_owner, freelancer, retired, student, unemployed]
      required: true
      description: Current employment status

    - name: employer_name
      type: string
      max_length: 200
      description: Current employer name

    - name: employer_industry
      type: string
      max_length: 100
      description: Employer's industry

    - name: job_title
      type: string
      max_length: 100
      description: Current job title

    - name: employment_start_date
      type: date
      description: Start date at current employer

    - name: employment_type
      type: enum
      values: [full_time, part_time, contract, seasonal]
      description: Type of employment

    - name: employer_phone
      type: string
      max_length: 20
      description: Employer contact number

    - name: employer_address
      type: string
      max_length: 500
      description: Employer address

    - name: employment_verified
      type: boolean
      default: false
      description: Whether employment is verified

    # Income Information
    - name: monthly_income
      type: decimal
      precision: 15
      scale: 2
      description: Monthly income in VND

    - name: income_source
      type: enum
      values: [salary, business, investment, rental, pension, other]
      description: Primary income source

    - name: additional_income
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Additional monthly income

    - name: additional_income_source
      type: string
      max_length: 200
      description: Source of additional income

    - name: income_verified
      type: boolean
      default: false
      description: Whether income is verified

    - name: income_verification_date
      type: date
      description: When income was last verified

    # Banking Information
    - name: primary_bank_name
      type: string
      max_length: 100
      description: Primary bank name

    - name: primary_bank_account
      type: string
      max_length: 50
      encrypted: true
      description: Primary bank account number

    - name: bank_account_verified
      type: boolean
      default: false
      description: Whether bank account is verified

    # Credit Profile
    - name: credit_score
      type: integer
      min: 300
      max: 850
      indexed: true
      description: Current credit score

    - name: credit_grade
      type: enum
      values: [A, B, C, D, E, F]
      indexed: true
      description: Current credit grade

    - name: credit_score_date
      type: date
      description: When credit score was last updated

    - name: external_credit_score
      type: integer
      description: Score from external bureau (CIC)

    - name: external_credit_date
      type: date
      description: When external score was obtained

    # Borrowing History
    - name: total_loans
      type: integer
      default: 0
      description: Total loans taken on platform

    - name: active_loans
      type: integer
      default: 0
      description: Currently active loans

    - name: completed_loans
      type: integer
      default: 0
      description: Successfully completed loans

    - name: defaulted_loans
      type: integer
      default: 0
      description: Loans that defaulted

    - name: total_borrowed
      type: decimal
      precision: 18
      scale: 2
      default: 0
      description: Total amount ever borrowed

    - name: current_outstanding
      type: decimal
      precision: 18
      scale: 2
      default: 0
      description: Current total outstanding

    - name: total_repaid
      type: decimal
      precision: 18
      scale: 2
      default: 0
      description: Total amount repaid

    # Payment Behavior
    - name: on_time_payment_rate
      type: decimal
      precision: 5
      scale: 2
      default: 100
      description: Percentage of on-time payments

    - name: total_payments_made
      type: integer
      default: 0
      description: Total number of payments made

    - name: late_payments_count
      type: integer
      default: 0
      description: Number of late payments

    - name: max_days_past_due
      type: integer
      default: 0
      description: Maximum DPD ever recorded

    # Risk Indicators
    - name: risk_flag
      type: boolean
      default: false
      description: Whether borrower is flagged for risk

    - name: risk_flag_reason
      type: string
      max_length: 500
      description: Reason for risk flag

    - name: watchlist_status
      type: enum
      values: [clear, monitoring, restricted, blocked]
      default: clear
      description: Watchlist status

    # Verification Status
    - name: kyc_status
      type: enum
      values: [pending, partial, verified, expired]
      default: pending
      indexed: true
      description: Overall KYC status

    - name: kyc_verified_date
      type: timestamp
      description: When KYC was verified

    - name: kyc_expiry_date
      type: date
      description: When KYC verification expires

    - name: liveness_verified
      type: boolean
      default: false
      description: Whether liveness check passed

    - name: face_match_score
      type: decimal
      precision: 5
      scale: 2
      description: Face match confidence score

    # Account Status
    - name: status
      type: enum
      values: [pending, active, suspended, blocked, inactive]
      default: pending
      indexed: true
      description: Borrower account status

    - name: status_reason
      type: string
      max_length: 500
      description: Reason for current status

    - name: eligible_to_borrow
      type: boolean
      default: false
      description: Whether eligible to apply for loans

    - name: max_borrowing_limit
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Maximum allowed borrowing limit

    - name: available_credit
      type: decimal
      precision: 15
      scale: 2
      computed: "max_borrowing_limit - current_outstanding"
      description: Available credit line

    # Preferences
    - name: preferred_language
      type: string
      default: "vi"
      description: Preferred communication language

    - name: notification_preferences
      type: jsonb
      description: Notification channel preferences

    # Timestamps
    - name: created_at
      type: timestamp
      default: now()
      description: When account was created

    - name: updated_at
      type: timestamp
      default: now()
      on_update: now()
      description: Last update time

    - name: last_login_at
      type: timestamp
      description: Last login time

    - name: first_loan_date
      type: date
      description: Date of first loan

    - name: last_loan_date
      type: date
      description: Date of most recent loan

  # ---------------------------------------------------------------------------
  # RELATIONSHIPS
  # ---------------------------------------------------------------------------
  relationships:
    - name: user
      type: belongs_to
      entity: User
      foreign_key: user_id

    - name: loan_applications
      type: has_many
      entity: LoanApplication
      foreign_key: borrower_id
      order_by: created_at desc

    - name: loans
      type: has_many
      entity: Loan
      foreign_key: borrower_id
      order_by: created_at desc

    - name: credit_scores
      type: has_many
      entity: CreditScore
      foreign_key: borrower_id
      order_by: created_at desc

    - name: repayments
      type: has_many
      entity: Repayment
      foreign_key: borrower_id
      order_by: payment_date desc

    - name: documents
      type: has_many
      entity: Document
      foreign_key: borrower_id

  # ---------------------------------------------------------------------------
  # INDEXES
  # ---------------------------------------------------------------------------
  indexes:
    - name: idx_borrowers_user
      columns: [user_id]
      unique: true

    - name: idx_borrowers_status
      columns: [status]

    - name: idx_borrowers_credit
      columns: [credit_score, credit_grade]

    - name: idx_borrowers_kyc
      columns: [kyc_status]

    - name: idx_borrowers_email
      columns: [email]

# =============================================================================
# STATE MACHINE
# =============================================================================
state_machine:
  initial_state: pending

  states:
    pending:
      description: Account created, KYC pending
      name_vi: Chờ xác minh
      allowed_actions: [submit_kyc, deactivate]

    active:
      description: Fully verified and active
      name_vi: Hoạt động
      allowed_actions: [apply_loan, update_profile, suspend]

    suspended:
      description: Temporarily suspended
      name_vi: Tạm khóa
      allowed_actions: [reactivate, block]

    blocked:
      description: Permanently blocked
      name_vi: Bị chặn
      terminal: true

    inactive:
      description: Voluntarily deactivated
      name_vi: Ngừng hoạt động
      allowed_actions: [reactivate]

  transitions:
    - from: pending
      to: active
      event: kyc_verified
      condition: "kyc_status = 'verified'"
      actions:
        - set_eligible_to_borrow
        - calculate_initial_limit
        - send_welcome

    - from: pending
      to: inactive
      event: deactivate
      actions:
        - log_deactivation

    - from: active
      to: suspended
      event: suspend
      actions:
        - freeze_applications
        - notify_borrower
        - log_suspension

    - from: active
      to: inactive
      event: deactivate
      condition: "active_loans = 0"
      actions:
        - revoke_eligibility
        - log_deactivation

    - from: suspended
      to: active
      event: reactivate
      condition: "suspension_resolved"
      actions:
        - unfreeze_applications
        - notify_borrower

    - from: suspended
      to: blocked
      event: block
      actions:
        - terminate_active_loans
        - notify_borrower
        - log_blocking

    - from: inactive
      to: active
      event: reactivate
      condition: "kyc_status = 'verified'"
      actions:
        - recalculate_limit
        - notify_borrower

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  eligibility:
    - rule: "Age must be 18-60 years"
      enforcement: system

    - rule: "KYC must be verified to borrow"
      enforcement: system

    - rule: "No active defaults allowed"
      enforcement: system

    - rule: "Maximum 2 concurrent loans"
      enforcement: system

  limits:
    - rule: "Initial borrowing limit based on income"
      formula: "monthly_income * 6"
      max: 500000000

    - rule: "Limit increases with successful repayments"
      formula: "base_limit * (1 + completed_loans * 0.1)"
      max_multiplier: 2.0

    - rule: "Limit decreases with late payments"
      formula: "current_limit * (on_time_payment_rate / 100)"

  verification:
    - rule: "Income must be re-verified every 12 months"
      enforcement: system

    - rule: "KYC expires after 24 months"
      enforcement: system

    - rule: "Phone number must be verified"
      enforcement: system

# =============================================================================
# COMPUTED FIELDS
# =============================================================================
computed_fields:
  - name: age
    formula: "YEAR(NOW()) - YEAR(date_of_birth)"

  - name: employment_duration_months
    formula: "DATEDIFF(MONTH, employment_start_date, NOW())"

  - name: repayment_rate
    formula: "(total_repaid / GREATEST(total_borrowed, 1)) * 100"

  - name: default_rate
    formula: "(defaulted_loans / GREATEST(total_loans, 1)) * 100"

# =============================================================================
# VALIDATION RULES
# =============================================================================
validations:
  - field: date_of_birth
    rules:
      - custom: "age_between(18, 60)"
        message: "Borrower must be between 18 and 60 years old"

  - field: monthly_income
    rules:
      - min: 5000000
        message: "Minimum monthly income is 5,000,000 VND"

  - field: email
    rules:
      - format: email
        message: "Invalid email format"

  - field: phone_number
    rules:
      - pattern: "^(0|84)[0-9]{9,10}$"
        message: "Invalid Vietnamese phone number"

# =============================================================================
# AUDIT CONFIGURATION
# =============================================================================
audit:
  enabled: true
  track_changes: true
  sensitive_fields:
    - id_number
    - tax_id
    - primary_bank_account
    - monthly_income
    - email
    - phone_number
    - current_address
  retention_years: 10
