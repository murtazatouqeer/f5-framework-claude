name: Card
display_name: Card / Thẻ ngân hàng
description: |
  Bank card entity representing debit, credit, and prepaid cards.
  Includes card lifecycle management, security features, limits,
  and transaction controls.

domain: fintech
sub_domain: banking
version: "1.0"
status: active

# =============================================================================
# ATTRIBUTES
# =============================================================================
attributes:
  # ---------------------------------------------------------------------------
  # Identity
  # ---------------------------------------------------------------------------
  id:
    type: uuid
    primary_key: true
    description: Unique card identifier

  card_number_masked:
    type: string
    format: "^\\*{12}[0-9]{4}$"
    description: Masked card number (last 4 digits visible)
    description_vi: Số thẻ đã che (chỉ hiện 4 số cuối)
    example: "************1234"

  card_token:
    type: string
    unique: true
    indexed: true
    encrypted: true
    description: Tokenized card number for secure storage
    description_vi: Mã token thẻ

  card_hash:
    type: string
    indexed: true
    description: Hash of full card number for lookup

  # ---------------------------------------------------------------------------
  # Relationships
  # ---------------------------------------------------------------------------
  account_id:
    type: uuid
    required: true
    indexed: true
    references: BankAccount
    description: Linked bank account

  account_holder_id:
    type: uuid
    required: true
    indexed: true
    references: AccountHolder
    description: Card holder

  # ---------------------------------------------------------------------------
  # Card Type & Brand
  # ---------------------------------------------------------------------------
  card_type:
    type: enum
    values: [debit, credit, prepaid]
    required: true
    description: Type of card
    description_vi: Loại thẻ
    value_descriptions:
      debit: "Linked to checking account / Thẻ ghi nợ"
      credit: "Credit line card / Thẻ tín dụng"
      prepaid: "Prepaid/Gift card / Thẻ trả trước"

  card_brand:
    type: enum
    values: [visa, mastercard, jcb, unionpay, napas]
    required: true
    description: Card network/brand
    description_vi: Thương hiệu thẻ

  card_tier:
    type: enum
    values: [standard, gold, platinum, signature, infinite]
    default: standard
    description: Card tier/level
    description_vi: Hạng thẻ
    value_descriptions:
      standard: "Basic card / Thẻ thường"
      gold: "Gold tier with perks / Thẻ vàng"
      platinum: "Platinum tier / Thẻ bạch kim"
      signature: "Signature/Premium / Thẻ Signature"
      infinite: "Top tier / Thẻ cao cấp nhất"

  card_program:
    type: string
    max_length: 50
    nullable: true
    description: Specific card program/product

  # ---------------------------------------------------------------------------
  # Status
  # ---------------------------------------------------------------------------
  status:
    type: enum
    values: [pending, inactive, active, blocked, expired, cancelled]
    default: pending
    indexed: true
    description: Card lifecycle status
    description_vi: Trạng thái thẻ
    value_descriptions:
      pending: "Card being produced / Đang sản xuất"
      inactive: "Issued but not activated / Chưa kích hoạt"
      active: "Active and usable / Đang hoạt động"
      blocked: "Temporarily blocked / Tạm khóa"
      expired: "Past expiry date / Hết hạn"
      cancelled: "Permanently cancelled / Đã hủy"

  # ---------------------------------------------------------------------------
  # Card Details
  # ---------------------------------------------------------------------------
  expiry_date:
    type: string
    format: "^(0[1-9]|1[0-2])/[0-9]{2}$"
    required: true
    description: Card expiry (MM/YY)
    description_vi: Ngày hết hạn

  expiry_month:
    type: integer
    minimum: 1
    maximum: 12

  expiry_year:
    type: integer
    minimum: 2024

  cvv_hash:
    type: string
    encrypted: true
    description: Hashed CVV for verification

  name_on_card:
    type: string
    max_length: 26
    required: true
    description: Embossed cardholder name
    description_vi: Tên in trên thẻ

  # ---------------------------------------------------------------------------
  # PIN Management
  # ---------------------------------------------------------------------------
  pin_set:
    type: boolean
    default: false
    description: Whether PIN has been set
    description_vi: Đã đặt mã PIN

  pin_hash:
    type: string
    encrypted: true
    nullable: true
    description: Hashed PIN

  pin_tries_remaining:
    type: integer
    default: 3
    description: Remaining PIN attempts before block

  pin_blocked:
    type: boolean
    default: false
    description: PIN blocked due to wrong attempts

  pin_last_changed_at:
    type: timestamp
    nullable: true

  # ---------------------------------------------------------------------------
  # Feature Toggles
  # ---------------------------------------------------------------------------
  contactless_enabled:
    type: boolean
    default: true
    description: Enable contactless/NFC payments
    description_vi: Bật thanh toán không tiếp xúc

  online_enabled:
    type: boolean
    default: true
    description: Enable online/e-commerce transactions
    description_vi: Bật giao dịch trực tuyến

  international_enabled:
    type: boolean
    default: false
    description: Enable international transactions
    description_vi: Bật giao dịch quốc tế

  atm_withdrawal_enabled:
    type: boolean
    default: true
    description: Enable ATM withdrawals

  pos_enabled:
    type: boolean
    default: true
    description: Enable POS transactions

  recurring_enabled:
    type: boolean
    default: true
    description: Enable recurring/subscription payments

  # ---------------------------------------------------------------------------
  # Limits
  # ---------------------------------------------------------------------------
  daily_limit:
    type: decimal
    precision: 18
    scale: 2
    default: 100000000
    description: Daily transaction limit
    description_vi: Hạn mức giao dịch/ngày

  daily_used:
    type: decimal
    precision: 18
    scale: 2
    default: 0
    description: Amount used today

  monthly_limit:
    type: decimal
    precision: 18
    scale: 2
    default: 500000000
    description: Monthly transaction limit
    description_vi: Hạn mức giao dịch/tháng

  monthly_used:
    type: decimal
    precision: 18
    scale: 2
    default: 0
    description: Amount used this month

  per_transaction_limit:
    type: decimal
    precision: 18
    scale: 2
    default: 50000000
    description: Per-transaction limit
    description_vi: Hạn mức mỗi giao dịch

  contactless_limit:
    type: decimal
    precision: 18
    scale: 2
    default: 1000000
    description: Contactless transaction limit (no PIN)
    description_vi: Hạn mức không tiếp xúc

  atm_daily_limit:
    type: decimal
    precision: 18
    scale: 2
    default: 30000000
    description: Daily ATM withdrawal limit
    description_vi: Hạn mức rút ATM/ngày

  atm_per_transaction_limit:
    type: decimal
    precision: 18
    scale: 2
    default: 10000000
    description: Per-transaction ATM limit

  # ---------------------------------------------------------------------------
  # Billing Address (for online transactions)
  # ---------------------------------------------------------------------------
  billing_address_line1:
    type: string
    max_length: 100
    nullable: true

  billing_address_line2:
    type: string
    max_length: 100
    nullable: true

  billing_city:
    type: string
    max_length: 50
    nullable: true

  billing_postal_code:
    type: string
    max_length: 20
    nullable: true

  billing_country:
    type: string
    format: "^[A-Z]{2}$"
    default: "VN"

  # ---------------------------------------------------------------------------
  # Card Issuance
  # ---------------------------------------------------------------------------
  issued_at:
    type: timestamp
    nullable: true
    description: When card was issued

  activated_at:
    type: timestamp
    nullable: true
    description: When card was activated

  delivery_address:
    type: json
    nullable: true
    description: Card delivery address

  delivery_method:
    type: enum
    values: [branch_pickup, courier, registered_mail]
    default: courier

  delivery_tracking_number:
    type: string
    max_length: 50
    nullable: true

  # ---------------------------------------------------------------------------
  # Block/Cancel Info
  # ---------------------------------------------------------------------------
  blocked_at:
    type: timestamp
    nullable: true

  blocked_reason:
    type: enum
    values: [lost, stolen, fraud_suspected, customer_request, pin_blocked, compliance]
    nullable: true
    description: Reason for blocking

  blocked_by:
    type: string
    nullable: true
    description: Who blocked the card (user/system/admin)

  cancelled_at:
    type: timestamp
    nullable: true

  cancellation_reason:
    type: string
    nullable: true

  # ---------------------------------------------------------------------------
  # Replacement
  # ---------------------------------------------------------------------------
  replacement_for:
    type: uuid
    nullable: true
    references: Card
    description: Card ID being replaced

  replaced_by:
    type: uuid
    nullable: true
    references: Card
    description: Replacement card ID

  renewal_count:
    type: integer
    default: 0
    description: Number of renewals/replacements

  # ---------------------------------------------------------------------------
  # Timestamps
  # ---------------------------------------------------------------------------
  created_at:
    type: timestamp
    auto: true

  updated_at:
    type: timestamp
    auto: true

# =============================================================================
# RELATIONSHIPS
# =============================================================================
relationships:
  account:
    type: belongs_to
    entity: BankAccount
    foreign_key: account_id

  account_holder:
    type: belongs_to
    entity: AccountHolder
    foreign_key: account_holder_id

  transactions:
    type: has_many
    entity: CardTransaction
    foreign_key: card_id

  replaced_card:
    type: belongs_to
    entity: Card
    foreign_key: replacement_for
    description: Previous card that was replaced

  replacement_card:
    type: has_one
    entity: Card
    foreign_key: replaced_by
    description: New card replacing this one

# =============================================================================
# STATE MACHINE
# =============================================================================
state_machine:
  field: status
  initial: pending

  states:
    pending:
      description: "Card production in progress"
      allowed_operations: [view, cancel]

    inactive:
      description: "Card delivered but not activated"
      allowed_operations: [view, activate, cancel]

    active:
      description: "Card is active and usable"
      allowed_operations: [view, transact, block, update_settings]

    blocked:
      description: "Card temporarily blocked"
      allowed_operations: [view, unblock, cancel, replace]

    expired:
      description: "Card has expired"
      allowed_operations: [view, replace]

    cancelled:
      description: "Card permanently cancelled"
      allowed_operations: [view]

  transitions:
    - from: pending
      to: inactive
      event: deliver
      actions:
        - "Send delivery notification"

    - from: inactive
      to: active
      event: activate
      conditions:
        - "PIN has been set"
        - "Activation within 90 days of issuance"
      actions:
        - "Enable all configured features"
        - "Send activation confirmation"

    - from: active
      to: blocked
      event: block
      conditions:
        - "Valid block reason provided"
      actions:
        - "Decline all pending transactions"
        - "Send block notification"

    - from: blocked
      to: active
      event: unblock
      conditions:
        - "Block reason resolved"
        - "Not blocked for fraud/compliance"
      actions:
        - "Restore card functionality"
        - "Send unblock notification"

    - from: active
      to: expired
      event: expire
      conditions:
        - "Current date > expiry date"
      actions:
        - "Block all transactions"
        - "Trigger auto-renewal if eligible"

    - from: [pending, inactive, active, blocked, expired]
      to: cancelled
      event: cancel
      actions:
        - "Permanently disable card"
        - "Send cancellation confirmation"

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  - id: BR-CRD-001
    name: PIN Required for Activation
    description: Card must have PIN set before activation
    description_vi: Phải đặt mã PIN trước khi kích hoạt
    rule: |
      IF action = 'activate' THEN pin_set = true

  - id: BR-CRD-002
    name: PIN Block After Failed Attempts
    description: Block PIN after 3 consecutive wrong attempts
    description_vi: Khóa PIN sau 3 lần nhập sai liên tiếp
    rule: |
      IF pin_tries_remaining = 0 THEN
        pin_blocked = true
        status = 'blocked'
        blocked_reason = 'pin_blocked'

  - id: BR-CRD-003
    name: Auto-Renewal Before Expiry
    description: Issue replacement card 30 days before expiry
    description_vi: Phát hành thẻ thay thế 30 ngày trước khi hết hạn
    rule: |
      IF expiry_date - 30 days <= NOW() AND status = 'active'
      THEN trigger_renewal_process()

  - id: BR-CRD-004
    name: Contactless Limit
    description: Contactless requires PIN above limit
    description_vi: Thanh toán không tiếp xúc yêu cầu PIN khi vượt hạn mức
    rule: |
      IF transaction_type = 'contactless' AND amount > contactless_limit
      THEN require_pin = true

  - id: BR-CRD-005
    name: International Transaction Control
    description: International disabled by default
    description_vi: Giao dịch quốc tế mặc định tắt
    rule: |
      IF transaction_country != card_country AND international_enabled = false
      THEN decline_transaction('INTERNATIONAL_DISABLED')

  - id: BR-CRD-006
    name: Daily Limit Reset
    description: Reset daily used amount at midnight
    rule: |
      AT 00:00 daily: daily_used = 0

  - id: BR-CRD-007
    name: Monthly Limit Reset
    description: Reset monthly used amount on 1st
    rule: |
      AT 00:00 on day 1 of month: monthly_used = 0

  - id: BR-CRD-008
    name: 3D Secure Requirement
    description: Online transactions require 3DS
    description_vi: Giao dịch trực tuyến yêu cầu 3D Secure
    rule: |
      IF transaction_type = 'online' AND merchant_enrolled_3ds
      THEN require_3ds_verification()

# =============================================================================
# INDEXES
# =============================================================================
indexes:
  - name: idx_card_account
    fields: [account_id]

  - name: idx_card_holder
    fields: [account_holder_id]

  - name: idx_card_token
    fields: [card_token]
    unique: true

  - name: idx_card_status
    fields: [status]

  - name: idx_card_expiry
    fields: [expiry_year, expiry_month]

  - name: idx_card_hash
    fields: [card_hash]

# =============================================================================
# AUDIT
# =============================================================================
audit:
  enabled: true
  events:
    - card_issued
    - card_activated
    - card_blocked
    - card_unblocked
    - card_expired
    - card_cancelled
    - card_replaced
    - pin_set
    - pin_changed
    - pin_blocked
    - pin_reset
    - limit_changed
    - feature_toggled
