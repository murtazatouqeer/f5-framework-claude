name: Beneficiary
display_name: Beneficiary / Người thụ hưởng
description: |
  Saved transfer recipient for quick and secure fund transfers.
  Includes verification status, transfer history, and security
  controls for new beneficiary cooling periods.

domain: fintech
sub_domain: banking
version: "1.0"
status: active

# =============================================================================
# ATTRIBUTES
# =============================================================================
attributes:
  # ---------------------------------------------------------------------------
  # Identity
  # ---------------------------------------------------------------------------
  id:
    type: uuid
    primary_key: true
    description: Unique beneficiary identifier

  account_holder_id:
    type: uuid
    required: true
    indexed: true
    references: AccountHolder
    description: Owner who saved this beneficiary

  # ---------------------------------------------------------------------------
  # Beneficiary Details
  # ---------------------------------------------------------------------------
  nickname:
    type: string
    max_length: 50
    nullable: true
    description: Customer-defined nickname
    description_vi: Tên gợi nhớ
    example: "Rent Payment", "Mom"

  recipient_name:
    type: string
    max_length: 100
    required: true
    description: Recipient's full name
    description_vi: Tên người nhận

  beneficiary_type:
    type: enum
    values: [individual, company]
    default: individual
    description: Type of beneficiary
    description_vi: Loại người thụ hưởng

  # ---------------------------------------------------------------------------
  # Account Information
  # ---------------------------------------------------------------------------
  account_number:
    type: string
    max_length: 34
    required: true
    indexed: true
    description: Recipient's account number
    description_vi: Số tài khoản người nhận

  account_type:
    type: enum
    values: [checking, savings]
    default: checking
    description: Type of recipient account

  bank_code:
    type: string
    max_length: 11
    required: true
    indexed: true
    description: Bank code (BIC/SWIFT or local code)
    description_vi: Mã ngân hàng

  bank_name:
    type: string
    max_length: 100
    required: true
    description: Bank name
    description_vi: Tên ngân hàng

  branch_code:
    type: string
    max_length: 10
    nullable: true
    description: Branch code if required
    description_vi: Mã chi nhánh

  branch_name:
    type: string
    max_length: 100
    nullable: true
    description: Branch name

  # ---------------------------------------------------------------------------
  # Location (for international)
  # ---------------------------------------------------------------------------
  country:
    type: string
    format: "^[A-Z]{2}$"
    default: "VN"
    description: Beneficiary's country (ISO 3166-1)
    description_vi: Quốc gia

  city:
    type: string
    max_length: 50
    nullable: true
    description: Beneficiary's city

  address:
    type: string
    max_length: 200
    nullable: true
    description: Beneficiary's address (for international)

  # ---------------------------------------------------------------------------
  # Currency
  # ---------------------------------------------------------------------------
  currency:
    type: string
    format: "^[A-Z]{3}$"
    default: "VND"
    description: Preferred currency
    description_vi: Loại tiền

  # ---------------------------------------------------------------------------
  # Status & Verification
  # ---------------------------------------------------------------------------
  status:
    type: enum
    values: [active, suspended, deleted]
    default: active
    indexed: true
    description: Beneficiary status
    description_vi: Trạng thái

  verification_status:
    type: enum
    values: [unverified, pending, verified, failed]
    default: unverified
    indexed: true
    description: Account verification status
    description_vi: Trạng thái xác minh
    value_descriptions:
      unverified: "Not yet verified / Chưa xác minh"
      pending: "Verification in progress / Đang xác minh"
      verified: "Verified successfully / Đã xác minh"
      failed: "Verification failed / Xác minh thất bại"

  verification_method:
    type: enum
    values: [micro_deposit, name_match, bank_lookup, manual]
    nullable: true
    description: How beneficiary was verified

  verified_at:
    type: timestamp
    nullable: true
    description: When verification completed

  verified_name:
    type: string
    max_length: 100
    nullable: true
    description: Name returned by verification

  # ---------------------------------------------------------------------------
  # Transfer Type
  # ---------------------------------------------------------------------------
  transfer_type:
    type: enum
    values: [internal, domestic, international]
    required: true
    indexed: true
    description: Type of transfers to this beneficiary
    description_vi: Loại chuyển khoản

  is_same_bank:
    type: boolean
    default: false
    description: Whether beneficiary is at same bank

  # ---------------------------------------------------------------------------
  # Usage Statistics
  # ---------------------------------------------------------------------------
  transfer_count:
    type: integer
    default: 0
    description: Number of transfers made
    description_vi: Số lần chuyển

  total_transferred:
    type: decimal
    precision: 18
    scale: 2
    default: 0
    description: Total amount transferred
    description_vi: Tổng số tiền đã chuyển

  last_transfer_at:
    type: timestamp
    nullable: true
    description: Last transfer timestamp

  last_transfer_amount:
    type: decimal
    precision: 18
    scale: 2
    nullable: true
    description: Amount of last transfer

  average_transfer_amount:
    type: decimal
    precision: 18
    scale: 2
    nullable: true
    description: Average transfer amount

  # ---------------------------------------------------------------------------
  # Security
  # ---------------------------------------------------------------------------
  cooling_period_end:
    type: timestamp
    nullable: true
    indexed: true
    description: End of cooling period for new beneficiary
    description_vi: Thời điểm kết thúc thời gian chờ

  is_trusted:
    type: boolean
    default: false
    description: Trusted beneficiary (no extra verification)
    description_vi: Người nhận đáng tin cậy

  trusted_at:
    type: timestamp
    nullable: true
    description: When marked as trusted

  # ---------------------------------------------------------------------------
  # Additional Info
  # ---------------------------------------------------------------------------
  email:
    type: string
    format: email
    nullable: true
    description: Beneficiary's email for notifications

  phone:
    type: string
    max_length: 20
    nullable: true
    description: Beneficiary's phone number

  notes:
    type: string
    max_length: 500
    nullable: true
    description: Personal notes about beneficiary
    description_vi: Ghi chú

  # ---------------------------------------------------------------------------
  # Timestamps
  # ---------------------------------------------------------------------------
  created_at:
    type: timestamp
    auto: true

  updated_at:
    type: timestamp
    auto: true

  deleted_at:
    type: timestamp
    nullable: true
    description: Soft delete timestamp

# =============================================================================
# RELATIONSHIPS
# =============================================================================
relationships:
  account_holder:
    type: belongs_to
    entity: AccountHolder
    foreign_key: account_holder_id

  transfers:
    type: has_many
    entity: Transfer
    foreign_key: beneficiary_id
    description: Transfers to this beneficiary

  standing_orders:
    type: has_many
    entity: StandingOrder
    foreign_key: beneficiary_id
    description: Standing orders for this beneficiary

# =============================================================================
# STATE MACHINE
# =============================================================================
state_machine:
  field: status
  initial: active

  states:
    active:
      description: "Beneficiary available for transfers"
      allowed_operations: [transfer, modify, delete, trust]

    suspended:
      description: "Temporarily suspended"
      allowed_operations: [reactivate, delete]

    deleted:
      description: "Soft deleted"
      final: true

  transitions:
    - from: active
      to: suspended
      event: suspend
      actions:
        - "Block transfers"
        - "Record reason"

    - from: suspended
      to: active
      event: reactivate
      actions:
        - "Enable transfers"

    - from: [active, suspended]
      to: deleted
      event: delete
      actions:
        - "Soft delete"
        - "Cancel standing orders"

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  - id: BR-BEN-001
    name: First Transfer OTP
    description: First transfer to new beneficiary requires OTP
    description_vi: Chuyển lần đầu cho người nhận mới cần OTP
    rule: |
      IF transfer_count = 0
      THEN require_otp = true

  - id: BR-BEN-002
    name: Cooling Period
    description: 24-hour cooling period for new beneficiaries with large amounts
    description_vi: Thời gian chờ 24h cho người nhận mới với số tiền lớn
    rule: |
      IF created_at > NOW() - 24 hours
      AND transfer_amount > 50_000_000 VND
      THEN block_transfer('COOLING_PERIOD')

  - id: BR-BEN-003
    name: Verification Requirement
    description: Verification required for international beneficiaries
    description_vi: Yêu cầu xác minh cho người nhận quốc tế
    rule: |
      IF transfer_type = 'international'
      AND verification_status != 'verified'
      THEN require_verification = true

  - id: BR-BEN-004
    name: Trusted Beneficiary
    description: Trusted beneficiaries skip additional verification
    description_vi: Người nhận tin cậy bỏ qua xác minh thêm
    rule: |
      IF is_trusted = true
      THEN skip_otp_for_amounts <= trusted_limit

  - id: BR-BEN-005
    name: Duplicate Check
    description: Prevent duplicate beneficiaries
    description_vi: Ngăn trùng lặp người thụ hưởng
    rule: |
      UNIQUE(account_holder_id, account_number, bank_code)
      WHERE status != 'deleted'

  - id: BR-BEN-006
    name: Name Verification
    description: Verify name matches account
    description_vi: Xác minh tên khớp với tài khoản
    rule: |
      IF bank_supports_name_inquiry
      THEN verify recipient_name matches account_name

# =============================================================================
# VERIFICATION METHODS
# =============================================================================
verification_methods:
  name_match:
    description: "Real-time name inquiry to recipient bank"
    supported_banks: ["NAPAS member banks"]
    response_time: "Real-time"

  micro_deposit:
    description: "Small deposit with verification code"
    deposit_amount: [100, 500, 1000]
    verification_window: "48 hours"

  bank_lookup:
    description: "Bank account lookup via network"
    supported_for: ["domestic"]

  manual:
    description: "Manual verification by bank staff"
    used_for: ["international", "disputed"]

# =============================================================================
# BANK DIRECTORY
# =============================================================================
bank_directory:
  napas_members:
    description: "Domestic interbank network members"
    lookup_method: "NAPAS API"

  swift_members:
    description: "International SWIFT network"
    lookup_method: "SWIFT directory"

# =============================================================================
# INDEXES
# =============================================================================
indexes:
  - name: idx_beneficiary_holder
    fields: [account_holder_id]

  - name: idx_beneficiary_account
    fields: [account_number, bank_code]

  - name: idx_beneficiary_status
    fields: [status]

  - name: idx_beneficiary_type
    fields: [transfer_type]

  - name: idx_beneficiary_cooling
    fields: [cooling_period_end]
    where: "cooling_period_end IS NOT NULL"

  - name: idx_beneficiary_verified
    fields: [verification_status]

# =============================================================================
# AUDIT
# =============================================================================
audit:
  enabled: true
  events:
    - beneficiary_created
    - beneficiary_modified
    - beneficiary_verified
    - beneficiary_trusted
    - beneficiary_suspended
    - beneficiary_reactivated
    - beneficiary_deleted
    - transfer_made
