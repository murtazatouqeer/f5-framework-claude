name: Statement
display_name: Statement / Sao kê tài khoản
description: |
  Periodic account statement containing transaction history, balance
  summary, and account activity. Supports various formats and
  delivery methods with regulatory compliance.

domain: fintech
sub_domain: banking
version: "1.0"
status: active

# =============================================================================
# ATTRIBUTES
# =============================================================================
attributes:
  # ---------------------------------------------------------------------------
  # Identity
  # ---------------------------------------------------------------------------
  id:
    type: uuid
    primary_key: true
    description: Unique statement identifier

  statement_reference:
    type: string
    format: "^STM-[0-9]{8}-[A-Z0-9]{6}$"
    unique: true
    indexed: true
    description: Human-readable statement reference
    description_vi: Mã tham chiếu sao kê
    example: "STM-20241215-A1B2C3"

  # ---------------------------------------------------------------------------
  # Account
  # ---------------------------------------------------------------------------
  account_id:
    type: uuid
    required: true
    indexed: true
    references: BankAccount
    description: Account for this statement

  account_holder_id:
    type: uuid
    required: true
    indexed: true
    references: AccountHolder

  account_number:
    type: string
    description: Account number (denormalized)

  # ---------------------------------------------------------------------------
  # Statement Period
  # ---------------------------------------------------------------------------
  statement_type:
    type: enum
    values: [monthly, quarterly, annual, custom, interim]
    required: true
    indexed: true
    description: Type of statement
    description_vi: Loại sao kê
    value_descriptions:
      monthly: "Monthly statement / Sao kê tháng"
      quarterly: "Quarterly statement / Sao kê quý"
      annual: "Annual statement / Sao kê năm"
      custom: "Custom date range / Tùy chỉnh"
      interim: "On-demand interim / Sao kê tạm thời"

  period_start:
    type: date
    required: true
    indexed: true
    description: Statement period start date
    description_vi: Ngày bắt đầu kỳ

  period_end:
    type: date
    required: true
    indexed: true
    description: Statement period end date
    description_vi: Ngày kết thúc kỳ

  statement_date:
    type: date
    required: true
    indexed: true
    description: Statement generation date
    description_vi: Ngày lập sao kê

  # ---------------------------------------------------------------------------
  # Balance Summary
  # ---------------------------------------------------------------------------
  opening_balance:
    type: decimal
    precision: 18
    scale: 2
    required: true
    description: Balance at start of period
    description_vi: Số dư đầu kỳ

  closing_balance:
    type: decimal
    precision: 18
    scale: 2
    required: true
    description: Balance at end of period
    description_vi: Số dư cuối kỳ

  total_credits:
    type: decimal
    precision: 18
    scale: 2
    default: 0
    description: Total credits in period
    description_vi: Tổng tiền ghi có

  total_debits:
    type: decimal
    precision: 18
    scale: 2
    default: 0
    description: Total debits in period
    description_vi: Tổng tiền ghi nợ

  credit_count:
    type: integer
    default: 0
    description: Number of credit transactions

  debit_count:
    type: integer
    default: 0
    description: Number of debit transactions

  currency:
    type: string
    format: "^[A-Z]{3}$"
    default: "VND"

  # ---------------------------------------------------------------------------
  # Interest Summary (for savings)
  # ---------------------------------------------------------------------------
  interest_earned:
    type: decimal
    precision: 18
    scale: 2
    nullable: true
    description: Interest earned in period
    description_vi: Lãi nhận được trong kỳ

  interest_rate:
    type: decimal
    precision: 5
    scale: 4
    nullable: true
    description: Applicable interest rate

  average_balance:
    type: decimal
    precision: 18
    scale: 2
    nullable: true
    description: Average daily balance

  minimum_balance:
    type: decimal
    precision: 18
    scale: 2
    nullable: true
    description: Minimum balance in period

  maximum_balance:
    type: decimal
    precision: 18
    scale: 2
    nullable: true
    description: Maximum balance in period

  # ---------------------------------------------------------------------------
  # Fee Summary
  # ---------------------------------------------------------------------------
  total_fees:
    type: decimal
    precision: 18
    scale: 2
    default: 0
    description: Total fees charged
    description_vi: Tổng phí

  fee_breakdown:
    type: json
    nullable: true
    description: Breakdown of fees by type
    example: |
      {
        "maintenance_fee": 25000,
        "transfer_fees": 33000,
        "atm_fees": 0
      }

  # ---------------------------------------------------------------------------
  # Transaction Count
  # ---------------------------------------------------------------------------
  transaction_count:
    type: integer
    default: 0
    description: Total transactions in period
    description_vi: Số giao dịch trong kỳ

  pages:
    type: integer
    default: 1
    description: Number of pages in statement

  # ---------------------------------------------------------------------------
  # Status
  # ---------------------------------------------------------------------------
  status:
    type: enum
    values: [generating, ready, delivered, failed, archived]
    default: generating
    indexed: true
    description: Statement status
    description_vi: Trạng thái
    value_descriptions:
      generating: "Being generated / Đang tạo"
      ready: "Ready for download / Sẵn sàng"
      delivered: "Delivered to customer / Đã gửi"
      failed: "Generation failed / Lỗi"
      archived: "Archived / Đã lưu trữ"

  # ---------------------------------------------------------------------------
  # Format & Delivery
  # ---------------------------------------------------------------------------
  format:
    type: enum
    values: [pdf, xlsx, csv, html]
    default: pdf
    description: Statement format
    description_vi: Định dạng

  file_path:
    type: string
    max_length: 500
    nullable: true
    description: Path to generated file

  file_size:
    type: integer
    nullable: true
    description: File size in bytes

  file_hash:
    type: string
    max_length: 64
    nullable: true
    description: File checksum for integrity

  delivery_method:
    type: enum
    values: [email, sms_link, app_notification, mail, branch_pickup]
    nullable: true
    description: How statement was delivered
    description_vi: Phương thức gửi

  delivered_at:
    type: timestamp
    nullable: true
    description: When statement was delivered

  delivery_address:
    type: string
    max_length: 200
    nullable: true
    description: Email or postal address

  # ---------------------------------------------------------------------------
  # Access
  # ---------------------------------------------------------------------------
  download_count:
    type: integer
    default: 0
    description: Number of times downloaded

  first_viewed_at:
    type: timestamp
    nullable: true
    description: First time statement was viewed

  last_viewed_at:
    type: timestamp
    nullable: true
    description: Last time statement was viewed

  download_expires_at:
    type: timestamp
    nullable: true
    description: When download link expires

  # ---------------------------------------------------------------------------
  # Request Info
  # ---------------------------------------------------------------------------
  requested_by:
    type: enum
    values: [system, customer, admin]
    default: system
    description: Who requested the statement

  request_reason:
    type: string
    max_length: 200
    nullable: true
    description: Reason for custom statement request

  # ---------------------------------------------------------------------------
  # Timestamps
  # ---------------------------------------------------------------------------
  generated_at:
    type: timestamp
    nullable: true
    description: When statement was generated

  created_at:
    type: timestamp
    auto: true

  updated_at:
    type: timestamp
    auto: true

  archived_at:
    type: timestamp
    nullable: true

# =============================================================================
# RELATIONSHIPS
# =============================================================================
relationships:
  account:
    type: belongs_to
    entity: BankAccount
    foreign_key: account_id

  account_holder:
    type: belongs_to
    entity: AccountHolder
    foreign_key: account_holder_id

  transactions:
    type: has_many
    entity: CardTransaction
    description: Transactions included in statement
    scope: |
      transaction_at BETWEEN period_start AND period_end
      AND account_id = statement.account_id

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  - id: BR-STM-001
    name: Monthly Statement Generation
    description: Generate monthly statements by 5th of following month
    description_vi: Tạo sao kê tháng trước ngày 5 tháng sau
    rule: |
      FOR each active account
      ON day 5 of month
      GENERATE statement for previous month

  - id: BR-STM-002
    name: Statement Retention
    description: Retain statements for 10 years
    description_vi: Lưu giữ sao kê 10 năm
    rule: |
      archive_after: 2 years
      delete_after: 10 years

  - id: BR-STM-003
    name: Download Link Expiry
    description: Download links expire after 30 days
    rule: |
      download_expires_at = generated_at + 30 days

  - id: BR-STM-004
    name: Interim Statement Limit
    description: Maximum 4 interim statements per month
    description_vi: Tối đa 4 sao kê tạm thời mỗi tháng
    rule: |
      COUNT(statements WHERE type = 'interim' AND month = current_month) <= 4

  - id: BR-STM-005
    name: Statement Fee
    description: Fee for additional statement copies
    description_vi: Phí sao kê bổ sung
    rule: |
      first_copy: free
      additional_copies: 11_000 VND each

# =============================================================================
# STATEMENT SCHEDULE
# =============================================================================
statement_schedule:
  monthly:
    generation_day: 5
    period: "1st to last day of previous month"
    delivery: "Within 3 business days"

  quarterly:
    generation_day: 10
    months: [1, 4, 7, 10]
    period: "Previous quarter"

  annual:
    generation_day: 15
    month: 1
    period: "Previous calendar year"

  interim:
    generation: "On demand"
    max_per_month: 4
    fee: 11000

# =============================================================================
# STATEMENT CONTENT
# =============================================================================
statement_content:
  header:
    - bank_name
    - bank_address
    - account_number
    - account_holder_name
    - statement_period
    - statement_date

  summary:
    - opening_balance
    - total_credits
    - total_debits
    - closing_balance
    - interest_earned (if applicable)
    - fees_charged

  transactions:
    columns:
      - date
      - description
      - reference
      - debit_amount
      - credit_amount
      - running_balance

  footer:
    - contact_information
    - dispute_instructions
    - terms_reference

# =============================================================================
# DELIVERY PREFERENCES
# =============================================================================
delivery_preferences:
  email:
    subject_template: "Account Statement - {account_number} - {period}"
    attachment: true
    password_protected: optional

  sms:
    message_template: "Your statement for {period} is ready. Download: {link}"

  mail:
    fee: 22000
    delivery_time: "5-7 business days"

# =============================================================================
# INDEXES
# =============================================================================
indexes:
  - name: idx_statement_account
    fields: [account_id]

  - name: idx_statement_period
    fields: [period_start, period_end]

  - name: idx_statement_date
    fields: [statement_date]

  - name: idx_statement_type
    fields: [statement_type]

  - name: idx_statement_status
    fields: [status]

# =============================================================================
# AUDIT
# =============================================================================
audit:
  enabled: true
  retention_years: 10
  events:
    - statement_requested
    - statement_generated
    - statement_delivered
    - statement_downloaded
    - statement_archived
    - generation_failed
