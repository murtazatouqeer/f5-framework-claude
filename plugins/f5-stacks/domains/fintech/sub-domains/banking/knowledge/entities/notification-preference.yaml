name: NotificationPreference
display_name: Notification Preference / Tùy chọn thông báo
description: |
  Customer preferences for banking notifications including
  transaction alerts, security notifications, marketing communications,
  and delivery channel settings.

domain: fintech
sub_domain: banking
version: "1.0"
status: active

# =============================================================================
# ATTRIBUTES
# =============================================================================
attributes:
  # ---------------------------------------------------------------------------
  # Identity
  # ---------------------------------------------------------------------------
  id:
    type: uuid
    primary_key: true
    description: Unique preference identifier

  account_holder_id:
    type: uuid
    required: true
    indexed: true
    references: AccountHolder
    description: Account holder these preferences belong to

  account_id:
    type: uuid
    nullable: true
    indexed: true
    references: BankAccount
    description: Specific account (null = all accounts)

  # ---------------------------------------------------------------------------
  # Notification Category
  # ---------------------------------------------------------------------------
  category:
    type: enum
    values: [transaction, security, account, marketing, regulatory]
    required: true
    indexed: true
    description: Notification category
    description_vi: Danh mục thông báo
    value_descriptions:
      transaction: "Transaction alerts / Thông báo giao dịch"
      security: "Security alerts / Thông báo bảo mật"
      account: "Account updates / Cập nhật tài khoản"
      marketing: "Marketing communications / Quảng cáo"
      regulatory: "Regulatory notices / Thông báo pháp lý"

  notification_type:
    type: string
    max_length: 50
    required: true
    indexed: true
    description: Specific notification type
    description_vi: Loại thông báo
    examples:
      - "credit_received"
      - "debit_made"
      - "card_transaction"
      - "login_alert"
      - "password_changed"
      - "statement_ready"

  # ---------------------------------------------------------------------------
  # Channel Preferences
  # ---------------------------------------------------------------------------
  push_enabled:
    type: boolean
    default: true
    description: Enable push notifications
    description_vi: Bật thông báo đẩy

  sms_enabled:
    type: boolean
    default: true
    description: Enable SMS notifications
    description_vi: Bật thông báo SMS

  email_enabled:
    type: boolean
    default: true
    description: Enable email notifications
    description_vi: Bật thông báo email

  in_app_enabled:
    type: boolean
    default: true
    description: Enable in-app notifications
    description_vi: Bật thông báo trong ứng dụng

  whatsapp_enabled:
    type: boolean
    default: false
    description: Enable WhatsApp notifications

  # ---------------------------------------------------------------------------
  # Threshold Settings (for transaction notifications)
  # ---------------------------------------------------------------------------
  amount_threshold:
    type: decimal
    precision: 18
    scale: 2
    nullable: true
    description: Notify only for amounts above this
    description_vi: Ngưỡng số tiền thông báo
    example: "Only notify for transactions > 1,000,000 VND"

  threshold_type:
    type: enum
    values: [all, above_threshold, below_threshold]
    default: all
    description: How to apply threshold

  # ---------------------------------------------------------------------------
  # Timing Preferences
  # ---------------------------------------------------------------------------
  instant_enabled:
    type: boolean
    default: true
    description: Send notifications immediately
    description_vi: Gửi thông báo ngay lập tức

  quiet_hours_enabled:
    type: boolean
    default: false
    description: Enable quiet hours
    description_vi: Bật giờ yên tĩnh

  quiet_hours_start:
    type: time
    nullable: true
    description: Start of quiet hours
    description_vi: Giờ bắt đầu yên tĩnh
    example: "22:00"

  quiet_hours_end:
    type: time
    nullable: true
    description: End of quiet hours
    description_vi: Giờ kết thúc yên tĩnh
    example: "07:00"

  quiet_hours_action:
    type: enum
    values: [delay, silent, skip]
    default: delay
    description: What to do during quiet hours
    value_descriptions:
      delay: "Send after quiet hours end"
      silent: "Send without sound"
      skip: "Don't send at all"

  # ---------------------------------------------------------------------------
  # Digest Settings
  # ---------------------------------------------------------------------------
  digest_enabled:
    type: boolean
    default: false
    description: Combine notifications into digest
    description_vi: Gộp thông báo

  digest_frequency:
    type: enum
    values: [daily, weekly]
    nullable: true
    description: How often to send digest

  digest_time:
    type: time
    nullable: true
    description: Time to send digest
    example: "08:00"

  digest_day:
    type: enum
    values: [monday, tuesday, wednesday, thursday, friday, saturday, sunday]
    nullable: true
    description: Day to send weekly digest

  # ---------------------------------------------------------------------------
  # Language & Format
  # ---------------------------------------------------------------------------
  language:
    type: string
    format: "^[a-z]{2}$"
    default: "vi"
    description: Notification language
    description_vi: Ngôn ngữ thông báo

  currency_format:
    type: enum
    values: [local, international]
    default: local
    description: How to format currency amounts

  include_balance:
    type: boolean
    default: true
    description: Include balance in transaction notifications
    description_vi: Hiển thị số dư trong thông báo

  mask_amount:
    type: boolean
    default: false
    description: Mask transaction amounts in notifications
    description_vi: Che số tiền trong thông báo

  # ---------------------------------------------------------------------------
  # Status
  # ---------------------------------------------------------------------------
  enabled:
    type: boolean
    default: true
    indexed: true
    description: Whether this preference is active

  # ---------------------------------------------------------------------------
  # Override Settings
  # ---------------------------------------------------------------------------
  override_global:
    type: boolean
    default: false
    description: Override global/account-level settings

  # ---------------------------------------------------------------------------
  # Timestamps
  # ---------------------------------------------------------------------------
  created_at:
    type: timestamp
    auto: true

  updated_at:
    type: timestamp
    auto: true

# =============================================================================
# RELATIONSHIPS
# =============================================================================
relationships:
  account_holder:
    type: belongs_to
    entity: AccountHolder
    foreign_key: account_holder_id

  account:
    type: belongs_to
    entity: BankAccount
    foreign_key: account_id
    optional: true

# =============================================================================
# NOTIFICATION TYPES
# =============================================================================
notification_types:
  transaction:
    - id: credit_received
      name: Credit Received
      name_vi: Nhận tiền vào
      default_channels: [push, sms]
      user_configurable: true
      threshold_applicable: true

    - id: debit_made
      name: Debit Made
      name_vi: Tiền ra
      default_channels: [push, sms]
      user_configurable: true
      threshold_applicable: true

    - id: card_transaction
      name: Card Transaction
      name_vi: Giao dịch thẻ
      default_channels: [push, sms]
      user_configurable: true
      threshold_applicable: true

    - id: transfer_sent
      name: Transfer Sent
      name_vi: Chuyển khoản đi
      default_channels: [push, sms]
      user_configurable: true

    - id: transfer_received
      name: Transfer Received
      name_vi: Nhận chuyển khoản
      default_channels: [push, sms]
      user_configurable: true

    - id: standing_order_executed
      name: Standing Order Executed
      name_vi: Lệnh định kỳ đã thực hiện
      default_channels: [push]
      user_configurable: true

    - id: direct_debit_collected
      name: Direct Debit Collected
      name_vi: Ủy nhiệm chi đã thu
      default_channels: [push, sms]
      user_configurable: true

  security:
    - id: login_new_device
      name: Login from New Device
      name_vi: Đăng nhập từ thiết bị mới
      default_channels: [push, sms, email]
      user_configurable: false
      mandatory: true

    - id: password_changed
      name: Password Changed
      name_vi: Mật khẩu đã thay đổi
      default_channels: [sms, email]
      user_configurable: false
      mandatory: true

    - id: pin_changed
      name: PIN Changed
      name_vi: Mã PIN đã thay đổi
      default_channels: [sms]
      user_configurable: false
      mandatory: true

    - id: card_blocked
      name: Card Blocked
      name_vi: Thẻ bị khóa
      default_channels: [push, sms]
      user_configurable: false
      mandatory: true

    - id: suspicious_activity
      name: Suspicious Activity Detected
      name_vi: Phát hiện hoạt động đáng ngờ
      default_channels: [push, sms, email]
      user_configurable: false
      mandatory: true

    - id: beneficiary_added
      name: New Beneficiary Added
      name_vi: Thêm người thụ hưởng mới
      default_channels: [push, sms]
      user_configurable: true

  account:
    - id: statement_ready
      name: Statement Ready
      name_vi: Sao kê sẵn sàng
      default_channels: [push, email]
      user_configurable: true

    - id: low_balance
      name: Low Balance Alert
      name_vi: Cảnh báo số dư thấp
      default_channels: [push]
      user_configurable: true
      threshold_applicable: true

    - id: limit_approaching
      name: Limit Approaching
      name_vi: Sắp đạt hạn mức
      default_channels: [push]
      user_configurable: true

    - id: card_expiring
      name: Card Expiring Soon
      name_vi: Thẻ sắp hết hạn
      default_channels: [push, email]
      user_configurable: true

    - id: deposit_matured
      name: Deposit Matured
      name_vi: Tiền gửi đáo hạn
      default_channels: [push, sms, email]
      user_configurable: true

  marketing:
    - id: promotional_offers
      name: Promotional Offers
      name_vi: Ưu đãi khuyến mãi
      default_channels: [push, email]
      user_configurable: true
      opt_in_required: true

    - id: new_features
      name: New Features
      name_vi: Tính năng mới
      default_channels: [push]
      user_configurable: true

    - id: rewards_update
      name: Rewards Update
      name_vi: Cập nhật điểm thưởng
      default_channels: [push]
      user_configurable: true

  regulatory:
    - id: terms_update
      name: Terms Update
      name_vi: Cập nhật điều khoản
      default_channels: [email]
      user_configurable: false
      mandatory: true

    - id: privacy_notice
      name: Privacy Notice
      name_vi: Thông báo bảo mật
      default_channels: [email]
      user_configurable: false
      mandatory: true

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  - id: BR-NTF-001
    name: Security Notifications Mandatory
    description: Security notifications cannot be disabled
    description_vi: Thông báo bảo mật không thể tắt
    rule: |
      IF category = 'security'
      THEN at least one channel must be enabled

  - id: BR-NTF-002
    name: Transaction Notification Default
    description: Transaction notifications enabled by default
    rule: |
      ON account_creation
      CREATE default notification preferences with push and sms enabled

  - id: BR-NTF-003
    name: Marketing Opt-In
    description: Marketing requires explicit opt-in
    description_vi: Quảng cáo cần đồng ý rõ ràng
    rule: |
      IF category = 'marketing'
      THEN opt_in_required = true

  - id: BR-NTF-004
    name: Quiet Hours Respect
    description: Non-urgent notifications respect quiet hours
    rule: |
      IF quiet_hours_enabled AND current_time BETWEEN quiet_start AND quiet_end
      AND category NOT IN ('security')
      THEN apply quiet_hours_action

  - id: BR-NTF-005
    name: SMS Rate Limit
    description: Limit SMS notifications to prevent cost overrun
    rule: |
      MAX 50 SMS per account per day
      EXCEPT for security notifications

# =============================================================================
# DEFAULT PREFERENCES
# =============================================================================
default_preferences:
  transaction:
    push_enabled: true
    sms_enabled: true
    email_enabled: false
    threshold_type: all

  security:
    push_enabled: true
    sms_enabled: true
    email_enabled: true
    instant_enabled: true
    quiet_hours_enabled: false

  account:
    push_enabled: true
    sms_enabled: false
    email_enabled: true

  marketing:
    push_enabled: false
    sms_enabled: false
    email_enabled: false

  regulatory:
    email_enabled: true

# =============================================================================
# INDEXES
# =============================================================================
indexes:
  - name: idx_notif_pref_holder
    fields: [account_holder_id]

  - name: idx_notif_pref_account
    fields: [account_id]

  - name: idx_notif_pref_category
    fields: [category]

  - name: idx_notif_pref_type
    fields: [notification_type]

  - name: idx_notif_pref_enabled
    fields: [enabled]

# =============================================================================
# AUDIT
# =============================================================================
audit:
  enabled: true
  events:
    - preference_created
    - preference_updated
    - channel_enabled
    - channel_disabled
    - quiet_hours_set
    - threshold_changed
