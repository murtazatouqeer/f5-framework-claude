name: Trade
display_name: Trade / Giao dịch
description: |
  Executed trade between a buyer and seller order on the exchange.
  Represents the matching of two orders at a specific price and quantity.

domain: fintech
sub_domain: crypto
entity_type: transaction
version: "1.0"
status: active

# =============================================================================
# ATTRIBUTES
# =============================================================================
attributes:
  # Primary Key
  id:
    type: uuid
    primary_key: true
    description: Unique trade identifier

  # Business Identifier
  trade_id:
    type: bigint
    unique: true
    indexed: true
    auto_increment: true
    description: Sequential trade ID for the market

  # Trading Pair
  trading_pair_id:
    type: uuid
    required: true
    indexed: true
    description: The trading pair
    reference: trading_pairs.id

  symbol:
    type: string
    max_length: 20
    indexed: true
    description: Trading pair symbol (denormalized)
    example: "BTC/USDT"

  # Order References
  buyer_order_id:
    type: uuid
    required: true
    indexed: true
    description: Buy order in the trade
    reference: orders.id

  seller_order_id:
    type: uuid
    required: true
    indexed: true
    description: Sell order in the trade
    reference: orders.id

  # User References
  buyer_user_id:
    type: uuid
    required: true
    indexed: true
    description: Buyer user
    reference: users.id

  seller_user_id:
    type: uuid
    required: true
    indexed: true
    description: Seller user
    reference: users.id

  # Trade Details
  side:
    type: enum
    required: true
    values:
      - buy
      - sell
    description: Trade side from taker's perspective

  price:
    type: decimal
    precision: 28
    scale: 8
    required: true
    description: Execution price

  quantity:
    type: decimal
    precision: 28
    scale: 8
    required: true
    description: Quantity of base asset traded

  quote_quantity:
    type: decimal
    precision: 28
    scale: 8
    required: true
    calculated: true
    description: Quantity of quote asset traded (price * quantity)

  # Maker/Taker
  maker_user_id:
    type: uuid
    required: true
    indexed: true
    description: User who provided liquidity
    reference: users.id

  taker_user_id:
    type: uuid
    required: true
    indexed: true
    description: User who took liquidity
    reference: users.id

  is_buyer_maker:
    type: boolean
    required: true
    description: Whether buyer was the maker

  # Fees
  buyer_fee:
    type: decimal
    precision: 28
    scale: 8
    default: 0
    description: Fee charged to buyer

  seller_fee:
    type: decimal
    precision: 28
    scale: 8
    default: 0
    description: Fee charged to seller

  fee_asset_id:
    type: uuid
    description: Asset in which fees were paid
    reference: crypto_assets.id

  buyer_fee_discount:
    type: decimal
    precision: 5
    scale: 4
    default: 0
    description: Fee discount applied for buyer (0.00-1.00)

  seller_fee_discount:
    type: decimal
    precision: 5
    scale: 4
    default: 0
    description: Fee discount applied for seller

  # Timestamps
  executed_at:
    type: timestamp
    required: true
    indexed: true
    description: Trade execution timestamp

  # Market Impact
  is_best_price:
    type: boolean
    description: Whether this was at best bid/ask

# =============================================================================
# RELATIONSHIPS
# =============================================================================
relationships:
  trading_pair:
    type: belongs_to
    entity: TradingPair
    foreign_key: trading_pair_id

  buyer_order:
    type: belongs_to
    entity: Order
    foreign_key: buyer_order_id

  seller_order:
    type: belongs_to
    entity: Order
    foreign_key: seller_order_id

  buyer:
    type: belongs_to
    entity: User
    foreign_key: buyer_user_id

  seller:
    type: belongs_to
    entity: User
    foreign_key: seller_user_id

  fee_asset:
    type: belongs_to
    entity: CryptoAsset
    foreign_key: fee_asset_id

# =============================================================================
# INDEXES
# =============================================================================
indexes:
  - name: idx_trade_pair
    columns: [trading_pair_id]

  - name: idx_trade_pair_time
    columns: [trading_pair_id, executed_at]

  - name: idx_trade_buyer
    columns: [buyer_user_id, executed_at]

  - name: idx_trade_seller
    columns: [seller_user_id, executed_at]

  - name: idx_trade_time
    columns: [executed_at]

  - name: idx_trade_symbol
    columns: [symbol, executed_at]

# =============================================================================
# AGGREGATIONS
# =============================================================================
aggregations:
  ohlcv:
    description: Open, High, Low, Close, Volume for candlesticks
    intervals: [1m, 5m, 15m, 30m, 1h, 4h, 1d, 1w, 1M]
    fields:
      open: first price in interval
      high: max price in interval
      low: min price in interval
      close: last price in interval
      volume: sum of quantity
      quote_volume: sum of quote_quantity
      trades: count of trades

  ticker_24h:
    description: 24-hour rolling statistics
    fields:
      price_change: close - open_24h_ago
      price_change_percent: percentage change
      high_price: max in 24h
      low_price: min in 24h
      volume: sum of quantity
      quote_volume: sum of quote_quantity
      weighted_avg_price: quote_volume / volume
      last_price: most recent
      trade_count: number of trades

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  - id: BR-TRD-001
    name: Self-Trade Prevention
    name_vi: Ngăn giao dịch tự thân
    description: Same user cannot be both buyer and seller
    enforcement: matching_engine
    action: Cancel older order

  - id: BR-TRD-002
    name: Trade Atomicity
    name_vi: Tính nguyên tử giao dịch
    description: Trade, balance updates, and fee charges are atomic
    enforcement: transaction_required

  - id: BR-TRD-003
    name: Immutable Trades
    name_vi: Giao dịch không thể thay đổi
    description: Trade records cannot be modified after creation
    enforcement: database_constraint

# =============================================================================
# AUDIT
# =============================================================================
audit:
  enabled: true
  immutable: true
  log_creation: true
  retention_years: 10
