name: work-order
display_name: Work Order
display_name_vi: Lệnh sản xuất
version: "1.0"
domain: manufacturing
subdomain: production
type: entity

description: |
  Work order (production order) authorizing the manufacture of a product.
  Tracks quantities, schedules, costs, and progress through operations.

description_vi: |
  Lệnh sản xuất ủy quyền sản xuất sản phẩm. Theo dõi số lượng, lịch trình,
  chi phí và tiến độ qua các công đoạn.

attributes:
  identification:
    - name: id
      type: uuid
      required: true

    - name: work_order_number
      type: string
      required: true
      unique: true
      pattern: "^WO-[0-9]{8,12}$"
      auto_generate: true
      description: Work order number
      description_vi: Số lệnh sản xuất

    - name: status
      type: enum
      required: true
      default: planned
      values:
        - draft: Being created
        - planned: Planned, not released
        - released: Released to production
        - in_progress: Production started
        - on_hold: Temporarily stopped
        - completed: Production finished
        - closed: Financially closed
        - cancelled: Cancelled
      description_vi: Trạng thái

    - name: order_type
      type: enum
      required: true
      default: standard
      values:
        - standard: Normal production
        - rework: Rework order
        - prototype: Prototype/sample
        - repair: Repair order
        - disassembly: Disassembly order
      description_vi: Loại lệnh

    - name: priority
      type: enum
      default: medium
      values:
        - low: Low priority
        - medium: Normal priority
        - high: High priority
        - urgent: Urgent/rush
      description_vi: Độ ưu tiên

  product:
    - name: product_id
      type: uuid
      required: true
      description: Product to manufacture
      description_vi: Sản phẩm sản xuất

    - name: product_code
      type: string
      description: Product code (denormalized)
      description_vi: Mã sản phẩm

    - name: product_name
      type: string
      description: Product name (denormalized)

    - name: bom_id
      type: uuid
      required: true
      description: Bill of materials
      description_vi: Định mức vật tư

    - name: routing_id
      type: uuid
      required: true
      description: Production routing
      description_vi: Quy trình sản xuất

  quantity:
    - name: planned_quantity
      type: decimal
      required: true
      precision: 15
      scale: 4
      description: Quantity to produce
      description_vi: Số lượng kế hoạch

    - name: unit_of_measure
      type: string
      required: true
      description: Unit of measure
      description_vi: Đơn vị tính

    - name: completed_quantity
      type: decimal
      default: 0
      precision: 15
      scale: 4
      description: Good quantity completed
      description_vi: Số lượng hoàn thành

    - name: scrapped_quantity
      type: decimal
      default: 0
      precision: 15
      scale: 4
      description: Quantity scrapped
      description_vi: Số lượng phế

    - name: rework_quantity
      type: decimal
      default: 0
      description: Quantity sent to rework

  schedule:
    - name: planned_start_date
      type: datetime
      required: true
      description: Planned start date/time
      description_vi: Ngày bắt đầu kế hoạch

    - name: planned_end_date
      type: datetime
      required: true
      description: Planned end date/time
      description_vi: Ngày kết thúc kế hoạch

    - name: actual_start_date
      type: datetime
      description: Actual start date/time
      description_vi: Ngày bắt đầu thực tế

    - name: actual_end_date
      type: datetime
      description: Actual end date/time
      description_vi: Ngày kết thúc thực tế

    - name: due_date
      type: date
      required: true
      description: Required by date
      description_vi: Ngày yêu cầu

    - name: released_date
      type: datetime
      description: When released to production
      description_vi: Ngày phát hành

  source:
    - name: source_type
      type: enum
      required: true
      default: internal
      values:
        - sales_order: From sales order
        - forecast: From demand forecast
        - stock: For stock replenishment
        - internal: Internal request
        - project: Project requirement
      description_vi: Nguồn yêu cầu

    - name: source_reference
      type: string
      description: Source document reference
      description_vi: Tham chiếu nguồn

    - name: source_id
      type: uuid
      description: Link to source document

    - name: customer_id
      type: uuid
      description: Customer if make-to-order

  lot:
    - name: production_lot_id
      type: uuid
      description: Production lot
      description_vi: Lô sản xuất

    - name: lot_number
      type: string
      description: Lot number assigned
      description_vi: Số lô

    - name: serial_numbers
      type: array
      item_type: string
      description: Serial numbers if tracked

  progress:
    - name: current_operation_id
      type: uuid
      description: Current operation in progress
      description_vi: Công đoạn hiện tại

    - name: current_operation_sequence
      type: integer
      description: Current operation sequence

    - name: percent_complete
      type: decimal
      default: 0
      min: 0
      max: 100
      description: Overall completion percentage
      description_vi: Phần trăm hoàn thành

    - name: operations_completed
      type: integer
      default: 0
      description: Number of operations completed

    - name: total_operations
      type: integer
      description: Total number of operations

  costing:
    - name: planned_cost
      type: decimal
      precision: 15
      scale: 4
      description: Planned total cost
      description_vi: Chi phí kế hoạch

    - name: actual_cost
      type: decimal
      precision: 15
      scale: 4
      description: Actual total cost
      description_vi: Chi phí thực tế

    - name: material_cost
      type: decimal
      precision: 15
      scale: 4
      description: Actual material cost
      description_vi: Chi phí vật tư

    - name: labor_cost
      type: decimal
      precision: 15
      scale: 4
      description: Actual labor cost
      description_vi: Chi phí nhân công

    - name: overhead_cost
      type: decimal
      precision: 15
      scale: 4
      description: Actual overhead cost
      description_vi: Chi phí chung

    - name: variance
      type: decimal
      description: Cost variance (actual - planned)

  location:
    - name: plant_id
      type: uuid
      description: Manufacturing plant
      description_vi: Nhà máy

    - name: warehouse_id
      type: uuid
      description: Output warehouse
      description_vi: Kho xuất

  notes:
    - name: notes
      type: text
      description: General notes
      description_vi: Ghi chú

    - name: hold_reason
      type: string
      description: Reason if on hold
      description_vi: Lý do tạm dừng

    - name: cancellation_reason
      type: string
      description: Reason if cancelled

  audit:
    - name: created_at
      type: timestamp
      auto: true

    - name: created_by
      type: uuid

    - name: updated_at
      type: timestamp
      auto: true

    - name: updated_by
      type: uuid

    - name: closed_at
      type: timestamp

    - name: closed_by
      type: uuid

relationships:
  - name: product
    type: belongs_to
    entity: product
    foreign_key: product_id

  - name: bom
    type: belongs_to
    entity: bom
    foreign_key: bom_id

  - name: routing
    type: belongs_to
    entity: routing
    foreign_key: routing_id

  - name: production_lot
    type: belongs_to
    entity: production_lot
    foreign_key: production_lot_id

  - name: material_consumptions
    type: has_many
    entity: material_consumption
    foreign_key: work_order_id

  - name: production_outputs
    type: has_many
    entity: production_output
    foreign_key: work_order_id

  - name: downtimes
    type: has_many
    entity: downtime
    foreign_key: work_order_id

indexes:
  - columns: [work_order_number]
    unique: true
  - columns: [status]
  - columns: [product_id, status]
  - columns: [planned_start_date]
  - columns: [due_date]
  - columns: [source_type, source_id]

state_machine:
  field: status
  initial: draft
  transitions:
    - from: draft
      to: planned
      event: plan
      guard: has_valid_bom_routing

    - from: planned
      to: released
      event: release
      guard: materials_available
      action: reserve_materials

    - from: released
      to: in_progress
      event: start
      action: record_actual_start

    - from: in_progress
      to: on_hold
      event: hold
      requires: hold_reason

    - from: on_hold
      to: in_progress
      event: resume

    - from: in_progress
      to: completed
      event: complete
      guard: all_operations_complete
      action: record_actual_end

    - from: completed
      to: closed
      event: close
      action: calculate_final_costs

    - from: [planned, released]
      to: cancelled
      event: cancel
      action: release_materials

validation_rules:
  - rule: "planned_quantity > 0"
    message: "Planned quantity must be positive"

  - rule: "planned_end_date >= planned_start_date"
    message: "End date must be after start date"

  - rule: "completed_quantity + scrapped_quantity <= planned_quantity * 1.1"
    message: "Total output cannot exceed 110% of planned"

computed_fields:
  - name: remaining_quantity
    formula: "planned_quantity - completed_quantity - scrapped_quantity"
    description: Quantity remaining to produce

  - name: yield_percent
    formula: "completed_quantity / (completed_quantity + scrapped_quantity) * 100"
    description: Yield percentage
