name: downtime
display_name: Downtime
display_name_vi: Thời gian dừng máy
version: "1.0"
domain: manufacturing
subdomain: production
type: entity

description: |
  Records machine and production line downtime events for OEE calculation
  and maintenance tracking. Supports planned and unplanned downtime.

description_vi: |
  Ghi lại sự kiện dừng máy và dây chuyền sản xuất để tính OEE
  và theo dõi bảo trì. Hỗ trợ thời gian dừng kế hoạch và ngoài kế hoạch.

attributes:
  identification:
    - name: id
      type: uuid
      required: true

    - name: downtime_number
      type: string
      required: true
      unique: true
      auto_generate: true
      description: Downtime reference number
      description_vi: Số tham chiếu dừng máy

    - name: downtime_type
      type: enum
      required: true
      values:
        - planned: Planned downtime
        - unplanned: Unplanned/breakdown
        - changeover: Changeover time
        - setup: Setup time
        - idle: Idle time (no work)
        - quality: Quality-related stop
        - material: Waiting for materials
        - labor: Waiting for operator
        - other: Other reasons
      description_vi: Loại dừng máy

    - name: category
      type: enum
      required: true
      values:
        - availability: Affects availability
        - performance: Affects performance
        - quality: Affects quality
      description: OEE category impacted
      description_vi: Loại ảnh hưởng OEE

  resource:
    - name: machine_id
      type: uuid
      required: true
      description: Machine with downtime
      description_vi: Máy dừng

    - name: machine_code
      type: string
      description: Machine code (denormalized)

    - name: work_center_id
      type: uuid
      description: Work center
      description_vi: Trung tâm làm việc

    - name: production_line
      type: string
      description: Production line affected

  work_order:
    - name: work_order_id
      type: uuid
      description: Work order affected
      description_vi: Lệnh sản xuất ảnh hưởng

    - name: work_order_number
      type: string
      description: Work order number

    - name: operation_id
      type: uuid
      description: Operation affected

  timing:
    - name: start_time
      type: datetime
      required: true
      description: Downtime start
      description_vi: Thời điểm bắt đầu

    - name: end_time
      type: datetime
      description: Downtime end
      description_vi: Thời điểm kết thúc

    - name: duration_minutes
      type: decimal
      description: Duration in minutes
      description_vi: Thời lượng (phút)

    - name: shift_id
      type: uuid
      description: Shift when occurred
      description_vi: Ca xảy ra

  reason:
    - name: reason_code
      type: string
      required: true
      description: Standardized reason code
      description_vi: Mã lý do

    - name: reason_description
      type: string
      required: true
      description: Reason description
      description_vi: Mô tả lý do

    - name: root_cause
      type: string
      description: Root cause analysis
      description_vi: Nguyên nhân gốc

    - name: failure_mode
      type: string
      description: Failure mode if breakdown

    - name: component_failed
      type: string
      description: Component that failed

  maintenance:
    - name: maintenance_required
      type: boolean
      default: false
      description: Maintenance action needed
      description_vi: Cần bảo trì

    - name: maintenance_request_id
      type: uuid
      description: Linked maintenance work order

    - name: spare_parts_used
      type: array
      item_type: object
      properties:
        part_code:
          type: string
        quantity:
          type: integer
        cost:
          type: decimal
      description: Spare parts consumed

    - name: repair_notes
      type: text
      description: Repair/fix description

  personnel:
    - name: reported_by
      type: uuid
      required: true
      description: Who reported downtime
      description_vi: Người báo cáo

    - name: technician_id
      type: uuid
      description: Technician who fixed
      description_vi: Kỹ thuật viên sửa

    - name: verified_by
      type: uuid
      description: Supervisor verification

  impact:
    - name: units_lost
      type: decimal
      description: Estimated units lost
      description_vi: Sản lượng mất

    - name: cost_impact
      type: decimal
      description: Estimated cost impact
      description_vi: Thiệt hại chi phí

    - name: safety_incident
      type: boolean
      default: false
      description: Safety incident involved

  status:
    - name: status
      type: enum
      default: open
      values:
        - open: Downtime ongoing
        - closed: Downtime ended
        - under_review: Being analyzed
        - action_required: Corrective action needed
      description_vi: Trạng thái

    - name: corrective_action
      type: text
      description: Corrective action taken

    - name: preventive_action
      type: text
      description: Preventive action planned

  notes:
    - name: notes
      type: text
      description: Additional notes
      description_vi: Ghi chú

  audit:
    - name: created_at
      type: timestamp
      auto: true

    - name: created_by
      type: uuid

    - name: updated_at
      type: timestamp
      auto: true

relationships:
  - name: machine
    type: belongs_to
    entity: machine
    foreign_key: machine_id

  - name: work_center
    type: belongs_to
    entity: work_center
    foreign_key: work_center_id

  - name: work_order
    type: belongs_to
    entity: work_order
    foreign_key: work_order_id

  - name: shift
    type: belongs_to
    entity: shift
    foreign_key: shift_id

  - name: reporter
    type: belongs_to
    entity: operator
    foreign_key: reported_by

  - name: technician
    type: belongs_to
    entity: operator
    foreign_key: technician_id

indexes:
  - columns: [downtime_number]
    unique: true
  - columns: [machine_id, start_time]
  - columns: [downtime_type]
  - columns: [reason_code]
  - columns: [status]
  - columns: [start_time]

validation_rules:
  - rule: "end_time IS NULL OR end_time >= start_time"
    message: "End time must be after start time"

  - rule: "downtime_type = 'unplanned' IMPLIES reason_code IS NOT NULL"
    message: "Reason code required for unplanned downtime"

computed_fields:
  - name: duration_minutes_calc
    formula: "TIMESTAMPDIFF(MINUTE, start_time, COALESCE(end_time, NOW()))"
    description: Calculated duration in minutes

  - name: is_active
    formula: "end_time IS NULL"
    description: Whether downtime is ongoing

reason_codes:
  mechanical:
    - MECH-001: Motor failure
    - MECH-002: Bearing failure
    - MECH-003: Belt/chain break
    - MECH-004: Gear damage
    - MECH-005: Hydraulic leak

  electrical:
    - ELEC-001: Power failure
    - ELEC-002: Sensor malfunction
    - ELEC-003: PLC error
    - ELEC-004: Wiring issue
    - ELEC-005: Control system error

  operational:
    - OPER-001: Changeover
    - OPER-002: Setup
    - OPER-003: Material shortage
    - OPER-004: Quality hold
    - OPER-005: Operator unavailable

  planned:
    - PLAN-001: Scheduled maintenance
    - PLAN-002: Tooling change
    - PLAN-003: Cleaning
    - PLAN-004: Training
    - PLAN-005: Break/shift change
