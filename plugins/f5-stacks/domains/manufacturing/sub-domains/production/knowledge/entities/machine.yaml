name: machine
display_name: Machine
display_name_vi: Máy móc
version: "1.0"
domain: manufacturing
subdomain: production
type: entity

description: |
  Individual machine or equipment used in production operations.
  Tracks specifications, status, maintenance, and performance metrics.

description_vi: |
  Máy móc hoặc thiết bị riêng lẻ sử dụng trong các công đoạn sản xuất.
  Theo dõi thông số kỹ thuật, trạng thái, bảo trì và chỉ số hiệu suất.

attributes:
  identification:
    - name: id
      type: uuid
      required: true

    - name: machine_code
      type: string
      required: true
      unique: true
      pattern: "^MCH-[A-Z0-9-]+$"
      description: Machine code
      description_vi: Mã máy

    - name: asset_number
      type: string
      unique: true
      description: Fixed asset number
      description_vi: Số tài sản

    - name: name
      type: string
      required: true
      description: Machine name
      description_vi: Tên máy

    - name: description
      type: text
      description: Description
      description_vi: Mô tả

    - name: status
      type: enum
      required: true
      default: idle
      values:
        - running: Currently running
        - idle: Available, not running
        - setup: Being set up
        - maintenance: Planned maintenance
        - breakdown: Unplanned downtime
        - offline: Not available
      description_vi: Trạng thái

    - name: machine_type
      type: string
      required: true
      description: Type of machine
      description_vi: Loại máy

  specifications:
    - name: manufacturer
      type: string
      description: Machine manufacturer
      description_vi: Nhà sản xuất

    - name: model
      type: string
      description: Model number
      description_vi: Model

    - name: serial_number
      type: string
      description: Serial number
      description_vi: Số serial

    - name: year_manufactured
      type: integer
      description: Year of manufacture
      description_vi: Năm sản xuất

    - name: purchase_date
      type: date
      description: Date purchased

    - name: purchase_cost
      type: decimal
      description: Original purchase cost

    - name: power_kw
      type: decimal
      description: Power consumption (kW)
      description_vi: Công suất điện (kW)

    - name: dimensions
      type: object
      properties:
        length_cm:
          type: decimal
        width_cm:
          type: decimal
        height_cm:
          type: decimal
      description_vi: Kích thước

    - name: weight_kg
      type: decimal
      description: Weight (kg)

  location:
    - name: work_center_id
      type: uuid
      required: true
      description: Work center
      description_vi: Trung tâm làm việc

    - name: location_description
      type: string
      description: Physical location
      description_vi: Vị trí

    - name: grid_position
      type: string
      description: Grid position on floor plan

  capacity:
    - name: capacity_per_hour
      type: decimal
      description: Standard output per hour
      description_vi: Công suất mỗi giờ

    - name: capacity_unit
      type: string
      description: Capacity unit
      description_vi: Đơn vị công suất

    - name: max_speed
      type: decimal
      description: Maximum speed

    - name: standard_speed
      type: decimal
      description: Standard operating speed

    - name: cycle_time_seconds
      type: decimal
      description: Standard cycle time
      description_vi: Thời gian chu kỳ (giây)

  maintenance:
    - name: last_maintenance_date
      type: datetime
      description: Last maintenance performed
      description_vi: Ngày bảo trì gần nhất

    - name: next_maintenance_date
      type: datetime
      description: Next scheduled maintenance
      description_vi: Ngày bảo trì tiếp theo

    - name: maintenance_interval_hours
      type: decimal
      description: Maintenance interval (hours)
      description_vi: Chu kỳ bảo trì (giờ)

    - name: maintenance_interval_days
      type: integer
      description: Maintenance interval (days)

    - name: total_runtime_hours
      type: decimal
      default: 0
      description: Total runtime hours
      description_vi: Tổng giờ chạy

    - name: runtime_since_maintenance
      type: decimal
      default: 0
      description: Hours since last maintenance

    - name: warranty_expiry
      type: date
      description: Warranty expiration date

  performance:
    - name: oee_target
      type: decimal
      default: 85
      description: OEE target %
      description_vi: Mục tiêu OEE

    - name: availability_target
      type: decimal
      default: 90
      description: Availability target %

    - name: performance_target
      type: decimal
      default: 95
      description: Performance target %

    - name: quality_target
      type: decimal
      default: 99
      description: Quality target %

    - name: current_oee
      type: decimal
      description: Current OEE
      description_vi: OEE hiện tại

    - name: mtbf_hours
      type: decimal
      description: Mean time between failures
      description_vi: MTBF (giờ)

    - name: mttr_hours
      type: decimal
      description: Mean time to repair
      description_vi: MTTR (giờ)

  current_state:
    - name: current_work_order_id
      type: uuid
      description: Current work order
      description_vi: Lệnh sản xuất hiện tại

    - name: current_operator_id
      type: uuid
      description: Current operator
      description_vi: Công nhân hiện tại

    - name: current_product_id
      type: uuid
      description: Product being made

    - name: status_since
      type: datetime
      description: Status change timestamp
      description_vi: Thời điểm đổi trạng thái

    - name: current_speed
      type: decimal
      description: Current running speed

    - name: shift_output
      type: decimal
      default: 0
      description: Output this shift

  iot:
    - name: iot_enabled
      type: boolean
      default: false
      description: IoT monitoring enabled

    - name: iot_device_id
      type: string
      description: IoT device identifier

    - name: plc_address
      type: string
      description: PLC network address

    - name: data_collection_interval
      type: integer
      description: Data collection interval (seconds)

  costing:
    - name: hourly_rate
      type: decimal
      precision: 10
      scale: 4
      description: Machine hourly rate
      description_vi: Chi phí máy/giờ

    - name: depreciation_monthly
      type: decimal
      description: Monthly depreciation

  audit:
    - name: created_at
      type: timestamp
      auto: true

    - name: created_by
      type: uuid

    - name: updated_at
      type: timestamp
      auto: true

    - name: updated_by
      type: uuid

relationships:
  - name: work_center
    type: belongs_to
    entity: work_center
    foreign_key: work_center_id

  - name: current_work_order
    type: belongs_to
    entity: work_order
    foreign_key: current_work_order_id

  - name: current_operator
    type: belongs_to
    entity: operator
    foreign_key: current_operator_id

  - name: operations
    type: has_many
    entity: operation
    foreign_key: machine_id

  - name: downtimes
    type: has_many
    entity: downtime
    foreign_key: machine_id

indexes:
  - columns: [machine_code]
    unique: true
  - columns: [asset_number]
    unique: true
    where: "asset_number IS NOT NULL"
  - columns: [work_center_id, status]
  - columns: [status]
  - columns: [next_maintenance_date]

state_machine:
  field: status
  initial: idle
  transitions:
    - from: idle
      to: setup
      event: start_setup

    - from: setup
      to: running
      event: start_production

    - from: running
      to: idle
      event: stop

    - from: [idle, running]
      to: maintenance
      event: start_maintenance

    - from: maintenance
      to: idle
      event: complete_maintenance

    - from: [idle, running, setup]
      to: breakdown
      event: breakdown_occurred

    - from: breakdown
      to: idle
      event: repair_complete

    - from: any
      to: offline
      event: take_offline

validation_rules:
  - rule: "capacity_per_hour > 0"
    message: "Capacity must be positive"

  - rule: "oee_target > 0 AND oee_target <= 100"
    message: "OEE target must be between 0 and 100"

computed_fields:
  - name: maintenance_due
    formula: "runtime_since_maintenance >= maintenance_interval_hours"
    description: Whether maintenance is due

  - name: age_years
    formula: "YEAR(CURRENT_DATE) - year_manufactured"
    description: Machine age in years
