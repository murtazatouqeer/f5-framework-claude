name: production-output
display_name: Production Output
display_name_vi: Sản lượng sản xuất
version: "1.0"
domain: manufacturing
subdomain: production
type: entity

description: |
  Records production output quantities against work orders and operations,
  tracking good output, rejects, and scrap.

description_vi: |
  Ghi lại sản lượng sản xuất theo lệnh sản xuất và công đoạn,
  theo dõi sản lượng tốt, phế phẩm và phế liệu.

attributes:
  identification:
    - name: id
      type: uuid
      required: true

    - name: transaction_number
      type: string
      required: true
      unique: true
      auto_generate: true
      description: Transaction reference
      description_vi: Số giao dịch

    - name: output_type
      type: enum
      required: true
      default: good
      values:
        - good: Good/accepted output
        - reject: Rejected/defective
        - rework: Sent to rework
        - scrap: Scrapped output
        - sample: Quality sample
      description_vi: Loại sản lượng

  references:
    - name: work_order_id
      type: uuid
      required: true
      description: Work order
      description_vi: Lệnh sản xuất

    - name: work_order_number
      type: string
      description: Work order number (denormalized)

    - name: operation_id
      type: uuid
      required: true
      description: Operation completed
      description_vi: Công đoạn hoàn thành

    - name: operation_sequence
      type: integer
      description: Operation sequence number

    - name: production_lot_id
      type: uuid
      description: Production lot
      description_vi: Lô sản xuất

  product:
    - name: product_id
      type: uuid
      required: true
      description: Product produced
      description_vi: Sản phẩm

    - name: product_code
      type: string
      description: Product code (denormalized)
      description_vi: Mã sản phẩm

  quantity:
    - name: quantity
      type: decimal
      required: true
      precision: 15
      scale: 4
      description: Quantity reported
      description_vi: Số lượng báo cáo

    - name: unit_of_measure
      type: string
      required: true
      description: Unit of measure
      description_vi: Đơn vị tính

  quality:
    - name: rejection_reason
      type: string
      description: Reason if rejected
      description_vi: Lý do loại

    - name: defect_code
      type: string
      description: Defect classification code
      description_vi: Mã khuyết tật

    - name: rework_work_order_id
      type: uuid
      description: Rework WO if sent to rework

    - name: inspection_result
      type: enum
      values:
        - pending: Not inspected
        - passed: Passed inspection
        - failed: Failed inspection
      description_vi: Kết quả kiểm tra

    - name: inspector_id
      type: uuid
      description: Inspector who checked

  machine:
    - name: machine_id
      type: uuid
      description: Machine that produced
      description_vi: Máy sản xuất

    - name: machine_code
      type: string
      description: Machine code (denormalized)

  time:
    - name: transaction_datetime
      type: datetime
      required: true
      description: When output was recorded
      description_vi: Thời điểm ghi nhận

    - name: shift_id
      type: uuid
      description: Production shift
      description_vi: Ca sản xuất

    - name: setup_time_minutes
      type: decimal
      description: Actual setup time
      description_vi: Thời gian cài đặt thực tế

    - name: run_time_minutes
      type: decimal
      description: Actual run time
      description_vi: Thời gian chạy thực tế

    - name: labor_hours
      type: decimal
      description: Labor hours spent
      description_vi: Giờ nhân công

  operator:
    - name: operator_id
      type: uuid
      description: Operator who reported
      description_vi: Công nhân báo cáo

    - name: operator_name
      type: string
      description: Operator name (denormalized)

  destination:
    - name: warehouse_id
      type: uuid
      description: Output warehouse
      description_vi: Kho đến

    - name: location_id
      type: uuid
      description: Specific location

    - name: next_operation_id
      type: uuid
      description: Next operation in routing

  costing:
    - name: unit_cost
      type: decimal
      precision: 15
      scale: 6
      description: Cost per unit
      description_vi: Giá thành đơn vị

    - name: total_cost
      type: decimal
      precision: 15
      scale: 4
      description: Total output cost
      description_vi: Tổng chi phí

    - name: labor_cost
      type: decimal
      description: Labor cost component

    - name: overhead_cost
      type: decimal
      description: Overhead cost component

  status:
    - name: status
      type: enum
      default: posted
      values:
        - pending: Pending confirmation
        - posted: Confirmed and posted
        - reversed: Reversed
      description_vi: Trạng thái

    - name: reversed_by_id
      type: uuid
      description: Reversal transaction ID

  notes:
    - name: notes
      type: text
      description: Notes
      description_vi: Ghi chú

  audit:
    - name: created_at
      type: timestamp
      auto: true

    - name: created_by
      type: uuid

    - name: updated_at
      type: timestamp
      auto: true

relationships:
  - name: work_order
    type: belongs_to
    entity: work_order
    foreign_key: work_order_id

  - name: operation
    type: belongs_to
    entity: operation
    foreign_key: operation_id

  - name: production_lot
    type: belongs_to
    entity: production_lot
    foreign_key: production_lot_id

  - name: product
    type: belongs_to
    entity: product
    foreign_key: product_id

  - name: machine
    type: belongs_to
    entity: machine
    foreign_key: machine_id

  - name: operator
    type: belongs_to
    entity: operator
    foreign_key: operator_id

  - name: shift
    type: belongs_to
    entity: shift
    foreign_key: shift_id

indexes:
  - columns: [transaction_number]
    unique: true
  - columns: [work_order_id]
  - columns: [operation_id]
  - columns: [production_lot_id]
  - columns: [transaction_datetime]
  - columns: [output_type]

validation_rules:
  - rule: "quantity > 0"
    message: "Quantity must be positive"

  - rule: "output_type IN ('reject', 'scrap') IMPLIES rejection_reason IS NOT NULL"
    message: "Rejection reason required for rejects/scrap"

computed_fields:
  - name: is_final_operation
    formula: "operation_id = (SELECT MAX(id) FROM operations WHERE routing_id = work_order.routing_id)"
    description: Whether this is the final operation
