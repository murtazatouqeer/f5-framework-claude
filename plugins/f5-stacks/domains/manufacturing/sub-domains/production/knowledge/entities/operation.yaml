name: operation
display_name: Routing Operation
display_name_vi: Công đoạn sản xuất
version: "1.0"
domain: manufacturing
subdomain: production
type: entity

description: |
  Individual operation step within a production routing, defining
  work center, times, labor requirements, and quality checks.

description_vi: |
  Bước công đoạn riêng lẻ trong quy trình sản xuất, xác định
  trung tâm làm việc, thời gian, yêu cầu nhân công và kiểm tra chất lượng.

attributes:
  identification:
    - name: id
      type: uuid
      required: true

    - name: routing_id
      type: uuid
      required: true
      description: Parent routing
      description_vi: Quy trình cha

    - name: sequence_number
      type: integer
      required: true
      description: Operation sequence (10, 20, 30...)
      description_vi: Số thứ tự công đoạn

    - name: operation_code
      type: string
      description: Operation code
      description_vi: Mã công đoạn

    - name: name
      type: string
      required: true
      description: Operation name
      description_vi: Tên công đoạn

    - name: description
      type: text
      description: Operation description
      description_vi: Mô tả

    - name: status
      type: enum
      default: active
      values:
        - active: In use
        - inactive: Not used
      description_vi: Trạng thái

  work_center:
    - name: work_center_id
      type: uuid
      required: true
      description: Work center for this operation
      description_vi: Trung tâm làm việc

    - name: machine_id
      type: uuid
      description: Specific machine (optional)
      description_vi: Máy cụ thể

    - name: alternate_work_centers
      type: array
      item_type: uuid
      description: Alternative work centers

  time:
    - name: setup_time_minutes
      type: decimal
      required: true
      default: 0
      description: Setup/changeover time
      description_vi: Thời gian cài đặt (phút)

    - name: run_time_per_unit_minutes
      type: decimal
      required: true
      default: 0
      description: Run time per unit
      description_vi: Thời gian chạy mỗi đơn vị (phút)

    - name: run_time_per_batch_minutes
      type: decimal
      default: 0
      description: Fixed run time per batch

    - name: queue_time_minutes
      type: decimal
      default: 0
      description: Queue time before operation
      description_vi: Thời gian chờ

    - name: move_time_minutes
      type: decimal
      default: 0
      description: Move time after operation
      description_vi: Thời gian di chuyển

    - name: wait_time_minutes
      type: decimal
      default: 0
      description: Wait time after operation

  labor:
    - name: operators_required
      type: integer
      required: true
      default: 1
      description: Number of operators needed
      description_vi: Số công nhân cần

    - name: skill_level_required
      type: enum
      default: standard
      values:
        - entry: Entry level
        - standard: Standard skill
        - skilled: Skilled operator
        - expert: Expert/specialist
      description_vi: Cấp độ kỹ năng

    - name: labor_type
      type: string
      description: Type of labor required

  capacity:
    - name: overlap_percent
      type: decimal
      default: 0
      min: 0
      max: 100
      description: Can start next operation when this % complete
      description_vi: Phần trăm chồng chéo

    - name: batch_size
      type: decimal
      description: Process in batches of this size
      description_vi: Kích thước lô

    - name: max_batch_size
      type: decimal
      description: Maximum batch size

    - name: min_batch_size
      type: decimal
      description: Minimum batch size

  quality:
    - name: inspection_point
      type: boolean
      default: false
      description: Quality inspection required
      description_vi: Điểm kiểm tra chất lượng

    - name: inspection_type
      type: enum
      default: none
      values:
        - none: No inspection
        - sample: Sample inspection
        - 100_percent: 100% inspection
        - first_article: First article only
      description_vi: Loại kiểm tra

    - name: inspection_plan_id
      type: uuid
      description: Quality inspection plan

    - name: control_point
      type: boolean
      default: false
      description: Critical control point

  reporting:
    - name: report_quantity
      type: boolean
      default: true
      description: Report quantity at this operation
      description_vi: Báo cáo số lượng

    - name: report_time
      type: boolean
      default: true
      description: Report time at this operation
      description_vi: Báo cáo thời gian

    - name: count_point
      type: boolean
      default: false
      description: Count point for WIP valuation

    - name: backflush_materials
      type: boolean
      default: false
      description: Backflush materials at completion
      description_vi: Tự động trừ vật tư

  costing:
    - name: labor_rate_per_hour
      type: decimal
      description: Override labor rate

    - name: machine_rate_per_hour
      type: decimal
      description: Override machine rate

    - name: overhead_rate_per_hour
      type: decimal
      description: Override overhead rate

  subcontracting:
    - name: subcontract
      type: boolean
      default: false
      description: Subcontracted operation
      description_vi: Gia công ngoài

    - name: vendor_id
      type: uuid
      description: Subcontract vendor

    - name: subcontract_cost
      type: decimal
      description: Cost per unit for subcontracting

  instructions:
    - name: work_instructions
      type: text
      description: Detailed work instructions
      description_vi: Hướng dẫn công việc

    - name: safety_instructions
      type: text
      description: Safety instructions
      description_vi: Hướng dẫn an toàn

    - name: drawing_reference
      type: string
      description: Drawing or document reference

    - name: attachments
      type: array
      item_type: object
      properties:
        name:
          type: string
        url:
          type: string
        type:
          type: string

  audit:
    - name: created_at
      type: timestamp
      auto: true

    - name: created_by
      type: uuid

    - name: updated_at
      type: timestamp
      auto: true

relationships:
  - name: routing
    type: belongs_to
    entity: routing
    foreign_key: routing_id
    description: Parent routing

  - name: work_center
    type: belongs_to
    entity: work_center
    foreign_key: work_center_id
    description: Primary work center

  - name: machine
    type: belongs_to
    entity: machine
    foreign_key: machine_id
    description: Specific machine

  - name: bom_items
    type: has_many
    entity: bom_item
    foreign_key: operation_id
    description: Materials consumed at this operation

indexes:
  - columns: [routing_id, sequence_number]
    unique: true
  - columns: [work_center_id]
  - columns: [machine_id]

validation_rules:
  - rule: "setup_time_minutes >= 0"
    message: "Setup time cannot be negative"

  - rule: "run_time_per_unit_minutes >= 0"
    message: "Run time cannot be negative"

  - rule: "operators_required >= 1"
    message: "At least one operator required"

  - rule: "overlap_percent >= 0 AND overlap_percent <= 100"
    message: "Overlap must be between 0 and 100"

computed_fields:
  - name: total_time_for_quantity
    formula: "setup_time_minutes + (run_time_per_unit_minutes * quantity)"
    description: Total time for a given quantity
