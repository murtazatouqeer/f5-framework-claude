name: production-lot
display_name: Production Lot
display_name_vi: Lô sản xuất
version: "1.0"
domain: manufacturing
subdomain: production
type: entity

description: |
  Production lot represents a batch of items produced together,
  enabling traceability of materials, processes, and quality data.

description_vi: |
  Lô sản xuất đại diện cho một lô sản phẩm được sản xuất cùng nhau,
  cho phép truy xuất vật liệu, quy trình và dữ liệu chất lượng.

attributes:
  identification:
    - name: id
      type: uuid
      required: true

    - name: lot_number
      type: string
      required: true
      unique: true
      auto_generate: true
      pattern: "^LOT-[0-9]{8}-[A-Z0-9]+$"
      description: Lot number
      description_vi: Số lô

    - name: work_order_id
      type: uuid
      required: true
      description: Source work order
      description_vi: Lệnh sản xuất

    - name: product_id
      type: uuid
      required: true
      description: Product
      description_vi: Sản phẩm

    - name: product_code
      type: string
      description: Product code (denormalized)
      description_vi: Mã sản phẩm

    - name: status
      type: enum
      required: true
      default: in_production
      values:
        - in_production: Being produced
        - completed: Production complete
        - qa_pending: Awaiting QA
        - qa_hold: On QA hold
        - released: Released to inventory
        - blocked: Blocked from use
        - scrapped: Scrapped
      description_vi: Trạng thái

  quantity:
    - name: planned_quantity
      type: decimal
      required: true
      precision: 15
      scale: 4
      description: Planned quantity
      description_vi: Số lượng kế hoạch

    - name: produced_quantity
      type: decimal
      default: 0
      precision: 15
      scale: 4
      description: Total quantity produced
      description_vi: Số lượng sản xuất

    - name: good_quantity
      type: decimal
      default: 0
      precision: 15
      scale: 4
      description: Good/accepted quantity
      description_vi: Số lượng tốt

    - name: rejected_quantity
      type: decimal
      default: 0
      precision: 15
      scale: 4
      description: Rejected quantity
      description_vi: Số lượng loại

    - name: rework_quantity
      type: decimal
      default: 0
      description: Sent to rework

    - name: unit_of_measure
      type: string
      required: true
      description: Unit of measure
      description_vi: Đơn vị tính

  traceability:
    - name: material_lots_used
      type: array
      item_type: object
      properties:
        material_id:
          type: uuid
        material_code:
          type: string
        lot_number:
          type: string
        quantity_used:
          type: decimal
      description: Input material lots
      description_vi: Lô vật tư đầu vào

    - name: equipment_used
      type: array
      item_type: object
      properties:
        machine_id:
          type: uuid
        machine_code:
          type: string
        operation_id:
          type: uuid
      description: Equipment used in production

    - name: operators
      type: array
      item_type: object
      properties:
        operator_id:
          type: uuid
        operator_name:
          type: string
        operation_id:
          type: uuid
      description: Operators who worked on lot

  dates:
    - name: production_date
      type: date
      required: true
      description: Production date
      description_vi: Ngày sản xuất

    - name: production_start
      type: datetime
      description: Production start time
      description_vi: Thời gian bắt đầu

    - name: production_end
      type: datetime
      description: Production end time
      description_vi: Thời gian kết thúc

    - name: expiry_date
      type: date
      description: Expiration date
      description_vi: Ngày hết hạn

    - name: best_before_date
      type: date
      description: Best before date

    - name: release_date
      type: datetime
      description: When released to inventory

  quality:
    - name: qa_status
      type: enum
      default: pending
      values:
        - pending: Not yet inspected
        - in_progress: Inspection in progress
        - passed: Passed inspection
        - failed: Failed inspection
        - conditional: Conditional release
      description_vi: Trạng thái QA

    - name: inspection_results
      type: array
      item_type: object
      properties:
        test_name:
          type: string
        result:
          type: string
        specification:
          type: string
        actual_value:
          type: string
        passed:
          type: boolean
        inspector:
          type: string
        timestamp:
          type: datetime
      description: Quality inspection results

    - name: quality_score
      type: decimal
      description: Overall quality score

    - name: certificate_of_analysis
      type: string
      description: CoA document reference

    - name: qa_approved_by
      type: uuid
      description: QA approver

    - name: qa_approved_at
      type: datetime
      description: QA approval timestamp

    - name: hold_reason
      type: string
      description: Reason if on hold
      description_vi: Lý do giữ

  location:
    - name: current_location
      type: string
      description: Current location
      description_vi: Vị trí hiện tại

    - name: warehouse_id
      type: uuid
      description: Warehouse
      description_vi: Kho

    - name: location_id
      type: uuid
      description: Specific location in warehouse

  costing:
    - name: unit_cost
      type: decimal
      precision: 15
      scale: 6
      description: Cost per unit
      description_vi: Giá thành đơn vị

    - name: total_cost
      type: decimal
      precision: 15
      scale: 4
      description: Total lot cost
      description_vi: Tổng chi phí lô

  notes:
    - name: notes
      type: text
      description: General notes
      description_vi: Ghi chú

    - name: production_notes
      type: text
      description: Production observations

  audit:
    - name: created_at
      type: timestamp
      auto: true

    - name: created_by
      type: uuid

    - name: updated_at
      type: timestamp
      auto: true

    - name: updated_by
      type: uuid

relationships:
  - name: work_order
    type: belongs_to
    entity: work_order
    foreign_key: work_order_id

  - name: product
    type: belongs_to
    entity: product
    foreign_key: product_id

  - name: warehouse
    type: belongs_to
    entity: warehouse
    foreign_key: warehouse_id

indexes:
  - columns: [lot_number]
    unique: true
  - columns: [work_order_id]
  - columns: [product_id, status]
  - columns: [production_date]
  - columns: [expiry_date]
  - columns: [qa_status]

state_machine:
  field: status
  initial: in_production
  transitions:
    - from: in_production
      to: completed
      event: complete_production

    - from: completed
      to: qa_pending
      event: submit_for_qa

    - from: qa_pending
      to: qa_hold
      event: place_on_hold

    - from: [qa_pending, qa_hold]
      to: released
      event: release
      guard: qa_passed

    - from: [qa_pending, qa_hold]
      to: blocked
      event: block

    - from: blocked
      to: released
      event: release
      guard: qa_approved

    - from: [qa_hold, blocked]
      to: scrapped
      event: scrap

validation_rules:
  - rule: "produced_quantity >= 0"
    message: "Produced quantity cannot be negative"

  - rule: "good_quantity + rejected_quantity <= produced_quantity"
    message: "Good + rejected cannot exceed produced"

  - rule: "expiry_date IS NULL OR expiry_date > production_date"
    message: "Expiry date must be after production date"

computed_fields:
  - name: yield_percent
    formula: "(good_quantity / produced_quantity) * 100"
    description: Yield percentage

  - name: rejection_rate
    formula: "(rejected_quantity / produced_quantity) * 100"
    description: Rejection rate
