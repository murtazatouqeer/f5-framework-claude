name: production-schedule
display_name: Production Schedule
display_name_vi: Lịch sản xuất
version: "1.0"
domain: manufacturing
subdomain: production
type: entity

description: |
  Production schedule assigns work orders to work centers and machines
  with specific timing for capacity planning and execution.

description_vi: |
  Lịch sản xuất phân công lệnh sản xuất cho trung tâm làm việc và máy
  với thời gian cụ thể để lập kế hoạch công suất và thực hiện.

attributes:
  identification:
    - name: id
      type: uuid
      required: true

    - name: schedule_number
      type: string
      required: true
      unique: true
      auto_generate: true
      description: Schedule reference
      description_vi: Số lịch sản xuất

    - name: schedule_type
      type: enum
      required: true
      default: firm
      values:
        - planned: Planned/tentative
        - firm: Firm/committed
        - frozen: Cannot be changed
        - actual: Actual execution
      description_vi: Loại lịch

    - name: status
      type: enum
      default: scheduled
      values:
        - draft: Being created
        - scheduled: Scheduled
        - released: Released for execution
        - in_progress: Execution started
        - completed: Completed
        - cancelled: Cancelled
      description_vi: Trạng thái

  work_order:
    - name: work_order_id
      type: uuid
      required: true
      description: Work order
      description_vi: Lệnh sản xuất

    - name: work_order_number
      type: string
      description: Work order number

    - name: operation_id
      type: uuid
      required: true
      description: Specific operation
      description_vi: Công đoạn

    - name: operation_sequence
      type: integer
      description: Operation sequence

  resource:
    - name: work_center_id
      type: uuid
      required: true
      description: Work center
      description_vi: Trung tâm làm việc

    - name: machine_id
      type: uuid
      description: Specific machine
      description_vi: Máy cụ thể

    - name: operator_id
      type: uuid
      description: Assigned operator
      description_vi: Công nhân được phân

  timing:
    - name: scheduled_start
      type: datetime
      required: true
      description: Scheduled start time
      description_vi: Giờ bắt đầu kế hoạch

    - name: scheduled_end
      type: datetime
      required: true
      description: Scheduled end time
      description_vi: Giờ kết thúc kế hoạch

    - name: actual_start
      type: datetime
      description: Actual start time
      description_vi: Giờ bắt đầu thực tế

    - name: actual_end
      type: datetime
      description: Actual end time
      description_vi: Giờ kết thúc thực tế

    - name: setup_start
      type: datetime
      description: Setup start time

    - name: setup_end
      type: datetime
      description: Setup end time

    - name: shift_id
      type: uuid
      description: Assigned shift
      description_vi: Ca sản xuất

  quantity:
    - name: scheduled_quantity
      type: decimal
      required: true
      description: Quantity to produce
      description_vi: Số lượng kế hoạch

    - name: completed_quantity
      type: decimal
      default: 0
      description: Quantity completed
      description_vi: Số lượng hoàn thành

    - name: unit_of_measure
      type: string
      required: true

  time_details:
    - name: setup_time_minutes
      type: decimal
      description: Planned setup time
      description_vi: Thời gian cài đặt (phút)

    - name: run_time_minutes
      type: decimal
      description: Planned run time
      description_vi: Thời gian chạy (phút)

    - name: actual_setup_minutes
      type: decimal
      description: Actual setup time

    - name: actual_run_minutes
      type: decimal
      description: Actual run time

  sequence:
    - name: sequence_number
      type: integer
      description: Sequence on machine
      description_vi: Thứ tự trên máy

    - name: priority
      type: integer
      default: 50
      description: Priority (1-99, lower = higher)
      description_vi: Độ ưu tiên

    - name: previous_schedule_id
      type: uuid
      description: Previous schedule (dependency)

    - name: next_schedule_id
      type: uuid
      description: Next schedule

  constraints:
    - name: earliest_start
      type: datetime
      description: Cannot start before
      description_vi: Không thể bắt đầu trước

    - name: latest_end
      type: datetime
      description: Must finish by
      description_vi: Phải hoàn thành trước

    - name: locked
      type: boolean
      default: false
      description: Schedule is locked
      description_vi: Lịch bị khóa

    - name: lock_reason
      type: string
      description: Reason for lock

  capacity:
    - name: capacity_consumed
      type: decimal
      description: Capacity units consumed
      description_vi: Công suất tiêu thụ

    - name: load_percent
      type: decimal
      description: Load on resource (%)
      description_vi: Tải trọng (%)

  notes:
    - name: notes
      type: text
      description: Notes
      description_vi: Ghi chú

    - name: delay_reason
      type: string
      description: Reason if delayed

  audit:
    - name: created_at
      type: timestamp
      auto: true

    - name: created_by
      type: uuid

    - name: updated_at
      type: timestamp
      auto: true

    - name: scheduled_by
      type: uuid
      description: Who created schedule

relationships:
  - name: work_order
    type: belongs_to
    entity: work_order
    foreign_key: work_order_id

  - name: operation
    type: belongs_to
    entity: operation
    foreign_key: operation_id

  - name: work_center
    type: belongs_to
    entity: work_center
    foreign_key: work_center_id

  - name: machine
    type: belongs_to
    entity: machine
    foreign_key: machine_id

  - name: operator
    type: belongs_to
    entity: operator
    foreign_key: operator_id

  - name: shift
    type: belongs_to
    entity: shift
    foreign_key: shift_id

  - name: previous_schedule
    type: belongs_to
    entity: production_schedule
    foreign_key: previous_schedule_id

indexes:
  - columns: [schedule_number]
    unique: true
  - columns: [work_order_id, operation_id]
  - columns: [work_center_id, scheduled_start]
  - columns: [machine_id, scheduled_start]
  - columns: [status]
  - columns: [scheduled_start]

state_machine:
  field: status
  initial: draft
  transitions:
    - from: draft
      to: scheduled
      event: schedule

    - from: scheduled
      to: released
      event: release

    - from: released
      to: in_progress
      event: start
      action: record_actual_start

    - from: in_progress
      to: completed
      event: complete
      action: record_actual_end

    - from: [draft, scheduled, released]
      to: cancelled
      event: cancel

validation_rules:
  - rule: "scheduled_end > scheduled_start"
    message: "End time must be after start time"

  - rule: "scheduled_quantity > 0"
    message: "Quantity must be positive"

  - rule: "earliest_start IS NULL OR scheduled_start >= earliest_start"
    message: "Cannot schedule before earliest start"

  - rule: "latest_end IS NULL OR scheduled_end <= latest_end"
    message: "Cannot schedule after latest end"

computed_fields:
  - name: scheduled_duration_minutes
    formula: "TIMESTAMPDIFF(MINUTE, scheduled_start, scheduled_end)"
    description: Scheduled duration

  - name: actual_duration_minutes
    formula: "TIMESTAMPDIFF(MINUTE, actual_start, actual_end)"
    description: Actual duration

  - name: variance_minutes
    formula: "actual_duration_minutes - scheduled_duration_minutes"
    description: Duration variance

scheduling_methods:
  forward:
    description: Schedule from start date forward
    use_case: When start date is fixed

  backward:
    description: Schedule from due date backward
    use_case: When end date is fixed

  finite:
    description: Respect capacity constraints
    use_case: Realistic scheduling

  infinite:
    description: Ignore capacity limits
    use_case: Initial planning
