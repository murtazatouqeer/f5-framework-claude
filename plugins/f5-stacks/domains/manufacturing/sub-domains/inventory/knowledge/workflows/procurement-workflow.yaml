name: procurement-workflow
display_name: Procurement Workflow
display_name_vi: Quy trình mua hàng
version: "1.0"
domain: manufacturing
subdomain: inventory

description: |
  End-to-end procurement workflow from requisition to payment.
  Covers requisition creation, RFQ process, PO creation,
  approval routing, and supplier communication.

workflow_type: sequential
triggers:
  - Material requirement generated by MRP
  - Manual requisition request
  - Reorder point trigger
  - Safety stock replenishment

participants:
  - role: requester
    description: User creating the requisition
  - role: buyer
    description: Procurement specialist
  - role: approver
    description: Approval authority based on value
  - role: supplier
    description: External supplier
  - role: finance
    description: Finance/accounts payable

stages:
  # ============================================
  # STAGE 1: REQUISITION
  # ============================================
  - id: requisition
    name: Requisition Creation
    name_vi: Tạo yêu cầu mua hàng
    sequence: 1
    description: Create and submit purchase requisition

    steps:
      - id: create_requisition
        name: Create Requisition
        actor: requester
        description: Create purchase requisition with required items
        inputs:
          - Material ID or description
          - Quantity needed
          - Required date
          - Cost center / Project
          - Justification
        validations:
          - Material must be active
          - Quantity > 0
          - Required date >= today + lead time
        outputs:
          - Draft requisition

      - id: validate_requisition
        name: Validate Requisition
        actor: system
        description: System validates requisition data
        validations:
          - Budget availability (if budget control)
          - Material availability check
          - Duplicate check
          - Required fields complete
        auto_actions:
          - Calculate estimated cost
          - Determine approval route
        outputs:
          - Validated requisition

      - id: submit_requisition
        name: Submit for Approval
        actor: requester
        description: Submit requisition for approval
        conditions:
          - All validations passed
        outputs:
          - Submitted requisition
          - Notification to approvers

  # ============================================
  # STAGE 2: APPROVAL
  # ============================================
  - id: approval
    name: Requisition Approval
    name_vi: Phê duyệt yêu cầu
    sequence: 2
    description: Route requisition through approval chain

    steps:
      - id: determine_approval_route
        name: Determine Approval Route
        actor: system
        description: Determine approval chain based on value and type
        rules:
          - value: "< 10,000,000 VND"
            approvers: [department_manager]
          - value: "10,000,000 - 50,000,000 VND"
            approvers: [department_manager, procurement_manager]
          - value: "> 50,000,000 VND"
            approvers: [department_manager, procurement_manager, director]
        outputs:
          - Approval routing

      - id: approval_cycle
        name: Approval Cycle
        actor: approver
        description: Each approver reviews and decides
        actions:
          approve:
            - Route to next approver (if any)
            - Update status
          reject:
            - Return to requester with reason
            - End workflow
          request_info:
            - Pause approval
            - Request clarification
        sla: 48 hours per approver
        escalation:
          - Reminder at 24 hours
          - Escalate to supervisor at 48 hours

      - id: final_approval
        name: Final Approval
        actor: system
        description: Complete approval process
        conditions:
          - All approvers approved
        outputs:
          - Approved requisition
          - Release to procurement

  # ============================================
  # STAGE 3: SOURCING
  # ============================================
  - id: sourcing
    name: Sourcing Decision
    name_vi: Quyết định nguồn cung
    sequence: 3
    description: Determine supplier and pricing

    steps:
      - id: source_determination
        name: Source Determination
        actor: buyer
        description: Identify potential suppliers
        methods:
          - Check existing contracts
          - Check approved supplier list
          - Consider alternate sources
        outputs:
          - List of potential suppliers

      - id: rfq_decision
        name: RFQ Decision
        actor: buyer
        description: Decide if RFQ process needed
        rules:
          - Contract exists: No RFQ needed
          - Single source: May skip RFQ
          - Value < threshold: Direct PO
          - Value >= threshold: RFQ required
        outputs:
          - RFQ requirement decision

      - id: create_rfq
        name: Create RFQ
        actor: buyer
        description: Create and send request for quotation
        conditions:
          - RFQ required per decision
        inputs:
          - Material specifications
          - Quantity
          - Required delivery date
          - Terms and conditions
        outputs:
          - RFQ sent to suppliers

      - id: receive_quotes
        name: Receive Quotes
        actor: buyer
        description: Receive and record supplier quotations
        sla: Per RFQ deadline (typically 5-10 days)
        inputs:
          - Supplier quotations
          - Terms offered
          - Delivery commitments
        outputs:
          - Recorded quotations

      - id: evaluate_quotes
        name: Evaluate Quotes
        actor: buyer
        description: Compare and score quotations
        criteria:
          - Price (40%)
          - Delivery (25%)
          - Quality history (20%)
          - Terms (15%)
        outputs:
          - Quote comparison report
          - Recommended supplier

      - id: select_supplier
        name: Select Supplier
        actor: buyer
        description: Make final supplier selection
        documentation:
          - Selection justification
          - Price negotiation results
        outputs:
          - Selected supplier
          - Negotiated terms

  # ============================================
  # STAGE 4: PURCHASE ORDER
  # ============================================
  - id: purchase_order
    name: Purchase Order Creation
    name_vi: Tạo đơn đặt hàng
    sequence: 4
    description: Create and approve purchase order

    steps:
      - id: create_po
        name: Create Purchase Order
        actor: buyer
        description: Create PO from requisition/quote
        inputs:
          - Approved requisition
          - Selected supplier
          - Negotiated price/terms
        auto_populate:
          - Payment terms from supplier master
          - Delivery address from plant
          - Tax codes from material
        outputs:
          - Draft purchase order

      - id: po_approval
        name: PO Approval
        actor: approver
        description: Approve purchase order (if required)
        conditions:
          - PO value > auto-approval limit
          - Non-contract purchase
        rules:
          similar_to: requisition_approval
        outputs:
          - Approved purchase order

      - id: send_po
        name: Send PO to Supplier
        actor: buyer
        description: Transmit PO to supplier
        methods:
          - EDI transmission
          - Email with PDF
          - Supplier portal
          - Fax
        outputs:
          - Transmitted PO
          - Transmission confirmation

  # ============================================
  # STAGE 5: ORDER MANAGEMENT
  # ============================================
  - id: order_management
    name: Order Management
    name_vi: Quản lý đơn hàng
    sequence: 5
    description: Track and manage order through delivery

    steps:
      - id: supplier_acknowledgment
        name: Supplier Acknowledgment
        actor: supplier
        description: Supplier confirms order receipt
        expected_within: 2 business days
        actions:
          - Confirm order
          - Request changes
          - Reject order
        outputs:
          - Acknowledgment status

      - id: order_tracking
        name: Order Tracking
        actor: buyer
        description: Monitor order progress
        tracking_points:
          - Order confirmed
          - In production
          - Ready to ship
          - Shipped
          - In transit
          - Delivered
        alerts:
          - Late shipment warning
          - Quantity change
          - Delivery date change

      - id: expedite_if_needed
        name: Expedite if Needed
        actor: buyer
        description: Follow up on delayed orders
        triggers:
          - Order late vs promised date
          - Urgent need from production
        actions:
          - Contact supplier
          - Request expedited shipping
          - Seek alternate source

  # ============================================
  # STAGE 6: COMPLETION
  # ============================================
  - id: completion
    name: Order Completion
    name_vi: Hoàn tất đơn hàng
    sequence: 6
    description: Close order after receipt and payment

    steps:
      - id: verify_receipt
        name: Verify Receipt
        actor: buyer
        description: Confirm goods receipt completed
        checks:
          - All lines received
          - Within tolerance
          - Quality accepted
        outputs:
          - Receipt status

      - id: invoice_matching
        name: Invoice Matching
        actor: finance
        description: Match invoice to PO and GR
        three_way_match:
          - PO line item
          - GR quantity
          - Invoice amount
        variances:
          - Price variance → investigate
          - Quantity variance → investigate
        outputs:
          - Matched invoice
          - Variance report

      - id: close_po
        name: Close Purchase Order
        actor: buyer
        description: Close completed purchase order
        conditions:
          - All lines received or cancelled
          - All invoices processed
        actions:
          - Set PO status to closed
          - Update supplier statistics
        outputs:
          - Closed purchase order

process_metrics:
  - name: Requisition to PO Time
    formula: AVG(PO_Date - Requisition_Date)
    target: "< 5 business days"

  - name: RFQ Cycle Time
    formula: AVG(Quote_Selection - RFQ_Sent)
    target: "< 10 business days"

  - name: PO Approval Time
    formula: AVG(PO_Approved - PO_Submitted)
    target: "< 24 hours"

  - name: On-Time Delivery
    formula: (On_Time_Receipts / Total_Receipts) × 100
    target: "> 95%"

exceptions:
  - name: Emergency Purchase
    description: Bypass normal flow for urgent needs
    approval: VP or designated authority
    documentation: Emergency justification required
    post_action: Create regular requisition within 24 hours

  - name: Sole Source
    description: Only one supplier available
    approval: Procurement Manager
    documentation: Sole source justification

  - name: Contract Override
    description: Purchase outside contract terms
    approval: Contract owner + Procurement Manager
    documentation: Override justification

integrations:
  - system: ERP
    integration_points: [requisition, PO, receipt, invoice]
  - system: Supplier Portal
    integration_points: [RFQ, PO, ASN, invoice]
  - system: Budget System
    integration_points: [commitment, expense]
