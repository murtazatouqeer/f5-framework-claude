name: StockLocation
display_name: Stock Location / Vị trí kho
description: |
  Physical storage location within a warehouse.
  Defines storage bins, zones, and areas with capacity,
  restrictions, and picking priority settings.

domain: manufacturing
subdomain: inventory
category: master_data

attributes:
  # Identification
  - name: id
    type: uuid
    required: true
    description: Unique identifier

  - name: location_code
    type: string
    required: true
    description: Location code/bin number
    validation:
      pattern: "^[A-Z0-9]{2,20}$"
    example: "A-01-01-01"

  - name: status
    type: enum
    required: true
    description: Location status
    validation:
      values: [active, inactive, blocked, maintenance]
    default: active

  - name: location_type
    type: enum
    required: true
    description: Type of location
    validation:
      values:
        - storage         # Regular storage bin
        - receiving       # Inbound staging
        - shipping        # Outbound staging
        - production      # Production floor
        - quality         # QC inspection area
        - quarantine      # Quarantine/hold area
        - cross_dock      # Cross-docking area
        - staging         # General staging
        - picking         # Forward picking
        - reserve         # Reserve/bulk storage
        - returns         # Returns processing
        - damage          # Damaged goods
        - scrap           # Scrap/disposal
    default: storage

  # Hierarchy
  - name: plant_id
    type: uuid
    required: true
    description: Plant/facility

  - name: warehouse_id
    type: uuid
    required: true
    description: Parent warehouse

  - name: zone_id
    type: uuid
    required: false
    description: Warehouse zone

  - name: aisle
    type: string
    required: false
    description: Aisle identifier
    validation:
      max_length: 10

  - name: rack
    type: string
    required: false
    description: Rack/bay identifier
    validation:
      max_length: 10

  - name: level
    type: string
    required: false
    description: Shelf level
    validation:
      max_length: 10

  - name: position
    type: string
    required: false
    description: Position on level
    validation:
      max_length: 10

  # Description
  - name: name
    type: string
    required: false
    description: Location name/description
    validation:
      max_length: 100

  - name: description
    type: string
    required: false
    description: Detailed description
    validation:
      max_length: 500

  # Physical attributes
  - name: dimensions
    type: object
    required: false
    description: Physical dimensions
    example:
      length_cm: 120
      width_cm: 100
      height_cm: 150

  - name: max_weight_kg
    type: decimal
    required: false
    description: Maximum weight capacity
    validation:
      min: 0

  - name: max_volume_cbm
    type: decimal
    required: false
    description: Maximum volume capacity
    validation:
      min: 0

  - name: max_pallets
    type: integer
    required: false
    description: Maximum pallet capacity
    validation:
      min: 0

  - name: floor_level
    type: boolean
    required: false
    description: Is floor level (no lifting required)
    default: false

  - name: height_from_floor_cm
    type: integer
    required: false
    description: Height from floor
    validation:
      min: 0

  # Storage conditions
  - name: storage_type
    type: enum
    required: true
    description: Storage environment type
    validation:
      values: [ambient, temperature_controlled, cold, frozen, hazardous, clean_room]
    default: ambient

  - name: temperature_min
    type: decimal
    required: false
    description: Minimum temperature (Celsius)

  - name: temperature_max
    type: decimal
    required: false
    description: Maximum temperature (Celsius)

  - name: humidity_controlled
    type: boolean
    required: false
    description: Humidity controlled
    default: false

  - name: humidity_min
    type: integer
    required: false
    description: Minimum humidity percentage
    validation:
      min: 0
      max: 100

  - name: humidity_max
    type: integer
    required: false
    description: Maximum humidity percentage
    validation:
      min: 0
      max: 100

  # Restrictions
  - name: material_type_restriction
    type: array
    required: false
    description: Allowed material types
    items:
      type: string
    example: ["raw_material", "component"]

  - name: material_group_restriction
    type: array
    required: false
    description: Allowed material groups
    items:
      type: string

  - name: hazardous_allowed
    type: boolean
    required: false
    description: Can store hazardous materials
    default: false

  - name: hazard_classes_allowed
    type: array
    required: false
    description: Allowed hazard classes
    items:
      type: string

  - name: mixed_materials
    type: boolean
    required: false
    description: Can store multiple materials
    default: true

  - name: mixed_batches
    type: boolean
    required: false
    description: Can store multiple batches
    default: false

  # Operations
  - name: putaway_allowed
    type: boolean
    required: true
    description: Can putaway to this location
    default: true

  - name: picking_allowed
    type: boolean
    required: true
    description: Can pick from this location
    default: true

  - name: replenishment_allowed
    type: boolean
    required: false
    description: Can replenish this location
    default: false

  - name: count_allowed
    type: boolean
    required: true
    description: Can count this location
    default: true

  - name: adjustment_allowed
    type: boolean
    required: false
    description: Can adjust inventory
    default: true

  # Priority
  - name: putaway_priority
    type: integer
    required: false
    description: Priority for putaway (lower = higher priority)
    validation:
      min: 1
      max: 999
    default: 500

  - name: picking_priority
    type: integer
    required: false
    description: Priority for picking (lower = higher priority)
    validation:
      min: 1
      max: 999
    default: 500

  # ABC classification
  - name: abc_zone
    type: enum
    required: false
    description: ABC zone classification
    validation:
      values: [A, B, C]
    note: "A = Fast movers, B = Medium, C = Slow movers"

  - name: velocity_class
    type: enum
    required: false
    description: Velocity classification
    validation:
      values: [fast, medium, slow, dead]

  # Current utilization
  - name: current_weight_kg
    type: decimal
    required: false
    description: Current weight stored
    validation:
      min: 0
    default: 0

  - name: current_volume_cbm
    type: decimal
    required: false
    description: Current volume stored
    validation:
      min: 0
    default: 0

  - name: current_pallets
    type: integer
    required: false
    description: Current pallets stored
    default: 0

  - name: utilization_percentage
    type: decimal
    required: false
    description: Capacity utilization
    validation:
      min: 0
      max: 100
    computed: true

  - name: empty
    type: boolean
    required: false
    description: Location is empty
    computed: true

  # Coordinates (for WMS integration)
  - name: x_coordinate
    type: decimal
    required: false
    description: X position in warehouse

  - name: y_coordinate
    type: decimal
    required: false
    description: Y position in warehouse

  - name: z_coordinate
    type: decimal
    required: false
    description: Z position (height)

  # Blocking
  - name: blocked
    type: boolean
    required: true
    description: Location is blocked
    default: false

  - name: blocked_reason
    type: string
    required: false
    description: Reason for blocking
    validation:
      max_length: 200

  - name: blocked_at
    type: timestamp
    required: false
    description: Block timestamp

  - name: blocked_by
    type: uuid
    required: false
    description: User who blocked

  # Last activity
  - name: last_putaway_date
    type: timestamp
    required: false
    description: Last putaway date

  - name: last_pick_date
    type: timestamp
    required: false
    description: Last picking date

  - name: last_count_date
    type: timestamp
    required: false
    description: Last inventory count

  # Audit
  - name: created_by
    type: uuid
    required: true
    description: User who created

  - name: created_at
    type: timestamp
    required: true
    description: Creation timestamp

  - name: updated_by
    type: uuid
    required: false
    description: Last updated by

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

relationships:
  - name: warehouse
    type: belongs_to
    entity: Warehouse
    required: true
    description: Parent warehouse

  - name: zone
    type: belongs_to
    entity: WarehouseZone
    required: false
    description: Warehouse zone

  - name: inventory
    type: has_many
    entity: Inventory
    description: Inventory at this location

  - name: transactions
    type: has_many
    entity: InventoryTransaction
    description: Transactions at this location

indexes:
  - [location_code]
  - [warehouse_id, location_type]
  - [warehouse_id, zone_id]
  - [warehouse_id, aisle, rack, level]
  - [status]
  - [storage_type]
  - [abc_zone]
  - [empty]
  - [blocked]

business_rules:
  - BR-LOC-001: Location code unique within warehouse
  - BR-LOC-002: Cannot putaway to blocked location
  - BR-LOC-003: Cannot pick from blocked location
  - BR-LOC-004: Cannot exceed max weight/volume capacity
  - BR-LOC-005: Hazardous materials only in hazardous_allowed locations
  - BR-LOC-006: Temperature-sensitive items in appropriate storage_type
  - BR-LOC-007: Mixed batch not allowed unless mixed_batches = true
  - BR-LOC-008: Cannot deactivate location with inventory
  - BR-LOC-009: Priority values must be within range 1-999
  - BR-LOC-010: Coordinates required for automated warehouse

computed_fields:
  - name: utilization_percentage
    formula: |
      MAX(
        (current_weight_kg / NULLIF(max_weight_kg, 0)) * 100,
        (current_volume_cbm / NULLIF(max_volume_cbm, 0)) * 100,
        (current_pallets / NULLIF(max_pallets, 0)) * 100
      )
    description: Highest utilization metric

  - name: empty
    formula: current_weight_kg = 0 AND current_volume_cbm = 0 AND current_pallets = 0
    description: True if no inventory

events:
  - name: location.created
    payload: [id, location_code, warehouse_id, location_type]
    description: Location created

  - name: location.blocked
    payload: [id, location_code, blocked_reason]
    description: Location blocked

  - name: location.unblocked
    payload: [id, location_code]
    description: Location unblocked

  - name: location.capacity_warning
    payload: [id, location_code, utilization_percentage]
    description: Approaching capacity limit

  - name: location.full
    payload: [id, location_code]
    description: Location at full capacity
