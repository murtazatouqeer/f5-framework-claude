name: ReorderPoint
display_name: Reorder Point / Điểm đặt hàng lại
description: |
  Configuration for material reorder parameters by location.
  Defines safety stock, reorder point, maximum stock,
  and automatic replenishment triggers.

domain: manufacturing
subdomain: inventory
category: master_data

attributes:
  # Identification
  - name: id
    type: uuid
    required: true
    description: Unique identifier

  - name: material_id
    type: uuid
    required: true
    description: Material reference

  - name: plant_id
    type: uuid
    required: true
    description: Plant where this applies

  - name: warehouse_id
    type: uuid
    required: false
    description: Specific warehouse (if different by warehouse)

  - name: status
    type: enum
    required: true
    description: Configuration status
    validation:
      values: [active, inactive]
    default: active

  # Reorder levels
  - name: safety_stock
    type: decimal
    required: true
    description: Safety stock quantity
    validation:
      min: 0
      precision: 3
    default: 0

  - name: reorder_point
    type: decimal
    required: true
    description: Reorder point quantity
    validation:
      min: 0
      precision: 3

  - name: reorder_qty
    type: decimal
    required: false
    description: Fixed reorder quantity
    validation:
      min: 0
      precision: 3

  - name: max_stock
    type: decimal
    required: false
    description: Maximum stock level
    validation:
      min: 0
      precision: 3

  - name: min_order_qty
    type: decimal
    required: false
    description: Minimum order quantity
    validation:
      min: 0
      precision: 3
    default: 1

  - name: order_multiple
    type: decimal
    required: false
    description: Order quantity multiple
    validation:
      min: 0
      precision: 3
    default: 1

  - name: unit_of_measure
    type: string
    required: true
    description: Unit of measure
    validation:
      max_length: 10

  # Calculation method
  - name: calculation_method
    type: enum
    required: true
    description: How levels are calculated
    validation:
      values:
        - manual             # Manually set
        - usage_based        # Based on historical usage
        - forecast_based     # Based on demand forecast
        - service_level      # Based on service level target
        - lead_time_demand   # Lead time * avg daily demand
    default: manual

  - name: service_level_target
    type: decimal
    required: false
    description: Target service level percentage
    validation:
      min: 0
      max: 100
    default: 95

  # Lead time
  - name: lead_time_days
    type: integer
    required: true
    description: Lead time in days
    validation:
      min: 0
    default: 7

  - name: lead_time_variance_days
    type: integer
    required: false
    description: Lead time variance
    validation:
      min: 0
    default: 0

  # Demand data
  - name: avg_daily_usage
    type: decimal
    required: false
    description: Average daily usage
    validation:
      min: 0
      precision: 3

  - name: usage_variance
    type: decimal
    required: false
    description: Usage standard deviation
    validation:
      min: 0
      precision: 3

  - name: demand_type
    type: enum
    required: false
    description: Demand pattern type
    validation:
      values: [constant, trend, seasonal, intermittent, lumpy]
    default: constant

  - name: seasonality_factor
    type: decimal
    required: false
    description: Seasonality multiplier
    validation:
      min: 0
    default: 1

  # Calculation period
  - name: review_period_days
    type: integer
    required: false
    description: Review period for periodic system
    validation:
      min: 1

  - name: calculation_period_months
    type: integer
    required: false
    description: Months of history for calculation
    validation:
      min: 1
      max: 24
    default: 12

  - name: last_calculation_date
    type: timestamp
    required: false
    description: Last automatic calculation

  - name: next_calculation_date
    type: date
    required: false
    description: Next scheduled calculation

  # Replenishment
  - name: auto_replenish
    type: boolean
    required: true
    description: Enable automatic replenishment
    default: true

  - name: replenishment_type
    type: enum
    required: true
    description: Type of replenishment
    validation:
      values: [purchase, production, transfer, kanban]
    default: purchase

  - name: replenishment_source
    type: string
    required: false
    description: Source for replenishment
    validation:
      max_length: 100

  - name: supplier_id
    type: uuid
    required: false
    description: Default supplier

  - name: source_plant_id
    type: uuid
    required: false
    description: Source plant (for transfer)

  - name: source_warehouse_id
    type: uuid
    required: false
    description: Source warehouse (for transfer)

  # Alert settings
  - name: alert_enabled
    type: boolean
    required: true
    description: Enable low stock alerts
    default: true

  - name: alert_threshold_days
    type: integer
    required: false
    description: Days of supply to trigger alert
    validation:
      min: 0
    default: 7

  - name: critical_level
    type: decimal
    required: false
    description: Critical stock level
    validation:
      min: 0
      precision: 3

  - name: alert_recipients
    type: array
    required: false
    description: Users to notify on alert
    items:
      type: uuid

  # ABC/XYZ classification
  - name: abc_class
    type: enum
    required: false
    description: ABC classification
    validation:
      values: [A, B, C]

  - name: xyz_class
    type: enum
    required: false
    description: XYZ classification
    validation:
      values: [X, Y, Z]

  - name: review_frequency
    type: enum
    required: false
    description: Review frequency based on classification
    validation:
      values: [daily, weekly, biweekly, monthly, quarterly]
    default: monthly

  # Current status
  - name: current_stock
    type: decimal
    required: false
    description: Current stock level
    validation:
      precision: 3
    computed: true

  - name: days_of_supply
    type: decimal
    required: false
    description: Current days of supply
    computed: true

  - name: below_reorder_point
    type: boolean
    required: false
    description: Currently below reorder point
    computed: true

  - name: below_safety_stock
    type: boolean
    required: false
    description: Currently below safety stock
    computed: true

  - name: above_max_stock
    type: boolean
    required: false
    description: Currently above max stock
    computed: true

  # Override
  - name: manual_override
    type: boolean
    required: false
    description: Manually overridden values
    default: false

  - name: override_reason
    type: string
    required: false
    description: Reason for override
    validation:
      max_length: 200

  - name: override_expiry
    type: date
    required: false
    description: Override expiry date

  # Audit
  - name: created_by
    type: uuid
    required: true
    description: User who created

  - name: created_at
    type: timestamp
    required: true
    description: Creation timestamp

  - name: updated_by
    type: uuid
    required: false
    description: Last updated by

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

relationships:
  - name: material
    type: belongs_to
    entity: Material
    required: true
    description: Material for this configuration

  - name: plant
    type: belongs_to
    entity: Plant
    required: true
    description: Plant

  - name: warehouse
    type: belongs_to
    entity: Warehouse
    required: false
    description: Warehouse

  - name: supplier
    type: belongs_to
    entity: Supplier
    required: false
    description: Default supplier

  - name: source_plant
    type: belongs_to
    entity: Plant
    required: false
    description: Source plant for transfers

indexes:
  - [material_id, plant_id, warehouse_id]
  - [material_id, plant_id]
  - [status]
  - [auto_replenish]
  - [below_reorder_point]
  - [below_safety_stock]
  - [abc_class]
  - [next_calculation_date]

unique_constraints:
  - name: unique_reorder_config
    columns: [material_id, plant_id, warehouse_id]
    description: One configuration per material+plant+warehouse

business_rules:
  - BR-ROP-001: Reorder point >= safety stock
  - BR-ROP-002: Max stock >= reorder point
  - BR-ROP-003: Order multiple must divide evenly into order qty
  - BR-ROP-004: Service level between 0 and 100
  - BR-ROP-005: Auto calculation based on method and period
  - BR-ROP-006: Supplier required if replenishment_type = purchase
  - BR-ROP-007: Source plant required if replenishment_type = transfer
  - BR-ROP-008: Override expiry must be future date
  - BR-ROP-009: ABC-A items have more frequent review
  - BR-ROP-010: Lead time variance affects safety stock calculation

computed_fields:
  - name: current_stock
    formula: SUM(Inventory.on_hand_qty WHERE material_id AND plant_id)
    description: Current total stock

  - name: days_of_supply
    formula: current_stock / NULLIF(avg_daily_usage, 0)
    description: Days of supply remaining

  - name: below_reorder_point
    formula: current_stock < reorder_point
    description: Stock below reorder point

  - name: below_safety_stock
    formula: current_stock < safety_stock
    description: Stock below safety stock

  - name: above_max_stock
    formula: current_stock > max_stock
    description: Stock above max level

events:
  - name: rop.below_reorder_point
    payload: [id, material_id, plant_id, current_stock, reorder_point]
    description: Stock fell below reorder point

  - name: rop.below_safety_stock
    payload: [id, material_id, plant_id, current_stock, safety_stock]
    description: Stock fell below safety stock

  - name: rop.critical_level
    payload: [id, material_id, plant_id, current_stock, critical_level]
    description: Stock at critical level

  - name: rop.recalculated
    payload: [id, material_id, safety_stock, reorder_point, max_stock]
    description: Levels recalculated

  - name: rop.replenishment_triggered
    payload: [id, material_id, order_qty, replenishment_type]
    description: Auto replenishment triggered
