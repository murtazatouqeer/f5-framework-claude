name: PurchaseOrderLine
display_name: Purchase Order Line / Dòng đơn đặt hàng
description: |
  Individual line item on a purchase order specifying material,
  quantity, pricing, and delivery details. Supports partial
  receipts and delivery schedule tracking.

domain: manufacturing
subdomain: inventory
category: transaction

attributes:
  # Identification
  - name: id
    type: uuid
    required: true
    description: Unique identifier

  - name: purchase_order_id
    type: uuid
    required: true
    description: Parent purchase order

  - name: line_number
    type: integer
    required: true
    description: Line number within PO
    validation:
      min: 1

  - name: status
    type: enum
    required: true
    description: Line status
    validation:
      values: [open, partially_received, received, invoiced, closed, cancelled]
    default: open

  # Material
  - name: material_id
    type: uuid
    required: true
    description: Material being ordered

  - name: material_description
    type: string
    required: false
    description: Description override
    validation:
      max_length: 200

  - name: supplier_part_number
    type: string
    required: false
    description: Supplier's part number
    validation:
      max_length: 40

  # Quantity
  - name: quantity
    type: decimal
    required: true
    description: Order quantity
    validation:
      min: 0.001
      precision: 3

  - name: unit_of_measure
    type: string
    required: true
    description: Order UoM
    validation:
      max_length: 10

  - name: received_qty
    type: decimal
    required: true
    description: Total received quantity
    validation:
      min: 0
      precision: 3
    default: 0

  - name: remaining_qty
    type: decimal
    required: false
    description: Remaining to receive
    computed: true
    formula: "quantity - received_qty"

  - name: over_delivery_tolerance
    type: decimal
    required: false
    description: Over-delivery tolerance percentage
    validation:
      min: 0
      max: 100
    default: 0

  - name: under_delivery_tolerance
    type: decimal
    required: false
    description: Under-delivery tolerance percentage
    validation:
      min: 0
      max: 100
    default: 0

  # Pricing
  - name: unit_price
    type: decimal
    required: true
    description: Price per unit
    validation:
      min: 0
      precision: 4

  - name: price_unit
    type: integer
    required: true
    description: Price per X units
    default: 1

  - name: discount_type
    type: enum
    required: false
    description: Line discount type
    validation:
      values: [percentage, amount]

  - name: discount_value
    type: decimal
    required: false
    description: Discount value
    validation:
      min: 0

  - name: net_price
    type: decimal
    required: true
    description: Net price after discount
    validation:
      precision: 4
    computed: true

  - name: tax_code
    type: string
    required: false
    description: Tax code
    validation:
      max_length: 10

  - name: tax_rate
    type: decimal
    required: false
    description: Tax rate percentage
    validation:
      min: 0
      max: 100
    default: 0

  - name: tax_amount
    type: decimal
    required: false
    description: Line tax amount
    validation:
      precision: 2
    computed: true

  - name: total_amount
    type: decimal
    required: true
    description: Line total including tax
    validation:
      precision: 2
    computed: true
    formula: "(quantity * net_price / price_unit) + tax_amount"

  # Delivery
  - name: requested_date
    type: date
    required: true
    description: Requested delivery date

  - name: promised_date
    type: date
    required: false
    description: Supplier promised date

  - name: plant_id
    type: uuid
    required: true
    description: Receiving plant

  - name: warehouse_id
    type: uuid
    required: false
    description: Receiving warehouse

  - name: location_id
    type: uuid
    required: false
    description: Storage location

  # Batch/Quality
  - name: batch_number
    type: string
    required: false
    description: Required batch number
    validation:
      max_length: 20

  - name: inspection_required
    type: boolean
    required: false
    description: Quality inspection required
    default: false

  - name: certificate_required
    type: boolean
    required: false
    description: Certificate of analysis required
    default: false

  # Account assignment
  - name: account_assignment
    type: enum
    required: false
    description: Account assignment category
    validation:
      values: [stock, cost_center, asset, project, order]
    default: stock

  - name: cost_center
    type: string
    required: false
    description: Cost center (if account_assignment = cost_center)
    validation:
      max_length: 10

  - name: gl_account
    type: string
    required: false
    description: G/L account
    validation:
      max_length: 10

  - name: asset_number
    type: string
    required: false
    description: Asset number (if account_assignment = asset)
    validation:
      max_length: 12

  - name: project_id
    type: uuid
    required: false
    description: Project (if account_assignment = project)

  # Reference
  - name: requisition_line_id
    type: uuid
    required: false
    description: Source requisition line

  - name: contract_line_id
    type: uuid
    required: false
    description: Framework contract line

  - name: quote_line_id
    type: uuid
    required: false
    description: Source quote line

  # Invoice tracking
  - name: invoiced_qty
    type: decimal
    required: true
    description: Quantity invoiced
    validation:
      min: 0
      precision: 3
    default: 0

  - name: invoiced_amount
    type: decimal
    required: true
    description: Amount invoiced
    validation:
      min: 0
      precision: 2
    default: 0

  # Notes
  - name: notes
    type: string
    required: false
    description: Line notes
    validation:
      max_length: 500

  - name: supplier_notes
    type: string
    required: false
    description: Notes for supplier
    validation:
      max_length: 500

  # Audit
  - name: created_at
    type: timestamp
    required: true
    description: Creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

  - name: cancelled_at
    type: timestamp
    required: false
    description: Cancellation timestamp

  - name: cancellation_reason
    type: string
    required: false
    description: Reason for cancellation
    validation:
      max_length: 200

relationships:
  - name: purchase_order
    type: belongs_to
    entity: PurchaseOrder
    required: true
    description: Parent purchase order

  - name: material
    type: belongs_to
    entity: Material
    required: true
    description: Material being ordered

  - name: receipts
    type: has_many
    entity: GoodsReceiptLine
    description: Receipt lines

  - name: delivery_schedules
    type: has_many
    entity: DeliverySchedule
    description: Delivery schedule lines

  - name: plant
    type: belongs_to
    entity: Plant
    required: true
    description: Receiving plant

  - name: warehouse
    type: belongs_to
    entity: Warehouse
    required: false
    description: Receiving warehouse

indexes:
  - [purchase_order_id, line_number]
  - [material_id]
  - [status]
  - [requested_date]
  - [plant_id]

business_rules:
  - BR-POL-001: Line number auto-incremented within PO
  - BR-POL-002: Cannot edit received/closed lines
  - BR-POL-003: Unit price must match contract price if from contract
  - BR-POL-004: Received qty cannot exceed quantity + over_delivery_tolerance
  - BR-POL-005: Material must be approved for procurement
  - BR-POL-006: Requested date >= PO order date
  - BR-POL-007: Account assignment fields required based on category
  - BR-POL-008: Batch number required if material is batch-managed
  - BR-POL-009: Close line when received_qty within tolerance
  - BR-POL-010: Inspection set from material master if not specified

computed_fields:
  - name: remaining_qty
    formula: quantity - received_qty
    description: Quantity yet to be received

  - name: net_price
    formula: |
      IF discount_type = 'percentage' THEN
        unit_price * (1 - discount_value/100)
      ELSE IF discount_type = 'amount' THEN
        unit_price - (discount_value / quantity * price_unit)
      ELSE
        unit_price
    description: Price after line discount

  - name: tax_amount
    formula: (quantity * net_price / price_unit) * (tax_rate / 100)
    description: Calculated tax amount

  - name: total_amount
    formula: (quantity * net_price / price_unit) + tax_amount
    description: Line total with tax

  - name: receipt_percentage
    formula: (received_qty / quantity) * 100
    description: Percentage received

events:
  - name: po_line.received
    payload: [id, purchase_order_id, material_id, received_qty]
    description: Line received (partial or full)

  - name: po_line.completed
    payload: [id, purchase_order_id, total_amount]
    description: Line fully received

  - name: po_line.cancelled
    payload: [id, purchase_order_id, reason]
    description: Line cancelled
