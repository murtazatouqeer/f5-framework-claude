name: SupplierQuote
display_name: Supplier Quote / Báo giá nhà cung cấp
description: |
  Quotation received from supplier in response to RFQ.
  Contains pricing, terms, delivery schedules, and validity period.
  Supports comparison and selection for procurement decisions.

domain: manufacturing
subdomain: inventory
category: transaction

attributes:
  # Identification
  - name: id
    type: uuid
    required: true
    description: Unique identifier

  - name: quote_number
    type: string
    required: true
    description: Quote reference number
    validation:
      pattern: "^QUO-[0-9]{4}-[0-9]{6}$"
    example: "QUO-2024-000456"

  - name: supplier_quote_number
    type: string
    required: false
    description: Supplier's quote reference
    validation:
      max_length: 50

  - name: status
    type: enum
    required: true
    description: Quote status
    validation:
      values: [draft, submitted, under_review, accepted, rejected, expired, converted]
    default: draft

  # Supplier
  - name: supplier_id
    type: uuid
    required: true
    description: Supplier providing quote

  - name: supplier_contact_id
    type: uuid
    required: false
    description: Supplier contact person

  # RFQ reference
  - name: rfq_id
    type: uuid
    required: false
    description: Request for quotation reference

  - name: rfq_number
    type: string
    required: false
    description: RFQ number
    validation:
      max_length: 30

  # Dates
  - name: quote_date
    type: date
    required: true
    description: Date quote was received

  - name: valid_from
    type: date
    required: true
    description: Quote validity start date

  - name: valid_to
    type: date
    required: true
    description: Quote validity end date

  - name: response_due_date
    type: date
    required: false
    description: Date response expected

  # Pricing
  - name: currency
    type: string
    required: true
    description: Quote currency
    validation:
      pattern: "^[A-Z]{3}$"
    default: "VND"

  - name: subtotal
    type: decimal
    required: true
    description: Sum of line totals
    validation:
      min: 0
      precision: 2

  - name: discount_type
    type: enum
    required: false
    description: Header discount type
    validation:
      values: [percentage, amount]

  - name: discount_value
    type: decimal
    required: false
    description: Discount value
    validation:
      min: 0

  - name: tax_amount
    type: decimal
    required: true
    description: Total tax
    validation:
      min: 0
      precision: 2
    default: 0

  - name: total_amount
    type: decimal
    required: true
    description: Grand total
    validation:
      min: 0
      precision: 2
    computed: true

  # Terms
  - name: payment_terms
    type: string
    required: true
    description: Payment terms
    validation:
      max_length: 20

  - name: delivery_terms
    type: string
    required: false
    description: Delivery/shipping terms
    validation:
      max_length: 100

  - name: incoterms
    type: string
    required: false
    description: Incoterms
    validation:
      max_length: 10

  - name: incoterms_location
    type: string
    required: false
    description: Incoterms named place
    validation:
      max_length: 100

  - name: lead_time_days
    type: integer
    required: false
    description: Quoted lead time
    validation:
      min: 0

  - name: minimum_order_value
    type: decimal
    required: false
    description: Minimum order value
    validation:
      min: 0
      precision: 2

  - name: minimum_order_qty
    type: decimal
    required: false
    description: Minimum order quantity
    validation:
      min: 0

  # Comparison metrics
  - name: comparison_score
    type: decimal
    required: false
    description: Overall comparison score
    validation:
      min: 0
      max: 100

  - name: price_score
    type: decimal
    required: false
    description: Price competitiveness score
    validation:
      min: 0
      max: 100

  - name: delivery_score
    type: decimal
    required: false
    description: Delivery time score
    validation:
      min: 0
      max: 100

  - name: quality_score
    type: decimal
    required: false
    description: Quality/specification score
    validation:
      min: 0
      max: 100

  - name: terms_score
    type: decimal
    required: false
    description: Terms favorability score
    validation:
      min: 0
      max: 100

  - name: rank
    type: integer
    required: false
    description: Rank among competing quotes
    validation:
      min: 1

  # Selection
  - name: selected
    type: boolean
    required: false
    description: Quote selected for PO
    default: false

  - name: selection_reason
    type: string
    required: false
    description: Reason for selection/rejection
    validation:
      max_length: 500

  - name: selected_by
    type: uuid
    required: false
    description: User who made selection

  - name: selected_at
    type: timestamp
    required: false
    description: Selection timestamp

  # Conversion to PO
  - name: converted_to_po
    type: boolean
    required: false
    description: Converted to purchase order
    default: false

  - name: purchase_order_id
    type: uuid
    required: false
    description: Resulting purchase order

  - name: converted_at
    type: timestamp
    required: false
    description: Conversion timestamp

  # Attachments
  - name: attachments
    type: array
    required: false
    description: Quote documents
    items:
      type: object
      properties:
        name: string
        type: string
        url: string
        size_kb: integer

  # Notes
  - name: supplier_notes
    type: string
    required: false
    description: Notes from supplier
    validation:
      max_length: 2000

  - name: internal_notes
    type: string
    required: false
    description: Internal evaluation notes
    validation:
      max_length: 2000

  - name: terms_conditions
    type: string
    required: false
    description: Supplier T&Cs
    validation:
      max_length: 5000

  # Audit
  - name: received_by
    type: uuid
    required: true
    description: User who received quote

  - name: received_at
    type: timestamp
    required: true
    description: Receipt timestamp

  - name: reviewed_by
    type: uuid
    required: false
    description: User who reviewed

  - name: reviewed_at
    type: timestamp
    required: false
    description: Review timestamp

  - name: created_at
    type: timestamp
    required: true
    description: Creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

relationships:
  - name: supplier
    type: belongs_to
    entity: Supplier
    required: true
    description: Quoting supplier

  - name: rfq
    type: belongs_to
    entity: RequestForQuotation
    required: false
    description: Source RFQ

  - name: lines
    type: has_many
    entity: SupplierQuoteLine
    description: Quote line items

  - name: purchase_order
    type: belongs_to
    entity: PurchaseOrder
    required: false
    description: Converted PO

indexes:
  - [quote_number]
  - [supplier_id]
  - [rfq_id]
  - [status]
  - [valid_to]
  - [comparison_score]
  - [selected]

state_machine:
  initial: draft
  states:
    draft:
      description: Being entered
      transitions:
        - to: submitted
          trigger: submit
          condition: has_lines
    submitted:
      description: Submitted for review
      transitions:
        - to: under_review
          trigger: start_review
    under_review:
      description: Being evaluated
      transitions:
        - to: accepted
          trigger: accept
          action: set_selection_info
        - to: rejected
          trigger: reject
          action: set_rejection_reason
    accepted:
      description: Quote accepted
      transitions:
        - to: converted
          trigger: convert_to_po
          action: create_purchase_order
        - to: expired
          trigger: expire
    rejected:
      description: Quote rejected
      final: true
    expired:
      description: Quote validity expired
      final: true
    converted:
      description: Converted to PO
      final: true

business_rules:
  - BR-QUO-001: Quote number auto-generated as QUO-YYYY-NNNNNN
  - BR-QUO-002: valid_to must be after valid_from
  - BR-QUO-003: Cannot accept expired quotes
  - BR-QUO-004: Selection reason required when accepting/rejecting
  - BR-QUO-005: Only one quote from same supplier per RFQ
  - BR-QUO-006: Comparison scores calculated when all quotes received
  - BR-QUO-007: At least one line item required
  - BR-QUO-008: Auto-expire quotes past valid_to date
  - BR-QUO-009: Converted quote cannot be modified
  - BR-QUO-010: Supplier must be active to submit quotes

events:
  - name: quote.received
    payload: [id, quote_number, supplier_id, total_amount]
    description: Quote received from supplier

  - name: quote.evaluated
    payload: [id, quote_number, comparison_score, rank]
    description: Quote evaluated and scored

  - name: quote.accepted
    payload: [id, quote_number, supplier_id, selected_by]
    description: Quote accepted

  - name: quote.rejected
    payload: [id, quote_number, supplier_id, reason]
    description: Quote rejected

  - name: quote.converted
    payload: [id, quote_number, purchase_order_id]
    description: Quote converted to PO

  - name: quote.expired
    payload: [id, quote_number, valid_to]
    description: Quote expired
