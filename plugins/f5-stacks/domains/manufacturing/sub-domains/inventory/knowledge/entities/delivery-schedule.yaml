name: DeliverySchedule
display_name: Delivery Schedule / Lịch giao hàng
description: |
  Scheduled delivery against purchase order or blanket agreement.
  Defines planned delivery dates, quantities, and tracking
  for JIT and scheduled deliveries.

domain: manufacturing
subdomain: inventory
category: transaction

attributes:
  # Identification
  - name: id
    type: uuid
    required: true
    description: Unique identifier

  - name: schedule_number
    type: string
    required: true
    description: Schedule line number
    validation:
      pattern: "^DS-[0-9]{4}-[0-9]{8}$"
    example: "DS-2024-00000123"

  - name: status
    type: enum
    required: true
    description: Schedule status
    validation:
      values: [planned, confirmed, in_transit, partially_received,
               received, cancelled]
    default: planned

  # Reference
  - name: purchase_order_id
    type: uuid
    required: false
    description: Purchase order reference

  - name: po_line_id
    type: uuid
    required: false
    description: PO line reference

  - name: contract_id
    type: uuid
    required: false
    description: Framework contract reference

  - name: contract_line_id
    type: uuid
    required: false
    description: Contract line reference

  - name: schedule_agreement_id
    type: uuid
    required: false
    description: Scheduling agreement reference

  # Supplier
  - name: supplier_id
    type: uuid
    required: true
    description: Supplier

  - name: supplier_schedule_ref
    type: string
    required: false
    description: Supplier's schedule reference
    validation:
      max_length: 30

  # Material
  - name: material_id
    type: uuid
    required: true
    description: Material

  - name: plant_id
    type: uuid
    required: true
    description: Receiving plant

  - name: warehouse_id
    type: uuid
    required: false
    description: Receiving warehouse

  - name: location_id
    type: uuid
    required: false
    description: Receiving location

  # Quantities
  - name: scheduled_qty
    type: decimal
    required: true
    description: Scheduled delivery quantity
    validation:
      min: 0.001
      precision: 3

  - name: confirmed_qty
    type: decimal
    required: false
    description: Supplier confirmed quantity
    validation:
      min: 0
      precision: 3

  - name: shipped_qty
    type: decimal
    required: false
    description: Quantity shipped
    validation:
      min: 0
      precision: 3
    default: 0

  - name: received_qty
    type: decimal
    required: false
    description: Quantity received
    validation:
      min: 0
      precision: 3
    default: 0

  - name: open_qty
    type: decimal
    required: false
    description: Remaining quantity
    computed: true
    formula: "scheduled_qty - received_qty"

  - name: unit_of_measure
    type: string
    required: true
    description: Unit of measure
    validation:
      max_length: 10

  # Dates
  - name: scheduled_date
    type: date
    required: true
    description: Scheduled delivery date

  - name: scheduled_time
    type: time
    required: false
    description: Scheduled delivery time

  - name: confirmed_date
    type: date
    required: false
    description: Supplier confirmed date

  - name: ship_date
    type: date
    required: false
    description: Actual ship date

  - name: arrival_date
    type: date
    required: false
    description: Actual arrival date

  - name: receipt_date
    type: date
    required: false
    description: Goods receipt date

  # Lead time tracking
  - name: original_lead_time
    type: integer
    required: false
    description: Original lead time (days)

  - name: actual_lead_time
    type: integer
    required: false
    description: Actual lead time (days)
    computed: true

  - name: variance_days
    type: integer
    required: false
    description: Days early/late
    computed: true
    formula: "DATEDIFF(receipt_date, scheduled_date)"

  - name: on_time
    type: boolean
    required: false
    description: Delivered on time
    computed: true

  # Shipping
  - name: shipping_method
    type: string
    required: false
    description: Shipping method
    validation:
      max_length: 50

  - name: carrier_id
    type: uuid
    required: false
    description: Shipping carrier

  - name: tracking_number
    type: string
    required: false
    description: Shipment tracking
    validation:
      max_length: 50

  - name: asn_number
    type: string
    required: false
    description: Advanced shipping notice
    validation:
      max_length: 30

  - name: container_number
    type: string
    required: false
    description: Container number
    validation:
      max_length: 20

  - name: bill_of_lading
    type: string
    required: false
    description: Bill of lading
    validation:
      max_length: 30

  # Dock scheduling
  - name: dock_id
    type: string
    required: false
    description: Assigned receiving dock
    validation:
      max_length: 20

  - name: dock_appointment_time
    type: timestamp
    required: false
    description: Dock appointment time

  - name: unload_start_time
    type: timestamp
    required: false
    description: Unloading start time

  - name: unload_end_time
    type: timestamp
    required: false
    description: Unloading end time

  # JIT/Kanban
  - name: jit_delivery
    type: boolean
    required: false
    description: Just-in-time delivery
    default: false

  - name: kanban_id
    type: uuid
    required: false
    description: Related kanban card

  - name: sequence_number
    type: integer
    required: false
    description: Delivery sequence number

  - name: window_start
    type: timestamp
    required: false
    description: Delivery window start

  - name: window_end
    type: timestamp
    required: false
    description: Delivery window end

  # Cumulative tracking
  - name: cumulative_scheduled_qty
    type: decimal
    required: false
    description: Cumulative scheduled quantity
    validation:
      precision: 3

  - name: cumulative_received_qty
    type: decimal
    required: false
    description: Cumulative received quantity
    validation:
      precision: 3

  # Priority
  - name: priority
    type: enum
    required: false
    description: Delivery priority
    validation:
      values: [low, normal, high, urgent]
    default: normal

  - name: expedite
    type: boolean
    required: false
    description: Expedite delivery
    default: false

  # Exception handling
  - name: exception_flag
    type: boolean
    required: false
    description: Has delivery exception
    default: false

  - name: exception_type
    type: enum
    required: false
    description: Type of exception
    validation:
      values: [late, early, qty_variance, cancelled, quality, damaged]

  - name: exception_notes
    type: string
    required: false
    description: Exception description
    validation:
      max_length: 500

  # Notes
  - name: delivery_instructions
    type: string
    required: false
    description: Delivery instructions
    validation:
      max_length: 500

  - name: notes
    type: string
    required: false
    description: Additional notes
    validation:
      max_length: 500

  # Goods receipt reference
  - name: goods_receipt_id
    type: uuid
    required: false
    description: Goods receipt reference

  # Audit
  - name: created_by
    type: uuid
    required: true
    description: User who created

  - name: created_at
    type: timestamp
    required: true
    description: Creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

  - name: confirmed_by
    type: uuid
    required: false
    description: User who confirmed

  - name: confirmed_at
    type: timestamp
    required: false
    description: Confirmation timestamp

relationships:
  - name: purchase_order
    type: belongs_to
    entity: PurchaseOrder
    required: false
    description: Purchase order

  - name: po_line
    type: belongs_to
    entity: PurchaseOrderLine
    required: false
    description: PO line

  - name: supplier
    type: belongs_to
    entity: Supplier
    required: true
    description: Supplier

  - name: material
    type: belongs_to
    entity: Material
    required: true
    description: Material

  - name: carrier
    type: belongs_to
    entity: Carrier
    required: false
    description: Shipping carrier

  - name: goods_receipt
    type: belongs_to
    entity: GoodsReceipt
    required: false
    description: Goods receipt

  - name: contract
    type: belongs_to
    entity: FrameworkContract
    required: false
    description: Framework contract

indexes:
  - [schedule_number]
  - [status]
  - [supplier_id, material_id]
  - [purchase_order_id]
  - [scheduled_date]
  - [material_id, plant_id]
  - [tracking_number]
  - [jit_delivery]
  - [exception_flag]

business_rules:
  - BR-DS-001: Schedule number auto-generated
  - BR-DS-002: Scheduled date >= today for new schedules
  - BR-DS-003: Confirmed qty cannot exceed scheduled qty
  - BR-DS-004: Cannot receive more than scheduled + tolerance
  - BR-DS-005: JIT delivery requires window_start and window_end
  - BR-DS-006: Dock appointment required for JIT
  - BR-DS-007: Exception flag set if variance > threshold
  - BR-DS-008: Cumulative tracking for blanket orders
  - BR-DS-009: ASN required for certain suppliers
  - BR-DS-010: On-time calculated based on window for JIT

computed_fields:
  - name: open_qty
    formula: scheduled_qty - received_qty
    description: Remaining quantity to receive

  - name: actual_lead_time
    formula: DATEDIFF(receipt_date, ship_date)
    description: Actual shipping lead time

  - name: variance_days
    formula: DATEDIFF(receipt_date, scheduled_date)
    description: Days late (positive) or early (negative)

  - name: on_time
    formula: |
      IF jit_delivery THEN
        receipt_date BETWEEN window_start AND window_end
      ELSE
        variance_days <= 0 OR variance_days <= tolerance_days
    description: Whether delivery was on time

events:
  - name: ds.created
    payload: [id, schedule_number, material_id, scheduled_date, scheduled_qty]
    description: Delivery schedule created

  - name: ds.confirmed
    payload: [id, schedule_number, confirmed_date, confirmed_qty]
    description: Supplier confirmed delivery

  - name: ds.shipped
    payload: [id, schedule_number, tracking_number, ship_date]
    description: Shipment dispatched

  - name: ds.received
    payload: [id, schedule_number, received_qty, receipt_date]
    description: Delivery received

  - name: ds.late
    payload: [id, schedule_number, scheduled_date, variance_days]
    description: Delivery is late

  - name: ds.exception
    payload: [id, schedule_number, exception_type, exception_notes]
    description: Delivery exception occurred
