name: PurchaseOrder
display_name: Purchase Order / Đơn đặt hàng mua
description: |
  Document authorizing procurement of materials from suppliers.
  Supports multi-line orders, delivery schedules, pricing agreements,
  and full procurement lifecycle tracking.

domain: manufacturing
subdomain: inventory
category: transaction

attributes:
  # Identification
  - name: id
    type: uuid
    required: true
    description: Unique identifier

  - name: po_number
    type: string
    required: true
    description: Purchase order number
    validation:
      pattern: "^PO-[0-9]{4}-[0-9]{6}$"
    example: "PO-2024-000123"

  - name: po_type
    type: enum
    required: true
    description: Type of purchase order
    validation:
      values:
        - standard           # Regular purchase
        - blanket           # Framework agreement
        - consignment       # Consignment stock
        - subcontracting    # Subcontracting
        - service           # Service procurement
        - stock_transfer    # Inter-company transfer
    default: standard

  - name: status
    type: enum
    required: true
    description: Order status
    validation:
      values: [draft, pending_approval, approved, sent, acknowledged,
               partially_received, received, invoiced, closed, cancelled]
    default: draft

  # Supplier
  - name: supplier_id
    type: uuid
    required: true
    description: Supplier reference

  - name: supplier_contact_id
    type: uuid
    required: false
    description: Supplier contact person

  # Dates
  - name: order_date
    type: date
    required: true
    description: Date order was created

  - name: requested_date
    type: date
    required: true
    description: Requested delivery date

  - name: promised_date
    type: date
    required: false
    description: Supplier promised delivery date

  - name: expected_date
    type: date
    required: false
    description: Expected delivery date (calculated)

  - name: valid_from
    type: date
    required: false
    description: Validity start (for blanket orders)

  - name: valid_to
    type: date
    required: false
    description: Validity end (for blanket orders)

  # Location
  - name: plant_id
    type: uuid
    required: true
    description: Receiving plant

  - name: warehouse_id
    type: uuid
    required: false
    description: Default receiving warehouse

  - name: delivery_address
    type: object
    required: true
    description: Delivery address
    example:
      street: "123 Industrial Zone"
      city: "Ho Chi Minh City"
      postal_code: "700000"
      country: "VN"

  # Pricing
  - name: currency
    type: string
    required: true
    description: Order currency
    validation:
      pattern: "^[A-Z]{3}$"
    default: "VND"

  - name: exchange_rate
    type: decimal
    required: false
    description: Exchange rate to local currency
    validation:
      min: 0
      precision: 6

  - name: subtotal
    type: decimal
    required: true
    description: Sum of line item totals
    validation:
      min: 0
      precision: 2

  - name: discount_type
    type: enum
    required: false
    description: Header discount type
    validation:
      values: [percentage, amount]

  - name: discount_value
    type: decimal
    required: false
    description: Discount value
    validation:
      min: 0

  - name: tax_amount
    type: decimal
    required: true
    description: Total tax amount
    validation:
      min: 0
      precision: 2
    default: 0

  - name: shipping_cost
    type: decimal
    required: false
    description: Shipping/freight cost
    validation:
      min: 0
      precision: 2
    default: 0

  - name: total_amount
    type: decimal
    required: true
    description: Grand total
    validation:
      min: 0
      precision: 2
    computed: true
    formula: "subtotal - discount + tax_amount + shipping_cost"

  # Payment
  - name: payment_terms
    type: string
    required: true
    description: Payment terms code
    validation:
      max_length: 20
    example: "NET30"

  - name: payment_method
    type: enum
    required: false
    description: Payment method
    validation:
      values: [bank_transfer, check, cash, letter_of_credit, credit_card]
    default: bank_transfer

  - name: incoterms
    type: string
    required: false
    description: Incoterms code
    validation:
      max_length: 10
    example: "FOB"

  - name: incoterms_location
    type: string
    required: false
    description: Incoterms location
    validation:
      max_length: 100

  # Reference documents
  - name: requisition_id
    type: uuid
    required: false
    description: Purchase requisition reference

  - name: contract_id
    type: uuid
    required: false
    description: Framework contract reference

  - name: quote_id
    type: uuid
    required: false
    description: Supplier quote reference

  - name: external_reference
    type: string
    required: false
    description: External reference number
    validation:
      max_length: 50

  # Shipping
  - name: shipping_method
    type: string
    required: false
    description: Preferred shipping method
    validation:
      max_length: 50

  - name: shipping_instructions
    type: string
    required: false
    description: Special shipping instructions
    validation:
      max_length: 500

  # Approval
  - name: approval_required
    type: boolean
    required: true
    description: Requires approval
    default: true

  - name: approval_status
    type: enum
    required: false
    description: Approval workflow status
    validation:
      values: [pending, approved, rejected, escalated]

  - name: approved_by
    type: uuid
    required: false
    description: Approver

  - name: approved_at
    type: timestamp
    required: false
    description: Approval timestamp

  - name: rejection_reason
    type: string
    required: false
    description: Rejection reason
    validation:
      max_length: 500

  # Supplier acknowledgement
  - name: acknowledged
    type: boolean
    required: false
    description: Supplier acknowledged receipt
    default: false

  - name: acknowledged_at
    type: timestamp
    required: false
    description: Acknowledgement timestamp

  - name: acknowledged_by
    type: string
    required: false
    description: Supplier contact name

  # Progress tracking
  - name: total_lines
    type: integer
    required: false
    description: Number of line items
    computed: true

  - name: received_lines
    type: integer
    required: false
    description: Lines fully received
    computed: true

  - name: invoiced_lines
    type: integer
    required: false
    description: Lines invoiced
    computed: true

  - name: received_amount
    type: decimal
    required: false
    description: Total received value
    computed: true

  - name: invoiced_amount
    type: decimal
    required: false
    description: Total invoiced value
    computed: true

  # Notes
  - name: internal_notes
    type: string
    required: false
    description: Internal notes (not sent to supplier)
    validation:
      max_length: 1000

  - name: supplier_notes
    type: string
    required: false
    description: Notes for supplier
    validation:
      max_length: 1000

  - name: terms_conditions
    type: string
    required: false
    description: Terms and conditions text
    validation:
      max_length: 5000

  # Audit
  - name: created_by
    type: uuid
    required: true
    description: User who created

  - name: created_at
    type: timestamp
    required: true
    description: Creation timestamp

  - name: updated_by
    type: uuid
    required: false
    description: Last updated by

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

  - name: sent_at
    type: timestamp
    required: false
    description: Date sent to supplier

  - name: sent_by
    type: uuid
    required: false
    description: User who sent

  - name: closed_at
    type: timestamp
    required: false
    description: Date order was closed

  - name: closed_by
    type: uuid
    required: false
    description: User who closed

  - name: cancellation_reason
    type: string
    required: false
    description: Reason for cancellation
    validation:
      max_length: 500

relationships:
  - name: supplier
    type: belongs_to
    entity: Supplier
    required: true
    description: Supplier for this order

  - name: lines
    type: has_many
    entity: PurchaseOrderLine
    description: Order line items

  - name: goods_receipts
    type: has_many
    entity: GoodsReceipt
    description: Related goods receipts

  - name: requisition
    type: belongs_to
    entity: PurchaseRequisition
    required: false
    description: Source requisition

  - name: contract
    type: belongs_to
    entity: FrameworkContract
    required: false
    description: Framework contract

  - name: quote
    type: belongs_to
    entity: SupplierQuote
    required: false
    description: Source quotation

indexes:
  - [po_number]
  - [supplier_id]
  - [status]
  - [order_date]
  - [requested_date]
  - [plant_id]
  - [created_by]
  - [approval_status]

state_machine:
  initial: draft
  states:
    draft:
      description: Being prepared
      transitions:
        - to: pending_approval
          trigger: submit_for_approval
          condition: has_lines AND total_amount > 0
        - to: approved
          trigger: auto_approve
          condition: total_amount <= auto_approval_limit
        - to: cancelled
          trigger: cancel
    pending_approval:
      description: Awaiting approval
      transitions:
        - to: approved
          trigger: approve
        - to: draft
          trigger: reject
          action: set_rejection_reason
    approved:
      description: Approved for sending
      transitions:
        - to: sent
          trigger: send_to_supplier
          action: record_sent_timestamp
        - to: cancelled
          trigger: cancel
    sent:
      description: Sent to supplier
      transitions:
        - to: acknowledged
          trigger: acknowledge
          action: record_acknowledgement
        - to: partially_received
          trigger: receive_partial
        - to: received
          trigger: receive_complete
        - to: cancelled
          trigger: cancel
    acknowledged:
      description: Supplier confirmed receipt
      transitions:
        - to: partially_received
          trigger: receive_partial
        - to: received
          trigger: receive_complete
        - to: cancelled
          trigger: cancel
    partially_received:
      description: Partial delivery received
      transitions:
        - to: received
          trigger: receive_remaining
        - to: closed
          trigger: close
    received:
      description: All items received
      transitions:
        - to: invoiced
          trigger: invoice
        - to: closed
          trigger: close
    invoiced:
      description: Fully invoiced
      transitions:
        - to: closed
          trigger: close
    closed:
      description: Order completed
      final: true
    cancelled:
      description: Order cancelled
      final: true

business_rules:
  - BR-PO-001: PO number auto-generated in format PO-YYYY-NNNNNN
  - BR-PO-002: Cannot modify sent/acknowledged PO without change order
  - BR-PO-003: Approval required if total exceeds threshold
  - BR-PO-004: At least one line item required
  - BR-PO-005: Supplier must be active and approved
  - BR-PO-006: Requested date >= order date
  - BR-PO-007: Cannot receive against cancelled PO
  - BR-PO-008: Blanket PO requires valid_from and valid_to
  - BR-PO-009: Close only when all receipts and invoices processed
  - BR-PO-010: Cancellation reason required when cancelling sent PO

events:
  - name: po.created
    payload: [id, po_number, supplier_id, total_amount]
    description: Purchase order created

  - name: po.submitted
    payload: [id, po_number, total_amount]
    description: Submitted for approval

  - name: po.approved
    payload: [id, po_number, approved_by]
    description: Order approved

  - name: po.sent
    payload: [id, po_number, supplier_id]
    description: Sent to supplier

  - name: po.acknowledged
    payload: [id, po_number, acknowledged_at]
    description: Supplier acknowledged

  - name: po.received
    payload: [id, po_number, status]
    description: Goods received

  - name: po.closed
    payload: [id, po_number, total_amount, received_amount]
    description: Order closed

  - name: po.cancelled
    payload: [id, po_number, reason]
    description: Order cancelled
