name: Inventory
display_name: Inventory / Tá»“n kho
description: |
  Real-time inventory records tracking material quantities by location.
  Supports batch and serial number tracking, multiple stock categories,
  and valuation at location level.

domain: manufacturing
subdomain: inventory
category: transaction

attributes:
  # Identification
  - name: id
    type: uuid
    required: true
    description: Unique identifier

  - name: material_id
    type: uuid
    required: true
    description: Reference to material

  - name: plant_id
    type: uuid
    required: true
    description: Plant/facility code

  - name: warehouse_id
    type: uuid
    required: true
    description: Warehouse within plant

  - name: location_id
    type: uuid
    required: true
    description: Storage location/bin

  # Quantities
  - name: on_hand_qty
    type: decimal
    required: true
    description: Total physical quantity on hand
    validation:
      min: 0
      precision: 3
    default: 0

  - name: available_qty
    type: decimal
    required: true
    description: Quantity available for allocation
    validation:
      precision: 3
    computed: true
    formula: "on_hand_qty - allocated_qty - blocked_qty"

  - name: allocated_qty
    type: decimal
    required: true
    description: Quantity allocated to orders
    validation:
      min: 0
      precision: 3
    default: 0

  - name: reserved_qty
    type: decimal
    required: true
    description: Quantity reserved (soft allocation)
    validation:
      min: 0
      precision: 3
    default: 0

  - name: in_transit_qty
    type: decimal
    required: true
    description: Quantity in transit (transfers)
    validation:
      min: 0
      precision: 3
    default: 0

  - name: in_quality_qty
    type: decimal
    required: true
    description: Quantity in quality inspection
    validation:
      min: 0
      precision: 3
    default: 0

  - name: blocked_qty
    type: decimal
    required: true
    description: Quantity blocked from use
    validation:
      min: 0
      precision: 3
    default: 0

  - name: quarantine_qty
    type: decimal
    required: true
    description: Quantity in quarantine
    validation:
      min: 0
      precision: 3
    default: 0

  # Batch tracking (if batch managed)
  - name: batch_number
    type: string
    required: false
    description: Batch/lot number
    validation:
      max_length: 20
    condition: "material.batch_managed = true"

  - name: batch_status
    type: enum
    required: false
    description: Batch status
    validation:
      values: [unrestricted, quality_inspection, blocked, quarantine]
    default: unrestricted

  - name: production_date
    type: date
    required: false
    description: Batch production date

  - name: expiry_date
    type: date
    required: false
    description: Batch expiry date

  - name: vendor_batch
    type: string
    required: false
    description: Supplier's batch number
    validation:
      max_length: 30

  - name: shelf_life_expiry_date
    type: date
    required: false
    description: Shelf life expiry date

  - name: days_to_expiry
    type: integer
    required: false
    description: Days until expiry
    computed: true
    formula: "expiry_date - current_date"

  # Serial tracking (if serial managed)
  - name: serial_number
    type: string
    required: false
    description: Serial number (one record per serial)
    validation:
      max_length: 40
    condition: "material.serial_managed = true"

  - name: serial_status
    type: enum
    required: false
    description: Serial number status
    validation:
      values: [available, allocated, in_use, returned, scrapped]
    default: available

  # Valuation
  - name: total_value
    type: decimal
    required: true
    description: Total inventory value at location
    validation:
      min: 0
      precision: 2
    default: 0

  - name: unit_cost
    type: decimal
    required: true
    description: Unit cost at this location
    validation:
      min: 0
      precision: 4

  - name: currency
    type: string
    required: true
    description: Valuation currency
    validation:
      pattern: "^[A-Z]{3}$"
    default: "VND"

  # Activity tracking
  - name: last_receipt_date
    type: timestamp
    required: false
    description: Last goods receipt date

  - name: last_receipt_qty
    type: decimal
    required: false
    description: Last receipt quantity

  - name: last_issue_date
    type: timestamp
    required: false
    description: Last goods issue date

  - name: last_issue_qty
    type: decimal
    required: false
    description: Last issue quantity

  - name: last_count_date
    type: timestamp
    required: false
    description: Last physical count date

  - name: last_count_qty
    type: decimal
    required: false
    description: Quantity at last count

  - name: last_movement_date
    type: timestamp
    required: false
    description: Last any movement date

  # Consumption metrics
  - name: daily_usage_avg
    type: decimal
    required: false
    description: Average daily usage (30-day)
    validation:
      min: 0

  - name: monthly_usage_avg
    type: decimal
    required: false
    description: Average monthly usage (12-month)
    validation:
      min: 0

  - name: days_on_hand
    type: decimal
    required: false
    description: Days of supply based on usage
    computed: true
    formula: "on_hand_qty / daily_usage_avg"

  # Reorder status
  - name: below_safety_stock
    type: boolean
    required: false
    description: Is below safety stock level
    computed: true

  - name: below_reorder_point
    type: boolean
    required: false
    description: Is below reorder point
    computed: true

  - name: above_max_stock
    type: boolean
    required: false
    description: Is above maximum stock level
    computed: true

  # Audit
  - name: created_at
    type: timestamp
    required: true
    description: Record creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

  - name: version
    type: integer
    required: true
    description: Version for optimistic locking
    default: 1

relationships:
  - name: material
    type: belongs_to
    entity: Material
    required: true
    description: Material master record

  - name: location
    type: belongs_to
    entity: StockLocation
    required: true
    description: Storage location

  - name: transactions
    type: has_many
    entity: InventoryTransaction
    description: Movement history

  - name: allocations
    type: has_many
    entity: InventoryAllocation
    description: Active allocations

indexes:
  - [material_id, location_id]
  - [material_id, plant_id]
  - [material_id, warehouse_id]
  - [batch_number]
  - [serial_number]
  - [expiry_date]
  - [batch_status]
  - [below_reorder_point]

unique_constraints:
  - name: unique_inventory_record
    columns: [material_id, location_id, batch_number, serial_number]
    description: One record per material+location+batch+serial combination

business_rules:
  - BR-INV-001: on_hand_qty >= allocated_qty + blocked_qty
  - BR-INV-002: available_qty = on_hand_qty - allocated_qty - blocked_qty
  - BR-INV-003: Batch number required for batch-managed materials
  - BR-INV-004: Serial number creates individual record per serial
  - BR-INV-005: Expiry date required for shelf-life materials
  - BR-INV-006: Cannot have negative on_hand_qty
  - BR-INV-007: Value recalculated on every movement
  - BR-INV-008: FIFO allocation for non-batch materials
  - BR-INV-009: FEFO allocation for batch-managed materials
  - BR-INV-010: Blocked stock excluded from available

computed_fields:
  - name: available_qty
    formula: on_hand_qty - allocated_qty - blocked_qty - quarantine_qty
    description: Available for allocation

  - name: days_on_hand
    formula: on_hand_qty / NULLIF(daily_usage_avg, 0)
    description: Days of inventory based on usage

  - name: days_to_expiry
    formula: expiry_date - CURRENT_DATE
    description: Days until expiration

events:
  - name: inventory.below_reorder_point
    payload: [material_id, location_id, on_hand_qty, reorder_point]
    description: Stock fell below reorder point

  - name: inventory.below_safety_stock
    payload: [material_id, location_id, on_hand_qty, safety_stock]
    description: Stock fell below safety stock

  - name: inventory.near_expiry
    payload: [material_id, batch_number, expiry_date, days_to_expiry]
    description: Batch approaching expiry

  - name: inventory.expired
    payload: [material_id, batch_number, expiry_date]
    description: Batch has expired

  - name: inventory.zero_stock
    payload: [material_id, location_id]
    description: Stock reached zero
