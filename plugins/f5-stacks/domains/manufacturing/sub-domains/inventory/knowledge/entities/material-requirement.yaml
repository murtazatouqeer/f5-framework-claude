name: MaterialRequirement
display_name: Material Requirement / Nhu cầu vật tư
description: |
  MRP-generated material requirement representing demand or supply.
  Tracks planned orders, dependent demands, and supply proposals
  with time-phased planning information.

domain: manufacturing
subdomain: inventory
category: transaction

attributes:
  # Identification
  - name: id
    type: uuid
    required: true
    description: Unique identifier

  - name: requirement_number
    type: string
    required: true
    description: Requirement reference number
    validation:
      pattern: "^MRQ-[0-9]{4}-[0-9]{8}$"
    example: "MRQ-2024-00000123"

  - name: status
    type: enum
    required: true
    description: Requirement status
    validation:
      values: [planned, firmed, released, in_progress, completed, cancelled]
    default: planned

  - name: requirement_type
    type: enum
    required: true
    description: Type of requirement
    validation:
      values:
        - independent_demand    # Customer orders, forecasts
        - dependent_demand      # BOM explosion
        - safety_stock          # Safety stock requirement
        - reorder_point         # Reorder point trigger
        - planned_order         # MRP planned order
        - transfer_requirement  # Inter-plant transfer
        - manual               # Manually created

  - name: element_type
    type: enum
    required: true
    description: MRP element type
    validation:
      values:
        - sales_order          # Customer order
        - forecast             # Demand forecast
        - production_order     # Production requirement
        - purchase_requisition # Purchase need
        - planned_production   # Planned production
        - planned_purchase     # Planned purchase
        - planned_transfer     # Planned transfer
        - stock_requirement    # Stock level requirement
        - reservation          # Stock reservation

  # Material
  - name: material_id
    type: uuid
    required: true
    description: Material reference

  - name: plant_id
    type: uuid
    required: true
    description: Plant for requirement

  # Quantities
  - name: required_qty
    type: decimal
    required: true
    description: Required quantity
    validation:
      precision: 3

  - name: unit_of_measure
    type: string
    required: true
    description: Unit of measure
    validation:
      max_length: 10

  - name: open_qty
    type: decimal
    required: true
    description: Open/remaining quantity
    validation:
      precision: 3

  - name: received_qty
    type: decimal
    required: false
    description: Quantity received/produced
    validation:
      min: 0
      precision: 3
    default: 0

  # Dates
  - name: requirement_date
    type: date
    required: true
    description: Date requirement is needed

  - name: due_date
    type: date
    required: true
    description: Due date for supply

  - name: start_date
    type: date
    required: false
    description: Start date (for production)

  - name: finish_date
    type: date
    required: false
    description: Finish date (for production)

  - name: order_date
    type: date
    required: false
    description: Date to place order

  - name: availability_date
    type: date
    required: false
    description: Expected availability date

  # Source reference
  - name: source_type
    type: enum
    required: true
    description: Source of requirement
    validation:
      values: [sales_order, production_order, forecast, bom_explosion, manual, reorder, safety_stock]

  - name: source_id
    type: uuid
    required: false
    description: Source document ID

  - name: source_number
    type: string
    required: false
    description: Source document number
    validation:
      max_length: 30

  - name: source_line
    type: integer
    required: false
    description: Source document line

  # Parent requirement (for dependent demand)
  - name: parent_requirement_id
    type: uuid
    required: false
    description: Parent requirement (BOM explosion)

  - name: parent_material_id
    type: uuid
    required: false
    description: Parent material

  - name: bom_level
    type: integer
    required: false
    description: BOM level (0 = top)
    validation:
      min: 0

  # Supply proposal
  - name: supply_type
    type: enum
    required: false
    description: Proposed supply type
    validation:
      values: [purchase, production, transfer, stock]

  - name: supply_source
    type: string
    required: false
    description: Proposed supply source
    validation:
      max_length: 100

  - name: supplier_id
    type: uuid
    required: false
    description: Suggested supplier

  - name: lead_time_days
    type: integer
    required: false
    description: Lead time used in calculation
    validation:
      min: 0

  # Lot sizing
  - name: lot_size_type
    type: enum
    required: false
    description: Lot sizing method used
    validation:
      values: [fixed, eoq, lot_for_lot, period_lot, min_max]

  - name: order_qty
    type: decimal
    required: false
    description: Calculated order quantity
    validation:
      min: 0
      precision: 3

  - name: scrap_percentage
    type: decimal
    required: false
    description: Scrap percentage applied
    validation:
      min: 0
      max: 100

  # Coverage
  - name: covers_requirements
    type: array
    required: false
    description: Requirements covered by this supply
    items:
      type: uuid

  - name: covered_by
    type: uuid
    required: false
    description: Supply that covers this requirement

  - name: coverage_type
    type: enum
    required: false
    description: Coverage status
    validation:
      values: [full, partial, none]

  # Exception handling
  - name: exception_code
    type: string
    required: false
    description: MRP exception code
    validation:
      max_length: 10

  - name: exception_message
    type: string
    required: false
    description: Exception description
    validation:
      max_length: 200

  - name: requires_action
    type: boolean
    required: false
    description: Requires planner action
    default: false

  - name: action_message
    type: string
    required: false
    description: Recommended action
    validation:
      max_length: 200

  # Conversion to order
  - name: converted
    type: boolean
    required: false
    description: Converted to order
    default: false

  - name: converted_to_type
    type: enum
    required: false
    description: Type of order created
    validation:
      values: [purchase_order, production_order, transfer_order, requisition]

  - name: converted_to_id
    type: uuid
    required: false
    description: Created order ID

  - name: converted_at
    type: timestamp
    required: false
    description: Conversion timestamp

  - name: converted_by
    type: uuid
    required: false
    description: User who converted

  # MRP run info
  - name: mrp_run_id
    type: uuid
    required: false
    description: MRP run that created this

  - name: mrp_run_date
    type: timestamp
    required: false
    description: MRP run timestamp

  - name: planning_horizon
    type: date
    required: false
    description: Planning horizon date

  # Priority
  - name: priority
    type: enum
    required: false
    description: Requirement priority
    validation:
      values: [low, normal, high, critical]
    default: normal

  # Audit
  - name: created_at
    type: timestamp
    required: true
    description: Creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

  - name: firmed_at
    type: timestamp
    required: false
    description: Date firmed

  - name: firmed_by
    type: uuid
    required: false
    description: User who firmed

relationships:
  - name: material
    type: belongs_to
    entity: Material
    required: true
    description: Material for requirement

  - name: plant
    type: belongs_to
    entity: Plant
    required: true
    description: Requirement plant

  - name: parent_requirement
    type: belongs_to
    entity: MaterialRequirement
    required: false
    description: Parent requirement

  - name: child_requirements
    type: has_many
    entity: MaterialRequirement
    description: Dependent requirements

  - name: supplier
    type: belongs_to
    entity: Supplier
    required: false
    description: Suggested supplier

  - name: mrp_run
    type: belongs_to
    entity: MRPRun
    required: false
    description: Source MRP run

indexes:
  - [requirement_number]
  - [material_id, plant_id]
  - [status]
  - [requirement_type]
  - [requirement_date]
  - [due_date]
  - [source_type, source_id]
  - [parent_requirement_id]
  - [mrp_run_id]
  - [requires_action]

business_rules:
  - BR-MRQ-001: Requirement number auto-generated
  - BR-MRQ-002: Dependent demand exploded from parent BOM
  - BR-MRQ-003: Lead time from material master or supplier
  - BR-MRQ-004: Lot sizing per material master settings
  - BR-MRQ-005: Cannot edit converted requirements
  - BR-MRQ-006: Firmed requirements not regenerated by MRP
  - BR-MRQ-007: Exception raised if no supply possible
  - BR-MRQ-008: Safety stock maintained above minimum
  - BR-MRQ-009: Order date = due date - lead time
  - BR-MRQ-010: Scrap percentage applied to dependent demand

events:
  - name: mrq.created
    payload: [id, material_id, requirement_type, required_qty, due_date]
    description: Requirement created

  - name: mrq.firmed
    payload: [id, material_id, firmed_by]
    description: Requirement firmed

  - name: mrq.converted
    payload: [id, material_id, converted_to_type, converted_to_id]
    description: Converted to order

  - name: mrq.exception
    payload: [id, material_id, exception_code, action_message]
    description: Exception raised

  - name: mrq.cancelled
    payload: [id, material_id, reason]
    description: Requirement cancelled
