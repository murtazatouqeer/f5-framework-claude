name: capa-workflow
display_name: CAPA Workflow
display_name_vi: Quy trình CAPA
version: "1.0"
domain: manufacturing
subdomain: quality
type: workflow

description: |
  Complete Corrective and Preventive Action (CAPA) workflow from initiation
  through investigation, action implementation, and effectiveness verification
  supporting 8D, 5-Why, Fishbone, and other methodologies.

description_vi: |
  Quy trình Hành động Khắc phục và Phòng ngừa (CAPA) hoàn chỉnh từ khởi tạo
  qua điều tra, thực hiện hành động và xác minh hiệu quả
  hỗ trợ các phương pháp 8D, 5 Tại sao, Xương cá và các phương pháp khác.

workflow_metadata:
  category: quality_management
  complexity: high
  estimated_duration: "30-120 days"
  automation_level: semi-automated
  compliance:
    - ISO 9001:2015
    - IATF 16949
    - FDA 21 CFR Part 820
    - AS9100D
    - ISO 13485

actors:
  - id: capa_initiator
    name: CAPA Initiator
    name_vi: Người khởi tạo CAPA
    responsibilities:
      - Identify need for CAPA
      - Provide initial problem description
      - Submit CAPA request

  - id: capa_owner
    name: CAPA Owner
    name_vi: Chủ sở hữu CAPA
    responsibilities:
      - Lead CAPA investigation
      - Coordinate team activities
      - Ensure timeline compliance
      - Report progress

  - id: quality_engineer
    name: Quality Engineer
    name_vi: Kỹ sư chất lượng
    responsibilities:
      - Support investigation
      - Validate root cause analysis
      - Verify action implementation
      - Assess effectiveness

  - id: quality_manager
    name: Quality Manager
    name_vi: Quản lý chất lượng
    responsibilities:
      - Approve CAPA plans
      - Review effectiveness
      - Authorize closure
      - Monitor CAPA metrics

  - id: action_owners
    name: Action Owners
    name_vi: Chủ sở hữu hành động
    responsibilities:
      - Implement assigned actions
      - Provide evidence of completion
      - Meet deadlines

  - id: cross_functional_team
    name: Cross-Functional Team
    name_vi: Nhóm đa chức năng
    responsibilities:
      - Participate in investigation
      - Provide expertise
      - Support implementation

triggers:
  - id: ncr_escalation
    name: NCR Escalation
    type: automatic
    source: ncr_system
    condition: "ncr.capa_required = true"

  - id: customer_complaint
    name: Customer Complaint
    type: automatic
    source: customer_service
    condition: "complaint.severity IN ('critical', 'major')"

  - id: audit_finding
    name: Audit Finding
    type: automatic
    source: audit_system
    condition: "finding.severity IN ('major', 'critical')"

  - id: management_review
    name: Management Review Action
    type: manual
    source: management_review

  - id: regulatory_observation
    name: Regulatory Observation
    type: automatic
    source: regulatory_system

  - id: voluntary_initiation
    name: Voluntary Initiation
    type: manual
    source: any_employee

states:
  - id: draft
    name: Draft
    name_vi: Bản nháp
    type: initial
    description: CAPA being created

  - id: submitted
    name: Submitted
    name_vi: Đã gửi
    type: intermediate
    description: CAPA submitted for review

  - id: containment
    name: Containment Phase
    name_vi: Giai đoạn ngăn chặn
    type: intermediate
    description: Immediate containment actions in progress

  - id: investigation
    name: Investigation Phase
    name_vi: Giai đoạn điều tra
    type: intermediate
    description: Root cause investigation in progress

  - id: action_planning
    name: Action Planning
    name_vi: Lập kế hoạch hành động
    type: intermediate
    description: Defining corrective and preventive actions

  - id: pending_approval
    name: Pending Approval
    name_vi: Chờ phê duyệt
    type: intermediate
    description: Action plan awaiting approval

  - id: implementation
    name: Implementation Phase
    name_vi: Giai đoạn thực hiện
    type: intermediate
    description: Actions being implemented

  - id: verification
    name: Verification Phase
    name_vi: Giai đoạn xác minh
    type: intermediate
    description: Verifying action implementation

  - id: effectiveness_monitoring
    name: Effectiveness Monitoring
    name_vi: Giám sát hiệu quả
    type: intermediate
    description: Monitoring for recurrence

  - id: pending_closure
    name: Pending Closure
    name_vi: Chờ đóng
    type: intermediate
    description: Ready for final closure approval

  - id: closed_effective
    name: Closed - Effective
    name_vi: Đóng - Hiệu quả
    type: final
    description: CAPA closed, actions effective

  - id: closed_ineffective
    name: Closed - Ineffective
    name_vi: Đóng - Không hiệu quả
    type: intermediate
    description: CAPA closed but requires reopen

  - id: cancelled
    name: Cancelled
    name_vi: Đã hủy
    type: final
    description: CAPA cancelled

# 8D Methodology Steps
eight_d_structure:
  d1_team:
    name: Team Formation
    state: submitted
    description: Form cross-functional team
  d2_problem:
    name: Problem Description
    state: submitted
    description: Define problem clearly
  d3_containment:
    name: Containment Actions
    state: containment
    description: Implement immediate containment
  d4_root_cause:
    name: Root Cause Analysis
    state: investigation
    description: Identify root cause
  d5_corrective:
    name: Permanent Corrective Actions
    state: action_planning
    description: Define permanent solutions
  d6_implementation:
    name: Implementation
    state: implementation
    description: Implement corrective actions
  d7_prevention:
    name: Prevention
    state: implementation
    description: Prevent recurrence
  d8_recognition:
    name: Team Recognition
    state: pending_closure
    description: Recognize team efforts

steps:
  # D1 & D2: Team Formation and Problem Definition
  - id: initiate_capa
    name: Initiate CAPA
    name_vi: Khởi tạo CAPA
    sequence: 1
    actor: capa_initiator
    description: Create CAPA and define problem
    from_state: null
    to_state: draft
    eight_d: [d1_team, d2_problem]
    actions:
      - Identify CAPA source
      - Write problem statement
      - Define scope and impact
      - Identify affected areas
    inputs:
      - name: source_record
        type: record
        description: NCR, complaint, audit finding, etc.
    outputs:
      - name: capa_record
        type: record
      - name: problem_statement
        type: document
    required_fields:
      - source_type
      - source_reference
      - problem_statement
      - affected_product_process
      - impact_description
    problem_statement_template:
      what: Clear description of the issue
      where: Location/product/process affected
      when: Timeframe and frequency
      extent: Magnitude of impact
      impact: Consequences if not addressed
    sla:
      target: 1 day
      maximum: 3 days

  - id: assign_ownership
    name: Assign CAPA Owner
    name_vi: Giao chủ sở hữu CAPA
    sequence: 2
    actor: quality_manager
    description: Assign qualified CAPA owner
    from_state: draft
    to_state: submitted
    eight_d: d1_team
    actions:
      - Select CAPA owner
      - Verify owner qualifications
      - Assign priority
      - Set target completion date
    outputs:
      - name: capa_assignment
        type: record
    owner_requirements:
      - Authority level >= CAPA priority
      - Not from affected area (independence)
      - Available capacity
      - Relevant expertise
    priority_timelines:
      critical: 30 days
      high: 45 days
      medium: 60 days
      low: 90 days

  - id: form_team
    name: Form Cross-Functional Team
    name_vi: Thành lập nhóm đa chức năng
    sequence: 3
    actor: capa_owner
    description: Assemble team with relevant expertise
    from_state: submitted
    to_state: submitted
    eight_d: d1_team
    actions:
      - Identify required expertise
      - Select team members
      - Define roles and responsibilities
      - Schedule kickoff meeting
    outputs:
      - name: team_roster
        type: record
      - name: roles_matrix
        type: document
    recommended_functions:
      - Quality
      - Engineering
      - Production
      - Maintenance
      - Supplier Quality (if supplier related)
      - Customer Service (if customer related)

  # D3: Containment
  - id: implement_containment
    name: Implement Containment Actions
    name_vi: Thực hiện hành động ngăn chặn
    sequence: 4
    actor: capa_owner
    description: Implement immediate containment
    from_state: submitted
    to_state: containment
    eight_d: d3_containment
    condition: "containment_required = true"
    actions:
      - Define containment actions
      - Execute containment
      - Verify effectiveness
      - Document results
    outputs:
      - name: containment_actions
        type: record
      - name: containment_verification
        type: record
    containment_types:
      - Quarantine suspect material
      - Sort and inspect
      - Temporary process control
      - Enhanced inspection
      - Customer notification
    sla:
      critical: 24 hours
      high: 48 hours
      medium: 72 hours
      low: 1 week

  - id: verify_containment
    name: Verify Containment Effectiveness
    name_vi: Xác minh hiệu quả ngăn chặn
    sequence: 5
    actor: quality_engineer
    description: Verify containment actions are effective
    from_state: containment
    to_state: investigation
    eight_d: d3_containment
    actions:
      - Review containment implementation
      - Verify no additional escapes
      - Confirm customer protection
      - Document verification
    outputs:
      - name: containment_verification
        type: approval

  # D4: Root Cause Analysis
  - id: perform_root_cause_analysis
    name: Perform Root Cause Analysis
    name_vi: Thực hiện phân tích nguyên nhân gốc
    sequence: 6
    actor: capa_owner
    description: Analyze and determine root cause(s)
    from_state: investigation
    to_state: investigation
    eight_d: d4_root_cause
    actions:
      - Select analysis methodology
      - Gather data and evidence
      - Conduct team analysis
      - Identify root cause(s)
      - Document analysis
    inputs:
      - name: problem_data
        type: record
        required: true
      - name: evidence
        type: attachment
        required: true
    outputs:
      - name: root_cause_analysis
        type: record
      - name: analysis_documentation
        type: document
    methodologies:
      five_why:
        description: Ask "why" iteratively to reach root cause
        requirements:
          - Minimum 5 levels
          - Reach systemic cause
          - Not stopped at human error
        template:
          why_1: First level cause
          why_2: Why did why_1 occur?
          why_3: Why did why_2 occur?
          why_4: Why did why_3 occur?
          why_5: Root cause (systemic)
      fishbone:
        description: Ishikawa diagram categorizing potential causes
        categories:
          - Man (People)
          - Machine (Equipment)
          - Method (Process)
          - Material
          - Measurement
          - Environment
      fault_tree:
        description: Logic diagram for safety-critical analysis
        use_for: Safety issues, complex systems
      eight_d:
        description: Full 8D problem-solving
        required_for: Customer complaints
    sla:
      critical: 1 week
      high: 2 weeks
      medium: 3 weeks
      low: 4 weeks

  - id: verify_root_cause
    name: Verify Root Cause
    name_vi: Xác minh nguyên nhân gốc
    sequence: 7
    actor: quality_engineer
    description: Verify identified root cause is valid
    from_state: investigation
    to_state: action_planning
    eight_d: d4_root_cause
    actions:
      - Review analysis logic
      - Verify evidence supports conclusion
      - Confirm root cause explains all occurrences
      - Validate with team
      - Approve root cause
    outputs:
      - name: root_cause_approval
        type: approval
    verification_criteria:
      - Explains ALL instances of the problem
      - Removing it would prevent recurrence
      - Evidence supports the conclusion
      - Team consensus achieved
    approval_required:
      approver: quality_engineer
      critical_capa: quality_manager

  # D5: Action Planning
  - id: define_corrective_actions
    name: Define Corrective Actions
    name_vi: Xác định hành động khắc phục
    sequence: 8
    actor: capa_owner
    description: Define permanent corrective actions
    from_state: action_planning
    to_state: action_planning
    eight_d: d5_corrective
    actions:
      - Brainstorm potential solutions
      - Evaluate options
      - Select best solutions
      - Define specific actions
      - Assign owners and due dates
    outputs:
      - name: corrective_actions
        type: record
    action_requirements:
      - Specific description
      - Single owner per action
      - Realistic due date
      - Success criteria defined
      - Link to root cause documented
    action_types:
      corrective:
        description: Eliminates root cause of existing NC
        required: true
      preventive:
        description: Prevents occurrence in similar situations
        required: "critical or major priority"

  - id: define_preventive_actions
    name: Define Preventive Actions
    name_vi: Xác định hành động phòng ngừa
    sequence: 9
    actor: capa_owner
    description: Define actions to prevent recurrence
    from_state: action_planning
    to_state: action_planning
    eight_d: d7_prevention
    actions:
      - Identify similar processes/products
      - Evaluate horizontal deployment need
      - Define preventive actions
      - Update procedures/training
    outputs:
      - name: preventive_actions
        type: record
      - name: horizontal_deployment_assessment
        type: document
    preventive_categories:
      - Procedure updates
      - Training enhancements
      - Design changes
      - Process controls
      - Error-proofing (poka-yoke)
      - System changes

  - id: approve_action_plan
    name: Approve Action Plan
    name_vi: Phê duyệt kế hoạch hành động
    sequence: 10
    actor: quality_manager
    description: Review and approve action plan
    from_state: action_planning
    to_state: pending_approval
    eight_d: d5_corrective
    actions:
      - Review all planned actions
      - Validate addresses root cause
      - Verify resources available
      - Approve or return for revision
    outputs:
      - name: action_plan_approval
        type: approval
    validation_criteria:
      - Actions address root cause
      - Resources identified
      - Timeline realistic
      - Success criteria measurable
    approval_required:
      approver: quality_manager
      critical_capa: director_quality

  # D6: Implementation
  - id: implement_actions
    name: Implement Actions
    name_vi: Thực hiện hành động
    sequence: 11
    actor: action_owners
    description: Execute approved actions
    from_state: pending_approval
    to_state: implementation
    eight_d: d6_implementation
    actions:
      - Execute assigned actions
      - Document completion
      - Provide evidence
      - Update progress
    outputs:
      - name: action_completion_records
        type: record
      - name: implementation_evidence
        type: attachment
    evidence_types:
      - Document revisions
      - Training records
      - Photos/videos
      - Test results
      - System screenshots
      - Audit records
    tracking:
      - Monitor due dates
      - Alert at 75% of timeline
      - Escalate overdue actions
    sla:
      critical: 30 days
      high: 45 days
      medium: 60 days
      low: 90 days

  - id: update_documentation
    name: Update Documentation
    name_vi: Cập nhật tài liệu
    sequence: 12
    actor: action_owners
    description: Update affected documentation
    from_state: implementation
    to_state: implementation
    parallel: true
    actions:
      - Identify affected documents
      - Update procedures
      - Update work instructions
      - Update training materials
      - Update control plans
    outputs:
      - name: document_updates
        type: record
    document_types:
      - Procedures
      - Work instructions
      - Control plans
      - FMEA
      - Training materials
      - Inspection plans

  - id: conduct_training
    name: Conduct Training
    name_vi: Tiến hành đào tạo
    sequence: 13
    actor: action_owners
    description: Train affected personnel
    from_state: implementation
    to_state: implementation
    condition: "training_required = true"
    parallel: true
    actions:
      - Identify training needs
      - Develop training content
      - Conduct training sessions
      - Verify competency
      - Document training
    outputs:
      - name: training_records
        type: record
    training_requirements:
      - Personnel identified
      - Content defined
      - Trainer qualified
      - Competency verified
      - Records maintained

  # D7 & Verification
  - id: verify_implementation
    name: Verify Implementation
    name_vi: Xác minh thực hiện
    sequence: 14
    actor: quality_engineer
    description: Verify all actions implemented correctly
    from_state: implementation
    to_state: verification
    eight_d: d6_implementation
    actions:
      - Review all action evidence
      - Verify implementation complete
      - Check documentation updates
      - Verify training complete
      - Document verification
    outputs:
      - name: implementation_verification
        type: record
    verification_checklist:
      - All actions marked complete
      - Evidence provided for each
      - Documentation updated
      - Training completed
      - System changes validated

  - id: verify_effectiveness
    name: Verify Effectiveness
    name_vi: Xác minh hiệu quả
    sequence: 15
    actor: quality_engineer
    description: Verify actions are effective
    from_state: verification
    to_state: effectiveness_monitoring
    eight_d: d7_prevention
    actions:
      - Define effectiveness criteria
      - Collect data
      - Analyze results
      - Determine effectiveness
    outputs:
      - name: effectiveness_assessment
        type: record
    effectiveness_criteria:
      - Problem not recurring
      - Metrics improved
      - Process capability improved
      - Customer satisfaction maintained
    verification_methods:
      - Review quality data
      - Audit implementation
      - Customer feedback
      - Process monitoring

  - id: monitor_for_recurrence
    name: Monitor for Recurrence
    name_vi: Giám sát tái phát
    sequence: 16
    actor: quality_engineer
    description: Monitor during effectiveness period
    from_state: effectiveness_monitoring
    to_state: effectiveness_monitoring
    actions:
      - Set monitoring period
      - Define recurrence criteria
      - Track for recurrence
      - Document monitoring results
    outputs:
      - name: monitoring_record
        type: record
    monitoring_periods:
      critical: 90 days
      high: 60 days
      medium: 30 days
      low: 30 days
    decision_points:
      - condition: "no_recurrence"
        action: "Proceed to closure"
        next_step: prepare_closure
      - condition: "recurrence_detected"
        action: "Reopen and reanalyze"
        next_step: reopen_capa

  - id: reopen_capa
    name: Reopen CAPA
    name_vi: Mở lại CAPA
    sequence: 17
    actor: quality_manager
    description: Reopen CAPA if ineffective
    from_state: effectiveness_monitoring
    to_state: investigation
    condition: "effectiveness_result = 'not_effective'"
    actions:
      - Document ineffectiveness
      - Analyze why ineffective
      - Reset to investigation phase
      - Update timeline
    outputs:
      - name: reopen_record
        type: record
    notifications:
      - recipient: capa_owner
        message: "CAPA {{capa_number}} reopened - ineffective"
        priority: high
      - recipient: quality_manager
        message: "CAPA {{capa_number}} requires reanalysis"
        priority: high

  # D8: Closure
  - id: prepare_closure
    name: Prepare for Closure
    name_vi: Chuẩn bị đóng
    sequence: 18
    actor: capa_owner
    description: Prepare CAPA closure package
    from_state: effectiveness_monitoring
    to_state: pending_closure
    eight_d: d8_recognition
    condition: "no_recurrence"
    actions:
      - Compile closure documentation
      - Document lessons learned
      - Prepare horizontal deployment report
      - Recognize team contributions
    outputs:
      - name: closure_package
        type: document
      - name: lessons_learned
        type: record
      - name: team_recognition
        type: record
    closure_package_contents:
      - Problem statement
      - Root cause analysis
      - Action plan and evidence
      - Effectiveness verification
      - Lessons learned
      - Team recognition

  - id: close_capa
    name: Close CAPA
    name_vi: Đóng CAPA
    sequence: 19
    actor: quality_manager
    description: Final review and closure
    from_state: pending_closure
    to_state: closed_effective
    eight_d: d8_recognition
    actions:
      - Review closure package
      - Verify completeness
      - Approve closure
      - Archive CAPA
      - Distribute lessons learned
    outputs:
      - name: capa_closure
        type: approval
    approval_matrix:
      low: quality_engineer
      medium: quality_manager
      high: quality_manager
      critical: director_quality
    validations:
      - All actions complete
      - Effectiveness verified
      - No recurrence during monitoring
      - Documentation complete
      - Lessons learned documented

  - id: horizontal_deployment
    name: Horizontal Deployment
    name_vi: Triển khai ngang
    sequence: 20
    actor: quality_engineer
    description: Apply learnings to similar areas
    from_state: closed_effective
    to_state: closed_effective
    parallel: true
    actions:
      - Identify similar processes/products
      - Evaluate applicability
      - Implement applicable actions
      - Document deployment
    outputs:
      - name: horizontal_deployment_record
        type: record
    evaluation_areas:
      - Similar products
      - Similar processes
      - Other facilities
      - Other suppliers

escalation_matrix:
  critical:
    day_1: quality_manager
    day_7: plant_manager
    day_14: director_quality
    day_30: vp_quality
  high:
    day_7: quality_manager
    day_14: plant_manager
    day_30: director_quality
  overdue_actions:
    day_1: action_owner + capa_owner
    day_3: quality_manager
    day_7: plant_manager

notifications:
  - trigger: capa_created
    recipients: [capa_owner, quality_manager]
    message: "CAPA {{capa_number}} created: {{source_type}}"

  - trigger: action_due_soon
    recipients: [action_owner]
    message: "Action due in 3 days: {{action_description}}"

  - trigger: action_overdue
    recipients: [action_owner, capa_owner, quality_manager]
    message: "OVERDUE action: {{action_description}}"
    priority: high

  - trigger: effectiveness_check_due
    recipients: [quality_engineer, capa_owner]
    message: "Effectiveness check due for CAPA {{capa_number}}"

  - trigger: capa_closed
    recipients: [team_members, quality_manager]
    message: "CAPA {{capa_number}} closed successfully"

integrations:
  - system: ncr_system
    events:
      - capa_linked
      - capa_closed
    data_exchange:
      - ncr_reference
      - capa_status

  - system: training_system
    events:
      - training_required
      - training_complete
    data_exchange:
      - training_requirements
      - completion_records

  - system: document_control
    events:
      - document_update_required
      - document_updated
    data_exchange:
      - document_references
      - revision_records

  - system: supplier_portal
    events:
      - supplier_capa_required
    data_exchange:
      - supplier_8d_request
      - supplier_response

metrics:
  kpis:
    - name: capa_on_time_completion
      description: CAPAs completed within target
      target: "> 90%"

    - name: capa_effectiveness_rate
      description: CAPAs effective on first attempt
      target: "> 90%"

    - name: average_days_to_close
      description: Average cycle time
      targets:
        critical: "< 30 days"
        high: "< 45 days"
        medium: "< 60 days"
        low: "< 90 days"

    - name: recurrence_rate
      description: Issues recurring after CAPA closure
      target: "< 5%"

    - name: action_on_time_rate
      description: Individual actions completed on time
      target: "> 95%"

    - name: root_cause_accuracy
      description: Root causes verified as accurate
      target: "> 95%"

audit_trail:
  enabled: true
  events:
    - capa_creation
    - state_changes
    - root_cause_approval
    - action_plan_approval
    - action_completion
    - effectiveness_verification
    - closure_approval
  retention_years: 10
  regulatory_compliance:
    - fda_21_cfr_part_11
    - iso_9001_records
