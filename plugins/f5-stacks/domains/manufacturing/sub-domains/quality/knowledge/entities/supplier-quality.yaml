name: supplier-quality
display_name: Supplier Quality Record
display_name_vi: Bản ghi chất lượng nhà cung cấp
version: "1.0"
domain: manufacturing
subdomain: quality
type: entity

description: |
  Supplier quality performance tracking and management including
  qualification status, performance metrics, and quality history.

description_vi: |
  Theo dõi và quản lý hiệu suất chất lượng nhà cung cấp bao gồm
  trạng thái đánh giá, số liệu hiệu suất và lịch sử chất lượng.

attributes:
  - name: sqr_id
    type: string
    format: "SQR-XXXX"
    primary_key: true
    description: Unique supplier quality record ID

  - name: supplier_id
    type: reference
    references: supplier
    required: true
    description: Supplier being tracked

  - name: supplier_name
    type: string
    required: true
    description: Supplier name

  - name: supplier_code
    type: string
    description: Internal supplier code

  - name: qualification_status
    type: enum
    values:
      - pending
      - conditionally_approved
      - approved
      - preferred
      - probation
      - disqualified
      - inactive
    required: true
    default: pending
    description: Current qualification status

  - name: qualification_date
    type: date
    description: Initial qualification date

  - name: qualification_expiry
    type: date
    description: Qualification expiry date

  - name: requalification_due
    type: date
    description: Next requalification date

  - name: supplier_tier
    type: enum
    values:
      - tier_1
      - tier_2
      - tier_3
    description: Supplier tier classification

  - name: commodity_codes
    type: json
    description: Commodity codes supplied

  - name: approved_products
    type: json
    description: List of approved product IDs

  - name: approved_processes
    type: json
    description: Approved process types

  - name: quality_system
    type: string
    description: Supplier quality system (ISO 9001, etc.)

  - name: certifications
    type: json
    description: Quality certifications held
    # [{certification, number, issue_date, expiry_date}]

  - name: last_audit_date
    type: date
    description: Most recent audit date

  - name: last_audit_score
    type: decimal
    precision: 5
    scale: 2
    description: Last audit score percentage

  - name: last_audit_rating
    type: enum
    values:
      - excellent
      - good
      - acceptable
      - needs_improvement
      - unacceptable
    description: Last audit rating

  - name: next_audit_date
    type: date
    description: Next scheduled audit

  - name: audit_frequency
    type: enum
    values:
      - annual
      - semi_annual
      - quarterly
      - as_needed
    description: Audit frequency

  - name: total_lots_received
    type: integer
    default: 0
    description: Total lots received from supplier

  - name: total_lots_rejected
    type: integer
    default: 0
    description: Total lots rejected

  - name: lots_current_year
    type: integer
    default: 0
    description: Lots received this year

  - name: rejects_current_year
    type: integer
    default: 0
    description: Rejects this year

  - name: total_units_received
    type: integer
    default: 0
    description: Total units received

  - name: total_units_rejected
    type: integer
    default: 0
    description: Total units rejected

  - name: ppm_total
    type: decimal
    precision: 10
    scale: 2
    description: Parts per million defective (total)

  - name: ppm_current_year
    type: decimal
    precision: 10
    scale: 2
    description: PPM current year

  - name: ppm_target
    type: decimal
    precision: 10
    scale: 2
    description: Target PPM

  - name: lot_acceptance_rate
    type: decimal
    precision: 5
    scale: 2
    description: Lot acceptance rate percentage

  - name: on_time_delivery_rate
    type: decimal
    precision: 5
    scale: 2
    description: On-time delivery percentage

  - name: delivery_target
    type: decimal
    precision: 5
    scale: 2
    default: 95.0
    description: Delivery target percentage

  - name: ncr_count_total
    type: integer
    default: 0
    description: Total NCRs against supplier

  - name: ncr_count_year
    type: integer
    default: 0
    description: NCRs this year

  - name: open_ncrs
    type: integer
    default: 0
    description: Currently open NCRs

  - name: capa_count_total
    type: integer
    default: 0
    description: Total CAPAs against supplier

  - name: capa_count_year
    type: integer
    default: 0
    description: CAPAs this year

  - name: open_capas
    type: integer
    default: 0
    description: Currently open CAPAs

  - name: cost_recovery_total
    type: decimal
    precision: 12
    scale: 2
    description: Total cost recovered

  - name: cost_recovery_year
    type: decimal
    precision: 12
    scale: 2
    description: Cost recovered this year

  - name: quality_score
    type: decimal
    precision: 5
    scale: 2
    description: Composite quality score (0-100)

  - name: delivery_score
    type: decimal
    precision: 5
    scale: 2
    description: Delivery performance score

  - name: responsiveness_score
    type: decimal
    precision: 5
    scale: 2
    description: Responsiveness score

  - name: overall_rating
    type: decimal
    precision: 5
    scale: 2
    description: Overall supplier rating

  - name: rating_weights
    type: json
    description: Weights for rating components

  - name: inspection_level
    type: enum
    values:
      - skip_lot
      - reduced
      - normal
      - tightened
    default: normal
    description: Current inspection level

  - name: inspection_switch_rules
    type: json
    description: Rules for inspection level switching

  - name: corrective_action_status
    type: enum
    values:
      - none_required
      - pending
      - in_progress
      - completed
      - overdue
    default: none_required
    description: Corrective action status

  - name: probation_reason
    type: text
    description: Reason if on probation

  - name: probation_start_date
    type: date
    description: Probation start date

  - name: probation_end_date
    type: date
    description: Probation end date

  - name: probation_conditions
    type: text
    description: Conditions for exiting probation

  - name: disqualification_reason
    type: text
    description: Reason for disqualification

  - name: disqualification_date
    type: date
    description: Date of disqualification

  - name: primary_contact
    type: string
    description: Primary quality contact

  - name: primary_contact_email
    type: string
    description: Contact email

  - name: primary_contact_phone
    type: string
    description: Contact phone

  - name: quality_agreement_date
    type: date
    description: Quality agreement date

  - name: quality_agreement_ref
    type: string
    description: Quality agreement reference

  - name: approved_by
    type: reference
    references: employee
    description: Approval authority

  - name: approved_at
    type: datetime
    description: Approval timestamp

  - name: notes
    type: text
    description: General notes

  - name: attachments
    type: json
    description: Related documents

  - name: last_updated
    type: datetime
    auto: true
    description: Last metric update

  - name: created_at
    type: datetime
    auto: true
    description: Record creation timestamp

  - name: updated_at
    type: datetime
    auto: true
    description: Last update timestamp

relationships:
  - name: supplier
    type: one_to_one
    target: supplier
    foreign_key: supplier_id
    description: Related supplier

  - name: ncrs
    type: one_to_many
    target: ncr
    inverse: supplier_id
    description: Supplier NCRs

  - name: audits
    type: one_to_many
    target: audit
    inverse: supplier_id
    description: Supplier audits

  - name: inspections
    type: one_to_many
    target: inspection
    inverse: supplier_id
    description: Incoming inspections

state_machine:
  initial: pending
  states:
    pending:
      description: Awaiting initial qualification
      transitions:
        - to: conditionally_approved
          trigger: conditional_approve
          conditions:
            - initial_assessment_complete
        - to: approved
          trigger: approve
          conditions:
            - qualification_complete
            - audit_passed

    conditionally_approved:
      description: Approved with conditions
      transitions:
        - to: approved
          trigger: full_approve
          conditions:
            - conditions_met
        - to: disqualified
          trigger: disqualify
          conditions:
            - conditions_not_met

    approved:
      description: Fully approved supplier
      transitions:
        - to: preferred
          trigger: elevate
          conditions:
            - excellent_performance
        - to: probation
          trigger: place_on_probation
          conditions:
            - quality_issues
        - to: inactive
          trigger: deactivate
          conditions:
            - no_longer_used

    preferred:
      description: Preferred supplier status
      transitions:
        - to: approved
          trigger: demote
          conditions:
            - performance_decline
        - to: probation
          trigger: place_on_probation
          conditions:
            - quality_issues

    probation:
      description: On probation for quality issues
      transitions:
        - to: approved
          trigger: restore
          conditions:
            - probation_conditions_met
        - to: disqualified
          trigger: disqualify
          conditions:
            - probation_failed

    disqualified:
      description: Disqualified supplier
      transitions:
        - to: pending
          trigger: requalify
          conditions:
            - requalification_requested

    inactive:
      description: No longer active
      transitions:
        - to: pending
          trigger: reactivate
          conditions:
            - reactivation_requested

business_rules:
  - rule: ppm_calculation
    description: PPM calculated from inspection data
    formula: (rejected_units / received_units) * 1,000,000

  - rule: inspection_switching
    description: Inspection level switches based on performance
    validation: Follow ANSI/ASQ Z1.4 switching rules

  - rule: probation_trigger
    description: Auto-probation on severe quality issues
    validation: If major_ncrs > threshold then probation

  - rule: certification_expiry
    description: Track certification expiry
    validation: Alert before certification expires

  - rule: audit_scheduling
    description: Schedule audits based on performance
    validation: Lower performers audited more frequently

indexes:
  - columns: [supplier_id]
    unique: true
  - columns: [qualification_status]
  - columns: [supplier_tier]
  - columns: [quality_score]
  - columns: [overall_rating]
  - columns: [next_audit_date]
  - columns: [ppm_current_year]

audit:
  enabled: true
  retention_years: 10
  track_fields:
    - qualification_status
    - quality_score
    - overall_rating
    - inspection_level
