name: rework
display_name: Rework Order
display_name_vi: Lệnh làm lại
version: "1.0"
domain: manufacturing
subdomain: quality
type: entity

description: |
  Rework order for processing non-conforming products to bring them
  into compliance with specifications through repair or modification.

description_vi: |
  Lệnh làm lại để xử lý sản phẩm không phù hợp để đưa chúng
  về đúng thông số kỹ thuật thông qua sửa chữa hoặc điều chỉnh.

attributes:
  - name: rework_id
    type: string
    format: "RWK-YYYYMMDD-XXXX"
    primary_key: true
    description: Unique rework order identifier

  - name: rework_number
    type: string
    required: true
    unique: true
    description: Human-readable rework number

  - name: status
    type: enum
    values:
      - draft
      - pending_approval
      - approved
      - in_progress
      - pending_inspection
      - completed
      - cancelled
      - failed
    required: true
    default: draft
    description: Rework order status

  - name: rework_type
    type: enum
    values:
      - rework
      - repair
      - sort
      - reprocess
      - modification
    required: true
    description: Type of rework operation

  - name: priority
    type: enum
    values:
      - urgent
      - high
      - medium
      - low
    required: true
    default: medium
    description: Rework priority

  - name: ncr_id
    type: reference
    references: ncr
    required: true
    description: Source NCR

  - name: ncr_number
    type: string
    description: NCR number reference

  - name: product_id
    type: reference
    references: product
    required: true
    description: Product being reworked

  - name: product_name
    type: string
    description: Product name

  - name: lot_number
    type: string
    description: Lot number being reworked

  - name: batch_number
    type: string
    description: Batch number if applicable

  - name: serial_numbers
    type: json
    description: Serial numbers being reworked

  - name: quantity_to_rework
    type: decimal
    precision: 10
    scale: 2
    required: true
    description: Quantity to be reworked

  - name: unit_of_measure
    type: string
    required: true
    description: Unit of measure

  - name: quantity_completed
    type: decimal
    precision: 10
    scale: 2
    default: 0
    description: Quantity successfully reworked

  - name: quantity_scrapped
    type: decimal
    precision: 10
    scale: 2
    default: 0
    description: Quantity scrapped during rework

  - name: defect_code
    type: string
    required: true
    description: Defect being addressed

  - name: defect_description
    type: text
    description: Description of defect

  - name: rework_procedure
    type: text
    required: true
    description: Rework instructions

  - name: rework_procedure_ref
    type: string
    description: Rework procedure document reference

  - name: special_instructions
    type: text
    description: Special handling instructions

  - name: tools_required
    type: json
    description: Tools needed for rework

  - name: materials_required
    type: json
    description: Additional materials needed

  - name: estimated_time
    type: decimal
    precision: 8
    scale: 2
    description: Estimated time in hours

  - name: actual_time
    type: decimal
    precision: 8
    scale: 2
    description: Actual time spent

  - name: estimated_cost
    type: decimal
    precision: 12
    scale: 2
    description: Estimated rework cost

  - name: actual_cost
    type: decimal
    precision: 12
    scale: 2
    description: Actual rework cost

  - name: labor_cost
    type: decimal
    precision: 12
    scale: 2
    description: Labor cost

  - name: material_cost
    type: decimal
    precision: 12
    scale: 2
    description: Material cost

  - name: work_center_id
    type: reference
    references: work-center
    description: Where rework is performed

  - name: machine_id
    type: reference
    references: machine
    description: Machine used for rework

  - name: location
    type: string
    description: Rework location

  - name: created_by
    type: reference
    references: employee
    required: true
    description: Person who created rework order

  - name: created_date
    type: datetime
    auto: true
    description: Creation timestamp

  - name: approved_by
    type: reference
    references: employee
    description: Person who approved rework

  - name: approved_date
    type: datetime
    description: Approval timestamp

  - name: engineering_approval
    type: boolean
    default: false
    description: Engineering approval obtained

  - name: engineering_approved_by
    type: reference
    references: employee
    description: Engineer who approved

  - name: engineering_approval_date
    type: datetime
    description: Engineering approval date

  - name: customer_approval_required
    type: boolean
    default: false
    description: Customer approval needed

  - name: customer_approved
    type: boolean
    description: Customer approved

  - name: customer_approval_ref
    type: string
    description: Customer approval reference

  - name: scheduled_start
    type: datetime
    description: Scheduled start time

  - name: scheduled_end
    type: datetime
    description: Scheduled end time

  - name: actual_start
    type: datetime
    description: Actual start time

  - name: actual_end
    type: datetime
    description: Actual end time

  - name: assigned_to
    type: reference
    references: employee
    description: Operator assigned

  - name: performed_by
    type: json
    description: List of operators who performed rework

  - name: rework_steps
    type: json
    description: Step-by-step rework record
    # [{step, description, completed, completed_by, timestamp}]

  - name: inspection_required
    type: boolean
    default: true
    description: Post-rework inspection needed

  - name: inspection_plan_id
    type: reference
    references: inspection-plan
    description: Inspection plan for reworked items

  - name: inspection_id
    type: reference
    references: inspection
    description: Post-rework inspection

  - name: inspection_result
    type: enum
    values:
      - pass
      - fail
      - partial
      - pending
    description: Inspection result

  - name: re_inspection_count
    type: integer
    default: 0
    description: Number of re-inspections

  - name: final_disposition
    type: enum
    values:
      - accepted
      - scrapped
      - returned
      - pending
    description: Final disposition of reworked items

  - name: new_lot_number
    type: string
    description: New lot number if reprocessed

  - name: traceability_maintained
    type: boolean
    default: true
    description: Traceability maintained throughout

  - name: documentation_complete
    type: boolean
    default: false
    description: All documentation complete

  - name: notes
    type: text
    description: General notes

  - name: lessons_learned
    type: text
    description: Lessons learned

  - name: attachments
    type: json
    description: Photos, documents

  - name: closed_by
    type: reference
    references: employee
    description: Person who closed order

  - name: closed_date
    type: datetime
    description: Closure timestamp

  - name: closure_notes
    type: text
    description: Closure notes

  - name: updated_at
    type: datetime
    auto: true
    description: Last update timestamp

relationships:
  - name: ncr
    type: many_to_one
    target: ncr
    foreign_key: ncr_id
    description: Source NCR

  - name: product
    type: many_to_one
    target: product
    foreign_key: product_id
    description: Product being reworked

  - name: work_center
    type: many_to_one
    target: work-center
    foreign_key: work_center_id
    description: Rework location

  - name: inspection
    type: one_to_one
    target: inspection
    foreign_key: inspection_id
    description: Post-rework inspection

  - name: creator
    type: many_to_one
    target: employee
    foreign_key: created_by
    description: Creator

  - name: operator
    type: many_to_one
    target: employee
    foreign_key: assigned_to
    description: Assigned operator

state_machine:
  initial: draft
  states:
    draft:
      description: Rework order being created
      transitions:
        - to: pending_approval
          trigger: submit
          conditions:
            - procedure_defined
            - quantity_specified

    pending_approval:
      description: Awaiting approval
      transitions:
        - to: approved
          trigger: approve
          conditions:
            - approver_authorized
        - to: draft
          trigger: revise
          conditions:
            - revisions_needed
        - to: cancelled
          trigger: cancel

    approved:
      description: Approved, ready to start
      transitions:
        - to: in_progress
          trigger: start
          conditions:
            - operator_assigned
            - materials_available

    in_progress:
      description: Rework being performed
      transitions:
        - to: pending_inspection
          trigger: complete_rework
          conditions:
            - all_steps_done
        - to: cancelled
          trigger: cancel
          conditions:
            - cancellation_approved

    pending_inspection:
      description: Awaiting post-rework inspection
      transitions:
        - to: completed
          trigger: pass_inspection
          conditions:
            - inspection_passed
        - to: in_progress
          trigger: fail_inspection
          conditions:
            - additional_rework_needed
        - to: failed
          trigger: reject
          conditions:
            - not_salvageable

    completed:
      description: Rework completed successfully
      final: true

    cancelled:
      description: Rework order cancelled
      final: true

    failed:
      description: Rework failed, items scrapped
      final: true

business_rules:
  - rule: approval_required
    description: Rework requires appropriate approval
    validation: approved_by has rework approval authority

  - rule: engineering_for_deviation
    description: Engineering approval for non-standard rework
    validation: If rework_type = modification then engineering_approval required

  - rule: customer_approval
    description: Customer approval when required
    validation: If customer_approval_required then customer_approved before start

  - rule: inspection_mandatory
    description: Post-rework inspection is mandatory
    validation: inspection_result must be pass before completion

  - rule: cost_tracking
    description: Track all rework costs
    validation: actual_cost calculated before closure

indexes:
  - columns: [rework_number]
    unique: true
  - columns: [status]
  - columns: [ncr_id]
  - columns: [product_id]
  - columns: [lot_number]
  - columns: [assigned_to, status]
  - columns: [scheduled_start]
  - columns: [priority, status]

audit:
  enabled: true
  retention_years: 7
  track_fields:
    - status
    - quantity_completed
    - quantity_scrapped
    - actual_cost
    - inspection_result
