name: ncr
display_name: Non-Conformance Report
display_name_vi: Báo cáo không phù hợp
version: "1.0"
domain: manufacturing
subdomain: quality
type: entity

description: |
  Non-conformance report (NCR) documenting products, materials, or processes
  that do not meet specified requirements, with disposition and corrective actions.

description_vi: |
  Báo cáo không phù hợp (NCR) ghi nhận sản phẩm, vật liệu hoặc quy trình
  không đáp ứng yêu cầu quy định, với quyết định xử lý và hành động khắc phục.

attributes:
  - name: ncr_id
    type: string
    format: "NCR-YYYYMMDD-XXXX"
    primary_key: true
    description: Unique NCR identifier

  - name: ncr_number
    type: string
    required: true
    unique: true
    description: Human-readable NCR number

  - name: status
    type: enum
    values:
      - draft
      - open
      - under_investigation
      - pending_disposition
      - disposition_approved
      - pending_closure
      - closed
      - cancelled
    required: true
    default: draft
    description: NCR lifecycle status

  - name: ncr_type
    type: enum
    values:
      - internal
      - supplier
      - customer
      - process
      - documentation
    required: true
    description: Source/type of non-conformance

  - name: severity
    type: enum
    values:
      - critical
      - major
      - minor
    required: true
    description: Severity classification

  - name: priority
    type: enum
    values:
      - urgent
      - high
      - medium
      - low
    required: true
    default: medium
    description: Response priority

  - name: title
    type: string
    required: true
    max_length: 200
    description: Brief NCR title

  - name: description
    type: text
    required: true
    description: Detailed description of non-conformance

  - name: description_vi
    type: text
    description: Vietnamese description

  - name: detected_at
    type: datetime
    required: true
    description: When non-conformance was detected

  - name: detected_by
    type: reference
    references: employee
    required: true
    description: Person who detected the issue

  - name: detection_point
    type: enum
    values:
      - incoming_inspection
      - in_process
      - final_inspection
      - customer_site
      - field_return
      - audit
      - supplier_notification
    required: true
    description: Where non-conformance was detected

  - name: product_id
    type: reference
    references: product
    description: Affected product

  - name: product_name
    type: string
    description: Product name for reference

  - name: lot_number
    type: string
    description: Affected lot number

  - name: batch_number
    type: string
    description: Affected batch number

  - name: serial_numbers
    type: json
    description: List of affected serial numbers

  - name: quantity_affected
    type: decimal
    precision: 10
    scale: 2
    description: Quantity of affected items

  - name: unit_of_measure
    type: string
    description: Unit of measure

  - name: work_order_id
    type: reference
    references: work-order
    description: Related work order

  - name: purchase_order_id
    type: reference
    references: purchase-order
    description: Related purchase order

  - name: inspection_id
    type: reference
    references: inspection
    description: Related inspection that found issue

  - name: supplier_id
    type: reference
    references: supplier
    description: Supplier for supplier NCRs

  - name: customer_id
    type: reference
    references: customer
    description: Customer for customer NCRs

  - name: customer_po_number
    type: string
    description: Customer PO reference

  - name: nonconformance_codes
    type: json
    description: List of applicable NC codes

  - name: defect_category
    type: string
    description: Defect category classification

  - name: root_cause_category
    type: enum
    values:
      - design
      - material
      - process
      - equipment
      - operator
      - environment
      - measurement
      - supplier
      - unknown
    description: High-level root cause category

  - name: root_cause_description
    type: text
    description: Detailed root cause analysis

  - name: immediate_action
    type: text
    description: Containment actions taken

  - name: containment_effective
    type: boolean
    description: Whether containment was effective

  - name: disposition
    type: enum
    values:
      - use_as_is
      - rework
      - repair
      - scrap
      - return_to_vendor
      - sort_and_use
      - downgrade
      - deviate
    description: Final disposition decision

  - name: disposition_reason
    type: text
    description: Justification for disposition

  - name: disposition_by
    type: reference
    references: employee
    description: Person who decided disposition

  - name: disposition_date
    type: datetime
    description: When disposition was decided

  - name: disposition_approved_by
    type: reference
    references: employee
    description: Manager who approved disposition

  - name: disposition_approval_date
    type: datetime
    description: Disposition approval timestamp

  - name: customer_notification_required
    type: boolean
    default: false
    description: Whether customer must be notified

  - name: customer_notified_at
    type: datetime
    description: When customer was notified

  - name: customer_response
    type: text
    description: Customer response/decision

  - name: rework_id
    type: reference
    references: rework
    description: Related rework order

  - name: capa_required
    type: boolean
    default: false
    description: Whether CAPA is required

  - name: capa_id
    type: reference
    references: capa
    description: Related CAPA if created

  - name: cost_impact
    type: decimal
    precision: 12
    scale: 2
    description: Estimated cost impact

  - name: cost_category
    type: enum
    values:
      - scrap
      - rework
      - sorting
      - shipping
      - warranty
      - other
    description: Cost category

  - name: recovery_amount
    type: decimal
    precision: 12
    scale: 2
    description: Amount recovered from supplier

  - name: target_close_date
    type: date
    description: Target closure date

  - name: actual_close_date
    type: date
    description: Actual closure date

  - name: days_open
    type: integer
    description: Days NCR was open

  - name: recurrence_count
    type: integer
    default: 0
    description: Number of recurrences

  - name: related_ncrs
    type: json
    description: Related NCR references

  - name: attachments
    type: json
    description: Photos, documents, evidence

  - name: investigation_notes
    type: text
    description: Investigation documentation

  - name: lessons_learned
    type: text
    description: Lessons learned from NCR

  - name: owner_id
    type: reference
    references: employee
    required: true
    description: NCR owner responsible for resolution

  - name: investigator_id
    type: reference
    references: employee
    description: Person investigating root cause

  - name: reviewed_by
    type: reference
    references: employee
    description: Quality reviewer

  - name: reviewed_at
    type: datetime
    description: Review timestamp

  - name: closed_by
    type: reference
    references: employee
    description: Person who closed NCR

  - name: closed_at
    type: datetime
    description: Closure timestamp

  - name: closure_notes
    type: text
    description: Notes on closure

  - name: electronic_signatures
    type: json
    description: FDA 21 CFR Part 11 signatures

  - name: created_at
    type: datetime
    auto: true
    description: Record creation timestamp

  - name: updated_at
    type: datetime
    auto: true
    description: Last update timestamp

relationships:
  - name: product
    type: many_to_one
    target: product
    foreign_key: product_id
    description: Affected product

  - name: inspection
    type: many_to_one
    target: inspection
    foreign_key: inspection_id
    description: Source inspection

  - name: supplier
    type: many_to_one
    target: supplier
    foreign_key: supplier_id
    description: Supplier for supplier NCRs

  - name: customer
    type: many_to_one
    target: customer
    foreign_key: customer_id
    description: Customer for customer NCRs

  - name: capa
    type: one_to_one
    target: capa
    foreign_key: capa_id
    description: Related CAPA

  - name: rework
    type: one_to_one
    target: rework
    foreign_key: rework_id
    description: Rework order if applicable

  - name: owner
    type: many_to_one
    target: employee
    foreign_key: owner_id
    description: NCR owner

  - name: work_order
    type: many_to_one
    target: work-order
    foreign_key: work_order_id
    description: Related work order

state_machine:
  initial: draft
  states:
    draft:
      description: NCR being created
      transitions:
        - to: open
          trigger: submit
          conditions:
            - description_complete
            - owner_assigned

    open:
      description: NCR submitted, awaiting investigation
      transitions:
        - to: under_investigation
          trigger: start_investigation
          conditions:
            - investigator_assigned
        - to: cancelled
          trigger: cancel
          conditions:
            - cancellation_approved

    under_investigation:
      description: Root cause investigation in progress
      transitions:
        - to: pending_disposition
          trigger: complete_investigation
          conditions:
            - root_cause_documented
            - containment_verified

    pending_disposition:
      description: Awaiting disposition decision
      transitions:
        - to: disposition_approved
          trigger: approve_disposition
          conditions:
            - disposition_selected
            - disposition_authorized
        - to: under_investigation
          trigger: reopen_investigation
          conditions:
            - additional_investigation_needed

    disposition_approved:
      description: Disposition approved, executing
      transitions:
        - to: pending_closure
          trigger: complete_disposition
          conditions:
            - disposition_executed
            - verification_complete

    pending_closure:
      description: Ready for closure
      transitions:
        - to: closed
          trigger: close
          conditions:
            - all_actions_complete
            - capa_addressed_if_required
        - to: disposition_approved
          trigger: reopen
          conditions:
            - closure_issue_found

    closed:
      description: NCR resolved and closed
      final: true

    cancelled:
      description: NCR cancelled
      final: true

business_rules:
  - rule: severity_drives_response
    description: Critical NCRs require immediate containment
    validation: If severity = critical then immediate_action required within 24h

  - rule: capa_for_recurring
    description: CAPA required for recurring issues
    validation: If recurrence_count > 0 then capa_required = true

  - rule: customer_notification
    description: Customer notification for shipped product
    validation: If detection_point = customer_site then customer_notification_required

  - rule: disposition_authority
    description: Disposition requires appropriate authority level
    validation: disposition_approved_by has authority for severity level

  - rule: closure_verification
    description: Closure requires verification of disposition
    validation: All disposition actions must be verified before closure

  - rule: cost_tracking
    description: Cost impact must be tracked for major/critical
    validation: If severity in (critical, major) then cost_impact required

indexes:
  - columns: [ncr_number]
    unique: true
  - columns: [status]
  - columns: [severity, priority]
  - columns: [ncr_type, status]
  - columns: [supplier_id, status]
  - columns: [product_id]
  - columns: [lot_number]
  - columns: [detected_at]
  - columns: [owner_id, status]
  - columns: [target_close_date]

audit:
  enabled: true
  retention_years: 10
  track_fields:
    - status
    - severity
    - disposition
    - root_cause_category
    - cost_impact
