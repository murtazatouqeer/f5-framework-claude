name: capa
display_name: CAPA (Corrective and Preventive Action)
display_name_vi: CAPA (Hành động khắc phục và phòng ngừa)
version: "1.0"
domain: manufacturing
subdomain: quality
type: entity

description: |
  Corrective and Preventive Action (CAPA) system for systematic identification,
  analysis, and resolution of quality issues to prevent recurrence.

description_vi: |
  Hệ thống hành động khắc phục và phòng ngừa (CAPA) để nhận dạng có hệ thống,
  phân tích và giải quyết các vấn đề chất lượng để ngăn ngừa tái phát.

attributes:
  - name: capa_id
    type: string
    format: "CAPA-YYYY-XXXX"
    primary_key: true
    description: Unique CAPA identifier

  - name: capa_number
    type: string
    required: true
    unique: true
    description: Human-readable CAPA number

  - name: status
    type: enum
    values:
      - draft
      - open
      - root_cause_analysis
      - action_planning
      - action_implementation
      - verification
      - effectiveness_monitoring
      - closed
      - cancelled
    required: true
    default: draft
    description: CAPA lifecycle status

  - name: capa_type
    type: enum
    values:
      - corrective
      - preventive
      - improvement
    required: true
    description: Type of CAPA

  - name: priority
    type: enum
    values:
      - critical
      - high
      - medium
      - low
    required: true
    default: medium
    description: CAPA priority

  - name: title
    type: string
    required: true
    max_length: 200
    description: Brief CAPA title

  - name: problem_statement
    type: text
    required: true
    description: Clear statement of the problem

  - name: problem_statement_vi
    type: text
    description: Vietnamese problem statement

  - name: source_type
    type: enum
    values:
      - ncr
      - customer_complaint
      - audit_finding
      - management_review
      - supplier_issue
      - process_deviation
      - risk_assessment
      - employee_suggestion
      - regulatory_observation
    required: true
    description: Source that triggered CAPA

  - name: source_reference
    type: string
    description: Reference to source document/record

  - name: ncr_id
    type: reference
    references: ncr
    description: Related NCR if applicable

  - name: audit_id
    type: reference
    references: audit
    description: Related audit if applicable

  - name: complaint_id
    type: reference
    references: customer-complaint
    description: Related complaint if applicable

  - name: initiated_date
    type: date
    required: true
    description: CAPA initiation date

  - name: initiated_by
    type: reference
    references: employee
    required: true
    description: Person who initiated CAPA

  - name: owner_id
    type: reference
    references: employee
    required: true
    description: CAPA owner responsible for completion

  - name: team_members
    type: json
    description: CAPA team member IDs and roles

  - name: affected_area
    type: string
    description: Area/process affected

  - name: affected_products
    type: json
    description: List of affected product IDs

  - name: affected_processes
    type: json
    description: List of affected process IDs

  - name: risk_level
    type: enum
    values:
      - high
      - medium
      - low
    description: Risk assessment level

  - name: risk_assessment
    type: text
    description: Risk assessment details

  - name: immediate_containment
    type: text
    description: Immediate containment actions taken

  - name: containment_date
    type: datetime
    description: When containment was implemented

  - name: containment_verified
    type: boolean
    default: false
    description: Containment effectiveness verified

  - name: containment_verified_by
    type: reference
    references: employee
    description: Person who verified containment

  - name: root_cause_method
    type: enum
    values:
      - five_why
      - fishbone
      - eight_d
      - fmea
      - fault_tree
      - pareto
      - spc
      - other
    description: Root cause analysis method used

  - name: root_cause_analysis
    type: text
    description: Detailed root cause analysis

  - name: root_cause_category
    type: enum
    values:
      - man
      - machine
      - material
      - method
      - measurement
      - environment
    description: Root cause category (6M)

  - name: root_causes
    type: json
    description: List of identified root causes

  - name: contributing_factors
    type: json
    description: Contributing factors identified

  - name: rca_completed_date
    type: date
    description: Root cause analysis completion date

  - name: rca_approved_by
    type: reference
    references: employee
    description: Person who approved RCA

  - name: actions
    type: json
    description: List of corrective/preventive actions
    # Each action has: action_id, description, owner, due_date, status, completion_date, evidence

  - name: action_plan_approved
    type: boolean
    default: false
    description: Action plan approved

  - name: action_plan_approved_by
    type: reference
    references: employee
    description: Person who approved action plan

  - name: action_plan_approved_date
    type: datetime
    description: Action plan approval date

  - name: implementation_start_date
    type: date
    description: Implementation start date

  - name: implementation_end_date
    type: date
    description: Implementation completion date

  - name: verification_method
    type: text
    description: How effectiveness will be verified

  - name: verification_criteria
    type: text
    description: Criteria for successful verification

  - name: verification_results
    type: text
    description: Verification results and evidence

  - name: verification_date
    type: date
    description: When verification was performed

  - name: verified_by
    type: reference
    references: employee
    description: Person who performed verification

  - name: verification_status
    type: enum
    values:
      - pending
      - passed
      - failed
      - partial
    description: Verification status

  - name: effectiveness_check_required
    type: boolean
    default: true
    description: Whether effectiveness check needed

  - name: effectiveness_check_period
    type: integer
    description: Monitoring period in days

  - name: effectiveness_check_date
    type: date
    description: Scheduled effectiveness check date

  - name: effectiveness_result
    type: enum
    values:
      - effective
      - partially_effective
      - not_effective
      - pending
    description: Effectiveness determination

  - name: effectiveness_evidence
    type: text
    description: Evidence of effectiveness

  - name: recurrence_check
    type: boolean
    default: false
    description: Issue recurred after closure

  - name: lessons_learned
    type: text
    description: Lessons learned documentation

  - name: document_updates
    type: json
    description: Documents updated as result of CAPA

  - name: training_required
    type: boolean
    default: false
    description: Training required as part of CAPA

  - name: training_records
    type: json
    description: Training record references

  - name: horizontal_deployment
    type: boolean
    default: false
    description: Actions deployed to other areas

  - name: horizontal_deployment_areas
    type: json
    description: Areas where actions were deployed

  - name: cost_of_quality
    type: decimal
    precision: 12
    scale: 2
    description: Cost associated with issue

  - name: cost_of_capa
    type: decimal
    precision: 12
    scale: 2
    description: Cost of implementing CAPA

  - name: cost_avoidance
    type: decimal
    precision: 12
    scale: 2
    description: Estimated cost avoidance

  - name: target_close_date
    type: date
    required: true
    description: Target closure date

  - name: actual_close_date
    type: date
    description: Actual closure date

  - name: days_open
    type: integer
    description: Days CAPA was open

  - name: extension_count
    type: integer
    default: 0
    description: Number of extensions granted

  - name: extension_reason
    type: text
    description: Reason for latest extension

  - name: related_capas
    type: json
    description: Related CAPA references

  - name: attachments
    type: json
    description: Supporting documents

  - name: reviewed_by
    type: reference
    references: employee
    description: Quality reviewer

  - name: reviewed_at
    type: datetime
    description: Review timestamp

  - name: approved_by
    type: reference
    references: employee
    description: Manager who approved closure

  - name: approved_at
    type: datetime
    description: Approval timestamp

  - name: closed_by
    type: reference
    references: employee
    description: Person who closed CAPA

  - name: closed_at
    type: datetime
    description: Closure timestamp

  - name: electronic_signatures
    type: json
    description: FDA 21 CFR Part 11 signatures

  - name: created_at
    type: datetime
    auto: true
    description: Record creation timestamp

  - name: updated_at
    type: datetime
    auto: true
    description: Last update timestamp

relationships:
  - name: ncr
    type: many_to_one
    target: ncr
    foreign_key: ncr_id
    description: Source NCR

  - name: audit
    type: many_to_one
    target: audit
    foreign_key: audit_id
    description: Source audit

  - name: complaint
    type: many_to_one
    target: customer-complaint
    foreign_key: complaint_id
    description: Source complaint

  - name: owner
    type: many_to_one
    target: employee
    foreign_key: owner_id
    description: CAPA owner

  - name: initiator
    type: many_to_one
    target: employee
    foreign_key: initiated_by
    description: Person who initiated

state_machine:
  initial: draft
  states:
    draft:
      description: CAPA being drafted
      transitions:
        - to: open
          trigger: submit
          conditions:
            - problem_statement_complete
            - owner_assigned

    open:
      description: CAPA opened, awaiting analysis
      transitions:
        - to: root_cause_analysis
          trigger: start_analysis
          conditions:
            - containment_implemented
        - to: cancelled
          trigger: cancel
          conditions:
            - cancellation_approved

    root_cause_analysis:
      description: RCA in progress
      transitions:
        - to: action_planning
          trigger: complete_rca
          conditions:
            - root_cause_identified
            - rca_approved

    action_planning:
      description: Defining corrective actions
      transitions:
        - to: action_implementation
          trigger: approve_plan
          conditions:
            - actions_defined
            - plan_approved
        - to: root_cause_analysis
          trigger: revise_rca
          conditions:
            - rca_needs_revision

    action_implementation:
      description: Implementing actions
      transitions:
        - to: verification
          trigger: complete_implementation
          conditions:
            - all_actions_completed

    verification:
      description: Verifying effectiveness
      transitions:
        - to: effectiveness_monitoring
          trigger: verify_actions
          conditions:
            - verification_passed
        - to: action_implementation
          trigger: reimplement
          conditions:
            - verification_failed

    effectiveness_monitoring:
      description: Monitoring for recurrence
      transitions:
        - to: closed
          trigger: close
          conditions:
            - effectiveness_confirmed
            - no_recurrence
        - to: root_cause_analysis
          trigger: reopen
          conditions:
            - recurrence_detected

    closed:
      description: CAPA closed successfully
      final: true

    cancelled:
      description: CAPA cancelled
      final: true

business_rules:
  - rule: rca_method_required
    description: Root cause analysis method must be documented
    validation: root_cause_method required for completion

  - rule: action_ownership
    description: Each action must have an owner
    validation: All actions have assigned owner

  - rule: effectiveness_verification
    description: Effectiveness must be verified
    validation: effectiveness_result required before closure

  - rule: timeline_tracking
    description: Target dates must be met or extensions documented
    validation: If past target_close_date then extension_reason required

  - rule: eight_d_compliance
    description: 8D methodology compliance for customer CAPAs
    validation: 8D steps documented for customer-related CAPAs

indexes:
  - columns: [capa_number]
    unique: true
  - columns: [status]
  - columns: [capa_type, status]
  - columns: [priority]
  - columns: [owner_id, status]
  - columns: [source_type]
  - columns: [target_close_date]
  - columns: [ncr_id]
  - columns: [effectiveness_check_date]

audit:
  enabled: true
  retention_years: 10
  track_fields:
    - status
    - root_cause_category
    - effectiveness_result
    - actions
