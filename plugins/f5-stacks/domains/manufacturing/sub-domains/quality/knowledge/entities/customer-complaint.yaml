name: customer-complaint
display_name: Customer Complaint
display_name_vi: Khiếu nại khách hàng
version: "1.0"
domain: manufacturing
subdomain: quality
type: entity

description: |
  Customer complaint record for tracking and resolving quality issues
  reported by customers including investigation and corrective actions.

description_vi: |
  Bản ghi khiếu nại khách hàng để theo dõi và giải quyết các vấn đề chất lượng
  được báo cáo bởi khách hàng bao gồm điều tra và hành động khắc phục.

attributes:
  - name: complaint_id
    type: string
    format: "CC-YYYY-XXXX"
    primary_key: true
    description: Unique complaint identifier

  - name: complaint_number
    type: string
    required: true
    unique: true
    description: Human-readable complaint number

  - name: status
    type: enum
    values:
      - received
      - acknowledged
      - under_investigation
      - pending_response
      - awaiting_customer
      - resolved
      - closed
      - rejected
    required: true
    default: received
    description: Complaint lifecycle status

  - name: priority
    type: enum
    values:
      - critical
      - high
      - medium
      - low
    required: true
    default: medium
    description: Response priority

  - name: complaint_type
    type: enum
    values:
      - product_defect
      - documentation
      - packaging
      - labeling
      - delivery
      - service
      - specification
      - performance
      - safety
      - other
    required: true
    description: Type of complaint

  - name: severity
    type: enum
    values:
      - critical
      - major
      - minor
      - cosmetic
    required: true
    description: Issue severity

  - name: customer_id
    type: reference
    references: customer
    required: true
    description: Customer who complained

  - name: customer_name
    type: string
    required: true
    description: Customer name

  - name: customer_contact
    type: string
    description: Customer contact person

  - name: customer_email
    type: string
    description: Contact email

  - name: customer_phone
    type: string
    description: Contact phone

  - name: customer_reference
    type: string
    description: Customer's reference number

  - name: received_date
    type: datetime
    required: true
    description: When complaint was received

  - name: received_via
    type: enum
    values:
      - email
      - phone
      - portal
      - letter
      - in_person
      - field_report
    required: true
    description: How complaint was received

  - name: received_by
    type: reference
    references: employee
    required: true
    description: Person who received complaint

  - name: title
    type: string
    required: true
    max_length: 200
    description: Brief complaint title

  - name: description
    type: text
    required: true
    description: Detailed complaint description

  - name: description_vi
    type: text
    description: Vietnamese description

  - name: product_id
    type: reference
    references: product
    description: Affected product

  - name: product_name
    type: string
    description: Product name

  - name: lot_numbers
    type: json
    description: Affected lot numbers

  - name: serial_numbers
    type: json
    description: Affected serial numbers

  - name: quantity_affected
    type: decimal
    precision: 10
    scale: 2
    description: Quantity affected

  - name: unit_of_measure
    type: string
    description: Unit of measure

  - name: sales_order_number
    type: string
    description: Related sales order

  - name: invoice_number
    type: string
    description: Related invoice

  - name: shipment_date
    type: date
    description: When product was shipped

  - name: failure_date
    type: date
    description: When issue occurred

  - name: failure_mode
    type: text
    description: How the product failed

  - name: operating_conditions
    type: text
    description: Conditions at time of failure

  - name: customer_request
    type: text
    description: What customer is requesting

  - name: replacement_required
    type: boolean
    default: false
    description: Replacement requested

  - name: refund_required
    type: boolean
    default: false
    description: Refund requested

  - name: credit_required
    type: boolean
    default: false
    description: Credit requested

  - name: acknowledged_at
    type: datetime
    description: When customer was acknowledged

  - name: acknowledged_by
    type: reference
    references: employee
    description: Person who acknowledged

  - name: response_due_date
    type: date
    description: Target response date

  - name: owner_id
    type: reference
    references: employee
    required: true
    description: Complaint owner

  - name: investigator_id
    type: reference
    references: employee
    description: Person investigating

  - name: investigation_start
    type: datetime
    description: Investigation start time

  - name: investigation_findings
    type: text
    description: Investigation findings

  - name: root_cause
    type: text
    description: Root cause determination

  - name: root_cause_category
    type: enum
    values:
      - design
      - manufacturing
      - material
      - handling
      - documentation
      - customer_use
      - no_fault_found
      - unknown
    description: Root cause category

  - name: fault_determined
    type: enum
    values:
      - company_fault
      - supplier_fault
      - customer_fault
      - no_fault
      - shared_fault
      - undetermined
    description: Fault determination

  - name: sample_requested
    type: boolean
    default: false
    description: Sample return requested

  - name: sample_received
    type: boolean
    default: false
    description: Sample received

  - name: sample_received_date
    type: date
    description: When sample received

  - name: sample_analysis
    type: text
    description: Sample analysis results

  - name: ncr_id
    type: reference
    references: ncr
    description: Related NCR

  - name: capa_id
    type: reference
    references: capa
    description: Related CAPA

  - name: capa_required
    type: boolean
    default: false
    description: Whether CAPA is required

  - name: corrective_action
    type: text
    description: Corrective action taken

  - name: preventive_action
    type: text
    description: Preventive action taken

  - name: response_to_customer
    type: text
    description: Formal response sent

  - name: response_date
    type: datetime
    description: When response was sent

  - name: response_method
    type: enum
    values:
      - email
      - letter
      - phone
      - portal
      - in_person
    description: How response was delivered

  - name: customer_satisfaction
    type: enum
    values:
      - satisfied
      - partially_satisfied
      - dissatisfied
      - no_response
    description: Customer satisfaction with resolution

  - name: escalated
    type: boolean
    default: false
    description: Complaint was escalated

  - name: escalation_reason
    type: text
    description: Reason for escalation

  - name: escalated_to
    type: reference
    references: employee
    description: Who it was escalated to

  - name: escalation_date
    type: datetime
    description: When escalated

  - name: cost_of_complaint
    type: decimal
    precision: 12
    scale: 2
    description: Total cost associated

  - name: credit_amount
    type: decimal
    precision: 12
    scale: 2
    description: Credit issued

  - name: replacement_cost
    type: decimal
    precision: 12
    scale: 2
    description: Replacement cost

  - name: warranty_claim
    type: boolean
    default: false
    description: Is this a warranty claim

  - name: warranty_approved
    type: boolean
    description: Warranty claim approved

  - name: days_to_resolve
    type: integer
    description: Days to resolve complaint

  - name: sla_met
    type: boolean
    description: SLA was met

  - name: lessons_learned
    type: text
    description: Lessons learned

  - name: similar_complaints
    type: json
    description: References to similar complaints

  - name: attachments
    type: json
    description: Photos, documents, evidence

  - name: closed_date
    type: datetime
    description: When complaint was closed

  - name: closed_by
    type: reference
    references: employee
    description: Who closed the complaint

  - name: closure_notes
    type: text
    description: Closure notes

  - name: customer_sign_off
    type: boolean
    default: false
    description: Customer confirmed closure

  - name: created_at
    type: datetime
    auto: true
    description: Record creation timestamp

  - name: updated_at
    type: datetime
    auto: true
    description: Last update timestamp

relationships:
  - name: customer
    type: many_to_one
    target: customer
    foreign_key: customer_id
    description: Customer who complained

  - name: product
    type: many_to_one
    target: product
    foreign_key: product_id
    description: Affected product

  - name: owner
    type: many_to_one
    target: employee
    foreign_key: owner_id
    description: Complaint owner

  - name: ncr
    type: one_to_one
    target: ncr
    foreign_key: ncr_id
    description: Related NCR

  - name: capa
    type: one_to_one
    target: capa
    foreign_key: capa_id
    description: Related CAPA

state_machine:
  initial: received
  states:
    received:
      description: Complaint received
      transitions:
        - to: acknowledged
          trigger: acknowledge
          conditions:
            - customer_notified

    acknowledged:
      description: Customer acknowledged
      transitions:
        - to: under_investigation
          trigger: start_investigation
          conditions:
            - owner_assigned
        - to: rejected
          trigger: reject
          conditions:
            - not_valid_complaint

    under_investigation:
      description: Being investigated
      transitions:
        - to: pending_response
          trigger: complete_investigation
          conditions:
            - findings_documented
        - to: awaiting_customer
          trigger: request_info
          conditions:
            - need_more_info

    awaiting_customer:
      description: Waiting for customer info
      transitions:
        - to: under_investigation
          trigger: info_received
        - to: closed
          trigger: no_response
          conditions:
            - timeout_reached

    pending_response:
      description: Response being prepared
      transitions:
        - to: resolved
          trigger: send_response
          conditions:
            - response_approved

    resolved:
      description: Response sent, awaiting closure
      transitions:
        - to: closed
          trigger: close
          conditions:
            - customer_satisfied
        - to: under_investigation
          trigger: reopen
          conditions:
            - customer_not_satisfied

    closed:
      description: Complaint closed
      final: true

    rejected:
      description: Complaint rejected as invalid
      final: true

business_rules:
  - rule: acknowledgment_sla
    description: Must acknowledge within 24 hours
    validation: acknowledged_at within 24h of received_date

  - rule: response_sla
    description: Must respond within SLA period
    validation: response_date <= response_due_date

  - rule: safety_escalation
    description: Safety complaints escalate immediately
    validation: If complaint_type = safety then priority = critical

  - rule: capa_for_recurring
    description: CAPA required for recurring complaints
    validation: If similar_complaints.count > threshold then capa_required

  - rule: cost_tracking
    description: Track all complaint costs
    validation: cost_of_complaint documented before closure

indexes:
  - columns: [complaint_number]
    unique: true
  - columns: [status]
  - columns: [customer_id, status]
  - columns: [priority, status]
  - columns: [product_id]
  - columns: [received_date]
  - columns: [response_due_date]
  - columns: [owner_id, status]

audit:
  enabled: true
  retention_years: 10
  track_fields:
    - status
    - root_cause_category
    - fault_determined
    - cost_of_complaint
