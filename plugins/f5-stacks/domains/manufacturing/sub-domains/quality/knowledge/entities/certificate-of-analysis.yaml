name: certificate-of-analysis
display_name: Certificate of Analysis
display_name_vi: Chứng chỉ phân tích
version: "1.0"
domain: manufacturing
subdomain: quality
type: entity

description: |
  Certificate of Analysis (COA) documenting quality test results and
  certifying that products meet specifications for customer shipment.

description_vi: |
  Chứng chỉ phân tích (COA) ghi nhận kết quả kiểm tra chất lượng và
  chứng nhận sản phẩm đáp ứng thông số kỹ thuật để giao cho khách hàng.

attributes:
  - name: coa_id
    type: string
    format: "COA-YYYYMMDD-XXXX"
    primary_key: true
    description: Unique COA identifier

  - name: coa_number
    type: string
    required: true
    unique: true
    description: Human-readable COA number

  - name: status
    type: enum
    values:
      - draft
      - pending_review
      - approved
      - issued
      - superseded
      - void
    required: true
    default: draft
    description: COA status

  - name: certificate_type
    type: enum
    values:
      - coa
      - coc
      - combined
      - test_report
    required: true
    default: coa
    description: Type of certificate

  - name: product_id
    type: reference
    references: product
    required: true
    description: Certified product

  - name: product_name
    type: string
    required: true
    description: Product name

  - name: product_part_number
    type: string
    description: Part number

  - name: product_revision
    type: string
    description: Product revision level

  - name: lot_number
    type: string
    required: true
    description: Certified lot number

  - name: batch_number
    type: string
    description: Batch number if applicable

  - name: serial_numbers
    type: json
    description: Serial numbers if applicable

  - name: quantity
    type: decimal
    precision: 10
    scale: 2
    required: true
    description: Quantity certified

  - name: unit_of_measure
    type: string
    required: true
    description: Unit of measure

  - name: manufacture_date
    type: date
    description: Date of manufacture

  - name: expiry_date
    type: date
    description: Product expiry date

  - name: shelf_life_days
    type: integer
    description: Shelf life in days

  - name: customer_id
    type: reference
    references: customer
    description: Customer receiving COA

  - name: customer_name
    type: string
    description: Customer name

  - name: customer_po_number
    type: string
    description: Customer purchase order

  - name: sales_order_number
    type: string
    description: Internal sales order

  - name: shipment_id
    type: string
    description: Related shipment

  - name: inspection_id
    type: reference
    references: inspection
    required: true
    description: Source inspection

  - name: inspection_date
    type: date
    required: true
    description: When inspection was performed

  - name: specification_reference
    type: string
    description: Specification used for testing

  - name: specification_revision
    type: string
    description: Specification revision

  - name: test_results
    type: json
    required: true
    description: Test result details
    # [{characteristic, specification, result, unit, status}]

  - name: all_tests_passed
    type: boolean
    required: true
    description: All tests passed

  - name: deviations
    type: json
    description: Any deviations from spec

  - name: deviation_approval
    type: string
    description: Deviation approval reference

  - name: material_certifications
    type: json
    description: Incoming material cert references

  - name: raw_material_lots
    type: json
    description: Raw material lot traceability

  - name: process_parameters
    type: json
    description: Key process parameters recorded

  - name: environmental_conditions
    type: json
    description: Test environment conditions

  - name: test_equipment
    type: json
    description: Equipment used for testing

  - name: calibration_status
    type: text
    description: Calibration status of equipment

  - name: test_methods
    type: json
    description: Test methods used

  - name: sampling_plan
    type: string
    description: Sampling plan used

  - name: sample_size
    type: integer
    description: Number of samples tested

  - name: statistical_data
    type: json
    description: Statistical analysis data
    # {mean, std_dev, cp, cpk, range}

  - name: appearance_result
    type: string
    description: Visual appearance result

  - name: packaging_result
    type: string
    description: Packaging inspection result

  - name: labeling_verified
    type: boolean
    default: false
    description: Labeling verified correct

  - name: documentation_verified
    type: boolean
    default: false
    description: Documentation verified complete

  - name: special_requirements
    type: text
    description: Customer special requirements

  - name: special_requirements_met
    type: boolean
    description: Special requirements satisfied

  - name: regulatory_compliance
    type: json
    description: Regulatory compliance statements

  - name: certifications_referenced
    type: json
    description: Referenced certifications (ISO, etc.)

  - name: country_of_origin
    type: string
    description: Country of origin

  - name: harmonized_code
    type: string
    description: HS code for customs

  - name: rohs_compliant
    type: boolean
    description: RoHS compliance

  - name: reach_compliant
    type: boolean
    description: REACH compliance

  - name: conflict_mineral_free
    type: boolean
    description: Conflict mineral free certification

  - name: notes
    type: text
    description: Additional notes

  - name: internal_notes
    type: text
    description: Internal notes (not on certificate)

  - name: prepared_by
    type: reference
    references: employee
    required: true
    description: Person who prepared COA

  - name: prepared_date
    type: datetime
    auto: true
    description: Preparation timestamp

  - name: reviewed_by
    type: reference
    references: employee
    description: Quality reviewer

  - name: reviewed_date
    type: datetime
    description: Review timestamp

  - name: approved_by
    type: reference
    references: employee
    description: Approving authority

  - name: approved_date
    type: datetime
    description: Approval timestamp

  - name: issued_date
    type: datetime
    description: When COA was issued

  - name: issued_to
    type: string
    description: Who COA was issued to

  - name: delivery_method
    type: enum
    values:
      - with_shipment
      - email
      - portal
      - mail
      - fax
    description: How COA was delivered

  - name: template_id
    type: string
    description: COA template used

  - name: document_path
    type: string
    description: Path to generated document

  - name: document_format
    type: enum
    values:
      - pdf
      - excel
      - word
    default: pdf
    description: Document format

  - name: version
    type: integer
    default: 1
    description: COA version number

  - name: supersedes_coa_id
    type: reference
    references: certificate-of-analysis
    description: COA this supersedes

  - name: void_reason
    type: text
    description: Reason if voided

  - name: void_date
    type: datetime
    description: When voided

  - name: void_by
    type: reference
    references: employee
    description: Who voided

  - name: electronic_signature
    type: json
    description: FDA 21 CFR Part 11 signature data

  - name: signature_image_path
    type: string
    description: Path to signature image

  - name: attachments
    type: json
    description: Supporting documents

  - name: created_at
    type: datetime
    auto: true
    description: Record creation timestamp

  - name: updated_at
    type: datetime
    auto: true
    description: Last update timestamp

relationships:
  - name: product
    type: many_to_one
    target: product
    foreign_key: product_id
    description: Certified product

  - name: customer
    type: many_to_one
    target: customer
    foreign_key: customer_id
    description: Receiving customer

  - name: inspection
    type: many_to_one
    target: inspection
    foreign_key: inspection_id
    description: Source inspection

  - name: preparer
    type: many_to_one
    target: employee
    foreign_key: prepared_by
    description: COA preparer

  - name: approver
    type: many_to_one
    target: employee
    foreign_key: approved_by
    description: COA approver

  - name: superseded_coa
    type: many_to_one
    target: certificate-of-analysis
    foreign_key: supersedes_coa_id
    description: Previous version

state_machine:
  initial: draft
  states:
    draft:
      description: COA being prepared
      transitions:
        - to: pending_review
          trigger: submit
          conditions:
            - test_results_complete
            - all_data_entered

    pending_review:
      description: Awaiting quality review
      transitions:
        - to: approved
          trigger: approve
          conditions:
            - reviewed_by_quality
            - no_discrepancies
        - to: draft
          trigger: revise
          conditions:
            - revisions_needed

    approved:
      description: Approved, ready to issue
      transitions:
        - to: issued
          trigger: issue
          conditions:
            - document_generated
            - signature_applied

    issued:
      description: Issued to customer
      transitions:
        - to: superseded
          trigger: supersede
          conditions:
            - new_version_issued
        - to: void
          trigger: void
          conditions:
            - void_authorized

    superseded:
      description: Replaced by newer version
      final: true

    void:
      description: Certificate voided
      final: true

business_rules:
  - rule: test_results_required
    description: All test results must be documented
    validation: test_results contains all required characteristics

  - rule: approval_before_issue
    description: COA must be approved before issue
    validation: approved_by and approved_date set before issued status

  - rule: electronic_signature
    description: FDA regulated products need e-signature
    validation: electronic_signature complete for regulated products

  - rule: traceability_complete
    description: Full traceability must be documented
    validation: raw_material_lots or material_certifications provided

  - rule: version_control
    description: Track all COA versions
    validation: version incremented on revision

indexes:
  - columns: [coa_number]
    unique: true
  - columns: [lot_number]
  - columns: [product_id, lot_number]
  - columns: [customer_id]
  - columns: [inspection_id]
  - columns: [status]
  - columns: [issued_date]
  - columns: [sales_order_number]

audit:
  enabled: true
  retention_years: 10
  track_fields:
    - status
    - test_results
    - approved_by
    - approved_date
