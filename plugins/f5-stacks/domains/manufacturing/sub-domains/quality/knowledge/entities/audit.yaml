name: audit
display_name: Quality Audit
display_name_vi: Kiểm toán chất lượng
version: "1.0"
domain: manufacturing
subdomain: quality
type: entity

description: |
  Quality audit record for systematic examination of quality management
  system, processes, and products against defined criteria and standards.

description_vi: |
  Bản ghi kiểm toán chất lượng để kiểm tra có hệ thống hệ thống quản lý
  chất lượng, quy trình và sản phẩm so với tiêu chí và tiêu chuẩn.

attributes:
  - name: audit_id
    type: string
    format: "AUD-YYYY-XXXX"
    primary_key: true
    description: Unique audit identifier

  - name: audit_number
    type: string
    required: true
    unique: true
    description: Human-readable audit number

  - name: status
    type: enum
    values:
      - planned
      - scheduled
      - in_progress
      - pending_report
      - report_review
      - completed
      - cancelled
    required: true
    default: planned
    description: Audit lifecycle status

  - name: audit_type
    type: enum
    values:
      - internal
      - external
      - supplier
      - customer
      - certification
      - surveillance
      - process
      - product
      - system
    required: true
    description: Type of audit

  - name: audit_scope
    type: enum
    values:
      - full_system
      - partial
      - process_specific
      - product_specific
      - follow_up
    required: true
    description: Scope of audit

  - name: title
    type: string
    required: true
    description: Audit title/name

  - name: description
    type: text
    description: Audit description and objectives

  - name: description_vi
    type: text
    description: Vietnamese description

  - name: standard_reference
    type: json
    description: Standards being audited against
    # e.g., ["ISO 9001:2015", "ISO/TS 16949"]

  - name: audit_criteria
    type: text
    description: Specific audit criteria

  - name: audit_plan_id
    type: string
    description: Reference to annual audit plan

  - name: scheduled_start_date
    type: date
    required: true
    description: Planned start date

  - name: scheduled_end_date
    type: date
    required: true
    description: Planned end date

  - name: actual_start_date
    type: date
    description: Actual start date

  - name: actual_end_date
    type: date
    description: Actual end date

  - name: duration_days
    type: integer
    description: Audit duration in days

  - name: lead_auditor_id
    type: reference
    references: employee
    required: true
    description: Lead auditor

  - name: audit_team
    type: json
    description: Audit team members
    # [{auditor_id, role, areas_assigned}]

  - name: auditee_representative
    type: string
    description: Auditee contact person

  - name: auditee_organization
    type: string
    description: Organization being audited

  - name: audited_areas
    type: json
    description: Departments/areas to be audited

  - name: audited_processes
    type: json
    description: Processes to be audited

  - name: supplier_id
    type: reference
    references: supplier
    description: Supplier for supplier audits

  - name: location
    type: string
    description: Audit location

  - name: audit_method
    type: enum
    values:
      - on_site
      - remote
      - hybrid
    default: on_site
    description: Audit method

  - name: opening_meeting_date
    type: datetime
    description: Opening meeting timestamp

  - name: closing_meeting_date
    type: datetime
    description: Closing meeting timestamp

  - name: checklist_id
    type: string
    description: Reference to audit checklist used

  - name: checklist_results
    type: json
    description: Checklist question responses

  - name: total_questions
    type: integer
    description: Total checklist questions

  - name: conforming_count
    type: integer
    description: Number of conforming items

  - name: non_conforming_count
    type: integer
    description: Number of non-conformances

  - name: observation_count
    type: integer
    description: Number of observations

  - name: opportunity_count
    type: integer
    description: Number of improvement opportunities

  - name: findings
    type: json
    description: List of audit findings
    # [{finding_id, type, clause, description, evidence, severity}]

  - name: major_nc_count
    type: integer
    default: 0
    description: Major non-conformances found

  - name: minor_nc_count
    type: integer
    default: 0
    description: Minor non-conformances found

  - name: observations
    type: json
    description: Observations and opportunities

  - name: positive_findings
    type: json
    description: Positive findings/best practices

  - name: conformance_score
    type: decimal
    precision: 5
    scale: 2
    description: Overall conformance percentage

  - name: audit_rating
    type: enum
    values:
      - excellent
      - good
      - acceptable
      - needs_improvement
      - unacceptable
    description: Overall audit rating

  - name: executive_summary
    type: text
    description: Executive summary of findings

  - name: conclusions
    type: text
    description: Audit conclusions

  - name: recommendations
    type: text
    description: Auditor recommendations

  - name: report_draft_date
    type: date
    description: Draft report date

  - name: report_final_date
    type: date
    description: Final report date

  - name: report_path
    type: string
    description: Path to audit report document

  - name: response_due_date
    type: date
    description: Due date for auditee response

  - name: auditee_response
    type: text
    description: Auditee response to findings

  - name: response_received_date
    type: date
    description: When response was received

  - name: capa_ids
    type: json
    description: CAPAs created from audit

  - name: follow_up_required
    type: boolean
    default: false
    description: Whether follow-up audit needed

  - name: follow_up_audit_id
    type: reference
    references: audit
    description: Follow-up audit reference

  - name: follow_up_due_date
    type: date
    description: Follow-up audit due date

  - name: previous_audit_id
    type: reference
    references: audit
    description: Previous related audit

  - name: certification_body
    type: string
    description: Certification body for external audits

  - name: certificate_number
    type: string
    description: Related certificate number

  - name: certification_status
    type: enum
    values:
      - passed
      - conditional
      - failed
      - not_applicable
    description: Certification decision

  - name: confidentiality_level
    type: enum
    values:
      - public
      - internal
      - confidential
      - restricted
    default: internal
    description: Report confidentiality level

  - name: attachments
    type: json
    description: Supporting documents, photos

  - name: lessons_learned
    type: text
    description: Lessons learned from audit

  - name: reviewed_by
    type: reference
    references: employee
    description: Quality manager who reviewed

  - name: reviewed_at
    type: datetime
    description: Review timestamp

  - name: approved_by
    type: reference
    references: employee
    description: Manager who approved report

  - name: approved_at
    type: datetime
    description: Approval timestamp

  - name: created_at
    type: datetime
    auto: true
    description: Record creation timestamp

  - name: updated_at
    type: datetime
    auto: true
    description: Last update timestamp

relationships:
  - name: lead_auditor
    type: many_to_one
    target: employee
    foreign_key: lead_auditor_id
    description: Lead auditor

  - name: supplier
    type: many_to_one
    target: supplier
    foreign_key: supplier_id
    description: Audited supplier

  - name: capas
    type: one_to_many
    target: capa
    inverse: audit_id
    description: CAPAs from audit findings

  - name: follow_up_audit
    type: one_to_one
    target: audit
    foreign_key: follow_up_audit_id
    description: Follow-up audit

  - name: previous_audit
    type: many_to_one
    target: audit
    foreign_key: previous_audit_id
    description: Previous audit in series

state_machine:
  initial: planned
  states:
    planned:
      description: Audit planned in schedule
      transitions:
        - to: scheduled
          trigger: schedule
          conditions:
            - dates_confirmed
            - team_assigned

    scheduled:
      description: Audit scheduled with resources
      transitions:
        - to: in_progress
          trigger: start
          conditions:
            - opening_meeting_held
        - to: cancelled
          trigger: cancel
          conditions:
            - cancellation_approved

    in_progress:
      description: Audit being conducted
      transitions:
        - to: pending_report
          trigger: complete_fieldwork
          conditions:
            - closing_meeting_held
            - findings_documented

    pending_report:
      description: Audit complete, report being written
      transitions:
        - to: report_review
          trigger: submit_report
          conditions:
            - report_drafted

    report_review:
      description: Report under review
      transitions:
        - to: completed
          trigger: approve_report
          conditions:
            - report_reviewed
            - response_received
        - to: pending_report
          trigger: revise_report
          conditions:
            - revisions_needed

    completed:
      description: Audit completed
      final: true

    cancelled:
      description: Audit cancelled
      final: true

business_rules:
  - rule: auditor_independence
    description: Auditors cannot audit their own work
    validation: Lead auditor not from audited area

  - rule: auditor_qualification
    description: Auditors must be qualified
    validation: Lead auditor has internal auditor certification

  - rule: finding_documentation
    description: All findings must have evidence
    validation: Each finding has documented evidence

  - rule: capa_for_major_nc
    description: Major NCs require CAPA
    validation: CAPA created for each major non-conformance

  - rule: follow_up_tracking
    description: Follow-up audits must be tracked
    validation: If follow_up_required then follow_up_due_date set

indexes:
  - columns: [audit_number]
    unique: true
  - columns: [status]
  - columns: [audit_type, status]
  - columns: [scheduled_start_date]
  - columns: [lead_auditor_id]
  - columns: [supplier_id]
  - columns: [audit_rating]
  - columns: [follow_up_due_date]

audit:
  enabled: true
  retention_years: 7
  track_fields:
    - status
    - findings
    - audit_rating
    - conformance_score
