name: inspection
display_name: Quality Inspection
display_name_vi: Kiểm tra chất lượng
version: "1.0"
domain: manufacturing
subdomain: quality
type: entity

description: |
  Quality inspection record for verifying products, materials, or processes
  against specifications and quality standards.

description_vi: |
  Bản ghi kiểm tra chất lượng để xác minh sản phẩm, vật liệu hoặc quy trình
  so với thông số kỹ thuật và tiêu chuẩn chất lượng.

attributes:
  - name: inspection_id
    type: string
    format: "INS-YYYYMMDD-XXXX"
    primary_key: true
    description: Unique inspection identifier

  - name: inspection_number
    type: string
    required: true
    unique: true
    description: Human-readable inspection number

  - name: inspection_type
    type: enum
    values:
      - incoming
      - in_process
      - final
      - periodic
      - audit
      - receiving
      - source
    required: true
    description: Type of inspection being performed

  - name: inspection_plan_id
    type: reference
    references: inspection-plan
    required: true
    description: Reference to the inspection plan used

  - name: status
    type: enum
    values:
      - scheduled
      - in_progress
      - pending_review
      - approved
      - rejected
      - cancelled
    required: true
    default: scheduled
    description: Current inspection status

  - name: result
    type: enum
    values:
      - pass
      - fail
      - conditional
      - pending
    description: Overall inspection result

  - name: inspected_entity_type
    type: enum
    values:
      - material
      - product
      - work_order
      - lot
      - equipment
      - process
    required: true
    description: Type of entity being inspected

  - name: inspected_entity_id
    type: string
    required: true
    description: ID of the entity being inspected

  - name: lot_number
    type: string
    description: Lot number for traceability

  - name: batch_number
    type: string
    description: Batch number if applicable

  - name: quantity_inspected
    type: decimal
    precision: 10
    scale: 2
    description: Quantity that was inspected

  - name: quantity_passed
    type: decimal
    precision: 10
    scale: 2
    description: Quantity that passed inspection

  - name: quantity_failed
    type: decimal
    precision: 10
    scale: 2
    description: Quantity that failed inspection

  - name: unit_of_measure
    type: string
    description: Unit of measure for quantities

  - name: sample_size
    type: integer
    description: Number of samples taken

  - name: sampling_plan
    type: string
    description: Sampling plan used (e.g., AQL level)

  - name: scheduled_date
    type: date
    description: Scheduled inspection date

  - name: started_at
    type: datetime
    description: Actual start time

  - name: completed_at
    type: datetime
    description: Completion timestamp

  - name: inspector_id
    type: reference
    references: employee
    required: true
    description: Inspector who performed inspection

  - name: work_center_id
    type: reference
    references: work-center
    description: Work center where inspection performed

  - name: location
    type: string
    description: Physical location of inspection

  - name: supplier_id
    type: reference
    references: supplier
    description: Supplier for incoming inspection

  - name: customer_id
    type: reference
    references: customer
    description: Customer for final inspection

  - name: work_order_id
    type: reference
    references: work-order
    description: Related work order

  - name: purchase_order_id
    type: reference
    references: purchase-order
    description: Related purchase order for incoming

  - name: defects_found
    type: integer
    default: 0
    description: Total number of defects found

  - name: defect_rate
    type: decimal
    precision: 5
    scale: 4
    description: Defect rate (defects/inspected)

  - name: ncr_required
    type: boolean
    default: false
    description: Whether NCR needs to be created

  - name: ncr_id
    type: reference
    references: ncr
    description: Related NCR if created

  - name: disposition
    type: enum
    values:
      - accept
      - reject
      - rework
      - use_as_is
      - return_to_vendor
      - scrap
      - hold
    description: Material disposition decision

  - name: disposition_reason
    type: text
    description: Reason for disposition decision

  - name: disposition_by
    type: reference
    references: employee
    description: Who made disposition decision

  - name: disposition_date
    type: datetime
    description: When disposition was decided

  - name: coa_required
    type: boolean
    default: false
    description: Certificate of Analysis required

  - name: coa_id
    type: reference
    references: certificate-of-analysis
    description: Related COA if generated

  - name: notes
    type: text
    description: General inspection notes

  - name: attachments
    type: json
    description: Photos, documents, evidence

  - name: equipment_used
    type: json
    description: List of inspection equipment used

  - name: environmental_conditions
    type: json
    description: Temperature, humidity during inspection

  - name: reviewed_by
    type: reference
    references: employee
    description: Quality engineer who reviewed

  - name: reviewed_at
    type: datetime
    description: Review timestamp

  - name: approved_by
    type: reference
    references: employee
    description: Manager who approved

  - name: approved_at
    type: datetime
    description: Approval timestamp

  - name: electronic_signature
    type: json
    description: FDA 21 CFR Part 11 signature data

  - name: created_at
    type: datetime
    auto: true
    description: Record creation timestamp

  - name: updated_at
    type: datetime
    auto: true
    description: Last update timestamp

relationships:
  - name: inspection_plan
    type: many_to_one
    target: inspection-plan
    foreign_key: inspection_plan_id
    description: Plan governing this inspection

  - name: inspector
    type: many_to_one
    target: employee
    foreign_key: inspector_id
    description: Inspector performing inspection

  - name: samples
    type: one_to_many
    target: sample
    inverse: inspection_id
    description: Samples collected during inspection

  - name: measurements
    type: one_to_many
    target: measurement
    inverse: inspection_id
    description: Measurements recorded

  - name: ncr
    type: one_to_one
    target: ncr
    foreign_key: ncr_id
    description: Non-conformance report if created

  - name: coa
    type: one_to_one
    target: certificate-of-analysis
    foreign_key: coa_id
    description: Certificate of analysis

  - name: work_order
    type: many_to_one
    target: work-order
    foreign_key: work_order_id
    description: Related production work order

state_machine:
  initial: scheduled
  states:
    scheduled:
      description: Inspection is scheduled
      transitions:
        - to: in_progress
          trigger: start_inspection
          conditions:
            - inspector_assigned
            - materials_available

    in_progress:
      description: Inspection being performed
      transitions:
        - to: pending_review
          trigger: complete_inspection
          conditions:
            - all_measurements_recorded
        - to: cancelled
          trigger: cancel
          conditions:
            - cancellation_approved

    pending_review:
      description: Awaiting quality review
      transitions:
        - to: approved
          trigger: approve
          conditions:
            - reviewed_by_quality
            - result_determined
        - to: in_progress
          trigger: reopen
          conditions:
            - additional_inspection_needed

    approved:
      description: Inspection approved and finalized
      final: true

    rejected:
      description: Inspection rejected
      final: true

    cancelled:
      description: Inspection cancelled
      final: true

business_rules:
  - rule: inspection_requires_plan
    description: Every inspection must reference an inspection plan
    validation: inspection_plan_id is required

  - rule: inspector_qualification
    description: Inspector must be qualified for inspection type
    validation: Inspector certification matches inspection requirements

  - rule: sample_size_compliance
    description: Sample size must match sampling plan requirements
    validation: sample_size >= required_sample_size

  - rule: disposition_authority
    description: Only authorized personnel can set disposition
    validation: disposition_by has disposition authority

  - rule: ncr_on_failure
    description: NCR required when inspection fails
    validation: If result = fail then ncr_required = true

  - rule: electronic_signature_compliance
    description: FDA 21 CFR Part 11 compliance for signatures
    validation: electronic_signature includes user_id, timestamp, meaning

indexes:
  - columns: [inspection_number]
    unique: true
  - columns: [inspection_type, status]
  - columns: [inspected_entity_type, inspected_entity_id]
  - columns: [lot_number]
  - columns: [scheduled_date]
  - columns: [inspector_id, status]
  - columns: [supplier_id, inspection_type]
  - columns: [work_order_id]

audit:
  enabled: true
  retention_years: 7
  track_fields:
    - status
    - result
    - disposition
    - quantity_passed
    - quantity_failed
