name: measurement
display_name: Quality Measurement
display_name_vi: Đo lường chất lượng
version: "1.0"
domain: manufacturing
subdomain: quality
type: entity

description: |
  Individual measurement record capturing actual values measured
  during quality inspection with pass/fail determination.

description_vi: |
  Bản ghi đo lường riêng lẻ ghi nhận giá trị thực đo được
  trong quá trình kiểm tra chất lượng với xác định đạt/không đạt.

attributes:
  - name: measurement_id
    type: string
    format: "MSR-YYYYMMDD-XXXXXX"
    primary_key: true
    description: Unique measurement identifier

  - name: inspection_id
    type: reference
    references: inspection
    required: true
    description: Parent inspection

  - name: sample_id
    type: reference
    references: sample
    description: Sample measured (if applicable)

  - name: characteristic_id
    type: reference
    references: quality-characteristic
    required: true
    description: Characteristic being measured

  - name: measurement_number
    type: integer
    required: true
    description: Measurement sequence for this characteristic

  - name: measured_at
    type: datetime
    required: true
    auto: true
    description: Measurement timestamp

  - name: measured_by
    type: reference
    references: employee
    required: true
    description: Person who took measurement

  - name: data_type
    type: enum
    values:
      - variable
      - attribute
    required: true
    description: Variable or attribute measurement

  - name: measured_value
    type: decimal
    precision: 15
    scale: 6
    description: Actual measured value (variable data)

  - name: unit_of_measure
    type: string
    description: Measurement unit

  - name: attribute_result
    type: enum
    values:
      - pass
      - fail
      - not_applicable
    description: Pass/fail result (attribute data)

  - name: attribute_value
    type: string
    description: Recorded attribute value

  - name: nominal_value
    type: decimal
    precision: 15
    scale: 6
    description: Target value at time of measurement

  - name: upper_spec_limit
    type: decimal
    precision: 15
    scale: 6
    description: USL at time of measurement

  - name: lower_spec_limit
    type: decimal
    precision: 15
    scale: 6
    description: LSL at time of measurement

  - name: deviation
    type: decimal
    precision: 15
    scale: 6
    description: Deviation from nominal

  - name: deviation_percent
    type: decimal
    precision: 8
    scale: 4
    description: Percentage deviation from nominal

  - name: result
    type: enum
    values:
      - pass
      - fail
      - marginal
      - not_tested
    required: true
    description: Measurement result

  - name: is_within_spec
    type: boolean
    description: Whether value is within specification

  - name: is_within_control
    type: boolean
    description: Whether value is within control limits

  - name: defect_code
    type: string
    description: Defect code if failed

  - name: defect_description
    type: text
    description: Description of defect found

  - name: defect_severity
    type: enum
    values:
      - critical
      - major
      - minor
    description: Severity of defect if found

  - name: equipment_id
    type: reference
    references: equipment
    description: Measurement equipment used

  - name: equipment_name
    type: string
    description: Name of equipment used

  - name: equipment_serial
    type: string
    description: Equipment serial number

  - name: calibration_due_date
    type: date
    description: Equipment calibration due date

  - name: is_equipment_calibrated
    type: boolean
    description: Equipment was calibrated at measurement time

  - name: measurement_conditions
    type: json
    description: Environmental conditions during measurement

  - name: temperature
    type: decimal
    precision: 6
    scale: 2
    description: Temperature during measurement

  - name: humidity
    type: decimal
    precision: 5
    scale: 2
    description: Humidity during measurement

  - name: measurement_method
    type: string
    description: Method used for measurement

  - name: reading_number
    type: integer
    default: 1
    description: Reading number if multiple readings

  - name: total_readings
    type: integer
    default: 1
    description: Total readings for this measurement

  - name: average_value
    type: decimal
    precision: 15
    scale: 6
    description: Average if multiple readings

  - name: std_deviation
    type: decimal
    precision: 15
    scale: 6
    description: Standard deviation of readings

  - name: spc_violation
    type: boolean
    default: false
    description: Whether this caused SPC violation

  - name: spc_rule_violated
    type: string
    description: Which SPC rule was violated

  - name: requires_action
    type: boolean
    default: false
    description: Whether measurement requires action

  - name: action_taken
    type: text
    description: Action taken based on measurement

  - name: photo_path
    type: string
    description: Path to measurement photo

  - name: notes
    type: text
    description: Measurement notes

  - name: verified_by
    type: reference
    references: employee
    description: Person who verified measurement

  - name: verified_at
    type: datetime
    description: Verification timestamp

  - name: electronic_signature
    type: json
    description: FDA 21 CFR Part 11 signature

  - name: created_at
    type: datetime
    auto: true
    description: Record creation timestamp

relationships:
  - name: inspection
    type: many_to_one
    target: inspection
    foreign_key: inspection_id
    description: Parent inspection

  - name: sample
    type: many_to_one
    target: sample
    foreign_key: sample_id
    description: Sample measured

  - name: characteristic
    type: many_to_one
    target: quality-characteristic
    foreign_key: characteristic_id
    description: Characteristic measured

  - name: measurer
    type: many_to_one
    target: employee
    foreign_key: measured_by
    description: Person who measured

  - name: equipment
    type: many_to_one
    target: equipment
    foreign_key: equipment_id
    description: Equipment used

  - name: control_chart_points
    type: one_to_many
    target: control-chart-point
    inverse: measurement_id
    description: SPC chart data points

business_rules:
  - rule: calibrated_equipment
    description: Equipment must be calibrated
    validation: is_equipment_calibrated = true for valid measurement

  - rule: result_determination
    description: Result must be determined correctly
    validation: Result matches spec limit comparison

  - rule: defect_on_failure
    description: Failed measurements require defect code
    validation: If result = fail then defect_code required

  - rule: spc_tracking
    description: SPC violations must be flagged
    validation: spc_violation set when control limits exceeded

  - rule: verification_for_critical
    description: Critical measurements require verification
    validation: If defect_severity = critical then verified_by required

indexes:
  - columns: [inspection_id, characteristic_id, measurement_number]
  - columns: [sample_id]
  - columns: [measured_at]
  - columns: [result]
  - columns: [defect_code]
  - columns: [spc_violation]
  - columns: [equipment_id]

audit:
  enabled: true
  retention_years: 7
  track_fields:
    - measured_value
    - result
    - defect_code
