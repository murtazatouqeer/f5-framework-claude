name: control-chart
display_name: Statistical Control Chart
display_name_vi: Biểu đồ kiểm soát thống kê
version: "1.0"
domain: manufacturing
subdomain: quality
type: entity

description: |
  Statistical Process Control (SPC) chart for monitoring process variation,
  detecting special cause variation, and maintaining process capability.

description_vi: |
  Biểu đồ kiểm soát quy trình thống kê (SPC) để giám sát biến động quy trình,
  phát hiện biến động nguyên nhân đặc biệt và duy trì năng lực quy trình.

attributes:
  - name: chart_id
    type: string
    format: "SPC-XXXX"
    primary_key: true
    description: Unique chart identifier

  - name: chart_name
    type: string
    required: true
    description: Descriptive chart name

  - name: chart_name_vi
    type: string
    description: Vietnamese chart name

  - name: status
    type: enum
    values:
      - active
      - inactive
      - under_review
      - archived
    required: true
    default: active
    description: Chart status

  - name: chart_type
    type: enum
    values:
      - xbar_r
      - xbar_s
      - individual_mr
      - p_chart
      - np_chart
      - c_chart
      - u_chart
      - cusum
      - ewma
    required: true
    description: Type of control chart

  - name: data_type
    type: enum
    values:
      - variable
      - attribute
    required: true
    description: Variable or attribute data

  - name: characteristic_id
    type: reference
    references: quality-characteristic
    required: true
    description: Quality characteristic being charted

  - name: product_id
    type: reference
    references: product
    description: Product being monitored

  - name: process_id
    type: string
    description: Process being monitored

  - name: work_center_id
    type: reference
    references: work-center
    description: Work center being monitored

  - name: machine_id
    type: reference
    references: machine
    description: Specific machine monitored

  - name: operation_id
    type: reference
    references: operation
    description: Operation being monitored

  - name: description
    type: text
    description: Chart description and purpose

  - name: unit_of_measure
    type: string
    description: Measurement unit

  - name: subgroup_size
    type: integer
    required: true
    default: 5
    description: Sample subgroup size

  - name: sampling_frequency
    type: string
    description: How often samples are taken

  - name: specification_center
    type: decimal
    precision: 15
    scale: 6
    description: Specification center/nominal

  - name: upper_spec_limit
    type: decimal
    precision: 15
    scale: 6
    description: Upper specification limit (USL)

  - name: lower_spec_limit
    type: decimal
    precision: 15
    scale: 6
    description: Lower specification limit (LSL)

  - name: center_line
    type: decimal
    precision: 15
    scale: 6
    description: Chart center line (X-bar or p)

  - name: upper_control_limit
    type: decimal
    precision: 15
    scale: 6
    description: Upper control limit (UCL)

  - name: lower_control_limit
    type: decimal
    precision: 15
    scale: 6
    description: Lower control limit (LCL)

  - name: range_center_line
    type: decimal
    precision: 15
    scale: 6
    description: R-bar or S-bar center line

  - name: range_ucl
    type: decimal
    precision: 15
    scale: 6
    description: Range chart UCL

  - name: range_lcl
    type: decimal
    precision: 15
    scale: 6
    description: Range chart LCL

  - name: sigma_multiplier
    type: decimal
    precision: 4
    scale: 2
    default: 3.0
    description: Sigma multiplier for control limits

  - name: limits_calculation_method
    type: enum
    values:
      - calculated
      - historical
      - specified
    default: calculated
    description: How limits were determined

  - name: baseline_start_date
    type: date
    description: Start of baseline data

  - name: baseline_end_date
    type: date
    description: End of baseline data

  - name: baseline_subgroups
    type: integer
    description: Number of subgroups in baseline

  - name: current_mean
    type: decimal
    precision: 15
    scale: 6
    description: Current process mean

  - name: current_std_dev
    type: decimal
    precision: 15
    scale: 6
    description: Current standard deviation

  - name: current_range
    type: decimal
    precision: 15
    scale: 6
    description: Current average range

  - name: cp
    type: decimal
    precision: 6
    scale: 4
    description: Process capability (Cp)

  - name: cpk
    type: decimal
    precision: 6
    scale: 4
    description: Process capability index (Cpk)

  - name: cpu
    type: decimal
    precision: 6
    scale: 4
    description: Upper capability index

  - name: cpl
    type: decimal
    precision: 6
    scale: 4
    description: Lower capability index

  - name: pp
    type: decimal
    precision: 6
    scale: 4
    description: Process performance (Pp)

  - name: ppk
    type: decimal
    precision: 6
    scale: 4
    description: Process performance index (Ppk)

  - name: cp_target
    type: decimal
    precision: 4
    scale: 2
    default: 1.33
    description: Target Cp value

  - name: cpk_target
    type: decimal
    precision: 4
    scale: 2
    default: 1.33
    description: Target Cpk value

  - name: capability_status
    type: enum
    values:
      - capable
      - marginal
      - not_capable
      - unknown
    description: Process capability status

  - name: total_subgroups
    type: integer
    default: 0
    description: Total subgroups recorded

  - name: total_violations
    type: integer
    default: 0
    description: Total control limit violations

  - name: violation_rate
    type: decimal
    precision: 5
    scale: 4
    description: Violation rate percentage

  - name: last_violation_date
    type: datetime
    description: Most recent violation

  - name: current_trend
    type: enum
    values:
      - stable
      - upward
      - downward
      - erratic
      - unknown
    description: Current trend assessment

  - name: western_electric_rules
    type: boolean
    default: true
    description: Apply Western Electric rules

  - name: nelson_rules
    type: boolean
    default: false
    description: Apply Nelson rules

  - name: active_rules
    type: json
    description: List of active detection rules

  - name: notification_enabled
    type: boolean
    default: true
    description: Enable violation notifications

  - name: notification_recipients
    type: json
    description: Who to notify on violations

  - name: escalation_rules
    type: json
    description: Escalation for violations

  - name: reaction_plan
    type: text
    description: What to do on violation

  - name: owner_id
    type: reference
    references: employee
    required: true
    description: Chart owner

  - name: last_reviewed_date
    type: date
    description: Last review date

  - name: reviewed_by
    type: reference
    references: employee
    description: Reviewer

  - name: next_review_date
    type: date
    description: Next scheduled review

  - name: recalculate_limits
    type: boolean
    default: false
    description: Flag to recalculate limits

  - name: limits_locked
    type: boolean
    default: false
    description: Whether limits are locked

  - name: attachments
    type: json
    description: Related documents

  - name: notes
    type: text
    description: General notes

  - name: created_at
    type: datetime
    auto: true
    description: Creation timestamp

  - name: updated_at
    type: datetime
    auto: true
    description: Last update timestamp

relationships:
  - name: characteristic
    type: many_to_one
    target: quality-characteristic
    foreign_key: characteristic_id
    description: Monitored characteristic

  - name: product
    type: many_to_one
    target: product
    foreign_key: product_id
    description: Product monitored

  - name: work_center
    type: many_to_one
    target: work-center
    foreign_key: work_center_id
    description: Work center monitored

  - name: data_points
    type: one_to_many
    target: control-chart-point
    inverse: chart_id
    description: Chart data points

  - name: owner
    type: many_to_one
    target: employee
    foreign_key: owner_id
    description: Chart owner

business_rules:
  - rule: subgroup_size_match
    description: Subgroup size must match chart type requirements
    validation: xbar_r requires subgroup_size 2-10, xbar_s for >10

  - rule: control_limits_required
    description: Active charts must have control limits
    validation: If status = active then UCL, LCL, center_line required

  - rule: capability_calculation
    description: Cp/Cpk requires spec limits
    validation: Cp/Cpk calculated only when USL and LSL defined

  - rule: baseline_data_required
    description: Need baseline data for calculated limits
    validation: baseline_subgroups >= 20 for calculated limits

  - rule: periodic_review
    description: Charts must be reviewed periodically
    validation: next_review_date within review period

indexes:
  - columns: [chart_name]
    unique: true
  - columns: [characteristic_id]
  - columns: [product_id, status]
  - columns: [work_center_id]
  - columns: [machine_id]
  - columns: [status]
  - columns: [capability_status]
  - columns: [owner_id]

audit:
  enabled: true
  retention_years: 7
  track_fields:
    - center_line
    - upper_control_limit
    - lower_control_limit
    - cp
    - cpk
