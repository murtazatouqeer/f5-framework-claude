name: Offer
display_name: Offer / Đề nghị giá
description: |
  Đề nghị giá từ buyer cho listing có allow_offers = true.
  Hỗ trợ counter-offer qua lại.

domain: agriculture
category: core

attributes:
  - name: id
    type: uuid
    required: true

  - name: listing_id
    type: uuid
    required: true

  - name: buyer_id
    type: uuid
    required: true

  - name: quantity
    type: integer
    required: true
    description: Số lượng muốn mua

  - name: price_per_kg
    type: decimal
    required: true
    description: Giá đề nghị/kg

  - name: total_amount
    type: decimal
    required: true
    description: Tổng tiền

  - name: note
    type: text
    required: false
    description: Ghi chú từ buyer

  - name: status
    type: enum
    required: true
    validation:
      values: [pending, accepted, rejected, countered, expired, withdrawn]
    default: pending

  - name: parent_offer_id
    type: uuid
    required: false
    description: Offer gốc (nếu là counter-offer)

  - name: counter_round
    type: integer
    required: true
    default: 1
    description: Vòng counter (max 3)

  - name: responded_at
    type: timestamp
    required: false

  - name: response_note
    type: text
    required: false
    description: Ghi chú từ seller

  - name: expires_at
    type: timestamp
    required: true
    description: Hết hạn sau 24h

  - name: created_at
    type: timestamp
    required: true

relationships:
  - name: listing
    type: belongs_to
    entity: Listing
    required: true

  - name: buyer
    type: belongs_to
    entity: User
    required: true

  - name: parent_offer
    type: belongs_to
    entity: Offer
    required: false

  - name: counter_offers
    type: has_many
    entity: Offer
    foreign_key: parent_offer_id

indexes:
  - [listing_id, status]
  - [buyer_id]
  - [expires_at]

business_rules:
  - BR-OFR-001: price_per_kg >= listing.floor_price (nếu có)
  - BR-OFR-002: Offer hết hạn sau 24h không phản hồi
  - BR-OFR-003: Tối đa 3 vòng counter-offer
  - BR-OFR-004: Accepted offer tạo Order ngay lập tức
  - BR-OFR-005: Buyer có thể withdraw trước khi seller phản hồi
