name: QualityCheck
display_name: Quality Check / Kiểm tra chất lượng
description: |
  Ghi nhận kiểm tra chất lượng tại các checkpoint:
  - Farm (trước khi giao)
  - Lò mổ (sau giết mổ)
  - Shipper (khi lấy/giao)
  - Hub (khi nhận/trả)
  - Buyer (khi nhận hàng)

domain: agriculture
category: quality

attributes:
  - name: id
    type: uuid
    required: true

  - name: order_id
    type: uuid
    required: true

  - name: checkpoint
    type: enum
    required: true
    validation:
      values: [farm, slaughterhouse, shipper_pickup, hub_receive, hub_release, shipper_delivery, buyer_receive]

  - name: checked_by_id
    type: uuid
    required: true
    description: Người kiểm tra

  - name: checked_by_role
    type: enum
    required: true
    validation:
      values: [farmer, slaughterhouse_staff, shipper, hub_staff, buyer]

  - name: weight_kg
    type: decimal
    required: false
    description: Cân nặng tại checkpoint

  - name: quantity
    type: integer
    required: false
    description: Số lượng (con)

  - name: temperature_celsius
    type: decimal
    required: false
    description: Nhiệt độ (nếu là thịt đông lạnh)

  - name: seal_status
    type: enum
    required: false
    validation:
      values: [intact, broken, not_applicable]
    description: Trạng thái seal niêm phong

  - name: visual_condition
    type: enum
    required: true
    validation:
      values: [good, acceptable, poor, rejected]

  - name: water_injection_suspected
    type: boolean
    required: false
    default: false
    description: Nghi ngờ bơm nước

  - name: carcass_ratio
    type: decimal
    required: false
    description: Tỷ lệ móc hàm/hơi (%) - chỉ ở slaughterhouse

  - name: photos
    type: array
    required: true
    description: Ảnh chụp
    validation:
      min_items: 1

  - name: notes
    type: text
    required: false

  - name: issues_found
    type: array
    required: false
    description: Vấn đề phát hiện
    example: ["Thiếu 2 con", "Seal bị phá", "Nhiệt độ cao"]

  - name: created_at
    type: timestamp
    required: true

  - name: location
    type: object
    required: false
    description: GPS location
    example:
      lat: 10.9876
      lng: 106.9876

relationships:
  - name: order
    type: belongs_to
    entity: Order
    required: true

  - name: checked_by
    type: belongs_to
    entity: User
    required: true

indexes:
  - [order_id, checkpoint]
  - [checked_by_id]
  - [created_at]

business_rules:
  - BR-QC-001: Chênh lệch weight > 5% so với checkpoint trước = Alert
  - BR-QC-002: carcass_ratio > 85% = Alert bơm nước
  - BR-QC-003: Seal broken không phải tại buyer_receive = Dispute tự động
  - BR-QC-004: Phải có ít nhất 1 ảnh mỗi checkpoint
  - BR-QC-005: GPS location bắt buộc với shipper checkpoints
