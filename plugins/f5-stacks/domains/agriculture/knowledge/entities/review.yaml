name: Review
display_name: Review / Đánh giá
description: |
  Đánh giá sau khi hoàn thành đơn hàng.
  Buyer đánh giá Seller và ngược lại.

domain: agriculture
category: feedback

attributes:
  - name: id
    type: uuid
    required: true

  - name: review_code
    type: string
    required: true
    validation:
      pattern: "^REV-[0-9]{8}-[A-Z0-9]{4}$"

  - name: order_id
    type: uuid
    required: true

  - name: reviewer_id
    type: uuid
    required: true
    description: Người đánh giá

  - name: reviewee_id
    type: uuid
    required: true
    description: Người được đánh giá

  - name: reviewer_role
    type: enum
    required: true
    validation:
      values: [buyer, seller]

  - name: reviewee_role
    type: enum
    required: true
    validation:
      values: [buyer, seller, farm]

  # Ratings (1-5 stars)
  - name: overall_rating
    type: integer
    required: true
    description: Đánh giá tổng thể
    validation:
      min: 1
      max: 5

  - name: quality_rating
    type: integer
    required: false
    description: Đánh giá chất lượng hàng hóa
    validation:
      min: 1
      max: 5

  - name: accuracy_rating
    type: integer
    required: false
    description: Đánh giá độ chính xác mô tả
    validation:
      min: 1
      max: 5

  - name: communication_rating
    type: integer
    required: false
    description: Đánh giá giao tiếp
    validation:
      min: 1
      max: 5

  - name: delivery_rating
    type: integer
    required: false
    description: Đánh giá giao hàng
    validation:
      min: 1
      max: 5

  - name: value_rating
    type: integer
    required: false
    description: Đánh giá giá trị
    validation:
      min: 1
      max: 5

  # Content
  - name: title
    type: string
    required: false
    validation:
      max_length: 100

  - name: comment
    type: text
    required: false
    description: Nhận xét chi tiết
    validation:
      max_length: 1000

  - name: pros
    type: array
    required: false
    description: Điểm tốt
    example: ["Hàng đúng cân", "Giao nhanh", "Seller nhiệt tình"]

  - name: cons
    type: array
    required: false
    description: Điểm chưa tốt
    example: ["Đóng gói chưa kỹ"]

  # Media
  - name: images
    type: array
    required: false
    description: Ảnh đánh giá

  - name: video_url
    type: string
    required: false

  # Tags
  - name: tags
    type: array
    required: false
    description: Tags tự động hoặc chọn
    example: ["chất lượng tốt", "giao hàng nhanh", "seller uy tín"]

  # Order snapshot
  - name: order_amount
    type: decimal
    required: true
    description: Giá trị đơn hàng

  - name: animal_type
    type: enum
    required: true

  - name: quantity
    type: integer
    required: true

  # Status
  - name: status
    type: enum
    required: true
    validation:
      values: [pending, published, hidden, removed]
    default: published

  - name: hidden_reason
    type: string
    required: false

  # Moderation
  - name: flagged
    type: boolean
    required: false
    default: false

  - name: flagged_reason
    type: string
    required: false

  - name: moderated_at
    type: timestamp
    required: false

  - name: moderated_by
    type: uuid
    required: false

  # Reply
  - name: reply
    type: object
    required: false
    description: Phản hồi từ người được đánh giá
    example:
      content: "Cảm ơn bạn đã ủng hộ!"
      replied_at: "2024-12-02T10:00:00Z"

  # Helpfulness
  - name: helpful_count
    type: integer
    required: true
    default: 0
    description: Số người thấy hữu ích

  - name: not_helpful_count
    type: integer
    required: true
    default: 0

  # Verified purchase
  - name: verified_purchase
    type: boolean
    required: true
    default: true
    description: Có thực sự mua hàng không

  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: order
    type: belongs_to
    entity: Order
    required: true

  - name: reviewer
    type: belongs_to
    entity: User
    required: true

  - name: reviewee
    type: belongs_to
    entity: User
    required: true

  - name: farm
    type: belongs_to
    entity: Farm
    required: false

indexes:
  - [review_code]
  - [order_id]
  - [reviewer_id]
  - [reviewee_id]
  - [overall_rating]
  - [status]
  - [created_at]

computed_fields:
  - name: average_rating
    formula: |
      AVG(COALESCE(
        quality_rating,
        accuracy_rating,
        communication_rating,
        delivery_rating,
        value_rating,
        overall_rating
      ))
    description: Điểm trung bình các tiêu chí

  - name: helpfulness_score
    formula: helpful_count / NULLIF(helpful_count + not_helpful_count, 0)
    description: Tỷ lệ helpful

business_rules:
  - BR-REV-001: Review chỉ cho phép sau khi order completed
  - BR-REV-002: Mỗi user chỉ được review 1 lần/order
  - BR-REV-003: Review window = 30 ngày sau completion
  - BR-REV-004: Minimum comment length = 20 ký tự nếu có
  - BR-REV-005: Auto-flag review có từ khóa nhạy cảm
  - BR-REV-006: Buyer review required để được refund (if applicable)
  - BR-REV-007: Reply chỉ 1 lần từ reviewee

# Rating aggregation for Farm/User profile
rating_aggregation:
  farm_metrics:
    - overall_avg: AVG(overall_rating)
    - quality_avg: AVG(quality_rating)
    - accuracy_avg: AVG(accuracy_rating)
    - delivery_avg: AVG(delivery_rating)
    - total_reviews: COUNT(*)
    - positive_percent: COUNT(overall_rating >= 4) / COUNT(*) * 100

  display_rules:
    - min_reviews_to_show: 5
    - show_distribution: true
    - highlight_verified: true

events:
  - name: review.created
    payload: [id, order_id, reviewer_id, overall_rating]
  - name: review.replied
    payload: [id, reviewee_id, reply_content]
  - name: review.flagged
    payload: [id, flagged_reason]
  - name: review.helpful_voted
    payload: [id, voter_id, is_helpful]
