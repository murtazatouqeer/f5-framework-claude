name: Order
display_name: Order / Đơn hàng
description: |
  Đơn hàng mua bán gia súc/gia cầm.
  Tạo từ: Đấu giá thắng, Mua giá cố định, Offer được chấp nhận.

domain: agriculture
category: core

attributes:
  - name: id
    type: uuid
    required: true

  - name: order_code
    type: string
    required: true
    validation:
      pattern: "^ORD-[0-9]{8}-[A-Z0-9]{6}$"
    example: "ORD-20241201-ABC123"

  - name: listing_id
    type: uuid
    required: true

  - name: seller_id
    type: uuid
    required: true
    description: Farm owner

  - name: buyer_id
    type: uuid
    required: true

  - name: order_source
    type: enum
    required: true
    description: Nguồn đơn hàng
    validation:
      values: [auction, fixed_price, offer]

  - name: auction_id
    type: uuid
    required: false

  - name: offer_id
    type: uuid
    required: false

  - name: bid_id
    type: uuid
    required: false

  # Product info (snapshot)
  - name: animal_type
    type: enum
    required: true

  - name: breed
    type: string
    required: true

  - name: quantity
    type: integer
    required: true

  - name: declared_weight_kg
    type: decimal
    required: true
    description: Trọng lượng khai báo từ seller

  - name: actual_weight_kg
    type: decimal
    required: false
    description: Trọng lượng thực tế (cân khi giao)

  - name: price_per_kg
    type: decimal
    required: true

  - name: subtotal
    type: decimal
    required: true
    description: declared_weight_kg * price_per_kg

  - name: platform_fee
    type: decimal
    required: true
    description: Phí sàn

  - name: shipping_fee
    type: decimal
    required: true
    default: 0

  - name: total_amount
    type: decimal
    required: true

  - name: deposit_amount
    type: decimal
    required: true
    description: Tiền đặt cọc (10-20%)

  - name: deposit_status
    type: enum
    required: true
    validation:
      values: [pending, paid, refunded, forfeited]
    default: pending

  - name: final_amount
    type: decimal
    required: false
    description: Số tiền cuối cùng (sau khi cân thực tế)

  # Status
  - name: status
    type: enum
    required: true
    validation:
      values: [
        pending_deposit,
        deposit_paid,
        confirmed,
        processing,
        ready_for_pickup,
        in_transit,
        at_hub,
        delivered,
        completed,
        cancelled,
        disputed
      ]
    default: pending_deposit

  - name: payment_status
    type: enum
    required: true
    validation:
      values: [pending, deposit_paid, partially_paid, paid, refunded]
    default: pending

  # Fulfillment
  - name: fulfillment_type
    type: enum
    required: true
    description: Hình thức giao hàng
    validation:
      values: [self_pickup, platform_delivery, third_party]

  - name: slaughterhouse_id
    type: uuid
    required: false
    description: Lò mổ (nếu cần giết mổ)

  - name: hub_id
    type: uuid
    required: false
    description: Hub giao nhận

  - name: shipper_id
    type: uuid
    required: false

  - name: pickup_address
    type: object
    required: true

  - name: delivery_address
    type: object
    required: false

  - name: pickup_date
    type: date
    required: false

  - name: pickup_time_slot
    type: string
    required: false
    example: "08:00-12:00"

  - name: delivered_at
    type: timestamp
    required: false

  # Quality control
  - name: quality_check_status
    type: enum
    required: false
    validation:
      values: [pending, passed, failed, disputed]

  - name: weight_variance_percent
    type: decimal
    required: false
    description: Chênh lệch % giữa khai báo và thực tế

  # Notes
  - name: buyer_note
    type: text
    required: false

  - name: seller_note
    type: text
    required: false

  - name: internal_note
    type: text
    required: false

  # Dispute
  - name: dispute_id
    type: uuid
    required: false

  - name: cancellation_reason
    type: text
    required: false

  - name: cancelled_by
    type: enum
    required: false
    validation:
      values: [buyer, seller, system, admin]

  # Timestamps
  - name: deposit_paid_at
    type: timestamp
    required: false

  - name: confirmed_at
    type: timestamp
    required: false

  - name: completed_at
    type: timestamp
    required: false

  - name: cancelled_at
    type: timestamp
    required: false

  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: listing
    type: belongs_to
    entity: Listing
    required: true

  - name: seller
    type: belongs_to
    entity: User
    required: true

  - name: buyer
    type: belongs_to
    entity: User
    required: true

  - name: auction
    type: belongs_to
    entity: Auction
    required: false

  - name: offer
    type: belongs_to
    entity: Offer
    required: false

  - name: slaughterhouse
    type: belongs_to
    entity: Slaughterhouse
    required: false

  - name: hub
    type: belongs_to
    entity: Hub
    required: false

  - name: shipment
    type: has_one
    entity: Shipment

  - name: payments
    type: has_many
    entity: Payment

  - name: quality_checks
    type: has_many
    entity: QualityCheck

  - name: dispute
    type: has_one
    entity: Dispute

state_machine:
  initial: pending_deposit
  states:
    - name: pending_deposit
      description: Chờ đặt cọc
    - name: deposit_paid
      description: Đã đặt cọc, chờ seller xác nhận
    - name: confirmed
      description: Seller đã xác nhận
    - name: processing
      description: Đang xử lý (chuẩn bị hàng)
    - name: ready_for_pickup
      description: Sẵn sàng giao
    - name: in_transit
      description: Đang vận chuyển
    - name: at_hub
      description: Đang ở Hub
    - name: delivered
      description: Đã giao
    - name: completed
      description: Hoàn thành
    - name: cancelled
      description: Đã hủy
    - name: disputed
      description: Đang tranh chấp
  transitions:
    - from: pending_deposit
      to: deposit_paid
      trigger: pay_deposit
      actions: [record_deposit, notify_seller]
    - from: deposit_paid
      to: confirmed
      trigger: confirm
      actions: [notify_buyer, create_shipment_request]
    - from: confirmed
      to: processing
      trigger: start_processing
    - from: processing
      to: ready_for_pickup
      trigger: mark_ready
      actions: [notify_shipper]
    - from: ready_for_pickup
      to: in_transit
      trigger: pickup
      actions: [record_actual_weight, calculate_final_amount]
    - from: in_transit
      to: at_hub
      trigger: arrive_hub
      conditions: [hub_id_not_null]
    - from: [in_transit, at_hub]
      to: delivered
      trigger: deliver
      actions: [notify_both_parties]
    - from: delivered
      to: completed
      trigger: complete
      conditions: [no_open_dispute, payment_completed]
      actions: [release_payment_to_seller, award_rating]
    - from: [pending_deposit, deposit_paid]
      to: cancelled
      trigger: cancel
      actions: [refund_deposit_if_paid, notify_both]
    - from: any
      to: disputed
      trigger: open_dispute
      actions: [hold_payment, notify_admin]

indexes:
  - [order_code]
  - [seller_id]
  - [buyer_id]
  - [status]
  - [listing_id]
  - [created_at]

business_rules:
  - BR-ORD-001: Deposit = 10-20% total_amount
  - BR-ORD-002: Buyer có 24h để đặt cọc từ lúc thắng auction
  - BR-ORD-003: Seller có 24h để xác nhận sau khi nhận cọc
  - BR-ORD-004: Chênh lệch cân nặng > 5% = Auto alert + Có thể dispute
  - BR-ORD-005: final_amount = actual_weight_kg * price_per_kg
  - BR-ORD-006: Buyer có 2h sau delivery để report vấn đề
  - BR-ORD-007: Auto-complete sau 48h delivery nếu không có dispute
  - BR-ORD-008: Cancelled by buyer sau confirm = Mất cọc
  - BR-ORD-009: Cancelled by seller = Hoàn cọc + Penalty

events:
  - name: order.created
    payload: [id, order_code, seller_id, buyer_id, total_amount]
  - name: order.deposit_paid
    payload: [id, deposit_amount]
  - name: order.confirmed
    payload: [id]
  - name: order.shipped
    payload: [id, shipper_id, actual_weight_kg]
  - name: order.delivered
    payload: [id, delivered_at]
  - name: order.completed
    payload: [id, final_amount]
  - name: order.cancelled
    payload: [id, cancelled_by, reason]
  - name: order.disputed
    payload: [id, dispute_id]
