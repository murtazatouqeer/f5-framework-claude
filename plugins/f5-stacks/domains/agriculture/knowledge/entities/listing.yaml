name: Listing
display_name: Listing / Tin đăng bán
description: |
  Tin đăng bán gia súc/gia cầm trên sàn.
  Hỗ trợ 3 hình thức: Đấu giá, Giá cố định, Cho phép thương lượng.

domain: agriculture
category: core

attributes:
  - name: id
    type: uuid
    required: true

  - name: listing_code
    type: string
    required: true
    description: Mã tin đăng
    validation:
      pattern: "^LST-[0-9]{8}-[A-Z0-9]{6}$"
    example: "LST-20241201-ABC123"

  - name: farm_id
    type: uuid
    required: true

  - name: livestock_id
    type: uuid
    required: true

  - name: title
    type: string
    required: true
    description: Tiêu đề tin đăng
    validation:
      max_length: 200
    example: "Bán 100 con heo thịt giống Duroc 100kg"

  - name: description
    type: text
    required: false
    description: Mô tả chi tiết

  - name: animal_type
    type: enum
    required: true
    validation:
      values: [pig, chicken, duck, cow, buffalo, goat]

  - name: breed
    type: string
    required: true

  - name: quantity
    type: integer
    required: true
    description: Số lượng bán
    validation:
      min: 1

  - name: total_weight_kg
    type: decimal
    required: true
    description: Tổng trọng lượng (kg)

  - name: avg_weight_kg
    type: decimal
    required: true
    description: Trọng lượng trung bình/con

  - name: age_days
    type: integer
    required: true
    description: Số ngày tuổi

  - name: selling_type
    type: enum
    required: true
    description: Hình thức bán
    validation:
      values: [auction, fixed_price, negotiable]

  - name: price_per_kg
    type: decimal
    required: false
    description: Giá/kg (cho fixed_price và negotiable)

  - name: total_price
    type: decimal
    required: false
    description: Tổng giá

  - name: allow_offers
    type: boolean
    required: true
    default: false
    description: Cho phép thương lượng giá

  - name: floor_price_per_kg
    type: decimal
    required: false
    description: Giá sàn (hidden, cho negotiable)

  # Auction specific
  - name: starting_price
    type: decimal
    required: false
    description: Giá khởi điểm (cho auction)

  - name: reserve_price
    type: decimal
    required: false
    description: Giá tối thiểu chấp nhận (hidden)

  - name: bid_increment
    type: decimal
    required: false
    description: Bước giá tối thiểu

  - name: current_price
    type: decimal
    required: false
    description: Giá hiện tại (cao nhất)

  - name: bid_count
    type: integer
    required: false
    default: 0
    description: Số lượt đấu giá

  - name: auction_start_at
    type: timestamp
    required: false
    description: Thời gian bắt đầu đấu giá

  - name: auction_end_at
    type: timestamp
    required: false
    description: Thời gian kết thúc đấu giá

  - name: auto_extend
    type: boolean
    required: false
    default: true
    description: Tự động gia hạn nếu có bid trong 5 phút cuối

  # Status
  - name: status
    type: enum
    required: true
    description: Trạng thái
    validation:
      values: [draft, pending_approval, active, sold, expired, cancelled]
    default: draft

  - name: visibility
    type: enum
    required: true
    validation:
      values: [public, private, unlisted]
    default: public

  # Location
  - name: pickup_location
    type: object
    required: true
    description: Địa điểm lấy hàng
    example:
      province: "Đồng Nai"
      district: "Trảng Bom"
      address: "Trang trại ABC"

  # Media
  - name: images
    type: array
    required: true
    description: Hình ảnh (tối thiểu 3)
    validation:
      min_items: 3
      max_items: 10

  - name: video_url
    type: string
    required: false
    description: Video (khuyến khích)

  # Quality info
  - name: certifications
    type: array
    required: false
    description: Chứng nhận áp dụng

  - name: feed_type
    type: enum
    required: true
    validation:
      values: [industrial, organic, mixed, natural]

  - name: veterinary_cert
    type: string
    required: false
    description: Giấy kiểm dịch

  # Stats
  - name: view_count
    type: integer
    required: true
    default: 0

  - name: offer_count
    type: integer
    required: true
    default: 0

  - name: favorite_count
    type: integer
    required: true
    default: 0

  # Timestamps
  - name: published_at
    type: timestamp
    required: false

  - name: sold_at
    type: timestamp
    required: false

  - name: expires_at
    type: timestamp
    required: false
    description: Ngày hết hạn đăng

  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: farm
    type: belongs_to
    entity: Farm
    required: true

  - name: livestock
    type: belongs_to
    entity: Livestock
    required: true

  - name: bids
    type: has_many
    entity: Bid

  - name: offers
    type: has_many
    entity: Offer

  - name: orders
    type: has_many
    entity: Order

state_machine:
  initial: draft
  states:
    - name: draft
      description: Nháp, chưa đăng
    - name: pending_approval
      description: Chờ admin duyệt
    - name: active
      description: Đang bán
    - name: sold
      description: Đã bán hết
    - name: expired
      description: Hết hạn đăng
    - name: cancelled
      description: Đã hủy
  transitions:
    - from: draft
      to: pending_approval
      trigger: submit
      conditions: [has_minimum_images, has_valid_price]
    - from: pending_approval
      to: active
      trigger: approve
      actions: [set_published_at, notify_seller]
    - from: pending_approval
      to: draft
      trigger: reject
      actions: [notify_seller_rejection]
    - from: active
      to: sold
      trigger: complete_sale
      conditions: [has_winning_bid_or_order]
    - from: active
      to: expired
      trigger: expire
      conditions: [past_expiry_date]
    - from: active
      to: cancelled
      trigger: cancel
      actions: [cancel_all_bids, notify_bidders]

indexes:
  - [listing_code]
  - [farm_id]
  - [status]
  - [animal_type]
  - [selling_type]
  - [pickup_location.province]
  - [auction_end_at]
  - [price_per_kg]

business_rules:
  - BR-LST-001: Phải có ít nhất 3 ảnh rõ ràng
  - BR-LST-002: Auction phải có starting_price và bid_increment
  - BR-LST-003: floor_price không được hiển thị cho buyer
  - BR-LST-004: Auto-extend 5 phút nếu có bid trong 5 phút cuối
  - BR-LST-005: Listing hết hạn sau 30 ngày nếu không bán được
  - BR-LST-006: Không được sửa giá sau khi có bid/offer
  - BR-LST-007: Tối đa 10 listing active/farm

events:
  - name: listing.created
    payload: [id, listing_code, farm_id, animal_type]
  - name: listing.published
    payload: [id, listing_code]
  - name: listing.bid_placed
    payload: [id, bid_id, current_price]
  - name: listing.sold
    payload: [id, order_id, final_price]
  - name: listing.expired
    payload: [id]
