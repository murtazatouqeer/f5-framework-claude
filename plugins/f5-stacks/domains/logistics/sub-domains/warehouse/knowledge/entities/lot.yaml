name: Lot
display_name: Lot / Batch
description: |
  Lot/batch tracking for inventory traceability.
  Supports expiry management and recall tracking.

domain: logistics
subdomain: warehouse
category: core

attributes:
  - name: id
    type: uuid
    required: true

  - name: lot_number
    type: string
    required: true
    validation:
      max_length: 50

  - name: item_id
    type: uuid
    required: true

  - name: status
    type: enum
    required: true
    validation:
      values: [active, expired, recalled, consumed, quarantined]
    default: active

  # Dates
  - name: manufacture_date
    type: date
    required: false

  - name: expiry_date
    type: date
    required: false

  - name: received_date
    type: date
    required: true

  - name: best_before_date
    type: date
    required: false

  # Quantities
  - name: quantity_received
    type: integer
    required: true

  - name: quantity_on_hand
    type: integer
    required: true
    default: 0

  - name: quantity_consumed
    type: integer
    required: true
    default: 0

  # Origin
  - name: supplier_id
    type: uuid
    required: false

  - name: supplier_lot_number
    type: string
    required: false

  - name: country_of_origin
    type: string
    required: false

  - name: inbound_order_id
    type: uuid
    required: false

  # Quality
  - name: quality_status
    type: enum
    required: true
    validation:
      values: [pending_qa, approved, rejected, conditional]
    default: pending_qa

  - name: qa_notes
    type: text
    required: false

  - name: certificate_of_analysis
    type: string
    required: false
    description: URL to COA document

  # Recall
  - name: recall_id
    type: uuid
    required: false

  - name: recall_date
    type: date
    required: false

  - name: recall_reason
    type: text
    required: false

  # Cost
  - name: unit_cost
    type: decimal
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: item
    type: belongs_to
    entity: Item
    required: true

  - name: supplier
    type: belongs_to
    entity: Supplier
    required: false

  - name: inbound_order
    type: belongs_to
    entity: InboundOrder
    required: false

  - name: inventory
    type: has_many
    entity: Inventory

indexes:
  - [item_id, lot_number]
  - [expiry_date]
  - [status]
  - [supplier_id]

computed_fields:
  - name: days_until_expiry
    formula: expiry_date - today()
  - name: is_expired
    formula: expiry_date < today()
  - name: remaining_life_percent
    formula: (days_until_expiry / shelf_life_days) * 100

business_rules:
  - BR-LOT-001: Lot number must be unique per item
  - BR-LOT-002: Expired lots cannot be allocated
  - BR-LOT-003: Recalled lots must be quarantined immediately
  - BR-LOT-004: FEFO items must use expiry_date for allocation
