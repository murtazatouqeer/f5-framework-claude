name: Shipment
display_name: Shipment
description: |
  Record of goods shipped from the warehouse.
  Tracks carrier, tracking, and delivery status.

domain: logistics
subdomain: warehouse
category: core

attributes:
  - name: id
    type: uuid
    required: true

  - name: shipment_number
    type: string
    required: true
    validation:
      pattern: "^SHP-[0-9]{8}-[0-9]{3}$"
    example: "SHP-20241201-001"

  - name: outbound_order_id
    type: uuid
    required: true

  - name: warehouse_id
    type: uuid
    required: true

  - name: status
    type: enum
    required: true
    validation:
      values: [created, ready_for_pickup, picked_up, in_transit, out_for_delivery, delivered, returned, exception]
    default: created

  # Carrier
  - name: carrier_id
    type: uuid
    required: true

  - name: carrier_name
    type: string
    required: true
    example: "FedEx"

  - name: carrier_service
    type: string
    required: true
    example: "Ground"

  - name: tracking_number
    type: string
    required: true

  - name: master_tracking
    type: string
    required: false
    description: Master tracking for multi-piece shipments

  - name: pro_number
    type: string
    required: false
    description: PRO number for freight shipments

  # Ship To
  - name: ship_to_name
    type: string
    required: true

  - name: ship_to_company
    type: string
    required: false

  - name: ship_to_address
    type: object
    required: true
    example:
      line1: "123 Main St"
      line2: "Suite 100"
      city: "New York"
      state: "NY"
      country: "US"
      postal_code: "10001"

  - name: ship_to_phone
    type: string
    required: false

  - name: ship_to_email
    type: string
    required: false

  # Ship From
  - name: ship_from_address
    type: object
    required: true

  # Package Details
  - name: packages
    type: array
    required: true
    description: Individual packages in shipment
    example:
      - package_id: "PKG-001"
        tracking_number: "1Z999AA10123456784"
        weight_kg: 2.5
        dimensions:
          length_cm: 30
          width_cm: 20
          height_cm: 15
        package_type: "box"

  - name: total_packages
    type: integer
    required: true
    default: 1

  - name: total_weight_kg
    type: decimal
    required: true

  - name: total_volume_cbm
    type: decimal
    required: false

  # Shipping Cost
  - name: shipping_cost
    type: decimal
    required: false

  - name: insurance_value
    type: decimal
    required: false

  - name: declared_value
    type: decimal
    required: false

  # Special Services
  - name: signature_required
    type: boolean
    required: true
    default: false

  - name: adult_signature
    type: boolean
    required: true
    default: false

  - name: saturday_delivery
    type: boolean
    required: true
    default: false

  - name: hold_at_location
    type: boolean
    required: true
    default: false

  - name: residential
    type: boolean
    required: true
    default: true

  # Hazmat
  - name: contains_hazmat
    type: boolean
    required: true
    default: false

  - name: hazmat_class
    type: string
    required: false

  # International
  - name: international
    type: boolean
    required: true
    default: false

  - name: customs_value
    type: decimal
    required: false

  - name: customs_description
    type: text
    required: false

  - name: hs_code
    type: string
    required: false

  - name: commercial_invoice_number
    type: string
    required: false

  # Pickup
  - name: pickup_scheduled
    type: boolean
    required: true
    default: false

  - name: pickup_date
    type: date
    required: false

  - name: pickup_time_window
    type: string
    required: false
    example: "10:00-14:00"

  - name: dock_door
    type: string
    required: false

  # Tracking Events
  - name: shipped_at
    type: timestamp
    required: false

  - name: picked_up_at
    type: timestamp
    required: false

  - name: delivered_at
    type: timestamp
    required: false

  - name: delivery_signature
    type: string
    required: false

  # Estimated Delivery
  - name: estimated_delivery_date
    type: date
    required: false

  - name: delivery_window
    type: string
    required: false

  # Returns
  - name: return_label_created
    type: boolean
    required: true
    default: false

  - name: return_tracking
    type: string
    required: false

  # Documents
  - name: label_url
    type: string
    required: false

  - name: packing_slip_url
    type: string
    required: false

  - name: commercial_invoice_url
    type: string
    required: false

  - name: pod_url
    type: string
    required: false
    description: Proof of delivery document

  # Notes
  - name: notes
    type: text
    required: false

  - name: delivery_instructions
    type: text
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: outbound_order
    type: belongs_to
    entity: OutboundOrder
    required: true

  - name: warehouse
    type: belongs_to
    entity: Warehouse
    required: true

  - name: carrier
    type: belongs_to
    entity: Carrier
    required: true

indexes:
  - [shipment_number]
  - [tracking_number]
  - [outbound_order_id]
  - [warehouse_id, status]
  - [carrier_id, shipped_at]
  - [estimated_delivery_date]

computed_fields:
  - name: transit_days
    formula: delivered_at - shipped_at
  - name: on_time_delivery
    formula: delivered_at <= estimated_delivery_date

state_machine:
  initial: created
  states:
    - name: created
      description: Shipment record created
    - name: ready_for_pickup
      description: Packed and waiting for carrier
    - name: picked_up
      description: Carrier has picked up
    - name: in_transit
      description: In carrier network
    - name: out_for_delivery
      description: On delivery vehicle
    - name: delivered
      description: Successfully delivered
    - name: returned
      description: Returned to sender
    - name: exception
      description: Delivery exception
  transitions:
    - from: created
      to: ready_for_pickup
      trigger: complete_packing
    - from: ready_for_pickup
      to: picked_up
      trigger: carrier_pickup
      actions: [send_tracking_notification]
    - from: picked_up
      to: in_transit
      trigger: depart_origin
    - from: in_transit
      to: out_for_delivery
      trigger: arrive_destination
    - from: out_for_delivery
      to: delivered
      trigger: deliver
      actions: [capture_pod, send_delivery_notification]
    - from: [in_transit, out_for_delivery]
      to: exception
      trigger: exception
    - from: exception
      to: returned
      trigger: return_to_sender

business_rules:
  - BR-SHP-001: Tracking number must be unique per carrier
  - BR-SHP-002: Hazmat shipments require special carrier service
  - BR-SHP-003: International shipments require customs documentation
  - BR-SHP-004: High-value shipments require signature

events:
  - name: shipment.created
    payload: [id, outbound_order_id, tracking_number]
  - name: shipment.picked_up
    payload: [id, carrier_name, tracking_number]
  - name: shipment.delivered
    payload: [id, delivered_at, delivery_signature]
  - name: shipment.exception
    payload: [id, exception_reason]
