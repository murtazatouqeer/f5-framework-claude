name: DeliveryNotification
display_name: Delivery Notification
description: |
  Communication records for delivery updates.
  Tracks SMS, push notifications, emails, and other messages.

domain: logistics
subdomain: last-mile
category: entities
version: "1.0.0"
status: active

database:
  table_name: delivery_notifications
  primary_key: id
  indexes:
    - columns: [delivery_id]
    - columns: [recipient_id]
    - columns: [notification_type]
    - columns: [channel]
    - columns: [status]
    - columns: [sent_at]

attributes:
  # Identifiers
  - name: id
    type: uuid
    required: true
    generated: true

  - name: delivery_id
    type: uuid
    description: Related delivery
    required: true

  - name: recipient_id
    type: uuid
    description: Notification recipient

  # Notification type
  - name: notification_type
    type: enum
    description: Type of notification
    values:
      - order_confirmed
      - dispatched
      - out_for_delivery
      - arriving_soon
      - agent_nearby
      - delivered
      - delivery_failed
      - rescheduled
      - return_initiated
      - otp_code
      - pickup_reminder
      - locker_code
      - rating_request
      - survey
      - promotion
    required: true

  - name: trigger_event
    type: string
    description: Event that triggered notification
    max_length: 50

  # Channel
  - name: channel
    type: enum
    description: Delivery channel
    values:
      - sms
      - push
      - email
      - whatsapp
      - in_app
      - voice_call
    required: true

  # Recipient info
  - name: recipient_phone
    type: string
    description: Phone if SMS/WhatsApp/call

  - name: recipient_email
    type: string
    description: Email if email channel

  - name: device_token
    type: string
    description: Push token if push notification

  # Content
  - name: template_id
    type: string
    description: Template used
    max_length: 50

  - name: language
    type: string
    description: Message language
    default: "vi"

  - name: subject
    type: string
    description: Email subject or notification title
    max_length: 200

  - name: message_body
    type: text
    description: Full message content
    max_length: 2000

  - name: short_message
    type: string
    description: Short version for SMS/push
    max_length: 160

  # Personalization
  - name: template_data
    type: object
    description: Data used in template
    properties:
      recipient_name:
        type: string
      tracking_number:
        type: string
      agent_name:
        type: string
      agent_phone:
        type: string
      eta:
        type: string
      otp_code:
        type: string
      locker_code:
        type: string
      pickup_point:
        type: string
      delivery_address:
        type: string

  # Links
  - name: tracking_link
    type: string
    description: Tracking URL
    format: uri

  - name: action_link
    type: string
    description: Action URL (reschedule, etc.)
    format: uri

  - name: unsubscribe_link
    type: string
    description: Unsubscribe URL
    format: uri

  # Status
  - name: status
    type: enum
    description: Notification status
    values:
      - pending
      - queued
      - sent
      - delivered
      - failed
      - bounced
      - opened
      - clicked
    default: pending

  # Timing
  - name: scheduled_at
    type: timestamp
    description: When to send

  - name: sent_at
    type: timestamp
    description: When actually sent

  - name: delivered_at
    type: timestamp
    description: Delivery confirmation

  - name: opened_at
    type: timestamp
    description: When opened (email/push)

  - name: clicked_at
    type: timestamp
    description: When link clicked

  # Provider
  - name: provider
    type: string
    description: Notification provider
    max_length: 50
    example: "Twilio"

  - name: provider_message_id
    type: string
    description: Provider's message ID

  - name: provider_status
    type: string
    description: Status from provider

  - name: provider_response
    type: object
    description: Full provider response

  # Error handling
  - name: error_code
    type: string
    description: Error code if failed

  - name: error_message
    type: text
    description: Error details

  - name: retry_count
    type: integer
    description: Number of retries
    default: 0

  - name: max_retries
    type: integer
    description: Maximum retries
    default: 3

  - name: next_retry_at
    type: timestamp
    description: Next retry time

  # Cost
  - name: cost
    type: decimal
    description: Cost of sending
    precision: 8
    scale: 4

  - name: cost_currency
    type: string
    description: Cost currency
    default: "VND"

  # Metrics
  - name: segments
    type: integer
    description: SMS segments used
    default: 1

  - name: characters
    type: integer
    description: Character count

  # Priority
  - name: priority
    type: enum
    description: Sending priority
    values:
      - low
      - normal
      - high
      - critical
    default: normal

  - name: is_transactional
    type: boolean
    description: Transactional vs marketing
    default: true

  # User interaction
  - name: user_responded
    type: boolean
    description: User responded to notification
    default: false

  - name: user_response
    type: text
    description: User's response content
    max_length: 500

  # Audit
  - name: created_at
    type: timestamp
    required: true
    auto_generate: true

  - name: updated_at
    type: timestamp
    auto_update: true

relationships:
  - name: delivery
    type: belongs_to
    entity: Delivery
    foreign_key: delivery_id

  - name: recipient
    type: belongs_to
    entity: Recipient
    foreign_key: recipient_id

business_rules:
  - rule: BR-NOT-001
    description: OTP notifications must be high priority
    validation: notification_type != 'otp_code' OR priority = 'critical'

  - rule: BR-NOT-002
    description: Check recipient notification preferences
    validation: recipient.{channel}_notifications = true

events:
  - name: notification.sent
    description: Notification was sent
    payload: [notification_id, channel, status]

  - name: notification.delivered
    description: Notification was delivered
    payload: [notification_id]

  - name: notification.failed
    description: Notification failed
    payload: [notification_id, error_code, error_message]

  - name: notification.opened
    description: Notification was opened
    payload: [notification_id, opened_at]
