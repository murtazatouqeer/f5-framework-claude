name: Parcel
display_name: Parcel
description: |
  Individual package or item being delivered.
  Tracks dimensions, contents, handling requirements, and scan history.

domain: logistics
subdomain: last-mile
category: entities
version: "1.0.0"
status: active

database:
  table_name: parcels
  primary_key: id
  indexes:
    - columns: [parcel_id]
      unique: true
    - columns: [barcode]
      unique: true
    - columns: [delivery_id]
    - columns: [status]
    - columns: [shipment_id]

attributes:
  # Identifiers
  - name: id
    type: uuid
    description: Internal unique identifier
    required: true
    generated: true

  - name: parcel_id
    type: string
    description: Human-readable parcel ID
    pattern: "PCL-[A-Z0-9]{10}"
    example: "PCL-A1B2C3D4E5"
    required: true
    unique: true

  - name: barcode
    type: string
    description: Scannable barcode
    max_length: 30
    required: true
    unique: true

  - name: qr_code
    type: string
    description: QR code data

  # References
  - name: delivery_id
    type: uuid
    description: Associated delivery

  - name: shipment_id
    type: uuid
    description: Source shipment from warehouse

  - name: order_id
    type: uuid
    description: Source order

  - name: order_item_id
    type: uuid
    description: Specific order item

  # Status
  - name: status
    type: enum
    description: Current parcel status
    values:
      - created
      - at_warehouse
      - at_hub
      - in_transit
      - out_for_delivery
      - delivered
      - returned
      - lost
      - damaged
    default: created
    required: true

  # Dimensions
  - name: length_cm
    type: decimal
    description: Length in centimeters
    precision: 6
    scale: 2

  - name: width_cm
    type: decimal
    description: Width in centimeters
    precision: 6
    scale: 2

  - name: height_cm
    type: decimal
    description: Height in centimeters
    precision: 6
    scale: 2

  - name: weight_kg
    type: decimal
    description: Actual weight in kilograms
    precision: 8
    scale: 3
    required: true

  - name: volumetric_weight_kg
    type: decimal
    description: Volumetric weight
    precision: 8
    scale: 3
    computed: "(length_cm * width_cm * height_cm) / 5000"

  - name: chargeable_weight_kg
    type: decimal
    description: Weight used for pricing
    precision: 8
    scale: 3
    computed: "MAX(weight_kg, volumetric_weight_kg)"

  - name: size_category
    type: enum
    description: Size classification
    values:
      - envelope
      - small
      - medium
      - large
      - extra_large
      - oversized

  # Contents
  - name: description
    type: string
    description: Content description
    max_length: 500

  - name: item_category
    type: enum
    description: Category of contents
    values:
      - general
      - electronics
      - documents
      - clothing
      - food
      - fragile
      - hazardous
      - medical
      - livestock_products
      - agricultural

  - name: quantity
    type: integer
    description: Number of items inside
    default: 1

  - name: declared_value
    type: decimal
    description: Declared value of contents
    precision: 12
    scale: 2

  - name: currency
    type: string
    description: Currency of declared value
    default: "VND"

  # Handling requirements
  - name: is_fragile
    type: boolean
    description: Requires careful handling
    default: false

  - name: is_hazardous
    type: boolean
    description: Contains hazardous materials
    default: false

  - name: hazmat_class
    type: string
    description: Hazmat classification if applicable

  - name: temperature_sensitive
    type: boolean
    description: Requires temperature control
    default: false

  - name: min_temperature_c
    type: decimal
    description: Minimum temperature requirement
    precision: 4
    scale: 1

  - name: max_temperature_c
    type: decimal
    description: Maximum temperature requirement
    precision: 4
    scale: 1

  - name: orientation_sensitive
    type: boolean
    description: Must stay upright
    default: false

  - name: stacking_allowed
    type: boolean
    description: Can be stacked upon
    default: true

  # Packaging
  - name: package_type
    type: enum
    description: Type of packaging
    values:
      - box
      - envelope
      - bag
      - tube
      - crate
      - pallet
      - custom

  - name: packaging_material
    type: string
    description: Material used for packaging

  - name: sealed
    type: boolean
    description: Package is sealed
    default: true

  # Insurance
  - name: is_insured
    type: boolean
    description: Parcel is insured
    default: false

  - name: insurance_value
    type: decimal
    description: Insurance coverage amount
    precision: 12
    scale: 2

  - name: insurance_policy_number
    type: string
    description: Insurance policy reference

  # Tracking
  - name: current_location
    type: object
    description: Current known location
    properties:
      location_type:
        type: enum
        values: [warehouse, hub, vehicle, delivered]
      location_id:
        type: uuid
      lat:
        type: decimal
      lng:
        type: decimal
      updated_at:
        type: timestamp

  - name: scan_history
    type: array
    description: History of all scans
    items:
      type: object
      properties:
        timestamp:
          type: timestamp
        event:
          type: enum
          values: [received, sorted, loaded, unloaded, out_for_delivery, delivered, returned, exception]
        location:
          type: string
        location_id:
          type: uuid
        scanned_by:
          type: uuid
        notes:
          type: string

  # Condition
  - name: condition_at_pickup
    type: enum
    description: Condition when picked up
    values:
      - good
      - minor_damage
      - damaged
      - opened

  - name: condition_notes
    type: text
    description: Notes about condition

  - name: damage_photos
    type: array
    description: Photos of any damage
    items:
      type: string
      format: uri

  # Labels
  - name: label_url
    type: string
    description: Shipping label URL
    format: uri

  - name: label_printed
    type: boolean
    description: Label has been printed
    default: false

  # Audit
  - name: created_at
    type: timestamp
    required: true
    auto_generate: true

  - name: updated_at
    type: timestamp
    auto_update: true

relationships:
  - name: delivery
    type: belongs_to
    entity: Delivery
    foreign_key: delivery_id

  - name: shipment
    type: belongs_to
    entity: Shipment
    foreign_key: shipment_id

  - name: order
    type: belongs_to
    entity: Order
    foreign_key: order_id

state_machine:
  initial: created
  states:
    - name: created
      description: Parcel record created
    - name: at_warehouse
      description: At origin warehouse
    - name: at_hub
      description: At delivery hub
    - name: in_transit
      description: Being transported
    - name: out_for_delivery
      description: With delivery agent
    - name: delivered
      description: Successfully delivered
    - name: returned
      description: Returned to sender
    - name: lost
      description: Cannot be located
    - name: damaged
      description: Damaged beyond delivery

  transitions:
    - from: created
      to: at_warehouse
      event: receive_at_warehouse

    - from: at_warehouse
      to: in_transit
      event: ship_out

    - from: in_transit
      to: at_hub
      event: receive_at_hub

    - from: at_hub
      to: out_for_delivery
      event: dispatch

    - from: out_for_delivery
      to: delivered
      event: deliver

    - from: out_for_delivery
      to: at_hub
      event: return_to_hub

    - from: at_hub
      to: returned
      event: return_to_sender

    - from: [at_warehouse, at_hub, in_transit, out_for_delivery]
      to: lost
      event: mark_lost

    - from: [at_warehouse, at_hub, in_transit, out_for_delivery]
      to: damaged
      event: mark_damaged

events:
  - name: parcel.scanned
    description: Parcel was scanned
    payload: [parcel_id, event, location]

  - name: parcel.delivered
    description: Parcel delivered
    payload: [parcel_id, delivery_id]

  - name: parcel.exception
    description: Exception occurred
    payload: [parcel_id, exception_type]
