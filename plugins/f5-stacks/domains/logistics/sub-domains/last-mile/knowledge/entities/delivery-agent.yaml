name: DeliveryAgent
display_name: Delivery Agent
description: |
  Delivery personnel responsible for last-mile deliveries.
  Includes riders, drivers, and crowdsourced delivery partners.
  Tracks availability, performance, earnings, and compliance.

domain: logistics
subdomain: last-mile
category: entities
version: "1.0.0"
status: active

database:
  table_name: delivery_agents
  primary_key: id
  indexes:
    - columns: [agent_id]
      unique: true
    - columns: [phone]
      unique: true
    - columns: [status]
    - columns: [home_zone_id]
    - columns: [agent_type]
    - columns: [is_online]

attributes:
  # Primary identifiers
  - name: id
    type: uuid
    description: Internal unique identifier
    required: true
    generated: true

  - name: agent_id
    type: string
    description: Human-readable agent ID
    pattern: "AGT-[A-Z0-9]{4}"
    example: "AGT-1234"
    required: true
    unique: true

  - name: employee_id
    type: string
    description: HR employee ID if applicable
    unique: true

  # Agent type
  - name: agent_type
    type: enum
    description: Type of delivery agent
    values:
      - employee
      - contractor
      - gig_worker
      - crowd_sourced
    default: gig_worker
    required: true

  - name: status
    type: enum
    description: Agent account status
    values:
      - pending_verification
      - active
      - suspended
      - inactive
      - terminated
    default: pending_verification
    required: true

  # Personal information
  - name: first_name
    type: string
    description: Agent's first name
    max_length: 50
    required: true

  - name: last_name
    type: string
    description: Agent's last name
    max_length: 50
    required: true

  - name: full_name
    type: string
    description: Full name (computed)
    computed: "first_name || ' ' || last_name"

  - name: date_of_birth
    type: date
    description: Date of birth
    required: true

  - name: gender
    type: enum
    description: Gender
    values:
      - male
      - female
      - other
      - prefer_not_to_say

  - name: phone
    type: string
    description: Primary phone number
    pattern: "^\\+?[0-9]{10,15}$"
    required: true
    unique: true

  - name: email
    type: string
    description: Email address
    format: email

  - name: photo_url
    type: string
    description: Profile photo URL
    format: uri

  - name: address
    type: object
    description: Home address
    properties:
      address_line1:
        type: string
      address_line2:
        type: string
      city:
        type: string
      state:
        type: string
      postal_code:
        type: string
      country:
        type: string

  - name: emergency_contact
    type: object
    description: Emergency contact information
    properties:
      name:
        type: string
      relationship:
        type: string
      phone:
        type: string

  # Vehicle information
  - name: vehicle_type
    type: enum
    description: Type of vehicle used
    values:
      - foot
      - bicycle
      - motorcycle
      - scooter
      - car
      - van
    required: true

  - name: vehicle_number
    type: string
    description: Vehicle registration number
    max_length: 20

  - name: vehicle_make
    type: string
    description: Vehicle manufacturer

  - name: vehicle_model
    type: string
    description: Vehicle model

  - name: vehicle_year
    type: integer
    description: Vehicle year

  - name: vehicle_color
    type: string
    description: Vehicle color

  # Capacity
  - name: max_capacity_kg
    type: decimal
    description: Maximum carrying capacity in kg
    precision: 6
    scale: 2

  - name: max_parcels
    type: integer
    description: Maximum number of parcels
    default: 20

  - name: max_volume_cbm
    type: decimal
    description: Maximum carrying volume
    precision: 6
    scale: 3

  # Zone assignment
  - name: assigned_zone_ids
    type: array
    description: Zones agent can deliver in
    items:
      type: uuid

  - name: home_zone_id
    type: uuid
    description: Primary/home zone

  # Availability
  - name: is_online
    type: boolean
    description: Agent currently online
    default: false

  - name: shift_start
    type: time
    description: Scheduled shift start time

  - name: shift_end
    type: time
    description: Scheduled shift end time

  - name: break_start
    type: time
    description: Break period start

  - name: break_end
    type: time
    description: Break period end

  # Current location
  - name: current_location
    type: object
    description: Real-time location
    properties:
      lat:
        type: decimal
        precision: 10
        scale: 8
      lng:
        type: decimal
        precision: 11
        scale: 8
      accuracy_m:
        type: integer
      speed_kmh:
        type: decimal
      heading:
        type: integer

  - name: last_location_update
    type: timestamp
    description: Last location update time

  - name: battery_level
    type: integer
    description: Phone battery percentage
    minimum: 0
    maximum: 100

  # Current work
  - name: current_delivery_id
    type: uuid
    description: Current active delivery

  - name: active_deliveries
    type: array
    description: List of assigned delivery IDs
    items:
      type: uuid

  - name: active_delivery_count
    type: integer
    description: Count of active deliveries
    default: 0

  - name: next_pickup_location
    type: object
    description: Next pickup point
    properties:
      hub_id:
        type: uuid
      lat:
        type: decimal
      lng:
        type: decimal

  # Performance metrics
  - name: total_deliveries
    type: integer
    description: Total lifetime deliveries
    default: 0

  - name: deliveries_today
    type: integer
    description: Deliveries completed today
    default: 0

  - name: deliveries_this_week
    type: integer
    description: Deliveries this week
    default: 0

  - name: deliveries_this_month
    type: integer
    description: Deliveries this month
    default: 0

  - name: success_rate
    type: decimal
    description: Successful delivery percentage
    precision: 5
    scale: 2
    computed: true

  - name: first_attempt_success_rate
    type: decimal
    description: First attempt success rate
    precision: 5
    scale: 2

  - name: average_delivery_time_minutes
    type: integer
    description: Average time per delivery

  - name: on_time_rate
    type: decimal
    description: On-time delivery percentage
    precision: 5
    scale: 2

  # Ratings
  - name: rating
    type: decimal
    description: Average rating (1-5)
    precision: 3
    scale: 2
    minimum: 1
    maximum: 5

  - name: rating_count
    type: integer
    description: Total ratings received
    default: 0

  # Financial (for gig workers)
  - name: earnings_today
    type: decimal
    description: Today's earnings
    precision: 12
    scale: 2

  - name: earnings_this_week
    type: decimal
    description: This week's earnings
    precision: 12
    scale: 2

  - name: earnings_this_month
    type: decimal
    description: This month's earnings
    precision: 12
    scale: 2

  - name: per_delivery_rate
    type: decimal
    description: Rate per delivery
    precision: 10
    scale: 2

  - name: bonus_rate
    type: decimal
    description: Current bonus multiplier
    precision: 4
    scale: 2
    default: 1.0

  - name: incentive_eligible
    type: boolean
    description: Eligible for incentives
    default: true

  - name: bank_account
    type: object
    description: Bank account for payments
    properties:
      bank_name:
        type: string
      account_number:
        type: string
        encrypted: true
      account_holder:
        type: string

  # Compliance
  - name: background_check_status
    type: enum
    description: Background check result
    values:
      - pending
      - passed
      - failed
      - expired

  - name: background_check_date
    type: date
    description: Date of background check

  - name: training_completed
    type: boolean
    description: Completed required training
    default: false

  - name: training_completion_date
    type: date
    description: Training completion date

  - name: id_verified
    type: boolean
    description: Identity verified
    default: false

  - name: id_document_type
    type: enum
    description: Type of ID document
    values:
      - national_id
      - passport
      - driving_license

  - name: id_document_number
    type: string
    description: ID document number
    encrypted: true

  - name: vehicle_verified
    type: boolean
    description: Vehicle documents verified
    default: false

  - name: license_verified
    type: boolean
    description: Driving license verified
    default: false

  - name: license_number
    type: string
    description: Driving license number

  - name: license_expiry
    type: date
    description: License expiry date

  # App settings
  - name: device_id
    type: string
    description: Registered device ID

  - name: app_version
    type: string
    description: Current app version

  - name: push_token
    type: string
    description: Push notification token

  - name: language_preference
    type: string
    description: Preferred language
    default: "vi"

  # Audit
  - name: onboarded_at
    type: timestamp
    description: When agent was onboarded

  - name: last_active_at
    type: timestamp
    description: Last activity timestamp

  - name: created_at
    type: timestamp
    description: Record creation timestamp
    required: true
    auto_generate: true

  - name: updated_at
    type: timestamp
    description: Last update timestamp
    auto_update: true

relationships:
  - name: zones
    type: has_many_through
    entity: DeliveryZone
    through: assigned_zone_ids
    description: Assigned delivery zones

  - name: home_zone
    type: belongs_to
    entity: DeliveryZone
    foreign_key: home_zone_id
    description: Primary zone

  - name: deliveries
    type: has_many
    entity: Delivery
    foreign_key: delivery_agent_id
    description: All deliveries

  - name: active_deliveries_list
    type: has_many
    entity: Delivery
    foreign_key: delivery_agent_id
    conditions:
      status: [assigned, out_for_delivery, arrived]
    description: Current active deliveries

  - name: ratings
    type: has_many
    entity: RatingFeedback
    foreign_key: delivery_agent_id
    description: Ratings received

state_machine:
  initial: pending_verification
  states:
    - name: pending_verification
      description: Awaiting verification

    - name: active
      description: Active and can receive assignments

    - name: suspended
      description: Temporarily suspended

    - name: inactive
      description: Voluntarily inactive

    - name: terminated
      description: Permanently terminated

  transitions:
    - from: pending_verification
      to: active
      event: verify
      conditions:
        - id_verified = true
        - background_check_status = 'passed'
        - training_completed = true

    - from: active
      to: suspended
      event: suspend
      actions:
        - unassign_active_deliveries

    - from: suspended
      to: active
      event: reactivate

    - from: active
      to: inactive
      event: deactivate

    - from: inactive
      to: active
      event: reactivate

    - from: [active, suspended, inactive]
      to: terminated
      event: terminate
      actions:
        - unassign_active_deliveries
        - revoke_app_access

business_rules:
  - rule: BR-AGT-001
    description: Agent must be verified before going online
    validation: status = 'active' OR is_online = false

  - rule: BR-AGT-002
    description: Cannot exceed max active deliveries
    validation: active_delivery_count <= max_parcels

  - rule: BR-AGT-003
    description: License required for motorized vehicles
    validation: vehicle_type NOT IN ['motorcycle', 'scooter', 'car', 'van'] OR license_verified = true

  - rule: BR-AGT-004
    description: Agent must have at least one assigned zone
    validation: array_length(assigned_zone_ids) > 0

events:
  - name: agent.registered
    description: New agent registered
    payload: [agent_id, agent_type]

  - name: agent.verified
    description: Agent verification completed
    payload: [agent_id]

  - name: agent.online
    description: Agent went online
    payload: [agent_id, zone_id]

  - name: agent.offline
    description: Agent went offline
    payload: [agent_id, last_location]

  - name: agent.location_updated
    description: Location update received
    payload: [agent_id, lat, lng, timestamp]

  - name: agent.delivery_assigned
    description: Delivery assigned to agent
    payload: [agent_id, delivery_id]

  - name: agent.suspended
    description: Agent suspended
    payload: [agent_id, reason]

api_endpoints:
  - method: GET
    path: /agents
    description: List agents with filters
  - method: GET
    path: /agents/{agent_id}
    description: Get agent details
  - method: POST
    path: /agents
    description: Register new agent
  - method: PATCH
    path: /agents/{agent_id}
    description: Update agent
  - method: POST
    path: /agents/{agent_id}/go-online
    description: Set agent online
  - method: POST
    path: /agents/{agent_id}/go-offline
    description: Set agent offline
  - method: POST
    path: /agents/{agent_id}/location
    description: Update location
  - method: GET
    path: /agents/{agent_id}/deliveries
    description: Get agent's deliveries
  - method: GET
    path: /agents/{agent_id}/earnings
    description: Get earnings summary
