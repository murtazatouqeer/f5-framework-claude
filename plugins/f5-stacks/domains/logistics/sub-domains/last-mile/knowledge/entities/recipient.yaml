name: Recipient
display_name: Recipient
description: |
  Profile of delivery recipient (end customer).
  Stores addresses, preferences, and delivery history.

domain: logistics
subdomain: last-mile
category: entities
version: "1.0.0"
status: active

database:
  table_name: recipients
  primary_key: id
  indexes:
    - columns: [customer_id]
      unique: true
    - columns: [phone]
    - columns: [email]
    - columns: [status]

attributes:
  # Identifiers
  - name: id
    type: uuid
    required: true
    generated: true

  - name: customer_id
    type: string
    description: External customer ID
    unique: true

  - name: user_id
    type: uuid
    description: Link to user account

  # Status
  - name: status
    type: enum
    description: Recipient account status
    values:
      - active
      - inactive
      - blacklisted
    default: active

  # Personal info
  - name: name
    type: string
    description: Full name
    max_length: 100
    required: true

  - name: phone
    type: string
    description: Primary phone number
    pattern: "^\\+?[0-9]{10,15}$"
    required: true

  - name: alternate_phone
    type: string
    description: Alternate phone number

  - name: email
    type: string
    description: Email address
    format: email

  - name: language
    type: string
    description: Preferred language
    default: "vi"

  # Addresses
  - name: addresses
    type: array
    description: Saved delivery addresses
    items:
      type: object
      properties:
        id:
          type: uuid
        label:
          type: string
          example: "Home"
        address_type:
          type: enum
          values: [home, work, other]
        address_line1:
          type: string
          required: true
        address_line2:
          type: string
        city:
          type: string
          required: true
        district:
          type: string
        state:
          type: string
        postal_code:
          type: string
        country:
          type: string
          default: "VN"
        lat:
          type: decimal
        lng:
          type: decimal
        plus_code:
          type: string
        delivery_instructions:
          type: text
        access_code:
          type: string
        is_default:
          type: boolean
          default: false
        is_verified:
          type: boolean
          default: false
        zone_id:
          type: uuid

  - name: default_address_id
    type: uuid
    description: Default delivery address

  # Preferences
  - name: preferred_slot
    type: enum
    description: Preferred delivery time
    values:
      - morning
      - afternoon
      - evening
      - any

  - name: safe_place_default
    type: string
    description: Default safe place location
    max_length: 200

  - name: safe_place_authorized
    type: boolean
    description: Authorized safe place delivery
    default: false

  - name: allow_neighbor_delivery
    type: boolean
    description: Allow leaving with neighbor
    default: false

  - name: preferred_neighbors
    type: array
    description: Preferred neighbors for delivery
    items:
      type: object
      properties:
        name:
          type: string
        unit:
          type: string
        phone:
          type: string

  - name: require_signature
    type: boolean
    description: Always require signature
    default: false

  - name: require_otp
    type: boolean
    description: Always require OTP verification
    default: false

  # Notification preferences
  - name: sms_notifications
    type: boolean
    description: Receive SMS notifications
    default: true

  - name: email_notifications
    type: boolean
    description: Receive email notifications
    default: true

  - name: app_notifications
    type: boolean
    description: Receive app push notifications
    default: true

  - name: whatsapp_notifications
    type: boolean
    description: Receive WhatsApp notifications
    default: false

  - name: notification_triggers
    type: array
    description: Which events trigger notifications
    items:
      type: enum
      values:
        - dispatched
        - out_for_delivery
        - arriving_soon
        - delivered
        - failed
        - rescheduled
    default: [dispatched, out_for_delivery, delivered, failed]

  # History
  - name: total_deliveries
    type: integer
    description: Total deliveries received
    default: 0

  - name: successful_deliveries
    type: integer
    description: Successfully received
    default: 0

  - name: failed_deliveries
    type: integer
    description: Failed delivery attempts
    default: 0

  - name: returned_deliveries
    type: integer
    description: Returned packages
    default: 0

  - name: first_delivery_at
    type: timestamp
    description: First delivery date

  - name: last_delivery_at
    type: timestamp
    description: Most recent delivery

  # Ratings
  - name: average_rating_given
    type: decimal
    description: Average rating this recipient gives
    precision: 3
    scale: 2

  - name: ratings_given_count
    type: integer
    description: Number of ratings given
    default: 0

  # Flags
  - name: is_verified
    type: boolean
    description: Phone/email verified
    default: false

  - name: has_locker_access
    type: boolean
    description: Has smart locker access
    default: false

  - name: locker_preferences
    type: array
    description: Preferred locker locations
    items:
      type: uuid

  - name: frequent_not_home
    type: boolean
    description: Frequently not at home
    computed: "failed_deliveries / total_deliveries > 0.3"

  - name: always_available
    type: boolean
    description: Usually available
    computed: "successful_deliveries / total_deliveries > 0.95"

  - name: high_value_customer
    type: boolean
    description: High order value customer
    default: false

  - name: vip_customer
    type: boolean
    description: VIP status
    default: false

  # Blacklist info
  - name: blacklist_reason
    type: text
    description: Reason for blacklisting

  - name: blacklisted_at
    type: timestamp
    description: When blacklisted

  - name: blacklisted_by
    type: uuid
    description: Who blacklisted

  # Special handling
  - name: special_instructions
    type: text
    description: General delivery instructions
    max_length: 500

  - name: access_notes
    type: text
    description: Building access information
    max_length: 500

  # Audit
  - name: created_at
    type: timestamp
    required: true
    auto_generate: true

  - name: updated_at
    type: timestamp
    auto_update: true

relationships:
  - name: user
    type: belongs_to
    entity: User
    foreign_key: user_id

  - name: deliveries
    type: has_many
    entity: Delivery
    foreign_key: recipient_id

  - name: ratings
    type: has_many
    entity: RatingFeedback
    foreign_key: recipient_id

events:
  - name: recipient.created
    description: New recipient created
    payload: [recipient_id]

  - name: recipient.blacklisted
    description: Recipient was blacklisted
    payload: [recipient_id, reason]

  - name: recipient.address_added
    description: New address added
    payload: [recipient_id, address_id]
