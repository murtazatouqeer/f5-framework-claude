name: ProofOfDelivery
display_name: Proof of Delivery
description: |
  Evidence confirming successful delivery to recipient.
  Includes signature, photos, verification codes, and location data.

domain: logistics
subdomain: last-mile
category: entities
version: "1.0.0"
status: active

database:
  table_name: proof_of_deliveries
  primary_key: id
  indexes:
    - columns: [delivery_id]
      unique: true
    - columns: [pod_type]
    - columns: [captured_at]

attributes:
  # Identifiers
  - name: id
    type: uuid
    required: true
    generated: true

  - name: delivery_id
    type: uuid
    description: Reference to delivery
    required: true
    unique: true

  # POD type
  - name: pod_type
    type: enum
    description: Primary proof method
    values:
      - signature
      - photo
      - pin_code
      - otp
      - contactless
      - locker_code
      - biometric
    required: true

  - name: captured_at
    type: timestamp
    description: When POD was captured
    required: true

  # Signature
  - name: signature_captured
    type: boolean
    description: Signature was captured
    default: false

  - name: signature_image_url
    type: string
    description: Signature image URL
    format: uri

  - name: signer_name
    type: string
    description: Name of person who signed
    max_length: 100

  - name: signer_relationship
    type: enum
    description: Relationship to recipient
    values:
      - recipient
      - family_member
      - neighbor
      - colleague
      - receptionist
      - security_guard
      - building_manager
      - other

  - name: signer_relationship_other
    type: string
    description: Description if relationship is other
    max_length: 50

  # Photo evidence
  - name: delivery_photo_url
    type: string
    description: Photo of delivered package
    format: uri

  - name: location_photo_url
    type: string
    description: Photo of delivery location
    format: uri

  - name: package_photo_url
    type: string
    description: Photo of package condition
    format: uri

  - name: photo_count
    type: integer
    description: Number of photos captured
    default: 0

  - name: all_photos
    type: array
    description: All photo URLs
    items:
      type: string
      format: uri

  # Verification
  - name: id_verified
    type: boolean
    description: Recipient ID was verified
    default: false

  - name: id_type
    type: enum
    description: Type of ID presented
    values:
      - national_id
      - passport
      - driving_license
      - employee_id
      - student_id

  - name: id_last_digits
    type: string
    description: Last 4 digits of ID number
    max_length: 4

  - name: id_photo_url
    type: string
    description: Photo of ID (if required)
    format: uri

  - name: age_verified
    type: boolean
    description: Age was verified
    default: false

  - name: verified_age
    type: integer
    description: Verified age of recipient

  # OTP/PIN verification
  - name: otp_verified
    type: boolean
    description: OTP code was verified
    default: false

  - name: otp_code
    type: string
    description: OTP code used
    max_length: 6

  - name: otp_sent_at
    type: timestamp
    description: When OTP was sent

  - name: otp_verified_at
    type: timestamp
    description: When OTP was verified

  - name: pin_verified
    type: boolean
    description: PIN code was verified
    default: false

  - name: pin_attempts
    type: integer
    description: Number of PIN attempts
    default: 0

  # Contactless delivery
  - name: contactless_delivery
    type: boolean
    description: Delivered without contact
    default: false

  - name: safe_place_used
    type: boolean
    description: Left at authorized safe place
    default: false

  - name: safe_place_description
    type: string
    description: Where package was left
    max_length: 200

  - name: recipient_notified
    type: boolean
    description: Recipient was notified
    default: false

  - name: recipient_confirmed
    type: boolean
    description: Recipient confirmed receipt
    default: false

  - name: confirmed_at
    type: timestamp
    description: When recipient confirmed

  # Locker delivery
  - name: locker_id
    type: uuid
    description: Locker used for delivery

  - name: compartment_number
    type: string
    description: Locker compartment

  - name: locker_code
    type: string
    description: Locker pickup code

  - name: locker_code_expires_at
    type: timestamp
    description: Code expiration time

  # Location
  - name: capture_location
    type: object
    description: Where POD was captured
    properties:
      lat:
        type: decimal
        precision: 10
        scale: 8
      lng:
        type: decimal
        precision: 11
        scale: 8
      accuracy_m:
        type: integer

  - name: distance_from_address_m
    type: integer
    description: Distance from delivery address

  - name: location_verified
    type: boolean
    description: Location is within acceptable range
    computed: "distance_from_address_m <= 100"

  # Device information
  - name: device_id
    type: string
    description: Device used for capture

  - name: app_version
    type: string
    description: App version

  - name: device_model
    type: string
    description: Device model

  - name: os_version
    type: string
    description: Operating system version

  # Timestamp verification
  - name: device_timestamp
    type: timestamp
    description: Device local time

  - name: server_timestamp
    type: timestamp
    description: Server time when received

  - name: timestamp_variance_seconds
    type: integer
    description: Difference between device and server time
    computed: "server_timestamp - device_timestamp"

  # Notes
  - name: delivery_notes
    type: text
    description: Notes from delivery agent
    max_length: 500

  - name: recipient_notes
    type: text
    description: Notes from recipient
    max_length: 500

  # Validation
  - name: is_valid
    type: boolean
    description: POD meets all requirements
    default: true

  - name: validation_issues
    type: array
    description: Any validation issues found
    items:
      type: string

  # Audit
  - name: captured_by
    type: uuid
    description: Agent who captured POD
    required: true

  - name: created_at
    type: timestamp
    required: true
    auto_generate: true

  - name: updated_at
    type: timestamp
    auto_update: true

relationships:
  - name: delivery
    type: belongs_to
    entity: Delivery
    foreign_key: delivery_id

  - name: agent
    type: belongs_to
    entity: DeliveryAgent
    foreign_key: captured_by

  - name: locker
    type: belongs_to
    entity: Locker
    foreign_key: locker_id

business_rules:
  - rule: BR-POD-001
    description: Signature required for high-value items
    validation: delivery.requires_signature = false OR signature_captured = true

  - rule: BR-POD-002
    description: Photo required for all deliveries
    validation: delivery_photo_url IS NOT NULL OR pod_type = 'locker_code'

  - rule: BR-POD-003
    description: ID required for restricted items
    validation: delivery.requires_id_verification = false OR id_verified = true

  - rule: BR-POD-004
    description: Age verification for restricted items
    validation: delivery.requires_age_verification = false OR (age_verified = true AND verified_age >= delivery.minimum_age)

  - rule: BR-POD-005
    description: Location must be near delivery address
    validation: distance_from_address_m <= 200

events:
  - name: pod.captured
    description: POD was captured
    payload: [pod_id, delivery_id, pod_type]

  - name: pod.verified
    description: POD verified by system
    payload: [pod_id, is_valid]

  - name: pod.recipient_confirmed
    description: Recipient confirmed delivery
    payload: [pod_id, confirmed_at]
