name: Route
display_name: Route
description: |
  Predefined or optimized route for trips.
  Contains waypoints, estimated times, and optimization parameters.

domain: logistics
subdomain: fleet
category: core

attributes:
  - name: id
    type: uuid
    required: true

  - name: route_code
    type: string
    required: true
    validation:
      pattern: "^RT-[A-Z]{2}-[0-9]{4}$"
    example: "RT-LA-0001"

  - name: name
    type: string
    required: true
    example: "Los Angeles to San Diego Express"

  - name: description
    type: text
    required: false

  - name: status
    type: enum
    required: true
    validation:
      values: [active, inactive, draft, archived]
    default: active

  - name: route_type
    type: enum
    required: true
    validation:
      values: [fixed, dynamic, optimized]
    default: fixed

  # Origin
  - name: origin_depot_id
    type: uuid
    required: true

  - name: origin_address
    type: object
    required: true
    example:
      line1: "100 Warehouse Blvd"
      city: "Los Angeles"
      state: "CA"
      postal_code: "90001"
      lat: 34.0522
      lng: -118.2437

  # Destination
  - name: destination_depot_id
    type: uuid
    required: false

  - name: destination_address
    type: object
    required: false

  - name: is_round_trip
    type: boolean
    required: true
    default: false

  # Geography
  - name: total_distance_km
    type: decimal
    required: true

  - name: estimated_duration_minutes
    type: integer
    required: true

  - name: waypoints
    type: array
    required: false
    description: Ordered list of waypoint coordinates
    example:
      - lat: 33.8704
        lng: -117.9242
        name: "Anaheim checkpoint"
      - lat: 33.1959
        lng: -117.3795
        name: "Oceanside rest stop"

  - name: polyline
    type: string
    required: false
    description: Encoded polyline for map display

  - name: bounds
    type: object
    required: false
    example:
      north: 34.0522
      south: 32.7157
      east: -117.1611
      west: -118.2437

  # Stop Configuration
  - name: max_stops
    type: integer
    required: false

  - name: typical_stops
    type: integer
    required: false

  - name: stop_sequence
    type: array
    required: false
    description: Default stop order for fixed routes

  # Vehicle Requirements
  - name: required_vehicle_type
    type: enum
    required: false
    validation:
      values: [truck, van, car, motorcycle, trailer]

  - name: required_vehicle_class
    type: enum
    required: false
    validation:
      values: [light_duty, medium_duty, heavy_duty]

  - name: requires_hazmat
    type: boolean
    required: true
    default: false

  - name: requires_refrigeration
    type: boolean
    required: true
    default: false

  # Restrictions
  - name: restrictions
    type: array
    required: false
    example:
      - type: "weight_limit"
        value: 20000
        unit: "kg"
        location: "Bridge on Highway 5"
      - type: "height_limit"
        value: 4.2
        unit: "m"
        location: "Tunnel entrance"

  - name: avoid_highways
    type: boolean
    required: true
    default: false

  - name: avoid_tolls
    type: boolean
    required: true
    default: false

  - name: avoid_ferries
    type: boolean
    required: true
    default: true

  # Schedule
  - name: operating_days
    type: array
    required: false
    example: ["monday", "tuesday", "wednesday", "thursday", "friday"]

  - name: departure_windows
    type: array
    required: false
    example:
      - start: "06:00"
        end: "08:00"
      - start: "14:00"
        end: "16:00"

  - name: service_time_per_stop_minutes
    type: integer
    required: false
    default: 15

  # Optimization
  - name: optimization_objective
    type: enum
    required: false
    validation:
      values: [minimize_distance, minimize_time, minimize_cost, balanced]
    default: balanced

  - name: traffic_model
    type: enum
    required: false
    validation:
      values: [best_guess, pessimistic, optimistic]
    default: best_guess

  - name: last_optimized_at
    type: timestamp
    required: false

  # Costs
  - name: estimated_fuel_cost
    type: decimal
    required: false

  - name: estimated_toll_cost
    type: decimal
    required: false

  - name: estimated_total_cost
    type: decimal
    required: false

  # Performance Metrics
  - name: average_completion_time_minutes
    type: integer
    required: false

  - name: on_time_percentage
    type: decimal
    required: false

  - name: trips_completed
    type: integer
    required: true
    default: 0

  - name: average_fuel_consumption
    type: decimal
    required: false
    description: Liters per 100 km

  # Zones
  - name: zone_ids
    type: array
    required: false
    description: Delivery zones covered by this route

  - name: territory_id
    type: uuid
    required: false

  # Notes
  - name: driver_instructions
    type: text
    required: false

  - name: notes
    type: text
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

  - name: created_by
    type: uuid
    required: false

relationships:
  - name: origin_depot
    type: belongs_to
    entity: Depot
    required: true

  - name: destination_depot
    type: belongs_to
    entity: Depot
    required: false

  - name: trips
    type: has_many
    entity: Trip

  - name: stops
    type: has_many
    entity: Stop

  - name: territory
    type: belongs_to
    entity: Territory
    required: false

indexes:
  - [route_code]
  - [status]
  - [origin_depot_id]
  - [destination_depot_id]
  - [route_type]
  - [operating_days]

computed_fields:
  - name: efficiency_score
    formula: (estimated_duration_minutes / average_completion_time_minutes) * 100
  - name: cost_per_km
    formula: estimated_total_cost / total_distance_km

state_machine:
  initial: draft
  states:
    - name: draft
      description: Route being defined
    - name: active
      description: Route in use for trips
    - name: inactive
      description: Temporarily disabled
    - name: archived
      description: No longer in use
  transitions:
    - from: draft
      to: active
      trigger: activate
      conditions: [valid_waypoints, valid_schedule]
    - from: active
      to: inactive
      trigger: deactivate
    - from: inactive
      to: active
      trigger: reactivate
    - from: [active, inactive]
      to: archived
      trigger: archive

business_rules:
  - BR-RTE-001: Route must have valid origin coordinates
  - BR-RTE-002: Hazmat routes require approved pathways
  - BR-RTE-003: Heavy duty routes must respect weight limits
  - BR-RTE-004: Routes should be reoptimized monthly

events:
  - name: route.created
    payload: [id, route_code, origin_depot_id]
  - name: route.optimized
    payload: [id, old_distance_km, new_distance_km, savings_percent]
  - name: route.performance_updated
    payload: [id, on_time_percentage, average_completion_time]
