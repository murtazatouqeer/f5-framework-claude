name: DriverBehavior
display_name: Driver Behavior
description: |
  Driver behavior events detected by telematics.
  Tracks safety-related driving patterns and scores.

domain: logistics
subdomain: fleet
category: telematics

attributes:
  - name: id
    type: uuid
    required: true

  - name: event_number
    type: string
    required: true
    validation:
      pattern: "^DBE-[0-9]{10}$"
    example: "DBE-0000000001"

  - name: driver_id
    type: uuid
    required: true

  - name: vehicle_id
    type: uuid
    required: true

  - name: trip_id
    type: uuid
    required: false

  - name: device_id
    type: string
    required: false

  # Event Details
  - name: event_type
    type: enum
    required: true
    validation:
      values:
        - harsh_brake
        - harsh_acceleration
        - harsh_cornering
        - speeding
        - distracted_driving
        - fatigue_detected
        - seatbelt_violation
        - phone_usage
        - tailgating
        - lane_departure
        - forward_collision_warning
        - drowsiness

  - name: severity
    type: enum
    required: true
    validation:
      values: [low, medium, high, critical]

  - name: score_impact
    type: integer
    required: true
    description: Points deducted from safety score (negative)
    validation:
      min: -100
      max: 0

  # Timing
  - name: occurred_at
    type: timestamp
    required: true

  - name: duration_seconds
    type: integer
    required: false

  # Location
  - name: latitude
    type: decimal
    required: true

  - name: longitude
    type: decimal
    required: true

  - name: address
    type: string
    required: false

  - name: road_name
    type: string
    required: false

  # Speed Context
  - name: speed_kmh
    type: decimal
    required: false

  - name: speed_limit_kmh
    type: decimal
    required: false

  - name: speed_over_limit_kmh
    type: decimal
    required: false

  # Acceleration/Deceleration
  - name: g_force
    type: decimal
    required: false
    description: G-force measurement

  - name: acceleration_mps2
    type: decimal
    required: false
    description: Acceleration in m/sÂ²

  # Heading
  - name: heading_before
    type: decimal
    required: false

  - name: heading_after
    type: decimal
    required: false

  - name: heading_change
    type: decimal
    required: false

  # Evidence
  - name: video_url
    type: string
    required: false
    description: Dashcam video clip URL

  - name: video_start_offset
    type: integer
    required: false
    description: Seconds into video where event starts

  - name: video_duration
    type: integer
    required: false

  - name: snapshot_url
    type: string
    required: false
    description: Image snapshot of event

  # Detection Source
  - name: detection_source
    type: enum
    required: true
    validation:
      values: [accelerometer, gps, camera, eld, manual]
    default: accelerometer

  - name: confidence_score
    type: decimal
    required: false
    description: AI confidence 0-1

  # Context
  - name: weather_conditions
    type: enum
    required: false
    validation:
      values: [clear, rain, snow, fog, wind]

  - name: road_conditions
    type: enum
    required: false
    validation:
      values: [dry, wet, icy, construction]

  - name: traffic_conditions
    type: enum
    required: false
    validation:
      values: [light, moderate, heavy, standstill]

  - name: time_of_day
    type: enum
    required: false
    validation:
      values: [morning, afternoon, evening, night]

  # Review Status
  - name: reviewed
    type: boolean
    required: true
    default: false

  - name: reviewed_by
    type: uuid
    required: false

  - name: reviewed_at
    type: timestamp
    required: false

  - name: review_outcome
    type: enum
    required: false
    validation:
      values: [confirmed, dismissed, coaching_needed, escalated]

  - name: review_notes
    type: text
    required: false

  # Coaching
  - name: coaching_completed
    type: boolean
    required: true
    default: false

  - name: coaching_date
    type: date
    required: false

  - name: coaching_notes
    type: text
    required: false

  # Disputed
  - name: disputed
    type: boolean
    required: true
    default: false

  - name: dispute_reason
    type: text
    required: false

  - name: dispute_resolved
    type: boolean
    required: false

  # Acknowledgment
  - name: driver_acknowledged
    type: boolean
    required: true
    default: false

  - name: acknowledged_at
    type: timestamp
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: driver
    type: belongs_to
    entity: Driver
    required: true

  - name: vehicle
    type: belongs_to
    entity: Vehicle
    required: true

  - name: trip
    type: belongs_to
    entity: Trip
    required: false

  - name: reviewed_by_user
    type: belongs_to
    entity: User
    required: false

indexes:
  - [event_number]
  - [driver_id, occurred_at]
  - [vehicle_id, occurred_at]
  - [trip_id]
  - [event_type]
  - [severity]
  - [reviewed]
  - [occurred_at]

computed_fields:
  - name: is_speeding
    formula: speed_kmh > speed_limit_kmh
  - name: speed_percentage_over
    formula: ((speed_kmh - speed_limit_kmh) / speed_limit_kmh) * 100

aggregations:
  - name: driver_daily_score
    group_by: [driver_id, date]
    fields: [event_count, total_score_impact, severity_breakdown]
  - name: fleet_weekly_trends
    group_by: [week]
    fields: [event_count_by_type, average_severity]

business_rules:
  - BR-DBE-001: Critical events notify fleet manager immediately
  - BR-DBE-002: 3+ high severity events in week triggers review
  - BR-DBE-003: Speeding >30 km/h over limit is critical
  - BR-DBE-004: Disputed events excluded from score until resolved
  - BR-DBE-005: Video evidence required for coaching

events:
  - name: behavior.event_detected
    payload: [id, driver_id, event_type, severity]
  - name: behavior.critical_event
    payload: [id, driver_id, event_type, location]
  - name: behavior.score_threshold
    payload: [driver_id, current_score, threshold]
  - name: behavior.coaching_required
    payload: [driver_id, event_count, recommendation]
