name: Stop
display_name: Stop
description: |
  Individual stop within a trip for pickup, delivery, or service.
  Tracks arrival, completion, proof of delivery, and exceptions.

domain: logistics
subdomain: fleet
category: core

attributes:
  - name: id
    type: uuid
    required: true

  - name: stop_number
    type: string
    required: true
    validation:
      pattern: "^STP-[0-9]{8}$"
    example: "STP-00000001"

  - name: trip_id
    type: uuid
    required: true

  - name: route_id
    type: uuid
    required: false

  - name: status
    type: enum
    required: true
    validation:
      values: [pending, arrived, in_progress, completed, failed, skipped]
    default: pending

  # Sequence
  - name: sequence_number
    type: integer
    required: true
    description: Order of stop in the trip

  - name: is_first_stop
    type: boolean
    required: true
    default: false

  - name: is_last_stop
    type: boolean
    required: true
    default: false

  # Stop Type
  - name: stop_type
    type: enum
    required: true
    validation:
      values: [pickup, delivery, fuel, rest, service, inspection]

  - name: priority
    type: enum
    required: true
    validation:
      values: [low, normal, high, critical]
    default: normal

  # Location
  - name: location_name
    type: string
    required: false
    example: "ABC Distribution Center"

  - name: address
    type: object
    required: true
    example:
      line1: "456 Commerce St"
      line2: "Suite 100"
      city: "San Diego"
      state: "CA"
      postal_code: "92101"
      country: "US"

  - name: lat
    type: decimal
    required: true

  - name: lng
    type: decimal
    required: true

  - name: geofence_radius_m
    type: integer
    required: false
    default: 100

  # Contact
  - name: contact_name
    type: string
    required: false

  - name: contact_phone
    type: string
    required: false

  - name: contact_email
    type: string
    required: false

  # Customer
  - name: customer_id
    type: uuid
    required: false

  - name: order_id
    type: uuid
    required: false

  - name: shipment_id
    type: uuid
    required: false

  # Timing - Planned
  - name: scheduled_arrival
    type: timestamp
    required: true

  - name: scheduled_departure
    type: timestamp
    required: false

  - name: time_window_start
    type: timestamp
    required: false

  - name: time_window_end
    type: timestamp
    required: false

  - name: estimated_service_time_minutes
    type: integer
    required: false
    default: 15

  # Timing - Actual
  - name: actual_arrival
    type: timestamp
    required: false

  - name: actual_departure
    type: timestamp
    required: false

  - name: wait_time_minutes
    type: integer
    required: false

  - name: service_time_minutes
    type: integer
    required: false

  # Distance
  - name: distance_from_previous_km
    type: decimal
    required: false

  - name: distance_to_next_km
    type: decimal
    required: false

  # Load (for pickup/delivery)
  - name: items_count
    type: integer
    required: false

  - name: packages_count
    type: integer
    required: false

  - name: pallets_count
    type: integer
    required: false

  - name: weight_kg
    type: decimal
    required: false

  - name: volume_cbm
    type: decimal
    required: false

  # Proof of Delivery/Pickup
  - name: signature_required
    type: boolean
    required: true
    default: true

  - name: photo_required
    type: boolean
    required: true
    default: false

  - name: signature_image_url
    type: string
    required: false

  - name: signee_name
    type: string
    required: false

  - name: photo_urls
    type: array
    required: false

  - name: barcode_scans
    type: array
    required: false
    example:
      - barcode: "PKG-001"
        scanned_at: "2024-01-15T10:30:00Z"
        status: "delivered"

  # Completion
  - name: completed_at
    type: timestamp
    required: false

  - name: completed_by
    type: uuid
    required: false
    description: Driver who completed the stop

  - name: completion_notes
    type: text
    required: false

  # Failure
  - name: failure_reason
    type: enum
    required: false
    validation:
      values:
        - customer_not_available
        - address_not_found
        - refused_delivery
        - damaged_goods
        - wrong_items
        - access_denied
        - weather
        - vehicle_issue
        - other

  - name: failure_notes
    type: text
    required: false

  - name: failed_at
    type: timestamp
    required: false

  - name: retry_scheduled
    type: timestamp
    required: false

  # Skip
  - name: skip_reason
    type: string
    required: false

  - name: skipped_at
    type: timestamp
    required: false

  # Special Instructions
  - name: delivery_instructions
    type: text
    required: false

  - name: access_instructions
    type: text
    required: false
    example: "Gate code: 1234, Ring bell twice"

  - name: special_requirements
    type: array
    required: false
    example: ["lift_gate", "inside_delivery", "appointment_required"]

  # Payment (for COD)
  - name: payment_required
    type: boolean
    required: true
    default: false

  - name: payment_amount
    type: decimal
    required: false

  - name: payment_collected
    type: decimal
    required: false

  - name: payment_method
    type: enum
    required: false
    validation:
      values: [cash, check, card, online]

  # Driver
  - name: driver_notes
    type: text
    required: false

  # Rating
  - name: customer_rating
    type: integer
    required: false
    description: Rating 1-5

  - name: customer_feedback
    type: text
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: trip
    type: belongs_to
    entity: Trip
    required: true

  - name: route
    type: belongs_to
    entity: Route
    required: false

  - name: customer
    type: belongs_to
    entity: Customer
    required: false

  - name: order
    type: belongs_to
    entity: Order
    required: false

  - name: shipment
    type: belongs_to
    entity: Shipment
    required: false

  - name: completed_by_driver
    type: belongs_to
    entity: Driver
    required: false

indexes:
  - [stop_number]
  - [trip_id, sequence_number]
  - [status]
  - [customer_id]
  - [order_id]
  - [scheduled_arrival]
  - [stop_type]

computed_fields:
  - name: on_time
    formula: actual_arrival <= time_window_end
  - name: early_arrival_minutes
    formula: max(0, scheduled_arrival - actual_arrival)
  - name: late_arrival_minutes
    formula: max(0, actual_arrival - time_window_end)
  - name: total_time_at_stop_minutes
    formula: actual_departure - actual_arrival

state_machine:
  initial: pending
  states:
    - name: pending
      description: Stop not yet reached
    - name: arrived
      description: Driver arrived at stop
    - name: in_progress
      description: Service being performed
    - name: completed
      description: Stop successfully completed
    - name: failed
      description: Stop could not be completed
    - name: skipped
      description: Stop intentionally skipped
  transitions:
    - from: pending
      to: arrived
      trigger: arrive
      conditions: [within_geofence]
      actions: [record_arrival_time]
    - from: pending
      to: skipped
      trigger: skip
      conditions: [skip_authorized]
    - from: arrived
      to: in_progress
      trigger: start_service
    - from: in_progress
      to: completed
      trigger: complete
      conditions: [required_info_collected]
      actions: [record_completion, update_trip_progress]
    - from: [arrived, in_progress]
      to: failed
      trigger: fail
      actions: [record_failure_reason]

business_rules:
  - BR-STP-001: Signature required for high-value deliveries
  - BR-STP-002: Photo required for contactless deliveries
  - BR-STP-003: COD payment must be collected before completion
  - BR-STP-004: Failed stops must have reason documented
  - BR-STP-005: Time window violations trigger alerts

events:
  - name: stop.arrived
    payload: [id, trip_id, actual_arrival, on_time]
  - name: stop.completed
    payload: [id, trip_id, service_time_minutes]
  - name: stop.failed
    payload: [id, trip_id, failure_reason]
  - name: stop.time_window_violated
    payload: [id, trip_id, late_minutes]
