name: MaintenanceRecord
display_name: Maintenance Record
description: |
  Record of maintenance work performed on fleet vehicles.
  Tracks service type, parts, labor, and costs.

domain: logistics
subdomain: fleet
category: operations

attributes:
  - name: id
    type: uuid
    required: true

  - name: maintenance_number
    type: string
    required: true
    validation:
      pattern: "^MNT-[0-9]{8}$"
    example: "MNT-00000001"

  - name: vehicle_id
    type: uuid
    required: true

  - name: schedule_id
    type: uuid
    required: false
    description: Link to maintenance schedule if preventive

  - name: status
    type: enum
    required: true
    validation:
      values: [scheduled, in_progress, completed, cancelled]
    default: scheduled

  # Maintenance Type
  - name: maintenance_type
    type: enum
    required: true
    validation:
      values: [preventive, corrective, inspection, recall, emergency]

  - name: category
    type: enum
    required: true
    validation:
      values: [engine, transmission, brakes, tires, electrical, hvac, body, suspension, exhaust, fuel_system, cooling, steering, other]

  - name: priority
    type: enum
    required: true
    validation:
      values: [low, normal, high, critical]
    default: normal

  # Description
  - name: title
    type: string
    required: true
    example: "Oil Change and Filter Replacement"

  - name: description
    type: text
    required: false

  - name: work_performed
    type: text
    required: false

  # Service Provider
  - name: service_location
    type: enum
    required: true
    validation:
      values: [in_house, external_shop, dealer, mobile_service, roadside]
    default: in_house

  - name: vendor_id
    type: uuid
    required: false

  - name: vendor_name
    type: string
    required: false

  - name: vendor_address
    type: object
    required: false

  - name: technician_name
    type: string
    required: false

  # Vehicle State
  - name: odometer_at_service
    type: decimal
    required: true

  - name: engine_hours_at_service
    type: decimal
    required: false

  - name: reported_issue
    type: text
    required: false

  - name: diagnosis
    type: text
    required: false

  # Scheduling
  - name: scheduled_date
    type: date
    required: true

  - name: scheduled_time
    type: time
    required: false

  - name: estimated_duration_hours
    type: decimal
    required: false

  # Actual Timing
  - name: started_at
    type: timestamp
    required: false

  - name: completed_at
    type: timestamp
    required: false

  - name: actual_duration_hours
    type: decimal
    required: false

  # Parts
  - name: parts_used
    type: array
    required: false
    example:
      - part_number: "OIL-5W30-5L"
        description: "Engine Oil 5W-30 5L"
        quantity: 2
        unit_cost: 45.00
        total_cost: 90.00
      - part_number: "FLT-OIL-001"
        description: "Oil Filter"
        quantity: 1
        unit_cost: 15.00
        total_cost: 15.00

  - name: parts_cost
    type: decimal
    required: false

  # Labor
  - name: labor_hours
    type: decimal
    required: false

  - name: labor_rate
    type: decimal
    required: false

  - name: labor_cost
    type: decimal
    required: false

  # Costs
  - name: other_costs
    type: decimal
    required: false

  - name: tax
    type: decimal
    required: false

  - name: total_cost
    type: decimal
    required: false

  - name: currency
    type: string
    required: true
    default: "USD"

  # Warranty
  - name: warranty_claim
    type: boolean
    required: true
    default: false

  - name: warranty_coverage
    type: decimal
    required: false

  - name: warranty_claim_number
    type: string
    required: false

  # Documents
  - name: invoice_number
    type: string
    required: false

  - name: invoice_url
    type: string
    required: false

  - name: work_order_number
    type: string
    required: false

  - name: photos
    type: array
    required: false
    description: Before/after photos

  # Follow-up
  - name: next_service_due_date
    type: date
    required: false

  - name: next_service_due_odometer
    type: decimal
    required: false

  - name: follow_up_required
    type: boolean
    required: true
    default: false

  - name: follow_up_notes
    type: text
    required: false

  # Approval
  - name: approved_by
    type: uuid
    required: false

  - name: approved_at
    type: timestamp
    required: false

  # Notes
  - name: technician_notes
    type: text
    required: false

  - name: internal_notes
    type: text
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

  - name: created_by
    type: uuid
    required: false

relationships:
  - name: vehicle
    type: belongs_to
    entity: Vehicle
    required: true

  - name: schedule
    type: belongs_to
    entity: MaintenanceSchedule
    required: false

  - name: vendor
    type: belongs_to
    entity: Vendor
    required: false

  - name: approved_by_user
    type: belongs_to
    entity: User
    required: false

  - name: created_by_user
    type: belongs_to
    entity: User
    required: false

indexes:
  - [maintenance_number]
  - [vehicle_id, status]
  - [vehicle_id, scheduled_date]
  - [maintenance_type]
  - [status]
  - [vendor_id]
  - [scheduled_date]
  - [completed_at]

computed_fields:
  - name: total_parts_count
    formula: sum(parts_used.quantity)
  - name: cost_per_hour
    formula: total_cost / actual_duration_hours
  - name: duration_variance
    formula: actual_duration_hours - estimated_duration_hours

state_machine:
  initial: scheduled
  states:
    - name: scheduled
      description: Maintenance planned
    - name: in_progress
      description: Work being performed
    - name: completed
      description: Maintenance finished
    - name: cancelled
      description: Maintenance cancelled
  transitions:
    - from: scheduled
      to: in_progress
      trigger: start
      actions: [record_start_time, update_vehicle_status]
    - from: scheduled
      to: cancelled
      trigger: cancel
    - from: in_progress
      to: completed
      trigger: complete
      conditions: [work_documented]
      actions: [record_completion, update_vehicle_mileage, schedule_next_service]

business_rules:
  - BR-MNT-001: Emergency maintenance bypasses scheduling
  - BR-MNT-002: External service requires cost approval above $500
  - BR-MNT-003: Warranty claims require documentation
  - BR-MNT-004: Parts must be recorded with part numbers
  - BR-MNT-005: Completed maintenance updates vehicle service history

events:
  - name: maintenance.scheduled
    payload: [id, vehicle_id, maintenance_type, scheduled_date]
  - name: maintenance.started
    payload: [id, vehicle_id, started_at]
  - name: maintenance.completed
    payload: [id, vehicle_id, total_cost, next_service_due]
  - name: maintenance.cost_exceeded
    payload: [id, vehicle_id, estimated_cost, actual_cost]
