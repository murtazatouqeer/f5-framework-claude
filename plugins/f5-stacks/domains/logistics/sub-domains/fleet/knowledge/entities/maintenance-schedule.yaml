name: MaintenanceSchedule
display_name: Maintenance Schedule
description: |
  Preventive maintenance schedule templates for fleet vehicles.
  Defines service intervals based on time or mileage.

domain: logistics
subdomain: fleet
category: operations

attributes:
  - name: id
    type: uuid
    required: true

  - name: schedule_code
    type: string
    required: true
    validation:
      pattern: "^MS-[A-Z]{3}-[0-9]{3}$"
    example: "MS-OIL-001"

  - name: name
    type: string
    required: true
    example: "Oil Change Schedule"

  - name: description
    type: text
    required: false

  - name: status
    type: enum
    required: true
    validation:
      values: [active, inactive, archived]
    default: active

  # Applicability
  - name: applies_to
    type: enum
    required: true
    validation:
      values: [all_vehicles, vehicle_type, vehicle_class, specific_vehicles]

  - name: vehicle_types
    type: array
    required: false
    example: ["truck", "van"]

  - name: vehicle_classes
    type: array
    required: false
    example: ["heavy_duty"]

  - name: vehicle_ids
    type: array
    required: false

  - name: make
    type: string
    required: false

  - name: model
    type: string
    required: false

  - name: year_from
    type: integer
    required: false

  - name: year_to
    type: integer
    required: false

  # Service Details
  - name: maintenance_type
    type: enum
    required: true
    validation:
      values: [preventive, inspection]

  - name: category
    type: enum
    required: true
    validation:
      values: [engine, transmission, brakes, tires, electrical, hvac, body, suspension, exhaust, fuel_system, cooling, steering, safety, general]

  - name: service_items
    type: array
    required: true
    example:
      - name: "Change engine oil"
        required: true
      - name: "Replace oil filter"
        required: true
      - name: "Check fluid levels"
        required: true
      - name: "Inspect belts"
        required: false

  # Interval - Time Based
  - name: interval_days
    type: integer
    required: false
    description: Days between services

  - name: interval_weeks
    type: integer
    required: false

  - name: interval_months
    type: integer
    required: false

  # Interval - Distance Based
  - name: interval_km
    type: integer
    required: false
    description: Kilometers between services

  - name: interval_miles
    type: integer
    required: false

  # Interval - Hours Based
  - name: interval_engine_hours
    type: integer
    required: false

  # Trigger Logic
  - name: trigger_type
    type: enum
    required: true
    validation:
      values: [time_only, distance_only, hours_only, whichever_first, all_conditions]
    default: whichever_first

  # Warning Thresholds
  - name: warning_days_before
    type: integer
    required: false
    default: 7

  - name: warning_km_before
    type: integer
    required: false
    default: 500

  - name: warning_hours_before
    type: integer
    required: false

  # Overdue Thresholds
  - name: critical_days_overdue
    type: integer
    required: false
    default: 14

  - name: critical_km_overdue
    type: integer
    required: false
    default: 1000

  # Estimated Resources
  - name: estimated_duration_hours
    type: decimal
    required: false

  - name: estimated_cost
    type: decimal
    required: false

  - name: required_parts
    type: array
    required: false
    example:
      - part_number: "OIL-5W30-5L"
        description: "Engine Oil 5W-30"
        quantity: 2
      - part_number: "FLT-OIL-001"
        description: "Oil Filter"
        quantity: 1

  # Service Location
  - name: preferred_service_location
    type: enum
    required: false
    validation:
      values: [in_house, external_shop, dealer, any]
    default: any

  - name: preferred_vendor_id
    type: uuid
    required: false

  # Compliance
  - name: is_regulatory
    type: boolean
    required: true
    default: false

  - name: regulation_reference
    type: string
    required: false
    example: "DOT Annual Inspection"

  - name: compliance_category
    type: enum
    required: false
    validation:
      values: [dot, fmcsa, epa, state, manufacturer]

  # Priority
  - name: priority
    type: enum
    required: true
    validation:
      values: [low, normal, high, critical]
    default: normal

  - name: can_defer
    type: boolean
    required: true
    default: true

  - name: max_defer_days
    type: integer
    required: false

  # Notifications
  - name: notify_driver
    type: boolean
    required: true
    default: true

  - name: notify_fleet_manager
    type: boolean
    required: true
    default: true

  - name: notify_maintenance_team
    type: boolean
    required: true
    default: true

  # Auto Scheduling
  - name: auto_schedule
    type: boolean
    required: true
    default: true

  - name: auto_create_work_order
    type: boolean
    required: true
    default: false

  # Notes
  - name: instructions
    type: text
    required: false

  - name: notes
    type: text
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

  - name: created_by
    type: uuid
    required: false

relationships:
  - name: preferred_vendor
    type: belongs_to
    entity: Vendor
    required: false

  - name: maintenance_records
    type: has_many
    entity: MaintenanceRecord

  - name: created_by_user
    type: belongs_to
    entity: User
    required: false

indexes:
  - [schedule_code]
  - [status]
  - [maintenance_type]
  - [category]
  - [applies_to]
  - [is_regulatory]

computed_fields:
  - name: next_due_calculation
    formula: min(last_service_date + interval_days, last_service_km + interval_km)

validation_rules:
  - name: interval_required
    condition: interval_days OR interval_km OR interval_engine_hours
    message: "At least one interval must be specified"

business_rules:
  - BR-MSC-001: Regulatory schedules cannot be deferred
  - BR-MSC-002: Critical priority creates immediate work order
  - BR-MSC-003: Auto-schedule generates maintenance 7 days before due
  - BR-MSC-004: Overdue items restrict vehicle from trips

events:
  - name: schedule.created
    payload: [id, schedule_code, maintenance_type]
  - name: schedule.service_due
    payload: [schedule_id, vehicle_id, due_date, due_km]
  - name: schedule.service_overdue
    payload: [schedule_id, vehicle_id, days_overdue, km_overdue]
