name: FuelLog
display_name: Fuel Log
description: |
  Record of fuel purchase or consumption for fleet vehicles.
  Tracks quantity, cost, location, and efficiency metrics.

domain: logistics
subdomain: fleet
category: operations

attributes:
  - name: id
    type: uuid
    required: true

  - name: fuel_log_number
    type: string
    required: true
    validation:
      pattern: "^FL-[0-9]{8}$"
    example: "FL-00000001"

  - name: vehicle_id
    type: uuid
    required: true

  - name: driver_id
    type: uuid
    required: true

  - name: trip_id
    type: uuid
    required: false

  - name: status
    type: enum
    required: true
    validation:
      values: [pending, approved, rejected, flagged]
    default: pending

  # Transaction Details
  - name: transaction_type
    type: enum
    required: true
    validation:
      values: [purchase, bulk_fill, tank_dip, adjustment]
    default: purchase

  - name: transaction_date
    type: timestamp
    required: true

  # Fuel Details
  - name: fuel_type
    type: enum
    required: true
    validation:
      values: [diesel, gasoline, electric, cng, lpg, def]

  - name: quantity_liters
    type: decimal
    required: true

  - name: unit_price
    type: decimal
    required: true

  - name: total_cost
    type: decimal
    required: true

  - name: currency
    type: string
    required: true
    default: "USD"

  # Odometer
  - name: odometer_reading_km
    type: decimal
    required: true

  - name: previous_odometer_km
    type: decimal
    required: false

  - name: distance_since_last_fill_km
    type: decimal
    required: false

  # Efficiency
  - name: fuel_efficiency
    type: decimal
    required: false
    description: km per liter

  - name: consumption_rate
    type: decimal
    required: false
    description: liters per 100 km

  - name: expected_efficiency
    type: decimal
    required: false

  - name: efficiency_variance_percent
    type: decimal
    required: false

  # Tank Status
  - name: tank_level_before
    type: decimal
    required: false
    description: Tank percentage before fill

  - name: tank_level_after
    type: decimal
    required: false
    description: Tank percentage after fill

  - name: is_full_tank
    type: boolean
    required: true
    default: true

  # Location
  - name: station_name
    type: string
    required: false

  - name: station_address
    type: object
    required: false
    example:
      line1: "123 Fuel Station Rd"
      city: "Los Angeles"
      state: "CA"
      postal_code: "90001"

  - name: station_lat
    type: decimal
    required: false

  - name: station_lng
    type: decimal
    required: false

  - name: station_brand
    type: string
    required: false
    example: "Shell"

  # Payment
  - name: payment_method
    type: enum
    required: true
    validation:
      values: [fuel_card, company_card, cash, reimbursement]
    default: fuel_card

  - name: fuel_card_number
    type: string
    required: false

  - name: fuel_card_last4
    type: string
    required: false

  - name: receipt_number
    type: string
    required: false

  - name: receipt_image_url
    type: string
    required: false

  # Verification
  - name: verified
    type: boolean
    required: true
    default: false

  - name: verified_by
    type: uuid
    required: false

  - name: verified_at
    type: timestamp
    required: false

  # Flags
  - name: is_anomaly
    type: boolean
    required: true
    default: false

  - name: anomaly_reason
    type: string
    required: false
    example: "Fuel efficiency 40% below average"

  - name: needs_review
    type: boolean
    required: true
    default: false

  - name: review_notes
    type: text
    required: false

  # DEF (Diesel Exhaust Fluid) if applicable
  - name: def_quantity_liters
    type: decimal
    required: false

  - name: def_cost
    type: decimal
    required: false

  # Additional Items
  - name: additional_items
    type: array
    required: false
    description: Non-fuel purchases at station
    example:
      - item: "Windshield washer fluid"
        quantity: 1
        cost: 5.99

  - name: additional_items_cost
    type: decimal
    required: false

  # Notes
  - name: driver_notes
    type: text
    required: false

  - name: notes
    type: text
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: vehicle
    type: belongs_to
    entity: Vehicle
    required: true

  - name: driver
    type: belongs_to
    entity: Driver
    required: true

  - name: trip
    type: belongs_to
    entity: Trip
    required: false

  - name: verified_by_user
    type: belongs_to
    entity: User
    required: false

indexes:
  - [fuel_log_number]
  - [vehicle_id, transaction_date]
  - [driver_id, transaction_date]
  - [trip_id]
  - [status]
  - [is_anomaly]
  - [transaction_date]
  - [fuel_card_number]

computed_fields:
  - name: cost_per_km
    formula: total_cost / distance_since_last_fill_km
  - name: efficiency_rating
    formula: (fuel_efficiency / expected_efficiency) * 100
  - name: is_efficient
    formula: fuel_efficiency >= expected_efficiency * 0.9

validation_rules:
  - name: quantity_positive
    condition: quantity_liters > 0
    message: "Fuel quantity must be positive"

  - name: odometer_increasing
    condition: odometer_reading_km > previous_odometer_km
    message: "Odometer reading must be greater than previous"

  - name: cost_matches_quantity
    condition: abs(total_cost - (quantity_liters * unit_price)) < 0.01
    message: "Total cost must match quantity times unit price"

business_rules:
  - BR-FUL-001: Fuel purchases must match vehicle fuel type
  - BR-FUL-002: Efficiency variance >20% triggers review
  - BR-FUL-003: Missing odometer reading requires supervisor approval
  - BR-FUL-004: Fuel card purchases auto-reconcile with card provider
  - BR-FUL-005: Cash purchases require receipt image

events:
  - name: fuel_log.created
    payload: [id, vehicle_id, driver_id, quantity_liters, total_cost]
  - name: fuel_log.anomaly_detected
    payload: [id, vehicle_id, anomaly_reason, efficiency_variance]
  - name: fuel_log.approved
    payload: [id, approved_by, approved_at]
  - name: fuel_log.rejected
    payload: [id, rejected_by, rejection_reason]
