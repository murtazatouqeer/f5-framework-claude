name: Driver
display_name: Driver
description: |
  Fleet driver with license, certifications, and performance tracking.
  Manages Hours of Service compliance and safety scoring.

domain: logistics
subdomain: fleet
category: core

attributes:
  - name: id
    type: uuid
    required: true

  - name: driver_id
    type: string
    required: true
    validation:
      pattern: "^DRV-[0-9]{4}$"
    example: "DRV-0001"

  - name: employee_id
    type: string
    required: true

  - name: user_id
    type: uuid
    required: true
    description: Link to system user account

  - name: status
    type: enum
    required: true
    validation:
      values: [active, inactive, suspended, terminated]
    default: active

  # Personal Information
  - name: first_name
    type: string
    required: true

  - name: last_name
    type: string
    required: true

  - name: date_of_birth
    type: date
    required: true

  - name: gender
    type: enum
    required: false
    validation:
      values: [male, female, other]

  - name: photo_url
    type: string
    required: false

  - name: phone
    type: string
    required: true

  - name: email
    type: string
    required: true
    validation:
      format: email

  - name: address
    type: object
    required: false
    example:
      line1: "123 Main Street"
      city: "Los Angeles"
      state: "CA"
      postal_code: "90001"
      country: "US"

  - name: emergency_contact
    type: object
    required: true
    example:
      name: "Jane Doe"
      relationship: "Spouse"
      phone: "+1-555-0102"

  # License
  - name: license_number
    type: string
    required: true

  - name: license_state
    type: string
    required: true
    description: Issuing state/jurisdiction

  - name: license_class
    type: enum
    required: true
    validation:
      values: [A, B, C, D, E]
    description: CDL class

  - name: license_expiry
    type: date
    required: true

  - name: license_restrictions
    type: array
    required: false
    description: License restrictions (e.g., corrective lenses)

  - name: endorsements
    type: array
    required: false
    description: CDL endorsements
    example: ["H", "N", "T"]

  # Employment
  - name: hire_date
    type: date
    required: true

  - name: termination_date
    type: date
    required: false

  - name: employment_type
    type: enum
    required: true
    validation:
      values: [full_time, part_time, contractor]
    default: full_time

  - name: home_depot_id
    type: uuid
    required: true

  - name: supervisor_id
    type: uuid
    required: false

  - name: pay_type
    type: enum
    required: false
    validation:
      values: [hourly, salary, per_mile, per_trip]

  - name: pay_rate
    type: decimal
    required: false

  # Certifications
  - name: certifications
    type: array
    required: false
    description: Professional certifications
    example:
      - type: "hazmat"
        number: "HAZ-12345"
        issued_date: "2023-01-15"
        expiry_date: "2025-01-15"
        status: "active"
      - type: "defensive_driving"
        number: "DD-67890"
        issued_date: "2023-06-01"
        expiry_date: "2025-06-01"
        status: "active"

  - name: defensive_driving_certified
    type: boolean
    required: true
    default: false

  - name: hazmat_certified
    type: boolean
    required: true
    default: false

  - name: first_aid_certified
    type: boolean
    required: true
    default: false

  - name: tanker_certified
    type: boolean
    required: true
    default: false

  # Performance Metrics
  - name: total_trips
    type: integer
    required: true
    default: 0

  - name: total_distance_km
    type: decimal
    required: true
    default: 0

  - name: safety_score
    type: decimal
    required: false
    description: 0-100 safety rating

  - name: on_time_delivery_rate
    type: decimal
    required: false
    description: Percentage

  - name: fuel_efficiency_score
    type: decimal
    required: false

  - name: customer_rating
    type: decimal
    required: false
    description: Average customer rating 1-5

  - name: accidents_count
    type: integer
    required: true
    default: 0

  - name: violations_count
    type: integer
    required: true
    default: 0

  # Current Status
  - name: duty_status
    type: enum
    required: true
    validation:
      values: [off_duty, sleeper_berth, driving, on_duty_not_driving]
    default: off_duty

  - name: current_vehicle_id
    type: uuid
    required: false

  - name: current_trip_id
    type: uuid
    required: false

  - name: current_lat
    type: decimal
    required: false

  - name: current_lng
    type: decimal
    required: false

  - name: last_activity_at
    type: timestamp
    required: false

  - name: is_available
    type: boolean
    required: true
    default: true

  # Hours of Service (HOS)
  - name: hos_cycle_type
    type: enum
    required: true
    validation:
      values: [7_day_60_hour, 8_day_70_hour]
    default: 8_day_70_hour

  - name: available_drive_hours
    type: decimal
    required: false
    description: Remaining driving hours today

  - name: available_duty_hours
    type: decimal
    required: false
    description: Remaining on-duty hours today

  - name: available_cycle_hours
    type: decimal
    required: false
    description: Remaining hours in cycle

  - name: last_34_hour_reset
    type: timestamp
    required: false

  - name: last_30_min_break
    type: timestamp
    required: false

  - name: consecutive_driving_minutes
    type: integer
    required: false

  # Medical
  - name: medical_certificate_expiry
    type: date
    required: true

  - name: medical_restrictions
    type: array
    required: false

  - name: drug_test_date
    type: date
    required: false

  - name: drug_test_result
    type: enum
    required: false
    validation:
      values: [passed, failed, pending]

  # Equipment
  - name: assigned_vehicle_id
    type: uuid
    required: false
    description: Primary assigned vehicle

  - name: eld_device_id
    type: string
    required: false

  - name: mobile_device_id
    type: string
    required: false

  # Notes
  - name: notes
    type: text
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: user
    type: belongs_to
    entity: User
    required: true

  - name: home_depot
    type: belongs_to
    entity: Depot
    required: true

  - name: supervisor
    type: belongs_to
    entity: Driver
    required: false

  - name: assigned_vehicle
    type: belongs_to
    entity: Vehicle
    required: false

  - name: current_vehicle
    type: belongs_to
    entity: Vehicle
    required: false

  - name: current_trip
    type: belongs_to
    entity: Trip
    required: false

  - name: trips
    type: has_many
    entity: Trip

  - name: incidents
    type: has_many
    entity: Incident

  - name: driver_behaviors
    type: has_many
    entity: DriverBehavior

  - name: fuel_logs
    type: has_many
    entity: FuelLog

  - name: inspections
    type: has_many
    entity: VehicleInspection

indexes:
  - [driver_id]
  - [employee_id]
  - [license_number]
  - [status]
  - [home_depot_id, status]
  - [duty_status]
  - [is_available]
  - [safety_score]

computed_fields:
  - name: full_name
    formula: first_name + ' ' + last_name
  - name: age
    formula: (today() - date_of_birth) / 365
  - name: tenure_years
    formula: (today() - hire_date) / 365
  - name: days_until_license_expiry
    formula: license_expiry - today()
  - name: days_until_medical_expiry
    formula: medical_certificate_expiry - today()
  - name: can_drive_hazmat
    formula: hazmat_certified AND 'H' IN endorsements

state_machine:
  initial: active
  states:
    - name: active
      description: Employed and eligible to drive
    - name: inactive
      description: Temporarily not working
    - name: suspended
      description: Suspended pending investigation
    - name: terminated
      description: No longer employed
  transitions:
    - from: active
      to: inactive
      trigger: deactivate
    - from: active
      to: suspended
      trigger: suspend
      conditions: [safety_violation OR license_suspended]
    - from: inactive
      to: active
      trigger: reactivate
    - from: suspended
      to: active
      trigger: reinstate
    - from: suspended
      to: terminated
      trigger: terminate
    - from: [active, inactive]
      to: terminated
      trigger: terminate

business_rules:
  - BR-DRV-001: License must be valid for trip assignment
  - BR-DRV-002: Medical certificate must be valid
  - BR-DRV-003: HOS limits must not be exceeded
  - BR-DRV-004: Hazmat loads require H endorsement
  - BR-DRV-005: Safety score below 50 triggers review

events:
  - name: driver.created
    payload: [id, driver_id, license_class]
  - name: driver.duty_status_changed
    payload: [id, old_status, new_status]
  - name: driver.hos_violation
    payload: [id, violation_type, details]
  - name: driver.document_expiring
    payload: [id, document_type, expiry_date]
  - name: driver.safety_alert
    payload: [id, alert_type, safety_score]
