name: Trip
display_name: Trip
description: |
  Delivery or service trip from origin to destination.
  Tracks vehicle, driver, route, stops, and completion status.

domain: logistics
subdomain: fleet
category: core

attributes:
  - name: id
    type: uuid
    required: true

  - name: trip_number
    type: string
    required: true
    validation:
      pattern: "^TRP-[0-9]{6}$"
    example: "TRP-000001"

  - name: status
    type: enum
    required: true
    validation:
      values: [planned, dispatched, in_progress, completed, cancelled, failed]
    default: planned

  # Assignment
  - name: vehicle_id
    type: uuid
    required: true

  - name: driver_id
    type: uuid
    required: true

  - name: route_id
    type: uuid
    required: false

  - name: dispatcher_id
    type: uuid
    required: false

  # Trip Type
  - name: trip_type
    type: enum
    required: true
    validation:
      values: [delivery, pickup, service, transfer, repositioning]

  - name: priority
    type: enum
    required: true
    validation:
      values: [low, normal, high, urgent]
    default: normal

  # Origin
  - name: origin_depot_id
    type: uuid
    required: true

  - name: origin_address
    type: object
    required: true
    example:
      line1: "100 Warehouse Blvd"
      city: "Los Angeles"
      state: "CA"
      postal_code: "90001"
      country: "US"
      lat: 34.0522
      lng: -118.2437

  # Destination
  - name: destination_address
    type: object
    required: false
    example:
      line1: "500 Customer Ave"
      city: "San Diego"
      state: "CA"
      postal_code: "92101"
      country: "US"
      lat: 32.7157
      lng: -117.1611

  # Timing - Planned
  - name: scheduled_departure
    type: timestamp
    required: true

  - name: scheduled_arrival
    type: timestamp
    required: true

  - name: estimated_duration_minutes
    type: integer
    required: false

  # Timing - Actual
  - name: actual_departure
    type: timestamp
    required: false

  - name: actual_arrival
    type: timestamp
    required: false

  - name: completed_at
    type: timestamp
    required: false

  # Distance
  - name: planned_distance_km
    type: decimal
    required: false

  - name: actual_distance_km
    type: decimal
    required: false

  # Stops
  - name: total_stops
    type: integer
    required: true
    default: 0

  - name: completed_stops
    type: integer
    required: true
    default: 0

  - name: failed_stops
    type: integer
    required: true
    default: 0

  # Load Information
  - name: load_type
    type: enum
    required: false
    validation:
      values: [full_truck, less_than_truck, partial, empty]

  - name: total_weight_kg
    type: decimal
    required: false

  - name: total_volume_cbm
    type: decimal
    required: false

  - name: total_pallets
    type: integer
    required: false

  - name: total_packages
    type: integer
    required: false

  - name: is_hazmat
    type: boolean
    required: true
    default: false

  - name: is_refrigerated
    type: boolean
    required: true
    default: false

  - name: temperature_required_c
    type: decimal
    required: false

  # Orders
  - name: order_ids
    type: array
    required: false
    description: List of order IDs for this trip

  - name: shipment_ids
    type: array
    required: false
    description: List of shipment IDs for this trip

  # Costs
  - name: fuel_cost
    type: decimal
    required: false

  - name: toll_cost
    type: decimal
    required: false

  - name: labor_cost
    type: decimal
    required: false

  - name: other_costs
    type: decimal
    required: false

  - name: total_cost
    type: decimal
    required: false

  # Revenue
  - name: revenue
    type: decimal
    required: false

  # Current Position (during trip)
  - name: current_lat
    type: decimal
    required: false

  - name: current_lng
    type: decimal
    required: false

  - name: current_stop_index
    type: integer
    required: false

  - name: eta_next_stop
    type: timestamp
    required: false

  - name: eta_destination
    type: timestamp
    required: false

  # Performance Metrics
  - name: on_time
    type: boolean
    required: false

  - name: delay_minutes
    type: integer
    required: false

  - name: idle_time_minutes
    type: integer
    required: false

  - name: driving_time_minutes
    type: integer
    required: false

  # Customer
  - name: customer_id
    type: uuid
    required: false

  - name: customer_rating
    type: decimal
    required: false
    description: Rating 1-5 from customer

  - name: customer_feedback
    type: text
    required: false

  # Proof of Delivery
  - name: pod_signature
    type: string
    required: false
    description: Signature image URL

  - name: pod_photos
    type: array
    required: false
    description: Delivery photo URLs

  - name: pod_notes
    type: text
    required: false

  # Exceptions
  - name: has_exceptions
    type: boolean
    required: true
    default: false

  - name: exception_details
    type: array
    required: false
    example:
      - type: "delay"
        reason: "traffic"
        impact_minutes: 30
      - type: "failed_delivery"
        reason: "customer_not_available"

  # Cancellation
  - name: cancellation_reason
    type: string
    required: false

  - name: cancelled_by
    type: uuid
    required: false

  - name: cancelled_at
    type: timestamp
    required: false

  # Notes
  - name: driver_notes
    type: text
    required: false

  - name: dispatcher_notes
    type: text
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: vehicle
    type: belongs_to
    entity: Vehicle
    required: true

  - name: driver
    type: belongs_to
    entity: Driver
    required: true

  - name: route
    type: belongs_to
    entity: Route
    required: false

  - name: origin_depot
    type: belongs_to
    entity: Depot
    required: true

  - name: dispatcher
    type: belongs_to
    entity: User
    required: false

  - name: customer
    type: belongs_to
    entity: Customer
    required: false

  - name: stops
    type: has_many
    entity: Stop

  - name: fuel_logs
    type: has_many
    entity: FuelLog

  - name: incidents
    type: has_many
    entity: Incident

  - name: gps_tracking
    type: has_many
    entity: GPSTracking

  - name: driver_behaviors
    type: has_many
    entity: DriverBehavior

  - name: toll_records
    type: has_many
    entity: TollRecord

indexes:
  - [trip_number]
  - [status]
  - [vehicle_id, status]
  - [driver_id, status]
  - [scheduled_departure]
  - [origin_depot_id]
  - [customer_id]
  - [trip_type, status]

computed_fields:
  - name: duration_minutes
    formula: (actual_arrival - actual_departure) / 60
  - name: distance_variance_km
    formula: actual_distance_km - planned_distance_km
  - name: on_time_status
    formula: actual_arrival <= scheduled_arrival
  - name: completion_rate
    formula: (completed_stops / total_stops) * 100
  - name: profit
    formula: revenue - total_cost

state_machine:
  initial: planned
  states:
    - name: planned
      description: Trip scheduled but not dispatched
    - name: dispatched
      description: Assigned to driver, pending start
    - name: in_progress
      description: Trip currently underway
    - name: completed
      description: All stops completed successfully
    - name: cancelled
      description: Trip cancelled before completion
    - name: failed
      description: Trip failed or abandoned
  transitions:
    - from: planned
      to: dispatched
      trigger: dispatch
      conditions: [vehicle_available, driver_available]
    - from: planned
      to: cancelled
      trigger: cancel
    - from: dispatched
      to: in_progress
      trigger: start
      actions: [update_vehicle_status, update_driver_status]
    - from: dispatched
      to: cancelled
      trigger: cancel
    - from: in_progress
      to: completed
      trigger: complete
      conditions: [all_stops_processed]
      actions: [calculate_costs, update_metrics]
    - from: in_progress
      to: failed
      trigger: fail
      conditions: [critical_exception]

business_rules:
  - BR-TRP-001: Vehicle must be available for dispatch
  - BR-TRP-002: Driver must have valid license and HOS hours
  - BR-TRP-003: Hazmat loads require certified driver and vehicle
  - BR-TRP-004: Refrigerated loads require reefer vehicle
  - BR-TRP-005: Trip cannot start without pre-trip inspection

events:
  - name: trip.created
    payload: [id, trip_number, vehicle_id, driver_id]
  - name: trip.dispatched
    payload: [id, vehicle_id, driver_id, scheduled_departure]
  - name: trip.started
    payload: [id, actual_departure, origin_lat, origin_lng]
  - name: trip.stop_completed
    payload: [id, stop_id, completed_stops, total_stops]
  - name: trip.completed
    payload: [id, actual_arrival, on_time, total_cost]
  - name: trip.delayed
    payload: [id, delay_minutes, reason]
  - name: trip.exception
    payload: [id, exception_type, details]
