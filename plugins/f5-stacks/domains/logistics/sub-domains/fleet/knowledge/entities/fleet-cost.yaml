name: FleetCost
display_name: Fleet Cost
description: |
  Aggregated cost tracking for fleet operations.
  Consolidates fuel, maintenance, tolls, and other expenses.

domain: logistics
subdomain: fleet
category: analytics

attributes:
  - name: id
    type: uuid
    required: true

  - name: cost_record_number
    type: string
    required: true
    validation:
      pattern: "^FC-[0-9]{8}$"
    example: "FC-00000001"

  # Scope
  - name: scope_type
    type: enum
    required: true
    validation:
      values: [vehicle, driver, trip, depot, fleet]

  - name: vehicle_id
    type: uuid
    required: false

  - name: driver_id
    type: uuid
    required: false

  - name: trip_id
    type: uuid
    required: false

  - name: depot_id
    type: uuid
    required: false

  # Period
  - name: period_type
    type: enum
    required: true
    validation:
      values: [daily, weekly, monthly, quarterly, yearly, custom]

  - name: period_start
    type: date
    required: true

  - name: period_end
    type: date
    required: true

  # Fuel Costs
  - name: fuel_cost
    type: decimal
    required: true
    default: 0

  - name: fuel_liters
    type: decimal
    required: false

  - name: fuel_transactions
    type: integer
    required: false

  - name: def_cost
    type: decimal
    required: false
    default: 0

  # Maintenance Costs
  - name: maintenance_cost
    type: decimal
    required: true
    default: 0

  - name: preventive_maintenance_cost
    type: decimal
    required: false

  - name: corrective_maintenance_cost
    type: decimal
    required: false

  - name: parts_cost
    type: decimal
    required: false

  - name: labor_cost
    type: decimal
    required: false

  - name: maintenance_count
    type: integer
    required: false

  # Toll Costs
  - name: toll_cost
    type: decimal
    required: true
    default: 0

  - name: toll_transactions
    type: integer
    required: false

  - name: toll_violations_cost
    type: decimal
    required: false
    default: 0

  # Insurance Costs
  - name: insurance_cost
    type: decimal
    required: true
    default: 0

  - name: insurance_premium
    type: decimal
    required: false

  - name: insurance_claims_cost
    type: decimal
    required: false

  - name: deductibles_paid
    type: decimal
    required: false

  # Registration & Licensing
  - name: registration_cost
    type: decimal
    required: true
    default: 0

  - name: permits_cost
    type: decimal
    required: false

  - name: license_fees
    type: decimal
    required: false

  # Labor Costs
  - name: driver_wages
    type: decimal
    required: true
    default: 0

  - name: driver_overtime
    type: decimal
    required: false

  - name: driver_benefits
    type: decimal
    required: false

  - name: driver_per_diem
    type: decimal
    required: false

  # Incident Costs
  - name: incident_cost
    type: decimal
    required: true
    default: 0

  - name: accident_cost
    type: decimal
    required: false

  - name: cargo_damage_cost
    type: decimal
    required: false

  - name: fine_cost
    type: decimal
    required: false

  # Depreciation
  - name: depreciation_cost
    type: decimal
    required: true
    default: 0

  # Lease/Rental
  - name: lease_cost
    type: decimal
    required: true
    default: 0

  - name: rental_cost
    type: decimal
    required: false

  # Other Costs
  - name: parking_cost
    type: decimal
    required: false
    default: 0

  - name: washing_cost
    type: decimal
    required: false
    default: 0

  - name: communication_cost
    type: decimal
    required: false
    default: 0
    description: GPS, telematics, mobile

  - name: other_cost
    type: decimal
    required: false
    default: 0

  - name: other_cost_details
    type: text
    required: false

  # Totals
  - name: total_fixed_cost
    type: decimal
    required: true
    default: 0
    description: Insurance, registration, depreciation, lease

  - name: total_variable_cost
    type: decimal
    required: true
    default: 0
    description: Fuel, maintenance, tolls

  - name: total_cost
    type: decimal
    required: true
    default: 0

  # Revenue (for profitability)
  - name: revenue
    type: decimal
    required: false
    default: 0

  - name: profit
    type: decimal
    required: false

  - name: profit_margin_percent
    type: decimal
    required: false

  # Efficiency Metrics
  - name: total_distance_km
    type: decimal
    required: false

  - name: total_trips
    type: integer
    required: false

  - name: total_stops
    type: integer
    required: false

  - name: total_driving_hours
    type: decimal
    required: false

  # Cost Ratios
  - name: cost_per_km
    type: decimal
    required: false

  - name: cost_per_trip
    type: decimal
    required: false

  - name: cost_per_stop
    type: decimal
    required: false

  - name: cost_per_hour
    type: decimal
    required: false

  - name: fuel_cost_per_km
    type: decimal
    required: false

  # Comparisons
  - name: budget_amount
    type: decimal
    required: false

  - name: budget_variance
    type: decimal
    required: false

  - name: budget_variance_percent
    type: decimal
    required: false

  - name: previous_period_cost
    type: decimal
    required: false

  - name: period_over_period_change
    type: decimal
    required: false

  # Currency
  - name: currency
    type: string
    required: true
    default: "USD"

  # Status
  - name: status
    type: enum
    required: true
    validation:
      values: [draft, calculated, verified, published]
    default: draft

  - name: verified_by
    type: uuid
    required: false

  - name: verified_at
    type: timestamp
    required: false

  # Notes
  - name: notes
    type: text
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

  - name: calculated_at
    type: timestamp
    required: false

relationships:
  - name: vehicle
    type: belongs_to
    entity: Vehicle
    required: false

  - name: driver
    type: belongs_to
    entity: Driver
    required: false

  - name: trip
    type: belongs_to
    entity: Trip
    required: false

  - name: depot
    type: belongs_to
    entity: Depot
    required: false

  - name: verified_by_user
    type: belongs_to
    entity: User
    required: false

indexes:
  - [cost_record_number]
  - [scope_type, period_start]
  - [vehicle_id, period_start]
  - [driver_id, period_start]
  - [depot_id, period_start]
  - [trip_id]
  - [period_type, period_start]
  - [status]

computed_fields:
  - name: total_operational_cost
    formula: fuel_cost + maintenance_cost + toll_cost + driver_wages
  - name: total_overhead_cost
    formula: insurance_cost + registration_cost + depreciation_cost + lease_cost
  - name: cost_efficiency_score
    formula: (budget_amount - total_cost) / budget_amount * 100

aggregations:
  - name: fleet_monthly_summary
    group_by: [month]
    fields: [total_cost, total_distance, total_trips, cost_per_km]
  - name: vehicle_comparison
    group_by: [vehicle_id, month]
    fields: [total_cost, cost_per_km, maintenance_cost]
  - name: cost_breakdown
    group_by: [scope_type, period_type]
    fields: [fuel_percent, maintenance_percent, labor_percent, other_percent]

business_rules:
  - BR-FC-001: Monthly costs calculated by 5th of following month
  - BR-FC-002: Variance >10% triggers review
  - BR-FC-003: Cost per km tracked against fleet average
  - BR-FC-004: Budget overruns notify fleet manager
  - BR-FC-005: Published costs cannot be modified without audit trail

events:
  - name: cost.calculated
    payload: [id, scope_type, period_start, total_cost]
  - name: cost.budget_exceeded
    payload: [id, scope_type, budget_amount, total_cost, variance_percent]
  - name: cost.anomaly_detected
    payload: [id, scope_type, cost_category, expected, actual]
  - name: cost.published
    payload: [id, scope_type, period_type, total_cost]
