name: VehicleInspection
display_name: Vehicle Inspection
description: |
  Pre-trip, post-trip, and periodic vehicle inspections.
  Documents vehicle condition and defects for compliance.

domain: logistics
subdomain: fleet
category: compliance

attributes:
  - name: id
    type: uuid
    required: true

  - name: inspection_number
    type: string
    required: true
    validation:
      pattern: "^INS-[0-9]{8}$"
    example: "INS-00000001"

  - name: vehicle_id
    type: uuid
    required: true

  - name: driver_id
    type: uuid
    required: true

  - name: trip_id
    type: uuid
    required: false

  - name: status
    type: enum
    required: true
    validation:
      values: [in_progress, passed, failed, pending_review]
    default: in_progress

  # Inspection Type
  - name: inspection_type
    type: enum
    required: true
    validation:
      values: [pre_trip, post_trip, dot_annual, quarterly, monthly, roadside]

  - name: is_regulatory
    type: boolean
    required: true
    default: false

  - name: regulation_type
    type: enum
    required: false
    validation:
      values: [dot, fmcsa, state]

  # Timing
  - name: inspection_date
    type: date
    required: true

  - name: started_at
    type: timestamp
    required: true

  - name: completed_at
    type: timestamp
    required: false

  - name: duration_minutes
    type: integer
    required: false

  # Location
  - name: location_type
    type: enum
    required: true
    validation:
      values: [depot, customer_site, roadside, inspection_station]

  - name: location_name
    type: string
    required: false

  - name: location_address
    type: object
    required: false

  - name: latitude
    type: decimal
    required: false

  - name: longitude
    type: decimal
    required: false

  # Vehicle State
  - name: odometer_reading
    type: decimal
    required: true

  - name: fuel_level_percent
    type: decimal
    required: false

  # Checklist
  - name: checklist_template_id
    type: uuid
    required: false

  - name: checklist_items
    type: array
    required: true
    example:
      - category: "exterior"
        item: "Headlights working"
        passed: true
        notes: null
      - category: "exterior"
        item: "Taillights working"
        passed: true
        notes: null
      - category: "tires"
        item: "Front left tire condition"
        passed: false
        notes: "Tread depth below minimum"
        defect_severity: "major"
      - category: "brakes"
        item: "Service brakes"
        passed: true
        notes: null

  # Results Summary
  - name: total_items
    type: integer
    required: true

  - name: passed_items
    type: integer
    required: true

  - name: failed_items
    type: integer
    required: true

  - name: not_applicable_items
    type: integer
    required: false
    default: 0

  # Defects
  - name: defects_found
    type: boolean
    required: true
    default: false

  - name: defects
    type: array
    required: false
    example:
      - category: "tires"
        description: "Front left tire tread below 4/32"
        severity: "major"
        corrective_action: "Replace tire"
        requires_immediate_attention: true
        photo_url: "https://..."

  - name: major_defects_count
    type: integer
    required: true
    default: 0

  - name: minor_defects_count
    type: integer
    required: true
    default: 0

  # Safety Decision
  - name: vehicle_safe_to_operate
    type: boolean
    required: true

  - name: out_of_service
    type: boolean
    required: true
    default: false

  - name: out_of_service_reason
    type: text
    required: false

  # Follow-up
  - name: repair_required
    type: boolean
    required: true
    default: false

  - name: maintenance_record_id
    type: uuid
    required: false
    description: Link to repair work order

  - name: repair_completed
    type: boolean
    required: false

  - name: repair_completed_at
    type: timestamp
    required: false

  # Signatures
  - name: inspector_signature_url
    type: string
    required: false

  - name: driver_signature_url
    type: string
    required: false

  - name: certifier_name
    type: string
    required: false
    description: For DOT inspections

  - name: certifier_id
    type: string
    required: false

  # Photos
  - name: photos
    type: array
    required: false
    description: General inspection photos

  - name: defect_photos
    type: array
    required: false

  # Documents
  - name: inspection_report_url
    type: string
    required: false

  - name: dot_form_url
    type: string
    required: false

  # Compliance
  - name: compliant
    type: boolean
    required: false

  - name: violations
    type: array
    required: false
    example:
      - code: "396.17"
        description: "Brake adjustment"
        severity: "critical"

  - name: fine_amount
    type: decimal
    required: false

  # Notes
  - name: inspector_notes
    type: text
    required: false

  - name: driver_comments
    type: text
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: vehicle
    type: belongs_to
    entity: Vehicle
    required: true

  - name: driver
    type: belongs_to
    entity: Driver
    required: true

  - name: trip
    type: belongs_to
    entity: Trip
    required: false

  - name: maintenance_record
    type: belongs_to
    entity: MaintenanceRecord
    required: false

  - name: checklist_template
    type: belongs_to
    entity: InspectionTemplate
    required: false

indexes:
  - [inspection_number]
  - [vehicle_id, inspection_date]
  - [driver_id, inspection_date]
  - [trip_id]
  - [status]
  - [inspection_type]
  - [defects_found]
  - [out_of_service]
  - [inspection_date]

computed_fields:
  - name: pass_rate
    formula: (passed_items / total_items) * 100
  - name: compliance_status
    formula: major_defects_count == 0 AND vehicle_safe_to_operate

state_machine:
  initial: in_progress
  states:
    - name: in_progress
      description: Inspection being conducted
    - name: passed
      description: All items passed or minor defects only
    - name: failed
      description: Major defects found
    - name: pending_review
      description: Requires supervisor review
  transitions:
    - from: in_progress
      to: passed
      trigger: complete
      conditions: [all_items_checked, no_major_defects]
    - from: in_progress
      to: failed
      trigger: complete
      conditions: [major_defects_found]
      actions: [update_vehicle_status, create_maintenance_record]
    - from: in_progress
      to: pending_review
      trigger: escalate
    - from: pending_review
      to: passed
      trigger: approve
    - from: pending_review
      to: failed
      trigger: reject

business_rules:
  - BR-INS-001: Pre-trip inspection required before each trip
  - BR-INS-002: Major defects render vehicle out of service
  - BR-INS-003: DOT annual inspection must be by certified inspector
  - BR-INS-004: Failed inspections block vehicle dispatch
  - BR-INS-005: Inspection records retained 90 days minimum

events:
  - name: inspection.started
    payload: [id, vehicle_id, driver_id, inspection_type]
  - name: inspection.passed
    payload: [id, vehicle_id, pass_rate]
  - name: inspection.failed
    payload: [id, vehicle_id, major_defects_count, defects]
  - name: inspection.out_of_service
    payload: [id, vehicle_id, reason]
