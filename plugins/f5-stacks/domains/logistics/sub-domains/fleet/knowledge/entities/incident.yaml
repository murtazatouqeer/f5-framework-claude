name: Incident
display_name: Incident
description: |
  Fleet incidents including accidents, breakdowns, thefts, and violations.
  Tracks details, investigations, and resolutions.

domain: logistics
subdomain: fleet
category: safety

attributes:
  - name: id
    type: uuid
    required: true

  - name: incident_number
    type: string
    required: true
    validation:
      pattern: "^INC-[0-9]{8}$"
    example: "INC-00000001"

  - name: status
    type: enum
    required: true
    validation:
      values: [reported, under_investigation, resolved, closed, reopened]
    default: reported

  # Incident Details
  - name: incident_type
    type: enum
    required: true
    validation:
      values: [accident, breakdown, theft, violation, near_miss, cargo_damage, injury, vandalism, fire, other]

  - name: severity
    type: enum
    required: true
    validation:
      values: [minor, moderate, major, critical]

  - name: title
    type: string
    required: true
    example: "Rear-end collision at intersection"

  - name: description
    type: text
    required: true

  # Timing
  - name: occurred_at
    type: timestamp
    required: true

  - name: reported_at
    type: timestamp
    required: true

  - name: discovered_at
    type: timestamp
    required: false
    description: For theft/damage discovered later

  # Location
  - name: location_description
    type: string
    required: false

  - name: address
    type: object
    required: false

  - name: latitude
    type: decimal
    required: false

  - name: longitude
    type: decimal
    required: false

  - name: road_name
    type: string
    required: false

  - name: mile_marker
    type: string
    required: false

  # Parties Involved
  - name: vehicle_id
    type: uuid
    required: true

  - name: driver_id
    type: uuid
    required: true

  - name: trip_id
    type: uuid
    required: false

  - name: reported_by
    type: uuid
    required: true

  # Other Parties (for accidents)
  - name: other_parties
    type: array
    required: false
    example:
      - type: "vehicle"
        name: "John Smith"
        contact: "+1-555-0123"
        vehicle_info: "Blue Toyota Camry, ABC-1234"
        insurance_company: "State Farm"
        insurance_policy: "POL-123456"
      - type: "pedestrian"
        name: "Jane Doe"
        contact: "+1-555-0124"
        injury_reported: true

  - name: witnesses
    type: array
    required: false
    example:
      - name: "Mike Johnson"
        contact: "+1-555-0125"
        statement: "I saw the other car run the red light"

  # Injuries
  - name: injuries_reported
    type: boolean
    required: true
    default: false

  - name: injury_details
    type: array
    required: false
    example:
      - person: "driver"
        type: "minor"
        description: "Whiplash"
        medical_attention: true

  - name: fatalities
    type: integer
    required: false
    default: 0

  # Damage
  - name: vehicle_damage
    type: boolean
    required: true
    default: false

  - name: vehicle_damage_description
    type: text
    required: false

  - name: vehicle_damage_photos
    type: array
    required: false

  - name: vehicle_driveable
    type: boolean
    required: false

  - name: cargo_damage
    type: boolean
    required: true
    default: false

  - name: cargo_damage_description
    type: text
    required: false

  - name: property_damage
    type: boolean
    required: true
    default: false

  - name: property_damage_description
    type: text
    required: false

  # Fault Determination
  - name: our_driver_at_fault
    type: boolean
    required: false

  - name: fault_percentage
    type: integer
    required: false
    validation:
      min: 0
      max: 100

  - name: fault_determination_notes
    type: text
    required: false

  # Police Report
  - name: police_called
    type: boolean
    required: true
    default: false

  - name: police_report_number
    type: string
    required: false

  - name: police_department
    type: string
    required: false

  - name: police_report_url
    type: string
    required: false

  - name: citation_issued
    type: boolean
    required: false

  - name: citation_details
    type: text
    required: false

  # Insurance
  - name: insurance_claim_filed
    type: boolean
    required: true
    default: false

  - name: insurance_claim_number
    type: string
    required: false

  - name: insurance_adjuster
    type: string
    required: false

  - name: insurance_status
    type: enum
    required: false
    validation:
      values: [pending, approved, denied, settled]

  # Costs
  - name: estimated_damage_cost
    type: decimal
    required: false

  - name: actual_repair_cost
    type: decimal
    required: false

  - name: medical_costs
    type: decimal
    required: false

  - name: third_party_costs
    type: decimal
    required: false

  - name: total_cost
    type: decimal
    required: false

  - name: insurance_payout
    type: decimal
    required: false

  - name: deductible_paid
    type: decimal
    required: false

  # Investigation
  - name: investigation_required
    type: boolean
    required: true
    default: false

  - name: investigator_id
    type: uuid
    required: false

  - name: investigation_started_at
    type: timestamp
    required: false

  - name: investigation_completed_at
    type: timestamp
    required: false

  - name: investigation_findings
    type: text
    required: false

  - name: root_cause
    type: string
    required: false

  # Evidence
  - name: photos
    type: array
    required: false

  - name: dashcam_video_url
    type: string
    required: false

  - name: witness_statements
    type: array
    required: false

  - name: driver_statement
    type: text
    required: false

  - name: documents
    type: array
    required: false

  # Corrective Actions
  - name: corrective_actions
    type: array
    required: false
    example:
      - action: "Driver coaching completed"
        assigned_to: "uuid"
        due_date: "2024-02-01"
        completed: true
        completed_at: "2024-01-28"

  - name: preventive_measures
    type: text
    required: false

  # Driver Impact
  - name: driver_suspended
    type: boolean
    required: true
    default: false

  - name: suspension_start_date
    type: date
    required: false

  - name: suspension_end_date
    type: date
    required: false

  - name: driver_safety_score_impact
    type: integer
    required: false

  # DOT Reportable
  - name: dot_reportable
    type: boolean
    required: true
    default: false

  - name: dot_report_number
    type: string
    required: false

  - name: dot_reported_at
    type: timestamp
    required: false

  # Resolution
  - name: resolved_at
    type: timestamp
    required: false

  - name: resolved_by
    type: uuid
    required: false

  - name: resolution_summary
    type: text
    required: false

  # Notes
  - name: notes
    type: text
    required: false

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: vehicle
    type: belongs_to
    entity: Vehicle
    required: true

  - name: driver
    type: belongs_to
    entity: Driver
    required: true

  - name: trip
    type: belongs_to
    entity: Trip
    required: false

  - name: reported_by_user
    type: belongs_to
    entity: User
    required: true

  - name: investigator
    type: belongs_to
    entity: User
    required: false

  - name: resolved_by_user
    type: belongs_to
    entity: User
    required: false

indexes:
  - [incident_number]
  - [vehicle_id, occurred_at]
  - [driver_id, occurred_at]
  - [trip_id]
  - [status]
  - [incident_type]
  - [severity]
  - [occurred_at]
  - [dot_reportable]
  - [our_driver_at_fault]

computed_fields:
  - name: days_open
    formula: (resolved_at OR today()) - occurred_at
  - name: net_cost
    formula: total_cost - insurance_payout

state_machine:
  initial: reported
  states:
    - name: reported
      description: Incident initially reported
    - name: under_investigation
      description: Investigation in progress
    - name: resolved
      description: Investigation complete, actions taken
    - name: closed
      description: Incident fully closed
    - name: reopened
      description: Incident reopened for additional review
  transitions:
    - from: reported
      to: under_investigation
      trigger: start_investigation
      conditions: [investigator_assigned]
    - from: reported
      to: resolved
      trigger: resolve
      conditions: [minor_incident]
    - from: under_investigation
      to: resolved
      trigger: complete_investigation
      conditions: [findings_documented]
    - from: resolved
      to: closed
      trigger: close
      conditions: [all_actions_complete, costs_settled]
    - from: closed
      to: reopened
      trigger: reopen

business_rules:
  - BR-INC-001: Critical incidents notify safety manager immediately
  - BR-INC-002: Fatalities require DOT reporting within 24 hours
  - BR-INC-003: Insurance claim required for damage >$500
  - BR-INC-004: At-fault accidents impact driver safety score
  - BR-INC-005: Investigation required for major/critical severity

events:
  - name: incident.reported
    payload: [id, vehicle_id, driver_id, incident_type, severity]
  - name: incident.critical
    payload: [id, vehicle_id, driver_id, location, injuries]
  - name: incident.investigation_complete
    payload: [id, findings, root_cause]
  - name: incident.resolved
    payload: [id, total_cost, corrective_actions]
