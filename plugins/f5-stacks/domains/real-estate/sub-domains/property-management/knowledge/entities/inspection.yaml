# Inspection Entity
# F5 Framework v2.0 - Real Estate/Property Management
# Kiểm tra / 点検

entity:
  name: Inspection
  name_vi: Kiểm tra
  name_ja: 点検
  domain: real-estate
  subdomain: property-management
  version: "1.0.0"

  description: |
    Represents a property or unit inspection, including move-in,
    move-out, routine, and complaint-driven inspections. Documents
    conditions and identifies required maintenance or charges.

  # Primary Key
  identifier:
    field: id
    type: uuid
    generated: true

  # Business Keys
  business_keys:
    inspection_id:
      pattern: "INS-{YYYYMMDD}-{XXXX}"
      example: "INS-20240115-0001"
      unique: true

  # Attributes
  attributes:
    # References
    property_id:
      type: uuid
      required: true
    unit_id:
      type: uuid
    lease_id:
      type: uuid
    tenant_id:
      type: uuid

    # Inspection Type
    inspection_type:
      type: enum
      values:
        - move_in
        - move_out
        - routine
        - annual
        - complaint
        - pre_listing
        - safety
        - insurance
      required: true
      name_vi:
        move_in: Nhận nhà
        move_out: Trả nhà
        routine: Định kỳ
        annual: Hàng năm
        complaint: Khiếu nại
        pre_listing: Trước khi đăng
        safety: An toàn
        insurance: Bảo hiểm

    # Status
    status:
      type: enum
      values:
        - scheduled
        - in_progress
        - completed
        - issues_found
        - cleared
        - cancelled
      default: scheduled
      name_vi:
        scheduled: Đã lên lịch
        in_progress: Đang thực hiện
        completed: Hoàn thành
        issues_found: Phát hiện vấn đề
        cleared: Đã xử lý
        cancelled: Đã hủy

    # Schedule
    schedule:
      type: object
      properties:
        scheduled_date:
          type: date
          required: true
        scheduled_time:
          type: time
        duration_minutes:
          type: integer
          default: 60
        actual_date:
          type: date
        actual_time:
          type: time

    # Participants
    participants:
      type: object
      properties:
        inspector_id:
          type: uuid
          required: true
        inspector_name:
          type: string
        tenant_present:
          type: boolean
        tenant_name:
          type: string
        owner_present:
          type: boolean
        other_participants:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              role:
                type: string

    # Checklist
    checklist:
      type: object
      properties:
        template_used:
          type: string
        items:
          type: array
          items:
            type: object
            properties:
              area:
                type: string
                examples: ["Living Room", "Kitchen", "Bathroom", "Bedroom"]
              item:
                type: string
                examples: ["Walls", "Floors", "Windows", "Appliances"]
              condition:
                type: enum
                values: [excellent, good, fair, poor, damaged, missing, na]
              previous_condition:
                type: enum
                values: [excellent, good, fair, poor, damaged, missing, na]
                description: "For comparison inspections"
              notes:
                type: string
              photo_urls:
                type: array
                items:
                  type: string
                  format: url
              action_required:
                type: boolean
                default: false
              action_description:
                type: string

    # Overall Assessment
    assessment:
      type: object
      properties:
        overall_condition:
          type: enum
          values: [excellent, good, fair, poor]
          name_vi:
            excellent: Xuất sắc
            good: Tốt
            fair: Trung bình
            poor: Kém
        cleanliness:
          type: enum
          values: [excellent, good, fair, poor]
        odor_issues:
          type: boolean
          default: false
        odor_description:
          type: string
        pest_evidence:
          type: boolean
          default: false
        pest_description:
          type: string
        safety_hazards:
          type: boolean
          default: false
        safety_hazard_description:
          type: string

    # Findings
    findings:
      type: object
      properties:
        issues_found:
          type: array
          items:
            type: object
            properties:
              issue_id:
                type: string
              area:
                type: string
              description:
                type: string
              severity:
                type: enum
                values: [critical, major, minor, cosmetic]
              photo_urls:
                type: array
                items:
                  type: string
              recommended_action:
                type: string
              estimated_cost:
                type: money
              responsibility:
                type: enum
                values: [landlord, tenant, normal_wear, pending]
              maintenance_request_id:
                type: uuid
        total_issues:
          type: integer
          computed: true
        critical_issues:
          type: integer
          computed: true

    # Meter Readings
    meter_readings:
      type: object
      properties:
        electricity:
          type: object
          properties:
            meter_number:
              type: string
            reading:
              type: decimal
            photo_url:
              type: string
        water:
          type: object
          properties:
            meter_number:
              type: string
            reading:
              type: decimal
            photo_url:
              type: string
        gas:
          type: object
          properties:
            meter_number:
              type: string
            reading:
              type: decimal
            photo_url:
              type: string

    # Key/Access Inventory
    keys:
      type: object
      properties:
        keys_issued:
          type: array
          items:
            type: object
            properties:
              key_type:
                type: string
                examples: ["Main door", "Mailbox", "Parking", "Storage"]
              quantity:
                type: integer
              received:
                type: boolean
              condition:
                type: string
        access_cards:
          type: array
          items:
            type: object
            properties:
              card_type:
                type: string
              card_number:
                type: string
              received:
                type: boolean
        remotes:
          type: array
          items:
            type: object
            properties:
              remote_type:
                type: string
              received:
                type: boolean

    # Documentation
    documentation:
      type: object
      properties:
        report_url:
          type: string
          format: url
        photos:
          type: array
          items:
            type: string
            format: url
        video_url:
          type: string
          format: url

    # Signatures
    signatures:
      type: object
      properties:
        inspector_signed:
          type: boolean
          default: false
        inspector_signature_url:
          type: string
        tenant_signed:
          type: boolean
          default: false
        tenant_signature_url:
          type: string
        tenant_comments:
          type: text
        landlord_signed:
          type: boolean
          default: false
        signed_date:
          type: date

    # Follow-Up
    follow_up:
      type: object
      properties:
        maintenance_requests_created:
          type: array
          items:
            type: uuid
        charges_to_tenant:
          type: array
          items:
            type: object
            properties:
              description:
                type: string
              amount:
                type: money
              charge_id:
                type: uuid
        deposit_deductions:
          type: array
          items:
            type: object
            properties:
              description:
                type: string
              amount:
                type: money
        total_tenant_charges:
          type: money
          computed: true

    # Comparison (for move-out)
    comparison:
      type: object
      applicable_when: "inspection_type == 'move_out'"
      properties:
        move_in_inspection_id:
          type: uuid
        comparison_report_url:
          type: string
        wear_and_tear_items:
          type: array
          items:
            type: string
        damage_items:
          type: array
          items:
            type: string

    # Metadata
    notes:
      type: text
    internal_notes:
      type: text
    created_at:
      type: timestamp
      auto: create
    updated_at:
      type: timestamp
      auto: update

  # Relationships
  relationships:
    property:
      type: belongs_to
      entity: ManagedProperty
      foreign_key: property_id
    unit:
      type: belongs_to
      entity: Unit
      foreign_key: unit_id
    lease:
      type: belongs_to
      entity: Lease
      foreign_key: lease_id
    tenant:
      type: belongs_to
      entity: Tenant
      foreign_key: tenant_id
    inspector:
      type: belongs_to
      entity: User
      foreign_key: inspector_id
    maintenance_requests:
      type: has_many
      entity: MaintenanceRequest
      foreign_key: inspection_id
    move_in_inspection:
      type: belongs_to
      entity: Inspection
      foreign_key: move_in_inspection_id

  # State Machine
  state_machine:
    field: status
    states:
      - scheduled
      - in_progress
      - completed
      - issues_found
      - cleared
      - cancelled
    transitions:
      - from: scheduled
        to: in_progress
        event: start
        action: record_start_time
      - from: scheduled
        to: cancelled
        event: cancel
      - from: in_progress
        to: completed
        event: complete
        guard: no_issues
        action: generate_report
      - from: in_progress
        to: issues_found
        event: complete_with_issues
        guard: has_issues
        action: [generate_report, create_maintenance_requests]
      - from: issues_found
        to: cleared
        event: clear
        guard: all_issues_resolved
      - from: completed
        to: issues_found
        event: reopen
        action: document_reason

  # Indexes
  indexes:
    - fields: [inspection_id]
      unique: true
    - fields: [property_id, scheduled_date]
    - fields: [unit_id, inspection_type]
    - fields: [lease_id, inspection_type]
    - fields: [status]
    - fields: [scheduled_date]
    - fields: [inspector_id]

  # Validation Rules
  validations:
    - rule: "actual_date must not be before scheduled_date"
      condition: "actual_date.nil? || actual_date >= scheduled_date"
    - rule: "tenant_signed required for move_in and move_out"
      condition: "!['move_in', 'move_out'].include?(inspection_type) || tenant_signed"

  # Events
  events:
    - inspection_scheduled
    - inspection_started
    - inspection_completed
    - issues_identified
    - report_generated
    - inspection_signed
    - issues_cleared
    - inspection_cancelled
    - maintenance_created_from_inspection

  # Audit
  audit:
    enabled: true
    tracked_fields:
      - status
      - checklist
      - findings
      - signatures
