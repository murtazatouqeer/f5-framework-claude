# Work Order Entity
# F5 Framework v2.0 - Real Estate/Property Management
# Lệnh công việc / 作業指示書

entity:
  name: WorkOrder
  name_vi: Lệnh công việc
  name_ja: 作業指示書
  domain: real-estate
  subdomain: property-management
  version: "1.0.0"

  description: |
    Represents a work order issued to a vendor or internal staff
    for maintenance, repair, or improvement work. Tracks scope,
    execution, billing, and payment.

  # Primary Key
  identifier:
    field: id
    type: uuid
    generated: true

  # Business Keys
  business_keys:
    work_order_number:
      pattern: "WO-{YYYYMMDD}-{XXXX}"
      example: "WO-20240115-0001"
      unique: true

  # Attributes
  attributes:
    # References
    maintenance_request_id:
      type: uuid
    property_id:
      type: uuid
      required: true
    unit_id:
      type: uuid

    # Status
    status:
      type: enum
      values:
        - created
        - sent
        - accepted
        - declined
        - in_progress
        - on_hold
        - completed
        - invoiced
        - paid
        - cancelled
      default: created
      name_vi:
        created: Đã tạo
        sent: Đã gửi
        accepted: Đã chấp nhận
        declined: Từ chối
        in_progress: Đang thực hiện
        on_hold: Tạm dừng
        completed: Hoàn thành
        invoiced: Đã xuất hóa đơn
        paid: Đã thanh toán
        cancelled: Đã hủy

    # Work Type
    work_type:
      type: enum
      values:
        - repair
        - replacement
        - installation
        - inspection
        - preventive_maintenance
        - emergency_repair
        - improvement
        - cleaning
      required: true
      name_vi:
        repair: Sửa chữa
        replacement: Thay thế
        installation: Lắp đặt
        inspection: Kiểm tra
        preventive_maintenance: Bảo trì định kỳ
        emergency_repair: Sửa chữa khẩn cấp
        improvement: Cải tiến
        cleaning: Vệ sinh

    # Priority
    priority:
      type: enum
      values: [emergency, urgent, normal, low]
      default: normal

    # Vendor/Assignee
    vendor:
      type: object
      properties:
        vendor_id:
          type: uuid
        vendor_name:
          type: string
        vendor_contact_name:
          type: string
        vendor_phone:
          type: string
        vendor_email:
          type: string
        assigned_technician:
          type: string
        is_internal_staff:
          type: boolean
          default: false
        staff_id:
          type: uuid

    # Scope
    scope:
      type: object
      properties:
        title:
          type: string
          max_length: 200
          required: true
        work_description:
          type: text
          required: true
        location:
          type: string
        special_instructions:
          type: text
        access_instructions:
          type: text
        materials_needed:
          type: array
          items:
            type: object
            properties:
              item:
                type: string
              quantity:
                type: integer
              provided_by:
                type: enum
                values: [vendor, property, tenant]
        estimated_hours:
          type: decimal
        estimated_cost:
          type: money
        not_to_exceed:
          type: money
          description: "Maximum cost without additional approval"

    # Schedule
    schedule:
      type: object
      properties:
        requested_date:
          type: date
        requested_time:
          type: string
        confirmed_date:
          type: date
        confirmed_time:
          type: string
        completion_deadline:
          type: date
        flexibility:
          type: enum
          values: [fixed, flexible, asap]

    # Execution
    execution:
      type: object
      properties:
        actual_start:
          type: timestamp
        actual_end:
          type: timestamp
        hours_worked:
          type: decimal
        work_performed:
          type: text
        materials_used:
          type: array
          items:
            type: object
            properties:
              item:
                type: string
              quantity:
                type: integer
              unit_cost:
                type: money
              total_cost:
                type: money
        issues_encountered:
          type: text
        additional_work_needed:
          type: boolean
          default: false
        additional_work_description:
          type: text
        completion_photos:
          type: array
          items:
            type: string
            format: url

    # Quality
    quality:
      type: object
      properties:
        quality_verified:
          type: boolean
          default: false
        verified_by:
          type: uuid
        verified_at:
          type: timestamp
        quality_notes:
          type: text
        rework_required:
          type: boolean
          default: false
        rework_notes:
          type: text

    # Billing
    billing:
      type: object
      properties:
        labor_rate:
          type: money
          description: "Hourly rate"
        labor_hours:
          type: decimal
        labor_cost:
          type: money
        materials_cost:
          type: money
        other_costs:
          type: money
        total_cost:
          type: money
          computed: true
          formula: "labor_cost + materials_cost + other_costs"
        tax_amount:
          type: money
        grand_total:
          type: money
          computed: true
          formula: "total_cost + tax_amount"
        charge_to:
          type: enum
          values: [owner, tenant, common_fund, warranty, insurance]
        approved_for_payment:
          type: boolean
          default: false
        approved_by:
          type: uuid
        approved_at:
          type: timestamp

    # Invoice
    invoice:
      type: object
      properties:
        invoice_number:
          type: string
        invoice_date:
          type: date
        invoice_url:
          type: string
          format: url
        invoice_due_date:
          type: date
        payment_terms:
          type: string
          examples: ["Net 30", "Due on receipt", "Net 15"]

    # Payment
    payment:
      type: object
      properties:
        payment_status:
          type: enum
          values: [unpaid, partial, paid]
        paid_amount:
          type: money
        paid_date:
          type: date
        payment_method:
          type: string
        payment_reference:
          type: string
        check_number:
          type: string

    # Warranty
    warranty:
      type: object
      properties:
        warranty_period_days:
          type: integer
        warranty_expiry:
          type: date
        warranty_terms:
          type: text
        warranty_claim_filed:
          type: boolean
          default: false

    # Metadata
    notes:
      type: text
    internal_notes:
      type: text
    created_at:
      type: timestamp
      auto: create
    updated_at:
      type: timestamp
      auto: update
    created_by:
      type: uuid

  # Relationships
  relationships:
    maintenance_request:
      type: belongs_to
      entity: MaintenanceRequest
      foreign_key: maintenance_request_id
    property:
      type: belongs_to
      entity: ManagedProperty
      foreign_key: property_id
    unit:
      type: belongs_to
      entity: Unit
      foreign_key: unit_id
    vendor:
      type: belongs_to
      entity: Vendor
      foreign_key: vendor_id

  # State Machine
  state_machine:
    field: status
    states:
      - created
      - sent
      - accepted
      - declined
      - in_progress
      - on_hold
      - completed
      - invoiced
      - paid
      - cancelled
    transitions:
      - from: created
        to: sent
        event: send
        action: notify_vendor
      - from: sent
        to: accepted
        event: accept
        action: update_maintenance_request
      - from: sent
        to: declined
        event: decline
        action: notify_manager
      - from: accepted
        to: in_progress
        event: start
        action: record_start_time
      - from: in_progress
        to: on_hold
        event: hold
      - from: on_hold
        to: in_progress
        event: resume
      - from: in_progress
        to: completed
        event: complete
        action: [record_completion, notify_manager]
      - from: completed
        to: invoiced
        event: invoice_received
        action: attach_invoice
      - from: invoiced
        to: paid
        event: pay
        action: record_payment
      - from: [created, sent, accepted]
        to: cancelled
        event: cancel
        action: notify_vendor

  # Indexes
  indexes:
    - fields: [work_order_number]
      unique: true
    - fields: [maintenance_request_id]
    - fields: [property_id, status]
    - fields: [vendor_id, status]
    - fields: [status]
    - fields: [confirmed_date]
    - fields: [invoice_due_date]

  # Validation Rules
  validations:
    - rule: "estimated_cost must be positive"
      condition: "estimated_cost.nil? || estimated_cost > 0"
    - rule: "actual_end must be after actual_start"
      condition: "actual_end.nil? || actual_end > actual_start"
    - rule: "paid_amount cannot exceed grand_total"
      condition: "paid_amount.nil? || paid_amount <= grand_total"

  # Events
  events:
    - work_order_created
    - work_order_sent
    - work_order_accepted
    - work_order_declined
    - work_started
    - work_on_hold
    - work_resumed
    - work_completed
    - invoice_received
    - payment_approved
    - payment_processed
    - work_order_cancelled

  # Audit
  audit:
    enabled: true
    tracked_fields:
      - status
      - vendor
      - schedule
      - execution
      - billing
      - payment
