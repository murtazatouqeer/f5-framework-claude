# Maintenance Request Entity
# F5 Framework v2.0 - Real Estate/Property Management
# Yêu cầu bảo trì / メンテナンス依頼

entity:
  name: MaintenanceRequest
  name_vi: Yêu cầu bảo trì
  name_ja: メンテナンス依頼
  domain: real-estate
  subdomain: property-management
  version: "1.0.0"

  description: |
    Represents a maintenance or repair request from tenants, staff,
    or identified during inspections. Tracks the full lifecycle from
    submission through resolution and tenant feedback.

  # Primary Key
  identifier:
    field: id
    type: uuid
    generated: true

  # Business Keys
  business_keys:
    request_id:
      pattern: "MNT-{YYYYMMDD}-{XXXX}"
      example: "MNT-20240115-0001"
      unique: true

  # Attributes
  attributes:
    # References
    property_id:
      type: uuid
      required: true
    unit_id:
      type: uuid
    tenant_id:
      type: uuid
    lease_id:
      type: uuid

    # Status
    status:
      type: enum
      values:
        - submitted
        - acknowledged
        - assessed
        - assigned
        - scheduled
        - in_progress
        - pending_parts
        - pending_approval
        - completed
        - verified
        - closed
        - cancelled
      default: submitted
      name_vi:
        submitted: Đã gửi
        acknowledged: Đã xác nhận
        assessed: Đã đánh giá
        assigned: Đã phân công
        scheduled: Đã lên lịch
        in_progress: Đang xử lý
        pending_parts: Chờ linh kiện
        pending_approval: Chờ duyệt
        completed: Hoàn thành
        verified: Đã xác minh
        closed: Đóng
        cancelled: Hủy

    # Priority
    priority:
      type: enum
      values:
        - emergency
        - urgent
        - normal
        - low
      default: normal
      name_vi:
        emergency: Khẩn cấp
        urgent: Gấp
        normal: Bình thường
        low: Thấp
      sla_hours:
        emergency: 4
        urgent: 24
        normal: 72
        low: 168

    # Issue Details
    issue:
      type: object
      properties:
        category:
          type: enum
          values:
            - plumbing
            - electrical
            - hvac
            - appliance
            - structural
            - pest_control
            - locksmith
            - cleaning
            - painting
            - flooring
            - general
            - safety
            - common_area
          required: true
          name_vi:
            plumbing: Ống nước
            electrical: Điện
            hvac: Điều hòa/Thông gió
            appliance: Thiết bị
            structural: Kết cấu
            pest_control: Diệt côn trùng
            locksmith: Khóa
            cleaning: Vệ sinh
            painting: Sơn
            flooring: Sàn
            general: Chung
            safety: An toàn
            common_area: Khu vực chung
        subcategory:
          type: string
          examples:
            - "Leaky faucet"
            - "Clogged drain"
            - "AC not cooling"
            - "Refrigerator not working"
        title:
          type: string
          max_length: 100
          required: true
        description:
          type: text
          required: true
        location_in_unit:
          type: string
          examples:
            - "Master bathroom"
            - "Kitchen"
            - "Living room"
            - "Balcony"

    # Reporting
    reporting:
      type: object
      properties:
        reported_by:
          type: enum
          values: [tenant, staff, owner, inspection, automated]
          required: true
        reported_at:
          type: timestamp
          required: true
        reported_via:
          type: enum
          values: [portal, phone, email, in_person, app]
        reporter_name:
          type: string
        reporter_phone:
          type: string
        reporter_email:
          type: string

    # Media
    media:
      type: object
      properties:
        photos:
          type: array
          items:
            type: string
            format: url
        videos:
          type: array
          items:
            type: string
            format: url
        voice_note_url:
          type: string
          format: url

    # Access
    access:
      type: object
      properties:
        permission_to_enter:
          type: boolean
          required: true
        entry_instructions:
          type: text
        pet_in_unit:
          type: boolean
        pet_instructions:
          type: string
        preferred_contact:
          type: string
        preferred_times:
          type: array
          items:
            type: string

    # Assignment
    assignment:
      type: object
      properties:
        assigned_to_type:
          type: enum
          values: [staff, vendor, unassigned]
        assigned_to_id:
          type: uuid
        assigned_to_name:
          type: string
        vendor_id:
          type: uuid
        assigned_at:
          type: timestamp
        assigned_by:
          type: uuid

    # Scheduling
    scheduling:
      type: object
      properties:
        scheduled_date:
          type: date
        scheduled_time_start:
          type: time
        scheduled_time_end:
          type: time
        appointment_confirmed:
          type: boolean
          default: false
        tenant_notified:
          type: boolean
          default: false
        reschedule_count:
          type: integer
          default: 0
        actual_visit_date:
          type: date
        actual_visit_time:
          type: time

    # Work Performed
    work_performed:
      type: object
      properties:
        diagnosis:
          type: text
        work_description:
          type: text
        parts_used:
          type: array
          items:
            type: object
            properties:
              part_name:
                type: string
              quantity:
                type: integer
              cost:
                type: money
        labor_hours:
          type: decimal
        completed_at:
          type: timestamp
        completed_by:
          type: uuid
        completion_photos:
          type: array
          items:
            type: string
            format: url
        follow_up_required:
          type: boolean
          default: false
        follow_up_notes:
          type: text

    # Cost
    cost:
      type: object
      properties:
        estimated_cost:
          type: money
        requires_approval:
          type: boolean
          default: false
        approval_threshold:
          type: money
        approved:
          type: boolean
        approved_by:
          type: uuid
        approved_at:
          type: timestamp
        actual_labor_cost:
          type: money
        actual_parts_cost:
          type: money
        actual_total_cost:
          type: money
          computed: true
          formula: "actual_labor_cost + actual_parts_cost"
        charged_to:
          type: enum
          values: [owner, tenant, common_fund, warranty, insurance]
          name_vi:
            owner: Chủ nhà
            tenant: Người thuê
            common_fund: Quỹ chung
            warranty: Bảo hành
            insurance: Bảo hiểm
        invoice_number:
          type: string
        invoice_url:
          type: string

    # SLA Tracking
    sla:
      type: object
      computed: true
      properties:
        sla_deadline:
          type: timestamp
        sla_met:
          type: boolean
        response_time_hours:
          type: decimal
        resolution_time_hours:
          type: decimal

    # Feedback
    feedback:
      type: object
      properties:
        satisfaction_rating:
          type: integer
          min: 1
          max: 5
        feedback_text:
          type: text
        feedback_date:
          type: timestamp
        would_recommend:
          type: boolean

    # Metadata
    internal_notes:
      type: text
    created_at:
      type: timestamp
      auto: create
    updated_at:
      type: timestamp
      auto: update

  # Relationships
  relationships:
    property:
      type: belongs_to
      entity: ManagedProperty
      foreign_key: property_id
    unit:
      type: belongs_to
      entity: Unit
      foreign_key: unit_id
    tenant:
      type: belongs_to
      entity: Tenant
      foreign_key: tenant_id
    lease:
      type: belongs_to
      entity: Lease
      foreign_key: lease_id
    work_orders:
      type: has_many
      entity: WorkOrder
      foreign_key: maintenance_request_id
    vendor:
      type: belongs_to
      entity: Vendor
      foreign_key: vendor_id
    assignee:
      type: belongs_to
      entity: User
      foreign_key: assigned_to_id

  # State Machine
  state_machine:
    field: status
    states:
      - submitted
      - acknowledged
      - assessed
      - assigned
      - scheduled
      - in_progress
      - pending_parts
      - pending_approval
      - completed
      - verified
      - closed
      - cancelled
    transitions:
      - from: submitted
        to: acknowledged
        event: acknowledge
        action: [send_acknowledgment, calculate_sla]
      - from: acknowledged
        to: assessed
        event: assess
        action: record_assessment
      - from: [acknowledged, assessed]
        to: assigned
        event: assign
        action: notify_assignee
      - from: assigned
        to: scheduled
        event: schedule
        action: notify_tenant
      - from: scheduled
        to: in_progress
        event: start_work
      - from: in_progress
        to: pending_parts
        event: await_parts
      - from: pending_parts
        to: in_progress
        event: parts_received
      - from: in_progress
        to: pending_approval
        event: request_approval
        guard: cost_exceeds_threshold
      - from: pending_approval
        to: in_progress
        event: approve
      - from: in_progress
        to: completed
        event: complete
        action: [record_completion, send_completion_notice]
      - from: completed
        to: verified
        event: verify
        guard: tenant_confirms
      - from: [completed, verified]
        to: closed
        event: close
        action: [request_feedback, update_metrics]
      - from: [submitted, acknowledged, assessed, assigned, scheduled]
        to: cancelled
        event: cancel
        action: notify_cancellation

  # Indexes
  indexes:
    - fields: [request_id]
      unique: true
    - fields: [property_id, status]
    - fields: [unit_id, status]
    - fields: [tenant_id]
    - fields: [priority, status]
    - fields: [assigned_to_id, status]
    - fields: [vendor_id, status]
    - fields: [category]
    - fields: [scheduled_date]

  # Validation Rules
  validations:
    - rule: "description must be provided"
      condition: "description.present?"
    - rule: "scheduled_time_end must be after scheduled_time_start"
      condition: "scheduled_time_end.nil? || scheduled_time_end > scheduled_time_start"
    - rule: "satisfaction_rating must be 1-5"
      condition: "satisfaction_rating.nil? || (satisfaction_rating >= 1 && satisfaction_rating <= 5)"

  # Events
  events:
    - request_submitted
    - request_acknowledged
    - request_assessed
    - request_assigned
    - request_scheduled
    - work_started
    - parts_ordered
    - parts_received
    - approval_requested
    - approval_granted
    - work_completed
    - tenant_verified
    - request_closed
    - request_cancelled
    - feedback_received
    - sla_breached

  # Audit
  audit:
    enabled: true
    tracked_fields:
      - status
      - priority
      - assignment
      - scheduling
      - work_performed
      - cost
