# Managed Property Entity
# F5 Framework v2.0 - Real Estate/Property Management
# Tài sản được quản lý / 管理物件

entity:
  name: ManagedProperty
  name_vi: Tài sản được quản lý
  name_ja: 管理物件
  domain: real-estate
  subdomain: property-management
  version: "1.0.0"

  description: |
    Represents a property under management, including buildings,
    complexes, or individual homes. Contains portfolio-level
    information, ownership details, and management agreements.

  # Primary Key
  identifier:
    field: id
    type: uuid
    generated: true

  # Business Keys
  business_keys:
    property_id:
      pattern: "MPR-{YYYYMMDD}-{XXXX}"
      example: "MPR-20240115-0001"
      unique: true
    property_code:
      type: string
      max_length: 20
      unique: true
      example: "SUNRISE-TOWER"

  # Attributes
  attributes:
    # Status
    status:
      type: enum
      values:
        - active
        - inactive
        - under_renovation
        - for_sale
      default: active
      name_vi:
        active: Đang hoạt động
        inactive: Ngừng hoạt động
        under_renovation: Đang sửa chữa
        for_sale: Đang bán

    # Property Type
    property_type:
      type: enum
      values:
        - apartment_building
        - condominium
        - single_family_house
        - townhouse
        - commercial_building
        - mixed_use
        - industrial
      required: true
      name_vi:
        apartment_building: Chung cư
        condominium: Căn hộ chung cư
        single_family_house: Nhà riêng
        townhouse: Nhà phố
        commercial_building: Tòa nhà thương mại
        mixed_use: Đa chức năng
        industrial: Công nghiệp

    # Location
    location:
      type: object
      properties:
        address:
          type: string
          required: true
        city:
          type: string
          required: true
        district:
          type: string
          required: true
        ward:
          type: string
        postal_code:
          type: string
        country:
          type: string
          default: "Vietnam"
        latitude:
          type: decimal
          precision: 8
        longitude:
          type: decimal
          precision: 8

    # Structure
    structure:
      type: object
      properties:
        total_units:
          type: integer
          min: 1
          required: true
        total_floors:
          type: integer
          min: 1
        year_built:
          type: integer
          min: 1900
        year_renovated:
          type: integer
        total_area_sqm:
          type: decimal
          precision: 2
        land_area_sqm:
          type: decimal
          precision: 2
        building_class:
          type: enum
          values: [A, B, C, D]

    # Ownership
    ownership:
      type: object
      properties:
        owner_id:
          type: uuid
          required: true
        owner_name:
          type: string
          required: true
        owner_type:
          type: enum
          values: [individual, company, trust, partnership]
        ownership_percent:
          type: decimal
          default: 100
        management_start_date:
          type: date
          required: true
        management_end_date:
          type: date
        management_agreement_url:
          type: string
          format: url

    # Management Fees
    management_fees:
      type: object
      properties:
        fee_type:
          type: enum
          values: [percentage, fixed, hybrid]
        management_fee_percent:
          type: decimal
          precision: 2
          description: "Percentage of collected rent"
        management_fee_fixed:
          type: money
          description: "Fixed monthly fee"
        collection_fee_percent:
          type: decimal
          precision: 2
          description: "Additional fee for rent collection"
        leasing_fee_percent:
          type: decimal
          description: "Fee for finding new tenants"

    # Amenities
    amenities:
      type: object
      properties:
        common_amenities:
          type: array
          items:
            type: string
          examples:
            - lobby
            - elevator
            - parking
            - swimming_pool
            - gym
            - playground
            - security_24h
            - cctv
        parking_spaces:
          type: integer
        has_elevator:
          type: boolean
          default: false
        has_pool:
          type: boolean
          default: false
        has_gym:
          type: boolean
          default: false
        has_security:
          type: boolean
          default: true

    # Staff
    staff:
      type: object
      properties:
        property_manager_id:
          type: uuid
        property_manager_name:
          type: string
        on_site_staff:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              role:
                type: string
              phone:
                type: string

    # Documents
    documents:
      type: object
      properties:
        legal_documents:
          type: array
          items:
            type: object
            properties:
              document_type:
                type: string
              document_url:
                type: string
              expiry_date:
                type: date
        certificate_number:
          type: string
          description: "Land use rights certificate number"
        insurance_policy_url:
          type: string
        insurance_provider:
          type: string
        insurance_expiry:
          type: date
        insurance_coverage_amount:
          type: money

    # Financial Summary (computed)
    financial_summary:
      type: object
      computed: true
      properties:
        total_potential_rent:
          type: money
        current_monthly_income:
          type: money
        vacancy_loss:
          type: money
        operating_expenses:
          type: money
        net_operating_income:
          type: money

    # Metadata
    notes:
      type: text
    created_at:
      type: timestamp
      auto: create
    updated_at:
      type: timestamp
      auto: update
    created_by:
      type: uuid
    updated_by:
      type: uuid

  # Relationships
  relationships:
    owner:
      type: belongs_to
      entity: Owner
      foreign_key: owner_id
    units:
      type: has_many
      entity: Unit
      foreign_key: property_id
    tenants:
      type: has_many_through
      entity: Tenant
      through: Lease
    leases:
      type: has_many_through
      entity: Lease
      through: Unit
    maintenance_requests:
      type: has_many
      entity: MaintenanceRequest
      foreign_key: property_id
    inspections:
      type: has_many
      entity: Inspection
      foreign_key: property_id
    expenses:
      type: has_many
      entity: Expense
      foreign_key: property_id
    property_manager:
      type: belongs_to
      entity: User
      foreign_key: property_manager_id

  # Computed Properties
  computed:
    occupancy_rate:
      formula: "(units.where(status: 'occupied').count / total_units) * 100"
      type: decimal
    vacancy_count:
      formula: "units.where(status: 'vacant').count"
      type: integer
    total_monthly_rent:
      formula: "leases.where(status: 'active').sum(:monthly_rent)"
      type: money

  # Indexes
  indexes:
    - fields: [property_id]
      unique: true
    - fields: [property_code]
      unique: true
    - fields: [owner_id]
    - fields: [property_manager_id]
    - fields: [status]
    - fields: [city, district]

  # Validation Rules
  validations:
    - rule: "management_end_date must be after management_start_date"
      condition: "management_end_date.nil? || management_end_date > management_start_date"
    - rule: "total_units must be positive"
      condition: "total_units > 0"
    - rule: "insurance must not be expired for active properties"
      condition: "status != 'active' || insurance_expiry.nil? || insurance_expiry > Date.today"

  # Events
  events:
    - property_registered
    - property_activated
    - property_deactivated
    - management_agreement_renewed
    - property_manager_changed
    - insurance_updated
    - ownership_transferred

  # Audit
  audit:
    enabled: true
    tracked_fields:
      - status
      - owner_id
      - property_manager_id
      - management_fees
      - insurance_expiry
