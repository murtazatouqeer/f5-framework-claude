# Lease Entity
# F5 Framework v2.0 - Real Estate/Property Management
# Hợp đồng thuê / リース契約

entity:
  name: Lease
  name_vi: Hợp đồng thuê
  name_ja: リース契約
  domain: real-estate
  subdomain: property-management
  version: "1.0.0"

  description: |
    Represents a rental lease agreement between landlord and tenant(s).
    Covers all terms, conditions, rent details, and lease lifecycle
    from draft through expiration or termination.

  # Primary Key
  identifier:
    field: id
    type: uuid
    generated: true

  # Business Keys
  business_keys:
    lease_id:
      pattern: "LSE-{YYYYMMDD}-{XXXX}"
      example: "LSE-20240115-0001"
      unique: true
    lease_number:
      type: string
      description: "Human-readable lease reference"

  # Attributes
  attributes:
    # References
    property_id:
      type: uuid
      required: true
    unit_id:
      type: uuid
      required: true

    # Status
    status:
      type: enum
      values:
        - draft
        - pending_signatures
        - active
        - expired
        - renewed
        - terminated
        - cancelled
      default: draft
      name_vi:
        draft: Bản nháp
        pending_signatures: Chờ ký
        active: Đang hiệu lực
        expired: Hết hạn
        renewed: Đã gia hạn
        terminated: Chấm dứt
        cancelled: Hủy bỏ

    # Lease Type
    lease_type:
      type: enum
      values:
        - fixed_term
        - month_to_month
        - short_term
      default: fixed_term
      name_vi:
        fixed_term: Có thời hạn
        month_to_month: Theo tháng
        short_term: Ngắn hạn

    # Parties
    parties:
      type: object
      properties:
        primary_tenant_id:
          type: uuid
          required: true
        tenant_ids:
          type: array
          items:
            type: uuid
          description: "All tenants on the lease"
        occupants:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              relationship:
                type: string
              date_of_birth:
                type: date
          description: "Non-tenant occupants"
        guarantor:
          type: object
          properties:
            name:
              type: string
            national_id:
              type: string
            phone:
              type: string
            address:
              type: string

    # Term
    term:
      type: object
      properties:
        start_date:
          type: date
          required: true
        end_date:
          type: date
          required: true
        term_months:
          type: integer
          computed: true
        move_in_date:
          type: date
        move_out_date:
          type: date
        actual_move_in:
          type: date
        actual_move_out:
          type: date

    # Rent
    rent:
      type: object
      properties:
        monthly_rent:
          type: money
          required: true
        rent_currency:
          type: string
          default: "VND"
        rent_due_day:
          type: integer
          min: 1
          max: 28
          default: 1
          description: "Day of month rent is due"
        grace_period_days:
          type: integer
          default: 5
        late_fee_type:
          type: enum
          values: [fixed, percentage, daily]
        late_fee_amount:
          type: money
        late_fee_percent:
          type: decimal
          precision: 2
        late_fee_daily:
          type: money
        late_fee_cap:
          type: money
        first_month_prorated:
          type: boolean
          default: false
        prorated_amount:
          type: money

    # Security Deposit
    deposit:
      type: object
      properties:
        security_deposit_amount:
          type: money
          required: true
        deposit_months:
          type: decimal
          description: "Equivalent months of rent"
        deposit_received_date:
          type: date
        deposit_receipt_number:
          type: string
        deposit_account_number:
          type: string
          description: "Escrow account"

    # Utilities
    utilities:
      type: object
      properties:
        utilities_included:
          type: array
          items:
            type: enum
            values: [water, electricity, gas, internet, cable, trash, management_fee]
          name_vi:
            water: Nước
            electricity: Điện
            gas: Gas
            internet: Internet
            cable: Truyền hình cáp
            trash: Rác
            management_fee: Phí quản lý
        utilities_tenant_pays:
          type: array
          items:
            type: enum
            values: [water, electricity, gas, internet, cable, trash, management_fee]
        utility_cap_amount:
          type: money
          description: "Maximum landlord pays"
        utility_billing_method:
          type: enum
          values: [included, separate_meter, ratio, flat_fee]

    # Rules and Restrictions
    rules:
      type: object
      properties:
        pets_allowed:
          type: boolean
          default: false
        pet_types_allowed:
          type: array
          items:
            type: string
        pet_deposit:
          type: money
        pet_rent:
          type: money
        max_pets:
          type: integer
        smoking_allowed:
          type: boolean
          default: false
        subletting_allowed:
          type: boolean
          default: false
        max_occupants:
          type: integer
        quiet_hours:
          type: string
          example: "22:00-07:00"
        additional_rules:
          type: array
          items:
            type: string

    # Renewal Terms
    renewal:
      type: object
      properties:
        auto_renew:
          type: boolean
          default: false
        renewal_notice_days:
          type: integer
          default: 30
          description: "Days before expiry to decide"
        rent_increase_percent:
          type: decimal
          precision: 2
        rent_increase_cap:
          type: decimal
          precision: 2
          description: "Maximum increase percentage"
        renewal_term_months:
          type: integer
        month_to_month_after_expiry:
          type: boolean
          default: true

    # Documents
    documents:
      type: object
      properties:
        lease_document_url:
          type: string
          format: url
        addendums:
          type: array
          items:
            type: object
            properties:
              title:
                type: string
              document_url:
                type: string
              signed_date:
                type: date
        move_in_inspection_url:
          type: string
        move_out_inspection_url:
          type: string

    # Signatures
    signatures:
      type: object
      properties:
        landlord_signed:
          type: boolean
          default: false
        landlord_signed_at:
          type: timestamp
        landlord_signer_name:
          type: string
        tenant_signed:
          type: boolean
          default: false
        tenant_signed_at:
          type: timestamp
        all_tenants_signed:
          type: boolean
          default: false
        signed_at:
          type: timestamp
          description: "When fully executed"

    # Termination
    termination:
      type: object
      applicable_when: "status == 'terminated'"
      properties:
        termination_type:
          type: enum
          values: [mutual, tenant_notice, landlord_notice, eviction, lease_violation, early_termination]
        termination_reason:
          type: text
        notice_given_date:
          type: date
        effective_termination_date:
          type: date
        early_termination_fee:
          type: money
        fee_waived:
          type: boolean
          default: false

    # Financial Summary (computed)
    financial_summary:
      type: object
      computed: true
      properties:
        total_rent_collected:
          type: money
        total_late_fees_collected:
          type: money
        outstanding_balance:
          type: money
        deposit_status:
          type: string

    # Metadata
    notes:
      type: text
    created_at:
      type: timestamp
      auto: create
    updated_at:
      type: timestamp
      auto: update
    created_by:
      type: uuid

  # Relationships
  relationships:
    property:
      type: belongs_to
      entity: ManagedProperty
      foreign_key: property_id
    unit:
      type: belongs_to
      entity: Unit
      foreign_key: unit_id
    primary_tenant:
      type: belongs_to
      entity: Tenant
      foreign_key: primary_tenant_id
    tenants:
      type: has_many_through
      entity: Tenant
      through: LeaseTenant
    rent_charges:
      type: has_many
      entity: RentCharge
      foreign_key: lease_id
    payments:
      type: has_many
      entity: RentPayment
      foreign_key: lease_id
    security_deposit:
      type: has_one
      entity: SecurityDeposit
      foreign_key: lease_id
    inspections:
      type: has_many
      entity: Inspection
      foreign_key: lease_id
    move_in_out:
      type: has_many
      entity: MoveInOut
      foreign_key: lease_id
    renewed_from:
      type: belongs_to
      entity: Lease
      foreign_key: renewed_from_lease_id
    renewed_to:
      type: has_one
      entity: Lease
      foreign_key: renewed_from_lease_id

  # State Machine
  state_machine:
    field: status
    states:
      - draft
      - pending_signatures
      - active
      - expired
      - renewed
      - terminated
      - cancelled
    transitions:
      - from: draft
        to: pending_signatures
        event: send_for_signature
        guard: all_required_fields_complete
        action: generate_lease_document
      - from: draft
        to: cancelled
        event: cancel
      - from: pending_signatures
        to: active
        event: activate
        guard: all_signatures_collected
        action: [update_unit_status, create_initial_charges]
      - from: pending_signatures
        to: draft
        event: revise
      - from: pending_signatures
        to: cancelled
        event: cancel
      - from: active
        to: expired
        event: expire
        guard: past_end_date
        action: convert_to_month_to_month_if_configured
      - from: active
        to: renewed
        event: renew
        action: create_renewal_lease
      - from: active
        to: terminated
        event: terminate
        action: [process_termination, schedule_move_out]
      - from: expired
        to: renewed
        event: renew
        action: create_renewal_lease
      - from: expired
        to: terminated
        event: terminate

  # Indexes
  indexes:
    - fields: [lease_id]
      unique: true
    - fields: [property_id, unit_id]
    - fields: [primary_tenant_id]
    - fields: [status]
    - fields: [start_date, end_date]
    - fields: [end_date]
      name: expiring_leases

  # Validation Rules
  validations:
    - rule: "end_date must be after start_date"
      condition: "end_date > start_date"
    - rule: "monthly_rent must be positive"
      condition: "monthly_rent > 0"
    - rule: "security_deposit must be non-negative"
      condition: "security_deposit_amount >= 0"
    - rule: "grace_period must be reasonable"
      condition: "grace_period_days >= 0 && grace_period_days <= 15"
    - rule: "rent_due_day must be valid"
      condition: "rent_due_day >= 1 && rent_due_day <= 28"

  # Events
  events:
    - lease_created
    - lease_sent_for_signature
    - lease_signed
    - lease_activated
    - lease_expired
    - lease_renewed
    - lease_terminated
    - rent_increased
    - addendum_added

  # Audit
  audit:
    enabled: true
    tracked_fields:
      - status
      - rent
      - term
      - termination
      - signatures
