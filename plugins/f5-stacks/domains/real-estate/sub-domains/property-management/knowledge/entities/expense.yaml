# Expense Entity
# F5 Framework v2.0 - Real Estate/Property Management
# Chi phí / 経費

entity:
  name: Expense
  name_vi: Chi phí
  name_ja: 経費
  domain: real-estate
  subdomain: property-management
  version: "1.0.0"

  description: |
    Represents expenses incurred for property management, including
    maintenance, utilities, insurance, and other operating costs.
    Tracks allocation, approval, and payment status.

  # Primary Key
  identifier:
    field: id
    type: uuid
    generated: true

  # Business Keys
  business_keys:
    expense_id:
      pattern: "EXP-{YYYYMM}-{XXXXX}"
      example: "EXP-202401-00001"
      unique: true

  # Attributes
  attributes:
    # References
    property_id:
      type: uuid
      required: true
    unit_id:
      type: uuid
      description: "Null for property-wide expenses"
    vendor_id:
      type: uuid
    work_order_id:
      type: uuid
    maintenance_request_id:
      type: uuid

    # Expense Category
    category:
      type: enum
      values:
        - maintenance_repair
        - utilities
        - insurance
        - property_tax
        - management_fee
        - legal
        - advertising
        - cleaning
        - landscaping
        - security
        - capital_improvement
        - supplies
        - professional_services
        - administrative
        - other
      required: true
      name_vi:
        maintenance_repair: Bảo trì sửa chữa
        utilities: Tiện ích
        insurance: Bảo hiểm
        property_tax: Thuế tài sản
        management_fee: Phí quản lý
        legal: Pháp lý
        advertising: Quảng cáo
        cleaning: Vệ sinh
        landscaping: Cảnh quan
        security: An ninh
        capital_improvement: Cải tạo
        supplies: Vật tư
        professional_services: Dịch vụ chuyên nghiệp
        administrative: Hành chính
        other: Khác

    # Subcategory
    subcategory:
      type: string
      examples:
        - "Plumbing repair"
        - "Electricity bill"
        - "Property liability insurance"
        - "Legal consultation"

    # Status
    status:
      type: enum
      values:
        - pending
        - approved
        - rejected
        - paid
        - partially_paid
        - cancelled
        - reimbursed
      default: pending
      name_vi:
        pending: Chờ duyệt
        approved: Đã duyệt
        rejected: Từ chối
        paid: Đã thanh toán
        partially_paid: Thanh toán một phần
        cancelled: Đã hủy
        reimbursed: Đã hoàn

    # Expense Details
    details:
      type: object
      properties:
        description:
          type: string
          max_length: 500
          required: true
        expense_date:
          type: date
          required: true
        due_date:
          type: date
        recurring:
          type: boolean
          default: false
        recurrence_pattern:
          type: enum
          values: [monthly, quarterly, semi_annual, annual]
          applicable_when: "recurring == true"
        next_occurrence:
          type: date
          applicable_when: "recurring == true"

    # Amount
    amount:
      type: object
      properties:
        gross_amount:
          type: money
          required: true
        tax_amount:
          type: money
          default: 0
        total_amount:
          type: money
          computed: true
          formula: "gross_amount + tax_amount"
        currency:
          type: string
          default: "VND"

    # Allocation
    allocation:
      type: object
      properties:
        charged_to:
          type: enum
          values:
            - owner
            - tenant
            - common_fund
            - insurance_claim
            - warranty
          required: true
          name_vi:
            owner: Chủ nhà
            tenant: Người thuê
            common_fund: Quỹ chung
            insurance_claim: Bảo hiểm
            warranty: Bảo hành
        unit_allocation:
          type: array
          items:
            type: object
            properties:
              unit_id:
                type: uuid
              amount:
                type: money
              percentage:
                type: decimal
          description: "For expenses split across units"
        owner_portion:
          type: money
        tenant_portion:
          type: money
        reimbursable:
          type: boolean
          default: false

    # Vendor/Payee
    payee:
      type: object
      properties:
        payee_type:
          type: enum
          values: [vendor, employee, utility_company, government, other]
        payee_name:
          type: string
          required: true
        payee_account:
          type: string
        payee_tax_id:
          type: string

    # Invoice
    invoice:
      type: object
      properties:
        invoice_number:
          type: string
        invoice_date:
          type: date
        invoice_url:
          type: string
          format: url
        receipt_url:
          type: string
          format: url

    # Approval
    approval:
      type: object
      properties:
        requires_approval:
          type: boolean
          default: true
        approval_threshold:
          type: money
        approved:
          type: boolean
          default: false
        approved_by:
          type: uuid
        approved_at:
          type: timestamp
        approval_notes:
          type: text
        rejection_reason:
          type: text

    # Payment
    payment:
      type: object
      properties:
        payment_method:
          type: enum
          values: [bank_transfer, check, cash, credit_card, auto_debit]
        payment_date:
          type: date
        payment_reference:
          type: string
        check_number:
          type: string
        amount_paid:
          type: money
        balance_due:
          type: money
          computed: true
          formula: "total_amount - amount_paid"
        paid_from_account:
          type: string

    # Budget
    budget:
      type: object
      properties:
        budget_category:
          type: string
        budgeted_amount:
          type: money
        within_budget:
          type: boolean
          computed: true
        variance:
          type: money
          computed: true

    # Tax
    tax:
      type: object
      properties:
        tax_deductible:
          type: boolean
          default: true
        tax_category:
          type: string
        vat_invoice_number:
          type: string
        vat_rate:
          type: decimal

    # Documentation
    documents:
      type: object
      properties:
        supporting_documents:
          type: array
          items:
            type: object
            properties:
              document_type:
                type: string
              document_url:
                type: string
              upload_date:
                type: date

    # Metadata
    notes:
      type: text
    internal_notes:
      type: text
    created_at:
      type: timestamp
      auto: create
    updated_at:
      type: timestamp
      auto: update
    created_by:
      type: uuid

  # Relationships
  relationships:
    property:
      type: belongs_to
      entity: ManagedProperty
      foreign_key: property_id
    unit:
      type: belongs_to
      entity: Unit
      foreign_key: unit_id
    vendor:
      type: belongs_to
      entity: Vendor
      foreign_key: vendor_id
    work_order:
      type: belongs_to
      entity: WorkOrder
      foreign_key: work_order_id
    maintenance_request:
      type: belongs_to
      entity: MaintenanceRequest
      foreign_key: maintenance_request_id
    approved_by_user:
      type: belongs_to
      entity: User
      foreign_key: approved_by

  # State Machine
  state_machine:
    field: status
    states:
      - pending
      - approved
      - rejected
      - paid
      - partially_paid
      - cancelled
      - reimbursed
    transitions:
      - from: pending
        to: approved
        event: approve
        guard: has_approval_permission
        action: record_approval
      - from: pending
        to: rejected
        event: reject
        action: record_rejection
      - from: approved
        to: paid
        event: pay
        guard: full_payment
        action: record_payment
      - from: approved
        to: partially_paid
        event: partial_pay
        action: record_partial_payment
      - from: partially_paid
        to: paid
        event: complete_payment
        guard: balance_zero
      - from: paid
        to: reimbursed
        event: reimburse
        guard: reimbursable_expense
      - from: [pending, approved]
        to: cancelled
        event: cancel

  # Computed Properties
  computed:
    balance_due:
      formula: "total_amount - (amount_paid || 0)"
      type: money
    is_overdue:
      formula: "status in ['pending', 'approved', 'partially_paid'] && due_date < Date.today"
      type: boolean

  # Indexes
  indexes:
    - fields: [expense_id]
      unique: true
    - fields: [property_id, expense_date]
    - fields: [property_id, category]
    - fields: [vendor_id]
    - fields: [status]
    - fields: [expense_date]
    - fields: [due_date, status]
    - fields: [category, expense_date]

  # Validation Rules
  validations:
    - rule: "gross_amount must be positive"
      condition: "gross_amount > 0"
    - rule: "amount_paid cannot exceed total_amount"
      condition: "amount_paid.nil? || amount_paid <= total_amount"
    - rule: "approval required for expenses above threshold"
      condition: "total_amount <= approval_threshold || approved"

  # Events
  events:
    - expense_created
    - expense_approved
    - expense_rejected
    - expense_paid
    - expense_partially_paid
    - expense_cancelled
    - expense_reimbursed
    - recurring_expense_generated

  # Audit
  audit:
    enabled: true
    tracked_fields:
      - status
      - amount
      - allocation
      - approval
      - payment
