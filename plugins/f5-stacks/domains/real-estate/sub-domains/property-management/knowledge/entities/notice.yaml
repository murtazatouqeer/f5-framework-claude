# Notice Entity
# F5 Framework v2.0 - Real Estate/Property Management
# Thông báo / 通知

entity:
  name: Notice
  name_vi: Thông báo
  name_ja: 通知
  domain: real-estate
  subdomain: property-management
  version: "1.0.0"

  description: |
    Represents formal notices sent to tenants or from tenants,
    including rent increases, lease violations, eviction notices,
    and other legal communications.

  # Primary Key
  identifier:
    field: id
    type: uuid
    generated: true

  # Business Keys
  business_keys:
    notice_id:
      pattern: "NTC-{YYYYMMDD}-{XXXX}"
      example: "NTC-20240115-0001"
      unique: true

  # Attributes
  attributes:
    # References
    property_id:
      type: uuid
      required: true
    unit_id:
      type: uuid
    lease_id:
      type: uuid
    tenant_id:
      type: uuid

    # Notice Direction
    direction:
      type: enum
      values:
        - to_tenant
        - from_tenant
      required: true
      name_vi:
        to_tenant: Gửi đến người thuê
        from_tenant: Từ người thuê

    # Notice Type
    notice_type:
      type: enum
      values:
        - rent_increase
        - lease_renewal
        - non_renewal
        - notice_to_vacate
        - notice_to_quit
        - lease_violation
        - pay_or_quit
        - cure_or_quit
        - entry_notice
        - inspection_notice
        - maintenance_notice
        - policy_change
        - general_communication
        - eviction_warning
        - eviction_notice
      required: true
      name_vi:
        rent_increase: Tăng tiền thuê
        lease_renewal: Gia hạn hợp đồng
        non_renewal: Không gia hạn
        notice_to_vacate: Thông báo dọn đi
        notice_to_quit: Yêu cầu rời đi
        lease_violation: Vi phạm hợp đồng
        pay_or_quit: Thanh toán hoặc dọn đi
        cure_or_quit: Khắc phục hoặc dọn đi
        entry_notice: Thông báo vào nhà
        inspection_notice: Thông báo kiểm tra
        maintenance_notice: Thông báo bảo trì
        policy_change: Thay đổi chính sách
        general_communication: Thông báo chung
        eviction_warning: Cảnh báo thu hồi
        eviction_notice: Thông báo thu hồi

    # Status
    status:
      type: enum
      values:
        - draft
        - pending_review
        - approved
        - sent
        - delivered
        - acknowledged
        - complied
        - expired
        - escalated
        - cancelled
      default: draft
      name_vi:
        draft: Bản nháp
        pending_review: Chờ xét duyệt
        approved: Đã duyệt
        sent: Đã gửi
        delivered: Đã giao
        acknowledged: Đã xác nhận
        complied: Đã tuân thủ
        expired: Hết hạn
        escalated: Leo thang
        cancelled: Đã hủy

    # Content
    content:
      type: object
      properties:
        subject:
          type: string
          max_length: 200
          required: true
        body:
          type: text
          required: true
        template_used:
          type: string
        custom_fields:
          type: json
          description: "Template variable values"

    # Timing
    timing:
      type: object
      properties:
        notice_date:
          type: date
          required: true
        effective_date:
          type: date
          description: "When the notice takes effect"
        compliance_deadline:
          type: date
          description: "Deadline for tenant action"
        expiry_date:
          type: date
        notice_period_days:
          type: integer
          description: "Required notice period"

    # Delivery
    delivery:
      type: object
      properties:
        delivery_method:
          type: enum
          values:
            - hand_delivered
            - certified_mail
            - regular_mail
            - email
            - portal
            - posted_on_door
            - courier
          required: true
          name_vi:
            hand_delivered: Giao trực tiếp
            certified_mail: Thư bảo đảm
            regular_mail: Thư thường
            email: Email
            portal: Cổng thông tin
            posted_on_door: Dán trên cửa
            courier: Chuyển phát
        sent_date:
          type: date
        sent_at:
          type: timestamp
        sent_by:
          type: uuid
        tracking_number:
          type: string
        delivered_date:
          type: date
        delivery_confirmed:
          type: boolean
          default: false
        delivery_confirmation:
          type: object
          properties:
            confirmed_by:
              type: string
            confirmation_date:
              type: date
            signature_url:
              type: string
            photo_url:
              type: string

    # Acknowledgment
    acknowledgment:
      type: object
      properties:
        acknowledgment_required:
          type: boolean
          default: false
        acknowledged:
          type: boolean
          default: false
        acknowledged_date:
          type: date
        acknowledged_by:
          type: string
        acknowledgment_method:
          type: enum
          values: [signed, email_reply, portal, verbal]
        acknowledgment_document_url:
          type: string

    # Compliance (for violation notices)
    compliance:
      type: object
      applicable_when: "notice_type in ['lease_violation', 'pay_or_quit', 'cure_or_quit']"
      properties:
        compliance_required:
          type: boolean
          default: true
        complied:
          type: boolean
          default: false
        compliance_date:
          type: date
        compliance_notes:
          type: text
        follow_up_notices:
          type: array
          items:
            type: uuid
            description: "Related follow-up notice IDs"

    # Rent Increase Details
    rent_increase:
      type: object
      applicable_when: "notice_type == 'rent_increase'"
      properties:
        current_rent:
          type: money
        new_rent:
          type: money
        increase_amount:
          type: money
          computed: true
        increase_percent:
          type: decimal
          computed: true
        effective_date:
          type: date

    # Violation Details
    violation:
      type: object
      applicable_when: "notice_type in ['lease_violation', 'cure_or_quit']"
      properties:
        violation_type:
          type: string
        violation_date:
          type: date
        violation_description:
          type: text
        lease_clause_reference:
          type: string
        required_cure:
          type: text
        cure_deadline_days:
          type: integer
        previous_violations:
          type: integer
          description: "Number of previous violations"

    # Eviction Details
    eviction:
      type: object
      applicable_when: "notice_type in ['pay_or_quit', 'eviction_warning', 'eviction_notice']"
      properties:
        amount_owed:
          type: money
        eviction_grounds:
          type: array
          items:
            type: string
        pay_by_date:
          type: date
        vacate_by_date:
          type: date
        court_filing_date:
          type: date
        case_number:
          type: string

    # Documents
    documents:
      type: object
      properties:
        notice_document_url:
          type: string
          format: url
        supporting_documents:
          type: array
          items:
            type: object
            properties:
              document_type:
                type: string
              document_url:
                type: string
        delivery_proof_url:
          type: string

    # Legal
    legal:
      type: object
      properties:
        legal_review_required:
          type: boolean
          default: false
        legal_reviewed:
          type: boolean
          default: false
        reviewed_by:
          type: string
        legal_notes:
          type: text

    # Metadata
    notes:
      type: text
    internal_notes:
      type: text
    created_at:
      type: timestamp
      auto: create
    updated_at:
      type: timestamp
      auto: update
    created_by:
      type: uuid

  # Relationships
  relationships:
    property:
      type: belongs_to
      entity: ManagedProperty
      foreign_key: property_id
    unit:
      type: belongs_to
      entity: Unit
      foreign_key: unit_id
    lease:
      type: belongs_to
      entity: Lease
      foreign_key: lease_id
    tenant:
      type: belongs_to
      entity: Tenant
      foreign_key: tenant_id
    created_by_user:
      type: belongs_to
      entity: User
      foreign_key: created_by
    related_notices:
      type: has_many
      entity: Notice
      foreign_key: parent_notice_id

  # State Machine
  state_machine:
    field: status
    states:
      - draft
      - pending_review
      - approved
      - sent
      - delivered
      - acknowledged
      - complied
      - expired
      - escalated
      - cancelled
    transitions:
      - from: draft
        to: pending_review
        event: submit_for_review
        guard: content_complete
      - from: draft
        to: approved
        event: approve
        guard: no_review_required
      - from: pending_review
        to: approved
        event: approve
      - from: pending_review
        to: draft
        event: reject
        action: record_rejection_reason
      - from: approved
        to: sent
        event: send
        action: [generate_document, record_send_time]
      - from: sent
        to: delivered
        event: confirm_delivery
        action: record_delivery
      - from: [sent, delivered]
        to: acknowledged
        event: acknowledge
        guard: acknowledgment_received
      - from: [delivered, acknowledged]
        to: complied
        event: mark_complied
        guard: compliance_verified
      - from: [sent, delivered, acknowledged]
        to: expired
        event: expire
        guard: past_deadline
      - from: [delivered, acknowledged, expired]
        to: escalated
        event: escalate
        action: create_follow_up
      - from: [draft, pending_review, approved]
        to: cancelled
        event: cancel

  # Indexes
  indexes:
    - fields: [notice_id]
      unique: true
    - fields: [property_id, notice_type]
    - fields: [unit_id, status]
    - fields: [tenant_id, status]
    - fields: [lease_id]
    - fields: [notice_type, status]
    - fields: [compliance_deadline]
    - fields: [effective_date]

  # Validation Rules
  validations:
    - rule: "effective_date must be after notice_date"
      condition: "effective_date.nil? || effective_date >= notice_date"
    - rule: "compliance_deadline must be after notice_date"
      condition: "compliance_deadline.nil? || compliance_deadline >= notice_date"
    - rule: "notice_period must be respected"
      condition: "effective_date.nil? || (effective_date - notice_date).to_i >= notice_period_days"

  # Events
  events:
    - notice_created
    - notice_submitted_for_review
    - notice_approved
    - notice_sent
    - notice_delivered
    - notice_acknowledged
    - notice_complied
    - notice_expired
    - notice_escalated
    - notice_cancelled
    - eviction_filed

  # Audit
  audit:
    enabled: true
    tracked_fields:
      - status
      - content
      - delivery
      - acknowledgment
      - compliance
