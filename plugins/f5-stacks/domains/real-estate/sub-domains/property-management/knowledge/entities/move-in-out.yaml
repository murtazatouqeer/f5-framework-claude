# Move-In/Out Entity
# F5 Framework v2.0 - Real Estate/Property Management
# Nhận/Trả nhà / 入居・退去

entity:
  name: MoveInOut
  name_vi: Nhận/Trả nhà
  name_ja: 入居・退去
  domain: real-estate
  subdomain: property-management
  version: "1.0.0"

  description: |
    Tracks the move-in or move-out process for a tenancy, including
    scheduling, inspections, key handover, deposit handling, and
    unit turnover activities.

  # Primary Key
  identifier:
    field: id
    type: uuid
    generated: true

  # Business Keys
  business_keys:
    move_id:
      pattern: "{TYPE}-{YYYYMMDD}-{XXXX}"
      examples:
        - "MI-20240115-0001"
        - "MO-20240130-0001"
      unique: true

  # Attributes
  attributes:
    # References
    lease_id:
      type: uuid
      required: true
    unit_id:
      type: uuid
      required: true
    tenant_id:
      type: uuid
      required: true
    property_id:
      type: uuid
      required: true

    # Move Type
    move_type:
      type: enum
      values:
        - move_in
        - move_out
      required: true
      name_vi:
        move_in: Nhận nhà
        move_out: Trả nhà

    # Status
    status:
      type: enum
      values:
        - scheduled
        - in_progress
        - completed
        - cancelled
      default: scheduled
      name_vi:
        scheduled: Đã lên lịch
        in_progress: Đang thực hiện
        completed: Hoàn thành
        cancelled: Đã hủy

    # Schedule
    schedule:
      type: object
      properties:
        scheduled_date:
          type: date
          required: true
        scheduled_time:
          type: time
        actual_date:
          type: date
        actual_time:
          type: time
        duration_hours:
          type: decimal
          description: "Estimated duration"

    # Checklist Progress
    checklist:
      type: object
      properties:
        move_in_items:
          type: array
          applicable_when: "move_type == 'move_in'"
          items:
            type: object
            properties:
              item:
                type: string
              completed:
                type: boolean
              completed_at:
                type: timestamp
              notes:
                type: string
          default_items:
            - "Lease signed"
            - "Deposit collected"
            - "First month rent collected"
            - "Move-in inspection completed"
            - "Keys provided"
            - "Access cards issued"
            - "Utilities transferred"
            - "Welcome package provided"
            - "Portal access set up"
            - "Emergency contacts collected"
        move_out_items:
          type: array
          applicable_when: "move_type == 'move_out'"
          items:
            type: object
            properties:
              item:
                type: string
              completed:
                type: boolean
              completed_at:
                type: timestamp
              notes:
                type: string
          default_items:
            - "Notice received"
            - "Pre-move-out inspection scheduled"
            - "Final walkthrough scheduled"
            - "Move-out inspection completed"
            - "Keys returned"
            - "Access cards returned"
            - "Utilities final reading"
            - "Forwarding address collected"
            - "Deposit statement prepared"
            - "Deposit refunded"

    # Inspection
    inspection:
      type: object
      properties:
        inspection_id:
          type: uuid
        inspection_scheduled:
          type: boolean
          default: false
        inspection_completed:
          type: boolean
          default: false
        inspection_date:
          type: date
        condition_rating:
          type: enum
          values: [excellent, good, fair, poor]

    # Keys/Access
    keys:
      type: object
      properties:
        keys_status:
          type: enum
          values: [not_issued, issued, returned, not_returned]
          default: not_issued
        keys_issued:
          type: array
          items:
            type: object
            properties:
              key_type:
                type: string
              quantity:
                type: integer
              serial_numbers:
                type: array
                items:
                  type: string
        keys_returned:
          type: array
          items:
            type: object
            properties:
              key_type:
                type: string
              quantity:
                type: integer
        missing_keys:
          type: array
          items:
            type: string
        key_replacement_charge:
          type: money

    # Financial (Move-In)
    move_in_financial:
      type: object
      applicable_when: "move_type == 'move_in'"
      properties:
        first_month_rent:
          type: money
        first_month_collected:
          type: boolean
          default: false
        security_deposit:
          type: money
        deposit_collected:
          type: boolean
          default: false
        pet_deposit:
          type: money
        other_fees:
          type: array
          items:
            type: object
            properties:
              description:
                type: string
              amount:
                type: money
              collected:
                type: boolean
        total_due:
          type: money
          computed: true
        total_collected:
          type: money
        balance:
          type: money
          computed: true

    # Financial (Move-Out)
    move_out_financial:
      type: object
      applicable_when: "move_type == 'move_out'"
      properties:
        final_rent_due:
          type: money
        final_rent_paid:
          type: boolean
          default: false
        utility_final_charges:
          type: money
        damage_charges:
          type: money
        cleaning_charges:
          type: money
        other_charges:
          type: array
          items:
            type: object
            properties:
              description:
                type: string
              amount:
                type: money
        total_charges:
          type: money
          computed: true
        deposit_held:
          type: money
        deposit_interest:
          type: money
        net_refund:
          type: money
          computed: true
        refund_processed:
          type: boolean
          default: false

    # Utilities
    utilities:
      type: object
      properties:
        electricity_reading:
          type: decimal
        water_reading:
          type: decimal
        gas_reading:
          type: decimal
        utility_account_transferred:
          type: boolean
          default: false
        utility_final_bill_amount:
          type: money

    # Forwarding (Move-Out)
    forwarding:
      type: object
      applicable_when: "move_type == 'move_out'"
      properties:
        forwarding_address:
          type: string
        forwarding_email:
          type: string
        forwarding_phone:
          type: string
        mail_forwarding_requested:
          type: boolean
          default: false

    # Turnover (Move-Out)
    turnover:
      type: object
      applicable_when: "move_type == 'move_out'"
      properties:
        turnover_started:
          type: boolean
          default: false
        cleaning_scheduled:
          type: boolean
          default: false
        cleaning_completed:
          type: boolean
          default: false
        repairs_needed:
          type: boolean
          default: false
        repairs_completed:
          type: boolean
          default: false
        painting_needed:
          type: boolean
          default: false
        painting_completed:
          type: boolean
          default: false
        ready_for_listing:
          type: boolean
          default: false
        ready_date:
          type: date

    # Documents
    documents:
      type: object
      properties:
        move_in_checklist_url:
          type: string
        move_out_checklist_url:
          type: string
        inspection_report_url:
          type: string
        deposit_statement_url:
          type: string

    # Signatures
    signatures:
      type: object
      properties:
        tenant_signed:
          type: boolean
          default: false
        tenant_signature_date:
          type: date
        manager_signed:
          type: boolean
          default: false
        manager_signature_date:
          type: date

    # Metadata
    notes:
      type: text
    created_at:
      type: timestamp
      auto: create
    updated_at:
      type: timestamp
      auto: update
    completed_by:
      type: uuid

  # Relationships
  relationships:
    lease:
      type: belongs_to
      entity: Lease
      foreign_key: lease_id
    unit:
      type: belongs_to
      entity: Unit
      foreign_key: unit_id
    tenant:
      type: belongs_to
      entity: Tenant
      foreign_key: tenant_id
    property:
      type: belongs_to
      entity: ManagedProperty
      foreign_key: property_id
    inspection:
      type: belongs_to
      entity: Inspection
      foreign_key: inspection_id
    security_deposit:
      type: has_one
      entity: SecurityDeposit
      through: Lease

  # State Machine
  state_machine:
    field: status
    states:
      - scheduled
      - in_progress
      - completed
      - cancelled
    transitions:
      - from: scheduled
        to: in_progress
        event: start
        action: begin_process
      - from: in_progress
        to: completed
        event: complete
        guard: all_checklist_items_done
        action: finalize_move
      - from: [scheduled, in_progress]
        to: cancelled
        event: cancel
        action: reverse_if_needed

  # Indexes
  indexes:
    - fields: [move_id]
      unique: true
    - fields: [lease_id, move_type]
    - fields: [unit_id, scheduled_date]
    - fields: [tenant_id]
    - fields: [status]
    - fields: [scheduled_date]

  # Validation Rules
  validations:
    - rule: "scheduled_date must be in the future for new records"
      condition: "persisted? || scheduled_date >= Date.today"
    - rule: "move_out requires move_in to have happened"
      condition: "move_type != 'move_out' || lease.move_in_completed?"

  # Events
  events:
    - move_in_scheduled
    - move_in_started
    - move_in_completed
    - move_out_scheduled
    - move_out_started
    - move_out_completed
    - keys_issued
    - keys_returned
    - deposit_collected
    - deposit_refunded
    - unit_turnover_started
    - unit_ready_for_listing

  # Audit
  audit:
    enabled: true
    tracked_fields:
      - status
      - checklist
      - keys
      - move_in_financial
      - move_out_financial
      - signatures
