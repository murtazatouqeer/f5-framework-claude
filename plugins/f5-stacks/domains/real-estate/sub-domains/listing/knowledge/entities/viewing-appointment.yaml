# Viewing Appointment Entity
# F5 Framework v2.0 - Real Estate/Listing
# Property viewing scheduling and feedback

entity:
  id: viewing_appointment
  name: Viewing Appointment
  name_ja: 内覧予約
  name_vi: Lịch xem nhà
  domain: real-estate
  subdomain: listing
  version: "1.0.0"

  description: |
    Scheduled property viewings between seekers and agents. Tracks
    scheduling, attendance, feedback, and interest level assessment.

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true

    - name: viewing_id
      type: string
      format: "VW-{XXXXXXXX}"
      unique: true
      indexed: true

    # References
    - name: listing_id
      type: uuid
      foreign_key: listing.id
      required: true
      indexed: true

    - name: property_id
      type: uuid
      foreign_key: property.id
      required: true
      indexed: true

    - name: inquiry_id
      type: uuid
      foreign_key: inquiry.id
      indexed: true
      description: Source inquiry if applicable

    - name: agent_id
      type: uuid
      foreign_key: agent.id
      required: true
      indexed: true

    # Seeker Info
    - name: seeker_id
      type: uuid
      foreign_key: user.id
      indexed: true

    - name: seeker_name
      type: string
      max_length: 200
      required: true

    - name: seeker_phone
      type: string
      max_length: 20
      required: true

    - name: seeker_email
      type: string
      max_length: 255

    - name: attendees_count
      type: integer
      default: 1
      description: Number of people attending

    # Schedule
    - name: scheduled_date
      type: date
      required: true
      indexed: true

    - name: scheduled_time
      type: time
      required: true

    - name: scheduled_datetime
      type: timestamp
      indexed: true

    - name: duration_minutes
      type: integer
      default: 30

    - name: end_time
      type: time

    - name: timezone
      type: string
      max_length: 50
      default: "Asia/Ho_Chi_Minh"

    # Status
    - name: status
      type: enum
      values: [requested, confirmed, rescheduled, completed, cancelled, no_show]
      default: requested
      indexed: true

    - name: confirmation_status
      type: enum
      values: [pending_agent, pending_seeker, confirmed]
      default: pending_agent

    # Viewing Type
    - name: viewing_type
      type: enum
      values: [in_person, virtual, video_call, self_guided]
      default: in_person

    - name: virtual_meeting_link
      type: string
      max_length: 500
      description: For virtual viewings

    # Rescheduling
    - name: rescheduled_from
      type: uuid
      foreign_key: viewing_appointment.id
      description: Original appointment if rescheduled

    - name: reschedule_count
      type: integer
      default: 0

    - name: reschedule_reason
      type: text

    # Cancellation
    - name: cancelled_by
      type: enum
      values: [seeker, agent, owner, system]

    - name: cancellation_reason
      type: text

    - name: cancelled_at
      type: timestamp

    # Completion
    - name: actual_start_time
      type: timestamp

    - name: actual_end_time
      type: timestamp

    - name: actual_duration_minutes
      type: integer

    # Feedback - Seeker
    - name: seeker_feedback
      type: jsonb
      schema:
        overall_rating: integer  # 1-5
        property_condition: integer
        matches_description: boolean
        liked_aspects: array
        disliked_aspects: array
        comments: string
        submitted_at: timestamp

    - name: seeker_interest_level
      type: enum
      values: [not_interested, somewhat_interested, very_interested, ready_to_offer]
      indexed: true

    # Feedback - Agent
    - name: agent_feedback
      type: jsonb
      schema:
        seeker_seriousness: integer  # 1-5
        purchase_readiness: string
        objections: array
        follow_up_actions: array
        notes: string
        submitted_at: timestamp

    - name: agent_recommendation
      type: enum
      values: [not_qualified, needs_nurturing, qualified, hot_lead]

    # Follow-up
    - name: follow_up_required
      type: boolean
      default: true

    - name: follow_up_date
      type: date
      indexed: true

    - name: follow_up_notes
      type: text

    - name: follow_up_completed
      type: boolean
      default: false

    # Notifications
    - name: reminder_sent
      type: boolean
      default: false

    - name: reminder_sent_at
      type: timestamp

    - name: confirmation_sent
      type: boolean
      default: false

    # Special Instructions
    - name: seeker_notes
      type: text
      description: Notes from seeker about the viewing

    - name: agent_notes
      type: text
      description: Agent's preparation notes

    - name: access_instructions
      type: text
      description: How to access the property

    # Timestamps
    - name: requested_at
      type: timestamp
      auto: true

    - name: confirmed_at
      type: timestamp

    - name: completed_at
      type: timestamp

    - name: created_at
      type: timestamp
      auto: true

    - name: updated_at
      type: timestamp
      auto: true

  computed_fields:
    - name: is_upcoming
      formula: "status IN ('confirmed', 'requested') AND scheduled_datetime > NOW()"

    - name: is_overdue
      formula: "status IN ('confirmed', 'requested') AND scheduled_datetime < NOW()"

    - name: needs_feedback
      formula: "status = 'completed' AND seeker_feedback IS NULL"

  relationships:
    - name: listing
      type: belongs_to
      entity: listing
      foreign_key: listing_id

    - name: property
      type: belongs_to
      entity: property
      foreign_key: property_id

    - name: inquiry
      type: belongs_to
      entity: inquiry
      foreign_key: inquiry_id

    - name: agent
      type: belongs_to
      entity: agent
      foreign_key: agent_id

    - name: seeker
      type: belongs_to
      entity: user
      foreign_key: seeker_id

    - name: rescheduled_from_appointment
      type: belongs_to
      entity: viewing_appointment
      foreign_key: rescheduled_from

  indexes:
    - fields: [scheduled_datetime, status]
      name: idx_viewing_schedule

    - fields: [agent_id, scheduled_date]
      name: idx_agent_schedule

    - fields: [listing_id, status]
      name: idx_listing_viewings

    - fields: [seeker_interest_level, status]
      name: idx_interest_level

    - fields: [follow_up_date, follow_up_completed]
      name: idx_follow_up

  validations:
    - field: scheduled_datetime
      rule: future_date
      condition: "status = 'requested'"
      message: Viewing must be scheduled for a future date

    - field: duration_minutes
      rule: between
      min: 15
      max: 180
      message: Duration must be between 15 and 180 minutes

    - field: attendees_count
      rule: between
      min: 1
      max: 10

  state_machine:
    initial: requested

    transitions:
      - from: requested
        to: confirmed
        trigger: confirm
        actions:
          - set_confirmed_at
          - send_confirmation_notification
          - schedule_reminder

      - from: requested
        to: cancelled
        trigger: cancel
        actions:
          - set_cancelled_at
          - notify_parties

      - from: confirmed
        to: rescheduled
        trigger: reschedule
        conditions:
          - reschedule_count < 3
        actions:
          - increment_reschedule_count
          - create_new_appointment
          - notify_parties

      - from: confirmed
        to: completed
        trigger: complete
        actions:
          - set_completed_at
          - request_feedback
          - update_inquiry_status

      - from: confirmed
        to: no_show
        trigger: mark_no_show
        actions:
          - notify_agent
          - update_seeker_reliability

      - from: confirmed
        to: cancelled
        trigger: cancel
        actions:
          - set_cancelled_at
          - notify_parties

  audit:
    enabled: true
    track_changes: true
