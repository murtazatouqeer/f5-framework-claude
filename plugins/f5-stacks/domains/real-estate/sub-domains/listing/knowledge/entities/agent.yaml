# Agent Entity
# F5 Framework v2.0 - Real Estate/Listing
# Real estate agents and brokers

entity:
  id: agent
  name: Agent
  name_ja: 不動産エージェント
  name_vi: Môi giới bất động sản
  domain: real-estate
  subdomain: listing
  version: "1.0.0"

  description: |
    Real estate agents who list and manage properties, handle inquiries,
    and facilitate transactions. Includes licensing, performance metrics,
    and service area management.

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true

    - name: agent_id
      type: string
      format: "AGT-{XXXXXXXX}"
      unique: true
      indexed: true

    - name: user_id
      type: uuid
      foreign_key: user.id
      required: true
      unique: true
      description: Link to platform user account

    # Personal Info
    - name: full_name
      type: string
      max_length: 200
      required: true

    - name: display_name
      type: string
      max_length: 100

    - name: phone
      type: string
      max_length: 20
      required: true

    - name: phone_secondary
      type: string
      max_length: 20

    - name: email
      type: string
      max_length: 255
      required: true

    - name: avatar_url
      type: string
      max_length: 500

    - name: bio
      type: text
      description: Agent biography/introduction

    # Status
    - name: status
      type: enum
      values: [pending_verification, active, suspended, inactive]
      default: pending_verification
      indexed: true

    - name: verification_status
      type: enum
      values: [unverified, pending, verified, rejected]
      default: unverified
      indexed: true

    # Agency Affiliation
    - name: agency_id
      type: uuid
      foreign_key: agency.id
      indexed: true

    - name: is_independent
      type: boolean
      default: false
      description: Independent agent without agency

    - name: agency_role
      type: enum
      values: [agent, senior_agent, team_lead, branch_manager, broker]
      default: agent

    - name: joined_agency_at
      type: date

    # Licensing
    - name: license_number
      type: string
      max_length: 100
      indexed: true

    - name: license_type
      type: enum
      values: [salesperson, broker, associate_broker]

    - name: license_state
      type: string
      max_length: 50
      description: State/province of license

    - name: license_expiry
      type: date
      indexed: true

    - name: license_verified
      type: boolean
      default: false

    - name: license_documents
      type: jsonb
      schema:
        - document_type: string
          file_url: string
          uploaded_at: timestamp
          verified: boolean

    # Specializations
    - name: specializations
      type: array
      items: string
      description: "[residential, commercial, luxury, first_time_buyers, investment, relocation]"

    - name: property_types
      type: array
      items: string
      description: Property types agent specializes in

    - name: languages
      type: array
      items: string
      description: Languages spoken

    # Service Areas
    - name: service_areas
      type: jsonb
      description: Geographic areas agent serves
      schema:
        - city: string
          districts: array
          primary: boolean

    - name: service_radius_km
      type: integer
      description: Service radius from primary location

    # Performance Metrics (denormalized)
    - name: total_listings
      type: integer
      default: 0

    - name: active_listings
      type: integer
      default: 0

    - name: total_transactions
      type: integer
      default: 0

    - name: transactions_this_year
      type: integer
      default: 0

    - name: total_sales_volume
      type: decimal
      precision: 18
      scale: 2
      default: 0

    - name: average_days_on_market
      type: integer
      description: Average DOM for closed listings

    - name: list_to_sale_ratio
      type: decimal
      precision: 5
      scale: 2
      description: Percentage of list price achieved

    # Ratings
    - name: rating_average
      type: decimal
      precision: 3
      scale: 2
      indexed: true

    - name: rating_count
      type: integer
      default: 0

    - name: review_count
      type: integer
      default: 0

    # Response Metrics
    - name: response_rate
      type: decimal
      precision: 5
      scale: 2
      description: Percentage of inquiries responded to

    - name: average_response_time_minutes
      type: integer
      description: Average response time to inquiries

    # Subscription/Tier
    - name: subscription_tier
      type: enum
      values: [basic, professional, premium, enterprise]
      default: basic
      indexed: true

    - name: subscription_expires_at
      type: timestamp

    - name: featured_until
      type: timestamp
      description: Featured agent promotion end date

    # Social/Marketing
    - name: website_url
      type: string
      max_length: 500

    - name: social_links
      type: jsonb
      schema:
        facebook: string
        linkedin: string
        instagram: string
        youtube: string
        zalo: string

    # Settings
    - name: notification_preferences
      type: jsonb
      schema:
        email_inquiries: boolean
        sms_inquiries: boolean
        push_notifications: boolean
        weekly_report: boolean

    - name: availability
      type: jsonb
      description: Working hours and availability
      schema:
        monday: { start: string, end: string }
        tuesday: { start: string, end: string }
        # etc.

    # Timestamps
    - name: verified_at
      type: timestamp

    - name: last_active_at
      type: timestamp

    - name: created_at
      type: timestamp
      auto: true

    - name: updated_at
      type: timestamp
      auto: true

  computed_fields:
    - name: is_top_performer
      formula: "transactions_this_year >= 20 AND rating_average >= 4.5"

    - name: is_responsive
      formula: "response_rate >= 0.9 AND average_response_time_minutes <= 60"

    - name: license_valid
      formula: "license_verified = true AND license_expiry > NOW()"

  relationships:
    - name: user
      type: belongs_to
      entity: user
      foreign_key: user_id

    - name: agency
      type: belongs_to
      entity: agency
      foreign_key: agency_id

    - name: listings
      type: has_many
      entity: listing
      foreign_key: agent_id

    - name: inquiries
      type: has_many
      entity: inquiry
      foreign_key: agent_id

    - name: viewings
      type: has_many
      entity: viewing_appointment
      foreign_key: agent_id

    - name: reviews
      type: has_many
      entity: agent_review
      foreign_key: agent_id

  indexes:
    - fields: [status, service_areas]
      name: idx_active_agents_area

    - fields: [rating_average, status]
      name: idx_agent_rating

    - fields: [agency_id, status]
      name: idx_agency_agents

    - fields: [subscription_tier, status]
      name: idx_subscription

  validations:
    - field: phone
      rule: phone_format
      message: Invalid phone number format

    - field: email
      rule: email_format
      message: Invalid email format

    - field: rating_average
      rule: between
      min: 0
      max: 5

  state_machine:
    initial: pending_verification

    transitions:
      - from: pending_verification
        to: active
        trigger: verify
        conditions:
          - license_valid
          - profile_complete
        actions:
          - set_verified_at
          - notify_agent

      - from: pending_verification
        to: inactive
        trigger: reject_verification
        actions:
          - notify_rejection_reason

      - from: active
        to: suspended
        trigger: suspend
        actions:
          - pause_all_listings
          - notify_agent

      - from: suspended
        to: active
        trigger: reinstate
        actions:
          - resume_listings

      - from: [active, suspended]
        to: inactive
        trigger: deactivate
        actions:
          - close_all_listings
          - notify_inquirers

  audit:
    enabled: true
    track_changes: true
