# Listing Entity
# F5 Framework v2.0 - Real Estate/Listing
# Property listing for sale or rent

entity:
  id: listing
  name: Listing
  name_ja: 物件掲載
  name_vi: Tin đăng
  domain: real-estate
  subdomain: listing
  version: "1.0.0"
  
  description: |
    A listing represents a property being offered for sale, rent, or lease.
    A single property can have multiple listings over time, but typically
    only one active listing at a time.

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true
      
    - name: listing_id
      type: string
      format: "LST-{XXXXXXXX}"
      unique: true
      indexed: true
      
    - name: listing_number
      type: string
      max_length: 50
      unique: true
      description: Human-readable listing number

    # Reference
    - name: property_id
      type: uuid
      foreign_key: property.id
      required: true
      indexed: true

    # Status
    - name: status
      type: enum
      values: [draft, pending_approval, active, paused, expired, under_offer, closed, cancelled, rejected]
      default: draft
      indexed: true
      
    - name: listing_type
      type: enum
      values: [sale, rent, lease, auction]
      required: true
      indexed: true
      
    - name: rejection_reason
      type: text
      description: Reason if listing was rejected

    # Pricing
    - name: asking_price
      type: decimal
      precision: 15
      scale: 2
      indexed: true
      
    - name: price_currency
      type: string
      length: 3
      default: "VND"
      
    - name: price_per_sqm
      type: decimal
      precision: 12
      scale: 2
      indexed: true
      
    - name: price_negotiable
      type: boolean
      default: true
      
    - name: price_display
      type: enum
      values: [show, hide, call_for_price, price_on_application]
      default: show
      
    - name: original_price
      type: decimal
      precision: 15
      scale: 2
      description: Original price before any reduction
      
    - name: price_reduced
      type: boolean
      default: false
      indexed: true

    # Rental specific
    - name: rent_period
      type: enum
      values: [daily, weekly, monthly, quarterly, yearly]
      description: For rental listings
      
    - name: deposit_amount
      type: decimal
      precision: 15
      scale: 2
      
    - name: deposit_months
      type: integer
      description: Deposit as number of months rent
      
    - name: minimum_lease_months
      type: integer
      
    - name: utilities_included
      type: boolean
      default: false

    # Agent/Agency
    - name: agent_id
      type: uuid
      foreign_key: agent.id
      indexed: true
      
    - name: agency_id
      type: uuid
      foreign_key: agency.id
      indexed: true
      
    - name: listing_source
      type: enum
      values: [direct_owner, agent, agency, developer, auction_house]
      default: agent
      indexed: true
      
    - name: commission_rate
      type: decimal
      precision: 5
      scale: 2
      description: Commission percentage
      
    - name: exclusive_listing
      type: boolean
      default: false
      description: Exclusive to one agent

    # Visibility & Promotion
    - name: featured
      type: boolean
      default: false
      indexed: true
      
    - name: premium
      type: boolean
      default: false
      indexed: true
      
    - name: boost_until
      type: timestamp
      description: Boosted visibility until this time
      
    - name: visibility
      type: enum
      values: [public, private, unlisted]
      default: public
      indexed: true

    # Engagement Metrics
    - name: views_count
      type: integer
      default: 0
      
    - name: unique_views_count
      type: integer
      default: 0
      
    - name: inquiries_count
      type: integer
      default: 0
      
    - name: saves_count
      type: integer
      default: 0
      
    - name: shares_count
      type: integer
      default: 0
      
    - name: phone_reveals_count
      type: integer
      default: 0

    # Schedule
    - name: published_at
      type: timestamp
      indexed: true
      
    - name: expires_at
      type: timestamp
      indexed: true
      
    - name: listing_duration_days
      type: integer
      default: 30
      
    - name: auto_renew
      type: boolean
      default: false
      
    - name: renewed_count
      type: integer
      default: 0

    # Content
    - name: title
      type: string
      max_length: 200
      required: true
      
    - name: headline
      type: string
      max_length: 300
      description: Short catchy headline
      
    - name: description
      type: text
      required: true
      description: Full listing description (rich text)
      
    - name: description_plain
      type: text
      description: Plain text version for search
      
    - name: highlights
      type: array
      items: string
      description: Key selling points
      
    - name: tags
      type: array
      items: string
      indexed: true

    # Media override (can override property media)
    - name: custom_media_order
      type: array
      items: uuid
      description: Custom order of media for this listing
      
    - name: hide_address
      type: boolean
      default: false
      description: Hide exact address for privacy

    # MLS/Syndication
    - name: mls_number
      type: string
      max_length: 50
      unique: true
      indexed: true
      
    - name: syndicated_to
      type: array
      items: string
      description: Platforms where listing is syndicated
      
    - name: syndication_status
      type: jsonb
      description: Status per syndication platform
      schema:
        platform: string
        status: string
        last_sync: timestamp
        external_url: string

    # Availability
    - name: available_from
      type: date
      description: When property is available
      
    - name: move_in_ready
      type: boolean
      default: true

    # Offer tracking
    - name: offers_received
      type: integer
      default: 0
      
    - name: highest_offer
      type: decimal
      precision: 15
      scale: 2

    # Timestamps
    - name: created_at
      type: timestamp
      auto: true
      
    - name: updated_at
      type: timestamp
      auto: true
      
    - name: paused_at
      type: timestamp
      
    - name: closed_at
      type: timestamp
      
    - name: closed_reason
      type: enum
      values: [sold, rented, withdrawn, expired, other]

  computed_fields:
    - name: days_on_market
      formula: "EXTRACT(DAY FROM NOW() - published_at)"
      
    - name: is_active
      formula: "status = 'active' AND (expires_at IS NULL OR expires_at > NOW())"
      
    - name: is_boosted
      formula: "boost_until IS NOT NULL AND boost_until > NOW()"
      
    - name: price_reduced_percent
      formula: "((original_price - asking_price) / original_price) * 100"

  relationships:
    - name: property
      type: belongs_to
      entity: property
      foreign_key: property_id
      
    - name: agent
      type: belongs_to
      entity: agent
      foreign_key: agent_id
      
    - name: agency
      type: belongs_to
      entity: agency
      foreign_key: agency_id
      
    - name: inquiries
      type: has_many
      entity: inquiry
      foreign_key: listing_id
      
    - name: viewings
      type: has_many
      entity: viewing_appointment
      foreign_key: listing_id
      
    - name: favorites
      type: has_many
      entity: favorite
      foreign_key: listing_id
      
    - name: media
      type: has_many
      entity: property_media
      foreign_key: listing_id

  indexes:
    - fields: [status, listing_type]
      name: idx_status_type
      
    - fields: [asking_price]
      name: idx_price
      
    - fields: [published_at]
      name: idx_published
      
    - fields: [featured, premium, status]
      name: idx_promotion
      
    - fields: [agent_id, status]
      name: idx_agent_listings

  validations:
    - field: asking_price
      rule: greater_than
      value: 0
      message: Price must be positive
      
    - field: title
      rule: min_length
      value: 10
      message: Title must be at least 10 characters
      
    - field: description
      rule: min_length
      value: 50
      message: Description must be at least 50 characters

  state_machine:
    initial: draft
    
    transitions:
      - from: draft
        to: pending_approval
        trigger: submit
        conditions:
          - has_minimum_photos
          - has_required_info
        actions:
          - validate_content
          - check_duplicates
          
      - from: pending_approval
        to: active
        trigger: approve
        actions:
          - set_published_at
          - set_expires_at
          - notify_agent
          - start_syndication
          
      - from: pending_approval
        to: rejected
        trigger: reject
        actions:
          - set_rejection_reason
          - notify_agent
          
      - from: rejected
        to: draft
        trigger: edit
        
      - from: active
        to: paused
        trigger: pause
        actions:
          - set_paused_at
          - pause_syndication
          
      - from: paused
        to: active
        trigger: resume
        actions:
          - resume_syndication
          
      - from: active
        to: under_offer
        trigger: receive_offer
        actions:
          - notify_agent
          - update_property_status
          
      - from: under_offer
        to: active
        trigger: offer_rejected
        
      - from: under_offer
        to: closed
        trigger: accept_offer
        actions:
          - set_closed_at
          - set_closed_reason
          - update_property_status
          - stop_syndication
          
      - from: active
        to: expired
        trigger: expire
        conditions:
          - expires_at_passed
        actions:
          - notify_agent
          - stop_syndication
          
      - from: expired
        to: active
        trigger: renew
        conditions:
          - can_renew
        actions:
          - increment_renewed_count
          - set_new_expires_at
          
      - from: [active, paused]
        to: cancelled
        trigger: cancel
        actions:
          - stop_syndication
          - notify_agent

  audit:
    enabled: true
    track_changes: true
    track_price_changes: true
