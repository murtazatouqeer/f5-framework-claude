# Market Report Entity
# F5 Framework v2.0 - Real Estate/Listing
# Real estate market analysis and reports

entity:
  id: market_report
  name: Market Report
  name_ja: 市場レポート
  name_vi: Báo cáo thị trường
  domain: real-estate
  subdomain: listing
  version: "1.0.0"

  description: |
    Periodic market analysis reports containing price trends, inventory
    levels, demand indicators, and market forecasts by location and
    property type.

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true

    - name: report_id
      type: string
      format: "MKT-{YYYYMM}-{XXXX}"
      unique: true
      indexed: true

    # Report Period
    - name: report_type
      type: enum
      values: [weekly, monthly, quarterly, annual, custom]
      required: true
      indexed: true

    - name: period_start
      type: date
      required: true
      indexed: true

    - name: period_end
      type: date
      required: true

    - name: report_date
      type: date
      required: true
      indexed: true

    # Geographic Scope
    - name: scope_level
      type: enum
      values: [national, city, district, ward, project]
      required: true
      indexed: true

    - name: city
      type: string
      max_length: 100
      indexed: true

    - name: district
      type: string
      max_length: 100
      indexed: true

    - name: ward
      type: string
      max_length: 100

    - name: project_name
      type: string
      max_length: 200

    # Property Scope
    - name: property_category
      type: enum
      values: [all, residential, commercial, industrial, land]
      default: all
      indexed: true

    - name: property_types
      type: array
      items: string

    - name: listing_type
      type: enum
      values: [all, sale, rent]
      default: all
      indexed: true

    # Inventory Metrics
    - name: total_listings
      type: integer

    - name: new_listings
      type: integer

    - name: closed_listings
      type: integer

    - name: expired_listings
      type: integer

    - name: active_inventory
      type: integer

    - name: inventory_change_percent
      type: decimal
      precision: 8
      scale: 4

    # Pricing Metrics
    - name: median_price
      type: decimal
      precision: 15
      scale: 2

    - name: average_price
      type: decimal
      precision: 15
      scale: 2

    - name: price_per_sqm_median
      type: decimal
      precision: 12
      scale: 2

    - name: price_per_sqm_average
      type: decimal
      precision: 12
      scale: 2

    - name: price_range
      type: jsonb
      schema:
        min: number
        max: number
        currency: string

    - name: price_change_percent
      type: decimal
      precision: 8
      scale: 4
      description: vs previous period

    - name: price_change_yoy_percent
      type: decimal
      precision: 8
      scale: 4
      description: Year over year

    # Sales/Rental Metrics
    - name: transactions_count
      type: integer

    - name: total_transaction_volume
      type: decimal
      precision: 18
      scale: 2

    - name: average_days_on_market
      type: integer

    - name: median_days_on_market
      type: integer

    - name: list_to_sale_ratio
      type: decimal
      precision: 5
      scale: 2
      description: Percentage of list price achieved

    # Demand Indicators
    - name: inquiries_count
      type: integer

    - name: viewings_count
      type: integer

    - name: views_per_listing
      type: decimal
      precision: 10
      scale: 2

    - name: inquiries_per_listing
      type: decimal
      precision: 10
      scale: 2

    - name: demand_index
      type: decimal
      precision: 5
      scale: 2
      description: 0-100 demand indicator

    # Supply Indicators
    - name: months_of_supply
      type: decimal
      precision: 5
      scale: 2
      description: Inventory / monthly sales

    - name: absorption_rate
      type: decimal
      precision: 5
      scale: 2
      description: Monthly sales rate

    # Market Condition
    - name: market_condition
      type: enum
      values: [buyers_market, balanced, sellers_market]
      indexed: true

    - name: market_trend
      type: enum
      values: [declining, stable, growing, hot]
      indexed: true

    # Price Distribution
    - name: price_distribution
      type: jsonb
      schema:
        - range_label: string
          range_min: number
          range_max: number
          count: integer
          percentage: number

    # Property Type Breakdown
    - name: type_breakdown
      type: jsonb
      schema:
        - property_type: string
          count: integer
          median_price: number
          avg_dom: integer

    # Top Performers
    - name: top_areas
      type: jsonb
      schema:
        - area_name: string
          transaction_count: integer
          price_change_percent: number

    - name: top_projects
      type: jsonb
      schema:
        - project_name: string
          developer: string
          transaction_count: integer
          price_per_sqm: number

    # Commentary
    - name: summary
      type: text
      description: Executive summary

    - name: highlights
      type: array
      items: string

    - name: insights
      type: text
      description: Detailed market insights

    - name: forecast
      type: text
      description: Short-term market forecast

    - name: recommendations
      type: array
      items: string

    # Status
    - name: status
      type: enum
      values: [draft, published, archived]
      default: draft
      indexed: true

    - name: visibility
      type: enum
      values: [public, subscribers, internal]
      default: public

    # Metadata
    - name: data_sources
      type: array
      items: string

    - name: methodology_notes
      type: text

    - name: created_by
      type: uuid
      foreign_key: user.id

    - name: published_at
      type: timestamp

    - name: created_at
      type: timestamp
      auto: true

    - name: updated_at
      type: timestamp
      auto: true

  computed_fields:
    - name: is_bullish
      formula: "market_trend IN ('growing', 'hot') AND price_change_percent > 0"

    - name: is_buyers_market
      formula: "months_of_supply > 6"

    - name: is_sellers_market
      formula: "months_of_supply < 3"

  relationships:
    - name: created_by_user
      type: belongs_to
      entity: user
      foreign_key: created_by

  indexes:
    - fields: [report_date, scope_level]
      name: idx_report_date_scope

    - fields: [city, district, report_date]
      name: idx_location_date

    - fields: [property_category, listing_type, report_date]
      name: idx_category_type_date

    - fields: [status, visibility]
      name: idx_published

  analytics:
    - name: price_trend_over_time
      description: Track price changes over multiple periods
      aggregation: time_series
      fields: [median_price, price_per_sqm_median]
      group_by: [city, district, property_category]
      order_by: period_start

    - name: market_comparison
      description: Compare markets across locations
      aggregation: comparison
      fields: [median_price, average_days_on_market, demand_index]
      group_by: [district]

  audit:
    enabled: true
    track_changes: true
