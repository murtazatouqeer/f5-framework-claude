# Property Entity
# F5 Framework v2.0 - Real Estate/Listing
# Core property information

entity:
  id: property
  name: Property
  name_ja: 物件
  name_vi: Bất động sản
  domain: real-estate
  subdomain: listing
  version: "1.0.0"
  
  description: |
    Represents a physical real estate property with all its characteristics,
    specifications, and features. A property can have multiple listings
    over time (sale, rent, etc.).

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true
      
    - name: property_id
      type: string
      format: "PROP-{XXXXXXXX}"
      unique: true
      indexed: true
      
    - name: property_code
      type: string
      max_length: 50
      unique: true
      indexed: true
      description: Human-readable code (e.g., HN-CG-001)
      example: "HN-CG-001"

    # Status
    - name: status
      type: enum
      values: [draft, active, pending_verification, under_offer, sold, rented, off_market, archived]
      default: draft
      indexed: true
      
    - name: is_verified
      type: boolean
      default: false
      indexed: true

    # Classification
    - name: property_type_id
      type: uuid
      foreign_key: property_type.id
      required: true
      indexed: true
      
    - name: property_category
      type: enum
      values: [residential, commercial, industrial, land, mixed_use]
      required: true
      indexed: true
      
    - name: property_subtype
      type: enum
      values: [apartment, villa, townhouse, shophouse, condominium, house, studio, penthouse, duplex, office, retail, warehouse, factory, land_plot, farm, hotel, restaurant]
      indexed: true
      
    - name: listing_purpose
      type: enum
      values: [sale, rent, lease, auction, sale_and_rent]
      indexed: true

    # Location
    - name: address
      type: jsonb
      required: true
      schema:
        street_number: string
        street_name: string
        ward: string
        ward_code: string
        district: string
        district_code: string
        city: string
        city_code: string
        province: string
        country: string
        postal_code: string
        
    - name: full_address
      type: string
      max_length: 500
      description: Formatted complete address
      
    - name: latitude
      type: decimal
      precision: 10
      scale: 8
      indexed: true
      
    - name: longitude
      type: decimal
      precision: 11
      scale: 8
      indexed: true
      
    - name: location_description
      type: text
      description: Description of location advantages
      
    - name: nearby_landmarks
      type: jsonb
      description: Nearby points of interest
      schema:
        - name: string
          type: string  # school, hospital, mall, metro, park
          distance_meters: integer

    # Specifications - Area
    - name: total_area_sqm
      type: decimal
      precision: 10
      scale: 2
      indexed: true
      
    - name: usable_area_sqm
      type: decimal
      precision: 10
      scale: 2
      indexed: true
      
    - name: land_area_sqm
      type: decimal
      precision: 10
      scale: 2
      description: For houses and land
      
    - name: frontage_meters
      type: decimal
      precision: 6
      scale: 2
      description: Street frontage width

    # Specifications - Structure
    - name: floors
      type: integer
      description: Total floors in building/house
      
    - name: floor_number
      type: integer
      description: Floor number for apartments
      indexed: true
      
    - name: bedrooms
      type: integer
      indexed: true
      
    - name: bathrooms
      type: integer
      indexed: true
      
    - name: living_rooms
      type: integer
      default: 1
      
    - name: kitchens
      type: integer
      default: 1

    # Specifications - Features
    - name: direction
      type: enum
      values: [north, south, east, west, northeast, northwest, southeast, southwest]
      indexed: true
      description: Main entrance direction
      
    - name: balcony_direction
      type: enum
      values: [north, south, east, west, northeast, northwest, southeast, southwest]
      
    - name: year_built
      type: integer
      indexed: true
      
    - name: renovation_year
      type: integer
      
    - name: building_name
      type: string
      max_length: 200
      description: For apartments/condos

    # Features
    - name: amenities
      type: array
      items: uuid
      description: Array of amenity_ids
      
    - name: interior_status
      type: enum
      values: [unfurnished, partially_furnished, fully_furnished, shell]
      default: unfurnished
      indexed: true
      
    - name: interior_description
      type: text
      
    - name: parking_spaces
      type: integer
      default: 0
      
    - name: parking_type
      type: enum
      values: [garage, outdoor, underground, street, none]
      
    - name: view
      type: array
      items: string
      description: "[city, sea, river, mountain, garden, pool, street]"

    # Legal
    - name: ownership_type
      type: enum
      values: [freehold, leasehold, strata_title, cooperative]
      indexed: true
      
    - name: land_use_rights_expiry
      type: date
      description: For Vietnam leasehold properties
      
    - name: legal_status
      type: enum
      values: [pink_book, red_book, pending, under_dispute, none]
      description: Vietnam property documentation status
      indexed: true
      
    - name: zoning
      type: string
      max_length: 100
      description: Zoning classification
      
    - name: legal_documents
      type: jsonb
      description: List of legal documents available
      schema:
        - document_type: string
          document_number: string
          issue_date: date
          verified: boolean

    # Verification
    - name: verified_at
      type: timestamp
      
    - name: verified_by
      type: uuid
      foreign_key: user.id
      
    - name: verification_documents
      type: jsonb
      schema:
        - document_type: string
          file_url: string
          uploaded_at: timestamp
          verified: boolean
          
    - name: verification_notes
      type: text

    # Owner
    - name: owner_id
      type: uuid
      foreign_key: property_owner.id
      indexed: true
      
    - name: owner_type
      type: enum
      values: [individual, company, developer, government]

    # Media counts (denormalized)
    - name: photo_count
      type: integer
      default: 0
      
    - name: video_count
      type: integer
      default: 0
      
    - name: has_virtual_tour
      type: boolean
      default: false
      
    - name: has_floor_plan
      type: boolean
      default: false
      
    - name: primary_photo_url
      type: string
      max_length: 500

    # Metadata
    - name: source
      type: enum
      values: [direct_entry, import, api, scrape]
      default: direct_entry
      
    - name: external_id
      type: string
      max_length: 100
      description: ID from external system
      
    - name: created_by
      type: uuid
      foreign_key: user.id
      
    - name: created_at
      type: timestamp
      auto: true
      
    - name: updated_at
      type: timestamp
      auto: true

  computed_fields:
    - name: price_per_sqm
      formula: "Current listing price / total_area_sqm"
      
    - name: age_years
      formula: "EXTRACT(YEAR FROM NOW()) - year_built"
      
    - name: is_new_construction
      formula: "year_built >= EXTRACT(YEAR FROM NOW()) - 2"

  relationships:
    - name: property_type
      type: belongs_to
      entity: property_type
      foreign_key: property_type_id
      
    - name: owner
      type: belongs_to
      entity: property_owner
      foreign_key: owner_id
      
    - name: listings
      type: has_many
      entity: listing
      foreign_key: property_id
      
    - name: media
      type: has_many
      entity: property_media
      foreign_key: property_id
      
    - name: price_history
      type: has_many
      entity: price_history
      foreign_key: property_id
      
    - name: favorites
      type: has_many
      entity: favorite
      foreign_key: property_id
      
    - name: inquiries
      type: has_many
      entity: inquiry
      foreign_key: property_id

  indexes:
    - fields: [property_category, status]
      name: idx_category_status
      
    - fields: [city_code, district_code]
      name: idx_location
      
    - fields: [bedrooms, bathrooms]
      name: idx_specs
      
    - fields: [total_area_sqm]
      name: idx_area
      
    - fields: [latitude, longitude]
      name: idx_geo
      type: gist

  validations:
    - field: total_area_sqm
      rule: greater_than
      value: 0
      message: Area must be positive
      
    - field: bedrooms
      rule: between
      min: 0
      max: 50
      
    - field: year_built
      rule: between
      min: 1800
      max: 2100

  state_machine:
    initial: draft
    
    transitions:
      - from: draft
        to: pending_verification
        trigger: submit_for_verification
        
      - from: draft
        to: active
        condition: "is_verified OR skip_verification_allowed"
        trigger: activate
        
      - from: pending_verification
        to: active
        trigger: verify
        action: set_verified
        
      - from: pending_verification
        to: draft
        trigger: reject_verification
        
      - from: active
        to: under_offer
        trigger: receive_offer
        
      - from: under_offer
        to: active
        trigger: offer_rejected
        
      - from: under_offer
        to: sold
        trigger: complete_sale
        
      - from: under_offer
        to: rented
        trigger: complete_rental
        
      - from: active
        to: off_market
        trigger: take_off_market
        
      - from: off_market
        to: active
        trigger: relist
        
      - from: [sold, rented]
        to: archived
        trigger: archive

  audit:
    enabled: true
    track_changes: true
    track_views: true
