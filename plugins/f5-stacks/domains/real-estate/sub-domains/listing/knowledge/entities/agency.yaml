# Agency Entity
# F5 Framework v2.0 - Real Estate/Listing
# Real estate agencies and brokerages

entity:
  id: agency
  name: Agency
  name_ja: 不動産会社
  name_vi: Công ty bất động sản
  domain: real-estate
  subdomain: listing
  version: "1.0.0"

  description: |
    Real estate agencies and brokerages that employ agents and manage
    property listings. Includes business registration, team management,
    and performance tracking.

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true

    - name: agency_id
      type: string
      format: "AGC-{XXXXXXXX}"
      unique: true
      indexed: true

    - name: slug
      type: string
      max_length: 100
      unique: true
      indexed: true

    # Basic Info
    - name: name
      type: string
      max_length: 200
      required: true

    - name: name_legal
      type: string
      max_length: 300
      description: Official registered business name

    - name: description
      type: text

    - name: tagline
      type: string
      max_length: 200

    # Status
    - name: status
      type: enum
      values: [pending_verification, active, suspended, inactive]
      default: pending_verification
      indexed: true

    - name: verification_status
      type: enum
      values: [unverified, pending, verified, rejected]
      default: unverified

    # Business Registration
    - name: business_registration_number
      type: string
      max_length: 100
      unique: true
      indexed: true

    - name: tax_id
      type: string
      max_length: 50

    - name: business_license_number
      type: string
      max_length: 100

    - name: business_license_expiry
      type: date

    - name: registration_documents
      type: jsonb
      schema:
        - document_type: string
          file_url: string
          uploaded_at: timestamp
          verified: boolean

    # Contact
    - name: phone
      type: string
      max_length: 20
      required: true

    - name: phone_secondary
      type: string
      max_length: 20

    - name: email
      type: string
      max_length: 255
      required: true

    - name: website
      type: string
      max_length: 500

    # Address
    - name: address
      type: jsonb
      required: true
      schema:
        street: string
        ward: string
        district: string
        city: string
        province: string
        country: string
        postal_code: string

    - name: full_address
      type: string
      max_length: 500

    - name: latitude
      type: decimal
      precision: 10
      scale: 8

    - name: longitude
      type: decimal
      precision: 11
      scale: 8

    # Branding
    - name: logo_url
      type: string
      max_length: 500

    - name: banner_url
      type: string
      max_length: 500

    - name: brand_colors
      type: jsonb
      schema:
        primary: string
        secondary: string

    # Team
    - name: owner_id
      type: uuid
      foreign_key: user.id
      required: true
      description: Agency owner/admin

    - name: total_agents
      type: integer
      default: 0

    - name: active_agents
      type: integer
      default: 0

    # Service Areas
    - name: service_areas
      type: jsonb
      description: Geographic areas agency serves
      schema:
        - city: string
          districts: array
          primary: boolean

    - name: specializations
      type: array
      items: string
      description: "[residential, commercial, luxury, industrial, land]"

    # Performance Metrics (denormalized)
    - name: total_listings
      type: integer
      default: 0

    - name: active_listings
      type: integer
      default: 0

    - name: total_transactions
      type: integer
      default: 0

    - name: transactions_this_year
      type: integer
      default: 0

    - name: total_sales_volume
      type: decimal
      precision: 18
      scale: 2
      default: 0

    # Ratings
    - name: rating_average
      type: decimal
      precision: 3
      scale: 2
      indexed: true

    - name: rating_count
      type: integer
      default: 0

    # Subscription
    - name: subscription_tier
      type: enum
      values: [basic, professional, premium, enterprise]
      default: basic
      indexed: true

    - name: subscription_expires_at
      type: timestamp

    - name: max_agents_allowed
      type: integer
      default: 5

    - name: max_listings_allowed
      type: integer
      default: 50

    - name: featured_until
      type: timestamp

    # Social
    - name: social_links
      type: jsonb
      schema:
        facebook: string
        linkedin: string
        instagram: string
        youtube: string
        zalo: string

    # Operational Hours
    - name: operating_hours
      type: jsonb
      schema:
        monday: { open: string, close: string }
        tuesday: { open: string, close: string }
        wednesday: { open: string, close: string }
        thursday: { open: string, close: string }
        friday: { open: string, close: string }
        saturday: { open: string, close: string }
        sunday: { open: string, close: string }

    # Settings
    - name: commission_structure
      type: jsonb
      description: Default commission rates
      schema:
        sale_percentage: number
        rental_percentage: number
        split_with_agent: number

    - name: listing_approval_required
      type: boolean
      default: true
      description: Require agency approval for agent listings

    # Timestamps
    - name: founded_year
      type: integer

    - name: verified_at
      type: timestamp

    - name: created_at
      type: timestamp
      auto: true

    - name: updated_at
      type: timestamp
      auto: true

  computed_fields:
    - name: years_in_business
      formula: "EXTRACT(YEAR FROM NOW()) - founded_year"

    - name: is_established
      formula: "founded_year <= EXTRACT(YEAR FROM NOW()) - 5"

    - name: has_capacity
      formula: "active_agents < max_agents_allowed AND active_listings < max_listings_allowed"

  relationships:
    - name: owner
      type: belongs_to
      entity: user
      foreign_key: owner_id

    - name: agents
      type: has_many
      entity: agent
      foreign_key: agency_id

    - name: listings
      type: has_many
      entity: listing
      foreign_key: agency_id

    - name: branches
      type: has_many
      entity: agency_branch
      foreign_key: agency_id

  indexes:
    - fields: [status, service_areas]
      name: idx_active_agency_area

    - fields: [rating_average, status]
      name: idx_agency_rating

    - fields: [subscription_tier, status]
      name: idx_agency_subscription

    - fields: [business_registration_number]
      name: idx_business_reg

  validations:
    - field: email
      rule: email_format
      message: Invalid email format

    - field: rating_average
      rule: between
      min: 0
      max: 5

    - field: founded_year
      rule: between
      min: 1900
      max: 2100

  state_machine:
    initial: pending_verification

    transitions:
      - from: pending_verification
        to: active
        trigger: verify
        conditions:
          - has_valid_registration
          - has_valid_license
        actions:
          - set_verified_at
          - notify_owner

      - from: pending_verification
        to: inactive
        trigger: reject
        actions:
          - notify_rejection

      - from: active
        to: suspended
        trigger: suspend
        actions:
          - suspend_all_agents
          - pause_all_listings

      - from: suspended
        to: active
        trigger: reinstate
        actions:
          - reinstate_agents

      - from: [active, suspended]
        to: inactive
        trigger: deactivate
        actions:
          - deactivate_all_agents
          - close_all_listings

  audit:
    enabled: true
    track_changes: true
