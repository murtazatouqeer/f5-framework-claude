# Closing Workflow
# F5 Framework v2.0 - Real Estate/Transaction
# Transaction closing and settlement process

workflow:
  name: ClosingWorkflow
  name_vi: Quy trÃ¬nh Ä‘Ã³ng giao dá»‹ch
  name_ja: æ±ºæ¸ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
  domain: real-estate
  subdomain: transaction
  version: "1.0.0"

  description: |
    Complete closing workflow for real estate transactions including
    document preparation, fund collection, settlement, title transfer,
    and possession handover.

  # Workflow Metadata
  metadata:
    owner: closing_team
    estimated_duration: 7-14_days
    complexity: high
    automation_level: semi_automated
    requires_human_approval: true
    legal_compliance: critical

  # Actors
  actors:
    buyer:
      role: Purchaser
      responsibilities:
        - Provide closing funds
        - Review closing documents
        - Sign documents
        - Receive keys
    seller:
      role: Property owner
      responsibilities:
        - Provide clear title
        - Sign transfer documents
        - Vacate property
        - Transfer keys
    buyer_agent:
      role: Buyer's representative
      responsibilities:
        - Coordinate buyer activities
        - Review closing statement
        - Attend closing
    listing_agent:
      role: Seller's representative
      responsibilities:
        - Coordinate seller activities
        - Verify seller readiness
        - Attend closing
    closing_agent:
      role: Settlement coordinator
      responsibilities:
        - Prepare closing documents
        - Calculate settlements
        - Coordinate signing
        - Disburse funds
    escrow_officer:
      role: Fund custodian
      responsibilities:
        - Hold funds
        - Verify amounts
        - Execute disbursements
    lender:
      role: Mortgage provider
      responsibilities:
        - Provide loan funds
        - Prepare loan documents
        - Record mortgage
    title_company:
      role: Title services
      responsibilities:
        - Issue title insurance
        - Prepare deed
        - Record documents
    notary:
      role: Document authenticator
      responsibilities:
        - Witness signatures
        - Notarize documents

  # Workflow States
  states:
    closing_preparation:
      name: Closing Preparation
      name_vi: Chuáº©n bá»‹ Ä‘Ã³ng giao dá»‹ch
      description: Pre-closing document and fund preparation
      entry_actions:
        - create_closing_checklist
        - calculate_settlement
        - prepare_documents
      expected_duration: 3-5_days

    document_preparation:
      name: Document Preparation
      name_vi: Chuáº©n bá»‹ tÃ i liá»‡u
      description: Preparing all closing documents
      entry_actions:
        - prepare_deed
        - prepare_closing_statement
        - prepare_transfer_documents
      parallel: true

    loan_document_preparation:
      name: Loan Document Preparation
      name_vi: Chuáº©n bá»‹ tÃ i liá»‡u vay
      description: Lender preparing loan documents
      entry_actions:
        - request_loan_documents
        - schedule_loan_signing
      conditional: if_financed
      parallel: true

    final_walkthrough:
      name: Final Walkthrough
      name_vi: Kiá»ƒm tra láº§n cuá»‘i
      description: Buyer's final property inspection
      entry_actions:
        - schedule_walkthrough
        - notify_parties
      timing: 24-48_hours_before_closing

    fund_collection:
      name: Fund Collection
      name_vi: Thu tiá»n
      description: Collecting funds for closing
      entry_actions:
        - send_wire_instructions
        - verify_fund_availability
      parallel: true

    closing_statement_review:
      name: Closing Statement Review
      name_vi: Xem xÃ©t báº£ng kÃª thanh toÃ¡n
      description: Parties reviewing settlement figures
      entry_actions:
        - distribute_closing_statement
        - request_approval
      deadline: 24_hours_before_closing

    pre_closing_verification:
      name: Pre-Closing Verification
      name_vi: XÃ¡c minh trÆ°á»›c Ä‘Ã³ng
      description: Final verification before closing
      entry_actions:
        - verify_all_documents
        - verify_funds_received
        - confirm_title_clear
        - verify_mortgage_payoff
      checklist: pre_closing_checklist

    closing_scheduled:
      name: Closing Scheduled
      name_vi: ÄÃ£ lÃªn lá»‹ch Ä‘Ã³ng
      description: Closing appointment confirmed
      entry_actions:
        - confirm_all_parties
        - send_reminders
        - prepare_closing_room

    closing_in_progress:
      name: Closing in Progress
      name_vi: Äang Ä‘Ã³ng giao dá»‹ch
      description: Signing ceremony in progress
      entry_actions:
        - verify_identities
        - present_documents

    document_signing:
      name: Document Signing
      name_vi: KÃ½ tÃ i liá»‡u
      description: Signing closing documents
      activities:
        - seller_signing
        - buyer_signing
        - witness_signing
        - notarization

    fund_disbursement:
      name: Fund Disbursement
      name_vi: Giáº£i ngÃ¢n
      description: Distributing closing funds
      entry_actions:
        - verify_all_signatures
        - authorize_disbursement
      order:
        - mortgage_payoff
        - taxes_and_fees
        - commissions
        - seller_proceeds

    title_recording:
      name: Title Recording
      name_vi: ÄÄƒng kÃ½ quyá»n sá»Ÿ há»¯u
      description: Recording deed at land office
      entry_actions:
        - submit_for_recording
        - track_recording
      deadline: 30_days_from_notarization

    possession_transfer:
      name: Possession Transfer
      name_vi: BÃ n giao
      description: Transferring property possession
      entry_actions:
        - schedule_key_transfer
        - prepare_possession_checklist

    closing_complete:
      name: Closing Complete
      name_vi: ÄÃ³ng giao dá»‹ch hoÃ n táº¥t
      description: Transaction successfully closed
      entry_actions:
        - generate_closing_package
        - distribute_documents
        - update_records
      terminal: false
      next_workflow: post_closing_workflow

    closing_delayed:
      name: Closing Delayed
      name_vi: HoÃ£n Ä‘Ã³ng giao dá»‹ch
      description: Closing postponed
      entry_actions:
        - document_delay_reason
        - reschedule_closing
        - notify_all_parties

    closing_failed:
      name: Closing Failed
      name_vi: ÄÃ³ng giao dá»‹ch tháº¥t báº¡i
      description: Closing could not be completed
      entry_actions:
        - document_failure_reason
        - determine_next_steps
        - notify_all_parties
      terminal: true

  # Transitions
  transitions:
    - from: closing_preparation
      to: [document_preparation, loan_document_preparation, fund_collection]
      trigger: start_closing_activities
      parallel: true
      actions:
        - initiate_parallel_activities

    - from: closing_preparation
      to: final_walkthrough
      trigger: schedule_walkthrough
      actions:
        - coordinate_access

    - from: [document_preparation, loan_document_preparation]
      to: closing_statement_review
      trigger: documents_ready
      join: true
      actions:
        - compile_all_documents

    - from: closing_statement_review
      to: pre_closing_verification
      trigger: statements_approved
      conditions:
        - buyer_approved
        - seller_approved
      actions:
        - lock_figures

    - from: pre_closing_verification
      to: closing_scheduled
      trigger: verification_passed
      conditions:
        - all_documents_ready
        - funds_verified
        - title_clear
        - no_blockers
      actions:
        - confirm_closing_appointment

    - from: pre_closing_verification
      to: closing_delayed
      trigger: verification_failed
      conditions:
        - has_blockers
      actions:
        - identify_blockers
        - create_resolution_plan

    - from: closing_scheduled
      to: closing_in_progress
      trigger: closing_starts
      conditions:
        - all_parties_present
        - documents_ready
      actions:
        - begin_closing_ceremony

    - from: closing_in_progress
      to: document_signing
      trigger: begin_signing
      actions:
        - present_documents_in_order

    - from: document_signing
      to: fund_disbursement
      trigger: all_signed
      conditions:
        - all_required_signatures
        - notarization_complete
      actions:
        - authorize_disbursement

    - from: fund_disbursement
      to: title_recording
      trigger: disbursement_complete
      conditions:
        - all_funds_disbursed
      actions:
        - submit_for_recording

    - from: title_recording
      to: possession_transfer
      trigger: start_possession
      actions:
        - schedule_key_handover

    - from: possession_transfer
      to: closing_complete
      trigger: possession_transferred
      conditions:
        - keys_transferred
        - property_vacated
      actions:
        - document_completion

    - from: closing_delayed
      to: pre_closing_verification
      trigger: issues_resolved
      actions:
        - re_verify

    - from: [closing_in_progress, document_signing]
      to: closing_failed
      trigger: cannot_complete
      actions:
        - document_failure
        - return_funds

  # Activities
  activities:
    prepare_closing_statement:
      name: Prepare Closing Statement
      name_vi: Chuáº©n bá»‹ báº£ng kÃª thanh toÃ¡n
      actor: closing_agent
      steps:
        - step: 1
          name: Calculate purchase price credits/debits
          items:
            - purchase_price
            - deposit_credit
            - loan_amount_if_applicable
        - step: 2
          name: Calculate prorations
          items:
            - property_taxes
            - hoa_fees
            - prepaid_items
            - utility_adjustments
        - step: 3
          name: Calculate seller costs
          items:
            - agent_commission
            - mortgage_payoff
            - transfer_tax
            - other_fees
        - step: 4
          name: Calculate buyer costs
          items:
            - registration_fee
            - notary_fee
            - title_insurance
            - loan_costs
        - step: 5
          name: Generate closing statement
          outputs:
            - buyer_closing_statement
            - seller_closing_statement
        - step: 6
          name: Distribute for review

    conduct_closing_ceremony:
      name: Conduct Closing Ceremony
      name_vi: Tiáº¿n hÃ nh lá»… Ä‘Ã³ng giao dá»‹ch
      actor: closing_agent
      location: closing_office_or_notary
      steps:
        - step: 1
          name: Verify attendance
          required:
            - buyer
            - seller
            - closing_agent
            - notary
        - step: 2
          name: Verify identities
          documents:
            - cmnd_cccd_passport
            - compare_to_contract
        - step: 3
          name: Review closing statement
          with: all_parties
        - step: 4
          name: Execute seller documents
          documents:
            - deed
            - transfer_declaration
            - certificate_surrender
        - step: 5
          name: Execute buyer documents
          documents:
            - loan_documents_if_applicable
            - title_registration_form
        - step: 6
          name: Notarize documents
          documents:
            - deed
            - mortgage_if_applicable
        - step: 7
          name: Collect final funds
          if_not_wired: cashier_check
        - step: 8
          name: Authorize disbursement
          approval: closing_agent

    disburse_funds:
      name: Disburse Closing Funds
      name_vi: Giáº£i ngÃ¢n tiá»n Ä‘Ã³ng giao dá»‹ch
      actor: escrow_officer
      steps:
        - step: 1
          name: Verify authorization
          required:
            - all_documents_signed
            - closing_agent_approval
        - step: 2
          name: Pay existing mortgage
          timing: same_day
          method: wire_transfer
          confirmation: required
        - step: 3
          name: Pay transfer taxes
          to: tax_authority
        - step: 4
          name: Pay registration fees
          to: land_office
        - step: 5
          name: Pay commissions
          to:
            - listing_agency
            - buyer_agency
        - step: 6
          name: Pay other costs
          items:
            - notary_fees
            - title_insurance
            - other_service_providers
        - step: 7
          name: Disburse seller proceeds
          to: seller_account
          timing: same_or_next_business_day
        - step: 8
          name: Generate disbursement report

    transfer_possession:
      name: Transfer Property Possession
      name_vi: BÃ n giao tÃ i sáº£n
      actors: [seller, buyer, agents]
      steps:
        - step: 1
          name: Final walkthrough
          verify:
            - property_condition
            - included_items
            - repairs_completed
            - property_vacated
        - step: 2
          name: Meter readings
          record:
            - electric_meter
            - water_meter
            - gas_meter_if_applicable
        - step: 3
          name: Key transfer
          items:
            - house_keys
            - gate_keys
            - garage_remotes
            - mailbox_keys
            - security_codes
        - step: 4
          name: Document transfer
          provide:
            - appliance_manuals
            - warranty_documents
            - contractor_contacts
            - utility_information
        - step: 5
          name: Sign possession acknowledgment
          signatures:
            - buyer
            - seller
        - step: 6
          name: Complete handover

  # Checklists
  checklists:
    pre_closing:
      items:
        - all_contingencies_satisfied
        - title_clear
        - mortgage_payoff_amount_confirmed
        - funds_verified_available
        - closing_statement_approved
        - all_documents_prepared
        - closing_appointment_confirmed
        - final_walkthrough_completed

    closing_documents_seller:
      items:
        - deed_signed
        - transfer_declaration_signed
        - certificate_surrendered
        - keys_ready
        - property_vacated

    closing_documents_buyer:
      items:
        - closing_statement_signed
        - loan_documents_signed
        - title_registration_form_signed
        - insurance_confirmation

    fund_disbursement:
      items:
        - mortgage_paid_off
        - taxes_paid
        - fees_paid
        - commissions_paid
        - seller_proceeds_sent

  # Business Rules Integration
  business_rules:
    - rule_ref: BR-CLO-001  # Pre-closing checklist
    - rule_ref: BR-CLO-010  # Buyer funds verification
    - rule_ref: BR-CLO-011  # Wire transfer requirements
    - rule_ref: BR-CLO-020  # Title transfer process
    - rule_ref: BR-CLO-021  # Land registration deadline
    - rule_ref: BR-CLO-040  # Disbursement order

  # Notifications
  notifications:
    closing_scheduled:
      recipients: [all_parties]
      template: closing_scheduled
      channels: [email, sms]
      content:
        subject: "Closing Appointment Confirmed"
        body: |
          Your closing is scheduled:
          Date: {closing_date}
          Time: {closing_time}
          Location: {closing_location}
          Please bring valid ID and any required documents.

    wire_instructions:
      recipients: [buyer]
      template: wire_instructions
      channels: [email]
      priority: high
      security: encrypted
      content:
        subject: "SECURE: Wire Transfer Instructions"
        body: |
          Amount Due: {amount_due}
          Wire to: {bank_name}
          Account: {account_number}
          Reference: {transaction_id}

          âš ï¸ FRAUD ALERT: Always verify wire instructions
          by phone before sending funds.

    funds_received:
      recipients: [all_parties]
      template: funds_confirmed
      content:
        subject: "Closing Funds Received"
        body: |
          Closing funds have been received and verified.
          Closing will proceed as scheduled.

    closing_complete:
      recipients: [all_parties]
      template: closing_complete
      priority: high
      content:
        subject: "ðŸŽ‰ Congratulations! Closing Complete"
        body: |
          The transaction has successfully closed.
          {buyer_name} is now the proud owner of
          {property_address}.

          Next steps will follow shortly.

    disbursement_complete:
      recipients: [seller]
      template: disbursement_notice
      content:
        subject: "Funds Disbursed"
        body: |
          Your proceeds have been disbursed:
          Amount: {seller_proceeds}
          To: {seller_bank}
          Reference: {reference_number}

  # Documents
  documents:
    closing_statement:
      template: closing_statement_template
      sections:
        - transaction_summary
        - purchase_price_breakdown
        - prorations
        - seller_debits_credits
        - buyer_debits_credits
        - disbursement_summary
      signatures:
        - buyer
        - seller
        - closing_agent

    deed:
      template: property_deed_template
      type: warranty_deed
      elements:
        - grantor_seller
        - grantee_buyer
        - property_description
        - consideration
        - warranties
      notarization: required

    possession_acknowledgment:
      template: possession_form
      elements:
        - property_address
        - condition_statement
        - items_transferred
        - meter_readings
        - signatures
      signatures:
        - buyer
        - seller

  # Metrics
  metrics:
    - name: on_time_closing_rate
      description: Closings on originally scheduled date
      target: "> 85%"
    - name: funding_accuracy
      description: Wire amounts correct first time
      target: "> 99%"
    - name: disbursement_timing
      description: Same-day or next-day disbursement
      target: "> 95%"
    - name: recording_compliance
      description: Recorded within 30 days
      target: "100%"

  # Error Handling
  error_handling:
    funds_not_received:
      action: delay_closing
      notification: all_parties
      deadline_extension: required
    document_issue:
      action: identify_and_correct
      escalation: immediate
    title_issue_at_closing:
      action: pause_closing
      resolution: required_before_proceeding

  # Audit Trail
  audit:
    tracked_events:
      - closing_initiated
      - documents_prepared
      - statements_reviewed
      - funds_received
      - closing_started
      - documents_signed
      - funds_disbursed
      - title_recorded
      - possession_transferred
      - closing_completed
    retention: 10_years
