# Due Diligence Workflow
# F5 Framework v2.0 - Real Estate/Transaction
# Property inspection and verification process

workflow:
  name: DueDiligenceWorkflow
  name_vi: Quy trình thẩm định
  name_ja: デューデリジェンスワークフロー
  domain: real-estate
  subdomain: transaction
  version: "1.0.0"

  description: |
    Comprehensive due diligence workflow for real estate transactions
    including title verification, physical inspection, legal review,
    and issue resolution.

  # Workflow Metadata
  metadata:
    owner: transaction_team
    estimated_duration: 10-30_days
    complexity: high
    automation_level: partially_automated
    requires_human_approval: true

  # Actors
  actors:
    buyer:
      role: Purchaser
      responsibilities:
        - Approve inspectors
        - Review findings
        - Decide on issues
        - Approve to proceed
    buyer_agent:
      role: Buyer's representative
      responsibilities:
        - Coordinate inspections
        - Compile findings
        - Negotiate repairs
        - Track deadlines
    seller:
      role: Property owner
      responsibilities:
        - Provide access
        - Respond to requests
        - Address issues
    listing_agent:
      role: Seller's representative
      responsibilities:
        - Coordinate access
        - Facilitate responses
    title_company:
      role: Title examiner
      responsibilities:
        - Conduct title search
        - Report findings
        - Issue commitment
    inspector:
      role: Property inspector
      responsibilities:
        - Physical inspection
        - Document findings
        - Provide report
    attorney:
      role: Legal advisor
      responsibilities:
        - Legal document review
        - Compliance verification
        - Risk assessment

  # Workflow States
  states:
    dd_initiation:
      name: Due Diligence Initiation
      name_vi: Khởi tạo thẩm định
      description: Start due diligence period
      entry_actions:
        - calculate_dd_deadline
        - create_dd_checklist
        - notify_all_parties
      dd_period: per_contract

    title_search:
      name: Title Search
      name_vi: Tra cứu quyền sở hữu
      description: Examining property title history
      entry_actions:
        - order_title_search
        - set_title_deadline
      parallel: true
      expected_duration: 5-10_days

    physical_inspection:
      name: Physical Inspection
      name_vi: Kiểm tra thực địa
      description: Property condition inspection
      entry_actions:
        - schedule_inspection
        - notify_seller_for_access
      parallel: true
      expected_duration: 3-7_days

    legal_review:
      name: Legal Review
      name_vi: Xem xét pháp lý
      description: Legal compliance verification
      entry_actions:
        - assign_attorney
        - provide_documents
      parallel: true
      expected_duration: 5-10_days

    financial_review:
      name: Financial Review
      name_vi: Xem xét tài chính
      description: Tax and financial status review
      entry_actions:
        - request_tax_records
        - verify_utility_status
      parallel: true
      expected_duration: 3-5_days

    environmental_review:
      name: Environmental Review
      name_vi: Đánh giá môi trường
      description: Environmental assessment if required
      entry_actions:
        - determine_if_required
        - order_assessment
      parallel: true
      conditional: per_property_type
      expected_duration: 7-14_days

    findings_compilation:
      name: Findings Compilation
      name_vi: Tổng hợp kết quả
      description: Compile all DD findings
      entry_actions:
        - collect_all_reports
        - create_summary
      inputs:
        - title_report
        - inspection_report
        - legal_review
        - financial_status
        - environmental_report

    issues_identified:
      name: Issues Identified
      name_vi: Phát hiện vấn đề
      description: DD revealed issues requiring attention
      entry_actions:
        - categorize_issues
        - assess_severity
        - determine_resolution_options

    negotiation:
      name: Repair/Credit Negotiation
      name_vi: Đàm phán sửa chữa/giảm giá
      description: Negotiating issue resolution
      entry_actions:
        - prepare_repair_request
        - submit_to_seller
      expected_duration: 3-7_days

    resolution_in_progress:
      name: Resolution in Progress
      name_vi: Đang giải quyết
      description: Issues being addressed
      entry_actions:
        - track_resolution_items
        - schedule_follow_ups

    dd_completed:
      name: Due Diligence Completed
      name_vi: Thẩm định hoàn tất
      description: All DD completed satisfactorily
      entry_actions:
        - document_completion
        - buyer_acknowledgment
      terminal: false
      next_workflow: closing_workflow

    dd_waived:
      name: Due Diligence Waived
      name_vi: Miễn thẩm định
      description: Buyer waives remaining DD rights
      entry_actions:
        - document_waiver
        - buyer_signature_required
      terminal: false
      next_workflow: closing_workflow

    dd_failed:
      name: Due Diligence Failed
      name_vi: Thẩm định thất bại
      description: Buyer terminating due to DD issues
      entry_actions:
        - document_termination_reason
        - process_deposit_return
      terminal: true

    dd_expired:
      name: Due Diligence Expired
      name_vi: Thẩm định hết hạn
      description: DD period expired without action
      entry_actions:
        - notify_all_parties
        - determine_default_action
      terminal: depends_on_contract

  # Transitions
  transitions:
    - from: dd_initiation
      to: [title_search, physical_inspection, legal_review, financial_review]
      trigger: start_parallel_checks
      parallel: true
      actions:
        - initiate_all_checks

    - from: dd_initiation
      to: environmental_review
      trigger: environmental_required
      conditions:
        - property_type_requires_environmental
        - buyer_requests_environmental
      actions:
        - order_environmental_assessment

    - from: [title_search, physical_inspection, legal_review, financial_review, environmental_review]
      to: findings_compilation
      trigger: all_checks_complete
      conditions:
        - all_parallel_checks_done
      join: true
      actions:
        - compile_findings
        - generate_summary_report

    - from: findings_compilation
      to: dd_completed
      trigger: no_issues
      conditions:
        - no_critical_issues
        - no_major_issues
        - buyer_satisfied
      actions:
        - document_clean_dd
        - proceed_to_closing

    - from: findings_compilation
      to: issues_identified
      trigger: issues_found
      conditions:
        - has_critical_or_major_issues
      actions:
        - categorize_by_severity
        - determine_options

    - from: issues_identified
      to: negotiation
      trigger: buyer_requests_repairs
      actions:
        - prepare_repair_request_list
        - submit_to_seller

    - from: issues_identified
      to: dd_completed
      trigger: buyer_accepts_issues
      conditions:
        - buyer_written_acceptance
      actions:
        - document_issue_acceptance

    - from: issues_identified
      to: dd_failed
      trigger: buyer_terminates
      conditions:
        - within_dd_period
        - valid_reason
      actions:
        - process_termination
        - initiate_deposit_return

    - from: negotiation
      to: resolution_in_progress
      trigger: seller_agrees_to_repairs
      actions:
        - document_agreement
        - schedule_repairs

    - from: negotiation
      to: dd_completed
      trigger: credit_agreed
      conditions:
        - credit_amount_accepted
        - documented_in_writing
      actions:
        - document_credit
        - adjust_closing_statement

    - from: negotiation
      to: dd_failed
      trigger: cannot_reach_agreement
      conditions:
        - negotiation_failed
        - within_dd_period
      actions:
        - document_failure
        - process_termination

    - from: resolution_in_progress
      to: dd_completed
      trigger: issues_resolved
      conditions:
        - all_repairs_complete
        - buyer_verification
      actions:
        - document_completion
        - buyer_sign_off

    - from: [dd_initiation, title_search, physical_inspection, legal_review, financial_review, findings_compilation, issues_identified, negotiation]
      to: dd_waived
      trigger: buyer_waives
      conditions:
        - buyer_written_waiver
      actions:
        - document_waiver
        - acknowledge_risks

    - from: [dd_initiation, title_search, physical_inspection, legal_review, financial_review, findings_compilation]
      to: dd_expired
      trigger: deadline_passed
      conditions:
        - dd_deadline_exceeded
        - no_extension_granted
      actions:
        - determine_contract_default

  # Activities
  activities:
    conduct_title_search:
      name: Conduct Title Search
      name_vi: Thực hiện tra cứu quyền sở hữu
      actor: title_company
      steps:
        - step: 1
          name: Order title search
          inputs:
            - property_address
            - certificate_number
        - step: 2
          name: Search public records
          items:
            - land_registration_records
            - court_records
            - tax_records
            - municipal_records
        - step: 3
          name: Examine chain of title
          period: 30_years_minimum
        - step: 4
          name: Identify encumbrances
          types:
            - mortgages
            - liens
            - easements
            - restrictions
            - judgments
        - step: 5
          name: Prepare title report
          outputs:
            - ownership_history
            - current_owners
            - encumbrances_list
            - exceptions
            - title_status
        - step: 6
          name: Issue title commitment
          if: title_clear_or_clearable

    conduct_physical_inspection:
      name: Conduct Physical Inspection
      name_vi: Thực hiện kiểm tra thực địa
      actor: inspector
      steps:
        - step: 1
          name: Schedule inspection
          coordinate_with:
            - seller_for_access
            - buyer_attendance_optional
        - step: 2
          name: Inspect structural elements
          items:
            - foundation
            - walls
            - roof
            - floors
            - ceilings
        - step: 3
          name: Inspect systems
          items:
            - electrical
            - plumbing
            - hvac
            - water_heater
        - step: 4
          name: Inspect exterior
          items:
            - landscaping
            - drainage
            - walkways
            - fencing
            - parking
        - step: 5
          name: Document findings
          methods:
            - photographs
            - measurements
            - notes
        - step: 6
          name: Prepare inspection report
          sections:
            - executive_summary
            - findings_by_area
            - severity_ratings
            - recommended_actions
            - estimated_costs

    conduct_legal_review:
      name: Conduct Legal Review
      name_vi: Thực hiện xem xét pháp lý
      actor: attorney
      steps:
        - step: 1
          name: Review property certificate
          checks:
            - authenticity
            - current_ownership
            - land_use_purpose
            - restrictions
        - step: 2
          name: Verify zoning compliance
          checks:
            - current_use_permitted
            - building_compliance
            - setback_requirements
        - step: 3
          name: Check permits
          items:
            - construction_permits
            - occupancy_permits
            - renovation_permits
        - step: 4
          name: Review HOA if applicable
          items:
            - hoa_documents
            - financial_statements
            - meeting_minutes
            - pending_assessments
        - step: 5
          name: Check for disputes
          searches:
            - court_records
            - administrative_complaints
            - neighbor_disputes
        - step: 6
          name: Prepare legal opinion
          outputs:
            - legal_status_summary
            - identified_risks
            - recommendations

    negotiate_repairs:
      name: Negotiate Repairs
      name_vi: Đàm phán sửa chữa
      actors: [buyer_agent, listing_agent]
      steps:
        - step: 1
          name: Categorize issues
          categories:
            critical:
              description: Safety/structural issues
              typical_request: must_repair
            major:
              description: Significant defects
              typical_request: repair_or_credit
            minor:
              description: Cosmetic/minor issues
              typical_request: often_not_requested
        - step: 2
          name: Prepare repair request
          document:
            - items_requested
            - supporting_evidence
            - deadline_for_response
        - step: 3
          name: Submit to seller
          via: listing_agent
        - step: 4
          name: Seller response
          options:
            - agree_to_all
            - agree_to_some
            - offer_credit_instead
            - decline_all
        - step: 5
          name: Counter-negotiate if needed
          max_rounds: 3
        - step: 6
          name: Document agreement
          form: repair_addendum

  # Checklists
  checklists:
    title_verification:
      items:
        - ownership_verified
        - no_undisclosed_liens
        - easements_identified
        - restrictions_disclosed
        - mortgages_will_be_released
        - taxes_current

    physical_inspection:
      items:
        - structural_sound
        - roof_condition_acceptable
        - electrical_safe
        - plumbing_functional
        - hvac_operational
        - no_pest_infestation
        - no_water_damage
        - no_mold_issues

    legal_compliance:
      items:
        - zoning_compliant
        - permits_in_order
        - no_code_violations
        - no_pending_litigation
        - hoa_in_good_standing

    financial_status:
      items:
        - property_taxes_current
        - no_tax_liens
        - utilities_current
        - hoa_fees_current

  # Business Rules Integration
  business_rules:
    - rule_ref: BR-DD-001  # Critical issue handling
    - rule_ref: BR-DD-002  # Extension process
    - rule_ref: BR-DD-003  # Waiver documentation
    - rule_ref: BR-TTS-001  # Search depth
    - rule_ref: BR-TTS-002  # Lien release

  # Notifications
  notifications:
    dd_started:
      recipients: [all_parties]
      template: dd_started
      content:
        subject: "Due Diligence Period Started"
        body: |
          The due diligence period has begun.
          Deadline: {dd_deadline}
          Please coordinate for inspections and reviews.

    inspection_scheduled:
      recipients: [buyer, seller, agents]
      template: inspection_scheduled
      content:
        subject: "Property Inspection Scheduled"
        body: |
          Property inspection scheduled:
          Date: {date}
          Time: {time}
          Inspector: {inspector_name}
          Please ensure access is available.

    title_report_ready:
      recipients: [buyer, buyer_agent]
      template: title_report
      content:
        subject: "Title Search Report Ready"
        body: |
          The title search report is ready for review.
          Status: {title_status}
          Please review the attached report.

    issues_found:
      recipients: [buyer, buyer_agent]
      template: dd_issues
      priority: high
      content:
        subject: "Due Diligence Issues Identified"
        body: |
          Issues have been identified during due diligence:
          Critical: {critical_count}
          Major: {major_count}
          Please review and determine next steps.

    dd_deadline_reminder:
      recipients: [buyer, buyer_agent]
      template: dd_deadline
      timing: [7_days, 3_days, 1_day]
      content:
        subject: "Due Diligence Deadline Approaching"
        body: |
          Reminder: Due diligence deadline is {deadline}.
          {days_remaining} days remaining.
          Please complete all reviews.

    dd_completed:
      recipients: [all_parties]
      template: dd_completed
      content:
        subject: "Due Diligence Completed"
        body: |
          Due diligence has been completed satisfactorily.
          The transaction will proceed to closing.

  # Documents
  documents:
    title_report:
      generated_by: title_company
      sections:
        - property_description
        - ownership_history
        - current_ownership
        - encumbrances
        - exceptions
        - title_opinion

    inspection_report:
      generated_by: inspector
      sections:
        - summary
        - structural
        - electrical
        - plumbing
        - hvac
        - exterior
        - recommendations

    repair_request:
      template: repair_request_form
      fields:
        - item_description
        - severity
        - requested_action
        - supporting_evidence

    repair_addendum:
      template: repair_addendum_form
      fields:
        - agreed_repairs
        - credits
        - completion_deadline
        - verification_method

    dd_completion_certificate:
      template: dd_completion
      signatures:
        - buyer
        - buyer_agent

  # Metrics
  metrics:
    - name: dd_completion_rate
      description: DD completed within period
      target: "> 90%"
    - name: average_dd_duration
      description: Average days for DD completion
      target: "< 14 days"
    - name: issue_resolution_rate
      description: Issues resolved before closing
      target: "> 95%"
    - name: termination_rate
      description: Transactions terminated during DD
      target: "< 10%"

  # Error Handling
  error_handling:
    inspection_access_denied:
      action: reschedule_with_notice
      escalation: after_2_attempts
    title_issues_critical:
      action: notify_immediately
      requires: buyer_decision
    deadline_approaching:
      action: reminder_sequence
      extension_option: available

  # Audit Trail
  audit:
    tracked_events:
      - dd_initiated
      - inspection_scheduled
      - inspection_completed
      - title_search_ordered
      - title_report_received
      - legal_review_completed
      - issues_identified
      - repair_request_sent
      - repair_agreement_reached
      - dd_completed
      - dd_waived
      - dd_terminated
    retention: 7_years
