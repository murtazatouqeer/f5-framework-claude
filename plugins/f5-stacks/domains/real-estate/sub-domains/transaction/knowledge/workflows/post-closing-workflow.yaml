# Post-Closing Workflow
# F5 Framework v2.0 - Real Estate/Transaction
# Activities after transaction closing

workflow:
  name: PostClosingWorkflow
  name_vi: Quy tr√¨nh sau ƒë√≥ng giao d·ªãch
  name_ja: Ê±∫Ê∏àÂæå„ÉØ„Éº„ÇØ„Éï„É≠„Éº
  domain: real-estate
  subdomain: transaction
  version: "1.0.0"

  description: |
    Post-closing workflow covering land registration completion,
    certificate issuance, commission processing, document archiving,
    and relationship management.

  # Workflow Metadata
  metadata:
    owner: operations_team
    estimated_duration: 30-60_days
    complexity: moderate
    automation_level: mostly_automated
    requires_human_approval: selective

  # Actors
  actors:
    buyer:
      role: New property owner
      responsibilities:
        - Complete address change
        - Set up utilities
        - Obtain insurance
        - Receive certificate
    seller:
      role: Former owner
      responsibilities:
        - Forward mail
        - Cancel services
        - Receive proceeds
    buyer_agent:
      role: Buyer's representative
      responsibilities:
        - Follow up on registration
        - Deliver certificate
        - Provide ongoing support
    listing_agent:
      role: Seller's representative
      responsibilities:
        - Close listing
        - Follow up with seller
    land_office:
      role: VƒÉn ph√≤ng ƒëƒÉng k√Ω ƒë·∫•t ƒëai
      responsibilities:
        - Process registration
        - Issue new certificate
    agency_admin:
      role: Brokerage administration
      responsibilities:
        - Process commissions
        - Archive files
        - Report compliance

  # Workflow States
  states:
    post_closing_initiation:
      name: Post-Closing Initiation
      name_vi: Kh·ªüi t·∫°o sau ƒë√≥ng
      description: Initiating post-closing activities
      entry_actions:
        - create_post_closing_checklist
        - schedule_follow_ups
        - initiate_parallel_activities

    land_registration:
      name: Land Registration
      name_vi: ƒêƒÉng k√Ω ƒë·∫•t ƒëai
      description: Processing land registration
      entry_actions:
        - submit_registration_application
        - track_status
      deadline: 30_days_from_closing
      parallel: true

    certificate_processing:
      name: Certificate Processing
      name_vi: X·ª≠ l√Ω gi·∫•y ch·ª©ng nh·∫≠n
      description: Awaiting new certificate issuance
      entry_actions:
        - track_certificate_status
        - follow_up_if_delayed
      expected_duration: 15-30_working_days

    commission_processing:
      name: Commission Processing
      name_vi: X·ª≠ l√Ω hoa h·ªìng
      description: Processing agent commissions
      entry_actions:
        - calculate_final_splits
        - process_payments
      parallel: true

    document_archiving:
      name: Document Archiving
      name_vi: L∆∞u tr·ªØ t√†i li·ªáu
      description: Archiving transaction documents
      entry_actions:
        - compile_closing_file
        - scan_documents
        - organize_archive
      parallel: true

    client_follow_up:
      name: Client Follow-Up
      name_vi: Theo d√µi kh√°ch h√†ng
      description: Post-sale client care
      entry_actions:
        - schedule_check_ins
        - send_satisfaction_survey
      parallel: true

    certificate_received:
      name: Certificate Received
      name_vi: ƒê√£ nh·∫≠n gi·∫•y ch·ª©ng nh·∫≠n
      description: New certificate received from land office
      entry_actions:
        - verify_certificate_details
        - notify_buyer
        - schedule_delivery

    certificate_delivered:
      name: Certificate Delivered
      name_vi: ƒê√£ giao gi·∫•y ch·ª©ng nh·∫≠n
      description: Certificate delivered to buyer
      entry_actions:
        - obtain_receipt
        - update_records

    transaction_archived:
      name: Transaction Archived
      name_vi: Giao d·ªãch ƒë√£ l∆∞u tr·ªØ
      description: All post-closing complete
      entry_actions:
        - finalize_archive
        - close_transaction_file
        - generate_final_report
      terminal: true

    registration_issue:
      name: Registration Issue
      name_vi: V·∫•n ƒë·ªÅ ƒëƒÉng k√Ω
      description: Problem with land registration
      entry_actions:
        - identify_issue
        - notify_parties
        - create_resolution_plan

  # Transitions
  transitions:
    - from: post_closing_initiation
      to: [land_registration, commission_processing, document_archiving, client_follow_up]
      trigger: start_activities
      parallel: true
      actions:
        - initiate_all_parallel_activities

    - from: land_registration
      to: certificate_processing
      trigger: registration_submitted
      conditions:
        - application_accepted
      actions:
        - record_submission_date
        - set_follow_up_reminders

    - from: land_registration
      to: registration_issue
      trigger: registration_rejected
      actions:
        - document_rejection_reason
        - assess_resolution

    - from: registration_issue
      to: land_registration
      trigger: issue_resolved
      actions:
        - resubmit_application

    - from: certificate_processing
      to: certificate_received
      trigger: certificate_ready
      actions:
        - collect_certificate
        - verify_details

    - from: certificate_received
      to: certificate_delivered
      trigger: deliver_certificate
      conditions:
        - buyer_available
      actions:
        - schedule_delivery
        - obtain_signature

    - from: [certificate_delivered, commission_processing, document_archiving, client_follow_up]
      to: transaction_archived
      trigger: all_complete
      join: true
      conditions:
        - certificate_delivered
        - commissions_paid
        - documents_archived
        - follow_up_complete
      actions:
        - close_file

  # Activities
  activities:
    complete_land_registration:
      name: Complete Land Registration
      name_vi: Ho√†n t·∫•t ƒëƒÉng k√Ω ƒë·∫•t ƒëai
      actor: buyer_agent
      steps:
        - step: 1
          name: Prepare registration package
          documents:
            - notarized_contract
            - tax_payment_receipts
            - registration_application
            - old_certificate
            - party_id_copies
        - step: 2
          name: Submit to land office
          location: district_land_registration_office
          fee: registration_fee
        - step: 3
          name: Receive submission receipt
          contains:
            - submission_number
            - expected_completion_date
        - step: 4
          name: Track status
          frequency: weekly
          method: online_or_in_person
        - step: 5
          name: Collect certificate
          when: processing_complete
          bring:
            - submission_receipt
            - authorized_person_id
        - step: 6
          name: Verify certificate details
          check:
            - owner_name_correct
            - property_details_correct
            - no_errors

    process_commissions:
      name: Process Commission Payments
      name_vi: X·ª≠ l√Ω thanh to√°n hoa h·ªìng
      actor: agency_admin
      steps:
        - step: 1
          name: Verify closing statement
          confirm:
            - commission_amount
            - split_percentages
        - step: 2
          name: Calculate agent splits
          formula: |
            agent_gross = side_commission * agent_split_percent
            agent_net = agent_gross - fees - deductions
        - step: 3
          name: Process agency payment
          if: receiving_from_closing
          timing: within_24_hours_of_receipt
        - step: 4
          name: Calculate withholding
          items:
            - taxes_if_applicable
            - pending_draws
            - other_deductions
        - step: 5
          name: Process agent payment
          timing: per_agency_policy
          method:
            - direct_deposit
            - check
        - step: 6
          name: Issue statements
          to:
            - agents
            - accounting
        - step: 7
          name: Process referral fees
          if: referral_involved
          timing: same_as_agent_payment

    archive_transaction:
      name: Archive Transaction Documents
      name_vi: L∆∞u tr·ªØ t√†i li·ªáu giao d·ªãch
      actor: agency_admin
      steps:
        - step: 1
          name: Compile physical file
          sections:
            - listing_documents
            - offer_and_contracts
            - due_diligence
            - closing_documents
            - correspondence
        - step: 2
          name: Scan documents
          format: PDF
          naming: transaction_id_document_type
        - step: 3
          name: Upload to DMS
          location: document_management_system
          structure: per_archive_policy
        - step: 4
          name: Verify completeness
          checklist: archive_checklist
        - step: 5
          name: Store physical file
          location: secure_storage
          retention: per_retention_policy
        - step: 6
          name: Update transaction record
          status: archived
          archive_date: today
          archive_location: recorded

    buyer_follow_up:
      name: Buyer Follow-Up Program
      name_vi: Ch∆∞∆°ng tr√¨nh theo d√µi ng∆∞·ªùi mua
      actor: buyer_agent
      steps:
        - step: 1
          name: Same-day thank you
          timing: day_of_closing
          method: phone_call_or_text
        - step: 2
          name: Week 1 check-in
          timing: 7_days_post_closing
          topics:
            - move_in_status
            - any_issues
            - utility_setup
        - step: 3
          name: Send satisfaction survey
          timing: 14_days_post_closing
          method: email
        - step: 4
          name: 30-day follow-up
          timing: 30_days_post_closing
          topics:
            - settling_in
            - referral_request
            - review_request
        - step: 5
          name: Certificate delivery
          when: certificate_ready
          method: in_person_preferred
        - step: 6
          name: Anniversary reminder
          timing: 1_year
          method: card_or_email
        - step: 7
          name: Add to CRM nurture
          for: ongoing_relationship

    seller_follow_up:
      name: Seller Follow-Up Program
      name_vi: Ch∆∞∆°ng tr√¨nh theo d√µi ng∆∞·ªùi b√°n
      actor: listing_agent
      steps:
        - step: 1
          name: Closing day thank you
          timing: day_of_closing
        - step: 2
          name: Confirm proceeds received
          timing: next_business_day
        - step: 3
          name: Send satisfaction survey
          timing: 7_days_post_closing
        - step: 4
          name: Request testimonial
          timing: 14_days_post_closing
          if: positive_experience
        - step: 5
          name: Stay in touch
          for: future_business

  # Checklists
  checklists:
    land_registration:
      items:
        - registration_application_submitted
        - receipt_obtained
        - status_tracked
        - certificate_collected
        - certificate_verified
        - certificate_delivered

    commission_processing:
      items:
        - closing_statement_verified
        - agency_payment_received
        - agent_splits_calculated
        - agent_payments_processed
        - referral_fees_paid
        - statements_issued
        - reporting_complete

    document_archive:
      items:
        - all_documents_collected
        - documents_scanned
        - uploaded_to_dms
        - physical_file_organized
        - file_stored
        - retention_scheduled

    buyer_care:
      items:
        - thank_you_sent
        - week_1_check_in
        - survey_sent
        - 30_day_follow_up
        - certificate_delivered
        - added_to_crm

  # Business Rules Integration
  business_rules:
    - rule_ref: BR-CLO-021  # Land registration deadline
    - rule_ref: BR-COM-020  # Commission payment timing
    - rule_ref: BR-COM-022  # Installment commission
    - rule_ref: BR-CLO-052  # Document retention

  # Notifications
  notifications:
    registration_submitted:
      recipients: [buyer, buyer_agent]
      template: registration_submitted
      content:
        subject: "Land Registration Submitted"
        body: |
          Your land registration has been submitted.
          Submission #: {submission_number}
          Expected completion: {expected_date}
          We will notify you when the certificate is ready.

    certificate_ready:
      recipients: [buyer, buyer_agent]
      template: certificate_ready
      priority: high
      content:
        subject: "üéâ Your Property Certificate is Ready!"
        body: |
          Great news! Your new property certificate has been
          issued by the Land Registration Office.

          We will contact you to arrange delivery.

    commission_paid:
      recipients: [agent]
      template: commission_statement
      content:
        subject: "Commission Payment Processed"
        body: |
          Your commission for {property_address} has been processed.

          Gross Commission: {gross_amount}
          Deductions: {deductions}
          Net Payment: {net_amount}

          See attached statement for details.

    thank_you:
      recipients: [buyer, seller]
      template: thank_you
      content:
        subject: "Thank You for Your Business!"
        body: |
          Congratulations on your successful transaction!

          It was a pleasure working with you on
          {property_address}.

          Please don't hesitate to reach out if you need
          anything or know someone who could use our services.

    survey_request:
      recipients: [buyer, seller]
      template: satisfaction_survey
      content:
        subject: "How Did We Do?"
        body: |
          We value your feedback! Please take a moment to
          share your experience with our recent transaction.

          {survey_link}

          Your feedback helps us improve our services.

    registration_issue:
      recipients: [buyer, buyer_agent]
      template: registration_problem
      priority: high
      content:
        subject: "‚ö†Ô∏è Land Registration Issue"
        body: |
          We encountered an issue with your land registration:

          Issue: {issue_description}

          We are working to resolve this and will update you shortly.

  # Documents
  documents:
    certificate_delivery_receipt:
      template: delivery_receipt
      fields:
        - certificate_number
        - property_address
        - recipient_name
        - delivery_date
        - recipient_signature

    commission_statement:
      template: commission_statement
      fields:
        - transaction_details
        - gross_commission
        - split_calculations
        - deductions
        - net_payment
        - payment_date

    transaction_summary:
      template: transaction_summary
      fields:
        - transaction_overview
        - key_dates
        - financial_summary
        - parties_involved
        - important_notes

    archive_index:
      template: archive_index
      fields:
        - document_list
        - storage_locations
        - retention_dates
        - access_permissions

  # Metrics
  metrics:
    - name: registration_completion_time
      description: Days from closing to certificate issuance
      target: "< 30 days"
    - name: commission_payment_time
      description: Days from closing to agent payment
      target: "< 3 days"
    - name: client_satisfaction_score
      description: Average survey score
      target: "> 4.5/5"
    - name: referral_rate
      description: Clients providing referrals
      target: "> 30%"
    - name: review_collection_rate
      description: Clients leaving reviews
      target: "> 50%"

  # Schedules
  schedules:
    registration_follow_up:
      frequency: weekly
      until: certificate_received
      action: check_status

    survey_reminders:
      timing:
        - 14_days: initial_send
        - 21_days: reminder_if_no_response
      max_reminders: 2

    anniversary_program:
      timing: annual
      duration: indefinite
      content: personalized_card

  # Error Handling
  error_handling:
    registration_delayed:
      threshold: 45_days
      action: escalate_inquiry
      notification: buyer_and_agent
    commission_dispute:
      action: hold_payment
      resolution: per_dispute_process
    certificate_error:
      action: request_correction
      timeline: immediate

  # Audit Trail
  audit:
    tracked_events:
      - post_closing_initiated
      - registration_submitted
      - certificate_received
      - certificate_delivered
      - commission_calculated
      - commission_paid
      - documents_archived
      - follow_up_completed
      - transaction_closed
    retention: 10_years
