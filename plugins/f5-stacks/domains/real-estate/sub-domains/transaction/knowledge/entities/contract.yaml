# Contract Entity
# F5 Framework v2.0 - Real Estate/Transaction
# Real estate purchase/lease contract management

entity:
  name: Contract
  name_vi: Hợp đồng
  name_ja: 契約書
  domain: real-estate
  subdomain: transaction
  version: "1.0.0"

  description: |
    Represents the legal contract between buyer and seller for property
    transfer. Handles contract drafting, signing, notarization, and
    amendments according to Vietnam real estate law requirements.

  # Database Configuration
  database:
    table_name: contracts
    primary_key: id
    indexes:
      - columns: [contract_number]
        unique: true
      - columns: [transaction_id]
        unique: true
      - columns: [status]
      - columns: [notarized_at]

  # Attributes
  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true

    - name: contract_number
      type: string
      format: "CTR-{YYYY}-{XXXXXX}"
      unique: true
      description: Contract number
      example: "CTR-2024-A1B2C3"

    - name: transaction_id
      type: uuid
      required: true
      foreign_key: transactions.id
      description: Associated transaction

    # Status
    - name: status
      type: enum
      values:
        - draft
        - pending_review
        - pending_signatures
        - partially_signed
        - fully_signed
        - pending_notarization
        - notarized
        - amended
        - terminated
        - completed
      default: draft
      description: Contract status

    # Type
    - name: contract_type
      type: enum
      values:
        - sale_purchase_agreement
        - lease_agreement
        - option_contract
        - assignment_agreement
        - memorandum_of_understanding
      required: true
      description: Type of contract

    - name: contract_subtype
      type: string
      nullable: true
      description: Additional classification

    # Template
    - name: template_id
      type: uuid
      nullable: true
      description: Contract template used

    - name: template_version
      type: string
      nullable: true

    # Parties - Seller
    - name: seller_parties
      type: jsonb
      required: true
      description: Seller party details
      schema:
        type: array
        items:
          type: object
          properties:
            party_id: { type: string }
            user_id: { type: string }
            name: { type: string }
            id_number: { type: string }
            id_type: { type: string, enum: [cmnd, cccd, passport] }
            id_issued_date: { type: string, format: date }
            id_issued_place: { type: string }
            address: { type: string }
            phone: { type: string }
            role: { type: string, enum: [owner, co_owner, representative] }
            share_percent: { type: number }
            power_of_attorney: { type: string }

    # Parties - Buyer
    - name: buyer_parties
      type: jsonb
      required: true
      description: Buyer party details
      schema:
        type: array
        items:
          type: object
          properties:
            party_id: { type: string }
            user_id: { type: string }
            name: { type: string }
            id_number: { type: string }
            id_type: { type: string, enum: [cmnd, cccd, passport] }
            id_issued_date: { type: string, format: date }
            id_issued_place: { type: string }
            address: { type: string }
            phone: { type: string }
            role: { type: string, enum: [buyer, co_buyer, representative] }
            share_percent: { type: number }
            power_of_attorney: { type: string }

    # Witnesses
    - name: witnesses
      type: jsonb
      nullable: true
      description: Contract witnesses
      schema:
        type: array
        items:
          type: object
          properties:
            name: { type: string }
            id_number: { type: string }
            address: { type: string }
            relationship: { type: string }

    # Property Description
    - name: property_description
      type: text
      required: true
      description: Legal property description

    - name: property_address
      type: text
      required: true
      description: Full property address

    - name: legal_description
      type: text
      nullable: true
      description: Technical legal description

    - name: title_reference
      type: jsonb
      description: Property title details
      schema:
        type: object
        properties:
          certificate_type: { type: string, enum: [pink_book, red_book] }
          certificate_number: { type: string }
          issued_date: { type: string, format: date }
          issued_by: { type: string }
          land_parcel_number: { type: string }
          map_sheet_number: { type: string }

    # Financial Terms
    - name: purchase_price
      type: decimal
      precision: 15
      scale: 2
      required: true
      description: Total purchase price

    - name: currency
      type: string
      length: 3
      default: "VND"

    - name: price_in_words
      type: string
      description: Price written in words

    - name: deposit_amount
      type: decimal
      precision: 15
      scale: 2
      description: Deposit amount

    - name: payment_schedule
      type: jsonb
      description: Payment milestones
      schema:
        type: array
        items:
          type: object
          properties:
            sequence: { type: integer }
            milestone: { type: string }
            amount: { type: number }
            percent: { type: number }
            due_date: { type: string, format: date }
            payment_method: { type: string }

    # Key Dates
    - name: effective_date
      type: date
      description: Contract effective date

    - name: closing_date
      type: date
      required: true
      description: Scheduled closing date

    - name: possession_date
      type: date
      description: Property handover date

    - name: due_diligence_deadline
      type: date
      nullable: true
      description: DD period end date

    # Clauses
    - name: standard_clauses
      type: array
      items: uuid
      description: Standard clause references

    - name: special_conditions
      type: jsonb
      description: Special conditions
      schema:
        type: array
        items:
          type: object
          properties:
            condition_number: { type: integer }
            title: { type: string }
            description: { type: string }
            deadline: { type: string, format: date }

    - name: contingencies
      type: jsonb
      description: Contract contingencies
      schema:
        type: array
        items:
          type: object
          properties:
            type: { type: string }
            description: { type: string }
            deadline: { type: string, format: date }
            status: { type: string, enum: [active, satisfied, waived, failed] }

    # Representations & Warranties
    - name: seller_representations
      type: jsonb
      description: Seller's representations
      schema:
        type: array
        items:
          type: object
          properties:
            representation: { type: string }
            acknowledged: { type: boolean }

    - name: buyer_representations
      type: jsonb
      description: Buyer's representations

    # Signatures
    - name: signatures
      type: jsonb
      description: Signature records
      schema:
        type: array
        items:
          type: object
          properties:
            party_id: { type: string }
            party_name: { type: string }
            party_role: { type: string }
            signed_at: { type: string, format: datetime }
            signature_type: { type: string, enum: [wet, electronic] }
            signature_url: { type: string }
            ip_address: { type: string }
            witnessed_by: { type: string }

    - name: all_signed_at
      type: timestamp
      nullable: true
      description: When all parties signed

    - name: signing_location
      type: string
      nullable: true
      description: Where contract was signed

    # Notarization
    - name: requires_notarization
      type: boolean
      default: true
      description: Whether notarization required

    - name: notarized_at
      type: timestamp
      nullable: true
      description: Notarization datetime

    - name: notary_name
      type: string
      nullable: true
      description: Notary public name

    - name: notary_office
      type: string
      nullable: true
      description: Notary office name

    - name: notary_certificate_number
      type: string
      nullable: true
      description: Notary certificate number

    - name: notarization_fee
      type: decimal
      precision: 12
      scale: 2
      nullable: true

    # Documents
    - name: contract_document_url
      type: string
      nullable: true
      description: Main contract document

    - name: contract_document_version
      type: integer
      default: 1

    - name: attachments
      type: jsonb
      description: Contract attachments
      schema:
        type: array
        items:
          type: object
          properties:
            name: { type: string }
            type: { type: string }
            url: { type: string }
            uploaded_at: { type: string, format: datetime }

    # Amendments
    - name: amendments
      type: jsonb
      description: Contract amendments
      schema:
        type: array
        items:
          type: object
          properties:
            amendment_number: { type: integer }
            date: { type: string, format: date }
            description: { type: string }
            changes: { type: array, items: { type: string } }
            signed_by: { type: array, items: { type: string } }
            notarized: { type: boolean }
            document_url: { type: string }

    # Termination
    - name: terminated_at
      type: timestamp
      nullable: true

    - name: termination_reason
      type: string
      nullable: true

    - name: termination_by
      type: uuid
      nullable: true

    # Language
    - name: language
      type: string
      default: "vi"
      description: Contract language

    - name: has_translation
      type: boolean
      default: false

    - name: translation_language
      type: string
      nullable: true

    # Legal Review
    - name: legal_review_status
      type: enum
      values:
        - not_reviewed
        - under_review
        - approved
        - changes_requested
      default: not_reviewed

    - name: reviewed_by
      type: uuid
      nullable: true
      description: Lawyer who reviewed

    - name: review_notes
      type: text
      nullable: true

    # Audit
    - name: created_at
      type: timestamp
      default: CURRENT_TIMESTAMP

    - name: updated_at
      type: timestamp
      default: CURRENT_TIMESTAMP
      on_update: CURRENT_TIMESTAMP

    - name: created_by
      type: uuid
      foreign_key: users.id

  # Relationships
  relationships:
    - name: transaction
      type: belongs_to
      entity: Transaction
      foreign_key: transaction_id

    - name: clauses
      type: has_many
      entity: ContractClause
      through: contract_clauses_mapping

    - name: payment_schedule
      type: has_one
      entity: PaymentSchedule
      foreign_key: contract_id

    - name: documents
      type: has_many
      entity: Document
      foreign_key: contract_id

  # State Machine
  state_machine:
    field: status
    initial: draft
    transitions:
      - from: draft
        to: pending_review
        trigger: submit_for_review
        action: notify_reviewers

      - from: pending_review
        to: draft
        trigger: request_changes
        action: record_change_requests

      - from: pending_review
        to: pending_signatures
        trigger: approve
        action: prepare_for_signing

      - from: pending_signatures
        to: partially_signed
        trigger: partial_sign
        action: record_signature

      - from: [pending_signatures, partially_signed]
        to: fully_signed
        trigger: complete_signing
        guard: all_parties_signed
        action: finalize_signatures

      - from: fully_signed
        to: pending_notarization
        trigger: submit_for_notarization
        guard: requires_notarization

      - from: fully_signed
        to: completed
        trigger: complete
        guard: not_requires_notarization

      - from: pending_notarization
        to: notarized
        trigger: notarize
        action: record_notarization

      - from: notarized
        to: completed
        trigger: complete

      - from: [notarized, completed]
        to: amended
        trigger: amend
        action: record_amendment

      - from: amended
        to: completed
        trigger: complete_amendment

      - from: [draft, pending_review, pending_signatures, partially_signed]
        to: terminated
        trigger: terminate
        action: record_termination

  # Business Rules
  business_rules:
    - rule: BR-CTR-001
      name: Essential elements
      description: Contract must have all essential elements
      validation: "seller_parties IS NOT NULL AND buyer_parties IS NOT NULL AND purchase_price > 0"

    - rule: BR-CTR-002
      name: Notarization requirement
      description: Sale contracts in Vietnam require notarization
      validation: "contract_type != 'sale_purchase_agreement' OR requires_notarization = true"

    - rule: BR-CTR-003
      name: All parties must sign
      description: All listed parties must sign before completion

    - rule: BR-CTR-004
      name: Amendment notarization
      description: Amendments to notarized contracts must also be notarized

  # Validations
  validations:
    - field: purchase_price
      rule: positive
      message: "Purchase price must be positive"

    - field: closing_date
      rule: future_or_today
      when: status == 'draft'
      message: "Closing date must be in the future"

    - field: seller_parties
      rule: not_empty
      message: "At least one seller party required"

    - field: buyer_parties
      rule: not_empty
      message: "At least one buyer party required"

  # Events
  events:
    - name: contract.created
      trigger: on_create
      payload: [id, contract_number, transaction_id]

    - name: contract.signed
      trigger: on_transition_to_fully_signed
      payload: [id, transaction_id, all_signed_at]
      notifications:
        - recipient: all_parties
          template: contract_signed

    - name: contract.notarized
      trigger: on_transition_to_notarized
      payload: [id, notary_certificate_number]
      notifications:
        - recipient: all_parties
          template: contract_notarized

    - name: contract.amended
      trigger: on_transition_to_amended
      payload: [id, amendment_number]

  # API Endpoints
  api:
    endpoints:
      - method: GET
        path: /api/contracts
        description: List contracts

      - method: GET
        path: /api/contracts/{id}
        description: Get contract details

      - method: POST
        path: /api/transactions/{transaction_id}/contract
        description: Create contract

      - method: PUT
        path: /api/contracts/{id}
        description: Update contract draft

      - method: POST
        path: /api/contracts/{id}/sign
        description: Sign contract

      - method: POST
        path: /api/contracts/{id}/notarize
        description: Record notarization

      - method: POST
        path: /api/contracts/{id}/amend
        description: Create amendment
