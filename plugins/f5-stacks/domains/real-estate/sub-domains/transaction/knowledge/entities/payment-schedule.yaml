# Payment Schedule Entity
# F5 Framework v2.0 - Real Estate/Transaction
# Payment milestone and schedule management

entity:
  name: PaymentSchedule
  name_vi: Lịch thanh toán
  name_ja: 支払いスケジュール
  domain: real-estate
  subdomain: transaction
  version: "1.0.0"

  description: |
    Defines and tracks the payment schedule for a real estate transaction.
    Supports lump sum, installment, and milestone-based payment structures.

  # Database Configuration
  database:
    table_name: payment_schedules
    primary_key: id
    indexes:
      - columns: [transaction_id]
        unique: true
      - columns: [contract_id]

  # Attributes
  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true

    - name: transaction_id
      type: uuid
      required: true
      foreign_key: transactions.id
      description: Associated transaction

    - name: contract_id
      type: uuid
      nullable: true
      foreign_key: contracts.id
      description: Associated contract

    # Schedule Type
    - name: schedule_type
      type: enum
      values:
        - lump_sum
        - installment
        - milestone
        - mixed
      required: true
      description: Type of payment schedule

    - name: schedule_name
      type: string
      nullable: true
      description: Custom schedule name

    # Total Amount
    - name: total_amount
      type: decimal
      precision: 15
      scale: 2
      required: true
      description: Total transaction amount

    - name: currency
      type: string
      length: 3
      default: "VND"

    # Payments
    - name: payments
      type: jsonb
      required: true
      description: Payment schedule details
      schema:
        type: array
        items:
          type: object
          properties:
            payment_id:
              type: string
              description: Unique payment identifier
            sequence:
              type: integer
              description: Payment order
            milestone:
              type: string
              enum: [deposit, signing, notarization, land_registration, handover, final, custom]
              description: Payment milestone
            milestone_name:
              type: string
              description: Custom milestone name
            amount:
              type: number
              description: Payment amount
            percent:
              type: number
              description: Percentage of total
            due_date:
              type: string
              format: date
              description: Payment due date
            due_condition:
              type: string
              description: Condition that triggers due date
            payment_method:
              type: string
              enum: [bank_transfer, cash, check, escrow]
            status:
              type: string
              enum: [scheduled, invoiced, pending, paid, overdue, cancelled]
              default: scheduled
            invoiced_at:
              type: string
              format: datetime
            paid_date:
              type: string
              format: date
            paid_amount:
              type: number
            payment_reference:
              type: string
            payment_proof_url:
              type: string
            verified:
              type: boolean
              default: false
            verified_by:
              type: string
            notes:
              type: string

    # Summary
    - name: total_paid
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Total amount paid

    - name: remaining_balance
      type: decimal
      precision: 15
      scale: 2
      description: Amount remaining

    - name: payments_completed
      type: integer
      default: 0
      description: Number of payments completed

    - name: payments_total
      type: integer
      description: Total number of payments

    # Next Payment
    - name: next_payment_due
      type: date
      nullable: true
      description: Next payment due date

    - name: next_payment_amount
      type: decimal
      precision: 15
      scale: 2
      nullable: true

    - name: next_payment_milestone
      type: string
      nullable: true

    # Status
    - name: status
      type: enum
      values:
        - active
        - on_hold
        - completed
        - defaulted
        - cancelled
      default: active

    - name: is_on_track
      type: boolean
      default: true
      description: All payments on schedule

    - name: has_overdue
      type: boolean
      default: false
      description: Has overdue payments

    - name: overdue_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: days_overdue
      type: integer
      default: 0

    # Late Fees
    - name: late_fee_applicable
      type: boolean
      default: false

    - name: late_fee_percent
      type: decimal
      precision: 5
      scale: 2
      nullable: true
      description: Late fee percentage per period

    - name: late_fee_grace_days
      type: integer
      default: 0

    - name: total_late_fees
      type: decimal
      precision: 12
      scale: 2
      default: 0

    # Receiving Account
    - name: receiving_account
      type: jsonb
      description: Where payments should be made
      schema:
        type: object
        properties:
          account_type: { type: string, enum: [seller, escrow, agency] }
          bank_name: { type: string }
          account_number: { type: string }
          account_name: { type: string }
          branch: { type: string }
          swift_code: { type: string }

    # Modification History
    - name: modifications
      type: jsonb
      description: Schedule modifications
      schema:
        type: array
        items:
          type: object
          properties:
            modified_at: { type: string, format: datetime }
            modified_by: { type: string }
            change_type: { type: string }
            old_value: { type: string }
            new_value: { type: string }
            reason: { type: string }
            approved_by: { type: string }

    # Notes
    - name: notes
      type: text
      nullable: true

    # Audit
    - name: created_at
      type: timestamp
      default: CURRENT_TIMESTAMP

    - name: updated_at
      type: timestamp
      default: CURRENT_TIMESTAMP
      on_update: CURRENT_TIMESTAMP

    - name: created_by
      type: uuid
      foreign_key: users.id

  # Relationships
  relationships:
    - name: transaction
      type: belongs_to
      entity: Transaction
      foreign_key: transaction_id

    - name: contract
      type: belongs_to
      entity: Contract
      foreign_key: contract_id

  # Computed Fields
  computed_fields:
    - name: completion_percent
      formula: "(total_paid / total_amount) * 100"

    - name: remaining_payments
      formula: "payments_total - payments_completed"

  # Standard Payment Templates
  templates:
    - name: standard_sale
      schedule_type: milestone
      payments:
        - sequence: 1
          milestone: deposit
          percent: 10
          due_condition: "On offer acceptance"
        - sequence: 2
          milestone: signing
          percent: 30
          due_condition: "On contract signing"
        - sequence: 3
          milestone: notarization
          percent: 30
          due_condition: "On notarization"
        - sequence: 4
          milestone: handover
          percent: 30
          due_condition: "On property handover"

    - name: installment_12
      schedule_type: installment
      payments:
        - sequence: 1
          milestone: deposit
          percent: 20
          due_condition: "On contract signing"
        - sequence: 2-12
          milestone: custom
          percent: 7.27
          due_condition: "Monthly"

    - name: bank_financing
      schedule_type: mixed
      payments:
        - sequence: 1
          milestone: deposit
          percent: 5
          due_condition: "On offer acceptance"
        - sequence: 2
          milestone: signing
          percent: 25
          due_condition: "On contract signing"
        - sequence: 3
          milestone: final
          percent: 70
          due_condition: "Bank disbursement at closing"

  # Business Rules
  business_rules:
    - rule: BR-PAY-001
      name: Payment sequence
      description: Payments must be completed in sequence

    - rule: BR-PAY-002
      name: Total validation
      description: Sum of payments must equal total amount

    - rule: BR-PAY-003
      name: Overdue notification
      description: Notify parties when payment is overdue

    - rule: BR-PAY-004
      name: Default threshold
      description: Transaction may be defaulted after specified overdue period

  # Validations
  validations:
    - field: total_amount
      rule: positive
      message: "Total amount must be positive"

    - field: payments
      rule: sum_equals_total
      message: "Payment amounts must sum to total"

  # Events
  events:
    - name: payment.due_soon
      trigger: on_payment_due_in_3_days
      payload: [id, payment_id, amount, due_date]
      notifications:
        - recipient: buyer
          template: payment_reminder

    - name: payment.received
      trigger: on_payment_completed
      payload: [id, payment_id, amount, remaining]
      notifications:
        - recipient: seller
          template: payment_received
        - recipient: buyer
          template: payment_confirmation

    - name: payment.overdue
      trigger: on_payment_overdue
      payload: [id, payment_id, amount, days_overdue]
      notifications:
        - recipient: buyer
          template: payment_overdue
        - recipient: agents
          template: payment_overdue_alert

    - name: schedule.completed
      trigger: on_all_payments_complete
      payload: [id, transaction_id, total_paid]

  # API Endpoints
  api:
    endpoints:
      - method: GET
        path: /api/payment-schedules
        description: List payment schedules

      - method: GET
        path: /api/payment-schedules/{id}
        description: Get schedule details

      - method: POST
        path: /api/transactions/{transaction_id}/payment-schedule
        description: Create payment schedule

      - method: PUT
        path: /api/payment-schedules/{id}
        description: Update schedule

      - method: POST
        path: /api/payment-schedules/{id}/payments/{payment_id}/record
        description: Record payment

      - method: GET
        path: /api/payment-schedules/{id}/summary
        description: Get payment summary
