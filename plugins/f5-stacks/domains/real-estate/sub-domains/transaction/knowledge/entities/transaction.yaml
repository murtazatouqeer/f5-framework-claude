# Transaction Entity
# F5 Framework v2.0 - Real Estate/Transaction
# Core transaction management entity

entity:
  name: Transaction
  name_vi: Giao dịch
  name_ja: 取引
  domain: real-estate
  subdomain: transaction
  version: "1.0.0"

  description: |
    Core entity representing a real estate transaction from initiation
    through closing. Tracks all parties, milestones, documents, and
    financial information throughout the deal lifecycle.

  # Database Configuration
  database:
    table_name: transactions
    primary_key: id
    indexes:
      - columns: [transaction_id]
        unique: true
      - columns: [listing_id]
      - columns: [property_id]
      - columns: [buyer_id]
      - columns: [seller_id]
      - columns: [status]
      - columns: [created_at]
      - columns: [closing_date]

  # Attributes
  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true
      description: Unique identifier

    - name: transaction_id
      type: string
      format: "TXN-{YYYYMMDD}-{XXXXXX}"
      unique: true
      description: Human-readable transaction ID
      example: "TXN-20241215-A1B2C3"

    - name: listing_id
      type: uuid
      nullable: true
      foreign_key: listings.id
      description: Associated listing

    - name: property_id
      type: uuid
      required: true
      foreign_key: properties.id
      description: Property being transacted

    # Status
    - name: status
      type: enum
      values:
        - initiated
        - offer_pending
        - offer_accepted
        - under_contract
        - due_diligence
        - pending_closing
        - closing
        - completed
        - cancelled
        - fallen_through
      default: initiated
      description: Current transaction status

    - name: transaction_type
      type: enum
      values:
        - sale
        - purchase
        - lease
        - assignment
      required: true
      description: Type of transaction

    # Parties - Buyer Side
    - name: buyer_id
      type: uuid
      foreign_key: users.id
      description: Primary buyer

    - name: buyer_parties
      type: jsonb
      description: All buyer parties
      schema:
        type: array
        items:
          type: object
          properties:
            user_id: { type: uuid }
            name: { type: string }
            id_number: { type: string }
            role: { type: string, enum: [primary, co_buyer, representative] }
            share_percent: { type: number }

    - name: buyer_agent_id
      type: uuid
      nullable: true
      foreign_key: agents.id
      description: Buyer's agent

    - name: buyer_agency_id
      type: uuid
      nullable: true
      foreign_key: agencies.id
      description: Buyer's agency

    # Parties - Seller Side
    - name: seller_id
      type: uuid
      foreign_key: users.id
      description: Primary seller

    - name: seller_parties
      type: jsonb
      description: All seller parties
      schema:
        type: array
        items:
          type: object
          properties:
            user_id: { type: uuid }
            name: { type: string }
            id_number: { type: string }
            role: { type: string, enum: [primary, co_seller, representative] }
            share_percent: { type: number }

    - name: seller_agent_id
      type: uuid
      nullable: true
      foreign_key: agents.id
      description: Seller's/listing agent

    - name: seller_agency_id
      type: uuid
      nullable: true
      foreign_key: agencies.id
      description: Seller's agency

    # Other Parties
    - name: escrow_agent_id
      type: uuid
      nullable: true
      foreign_key: escrow_agents.id
      description: Escrow holder

    - name: notary_id
      type: uuid
      nullable: true
      description: Notary public

    - name: lawyer_ids
      type: array
      items: uuid
      description: Attorneys involved

    # Property Details
    - name: property_address
      type: jsonb
      description: Property address snapshot
      schema:
        type: object
        properties:
          street_address: { type: string }
          ward: { type: string }
          district: { type: string }
          city: { type: string }
          postal_code: { type: string }

    - name: property_type
      type: string
      description: Property type at transaction time

    - name: property_details_snapshot
      type: jsonb
      description: Property details at transaction initiation
      schema:
        type: object
        properties:
          area_sqm: { type: number }
          bedrooms: { type: integer }
          bathrooms: { type: integer }
          legal_status: { type: string }
          certificate_number: { type: string }

    # Financial
    - name: list_price
      type: decimal
      precision: 15
      scale: 2
      description: Original listing price

    - name: offer_price
      type: decimal
      precision: 15
      scale: 2
      description: Accepted offer price

    - name: final_price
      type: decimal
      precision: 15
      scale: 2
      description: Final transaction price

    - name: currency
      type: string
      length: 3
      default: "VND"
      description: Currency code

    - name: deposit_amount
      type: decimal
      precision: 15
      scale: 2
      description: Total deposit amount

    - name: payment_method
      type: enum
      values:
        - cash
        - mortgage
        - installment
        - mixed
      description: Primary payment method

    - name: mortgage_amount
      type: decimal
      precision: 15
      scale: 2
      nullable: true
      description: Mortgage/loan amount if applicable

    - name: mortgage_provider
      type: string
      nullable: true
      description: Bank or lender name

    - name: mortgage_status
      type: enum
      values:
        - not_applicable
        - pre_approved
        - applied
        - approved
        - funded
        - denied
      nullable: true
      description: Mortgage application status

    # Timeline
    - name: initiated_at
      type: timestamp
      default: CURRENT_TIMESTAMP
      description: Transaction start date

    - name: offer_submitted_at
      type: timestamp
      nullable: true
      description: When offer was submitted

    - name: offer_accepted_at
      type: timestamp
      nullable: true
      description: When offer was accepted

    - name: contract_signed_at
      type: timestamp
      nullable: true
      description: Contract execution date

    - name: notarized_at
      type: timestamp
      nullable: true
      description: Contract notarization date

    - name: due_diligence_start_date
      type: date
      nullable: true
      description: DD period start

    - name: due_diligence_end_date
      type: date
      nullable: true
      description: DD period deadline

    - name: scheduled_closing_date
      type: date
      nullable: true
      description: Planned closing date

    - name: actual_closing_date
      type: date
      nullable: true
      description: Actual closing date

    - name: possession_date
      type: date
      nullable: true
      description: Property handover date

    - name: completed_at
      type: timestamp
      nullable: true
      description: Transaction completion timestamp

    - name: cancelled_at
      type: timestamp
      nullable: true
      description: Cancellation timestamp

    # Documents
    - name: required_documents
      type: jsonb
      description: List of required documents
      schema:
        type: array
        items:
          type: object
          properties:
            document_type: { type: string }
            required_from: { type: string, enum: [buyer, seller, both] }
            status: { type: string, enum: [required, submitted, verified, rejected] }

    - name: submitted_documents
      type: array
      items: uuid
      description: References to submitted document entities

    # Milestones
    - name: milestones
      type: jsonb
      description: Transaction milestones tracking
      schema:
        type: array
        items:
          type: object
          properties:
            name: { type: string }
            status: { type: string, enum: [pending, in_progress, completed, skipped] }
            due_date: { type: string, format: date }
            completed_date: { type: string, format: date }
            notes: { type: string }

    # Compliance
    - name: tax_payment_status
      type: enum
      values:
        - not_applicable
        - pending
        - paid
        - exempt
      default: pending
      description: Transfer tax payment status

    - name: tax_receipt_number
      type: string
      nullable: true
      description: Tax payment receipt

    - name: land_registration_status
      type: enum
      values:
        - not_started
        - submitted
        - processing
        - completed
        - rejected
      nullable: true
      description: Land registration status

    - name: land_registration_number
      type: string
      nullable: true
      description: Registration confirmation number

    # Cancellation
    - name: cancellation_reason
      type: string
      nullable: true
      description: Reason if cancelled

    - name: cancelled_by
      type: uuid
      nullable: true
      description: Who initiated cancellation

    - name: fallthrough_reason
      type: enum
      values:
        - financing_failed
        - inspection_issues
        - title_issues
        - buyer_backed_out
        - seller_backed_out
        - mutual_agreement
        - contingency_not_met
        - other
      nullable: true
      description: Reason for deal falling through

    # Notes
    - name: internal_notes
      type: text
      nullable: true
      description: Internal agent/staff notes

    - name: special_instructions
      type: text
      nullable: true
      description: Special handling instructions

    # Audit
    - name: created_at
      type: timestamp
      default: CURRENT_TIMESTAMP

    - name: updated_at
      type: timestamp
      default: CURRENT_TIMESTAMP
      on_update: CURRENT_TIMESTAMP

    - name: created_by
      type: uuid
      foreign_key: users.id

  # Relationships
  relationships:
    - name: listing
      type: belongs_to
      entity: Listing
      foreign_key: listing_id

    - name: property
      type: belongs_to
      entity: Property
      foreign_key: property_id

    - name: buyer
      type: belongs_to
      entity: User
      foreign_key: buyer_id

    - name: seller
      type: belongs_to
      entity: User
      foreign_key: seller_id

    - name: buyer_agent
      type: belongs_to
      entity: Agent
      foreign_key: buyer_agent_id

    - name: seller_agent
      type: belongs_to
      entity: Agent
      foreign_key: seller_agent_id

    - name: offers
      type: has_many
      entity: Offer
      foreign_key: transaction_id

    - name: contract
      type: has_one
      entity: Contract
      foreign_key: transaction_id

    - name: deposits
      type: has_many
      entity: Deposit
      foreign_key: transaction_id

    - name: escrow
      type: has_one
      entity: Escrow
      foreign_key: transaction_id

    - name: closing
      type: has_one
      entity: Closing
      foreign_key: transaction_id

    - name: due_diligence
      type: has_one
      entity: DueDiligence
      foreign_key: transaction_id

    - name: documents
      type: has_many
      entity: Document
      foreign_key: transaction_id

    - name: payment_schedule
      type: has_one
      entity: PaymentSchedule
      foreign_key: transaction_id

    - name: commission_splits
      type: has_many
      entity: CommissionSplit
      foreign_key: transaction_id

    - name: parties
      type: has_many
      entity: TransactionParty
      foreign_key: transaction_id

  # State Machine
  state_machine:
    field: status
    initial: initiated
    transitions:
      - from: initiated
        to: offer_pending
        trigger: offer_submitted
        action: record_offer_date

      - from: offer_pending
        to: offer_accepted
        trigger: offer_accepted
        action: record_acceptance

      - from: offer_pending
        to: initiated
        trigger: offer_rejected
        action: clear_offer

      - from: offer_pending
        to: cancelled
        trigger: offer_withdrawn
        action: record_withdrawal

      - from: offer_accepted
        to: under_contract
        trigger: contract_signed
        action: record_contract_date

      - from: under_contract
        to: due_diligence
        trigger: start_due_diligence
        action: set_dd_period

      - from: due_diligence
        to: pending_closing
        trigger: due_diligence_complete
        action: approve_for_closing

      - from: due_diligence
        to: fallen_through
        trigger: dd_issues_unresolved
        action: record_fallthrough

      - from: pending_closing
        to: closing
        trigger: begin_closing
        action: initiate_closing

      - from: closing
        to: completed
        trigger: closing_complete
        action: finalize_transaction

      - from: [offer_pending, offer_accepted, under_contract, due_diligence, pending_closing]
        to: cancelled
        trigger: cancel_transaction
        action: record_cancellation

      - from: [under_contract, due_diligence, pending_closing, closing]
        to: fallen_through
        trigger: deal_falls_through
        action: record_fallthrough_reason

  # Computed Fields
  computed_fields:
    - name: days_on_market
      formula: "CURRENT_DATE - initiated_at::date"
      description: Days since transaction started

    - name: days_to_close
      formula: "actual_closing_date - initiated_at::date"
      description: Total days from start to close

    - name: price_difference
      formula: "final_price - list_price"
      description: Difference from list price

    - name: price_difference_percent
      formula: "((final_price - list_price) / list_price) * 100"
      description: Percentage difference

    - name: is_overdue
      formula: "scheduled_closing_date < CURRENT_DATE AND status NOT IN ('completed', 'cancelled', 'fallen_through')"
      description: Whether closing is overdue

  # Business Rules
  business_rules:
    - rule: BR-TXN-001
      name: Transaction ID generation
      description: Auto-generate unique transaction ID on creation

    - rule: BR-TXN-002
      name: Property must be active listing
      description: Can only initiate transaction on active listing

    - rule: BR-TXN-003
      name: Required parties
      description: Must have buyer and seller before contract

    - rule: BR-TXN-004
      name: Status progression
      description: Status must follow valid state transitions

    - rule: BR-TXN-005
      name: Completion requirements
      description: Cannot complete without all milestones met

  # Validations
  validations:
    - field: final_price
      rule: positive
      message: "Final price must be positive"

    - field: closing_date
      rule: future_or_today
      when: status == 'pending_closing'
      message: "Closing date cannot be in the past"

    - field: buyer_id
      rule: not_equals
      compare_to: seller_id
      message: "Buyer and seller cannot be the same"

  # Events
  events:
    - name: transaction.created
      trigger: on_create
      payload: [id, transaction_id, listing_id, buyer_id, seller_id]

    - name: transaction.status_changed
      trigger: on_status_change
      payload: [id, old_status, new_status]

    - name: transaction.offer_accepted
      trigger: on_transition_to_offer_accepted
      payload: [id, offer_price, buyer_id]

    - name: transaction.contract_signed
      trigger: on_transition_to_under_contract
      payload: [id, contract_id]

    - name: transaction.completed
      trigger: on_transition_to_completed
      payload: [id, final_price, completion_date]

    - name: transaction.cancelled
      trigger: on_transition_to_cancelled
      payload: [id, cancellation_reason]

  # API Endpoints
  api:
    endpoints:
      - method: GET
        path: /api/transactions
        description: List transactions
        filters: [status, buyer_id, seller_id, agent_id, date_range]
        pagination: true

      - method: GET
        path: /api/transactions/{id}
        description: Get transaction details

      - method: POST
        path: /api/transactions
        description: Create new transaction

      - method: PUT
        path: /api/transactions/{id}
        description: Update transaction

      - method: POST
        path: /api/transactions/{id}/status
        description: Update transaction status

      - method: GET
        path: /api/transactions/{id}/timeline
        description: Get transaction timeline

      - method: GET
        path: /api/transactions/{id}/documents
        description: Get transaction documents
