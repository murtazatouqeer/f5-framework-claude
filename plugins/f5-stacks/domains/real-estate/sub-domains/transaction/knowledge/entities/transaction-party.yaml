# Transaction Party Entity
# F5 Framework v2.0 - Real Estate/Transaction
# All parties involved in a transaction

entity:
  name: TransactionParty
  name_vi: Bên tham gia giao dịch
  name_ja: 取引当事者
  domain: real-estate
  subdomain: transaction
  version: "1.0.0"

  description: |
    Represents all parties involved in a real estate transaction including
    buyers, sellers, agents, attorneys, notaries, and other stakeholders.

  # Database Configuration
  database:
    table_name: transaction_parties
    primary_key: id
    indexes:
      - columns: [transaction_id]
      - columns: [party_type]
      - columns: [user_id]
      - columns: [role]

  # Attributes
  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true

    - name: transaction_id
      type: uuid
      required: true
      foreign_key: transactions.id
      description: Associated transaction

    - name: user_id
      type: uuid
      nullable: true
      foreign_key: users.id
      description: User account if registered

    # Party Type
    - name: party_type
      type: enum
      values:
        - individual
        - company
        - organization
        - government
      required: true
      description: Type of party

    # Role
    - name: role
      type: enum
      values:
        # Principal Parties
        - buyer
        - co_buyer
        - seller
        - co_seller
        # Agents
        - listing_agent
        - buyer_agent
        - transaction_coordinator
        # Legal
        - buyer_attorney
        - seller_attorney
        - notary
        # Financial
        - escrow_officer
        - lender
        - loan_officer
        # Other
        - witness
        - guarantor
        - power_of_attorney
        - inspector
        - appraiser
        - title_officer
        - representative
      required: true
      description: Role in transaction

    - name: is_primary
      type: boolean
      default: false
      description: Primary party in their category

    # Personal Information
    - name: full_name
      type: string
      required: true
      description: Full legal name

    - name: full_name_local
      type: string
      nullable: true
      description: Name in local script

    # Identity
    - name: id_type
      type: enum
      values:
        - cmnd
        - cccd
        - passport
        - business_license
        - other
      nullable: true

    - name: id_number
      type: string
      nullable: true
      description: ID document number

    - name: id_issued_date
      type: date
      nullable: true

    - name: id_issued_place
      type: string
      nullable: true

    - name: id_expiry_date
      type: date
      nullable: true

    - name: id_document_url
      type: string
      nullable: true

    # Contact Information
    - name: email
      type: string
      nullable: true
      description: Email address

    - name: phone
      type: string
      nullable: true
      description: Phone number

    - name: phone_secondary
      type: string
      nullable: true

    - name: address
      type: text
      nullable: true
      description: Current address

    - name: mailing_address
      type: text
      nullable: true
      description: Mailing address if different

    # Company Information (if company)
    - name: company_name
      type: string
      nullable: true

    - name: company_registration_number
      type: string
      nullable: true

    - name: company_tax_id
      type: string
      nullable: true

    - name: company_representative
      type: string
      nullable: true
      description: Authorized representative name

    - name: company_representative_title
      type: string
      nullable: true

    # Professional Information (for agents, lawyers, etc.)
    - name: license_number
      type: string
      nullable: true

    - name: license_type
      type: string
      nullable: true

    - name: license_expiry
      type: date
      nullable: true

    - name: organization_name
      type: string
      nullable: true
      description: Agency, firm, or company name

    - name: organization_id
      type: uuid
      nullable: true

    # Ownership Share
    - name: ownership_share_percent
      type: decimal
      precision: 5
      scale: 2
      nullable: true
      description: Percentage ownership (for buyers/sellers)

    # Representation
    - name: represented_by
      type: uuid
      nullable: true
      description: If represented by another party

    - name: power_of_attorney_url
      type: string
      nullable: true
      description: POA document if applicable

    - name: poa_scope
      type: string
      nullable: true
      description: Scope of authority under POA

    # Signing Authority
    - name: can_sign
      type: boolean
      default: true
      description: Has authority to sign documents

    - name: signature_required
      type: boolean
      default: false
      description: Signature required on contract

    - name: has_signed
      type: boolean
      default: false

    - name: signed_at
      type: timestamp
      nullable: true

    # Communication Preferences
    - name: preferred_contact_method
      type: enum
      values:
        - email
        - phone
        - sms
        - app
      default: email

    - name: preferred_language
      type: string
      default: "vi"

    - name: receive_notifications
      type: boolean
      default: true

    # Status
    - name: status
      type: enum
      values:
        - active
        - pending_verification
        - verified
        - inactive
        - removed
      default: active

    - name: verified
      type: boolean
      default: false

    - name: verified_at
      type: timestamp
      nullable: true

    - name: verified_by
      type: uuid
      nullable: true

    # Bank Information (for payments)
    - name: bank_details
      type: jsonb
      nullable: true
      description: Bank account for payments
      schema:
        type: object
        properties:
          bank_name: { type: string }
          branch: { type: string }
          account_number: { type: string }
          account_name: { type: string }
          swift_code: { type: string }

    # Notes
    - name: notes
      type: text
      nullable: true

    - name: internal_notes
      type: text
      nullable: true

    # Audit
    - name: created_at
      type: timestamp
      default: CURRENT_TIMESTAMP

    - name: updated_at
      type: timestamp
      default: CURRENT_TIMESTAMP
      on_update: CURRENT_TIMESTAMP

    - name: created_by
      type: uuid
      foreign_key: users.id

  # Relationships
  relationships:
    - name: transaction
      type: belongs_to
      entity: Transaction
      foreign_key: transaction_id

    - name: user
      type: belongs_to
      entity: User
      foreign_key: user_id

    - name: representative
      type: belongs_to
      entity: TransactionParty
      foreign_key: represented_by

    - name: represents
      type: has_many
      entity: TransactionParty
      foreign_key: represented_by

  # Role Configurations
  role_config:
    buyer:
      category: principal
      requires_verification: true
      signature_required: true
      max_per_transaction: 5

    seller:
      category: principal
      requires_verification: true
      signature_required: true
      max_per_transaction: 5

    listing_agent:
      category: agent
      requires_license: true
      max_per_transaction: 2

    buyer_agent:
      category: agent
      requires_license: true
      max_per_transaction: 2

    notary:
      category: legal
      requires_license: true
      signature_required: true
      max_per_transaction: 1

    witness:
      category: other
      requires_verification: false
      signature_required: true
      max_per_transaction: 4

  # Business Rules
  business_rules:
    - rule: BR-PTY-001
      name: Principal verification
      description: Buyers and sellers must be verified before contract

    - rule: BR-PTY-002
      name: ID validation
      description: ID documents must be valid at transaction time

    - rule: BR-PTY-003
      name: POA requirements
      description: Representatives need valid power of attorney

    - rule: BR-PTY-004
      name: Agent licensing
      description: Agents must have valid licenses

  # Validations
  validations:
    - field: full_name
      rule: required
      message: "Full name is required"

    - field: id_number
      rule: required
      when: role IN ['buyer', 'seller', 'co_buyer', 'co_seller']
      message: "ID number required for principals"

    - field: ownership_share_percent
      rule: range
      min: 0
      max: 100
      when: role IN ['buyer', 'seller', 'co_buyer', 'co_seller']
      message: "Ownership share must be 0-100%"

  # Events
  events:
    - name: party.added
      trigger: on_create
      payload: [id, transaction_id, role, full_name]

    - name: party.verified
      trigger: on_verification
      payload: [id, role, verified_at]

    - name: party.signed
      trigger: on_signature
      payload: [id, transaction_id, signed_at]

  # API Endpoints
  api:
    endpoints:
      - method: GET
        path: /api/transactions/{transaction_id}/parties
        description: List transaction parties

      - method: GET
        path: /api/transaction-parties/{id}
        description: Get party details

      - method: POST
        path: /api/transactions/{transaction_id}/parties
        description: Add party

      - method: PUT
        path: /api/transaction-parties/{id}
        description: Update party

      - method: POST
        path: /api/transaction-parties/{id}/verify
        description: Verify party

      - method: DELETE
        path: /api/transaction-parties/{id}
        description: Remove party
