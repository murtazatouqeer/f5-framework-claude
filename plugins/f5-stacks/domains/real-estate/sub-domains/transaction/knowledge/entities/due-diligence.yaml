# Due Diligence Entity
# F5 Framework v2.0 - Real Estate/Transaction
# Property due diligence process management

entity:
  name: DueDiligence
  name_vi: Thẩm định
  name_ja: デューデリジェンス
  domain: real-estate
  subdomain: transaction
  version: "1.0.0"

  description: |
    Manages the due diligence process for real estate transactions.
    Tracks title verification, inspections, legal review, and findings.

  # Database Configuration
  database:
    table_name: due_diligence
    primary_key: id
    indexes:
      - columns: [transaction_id]
        unique: true
      - columns: [status]
      - columns: [deadline_date]

  # Attributes
  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true

    - name: transaction_id
      type: uuid
      required: true
      foreign_key: transactions.id
      description: Associated transaction

    # Status
    - name: status
      type: enum
      values:
        - not_started
        - in_progress
        - pending_resolution
        - completed
        - issues_found
        - waived
        - expired
      default: not_started
      description: Overall DD status

    # Timeline
    - name: period_days
      type: integer
      required: true
      description: Due diligence period in days

    - name: start_date
      type: date
      nullable: true
      description: When DD started

    - name: deadline_date
      type: date
      required: true
      description: DD deadline

    - name: completed_date
      type: date
      nullable: true

    - name: extension_requested
      type: boolean
      default: false

    - name: extension_days
      type: integer
      nullable: true

    - name: extension_approved
      type: boolean
      nullable: true

    - name: extended_deadline
      type: date
      nullable: true

    # Checks
    - name: checks
      type: jsonb
      required: true
      description: All DD checks
      schema:
        type: array
        items:
          type: object
          properties:
            check_id:
              type: string
            check_type:
              type: string
              enum: [title, legal, physical, financial, environmental, survey, zoning, permits, hoa]
            name:
              type: string
            status:
              type: string
              enum: [pending, in_progress, passed, failed, waived, not_applicable]
            priority:
              type: string
              enum: [critical, high, medium, low]
            assigned_to:
              type: string
            started_at:
              type: string
              format: datetime
            completed_at:
              type: string
              format: datetime
            findings:
              type: string
            issues:
              type: array
              items:
                type: object
                properties:
                  issue_id: { type: string }
                  description: { type: string }
                  severity: { type: string, enum: [critical, major, minor] }
                  resolution: { type: string }
                  resolved: { type: boolean }
            documents:
              type: array
              items: { type: string }
            notes:
              type: string

    # Title Verification
    - name: title_search_id
      type: uuid
      nullable: true
      foreign_key: title_searches.id

    - name: title_clear
      type: boolean
      nullable: true
      description: Title verified clear

    - name: liens_found
      type: jsonb
      description: Liens discovered
      schema:
        type: array
        items:
          type: object
          properties:
            lien_type: { type: string }
            amount: { type: number }
            holder: { type: string }
            filed_date: { type: string, format: date }
            status: { type: string }
            release_required: { type: boolean }

    - name: encumbrances
      type: jsonb
      description: Encumbrances found
      schema:
        type: array
        items:
          type: object
          properties:
            type: { type: string }
            description: { type: string }
            affects_use: { type: boolean }
            removable: { type: boolean }

    - name: easements
      type: jsonb
      description: Easements on property
      schema:
        type: array
        items:
          type: object
          properties:
            type: { type: string }
            beneficiary: { type: string }
            description: { type: string }

    # Physical Inspection
    - name: inspection_scheduled
      type: boolean
      default: false

    - name: inspection_date
      type: date
      nullable: true

    - name: inspection_report_url
      type: string
      nullable: true

    - name: inspector_name
      type: string
      nullable: true

    - name: inspector_company
      type: string
      nullable: true

    - name: inspection_issues
      type: jsonb
      description: Issues from inspection
      schema:
        type: array
        items:
          type: object
          properties:
            issue_id: { type: string }
            category: { type: string, enum: [structural, electrical, plumbing, roofing, hvac, foundation, pest, mold, safety, cosmetic] }
            description: { type: string }
            severity: { type: string, enum: [critical, major, minor] }
            estimated_repair_cost: { type: number }
            requires_specialist: { type: boolean }
            photos: { type: array, items: { type: string } }

    - name: repair_requests
      type: jsonb
      description: Repair requests to seller
      schema:
        type: array
        items:
          type: object
          properties:
            issue_id: { type: string }
            request_type: { type: string, enum: [repair, credit, price_reduction] }
            requested_amount: { type: number }
            seller_response: { type: string, enum: [accepted, rejected, counter, pending] }
            final_resolution: { type: string }

    # Legal Verification
    - name: ownership_verified
      type: boolean
      nullable: true
      description: Ownership confirmed

    - name: zoning_compliant
      type: boolean
      nullable: true
      description: Zoning compliance verified

    - name: zoning_classification
      type: string
      nullable: true

    - name: permitted_uses
      type: array
      items: string
      nullable: true

    - name: permits_verified
      type: boolean
      nullable: true

    - name: outstanding_permits
      type: jsonb
      nullable: true
      description: Open permits found

    - name: violations_found
      type: jsonb
      nullable: true
      description: Code violations
      schema:
        type: array
        items:
          type: object
          properties:
            violation_type: { type: string }
            description: { type: string }
            issued_date: { type: string, format: date }
            status: { type: string }
            resolution_required: { type: boolean }

    - name: legal_disputes
      type: jsonb
      nullable: true
      description: Legal disputes affecting property

    # Environmental
    - name: environmental_check_required
      type: boolean
      default: false

    - name: environmental_report_url
      type: string
      nullable: true

    - name: environmental_issues
      type: jsonb
      nullable: true

    # HOA
    - name: hoa_applicable
      type: boolean
      default: false

    - name: hoa_documents_reviewed
      type: boolean
      nullable: true

    - name: hoa_fees_current
      type: boolean
      nullable: true

    - name: hoa_issues
      type: jsonb
      nullable: true

    # Financial Review
    - name: tax_status_verified
      type: boolean
      nullable: true

    - name: tax_arrears
      type: decimal
      precision: 15
      scale: 2
      nullable: true

    - name: utility_status_verified
      type: boolean
      nullable: true

    - name: utility_arrears
      type: decimal
      precision: 15
      scale: 2
      nullable: true

    # Overall Assessment
    - name: overall_findings
      type: text
      nullable: true
      description: Summary of findings

    - name: recommendation
      type: enum
      values:
        - proceed
        - proceed_with_conditions
        - negotiate_repairs
        - renegotiate_price
        - not_recommended
        - terminate
      nullable: true

    - name: issues_total
      type: integer
      default: 0

    - name: critical_issues
      type: integer
      default: 0

    - name: issues_resolved
      type: integer
      default: 0

    - name: all_issues_resolved
      type: boolean
      default: false

    # Resolution
    - name: resolution_notes
      type: text
      nullable: true

    - name: buyer_approved
      type: boolean
      nullable: true

    - name: buyer_approved_at
      type: timestamp
      nullable: true

    # Audit
    - name: created_at
      type: timestamp
      default: CURRENT_TIMESTAMP

    - name: updated_at
      type: timestamp
      default: CURRENT_TIMESTAMP
      on_update: CURRENT_TIMESTAMP

    - name: created_by
      type: uuid
      foreign_key: users.id

  # Relationships
  relationships:
    - name: transaction
      type: belongs_to
      entity: Transaction
      foreign_key: transaction_id

    - name: title_search
      type: has_one
      entity: TitleSearch
      foreign_key: due_diligence_id

    - name: documents
      type: has_many
      entity: Document
      foreign_key: due_diligence_id

  # State Machine
  state_machine:
    field: status
    initial: not_started
    transitions:
      - from: not_started
        to: in_progress
        trigger: start
        action: set_start_date

      - from: in_progress
        to: completed
        trigger: complete
        guard: all_checks_done_no_issues
        action: record_completion

      - from: in_progress
        to: issues_found
        trigger: find_issues
        action: compile_issues

      - from: issues_found
        to: pending_resolution
        trigger: request_resolution

      - from: pending_resolution
        to: completed
        trigger: resolve
        guard: all_issues_resolved
        action: record_resolution

      - from: [in_progress, issues_found, pending_resolution]
        to: waived
        trigger: waive
        action: record_waiver

      - from: [in_progress, issues_found, pending_resolution]
        to: expired
        trigger: expire
        guard: past_deadline

  # Computed Fields
  computed_fields:
    - name: days_remaining
      formula: "deadline_date - CURRENT_DATE"

    - name: is_overdue
      formula: "CURRENT_DATE > deadline_date AND status NOT IN ('completed', 'waived', 'expired')"

    - name: completion_percent
      formula: "COUNT(checks WHERE status IN ('passed', 'waived', 'not_applicable')) / COUNT(checks) * 100"

  # Business Rules
  business_rules:
    - rule: BR-DD-001
      name: Critical issue handling
      description: Critical issues must be resolved before closing

    - rule: BR-DD-002
      name: Extension process
      description: Extensions require seller approval

    - rule: BR-DD-003
      name: Waiver documentation
      description: Waivers must be documented and signed

  # Events
  events:
    - name: due_diligence.started
      trigger: on_transition_to_in_progress
      payload: [id, transaction_id, deadline_date]

    - name: due_diligence.issue_found
      trigger: on_critical_issue
      payload: [id, issue_type, description]
      notifications:
        - recipient: buyer
          template: dd_critical_issue

    - name: due_diligence.completed
      trigger: on_transition_to_completed
      payload: [id, recommendation]

    - name: due_diligence.deadline_approaching
      trigger: on_deadline_in_3_days
      payload: [id, days_remaining]
      notifications:
        - recipient: buyer_agent
          template: dd_deadline_reminder

  # API Endpoints
  api:
    endpoints:
      - method: GET
        path: /api/due-diligence/{id}
        description: Get DD details

      - method: POST
        path: /api/transactions/{transaction_id}/due-diligence
        description: Initialize DD

      - method: PUT
        path: /api/due-diligence/{id}
        description: Update DD

      - method: POST
        path: /api/due-diligence/{id}/checks/{check_id}
        description: Update check status

      - method: POST
        path: /api/due-diligence/{id}/complete
        description: Complete DD

      - method: GET
        path: /api/due-diligence/{id}/report
        description: Generate DD report
