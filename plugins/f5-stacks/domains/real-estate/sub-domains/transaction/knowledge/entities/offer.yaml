# Offer Entity
# F5 Framework v2.0 - Real Estate/Transaction
# Property purchase/lease offer management

entity:
  name: Offer
  name_vi: Đề nghị giá
  name_ja: オファー
  domain: real-estate
  subdomain: transaction
  version: "1.0.0"

  description: |
    Represents a formal offer from a buyer to purchase or lease a property.
    Tracks offer terms, conditions, contingencies, and response workflow.

  # Database Configuration
  database:
    table_name: offers
    primary_key: id
    indexes:
      - columns: [offer_id]
        unique: true
      - columns: [transaction_id]
      - columns: [listing_id]
      - columns: [buyer_id]
      - columns: [status]
      - columns: [offer_valid_until]

  # Attributes
  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true

    - name: offer_id
      type: string
      format: "OFR-{YYYYMMDD}-{XXXXXX}"
      unique: true
      description: Human-readable offer ID
      example: "OFR-20241215-X7Y8Z9"

    - name: transaction_id
      type: uuid
      nullable: true
      foreign_key: transactions.id
      description: Associated transaction (created on acceptance)

    - name: listing_id
      type: uuid
      required: true
      foreign_key: listings.id
      description: Target listing

    - name: property_id
      type: uuid
      required: true
      foreign_key: properties.id
      description: Target property

    # Status
    - name: status
      type: enum
      values:
        - draft
        - submitted
        - under_review
        - countered
        - accepted
        - rejected
        - withdrawn
        - expired
      default: draft
      description: Current offer status

    - name: offer_type
      type: enum
      values:
        - initial
        - counter
        - final
        - backup
      default: initial
      description: Type of offer

    - name: offer_sequence
      type: integer
      default: 1
      description: Sequence number in negotiation

    # Buyer Information
    - name: buyer_id
      type: uuid
      required: true
      foreign_key: users.id
      description: Primary buyer

    - name: buyer_name
      type: string
      required: true
      description: Buyer's full name

    - name: buyer_contact
      type: jsonb
      description: Buyer contact information
      schema:
        type: object
        properties:
          phone: { type: string }
          email: { type: string }
          address: { type: string }

    - name: buyer_agent_id
      type: uuid
      nullable: true
      foreign_key: agents.id
      description: Buyer's representing agent

    - name: co_buyers
      type: jsonb
      nullable: true
      description: Additional buyers
      schema:
        type: array
        items:
          type: object
          properties:
            name: { type: string }
            id_number: { type: string }
            share_percent: { type: number }

    # Price
    - name: offer_price
      type: decimal
      precision: 15
      scale: 2
      required: true
      description: Offered price

    - name: currency
      type: string
      length: 3
      default: "VND"

    - name: price_per_sqm
      type: decimal
      precision: 12
      scale: 2
      description: Calculated price per sqm

    - name: earnest_money_amount
      type: decimal
      precision: 15
      scale: 2
      description: Earnest money deposit amount

    - name: earnest_money_percent
      type: decimal
      precision: 5
      scale: 2
      description: Earnest money as percentage

    # Payment Terms
    - name: payment_terms
      type: enum
      values:
        - cash
        - mortgage
        - installment
        - seller_financing
        - mixed
      default: cash
      description: Payment method

    - name: down_payment_amount
      type: decimal
      precision: 15
      scale: 2
      nullable: true
      description: Down payment amount

    - name: down_payment_percent
      type: decimal
      precision: 5
      scale: 2
      nullable: true
      description: Down payment percentage

    # Financing Details
    - name: financing_contingency
      type: boolean
      default: false
      description: Subject to financing approval

    - name: mortgage_amount
      type: decimal
      precision: 15
      scale: 2
      nullable: true
      description: Requested mortgage amount

    - name: mortgage_rate_max
      type: decimal
      precision: 5
      scale: 2
      nullable: true
      description: Maximum acceptable interest rate

    - name: mortgage_term_years
      type: integer
      nullable: true
      description: Mortgage term in years

    - name: pre_approval_status
      type: enum
      values:
        - not_applicable
        - not_obtained
        - pre_qualified
        - pre_approved
        - fully_approved
      default: not_applicable
      description: Mortgage pre-approval status

    - name: pre_approval_letter_url
      type: string
      nullable: true
      description: Pre-approval letter document

    - name: lender_name
      type: string
      nullable: true
      description: Intended lender

    # Contingencies
    - name: inspection_contingency
      type: boolean
      default: true
      description: Subject to property inspection

    - name: inspection_period_days
      type: integer
      default: 14
      description: Days for inspection

    - name: appraisal_contingency
      type: boolean
      default: false
      description: Subject to appraisal

    - name: sale_contingency
      type: boolean
      default: false
      description: Subject to buyer selling existing property

    - name: sale_contingency_property
      type: string
      nullable: true
      description: Address of property to be sold

    - name: title_contingency
      type: boolean
      default: true
      description: Subject to clear title

    # Other Conditions
    - name: conditions
      type: jsonb
      description: Additional conditions
      schema:
        type: array
        items:
          type: object
          properties:
            type: { type: string }
            description: { type: string }
            deadline: { type: string, format: date }
            status: { type: string, enum: [pending, met, waived, failed] }

    - name: inclusions
      type: array
      items: string
      description: Items included in sale
      example: ["furniture", "appliances", "fixtures"]

    - name: exclusions
      type: array
      items: string
      description: Items excluded from sale

    # Timeline
    - name: offer_valid_until
      type: timestamp
      required: true
      description: Offer expiration datetime

    - name: proposed_closing_date
      type: date
      required: true
      description: Proposed closing date

    - name: proposed_possession_date
      type: date
      nullable: true
      description: Proposed possession/handover date

    - name: due_diligence_period_days
      type: integer
      default: 14
      description: Proposed due diligence period

    # Submission
    - name: submitted_at
      type: timestamp
      nullable: true
      description: When offer was submitted

    - name: submission_method
      type: enum
      values:
        - platform
        - email
        - in_person
        - fax
      default: platform
      description: How offer was submitted

    - name: cover_letter
      type: text
      nullable: true
      description: Buyer's cover letter

    - name: supporting_documents
      type: array
      items: uuid
      description: Supporting document references

    # Response
    - name: reviewed_at
      type: timestamp
      nullable: true
      description: When seller reviewed

    - name: responded_at
      type: timestamp
      nullable: true
      description: When seller responded

    - name: response_type
      type: enum
      values:
        - pending
        - accepted
        - rejected
        - countered
      default: pending
      description: Seller's response type

    - name: rejection_reason
      type: string
      nullable: true
      description: Reason if rejected

    - name: counter_offer_id
      type: uuid
      nullable: true
      description: Reference to counter offer

    # Seller Notes
    - name: seller_notes
      type: text
      nullable: true
      description: Seller's private notes

    # Audit
    - name: created_at
      type: timestamp
      default: CURRENT_TIMESTAMP

    - name: updated_at
      type: timestamp
      default: CURRENT_TIMESTAMP
      on_update: CURRENT_TIMESTAMP

    - name: created_by
      type: uuid
      foreign_key: users.id

  # Relationships
  relationships:
    - name: transaction
      type: belongs_to
      entity: Transaction
      foreign_key: transaction_id

    - name: listing
      type: belongs_to
      entity: Listing
      foreign_key: listing_id

    - name: property
      type: belongs_to
      entity: Property
      foreign_key: property_id

    - name: buyer
      type: belongs_to
      entity: User
      foreign_key: buyer_id

    - name: buyer_agent
      type: belongs_to
      entity: Agent
      foreign_key: buyer_agent_id

    - name: counter_offers
      type: has_many
      entity: CounterOffer
      foreign_key: original_offer_id

    - name: deposits
      type: has_many
      entity: Deposit
      foreign_key: offer_id

  # State Machine
  state_machine:
    field: status
    initial: draft
    transitions:
      - from: draft
        to: submitted
        trigger: submit
        action: set_submission_time
        guard: validate_completeness

      - from: submitted
        to: under_review
        trigger: acknowledge
        action: record_review_start

      - from: under_review
        to: accepted
        trigger: accept
        action: create_transaction

      - from: under_review
        to: rejected
        trigger: reject
        action: record_rejection

      - from: under_review
        to: countered
        trigger: counter
        action: create_counter_offer

      - from: [submitted, under_review]
        to: expired
        trigger: expire
        action: mark_expired
        guard: past_expiration

      - from: [draft, submitted, under_review]
        to: withdrawn
        trigger: withdraw
        action: record_withdrawal

  # Computed Fields
  computed_fields:
    - name: is_expired
      formula: "offer_valid_until < NOW() AND status IN ('submitted', 'under_review')"

    - name: price_vs_list
      formula: "((offer_price - listing.asking_price) / listing.asking_price) * 100"
      description: Percentage above/below list price

    - name: hours_until_expiration
      formula: "EXTRACT(EPOCH FROM (offer_valid_until - NOW())) / 3600"

  # Business Rules
  business_rules:
    - rule: BR-OFR-001
      name: Minimum offer validity
      description: Offer must be valid for at least 24 hours
      validation: "offer_valid_until > NOW() + INTERVAL '24 hours'"

    - rule: BR-OFR-002
      name: Earnest money minimum
      description: Earnest money must be at least 1% of offer price
      validation: "earnest_money_amount >= offer_price * 0.01"

    - rule: BR-OFR-003
      name: Closing date range
      description: Closing date must be 14-180 days from submission
      validation: "proposed_closing_date BETWEEN submitted_at + 14 AND submitted_at + 180"

    - rule: BR-OFR-004
      name: Pre-approval for financing
      description: Financing offers should have pre-approval
      warning: "financing_contingency AND pre_approval_status = 'not_obtained'"

  # Validations
  validations:
    - field: offer_price
      rule: positive
      message: "Offer price must be positive"

    - field: offer_valid_until
      rule: future
      when: status == 'draft'
      message: "Offer expiration must be in the future"

    - field: proposed_closing_date
      rule: future
      message: "Closing date must be in the future"

    - field: earnest_money_percent
      rule: range
      min: 1
      max: 20
      message: "Earnest money typically 1-20% of offer price"

  # Events
  events:
    - name: offer.created
      trigger: on_create
      payload: [id, offer_id, listing_id, buyer_id, offer_price]

    - name: offer.submitted
      trigger: on_transition_to_submitted
      payload: [id, listing_id, offer_price, seller_id]
      notifications:
        - recipient: seller
          template: new_offer_received
        - recipient: seller_agent
          template: new_offer_notification

    - name: offer.accepted
      trigger: on_transition_to_accepted
      payload: [id, transaction_id, buyer_id, final_price]
      notifications:
        - recipient: buyer
          template: offer_accepted
        - recipient: buyer_agent
          template: offer_acceptance_notification

    - name: offer.rejected
      trigger: on_transition_to_rejected
      payload: [id, buyer_id, rejection_reason]
      notifications:
        - recipient: buyer
          template: offer_rejected

    - name: offer.countered
      trigger: on_transition_to_countered
      payload: [id, counter_offer_id]
      notifications:
        - recipient: buyer
          template: counter_offer_received

    - name: offer.expired
      trigger: on_transition_to_expired
      payload: [id, buyer_id, listing_id]

  # API Endpoints
  api:
    endpoints:
      - method: GET
        path: /api/offers
        description: List offers
        filters: [status, listing_id, buyer_id, date_range]

      - method: GET
        path: /api/offers/{id}
        description: Get offer details

      - method: POST
        path: /api/offers
        description: Create new offer

      - method: PUT
        path: /api/offers/{id}
        description: Update offer (draft only)

      - method: POST
        path: /api/offers/{id}/submit
        description: Submit offer

      - method: POST
        path: /api/offers/{id}/respond
        description: Respond to offer (accept/reject/counter)

      - method: POST
        path: /api/offers/{id}/withdraw
        description: Withdraw offer
