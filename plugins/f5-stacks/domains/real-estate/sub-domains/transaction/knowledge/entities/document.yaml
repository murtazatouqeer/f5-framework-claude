# Document Entity
# F5 Framework v2.0 - Real Estate/Transaction
# Transaction document management

entity:
  name: Document
  name_vi: Tài liệu
  name_ja: 書類
  domain: real-estate
  subdomain: transaction
  version: "1.0.0"

  description: |
    Manages all documents associated with real estate transactions.
    Tracks document collection, verification, and storage.

  # Database Configuration
  database:
    table_name: transaction_documents
    primary_key: id
    indexes:
      - columns: [document_id]
        unique: true
      - columns: [transaction_id]
      - columns: [document_type]
      - columns: [status]
      - columns: [required_from]

  # Attributes
  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true

    - name: document_id
      type: string
      format: "DOC-{YYYYMMDD}-{XXXXXX}"
      unique: true
      description: Document reference ID

    - name: transaction_id
      type: uuid
      required: true
      foreign_key: transactions.id
      description: Associated transaction

    - name: contract_id
      type: uuid
      nullable: true
      foreign_key: contracts.id

    - name: closing_id
      type: uuid
      nullable: true
      foreign_key: closings.id

    # Document Info
    - name: document_type
      type: enum
      values:
        # Identity Documents
        - id_card
        - passport
        - household_registration
        - marriage_certificate
        - birth_certificate
        - death_certificate
        - power_of_attorney
        # Property Documents
        - property_certificate
        - land_use_certificate
        - construction_permit
        - floor_plan
        - survey_map
        - tax_clearance
        # Transaction Documents
        - purchase_offer
        - counter_offer
        - purchase_agreement
        - deposit_receipt
        - payment_receipt
        - escrow_agreement
        - closing_statement
        # Legal Documents
        - notarized_contract
        - deed
        - land_registration
        - title_insurance
        # Financial Documents
        - bank_statement
        - proof_of_funds
        - mortgage_approval
        - mortgage_commitment
        - appraisal_report
        # Inspection Documents
        - inspection_report
        - repair_request
        - repair_completion
        # Other
        - utility_bill
        - hoa_documents
        - disclosure_statement
        - other
      required: true
      description: Type of document

    - name: document_category
      type: enum
      values:
        - identity
        - property
        - transaction
        - legal
        - financial
        - inspection
        - compliance
        - other
      description: Document category

    - name: name
      type: string
      required: true
      description: Document name

    - name: description
      type: text
      nullable: true
      description: Document description

    # Status
    - name: status
      type: enum
      values:
        - required
        - requested
        - pending_upload
        - uploaded
        - under_review
        - verified
        - rejected
        - expired
        - superseded
      default: required
      description: Document status

    - name: is_required
      type: boolean
      default: true
      description: Whether document is required

    - name: required_from
      type: enum
      values:
        - buyer
        - seller
        - both
        - agent
        - third_party
        - system
      description: Who should provide

    - name: provided_by
      type: uuid
      nullable: true
      foreign_key: users.id

    - name: provided_by_name
      type: string
      nullable: true

    # File Info
    - name: file_url
      type: string
      nullable: true
      description: Storage URL

    - name: file_name
      type: string
      nullable: true
      description: Original filename

    - name: file_type
      type: string
      nullable: true
      description: MIME type

    - name: file_size
      type: integer
      nullable: true
      description: Size in bytes

    - name: file_hash
      type: string
      nullable: true
      description: File checksum

    - name: thumbnail_url
      type: string
      nullable: true

    # Version Control
    - name: version
      type: integer
      default: 1

    - name: is_latest
      type: boolean
      default: true

    - name: previous_version_id
      type: uuid
      nullable: true
      foreign_key: transaction_documents.id

    - name: superseded_by_id
      type: uuid
      nullable: true

    # Timeline
    - name: requested_at
      type: timestamp
      nullable: true

    - name: due_date
      type: date
      nullable: true

    - name: uploaded_at
      type: timestamp
      nullable: true

    - name: reviewed_at
      type: timestamp
      nullable: true

    - name: verified_at
      type: timestamp
      nullable: true

    - name: verified_by
      type: uuid
      nullable: true
      foreign_key: users.id

    # Verification
    - name: verification_status
      type: enum
      values:
        - not_verified
        - pending
        - verified
        - failed
      default: not_verified

    - name: verification_method
      type: enum
      values:
        - manual
        - automated
        - third_party
      nullable: true

    - name: verification_notes
      type: text
      nullable: true

    - name: rejection_reason
      type: string
      nullable: true

    # Validity
    - name: valid_from
      type: date
      nullable: true

    - name: valid_until
      type: date
      nullable: true

    - name: is_expired
      type: boolean
      default: false

    # Source
    - name: source
      type: enum
      values:
        - user_upload
        - system_generated
        - third_party
        - imported
      default: user_upload

    - name: source_reference
      type: string
      nullable: true
      description: External reference if applicable

    # Document Numbers
    - name: document_number
      type: string
      nullable: true
      description: Official document number

    - name: issued_date
      type: date
      nullable: true

    - name: issued_by
      type: string
      nullable: true

    # Security
    - name: is_sensitive
      type: boolean
      default: false
      description: Contains sensitive information

    - name: access_level
      type: enum
      values:
        - public
        - transaction_parties
        - agents_only
        - restricted
      default: transaction_parties

    - name: watermarked
      type: boolean
      default: false

    # Notes
    - name: notes
      type: text
      nullable: true

    - name: internal_notes
      type: text
      nullable: true

    # Audit
    - name: created_at
      type: timestamp
      default: CURRENT_TIMESTAMP

    - name: updated_at
      type: timestamp
      default: CURRENT_TIMESTAMP
      on_update: CURRENT_TIMESTAMP

    - name: created_by
      type: uuid
      foreign_key: users.id

  # Relationships
  relationships:
    - name: transaction
      type: belongs_to
      entity: Transaction
      foreign_key: transaction_id

    - name: contract
      type: belongs_to
      entity: Contract
      foreign_key: contract_id

    - name: closing
      type: belongs_to
      entity: Closing
      foreign_key: closing_id

    - name: provider
      type: belongs_to
      entity: User
      foreign_key: provided_by

    - name: previous_version
      type: belongs_to
      entity: Document
      foreign_key: previous_version_id

  # State Machine
  state_machine:
    field: status
    initial: required
    transitions:
      - from: required
        to: requested
        trigger: request
        action: send_request_notification

      - from: [required, requested]
        to: pending_upload
        trigger: await_upload

      - from: [required, requested, pending_upload]
        to: uploaded
        trigger: upload
        action: process_upload

      - from: uploaded
        to: under_review
        trigger: submit_for_review

      - from: under_review
        to: verified
        trigger: verify
        action: mark_verified

      - from: under_review
        to: rejected
        trigger: reject
        action: notify_rejection

      - from: rejected
        to: pending_upload
        trigger: request_reupload

      - from: [uploaded, verified]
        to: expired
        trigger: expire
        guard: past_validity

      - from: verified
        to: superseded
        trigger: supersede
        action: mark_as_superseded

  # Document Type Configuration
  document_types_config:
    id_card:
      name: ID Card (CMND/CCCD)
      name_vi: Chứng minh nhân dân/Căn cước công dân
      category: identity
      required_fields: [document_number, issued_date, issued_by, valid_until]
      validity_years: 15

    property_certificate:
      name: Property Certificate
      name_vi: Giấy chứng nhận quyền sử dụng đất
      category: property
      required_fields: [document_number, issued_date, issued_by]
      critical: true

    notarized_contract:
      name: Notarized Contract
      name_vi: Hợp đồng công chứng
      category: legal
      required_fields: [document_number, issued_date, issued_by]
      critical: true

    deposit_receipt:
      name: Deposit Receipt
      name_vi: Biên nhận đặt cọc
      category: transaction
      system_generated: true

  # Business Rules
  business_rules:
    - rule: BR-DOC-001
      name: Required documents
      description: All required documents must be verified before closing

    - rule: BR-DOC-002
      name: Expiry check
      description: Documents must be valid at time of use

    - rule: BR-DOC-003
      name: Version control
      description: Maintain version history for critical documents

  # Validations
  validations:
    - field: file_url
      rule: required
      when: status == 'uploaded'
      message: "File URL required when uploaded"

    - field: verification_notes
      rule: required
      when: status == 'rejected'
      message: "Rejection reason required"

  # Events
  events:
    - name: document.requested
      trigger: on_transition_to_requested
      payload: [id, document_type, required_from, due_date]
      notifications:
        - recipient: required_from
          template: document_request

    - name: document.uploaded
      trigger: on_transition_to_uploaded
      payload: [id, document_type, provided_by]

    - name: document.verified
      trigger: on_transition_to_verified
      payload: [id, document_type]

    - name: document.rejected
      trigger: on_transition_to_rejected
      payload: [id, document_type, rejection_reason]
      notifications:
        - recipient: provided_by
          template: document_rejected

  # API Endpoints
  api:
    endpoints:
      - method: GET
        path: /api/transactions/{transaction_id}/documents
        description: List transaction documents

      - method: GET
        path: /api/documents/{id}
        description: Get document details

      - method: POST
        path: /api/transactions/{transaction_id}/documents
        description: Upload document

      - method: PUT
        path: /api/documents/{id}
        description: Update document

      - method: POST
        path: /api/documents/{id}/verify
        description: Verify document

      - method: GET
        path: /api/documents/{id}/download
        description: Download document
