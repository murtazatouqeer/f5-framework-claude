name: night-audit
display_name: Night Audit
display_name_vi: Kiểm toán đêm
version: "1.0"
domain: travel-hospitality
subdomain: hotel

description: |
  Night audit entity representing the daily end-of-day process
  that posts room charges, reconciles accounts, rolls the business
  date, and generates daily reports.

description_vi: |
  Thực thể kiểm toán đêm đại diện cho quy trình cuối ngày hàng ngày
  ghi phí phòng, đối chiếu tài khoản, chuyển ngày kinh doanh
  và tạo báo cáo hàng ngày.

attributes:
  identity:
    - name: audit_id
      type: string
      format: "NA-{property_code}-{YYYYMMDD}"
      required: true
      description: Unique night audit identifier

    - name: property_id
      type: string
      required: true

    - name: business_date
      type: date
      required: true
      description: Date being audited

    - name: audit_number
      type: integer
      description: Sequential audit number

  timing:
    - name: audit_start_time
      type: timestamp
      description: When audit process started

    - name: audit_end_time
      type: timestamp
      description: When audit completed

    - name: date_roll_time
      type: timestamp
      description: When business date changed

    - name: duration_minutes
      type: integer
      computed: true

    - name: auditor_id
      type: string
      description: Night auditor user

    - name: auditor_name
      type: string

  pre_audit_checks:
    - name: housekeeping_discrepancies
      type: array
      items:
        type: object
        properties:
          room_number: string
          pms_status: string
          hk_status: string
          resolved: boolean

    - name: rate_variances
      type: array
      items:
        type: object
        properties:
          reservation_id: string
          room_number: string
          expected_rate: decimal
          actual_rate: decimal
          variance: decimal
          reason: string
          approved_by: string

    - name: no_shows
      type: array
      items:
        type: object
        properties:
          reservation_id: string
          confirmation_number: string
          guest_name: string
          room_type: string
          charge_applied: decimal
          processed: boolean

    - name: pending_departures
      type: array
      items:
        type: object
        properties:
          reservation_id: string
          room_number: string
          guest_name: string
          balance_due: decimal
          action_taken: string

  room_revenue:
    - name: rooms_occupied
      type: integer
      description: Total occupied rooms

    - name: rooms_complimentary
      type: integer

    - name: rooms_house_use
      type: integer

    - name: rooms_available
      type: integer

    - name: rooms_out_of_order
      type: integer

    - name: occupancy_percentage
      type: decimal
      computed: true

    - name: total_room_revenue
      type: decimal

    - name: average_daily_rate
      type: decimal

    - name: revpar
      type: decimal
      computed: true

    - name: room_revenue_breakdown
      type: array
      items:
        type: object
        properties:
          room_type: string
          rooms_sold: integer
          revenue: decimal
          adr: decimal

  postings:
    - name: room_charges_posted
      type: integer
      description: Number of room charge postings

    - name: room_charges_amount
      type: decimal

    - name: tax_postings
      type: object
      properties:
        room_tax: decimal
        occupancy_tax: decimal
        tourism_tax: decimal
        service_charge: decimal
        other_taxes: decimal
        total_tax: decimal

    - name: package_postings
      type: object
      properties:
        breakfast: decimal
        meals: decimal
        spa: decimal
        other: decimal

    - name: recurring_charges_posted
      type: array
      items:
        type: object
        properties:
          charge_code: string
          description: string
          count: integer
          amount: decimal

  other_revenue:
    - name: fb_revenue
      type: object
      properties:
        restaurant: decimal
        bar: decimal
        room_service: decimal
        banquet: decimal
        minibar: decimal
        total: decimal

    - name: other_revenue
      type: object
      properties:
        spa: decimal
        telephone: decimal
        parking: decimal
        laundry: decimal
        business_center: decimal
        miscellaneous: decimal
        total: decimal

    - name: total_revenue
      type: decimal
      computed: true

  payments:
    - name: payments_received
      type: object
      properties:
        cash: decimal
        credit_card: decimal
        debit_card: decimal
        city_ledger: decimal
        advance_deposit: decimal
        other: decimal
        total: decimal

    - name: refunds_processed
      type: decimal

    - name: adjustments
      type: object
      properties:
        allowances: decimal
        corrections: decimal
        total: decimal

  accounts_receivable:
    - name: opening_ar_balance
      type: decimal

    - name: ar_charges
      type: decimal

    - name: ar_payments
      type: decimal

    - name: closing_ar_balance
      type: decimal
      computed: true

    - name: city_ledger_transfers
      type: array
      items:
        type: object
        properties:
          folio_id: string
          guest_name: string
          company: string
          amount: decimal
          ar_account: string

  cash_management:
    - name: opening_cash
      type: decimal

    - name: cash_received
      type: decimal

    - name: cash_paid_out
      type: decimal

    - name: closing_cash
      type: decimal
      computed: true

    - name: cash_variance
      type: decimal
      description: Over/short

    - name: cash_drawer_counts
      type: array
      items:
        type: object
        properties:
          drawer_id: string
          cashier: string
          expected: decimal
          actual: decimal
          variance: decimal

    - name: deposits_made
      type: array
      items:
        type: object
        properties:
          deposit_type: string
          amount: decimal
          bank: string
          reference: string

  reconciliation:
    - name: trial_balance
      type: object
      properties:
        total_debits: decimal
        total_credits: decimal
        difference: decimal
        is_balanced: boolean

    - name: guest_ledger_balance
      type: decimal
      description: Total outstanding guest folios

    - name: deposit_ledger_balance
      type: decimal
      description: Advance deposits held

    - name: credit_card_settlement
      type: array
      items:
        type: object
        properties:
          card_type: string
          transaction_count: integer
          total_amount: decimal
          settlement_batch: string
          settled: boolean

  statistics:
    - name: arrivals
      type: object
      properties:
        expected: integer
        actual: integer
        walk_ins: integer

    - name: departures
      type: object
      properties:
        expected: integer
        actual: integer
        early_departures: integer
        extensions: integer

    - name: stayovers
      type: integer

    - name: day_use
      type: integer

    - name: guest_count
      type: object
      properties:
        adults: integer
        children: integer
        total: integer

    - name: reservation_statistics
      type: object
      properties:
        new_reservations: integer
        cancellations: integer
        modifications: integer
        no_shows: integer

  market_segment:
    - name: segment_statistics
      type: array
      items:
        type: object
        properties:
          segment: string
          room_nights: integer
          revenue: decimal
          adr: decimal
          percentage: decimal

    - name: source_statistics
      type: array
      items:
        type: object
        properties:
          source: string
          room_nights: integer
          revenue: decimal

  channel_statistics:
    - name: channel_production
      type: array
      items:
        type: object
        properties:
          channel_id: string
          channel_name: string
          reservations: integer
          room_nights: integer
          revenue: decimal
          adr: decimal
          commission: decimal

  errors_and_issues:
    - name: audit_errors
      type: array
      items:
        type: object
        properties:
          error_type: string
          description: string
          severity: enum [warning, error, critical]
          resolved: boolean
          resolution: string

    - name: manual_overrides
      type: array
      items:
        type: object
        properties:
          override_type: string
          original_value: decimal
          override_value: decimal
          reason: string
          approved_by: string

  status:
    - name: status
      type: enum
      values:
        - not_started
        - in_progress
        - pending_review
        - completed
        - rolled_back
      required: true
      default: not_started

    - name: pre_audit_complete
      type: boolean
      default: false

    - name: postings_complete
      type: boolean
      default: false

    - name: reconciliation_complete
      type: boolean
      default: false

    - name: reports_generated
      type: boolean
      default: false

    - name: date_rolled
      type: boolean
      default: false

  reports:
    - name: reports_generated
      type: array
      items:
        type: object
        properties:
          report_name: string
          report_type: string
          generated_at: timestamp
          file_url: string

    - name: standard_reports
      type: object
      properties:
        manager_report: boolean
        revenue_report: boolean
        statistics_report: boolean
        ar_aging: boolean
        cashier_report: boolean
        housekeeping_report: boolean
        guest_list: boolean

  audit_trail:
    - name: created_at
      type: timestamp
      auto: true

    - name: updated_at
      type: timestamp
      auto: true

    - name: approved_by
      type: string

    - name: approved_at
      type: timestamp

    - name: review_notes
      type: text

relationships:
  - entity: property
    type: many_to_one
    required: true

  - entity: folio
    type: one_to_many
    description: Folios processed in audit

  - entity: charge
    type: one_to_many
    description: Charges posted during audit

indexes:
  - fields: [property_id, business_date]
    unique: true
  - fields: [property_id, status]
  - fields: [auditor_id, business_date]

state_machine:
  name: audit_status
  states:
    - not_started
    - in_progress
    - pending_review
    - completed
    - rolled_back

  transitions:
    - from: not_started
      to: in_progress
      trigger: start_audit

    - from: in_progress
      to: pending_review
      trigger: audit_finished

    - from: pending_review
      to: completed
      trigger: approve_audit

    - from: pending_review
      to: in_progress
      trigger: reject_audit

    - from: completed
      to: rolled_back
      trigger: rollback_audit
      condition: manager_approval

business_rules:
  - rule: BR-NA-001
    description: Audit cannot start with unresolved room discrepancies
  - rule: BR-NA-002
    description: All departures must be checked out or extended
  - rule: BR-NA-003
    description: Trial balance must be zero before completion
  - rule: BR-NA-004
    description: Date roll is irreversible without manager approval
  - rule: BR-NA-005
    description: All pending no-shows must be processed

audit_sequence:
  1_pre_audit:
    - resolve_room_discrepancies
    - process_due_outs
    - handle_no_shows
    - verify_rate_postings
  2_posting:
    - post_room_charges
    - post_taxes
    - post_recurring_charges
    - post_package_elements
  3_reconciliation:
    - balance_cashier_drawers
    - settle_credit_cards
    - transfer_city_ledger
    - verify_trial_balance
  4_completion:
    - generate_reports
    - backup_data
    - roll_business_date
    - notify_stakeholders
