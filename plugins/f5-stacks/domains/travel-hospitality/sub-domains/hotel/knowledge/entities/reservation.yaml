name: reservation
display_name: Reservation
display_name_vi: Đặt phòng
version: "1.0"
domain: travel-hospitality
subdomain: hotel

description: |
  Hotel reservation entity representing a booking for one or more rooms
  with guest details, rate information, and stay specifications.

description_vi: |
  Thực thể đặt phòng khách sạn đại diện cho việc đặt một hoặc nhiều phòng
  với thông tin khách, thông tin giá và chi tiết lưu trú.

attributes:
  identity:
    - name: reservation_id
      type: string
      format: "RES-{property_code}-{YYYYMMDD}-{sequence}"
      required: true
      description: Unique reservation identifier

    - name: confirmation_number
      type: string
      max_length: 20
      required: true
      description: Guest-facing confirmation number

    - name: property_id
      type: string
      required: true
      description: Property reference

    - name: external_reference
      type: string
      description: OTA/GDS booking reference

    - name: channel_reservation_id
      type: string
      description: Channel's reservation ID

  booking_info:
    - name: booking_date
      type: timestamp
      required: true
      description: When reservation was made

    - name: booking_source
      type: enum
      values:
        - direct_website
        - call_center
        - front_desk
        - walk_in
        - gds
        - ota
        - corporate
        - travel_agent
        - group
        - mobile_app
      required: true

    - name: channel_id
      type: string
      description: Distribution channel reference

    - name: market_segment
      type: enum
      values:
        - transient
        - corporate
        - group
        - leisure
        - government
        - airline
        - wholesale

    - name: source_of_business
      type: string
      description: Detailed source

    - name: agent_id
      type: string
      description: Travel agent reference

    - name: company_id
      type: string
      description: Corporate account reference

    - name: group_id
      type: string
      description: Group booking reference

  stay_details:
    - name: arrival_date
      type: date
      required: true

    - name: departure_date
      type: date
      required: true

    - name: nights
      type: integer
      computed: true
      description: Calculated from dates

    - name: check_in_time
      type: time
      description: Expected arrival time

    - name: check_out_time
      type: time
      description: Expected departure time

    - name: actual_arrival
      type: timestamp
      description: Actual check-in time

    - name: actual_departure
      type: timestamp
      description: Actual check-out time

  room_details:
    - name: room_type_id
      type: string
      required: true
      description: Requested room type

    - name: room_count
      type: integer
      default: 1
      description: Number of rooms booked

    - name: assigned_room_ids
      type: array
      items: string
      description: Assigned room numbers

    - name: room_preference
      type: object
      properties:
        floor_preference: enum [low, high, specific]
        floor_number: integer
        view_preference: string
        bed_preference: enum [king, queen, twin]
        smoking_preference: enum [smoking, non_smoking, no_preference]
        accessibility_required: boolean
        connecting_rooms: boolean

  occupancy:
    - name: adults
      type: integer
      required: true
      min: 1

    - name: children
      type: integer
      default: 0

    - name: children_ages
      type: array
      items: integer
      description: Ages of children

    - name: infants
      type: integer
      default: 0

    - name: extra_beds
      type: integer
      default: 0

  rate_info:
    - name: rate_plan_id
      type: string
      required: true
      description: Applied rate plan

    - name: rate_code
      type: string
      required: true

    - name: daily_rates
      type: array
      items:
        type: object
        properties:
          date: date
          rate_amount: decimal
          base_rate: decimal
          extra_adult: decimal
          extra_child: decimal
          taxes: decimal
          total: decimal
      required: true

    - name: average_daily_rate
      type: decimal
      computed: true

    - name: total_room_charge
      type: decimal
      computed: true

    - name: currency_code
      type: string
      format: ISO 4217
      required: true

  meal_plan:
    - name: meal_plan_code
      type: enum
      values: [RO, BB, HB, FB, AI]
      required: true

    - name: meal_plan_amount
      type: decimal
      default: 0

  services:
    - name: additional_services
      type: array
      items:
        type: object
        properties:
          service_code: string
          service_name: string
          quantity: integer
          unit_price: decimal
          total_price: decimal
          date: date

    - name: packages
      type: array
      items:
        type: object
        properties:
          package_code: string
          package_name: string
          amount: decimal

  guest_info:
    - name: primary_guest_id
      type: string
      required: true
      description: Main guest reference

    - name: guest_profile_id
      type: string
      description: Linked guest profile

    - name: additional_guests
      type: array
      items:
        type: object
        properties:
          guest_id: string
          guest_type: enum [adult, child, infant]
          name: string

    - name: guest_requests
      type: text
      description: Special requests

    - name: guest_comments
      type: text
      description: Internal comments about guest

  payment:
    - name: payment_method
      type: enum
      values:
        - credit_card
        - debit_card
        - cash
        - bank_transfer
        - company_account
        - travel_agent_voucher
        - prepaid
      required: true

    - name: guarantee_type
      type: enum
      values:
        - credit_card
        - deposit
        - company_guarantee
        - travel_agent_guarantee
        - no_guarantee
      required: true

    - name: credit_card_token
      type: string
      description: Tokenized card for PCI compliance

    - name: card_type
      type: string

    - name: card_last_four
      type: string
      max_length: 4

    - name: card_expiry
      type: string
      format: MM/YY

    - name: deposit_amount
      type: decimal
      default: 0

    - name: deposit_paid
      type: boolean
      default: false

    - name: deposit_due_date
      type: date

  billing:
    - name: folio_id
      type: string
      description: Primary folio reference

    - name: billing_type
      type: enum
      values:
        - guest_pay
        - company_pay
        - split
        - agent_pay
      default: guest_pay

    - name: billing_instructions
      type: text
      description: Special billing instructions

    - name: routing_instructions
      type: array
      items:
        type: object
        properties:
          charge_code: string
          route_to: enum [guest, company, agent]

  status:
    - name: status
      type: enum
      values:
        - tentative
        - confirmed
        - guaranteed
        - waitlisted
        - checked_in
        - checked_out
        - cancelled
        - no_show
      required: true

    - name: cancellation_date
      type: timestamp
      description: When cancelled

    - name: cancellation_reason
      type: string

    - name: cancellation_number
      type: string

    - name: cancellation_penalty
      type: decimal

    - name: no_show_date
      type: date

    - name: no_show_charge
      type: decimal

  policies:
    - name: cancellation_policy
      type: object
      properties:
        deadline: timestamp
        penalty_type: enum [none, first_night, percentage, full]
        penalty_amount: decimal

    - name: deposit_policy
      type: object
      properties:
        required: boolean
        amount: decimal
        due_date: date

  communication:
    - name: confirmation_sent
      type: boolean
      default: false

    - name: confirmation_sent_date
      type: timestamp

    - name: reminder_sent
      type: boolean
      default: false

    - name: pre_arrival_email_sent
      type: boolean
      default: false

  operational:
    - name: vip_status
      type: enum
      values: [none, silver, gold, platinum, diamond]
      default: none

    - name: is_complimentary
      type: boolean
      default: false

    - name: comp_reason
      type: string

    - name: is_house_use
      type: boolean
      default: false

    - name: house_use_reason
      type: string

    - name: share_with_reservation_id
      type: string
      description: Sharing room with another reservation

  audit:
    - name: created_at
      type: timestamp
      auto: true

    - name: updated_at
      type: timestamp
      auto: true

    - name: created_by
      type: string

    - name: updated_by
      type: string

    - name: confirmed_by
      type: string

    - name: checked_in_by
      type: string

    - name: checked_out_by
      type: string

relationships:
  - entity: property
    type: many_to_one
    required: true

  - entity: room_type
    type: many_to_one
    required: true

  - entity: room
    type: many_to_one
    description: Assigned room

  - entity: rate_plan
    type: many_to_one
    required: true

  - entity: guest
    type: many_to_one
    required: true

  - entity: guest_profile
    type: many_to_one

  - entity: folio
    type: one_to_one

  - entity: channel
    type: many_to_one

indexes:
  - fields: [property_id, confirmation_number]
    unique: true
  - fields: [property_id, arrival_date, status]
  - fields: [property_id, departure_date, status]
  - fields: [primary_guest_id]
  - fields: [external_reference]
  - fields: [group_id]
  - fields: [company_id]

state_machine:
  name: reservation_status
  states:
    - tentative
    - confirmed
    - guaranteed
    - waitlisted
    - checked_in
    - checked_out
    - cancelled
    - no_show

  transitions:
    - from: tentative
      to: confirmed
      trigger: confirmation_received

    - from: [tentative, confirmed]
      to: guaranteed
      trigger: guarantee_received

    - from: [tentative, confirmed]
      to: waitlisted
      trigger: sold_out

    - from: waitlisted
      to: confirmed
      trigger: availability_opened

    - from: [confirmed, guaranteed]
      to: checked_in
      trigger: check_in

    - from: checked_in
      to: checked_out
      trigger: check_out

    - from: [tentative, confirmed, guaranteed, waitlisted]
      to: cancelled
      trigger: cancellation

    - from: [confirmed, guaranteed]
      to: no_show
      trigger: arrival_date_passed

business_rules:
  - rule: BR-RES-001
    description: Departure date must be after arrival date
  - rule: BR-RES-002
    description: Occupancy cannot exceed room type max
  - rule: BR-RES-003
    description: Rate plan must be valid for stay dates
  - rule: BR-RES-004
    description: Guaranteed reservation requires valid guarantee
  - rule: BR-RES-005
    description: No-show charge applies if guest doesn't arrive

htng_mapping:
  standard: HTNG Reservation Message
  elements:
    - ReservationID → reservation_id
    - ConfirmationNumber → confirmation_number
    - ArrivalDate → arrival_date
    - DepartureDate → departure_date
    - RoomTypeCode → room_type_id
    - RatePlanCode → rate_plan_id
