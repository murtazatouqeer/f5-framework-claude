name: payment
display_name: Payment
display_name_vi: Thanh toán
version: "1.0"
domain: travel-hospitality
subdomain: hotel

description: |
  Payment entity representing payments received against a guest folio.
  Includes cash, card payments, deposits, and settlement transactions.

description_vi: |
  Thực thể thanh toán đại diện cho các khoản thanh toán nhận được cho
  hóa đơn khách. Bao gồm tiền mặt, thẻ, đặt cọc và các giao dịch thanh toán.

attributes:
  identity:
    - name: payment_id
      type: string
      format: "PAY-{property_code}-{YYYYMMDD}-{sequence}"
      required: true
      description: Unique payment identifier

    - name: receipt_number
      type: string
      max_length: 20
      required: true
      description: Display receipt number

    - name: property_id
      type: string
      required: true

    - name: folio_id
      type: string
      required: true
      description: Target folio

    - name: reservation_id
      type: string

  payment_details:
    - name: payment_date
      type: date
      required: true
      description: Business date

    - name: payment_time
      type: timestamp
      required: true

    - name: payment_type
      type: enum
      values:
        - cash
        - credit_card
        - debit_card
        - bank_transfer
        - check
        - voucher
        - loyalty_points
        - deposit_applied
        - city_ledger
        - travel_agent_voucher
        - direct_bill
        - mobile_payment
        - cryptocurrency
      required: true

    - name: payment_category
      type: enum
      values:
        - advance_deposit
        - payment
        - settlement
        - refund
        - chargeback
        - adjustment
      required: true

  amounts:
    - name: amount
      type: decimal
      required: true
      description: Payment amount

    - name: currency_code
      type: string
      format: ISO 4217
      required: true

    - name: exchange_rate
      type: decimal
      default: 1.0

    - name: base_currency_amount
      type: decimal
      description: Amount in property currency

    - name: tip_amount
      type: decimal
      default: 0

    - name: surcharge_amount
      type: decimal
      default: 0
      description: Card surcharge if any

    - name: total_amount
      type: decimal
      computed: true
      description: amount + tip + surcharge

  cash_details:
    - name: amount_tendered
      type: decimal
      description: Amount given for cash

    - name: change_given
      type: decimal
      description: Change returned

    - name: cash_drawer_id
      type: string

  card_details:
    - name: card_type
      type: enum
      values:
        - visa
        - mastercard
        - amex
        - discover
        - diners
        - jcb
        - unionpay
        - other

    - name: card_token
      type: string
      description: Tokenized card number (PCI compliant)

    - name: card_last_four
      type: string
      max_length: 4

    - name: card_expiry
      type: string
      format: MM/YY

    - name: cardholder_name
      type: string

    - name: card_entry_mode
      type: enum
      values:
        - chip
        - swipe
        - manual
        - contactless
        - token
        - recurring

    - name: authorization_code
      type: string

    - name: authorization_amount
      type: decimal

    - name: reference_number
      type: string
      description: Merchant reference

    - name: transaction_id
      type: string
      description: Gateway transaction ID

    - name: batch_number
      type: string
      description: Settlement batch

    - name: terminal_id
      type: string

  bank_transfer_details:
    - name: bank_name
      type: string

    - name: bank_reference
      type: string

    - name: transfer_date
      type: date

    - name: account_number_last_four
      type: string

  check_details:
    - name: check_number
      type: string

    - name: bank_name
      type: string

    - name: bank_routing
      type: string

    - name: check_date
      type: date

  voucher_details:
    - name: voucher_number
      type: string

    - name: voucher_type
      type: enum
      values:
        - gift_certificate
        - travel_agent_voucher
        - corporate_voucher
        - promotional
        - compensation

    - name: voucher_issuer
      type: string

    - name: voucher_amount
      type: decimal

    - name: voucher_balance
      type: decimal
      description: Remaining balance if partial use

  loyalty_details:
    - name: loyalty_member_id
      type: string

    - name: points_redeemed
      type: integer

    - name: points_value
      type: decimal
      description: Monetary value of points

    - name: program_name
      type: string

  deposit:
    - name: is_deposit
      type: boolean
      default: false

    - name: deposit_type
      type: enum
      values:
        - advance
        - guarantee
        - incidentals
        - damage

    - name: deposit_due_date
      type: date

    - name: deposit_forfeited
      type: boolean
      default: false

    - name: forfeit_reason
      type: string

  refund:
    - name: is_refund
      type: boolean
      default: false

    - name: refund_reason
      type: string

    - name: original_payment_id
      type: string
      description: Payment being refunded

    - name: refund_method
      type: enum
      values:
        - same_as_original
        - cash
        - credit_card
        - bank_transfer

  direct_bill:
    - name: company_id
      type: string
      description: For company billing

    - name: ar_account
      type: string
      description: AR account number

    - name: invoice_number
      type: string

    - name: po_number
      type: string
      description: Purchase order

  travel_agent:
    - name: agent_id
      type: string

    - name: agent_voucher_number
      type: string

    - name: commission_amount
      type: decimal

    - name: commission_paid
      type: boolean
      default: false

  status:
    - name: status
      type: enum
      values:
        - pending
        - approved
        - declined
        - settled
        - refunded
        - voided
        - chargeback
      required: true
      default: pending

    - name: settlement_date
      type: date

    - name: settlement_batch
      type: string

    - name: decline_reason
      type: string

    - name: void_reason
      type: string

    - name: voided_by
      type: string

    - name: voided_at
      type: timestamp

  chargeback:
    - name: is_chargeback
      type: boolean
      default: false

    - name: chargeback_date
      type: date

    - name: chargeback_reason
      type: string

    - name: chargeback_status
      type: enum
      values:
        - received
        - disputed
        - won
        - lost

  reconciliation:
    - name: is_reconciled
      type: boolean
      default: false

    - name: reconciled_date
      type: date

    - name: reconciled_by
      type: string

    - name: bank_statement_reference
      type: string

  audit:
    - name: created_at
      type: timestamp
      auto: true

    - name: created_by
      type: string
      required: true

    - name: updated_at
      type: timestamp
      auto: true

    - name: cashier_id
      type: string

    - name: shift_id
      type: string

    - name: workstation_id
      type: string

relationships:
  - entity: folio
    type: many_to_one
    required: true

  - entity: property
    type: many_to_one
    required: true

  - entity: reservation
    type: many_to_one

indexes:
  - fields: [property_id, receipt_number]
    unique: true
  - fields: [folio_id, payment_date]
  - fields: [property_id, payment_date, payment_type]
  - fields: [transaction_id]
  - fields: [authorization_code]
  - fields: [settlement_batch]

business_rules:
  - rule: BR-PAY-001
    description: Receipt number must be unique within property
  - rule: BR-PAY-002
    description: Card payment requires valid authorization
  - rule: BR-PAY-003
    description: Refund cannot exceed original payment
  - rule: BR-PAY-004
    description: Void requires manager approval if > threshold
  - rule: BR-PAY-005
    description: Settlement batch must balance daily

pci_dss:
  compliant_storage:
    - card_token
    - card_last_four
    - cardholder_name
  prohibited_storage:
    - full_card_number
    - cvv
    - pin
    - magnetic_stripe_data
  encryption_required:
    - card_token
  transmission:
    - tls_1_2_minimum
    - point_to_point_encryption

settlement_process:
  credit_cards:
    - batch_close_time: "23:00"
    - settlement_days: 1-2
    - reconciliation: daily
  bank_transfers:
    - verification: required
    - reconciliation: upon_receipt
  cash:
    - drawer_count: shift_end
    - deposit: daily
