name: charge
display_name: Charge
display_name_vi: Khoản phí
version: "1.0"
domain: travel-hospitality
subdomain: hotel

description: |
  Charge entity representing individual transactions posted to a guest folio.
  Includes room charges, F&B, services, adjustments, and tax postings.

description_vi: |
  Thực thể khoản phí đại diện cho các giao dịch riêng lẻ được ghi vào
  hóa đơn khách. Bao gồm phí phòng, F&B, dịch vụ, điều chỉnh và thuế.

attributes:
  identity:
    - name: charge_id
      type: string
      format: "CHG-{property_code}-{YYYYMMDD}-{sequence}"
      required: true
      description: Unique charge identifier

    - name: transaction_number
      type: string
      max_length: 20
      required: true
      description: Display transaction number

    - name: property_id
      type: string
      required: true

    - name: folio_id
      type: string
      required: true
      description: Parent folio

    - name: reservation_id
      type: string
      description: Associated reservation

  posting_info:
    - name: posting_date
      type: date
      required: true
      description: Business date of posting

    - name: posting_time
      type: timestamp
      required: true
      description: Actual posting timestamp

    - name: transaction_date
      type: date
      required: true
      description: Date of actual transaction

    - name: room_number
      type: string
      description: Room associated with charge

    - name: guest_id
      type: string
      description: Guest who incurred charge

    - name: guest_name
      type: string

  charge_details:
    - name: charge_code
      type: string
      max_length: 20
      required: true
      description: Transaction code

    - name: charge_category
      type: enum
      values:
        - room_revenue
        - food_beverage
        - spa_wellness
        - telephone
        - laundry
        - minibar
        - parking
        - internet
        - business_center
        - gift_shop
        - recreation
        - transportation
        - miscellaneous
        - tax
        - service_charge
        - adjustment
        - package
        - deposit
      required: true

    - name: charge_type
      type: enum
      values:
        - debit
        - credit
      required: true

    - name: description
      type: string
      max_length: 200
      required: true
      description: Charge description

    - name: reference
      type: string
      description: External reference (check number, POS ticket)

    - name: supplement_info
      type: text
      description: Additional details

  amounts:
    - name: quantity
      type: decimal
      default: 1

    - name: unit_price
      type: decimal
      required: true

    - name: gross_amount
      type: decimal
      required: true
      description: quantity × unit_price

    - name: discount_amount
      type: decimal
      default: 0

    - name: discount_reason
      type: string

    - name: net_amount
      type: decimal
      required: true
      description: gross - discount

    - name: tax_amount
      type: decimal
      default: 0

    - name: service_charge_amount
      type: decimal
      default: 0

    - name: total_amount
      type: decimal
      required: true
      description: net + tax + service charge

    - name: currency_code
      type: string
      format: ISO 4217
      required: true

    - name: exchange_rate
      type: decimal
      default: 1.0

    - name: base_currency_amount
      type: decimal
      description: Amount in property currency

  tax_details:
    - name: tax_breakdown
      type: array
      items:
        type: object
        properties:
          tax_code: string
          tax_name: string
          tax_rate: decimal
          taxable_amount: decimal
          tax_amount: decimal

    - name: is_taxable
      type: boolean
      default: true

    - name: tax_exempt_reason
      type: string

  source:
    - name: source_system
      type: enum
      values:
        - pms
        - pos
        - spa
        - telephone
        - interface
        - minibar
        - internet
        - manual
      required: true

    - name: source_outlet
      type: string
      description: Outlet/department code

    - name: source_outlet_name
      type: string

    - name: source_check_number
      type: string
      description: POS check/ticket number

    - name: source_covers
      type: integer
      description: Number of covers (F&B)

    - name: source_table_number
      type: string

    - name: source_server
      type: string
      description: Server/cashier name

  room_charge_specific:
    - name: rate_code
      type: string
      description: For room charges

    - name: rate_plan_id
      type: string

    - name: package_code
      type: string

    - name: is_package_element
      type: boolean
      default: false

    - name: package_breakdown
      type: object
      properties:
        room: decimal
        breakfast: decimal
        dinner: decimal
        other: decimal

  adjustment_specific:
    - name: adjustment_reason_code
      type: string

    - name: adjustment_reason
      type: string

    - name: original_charge_id
      type: string
      description: If adjusting another charge

    - name: manager_approval
      type: string

    - name: allowance_type
      type: enum
      values:
        - goodwill
        - service_recovery
        - correction
        - complimentary
        - dispute_resolution

  routing:
    - name: routed_from_folio
      type: string
      description: Original folio if routed

    - name: routed_to_folio
      type: string
      description: Target folio if routed

    - name: is_auto_routed
      type: boolean
      default: false

    - name: routing_instruction_id
      type: string

  status:
    - name: status
      type: enum
      values:
        - posted
        - reversed
        - adjusted
        - voided
        - transferred
      required: true
      default: posted

    - name: reversal_id
      type: string
      description: Linked reversal charge

    - name: reversed_by_id
      type: string
      description: Charge that reversed this

    - name: void_reason
      type: string

    - name: voided_by
      type: string

    - name: voided_at
      type: timestamp

  night_audit:
    - name: night_audit_date
      type: date
      description: NA date when posted

    - name: is_audited
      type: boolean
      default: false

    - name: audited_at
      type: timestamp

  revenue:
    - name: revenue_center
      type: string
      description: Revenue center code

    - name: department_code
      type: string

    - name: gl_account
      type: string
      description: General ledger account

    - name: cost_center
      type: string

  audit:
    - name: created_at
      type: timestamp
      auto: true

    - name: created_by
      type: string
      required: true

    - name: updated_at
      type: timestamp
      auto: true

    - name: updated_by
      type: string

    - name: terminal_id
      type: string
      description: POS terminal/workstation

    - name: cashier_id
      type: string

relationships:
  - entity: folio
    type: many_to_one
    required: true

  - entity: property
    type: many_to_one
    required: true

  - entity: guest
    type: many_to_one

  - entity: reservation
    type: many_to_one

indexes:
  - fields: [property_id, transaction_number]
    unique: true
  - fields: [folio_id, posting_date]
  - fields: [property_id, posting_date, charge_category]
  - fields: [property_id, source_system, source_check_number]
  - fields: [reservation_id]
  - fields: [night_audit_date, is_audited]

business_rules:
  - rule: BR-CHG-001
    description: Transaction number must be unique within property
  - rule: BR-CHG-002
    description: Cannot post to closed folio
  - rule: BR-CHG-003
    description: Adjustment requires original charge reference
  - rule: BR-CHG-004
    description: Void requires manager approval if > threshold
  - rule: BR-CHG-005
    description: Post-audit adjustments require NA reversal
  - rule: BR-CHG-006
    description: Credit charges must have valid reason code

revenue_mapping:
  room_revenue: "4100"
  food_beverage: "4200"
  spa_wellness: "4300"
  telephone: "4400"
  laundry: "4500"
  minibar: "4600"
  parking: "4700"
  miscellaneous: "4900"
