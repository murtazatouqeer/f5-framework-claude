name: maintenance
display_name: Maintenance Request
display_name_vi: Yêu cầu bảo trì
version: "1.0"
domain: travel-hospitality
subdomain: hotel

description: |
  Maintenance request entity for tracking repairs, preventive maintenance,
  and facility issues. Manages work orders from creation to completion.

description_vi: |
  Thực thể yêu cầu bảo trì để theo dõi sửa chữa, bảo trì phòng ngừa
  và các vấn đề cơ sở vật chất. Quản lý đơn công việc từ tạo đến hoàn thành.

attributes:
  identity:
    - name: request_id
      type: string
      format: "MNT-{property_code}-{YYYYMMDD}-{sequence}"
      required: true
      description: Unique maintenance request ID

    - name: work_order_number
      type: string
      max_length: 20
      required: true
      description: Display work order number

    - name: property_id
      type: string
      required: true

  location:
    - name: location_type
      type: enum
      values:
        - guest_room
        - public_area
        - back_of_house
        - exterior
        - equipment
        - hvac
        - pool
        - kitchen
        - laundry
      required: true

    - name: room_id
      type: string
      description: If guest room

    - name: room_number
      type: string

    - name: area_description
      type: string
      required: true
      description: Specific location description

    - name: floor
      type: integer

    - name: building
      type: string

  request_details:
    - name: category
      type: enum
      values:
        - plumbing
        - electrical
        - hvac
        - furniture
        - appliances
        - locks_security
        - painting
        - flooring
        - windows_doors
        - pest_control
        - fire_safety
        - elevator
        - pool_spa
        - landscaping
        - general
      required: true

    - name: subcategory
      type: string
      description: Specific issue type

    - name: description
      type: text
      required: true
      description: Problem description

    - name: request_type
      type: enum
      values:
        - corrective
        - preventive
        - emergency
        - improvement
        - inspection
      required: true

    - name: priority
      type: enum
      values:
        - emergency
        - urgent
        - high
        - normal
        - low
      required: true
      default: normal

    - name: severity
      type: enum
      values:
        - critical
        - major
        - minor
        - cosmetic
      required: true

  guest_impact:
    - name: affects_guest_stay
      type: boolean
      default: false

    - name: room_sellable
      type: boolean
      default: true
      description: Can room be sold while issue exists

    - name: guest_notified
      type: boolean
      default: false

    - name: guest_relocated
      type: boolean
      default: false

    - name: relocation_room
      type: string

    - name: compensation_offered
      type: text

  source:
    - name: reported_by
      type: string
      required: true
      description: Who reported issue

    - name: reporter_type
      type: enum
      values:
        - guest
        - housekeeping
        - front_desk
        - engineering
        - management
        - inspection
        - preventive_schedule
      required: true

    - name: reported_at
      type: timestamp
      required: true

    - name: discovered_during
      type: enum
      values:
        - guest_complaint
        - room_cleaning
        - inspection
        - routine_check
        - pm_schedule

  media:
    - name: photos
      type: array
      items:
        type: object
        properties:
          url: string
          caption: string
          taken_at: timestamp
          photo_type: enum [before, during, after]

    - name: documents
      type: array
      items:
        type: object
        properties:
          url: string
          document_type: string
          description: string

  assignment:
    - name: assigned_technician_id
      type: string

    - name: assigned_technician_name
      type: string

    - name: assigned_team
      type: string

    - name: assigned_at
      type: timestamp

    - name: assigned_by
      type: string

    - name: external_vendor
      type: boolean
      default: false

    - name: vendor_name
      type: string

    - name: vendor_contact
      type: string

    - name: vendor_reference
      type: string

  scheduling:
    - name: scheduled_date
      type: date

    - name: scheduled_time
      type: time

    - name: estimated_duration
      type: integer
      description: Minutes

    - name: deadline
      type: timestamp
      description: Must complete by

    - name: requires_room_vacant
      type: boolean
      default: false

    - name: guest_preferred_time
      type: string

  execution:
    - name: started_at
      type: timestamp

    - name: completed_at
      type: timestamp

    - name: actual_duration
      type: integer
      description: Minutes

    - name: work_performed
      type: text
      description: Description of work done

    - name: root_cause
      type: text

    - name: resolution_notes
      type: text

    - name: requires_follow_up
      type: boolean
      default: false

    - name: follow_up_notes
      type: text

  parts_and_costs:
    - name: parts_used
      type: array
      items:
        type: object
        properties:
          part_code: string
          part_name: string
          quantity: decimal
          unit_cost: decimal
          total_cost: decimal

    - name: parts_total
      type: decimal
      computed: true

    - name: labor_hours
      type: decimal

    - name: labor_rate
      type: decimal

    - name: labor_cost
      type: decimal
      computed: true

    - name: vendor_cost
      type: decimal

    - name: total_cost
      type: decimal
      computed: true

    - name: billable_to_guest
      type: boolean
      default: false

    - name: billed_amount
      type: decimal

  status:
    - name: status
      type: enum
      values:
        - open
        - assigned
        - in_progress
        - on_hold
        - pending_parts
        - pending_vendor
        - completed
        - verified
        - closed
        - cancelled
      required: true
      default: open

    - name: hold_reason
      type: string

    - name: cancellation_reason
      type: string

  room_status:
    - name: room_out_of_order
      type: boolean
      default: false

    - name: ooo_start_date
      type: date

    - name: ooo_end_date
      type: date

    - name: ooo_reason
      type: string

  verification:
    - name: verified_by
      type: string

    - name: verified_at
      type: timestamp

    - name: verification_notes
      type: text

    - name: quality_rating
      type: integer
      min: 1
      max: 5

  preventive:
    - name: is_preventive
      type: boolean
      default: false

    - name: pm_schedule_id
      type: string

    - name: equipment_id
      type: string

    - name: last_pm_date
      type: date

    - name: next_pm_date
      type: date

  audit:
    - name: created_at
      type: timestamp
      auto: true

    - name: updated_at
      type: timestamp
      auto: true

    - name: created_by
      type: string

    - name: closed_at
      type: timestamp

    - name: closed_by
      type: string

relationships:
  - entity: property
    type: many_to_one
    required: true

  - entity: room
    type: many_to_one
    description: If room-related

  - entity: housekeeping
    type: many_to_one
    description: If discovered during cleaning

indexes:
  - fields: [property_id, work_order_number]
    unique: true
  - fields: [property_id, status, priority]
  - fields: [room_number, status]
  - fields: [assigned_technician_id, status]
  - fields: [scheduled_date]
  - fields: [category, status]

state_machine:
  name: maintenance_status
  states:
    - open
    - assigned
    - in_progress
    - on_hold
    - pending_parts
    - pending_vendor
    - completed
    - verified
    - closed
    - cancelled

  transitions:
    - from: open
      to: assigned
      trigger: technician_assigned

    - from: assigned
      to: in_progress
      trigger: work_started

    - from: in_progress
      to: completed
      trigger: work_finished

    - from: in_progress
      to: pending_parts
      trigger: parts_needed

    - from: in_progress
      to: pending_vendor
      trigger: vendor_required

    - from: [pending_parts, pending_vendor]
      to: in_progress
      trigger: ready_to_resume

    - from: [assigned, in_progress]
      to: on_hold
      trigger: work_paused

    - from: on_hold
      to: in_progress
      trigger: work_resumed

    - from: completed
      to: verified
      trigger: verification_passed

    - from: verified
      to: closed
      trigger: request_closed

    - from: [open, assigned]
      to: cancelled
      trigger: request_cancelled

business_rules:
  - rule: BR-MNT-001
    description: Emergency requests require immediate assignment
  - rule: BR-MNT-002
    description: OOO rooms cannot be sold until issue resolved
  - rule: BR-MNT-003
    description: Guest-affecting issues require 24hr resolution
  - rule: BR-MNT-004
    description: PM tasks auto-generate based on schedule
  - rule: BR-MNT-005
    description: Completed work requires supervisor verification

sla_targets:
  emergency:
    response_time: 15_minutes
    resolution_time: 2_hours
  urgent:
    response_time: 1_hour
    resolution_time: 4_hours
  high:
    response_time: 4_hours
    resolution_time: 24_hours
  normal:
    response_time: 24_hours
    resolution_time: 72_hours
  low:
    response_time: 48_hours
    resolution_time: 7_days
