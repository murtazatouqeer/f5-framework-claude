name: TourReview
display_name: Tour Review / Đánh giá tour
description: |
  Customer review and rating for a tour, activity, or experience.
  Includes detailed ratings, photos, and guide feedback.

domain: travel-hospitality
subdomain: tour
category: supporting

attributes:
  - name: id
    type: uuid
    required: true

  - name: booking_id
    type: uuid
    required: true

  - name: tour_id
    type: uuid
    required: false

  - name: activity_id
    type: uuid
    required: false

  - name: experience_id
    type: uuid
    required: false

  - name: customer_id
    type: uuid
    required: true

  - name: guide_id
    type: uuid
    required: false

  - name: status
    type: enum
    required: true
    validation:
      values: [pending, approved, rejected, hidden]
    default: pending

  # Ratings
  - name: overall_rating
    type: integer
    required: true
    validation:
      min: 1
      max: 5

  - name: guide_rating
    type: integer
    required: false
    validation:
      min: 1
      max: 5

  - name: value_rating
    type: integer
    required: false
    validation:
      min: 1
      max: 5
    description: Value for money

  - name: organization_rating
    type: integer
    required: false
    validation:
      min: 1
      max: 5
    description: Organization and punctuality

  - name: safety_rating
    type: integer
    required: false
    validation:
      min: 1
      max: 5
    description: Safety measures

  # Content
  - name: title
    type: string
    required: false
    validation:
      max_length: 150

  - name: review_text
    type: text
    required: true
    validation:
      min_length: 50
      max_length: 5000

  - name: highlights
    type: array
    required: false
    description: What the reviewer loved

  - name: improvements
    type: array
    required: false
    description: Suggestions for improvement

  - name: language
    type: string
    required: true

  # Media
  - name: photos
    type: array
    required: false
    validation:
      max_items: 10
    items:
      type: object
      properties:
        url: string
        caption: string

  - name: videos
    type: array
    required: false
    validation:
      max_items: 3

  # Context
  - name: travel_date
    type: date
    required: true

  - name: traveler_type
    type: enum
    required: true
    validation:
      values: [solo, couple, family, friends, business]

  - name: group_size
    type: integer
    required: false

  - name: would_recommend
    type: boolean
    required: true

  # Verification
  - name: verified_booking
    type: boolean
    required: true
    default: true

  - name: verified_badge
    type: boolean
    required: true
    default: false
    description: Verified purchase badge shown

  # Response
  - name: operator_response
    type: text
    required: false

  - name: operator_response_at
    type: timestamp
    required: false

  - name: operator_response_by
    type: uuid
    required: false

  # Moderation
  - name: moderation_status
    type: enum
    required: true
    validation:
      values: [pending, approved, rejected, flagged]
    default: pending

  - name: moderation_notes
    type: text
    required: false

  - name: moderated_by
    type: uuid
    required: false

  - name: moderated_at
    type: timestamp
    required: false

  - name: rejection_reason
    type: enum
    required: false
    validation:
      values: [inappropriate_content, spam, fake_review, irrelevant, privacy_violation]

  # Engagement
  - name: helpful_count
    type: integer
    required: true
    default: 0

  - name: not_helpful_count
    type: integer
    required: true
    default: 0

  - name: reported_count
    type: integer
    required: true
    default: 0

  # Display
  - name: featured
    type: boolean
    required: true
    default: false

  - name: display_name
    type: string
    required: true
    description: How to display reviewer name

  - name: display_location
    type: string
    required: false

  # Timestamps
  - name: published_at
    type: timestamp
    required: false

  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: booking
    type: belongs_to
    entity: TourBooking
    required: true

  - name: tour
    type: belongs_to
    entity: Tour
    required: false

  - name: activity
    type: belongs_to
    entity: Activity
    required: false

  - name: experience
    type: belongs_to
    entity: Experience
    required: false

  - name: customer
    type: belongs_to
    entity: Customer
    required: true

  - name: guide
    type: belongs_to
    entity: Guide
    required: false

indexes:
  - [booking_id]
  - [tour_id]
  - [customer_id]
  - [guide_id]
  - [status]
  - [overall_rating]
  - [created_at DESC]
  - [featured]

business_rules:
  - BR-REV-001: One review per booking
  - BR-REV-002: Can only review completed bookings
  - BR-REV-003: Review must be submitted within 30 days of tour
  - BR-REV-004: Minimum 50 characters for review text
  - BR-REV-005: Photos must be from the actual tour
  - BR-REV-006: Operator response within 7 days recommended
  - BR-REV-007: Cannot edit review after operator response
  - BR-REV-008: Rating < 3 triggers alert to operator

events:
  - name: review.submitted
    payload: [id, tour_id, overall_rating]
  - name: review.approved
    payload: [id, tour_id]
  - name: review.rejected
    payload: [id, reason]
  - name: review.response_added
    payload: [id, tour_id]
  - name: review.featured
    payload: [id, tour_id]
