name: TourVoucher
display_name: Tour Voucher / Phiếu xác nhận tour
description: |
  Booking confirmation voucher/ticket that serves as proof of booking.
  Contains all essential information for the tour and QR code for check-in.

domain: travel-hospitality
subdomain: tour
category: supporting

attributes:
  - name: id
    type: uuid
    required: true

  - name: voucher_number
    type: string
    required: true
    validation:
      pattern: "^VCH-[0-9]{8}-[A-Z0-9]{8}$"
    example: "VCH-20241215-ABCD1234"

  - name: booking_id
    type: uuid
    required: true

  - name: status
    type: enum
    required: true
    validation:
      values: [active, used, expired, cancelled, void]
    default: active

  - name: voucher_type
    type: enum
    required: true
    validation:
      values: [e_ticket, mobile_pass, print_required]
    default: e_ticket

  # QR/Barcode
  - name: qr_code
    type: string
    required: true
    description: Encoded QR code data

  - name: qr_code_url
    type: string
    required: true
    description: QR code image URL

  - name: barcode
    type: string
    required: false

  # Tour Details
  - name: tour_name
    type: string
    required: true

  - name: tour_date
    type: date
    required: true

  - name: start_time
    type: time
    required: true

  - name: duration
    type: string
    required: true
    example: "8 hours"

  - name: language
    type: string
    required: true

  # Meeting Point
  - name: meeting_point_name
    type: string
    required: true

  - name: meeting_point_address
    type: string
    required: true

  - name: meeting_point_coordinates
    type: object
    required: true
    properties:
      latitude: decimal
      longitude: decimal

  - name: meeting_point_instructions
    type: text
    required: true

  - name: meeting_point_map_url
    type: string
    required: false

  # Pickup (if applicable)
  - name: pickup_included
    type: boolean
    required: true
    default: false

  - name: pickup_location
    type: string
    required: false

  - name: pickup_time
    type: time
    required: false

  - name: pickup_instructions
    type: text
    required: false

  # Participants
  - name: total_participants
    type: integer
    required: true

  - name: lead_participant_name
    type: string
    required: true

  - name: participant_names
    type: array
    required: false

  # Supplier/Guide
  - name: supplier_name
    type: string
    required: true

  - name: supplier_phone
    type: string
    required: true

  - name: supplier_email
    type: string
    required: true

  - name: guide_name
    type: string
    required: false
    description: If assigned

  - name: guide_phone
    type: string
    required: false

  # Emergency
  - name: emergency_phone
    type: string
    required: true

  # Inclusions
  - name: inclusions
    type: array
    required: true

  - name: exclusions
    type: array
    required: false

  - name: what_to_bring
    type: array
    required: false

  # Terms
  - name: cancellation_policy_summary
    type: text
    required: true

  - name: important_notes
    type: array
    required: false

  # PDF
  - name: pdf_url
    type: string
    required: true

  - name: pdf_generated_at
    type: timestamp
    required: true

  - name: pdf_version
    type: integer
    required: true
    default: 1

  # Usage
  - name: scanned_count
    type: integer
    required: true
    default: 0

  - name: last_scanned_at
    type: timestamp
    required: false

  - name: checked_in_by
    type: uuid
    required: false

  # Delivery
  - name: sent_to_email
    type: string
    required: true

  - name: sent_at
    type: timestamp
    required: false

  - name: delivery_status
    type: enum
    required: true
    validation:
      values: [pending, sent, delivered, failed, resent]
    default: pending

  - name: resend_count
    type: integer
    required: true
    default: 0

  - name: downloaded
    type: boolean
    required: true
    default: false

  - name: downloaded_at
    type: timestamp
    required: false

  # Validity
  - name: valid_from
    type: timestamp
    required: true

  - name: valid_until
    type: timestamp
    required: true

  # Timestamps
  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: booking
    type: belongs_to
    entity: TourBooking
    required: true

indexes:
  - [voucher_number]
  - [booking_id]
  - [status]
  - [tour_date]
  - [qr_code]

business_rules:
  - BR-VCH-001: Generated only after payment confirmed
  - BR-VCH-002: QR code must be unique and secure
  - BR-VCH-003: Valid only for specified date and time
  - BR-VCH-004: Expired 24 hours after tour end time
  - BR-VCH-005: Can be scanned max 2 times (entry + verify)
  - BR-VCH-006: Auto-void if booking cancelled
  - BR-VCH-007: Resend limited to 5 times

events:
  - name: voucher.generated
    payload: [id, voucher_number, booking_id]
  - name: voucher.sent
    payload: [id, sent_to_email]
  - name: voucher.scanned
    payload: [id, scanned_by, location]
  - name: voucher.expired
    payload: [id]
  - name: voucher.voided
    payload: [id, reason]
