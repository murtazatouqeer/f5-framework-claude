name: TourBooking
display_name: Tour Booking / Đặt tour
description: |
  Booking record for tours, activities, or experiences.
  Tracks participant details, payment status, and booking lifecycle.

domain: travel-hospitality
subdomain: tour
category: core

attributes:
  - name: id
    type: uuid
    required: true

  - name: booking_reference
    type: string
    required: true
    validation:
      pattern: "^TBK-[0-9]{8}-[A-Z0-9]{6}$"
    example: "TBK-20241215-ABC123"

  - name: tour_id
    type: uuid
    required: false
    description: Set if booking a tour

  - name: activity_id
    type: uuid
    required: false
    description: Set if booking an activity

  - name: experience_id
    type: uuid
    required: false
    description: Set if booking an experience

  - name: schedule_id
    type: uuid
    required: true

  - name: status
    type: enum
    required: true
    validation:
      values: [pending, confirmed, paid, cancelled, completed, no_show, refunded, disputed]
    default: pending

  - name: booking_type
    type: enum
    required: true
    validation:
      values: [instant, request, private, group]
    default: instant

  # Customer
  - name: customer_id
    type: uuid
    required: true

  - name: lead_participant
    type: object
    required: true
    properties:
      name: string
      email: string
      phone: string
      country_code: string

  - name: booked_by
    type: enum
    required: true
    validation:
      values: [customer, agent, operator, admin]
    default: customer

  - name: agent_id
    type: uuid
    required: false

  # Participants
  - name: adults
    type: integer
    required: true
    default: 1

  - name: children
    type: integer
    required: true
    default: 0

  - name: infants
    type: integer
    required: true
    default: 0

  - name: total_participants
    type: integer
    required: true
    computed: true

  - name: participants
    type: array
    required: false
    items:
      type: object
      properties:
        name: string
        age: integer
        participant_type: enum[adult, child, infant]
        special_requirements: string
        dietary_requirements: array
        emergency_contact: object

  # Schedule Details
  - name: tour_date
    type: date
    required: true

  - name: start_time
    type: time
    required: true

  - name: pickup_required
    type: boolean
    required: true
    default: false

  - name: pickup_point_id
    type: uuid
    required: false

  - name: pickup_time
    type: time
    required: false

  - name: pickup_address
    type: string
    required: false
    description: Custom pickup address

  - name: language_preference
    type: string
    required: true
    default: "en"

  # Pricing
  - name: unit_price_adult
    type: decimal
    required: true

  - name: unit_price_child
    type: decimal
    required: false

  - name: unit_price_infant
    type: decimal
    required: false
    default: 0

  - name: subtotal
    type: decimal
    required: true

  - name: addons_total
    type: decimal
    required: true
    default: 0

  - name: pickup_fee
    type: decimal
    required: true
    default: 0

  - name: discount_amount
    type: decimal
    required: true
    default: 0

  - name: discount_code
    type: string
    required: false

  - name: discount_type
    type: enum
    required: false
    validation:
      values: [promo_code, loyalty, early_bird, last_minute, group]

  - name: taxes
    type: decimal
    required: true
    default: 0

  - name: service_fee
    type: decimal
    required: true
    default: 0

  - name: total_amount
    type: decimal
    required: true

  - name: currency
    type: string
    required: true

  # Payment
  - name: payment_status
    type: enum
    required: true
    validation:
      values: [pending, partial, paid, refunded, failed]
    default: pending

  - name: payment_method
    type: enum
    required: false
    validation:
      values: [credit_card, debit_card, paypal, bank_transfer, e_wallet, pay_later, cash]

  - name: paid_amount
    type: decimal
    required: true
    default: 0

  - name: deposit_required
    type: boolean
    required: true
    default: false

  - name: deposit_amount
    type: decimal
    required: false

  - name: deposit_paid_at
    type: timestamp
    required: false

  - name: balance_due_date
    type: date
    required: false

  - name: payment_transaction_id
    type: string
    required: false

  # Voucher
  - name: voucher_id
    type: uuid
    required: false

  - name: voucher_sent
    type: boolean
    required: true
    default: false

  - name: voucher_sent_at
    type: timestamp
    required: false

  - name: voucher_downloaded
    type: boolean
    required: true
    default: false

  # Addons
  - name: addons
    type: array
    required: false
    items:
      type: object
      properties:
        addon_id: uuid
        addon_name: string
        quantity: integer
        unit_price: decimal
        total_price: decimal

  # Special Requests
  - name: special_requests
    type: text
    required: false

  - name: dietary_requirements
    type: array
    required: false
    validation:
      values: [vegetarian, vegan, halal, kosher, gluten_free, dairy_free, nut_allergy, other]

  - name: accessibility_requirements
    type: array
    required: false

  - name: celebration
    type: object
    required: false
    properties:
      type: enum[birthday, anniversary, honeymoon, other]
      details: string

  # Cancellation
  - name: cancellation_policy_id
    type: uuid
    required: true

  - name: cancelled_at
    type: timestamp
    required: false

  - name: cancelled_by
    type: enum
    required: false
    validation:
      values: [customer, operator, system, weather, admin]

  - name: cancellation_reason
    type: text
    required: false

  - name: refund_amount
    type: decimal
    required: false

  - name: refund_status
    type: enum
    required: false
    validation:
      values: [pending, processing, completed, failed]

  # Confirmation
  - name: confirmation_sent
    type: boolean
    required: true
    default: false

  - name: reminder_sent
    type: boolean
    required: true
    default: false

  - name: reminder_sent_at
    type: timestamp
    required: false

  # Completion
  - name: checked_in
    type: boolean
    required: true
    default: false

  - name: checked_in_at
    type: timestamp
    required: false

  - name: actual_participants
    type: integer
    required: false

  - name: no_show_reason
    type: text
    required: false

  # Attribution
  - name: source
    type: enum
    required: true
    validation:
      values: [website, mobile_app, api, agent, call_center, walk_in]
    default: website

  - name: utm_source
    type: string
    required: false

  - name: utm_medium
    type: string
    required: false

  - name: utm_campaign
    type: string
    required: false

  - name: affiliate_id
    type: uuid
    required: false

  # Internal
  - name: internal_notes
    type: text
    required: false

  - name: operator_notes
    type: text
    required: false

  # Timestamps
  - name: confirmed_at
    type: timestamp
    required: false

  - name: paid_at
    type: timestamp
    required: false

  - name: completed_at
    type: timestamp
    required: false

  - name: created_at
    type: timestamp
    required: true

  - name: updated_at
    type: timestamp
    required: true

relationships:
  - name: customer
    type: belongs_to
    entity: Customer
    required: true

  - name: tour
    type: belongs_to
    entity: Tour
    required: false

  - name: activity
    type: belongs_to
    entity: Activity
    required: false

  - name: experience
    type: belongs_to
    entity: Experience
    required: false

  - name: schedule
    type: belongs_to
    entity: TourSchedule
    required: true

  - name: voucher
    type: has_one
    entity: TourVoucher

  - name: participants
    type: has_many
    entity: Participant

  - name: pickup_point
    type: belongs_to
    entity: PickupPoint
    required: false

  - name: payments
    type: has_many
    entity: Payment

  - name: review
    type: has_one
    entity: TourReview

state_machine:
  initial: pending
  states:
    - name: pending
      description: Booking created, awaiting confirmation
    - name: confirmed
      description: Booking confirmed by operator
    - name: paid
      description: Payment completed
    - name: cancelled
      description: Booking cancelled
    - name: completed
      description: Tour completed
    - name: no_show
      description: Customer did not show up
    - name: refunded
      description: Refund processed
    - name: disputed
      description: Dispute raised
  transitions:
    - from: pending
      to: confirmed
      trigger: confirm
      actions: [send_confirmation, reserve_spots]
    - from: [pending, confirmed]
      to: paid
      trigger: pay
      actions: [generate_voucher, send_voucher]
    - from: [pending, confirmed, paid]
      to: cancelled
      trigger: cancel
      actions: [release_spots, calculate_refund, process_refund]
    - from: paid
      to: completed
      trigger: complete
      actions: [request_review]
    - from: paid
      to: no_show
      trigger: mark_no_show
    - from: cancelled
      to: refunded
      trigger: refund
    - from: completed
      to: disputed
      trigger: dispute

indexes:
  - [booking_reference]
  - [customer_id]
  - [tour_id]
  - [schedule_id]
  - [status]
  - [tour_date]
  - [payment_status]
  - [created_at DESC]

business_rules:
  - BR-BKG-001: total_participants <= schedule.available_spots
  - BR-BKG-002: Booking must be made before cutoff_datetime
  - BR-BKG-003: Children require at least one adult
  - BR-BKG-004: Voucher sent only after payment confirmed
  - BR-BKG-005: Reminder sent 24h before tour_date
  - BR-BKG-006: Review request sent 24h after completion
  - BR-BKG-007: No-show results in no refund
  - BR-BKG-008: Dispute must be raised within 7 days of tour_date

events:
  - name: booking.created
    payload: [id, booking_reference, tour_id, customer_id]
  - name: booking.confirmed
    payload: [id]
  - name: booking.paid
    payload: [id, payment_transaction_id]
  - name: booking.cancelled
    payload: [id, cancelled_by, refund_amount]
  - name: booking.completed
    payload: [id, actual_participants]
  - name: booking.no_show
    payload: [id]
  - name: booking.voucher_sent
    payload: [id, voucher_id]
