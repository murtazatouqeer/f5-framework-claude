name: package
display_name: Travel Package
display_name_vi: Gói du lịch
version: "1.0"
domain: travel-hospitality
subdomain: booking

description: |
  Bundled travel package combining flights, hotels, and
  other services at package pricing.

attributes:
  # Identification
  - name: id
    type: uuid
    primary_key: true

  - name: booking_id
    type: uuid
    foreign_key: booking.id
    required: true

  - name: package_code
    type: string
    nullable: true
    description: Pre-built package code if applicable

  # Package Type
  - name: package_type
    type: enum
    values: [dynamic, pre_built, charter, tour]
    default: dynamic
    description: |
      dynamic: Built from components
      pre_built: Fixed package from supplier
      charter: Charter flight + hotel
      tour: Guided tour package

  - name: package_name
    type: string
    description: Display name for package

  - name: package_description
    type: text
    nullable: true

  # Status
  - name: status
    type: enum
    values: [pending, confirmed, cancelled, completed]
    default: pending

  # Components
  - name: flight_id
    type: uuid
    foreign_key: flight.id
    nullable: true

  - name: hotel_reservation_ids
    type: array
    items:
      type: uuid
      foreign_key: hotel_reservation.id

  - name: transfer_ids
    type: array
    nullable: true

  - name: activity_ids
    type: array
    nullable: true

  - name: car_rental_id
    type: uuid
    nullable: true

  - name: insurance_id
    type: uuid
    nullable: true

  # Component Details (denormalized for package display)
  - name: components
    type: array
    items:
      type: object
      properties:
        type:
          type: enum
          values: [flight, hotel, transfer, activity, car, insurance]
        description:
          type: string
        included:
          type: boolean
        optional:
          type: boolean
        price:
          type: decimal

  # Trip Details
  - name: destination_city
    type: string
    required: true

  - name: destination_country
    type: string

  - name: origin_city
    type: string
    required: true

  - name: departure_date
    type: date
    required: true

  - name: return_date
    type: date
    required: true

  - name: duration_nights
    type: integer

  # Travelers
  - name: adults
    type: integer
    min: 1
    default: 2

  - name: children
    type: integer
    min: 0
    default: 0

  - name: infants
    type: integer
    min: 0
    default: 0

  - name: rooms
    type: integer
    min: 1
    default: 1

  # Pricing
  - name: component_total
    type: decimal
    precision: 12
    scale: 2
    description: Sum of individual components

  - name: package_discount
    type: decimal
    precision: 10
    scale: 2
    default: 0
    description: Bundling discount

  - name: package_price
    type: decimal
    precision: 12
    scale: 2
    description: Final package price

  - name: price_per_person
    type: decimal
    precision: 10
    scale: 2

  - name: taxes_and_fees
    type: decimal
    precision: 10
    scale: 2

  - name: total_amount
    type: decimal
    precision: 12
    scale: 2

  - name: currency
    type: string
    length: 3

  # Price Breakdown
  - name: price_breakdown
    type: object
    properties:
      flight:
        type: decimal
      hotel:
        type: decimal
      transfers:
        type: decimal
      activities:
        type: decimal
      insurance:
        type: decimal
      taxes:
        type: decimal
      discount:
        type: decimal

  # Inclusions
  - name: inclusions
    type: array
    items:
      type: string
    description: What's included in package

  - name: exclusions
    type: array
    items:
      type: string
    description: What's not included

  - name: meal_plan
    type: enum
    values: [room_only, breakfast, half_board, full_board, all_inclusive]
    nullable: true

  # Payment Terms
  - name: deposit_required
    type: boolean
    default: true

  - name: deposit_amount
    type: decimal
    precision: 10
    scale: 2
    nullable: true

  - name: deposit_percentage
    type: integer
    nullable: true
    description: e.g., 30 for 30%

  - name: balance_due_date
    type: date
    nullable: true

  # Cancellation Policy
  - name: cancellation_policy
    type: array
    items:
      type: object
      properties:
        days_before:
          type: integer
        penalty_percentage:
          type: integer
        description:
          type: string

  # Supplier
  - name: supplier_code
    type: string
    nullable: true

  - name: supplier_reference
    type: string
    nullable: true

  - name: supplier_cost
    type: decimal
    precision: 12
    scale: 2
    nullable: true

  # Images
  - name: images
    type: array
    nullable: true
    items:
      type: string

  # Timestamps
  - name: created_at
    type: timestamp
    auto_set: true

  - name: confirmed_at
    type: timestamp
    nullable: true

  - name: updated_at
    type: timestamp
    auto_update: true

validations:
  - rule: return_date > departure_date
    message: Return date must be after departure

  - rule: adults >= 1
    message: At least 1 adult required

  - rule: package_price > 0
    message: Package price must be positive

  - rule: deposit_amount <= total_amount
    message: Deposit cannot exceed total

relationships:
  - name: booking
    type: belongs_to
    entity: booking
    foreign_key: booking_id

  - name: flight
    type: belongs_to
    entity: flight
    foreign_key: flight_id
    optional: true

  - name: hotel_reservations
    type: has_many
    entity: hotel_reservation
    through: package_hotels

indexes:
  - name: idx_package_booking
    columns: [booking_id]

  - name: idx_package_destination
    columns: [destination_city, departure_date]

  - name: idx_package_code
    columns: [package_code]

  - name: idx_package_status
    columns: [status]

computed_fields:
  - name: duration_nights
    formula: DATEDIFF(return_date, departure_date)

  - name: total_travelers
    formula: adults + children + infants

  - name: discount_percentage
    formula: |
      ROUND((package_discount / component_total) * 100, 1)

  - name: price_per_person
    formula: package_price / adults

  - name: is_deposit_due
    formula: |
      status = 'pending' AND deposit_required = true

  - name: is_balance_due
    formula: |
      balance_due_date IS NOT NULL AND balance_due_date <= CURRENT_DATE + 7

business_rules:
  - id: BR-PKG-001
    name: Package Discount
    rule: |
      Dynamic packages receive automatic discount:
      - Flight + Hotel: 5-10% off components
      - Flight + Hotel + Transfer: 10-15%
      - All-inclusive: 15-20%

  - id: BR-PKG-002
    name: Deposit Requirements
    rule: |
      - Standard: 30% deposit at booking
      - Peak season: 50% deposit
      - Within 30 days: Full payment

  - id: BR-PKG-003
    name: Balance Due
    rule: Balance due 14-30 days before departure (per supplier)

  - id: BR-PKG-004
    name: Cancellation Tiers
    rule: |
      Standard tiered cancellation:
      - 30+ days: 20% penalty
      - 15-29 days: 50% penalty
      - 7-14 days: 75% penalty
      - <7 days: 100% penalty

events:
  - name: package.created
    payload:
      - id
      - booking_id
      - package_name
      - total_amount

  - name: package.confirmed
    payload:
      - id
      - booking_id
      - confirmation_numbers

  - name: package.deposit_received
    payload:
      - id
      - deposit_amount
      - balance_due_date

  - name: package.balance_due_reminder
    payload:
      - id
      - booking_id
      - balance_amount
      - due_date
