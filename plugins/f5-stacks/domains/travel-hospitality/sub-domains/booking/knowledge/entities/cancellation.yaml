name: cancellation
display_name: Cancellation
display_name_vi: Hủy đặt chỗ
version: "1.0"
domain: travel-hospitality
subdomain: booking

description: |
  Cancellation record for bookings including reason,
  fees, refund calculations, and processing status.

attributes:
  # Identification
  - name: id
    type: uuid
    primary_key: true

  - name: booking_id
    type: uuid
    foreign_key: booking.id
    required: true
    unique: true

  - name: cancellation_reference
    type: string
    unique: true

  # Type
  - name: cancellation_type
    type: enum
    values: [full, partial, no_show, airline_initiated, force_majeure]
    required: true

  - name: initiated_by
    type: enum
    values: [customer, agent, system, airline, hotel, supplier]
    required: true

  # Status
  - name: status
    type: enum
    values: [requested, processing, completed, failed, disputed]
    default: requested

  # Reason
  - name: reason_code
    type: string
    required: true
    description: Standard reason code

  - name: reason_category
    type: enum
    values: [customer_request, schedule_change, medical, weather, visa, other]

  - name: reason_description
    type: text
    nullable: true

  - name: supporting_documents
    type: array
    nullable: true
    items:
      type: object
      properties:
        type:
          type: string
        file_url:
          type: string
        uploaded_at:
          type: datetime

  # Cancelled Components
  - name: cancelled_components
    type: array
    items:
      type: object
      properties:
        component_type:
          type: enum
          values: [flight, hotel, activity, transfer, car, insurance]
        component_id:
          type: uuid
        reference:
          type: string
        status:
          type: enum
          values: [cancelled, pending, failed]

  - name: flights_cancelled
    type: array
    items:
      type: uuid

  - name: hotels_cancelled
    type: array
    items:
      type: uuid

  - name: other_cancelled
    type: array
    nullable: true

  # Financial Summary
  - name: original_amount
    type: decimal
    precision: 12
    scale: 2
    description: Original booking amount

  - name: currency
    type: string
    length: 3

  # Fees & Penalties
  - name: airline_penalty
    type: decimal
    precision: 10
    scale: 2
    default: 0

  - name: hotel_penalty
    type: decimal
    precision: 10
    scale: 2
    default: 0

  - name: service_fee_forfeited
    type: decimal
    precision: 10
    scale: 2
    default: 0

  - name: admin_fee
    type: decimal
    precision: 10
    scale: 2
    default: 0
    description: OTA cancellation fee

  - name: total_penalties
    type: decimal
    precision: 10
    scale: 2

  # Refund Calculation
  - name: taxes_refundable
    type: decimal
    precision: 10
    scale: 2
    default: 0
    description: Taxes that can be refunded

  - name: amount_paid
    type: decimal
    precision: 12
    scale: 2
    description: Total amount customer paid

  - name: refund_amount
    type: decimal
    precision: 12
    scale: 2
    description: Calculated refund to customer

  - name: refund_breakdown
    type: object
    properties:
      base_refund:
        type: decimal
      tax_refund:
        type: decimal
      fees_retained:
        type: decimal
      penalties:
        type: decimal
      goodwill:
        type: decimal

  # Credit Option
  - name: credit_offered
    type: boolean
    default: false

  - name: credit_amount
    type: decimal
    precision: 12
    scale: 2
    nullable: true

  - name: credit_validity
    type: date
    nullable: true

  - name: customer_choice
    type: enum
    values: [refund, credit, pending]
    nullable: true

  # Refund Processing
  - name: refund_method
    type: enum
    values: [original_payment, bank_transfer, credit, check]
    nullable: true

  - name: refund_status
    type: enum
    values: [pending, processing, completed, failed]
    default: pending

  - name: payment_id
    type: uuid
    nullable: true
    description: Refund payment record

  - name: refund_reference
    type: string
    nullable: true

  - name: refund_processing_days
    type: integer
    nullable: true
    description: Estimated days to process

  # Waiver Information
  - name: penalty_waived
    type: boolean
    default: false

  - name: waiver_reason
    type: string
    nullable: true

  - name: waiver_approved_by
    type: string
    nullable: true

  - name: waiver_amount
    type: decimal
    precision: 10
    scale: 2
    nullable: true

  # Supplier Cancellations
  - name: supplier_cancellations
    type: array
    nullable: true
    items:
      type: object
      properties:
        supplier:
          type: string
        reference:
          type: string
        status:
          type: string
        cancelled_at:
          type: datetime
        refund_status:
          type: string

  # Timeline
  - name: requested_at
    type: timestamp
    auto_set: true

  - name: requested_by
    type: string
    description: User/agent who requested

  - name: approved_at
    type: timestamp
    nullable: true

  - name: approved_by
    type: string
    nullable: true

  - name: processed_at
    type: timestamp
    nullable: true

  - name: completed_at
    type: timestamp
    nullable: true

  - name: refunded_at
    type: timestamp
    nullable: true

  # Communication
  - name: notifications_sent
    type: array
    items:
      type: object
      properties:
        type:
          type: string
        recipient:
          type: string
        sent_at:
          type: datetime
        status:
          type: string

  # Internal
  - name: internal_notes
    type: text
    nullable: true

  - name: updated_at
    type: timestamp
    auto_update: true

validations:
  - rule: refund_amount <= amount_paid
    message: Refund cannot exceed amount paid

  - rule: total_penalties >= 0
    message: Penalties cannot be negative

  - rule: |
      penalty_waived = true IMPLIES waiver_reason IS NOT NULL
    message: Waived penalty requires reason

relationships:
  - name: booking
    type: belongs_to
    entity: booking
    foreign_key: booking_id

  - name: refund_payment
    type: has_one
    entity: payment
    foreign_key: payment_id

indexes:
  - name: idx_cancellation_booking
    columns: [booking_id]
    unique: true

  - name: idx_cancellation_reference
    columns: [cancellation_reference]
    unique: true

  - name: idx_cancellation_status
    columns: [status]

  - name: idx_cancellation_refund_status
    columns: [refund_status]

  - name: idx_cancellation_date
    columns: [requested_at]

state_machine:
  initial: requested
  states:
    requested:
      transitions:
        - to: processing
          event: cancellation_approved
        - to: disputed
          event: customer_disputed

    processing:
      transitions:
        - to: completed
          event: all_cancellations_confirmed
        - to: failed
          event: cancellation_failed

    completed:
      final: true

    failed:
      transitions:
        - to: processing
          event: retry_requested

    disputed:
      transitions:
        - to: processing
          event: dispute_resolved

computed_fields:
  - name: total_penalties
    formula: |
      airline_penalty + hotel_penalty + service_fee_forfeited + admin_fee - COALESCE(waiver_amount, 0)

  - name: refund_amount
    formula: amount_paid - total_penalties + taxes_refundable

  - name: refund_percentage
    formula: |
      ROUND((refund_amount / original_amount) * 100, 1)

  - name: is_full_refund
    formula: refund_amount >= amount_paid * 0.95

  - name: days_to_process
    formula: |
      DATEDIFF(completed_at, requested_at)

business_rules:
  - id: BR-CAN-001
    name: Flight Cancellation
    rule: |
      Flight refunds per fare rules:
      - Refundable: Full refund minus fees
      - Non-refundable: Taxes only
      - Within 24 hours: May qualify for full refund

  - id: BR-CAN-002
    name: Hotel Cancellation
    rule: |
      - Before deadline: Full refund
      - After deadline: Penalty per policy
      - No-show: Usually 1 night or full charge

  - id: BR-CAN-003
    name: Refund Timeline
    rule: |
      - Credit card: 5-10 business days
      - Bank transfer: 10-15 business days
      - Original payment method preferred

  - id: BR-CAN-004
    name: Force Majeure
    rule: |
      In case of force majeure (natural disaster, pandemic):
      - Flexible rebooking offered
      - Credit voucher option
      - Penalty waivers may apply

  - id: BR-CAN-005
    name: Airline Schedule Change
    rule: |
      If airline changes schedule significantly (>60 min):
      - Full refund option
      - Free rebooking
      - No penalty applies

events:
  - name: cancellation.requested
    payload:
      - id
      - booking_id
      - cancellation_type
      - reason_code

  - name: cancellation.approved
    payload:
      - id
      - booking_id
      - refund_amount

  - name: cancellation.completed
    payload:
      - id
      - booking_id
      - refund_amount
      - refund_method

  - name: cancellation.refund_processed
    payload:
      - id
      - booking_id
      - refund_amount
      - refund_reference

  - name: cancellation.disputed
    payload:
      - id
      - booking_id
      - dispute_reason
