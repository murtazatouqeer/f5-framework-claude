name: voucher
display_name: Voucher
display_name_vi: Phiếu xác nhận
version: "1.0"
domain: travel-hospitality
subdomain: booking

description: |
  Confirmation voucher for hotels, activities, transfers,
  and other non-flight travel services.

attributes:
  # Identification
  - name: id
    type: uuid
    primary_key: true

  - name: booking_id
    type: uuid
    foreign_key: booking.id
    required: true

  - name: voucher_number
    type: string
    unique: true
    description: Voucher reference number

  - name: supplier_confirmation
    type: string
    nullable: true
    description: Supplier's confirmation number

  # Type
  - name: voucher_type
    type: enum
    values: [hotel, activity, transfer, car_rental, cruise, insurance, other]
    required: true

  - name: service_name
    type: string
    required: true
    description: Name of service

  # Status
  - name: status
    type: enum
    values: [pending, confirmed, cancelled, used, expired, no_show]
    default: pending

  # Related Entity
  - name: reservation_id
    type: uuid
    nullable: true
    description: hotel_reservation_id if hotel voucher

  # Service Details
  - name: service_date
    type: date
    required: true
    description: Start date of service

  - name: service_end_date
    type: date
    nullable: true
    description: End date (for hotels, car rentals)

  - name: service_time
    type: time
    nullable: true
    description: Service time (for activities, transfers)

  - name: duration
    type: string
    nullable: true
    description: Duration of service

  # Location
  - name: location_name
    type: string
    description: Hotel name, activity venue, etc.

  - name: location_address
    type: text

  - name: location_city
    type: string

  - name: location_country
    type: string

  - name: location_phone
    type: string
    nullable: true

  - name: location_coordinates
    type: object
    nullable: true
    properties:
      latitude:
        type: decimal
      longitude:
        type: decimal

  # Guests/Participants
  - name: lead_guest_name
    type: string
    required: true

  - name: guests
    type: array
    items:
      type: object
      properties:
        name:
          type: string
        type:
          type: string

  - name: guest_count
    type: integer
    min: 1

  # Hotel-specific
  - name: room_details
    type: object
    nullable: true
    properties:
      room_type:
        type: string
      room_count:
        type: integer
      bed_type:
        type: string
      view:
        type: string
      meal_plan:
        type: string
      special_requests:
        type: string

  - name: check_in_time
    type: time
    nullable: true

  - name: check_out_time
    type: time
    nullable: true

  # Activity-specific
  - name: activity_details
    type: object
    nullable: true
    properties:
      activity_name:
        type: string
      meeting_point:
        type: string
      meeting_time:
        type: time
      end_time:
        type: time
      includes:
        type: array
      excludes:
        type: array
      requirements:
        type: array
      cancellation_policy:
        type: string

  # Transfer-specific
  - name: transfer_details
    type: object
    nullable: true
    properties:
      pickup_location:
        type: string
      pickup_time:
        type: datetime
      dropoff_location:
        type: string
      vehicle_type:
        type: string
      flight_number:
        type: string
      driver_contact:
        type: string

  # Car rental-specific
  - name: car_rental_details
    type: object
    nullable: true
    properties:
      car_category:
        type: string
      pickup_location:
        type: string
      pickup_datetime:
        type: datetime
      return_location:
        type: string
      return_datetime:
        type: datetime
      rental_company:
        type: string
      insurance_included:
        type: boolean

  # Pricing
  - name: total_amount
    type: decimal
    precision: 10
    scale: 2

  - name: currency
    type: string
    length: 3

  - name: payment_status
    type: enum
    values: [prepaid, pay_at_venue, partially_paid]
    default: prepaid

  - name: amount_due_at_venue
    type: decimal
    precision: 10
    scale: 2
    default: 0

  # Inclusions
  - name: inclusions
    type: array
    items:
      type: string

  - name: exclusions
    type: array
    items:
      type: string

  # Terms
  - name: cancellation_policy
    type: text
    nullable: true

  - name: cancellation_deadline
    type: datetime
    nullable: true

  - name: terms_and_conditions
    type: text
    nullable: true

  # Supplier Information
  - name: supplier_code
    type: string
    nullable: true

  - name: supplier_name
    type: string
    nullable: true

  - name: supplier_contact
    type: object
    nullable: true
    properties:
      phone:
        type: string
      email:
        type: string

  # Documents
  - name: voucher_pdf_url
    type: string
    nullable: true

  - name: barcode
    type: string
    nullable: true
    description: Barcode/QR code for scanning

  - name: qr_code_url
    type: string
    nullable: true

  # Notes
  - name: important_notes
    type: array
    nullable: true
    items:
      type: string

  - name: internal_notes
    type: text
    nullable: true

  # Timestamps
  - name: created_at
    type: timestamp
    auto_set: true

  - name: confirmed_at
    type: timestamp
    nullable: true

  - name: cancelled_at
    type: timestamp
    nullable: true

  - name: used_at
    type: timestamp
    nullable: true

  - name: updated_at
    type: timestamp
    auto_update: true

validations:
  - rule: service_date >= current_date
    message: Service date must be in future
    context: creation

  - rule: service_end_date >= service_date OR service_end_date IS NULL
    message: End date must be on or after start date

  - rule: guest_count >= 1
    message: At least one guest required

relationships:
  - name: booking
    type: belongs_to
    entity: booking
    foreign_key: booking_id

  - name: hotel_reservation
    type: belongs_to
    entity: hotel_reservation
    foreign_key: reservation_id
    optional: true

indexes:
  - name: idx_voucher_booking
    columns: [booking_id]

  - name: idx_voucher_number
    columns: [voucher_number]
    unique: true

  - name: idx_voucher_confirmation
    columns: [supplier_confirmation]

  - name: idx_voucher_service_date
    columns: [service_date]

  - name: idx_voucher_status
    columns: [status]

state_machine:
  initial: pending
  states:
    pending:
      transitions:
        - to: confirmed
          event: confirmation_received
        - to: cancelled
          event: booking_cancelled

    confirmed:
      transitions:
        - to: used
          event: service_completed
        - to: cancelled
          event: cancellation_requested
        - to: no_show
          event: no_show_marked
        - to: expired
          event: service_date_passed

    used:
      final: true

    cancelled:
      final: true

    expired:
      final: true

    no_show:
      final: true

computed_fields:
  - name: is_valid
    formula: |
      status IN ('pending', 'confirmed') AND
      service_date >= CURRENT_DATE

  - name: days_until_service
    formula: DATEDIFF(service_date, CURRENT_DATE)

  - name: is_cancellable
    formula: |
      status IN ('pending', 'confirmed') AND
      (cancellation_deadline IS NULL OR cancellation_deadline > NOW())

  - name: service_duration_days
    formula: |
      CASE
        WHEN service_end_date IS NOT NULL THEN
          DATEDIFF(service_end_date, service_date) + 1
        ELSE 1
      END

business_rules:
  - id: BR-VCH-001
    name: Voucher Presentation
    rule: |
      Voucher must include:
      - Confirmation number
      - Guest names
      - Service details
      - Payment status
      - Supplier contact

  - id: BR-VCH-002
    name: Hotel Voucher
    rule: |
      Hotel vouchers must show:
      - Check-in/check-out dates and times
      - Room type and meal plan
      - Number of rooms and guests
      - Special requests

  - id: BR-VCH-003
    name: Transfer Voucher
    rule: |
      Transfer vouchers must show:
      - Pickup location and time
      - Flight details (if applicable)
      - Driver contact information
      - Vehicle type

  - id: BR-VCH-004
    name: Cancellation Policy
    rule: Display cancellation policy prominently on voucher

events:
  - name: voucher.created
    payload:
      - id
      - voucher_number
      - booking_id
      - voucher_type

  - name: voucher.confirmed
    payload:
      - id
      - voucher_number
      - supplier_confirmation

  - name: voucher.cancelled
    payload:
      - id
      - voucher_number
      - cancellation_reason

  - name: voucher.used
    payload:
      - id
      - voucher_number
      - used_at
