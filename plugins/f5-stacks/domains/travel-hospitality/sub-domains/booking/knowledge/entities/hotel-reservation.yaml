name: hotel-reservation
display_name: Hotel Reservation
display_name_vi: Đặt phòng khách sạn
version: "1.0"
domain: travel-hospitality
subdomain: booking

description: |
  Hotel room reservation within a booking, including stay details,
  guest information, and pricing.

attributes:
  # Identification
  - name: id
    type: uuid
    primary_key: true

  - name: booking_id
    type: uuid
    foreign_key: booking.id
    required: true

  - name: confirmation_number
    type: string
    description: Hotel confirmation number

  - name: supplier_reference
    type: string
    nullable: true
    description: Supplier booking reference

  # Hotel & Room
  - name: hotel_id
    type: uuid
    foreign_key: hotel.id
    required: true

  - name: hotel_name
    type: string
    description: Denormalized for display

  - name: room_type_id
    type: uuid
    foreign_key: room_type.id
    required: true

  - name: room_type_name
    type: string

  # Status
  - name: status
    type: enum
    values: [pending, confirmed, cancelled, checked_in, checked_out, no_show]
    default: pending

  # Stay Details
  - name: check_in_date
    type: date
    required: true

  - name: check_out_date
    type: date
    required: true

  - name: nights
    type: integer
    min: 1

  - name: rooms_count
    type: integer
    min: 1
    default: 1

  - name: expected_arrival_time
    type: time
    nullable: true

  - name: actual_check_in
    type: datetime
    nullable: true

  - name: actual_check_out
    type: datetime
    nullable: true

  # Guests
  - name: guest_names
    type: array
    items:
      type: object
      properties:
        first_name:
          type: string
        last_name:
          type: string
        is_lead:
          type: boolean

  - name: adults
    type: integer
    min: 1
    default: 1

  - name: children
    type: integer
    min: 0
    default: 0

  - name: child_ages
    type: array
    items:
      type: integer

  # Room Details
  - name: rate_plan_code
    type: string
    description: Rate plan selected

  - name: rate_plan_name
    type: string
    description: e.g., "Best Available Rate"

  - name: bed_type_requested
    type: string
    nullable: true

  - name: room_preferences
    type: array
    items:
      type: string
    description: e.g., ["high_floor", "quiet_room", "near_elevator"]

  - name: special_requests
    type: text
    nullable: true

  # Meal Plan
  - name: meal_plan
    type: enum
    values: [room_only, breakfast, half_board, full_board, all_inclusive]
    default: room_only

  - name: meal_plan_description
    type: string
    nullable: true

  # Pricing
  - name: rate_per_night
    type: decimal
    precision: 10
    scale: 2
    description: Average rate per night

  - name: nightly_rates
    type: array
    items:
      type: object
      properties:
        date:
          type: date
        rate:
          type: decimal

  - name: total_room_rate
    type: decimal
    precision: 12
    scale: 2

  - name: taxes_and_fees
    type: decimal
    precision: 10
    scale: 2

  - name: resort_fee
    type: decimal
    precision: 10
    scale: 2
    default: 0

  - name: total_amount
    type: decimal
    precision: 12
    scale: 2

  - name: currency
    type: string
    length: 3

  - name: extras
    type: array
    items:
      type: object
      properties:
        code:
          type: string
        description:
          type: string
        price:
          type: decimal

  # Cancellation Policy
  - name: cancellation_policy_code
    type: string

  - name: cancellation_deadline
    type: datetime
    description: Free cancellation until this time

  - name: cancellation_penalty
    type: object
    properties:
      type:
        type: enum
        values: [percentage, nights, fixed]
      value:
        type: decimal
      description:
        type: string

  - name: is_refundable
    type: boolean
    default: true

  - name: is_prepaid
    type: boolean
    default: false
    description: Pay at booking vs pay at hotel

  # Supplier Information
  - name: supplier_code
    type: string
    nullable: true

  - name: supplier_cost
    type: decimal
    precision: 12
    scale: 2
    nullable: true
    description: Net cost from supplier

  # Timestamps
  - name: created_at
    type: timestamp
    auto_set: true

  - name: confirmed_at
    type: timestamp
    nullable: true

  - name: cancelled_at
    type: timestamp
    nullable: true

  - name: updated_at
    type: timestamp
    auto_update: true

validations:
  - rule: check_out_date > check_in_date
    message: Check-out must be after check-in

  - rule: nights >= 1
    message: Minimum 1 night stay

  - rule: adults >= 1
    message: At least 1 adult required

  - rule: rooms_count >= 1
    message: At least 1 room required

  - rule: guest_names.length >= 1
    message: At least one guest name required

relationships:
  - name: booking
    type: belongs_to
    entity: booking
    foreign_key: booking_id

  - name: hotel
    type: belongs_to
    entity: hotel
    foreign_key: hotel_id

  - name: room_type
    type: belongs_to
    entity: room_type
    foreign_key: room_type_id

  - name: voucher
    type: has_one
    entity: voucher
    foreign_key: reservation_id

indexes:
  - name: idx_reservation_booking
    columns: [booking_id]

  - name: idx_reservation_hotel
    columns: [hotel_id]

  - name: idx_reservation_dates
    columns: [check_in_date, check_out_date]

  - name: idx_reservation_confirmation
    columns: [confirmation_number]

  - name: idx_reservation_status
    columns: [status]

state_machine:
  initial: pending
  states:
    pending:
      transitions:
        - to: confirmed
          event: confirmation_received
        - to: cancelled
          event: booking_cancelled

    confirmed:
      transitions:
        - to: checked_in
          event: guest_checked_in
        - to: cancelled
          event: cancellation_requested
        - to: no_show
          event: no_show_marked

    checked_in:
      transitions:
        - to: checked_out
          event: guest_checked_out

    checked_out:
      final: true

    cancelled:
      final: true

    no_show:
      final: true

computed_fields:
  - name: nights
    formula: DATEDIFF(check_out_date, check_in_date)

  - name: total_guests
    formula: adults + children

  - name: average_nightly_rate
    formula: total_room_rate / nights

  - name: is_cancellation_free
    formula: NOW() < cancellation_deadline

  - name: lead_guest_name
    formula: |
      CONCAT(guest_names[0].first_name, ' ', guest_names[0].last_name)

business_rules:
  - id: BR-RES-001
    name: Cancellation Deadline
    rule: |
      Free cancellation must be before deadline.
      After deadline, penalty applies per policy.

  - id: BR-RES-002
    name: Guest Name Requirement
    rule: Lead guest name must be provided at booking

  - id: BR-RES-003
    name: Maximum Room Occupancy
    rule: Total guests cannot exceed room max_occupancy

  - id: BR-RES-004
    name: Prepaid vs Pay at Hotel
    rule: |
      Prepaid: Full payment at booking, usually non-refundable
      Pay at Hotel: Guarantee with card, pay at property

events:
  - name: reservation.confirmed
    payload:
      - id
      - booking_id
      - confirmation_number
      - hotel_name

  - name: reservation.cancelled
    payload:
      - id
      - booking_id
      - cancellation_reason
      - penalty_amount

  - name: reservation.checked_in
    payload:
      - id
      - booking_id
      - room_number
      - check_in_time

  - name: reservation.checked_out
    payload:
      - id
      - booking_id
      - check_out_time
      - final_bill_amount
