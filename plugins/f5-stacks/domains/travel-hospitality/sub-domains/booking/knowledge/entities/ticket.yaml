name: ticket
display_name: E-Ticket
display_name_vi: Vé điện tử
version: "1.0"
domain: travel-hospitality
subdomain: booking

description: |
  Electronic ticket record for air travel, including
  ticket number, coupons, and validity information.

attributes:
  # Identification
  - name: id
    type: uuid
    primary_key: true

  - name: booking_id
    type: uuid
    foreign_key: booking.id
    required: true

  - name: flight_id
    type: uuid
    foreign_key: flight.id
    required: true

  - name: traveler_id
    type: uuid
    foreign_key: traveler.id
    required: true

  # Ticket Number
  - name: ticket_number
    type: string
    length: 13
    unique: true
    description: 13-digit e-ticket number (3-digit airline + 10-digit serial)

  - name: airline_code
    type: string
    length: 3
    description: Numeric airline code (e.g., 738 for Vietnam Airlines)

  - name: ticket_serial
    type: string
    length: 10

  # Status
  - name: status
    type: enum
    values: [issued, open, used, exchanged, refunded, void, suspended]
    default: issued

  - name: ticket_type
    type: enum
    values: [e_ticket, paper, mcot]
    default: e_ticket
    description: |
      e_ticket: Electronic ticket
      paper: Paper ticket (rare)
      mcot: Miscellaneous Charges Order

  # Passenger Details
  - name: passenger_name
    type: string
    description: Name as per ticket (LASTNAME/FIRSTNAME)

  - name: passenger_type
    type: enum
    values: [ADT, CHD, INF]
    description: Adult/Child/Infant

  # Fare Information
  - name: fare_basis
    type: string
    description: Fare basis code

  - name: fare_calculation
    type: text
    description: Full fare calculation line

  - name: fare_amount
    type: decimal
    precision: 10
    scale: 2

  - name: equivalent_fare
    type: decimal
    precision: 10
    scale: 2
    nullable: true
    description: Fare in local currency if different

  - name: taxes
    type: array
    items:
      type: object
      properties:
        code:
          type: string
        amount:
          type: decimal

  - name: total_amount
    type: decimal
    precision: 10
    scale: 2

  - name: currency
    type: string
    length: 3

  # Coupons
  - name: coupons
    type: array
    items:
      type: object
      properties:
        coupon_number:
          type: integer
        segment_id:
          type: uuid
        flight_number:
          type: string
        origin:
          type: string
        destination:
          type: string
        class:
          type: string
        date:
          type: date
        status:
          type: enum
          values: [open, used, void, refunded, exchanged]
        fare_basis:
          type: string
        not_valid_before:
          type: date
        not_valid_after:
          type: date

  # Validity
  - name: issue_date
    type: date
    required: true

  - name: issue_place
    type: string
    description: Issuing office IATA code

  - name: issuing_agent
    type: string
    nullable: true

  - name: valid_from
    type: date

  - name: valid_until
    type: date
    description: Ticket validity end date

  # Form of Payment
  - name: form_of_payment
    type: string
    description: FOP code (e.g., CCVI4111...1111/0125)

  - name: payment_id
    type: uuid
    foreign_key: payment.id
    nullable: true

  # Endorsements
  - name: endorsements
    type: string
    nullable: true
    description: Ticket restrictions/endorsements

  - name: tour_code
    type: string
    nullable: true

  # Exchange/Refund Information
  - name: original_ticket_number
    type: string
    nullable: true
    description: If exchanged, original ticket

  - name: exchange_date
    type: date
    nullable: true

  - name: residual_value
    type: decimal
    precision: 10
    scale: 2
    nullable: true
    description: Remaining value for exchange

  - name: refund_amount
    type: decimal
    precision: 10
    scale: 2
    nullable: true

  - name: refund_date
    type: date
    nullable: true

  # Baggage
  - name: baggage_allowance
    type: object
    properties:
      checked:
        type: object
        properties:
          pieces:
            type: integer
          weight_kg:
            type: integer
          weight_lbs:
            type: integer
      carry_on:
        type: object
        properties:
          pieces:
            type: integer
          weight_kg:
            type: integer

  # Frequent Flyer
  - name: frequent_flyer_number
    type: string
    nullable: true

  - name: miles_earned
    type: integer
    nullable: true

  # Conjunctions
  - name: conjunction_tickets
    type: array
    nullable: true
    items:
      type: string
    description: Related ticket numbers for multi-ticket itineraries

  # Documents
  - name: eticket_receipt_url
    type: string
    nullable: true

  - name: itinerary_receipt_url
    type: string
    nullable: true

  # BSP Settlement
  - name: bsp_reporting_period
    type: string
    nullable: true

  - name: commission_amount
    type: decimal
    precision: 8
    scale: 2
    nullable: true

  # Timestamps
  - name: created_at
    type: timestamp
    auto_set: true

  - name: voided_at
    type: timestamp
    nullable: true

  - name: updated_at
    type: timestamp
    auto_update: true

validations:
  - rule: ticket_number.length = 13
    message: Ticket number must be 13 digits

  - rule: valid_until >= valid_from
    message: Validity end must be after start

  - rule: coupons.length >= 1
    message: At least one coupon required

relationships:
  - name: booking
    type: belongs_to
    entity: booking
    foreign_key: booking_id

  - name: flight
    type: belongs_to
    entity: flight
    foreign_key: flight_id

  - name: traveler
    type: belongs_to
    entity: traveler
    foreign_key: traveler_id

  - name: payment
    type: belongs_to
    entity: payment
    foreign_key: payment_id
    optional: true

indexes:
  - name: idx_ticket_number
    columns: [ticket_number]
    unique: true

  - name: idx_ticket_booking
    columns: [booking_id]

  - name: idx_ticket_traveler
    columns: [traveler_id]

  - name: idx_ticket_status
    columns: [status]

  - name: idx_ticket_issue_date
    columns: [issue_date]

state_machine:
  initial: issued
  states:
    issued:
      transitions:
        - to: open
          event: coupon_lifted
        - to: void
          event: ticket_voided
        - to: exchanged
          event: ticket_exchanged

    open:
      transitions:
        - to: used
          event: all_coupons_used
        - to: exchanged
          event: ticket_exchanged
        - to: refunded
          event: refund_processed

    used:
      final: true

    exchanged:
      final: true

    refunded:
      final: true

    void:
      final: true

    suspended:
      transitions:
        - to: issued
          event: suspension_lifted
        - to: void
          event: ticket_voided

computed_fields:
  - name: is_valid
    formula: |
      status IN ('issued', 'open') AND
      valid_until >= CURRENT_DATE

  - name: unused_coupons
    formula: |
      COUNT(coupons WHERE status = 'open')

  - name: used_coupons
    formula: |
      COUNT(coupons WHERE status = 'used')

  - name: is_refundable
    formula: |
      status IN ('issued', 'open') AND
      NOT endorsements LIKE '%NON-REF%'

  - name: days_until_expiry
    formula: DATEDIFF(valid_until, CURRENT_DATE)

business_rules:
  - id: BR-TKT-001
    name: Ticket Validity
    rule: |
      Standard validity: 1 year from issue date
      Some fare types: Restricted validity per fare rules
      Unused ticket: Can be exchanged within validity

  - id: BR-TKT-002
    name: Void Window
    rule: |
      Tickets can be voided within 24 hours of issue
      (varies by airline and fare type)
      After void window: Exchange or refund per fare rules

  - id: BR-TKT-003
    name: Name Change
    rule: |
      Name corrections: Up to 3 characters
      Full name change: Not allowed (reissue required)
      Misspellings: May be corrected before departure

  - id: BR-TKT-004
    name: Coupon Sequence
    rule: |
      Coupons must be used in order
      Skipping coupon invalidates remaining
      Exception: Round-trip point-to-point

events:
  - name: ticket.issued
    payload:
      - id
      - ticket_number
      - booking_id
      - traveler_id
      - total_amount

  - name: ticket.voided
    payload:
      - id
      - ticket_number
      - void_reason

  - name: ticket.exchanged
    payload:
      - id
      - ticket_number
      - new_ticket_number
      - exchange_fee

  - name: ticket.refunded
    payload:
      - id
      - ticket_number
      - refund_amount

  - name: ticket.coupon_used
    payload:
      - id
      - ticket_number
      - coupon_number
      - flight_number
