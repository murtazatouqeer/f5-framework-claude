name: Address
display_name: Address / Địa chỉ
description: |
  Customer shipping or billing address.
  Customers can have multiple addresses with one default for shipping
  and one default for billing.

domain: e-commerce
category: supporting

attributes:
  - name: id
    type: uuid
    required: true
    description: Unique identifier of the address

  - name: customer_id
    type: uuid
    required: true
    description: Reference to customer

  - name: type
    type: enum
    required: true
    description: Address type
    validation:
      values: [shipping, billing, both]
    default: both

  - name: is_default_shipping
    type: boolean
    required: true
    description: Default shipping address
    default: false

  - name: is_default_billing
    type: boolean
    required: true
    description: Default billing address
    default: false

  - name: label
    type: string
    required: false
    description: Address label (e.g., "Home", "Office")
    validation:
      max_length: 50
    example: "Home"

  - name: recipient_name
    type: string
    required: true
    description: Recipient full name
    validation:
      min_length: 1
      max_length: 100

  - name: phone
    type: string
    required: true
    description: Contact phone number
    validation:
      pattern: "^[0-9+\\-\\s]{8,20}$"

  - name: email
    type: string
    required: false
    description: Contact email
    validation:
      format: email

  - name: company_name
    type: string
    required: false
    description: Company name (for business addresses)
    validation:
      max_length: 200

  - name: address_line1
    type: string
    required: true
    description: Street address line 1
    validation:
      min_length: 1
      max_length: 255

  - name: address_line2
    type: string
    required: false
    description: Street address line 2 (apt, suite, etc.)
    validation:
      max_length: 255

  - name: ward
    type: string
    required: false
    description: Ward/commune (Phường/Xã)
    validation:
      max_length: 100

  - name: district
    type: string
    required: false
    description: District (Quận/Huyện)
    validation:
      max_length: 100

  - name: city
    type: string
    required: true
    description: City/Province (Tỉnh/Thành phố)
    validation:
      max_length: 100

  - name: state
    type: string
    required: false
    description: State/Province (for international)
    validation:
      max_length: 100

  - name: postal_code
    type: string
    required: false
    description: Postal/ZIP code
    validation:
      max_length: 20

  - name: country
    type: string
    required: true
    description: Country code (ISO 3166-1 alpha-2)
    validation:
      pattern: "^[A-Z]{2}$"
    default: "VN"

  - name: country_name
    type: string
    required: false
    description: Country name
    validation:
      max_length: 100
    default: "Vietnam"

  - name: latitude
    type: decimal
    required: false
    description: GPS latitude
    validation:
      min: -90
      max: 90

  - name: longitude
    type: decimal
    required: false
    description: GPS longitude
    validation:
      min: -180
      max: 180

  - name: delivery_instructions
    type: string
    required: false
    description: Special delivery instructions
    validation:
      max_length: 500

  - name: is_verified
    type: boolean
    required: true
    description: Address verified (by carrier or customer)
    default: false

  - name: verified_at
    type: timestamp
    required: false
    description: When address was verified

  - name: created_at
    type: timestamp
    required: true
    description: Record creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

relationships:
  - name: customer
    type: belongs_to
    entity: Customer
    required: true
    description: Address owner

  - name: orders_shipping
    type: has_many
    entity: Order
    required: false
    description: Orders shipped to this address

  - name: orders_billing
    type: has_many
    entity: Order
    required: false
    description: Orders billed to this address

indexes:
  - [customer_id]
  - [customer_id, is_default_shipping]
  - [customer_id, is_default_billing]
  - [country, city]
  - [postal_code]

business_rules:
  - BR-ADR-001: Only one default shipping address per customer
  - BR-ADR-002: Only one default billing address per customer
  - BR-ADR-003: First address automatically becomes default
  - BR-ADR-004: Cannot delete address used in orders (archive instead)
  - BR-ADR-005: Phone is required for shipping addresses
  - BR-ADR-006: Vietnam addresses require ward and district
  - BR-ADR-007: Address changes don't affect existing orders (snapshot)
  - BR-ADR-008: Deleting default address promotes next address to default

computed_fields:
  - name: full_address
    formula: CONCAT(address_line1, ', ', ward, ', ', district, ', ', city)
    description: Full formatted address

  - name: display_address
    formula: |
      recipient_name
      address_line1
      ward, district
      city, country
    description: Multi-line display format

events:
  - name: address.created
    payload: [id, customer_id, type]
    description: Fired when address is created

  - name: address.set_default
    payload: [id, customer_id, default_type]
    description: Fired when address is set as default

  - name: address.verified
    payload: [id, verification_method]
    description: Fired when address is verified
