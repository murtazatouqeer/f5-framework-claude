name: Shipment
display_name: Shipment / Lô hàng vận chuyển
description: |
  Shipment record for order fulfillment.
  Tracks packages, carriers, tracking information, and delivery status.
  Supports partial shipments and multi-package orders.

domain: e-commerce
category: core

attributes:
  - name: id
    type: uuid
    required: true
    description: Unique identifier of the shipment

  - name: shipment_number
    type: string
    required: true
    description: Human-readable shipment reference
    validation:
      pattern: "^SHP-[0-9]{8}-[A-Z0-9]{4}$"
    example: "SHP-20240115-A1B2"

  - name: order_id
    type: uuid
    required: true
    description: Reference to parent order

  - name: status
    type: enum
    required: true
    description: Shipment status
    validation:
      values: [pending, label_created, picked_up, in_transit, out_for_delivery, delivered, failed_attempt, returned, lost, cancelled]
    default: pending

  - name: carrier
    type: string
    required: true
    description: Shipping carrier code
    validation:
      max_length: 50
    example: "ghn"

  - name: carrier_name
    type: string
    required: true
    description: Carrier display name
    validation:
      max_length: 100
    example: "Giao Hàng Nhanh"

  - name: service_type
    type: string
    required: false
    description: Shipping service level
    validation:
      max_length: 50
    example: "express"

  - name: tracking_number
    type: string
    required: false
    description: Carrier tracking number
    validation:
      max_length: 100

  - name: tracking_url
    type: string
    required: false
    description: Carrier tracking URL
    validation:
      format: url

  - name: ship_from_address
    type: object
    required: true
    description: Origin address (warehouse/store)
    example:
      name: "Kho HCM"
      address_line1: "123 Nguyen Van Linh"
      city: "Ho Chi Minh City"
      country: "VN"

  - name: ship_to_address
    type: object
    required: true
    description: Destination address (customer)

  - name: package_count
    type: integer
    required: true
    description: Number of packages
    validation:
      min: 1
    default: 1

  - name: total_weight
    type: decimal
    required: false
    description: Total weight in grams
    validation:
      min: 0

  - name: total_dimensions
    type: object
    required: false
    description: Package dimensions
    example:
      length: 30
      width: 20
      height: 10
      unit: "cm"

  - name: shipping_cost
    type: decimal
    required: true
    description: Shipping cost charged to customer
    validation:
      min: 0
    default: 0

  - name: actual_cost
    type: decimal
    required: false
    description: Actual cost paid to carrier
    validation:
      min: 0

  - name: insurance_amount
    type: decimal
    required: false
    description: Declared value for insurance
    validation:
      min: 0

  - name: cod_amount
    type: decimal
    required: false
    description: Cash on delivery amount to collect
    validation:
      min: 0

  - name: is_cod
    type: boolean
    required: true
    description: Whether COD is required
    default: false

  - name: requires_signature
    type: boolean
    required: true
    description: Signature required on delivery
    default: false

  - name: delivery_instructions
    type: string
    required: false
    description: Special delivery instructions
    validation:
      max_length: 500

  - name: estimated_delivery_at
    type: timestamp
    required: false
    description: Estimated delivery date

  - name: shipped_at
    type: timestamp
    required: false
    description: When shipment was handed to carrier

  - name: delivered_at
    type: timestamp
    required: false
    description: When shipment was delivered

  - name: delivery_attempts
    type: integer
    required: true
    description: Number of delivery attempts
    validation:
      min: 0
    default: 0

  - name: last_attempt_at
    type: timestamp
    required: false
    description: Last delivery attempt timestamp

  - name: signed_by
    type: string
    required: false
    description: Name of person who signed
    validation:
      max_length: 100

  - name: proof_of_delivery
    type: string
    required: false
    description: POD image URL
    validation:
      format: url

  - name: return_reason
    type: string
    required: false
    description: Reason for return
    validation:
      max_length: 500

  - name: tracking_events
    type: array
    required: false
    description: Array of tracking events
    example:
      - timestamp: "2024-01-15T10:30:00Z"
        status: "picked_up"
        location: "Ho Chi Minh City"
        description: "Package picked up by carrier"

  - name: label_url
    type: string
    required: false
    description: Shipping label PDF URL
    validation:
      format: url

  - name: created_at
    type: timestamp
    required: true
    description: Record creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

relationships:
  - name: order
    type: belongs_to
    entity: Order
    required: true
    description: Parent order

  - name: shipment_items
    type: has_many
    entity: ShipmentItem
    required: true
    description: Items in this shipment

  - name: warehouse
    type: belongs_to
    entity: Warehouse
    required: false
    description: Origin warehouse

state_machine:
  initial: pending
  states:
    - name: pending
      description: Shipment created, awaiting fulfillment
    - name: label_created
      description: Shipping label generated
    - name: picked_up
      description: Carrier has picked up package
    - name: in_transit
      description: Package in transit
    - name: out_for_delivery
      description: Out for delivery today
    - name: delivered
      description: Successfully delivered
    - name: failed_attempt
      description: Delivery attempt failed
    - name: returned
      description: Package returned to sender
    - name: lost
      description: Package lost in transit
    - name: cancelled
      description: Shipment cancelled
  transitions:
    - from: pending
      to: label_created
      trigger: create_label
      actions: [generate_label, notify_warehouse]
      description: Generate shipping label
    - from: pending
      to: cancelled
      trigger: cancel
      description: Cancel before shipping
    - from: label_created
      to: picked_up
      trigger: pickup
      actions: [update_order_status, notify_customer]
      description: Carrier picks up package
    - from: picked_up
      to: in_transit
      trigger: transit
      description: Package in transit
    - from: in_transit
      to: out_for_delivery
      trigger: out_for_delivery
      actions: [notify_customer_delivery_today]
      description: Out for delivery
    - from: out_for_delivery
      to: delivered
      trigger: deliver
      actions: [update_order_delivered, notify_customer_delivered]
      description: Successfully delivered
    - from: out_for_delivery
      to: failed_attempt
      trigger: fail_delivery
      description: Delivery attempt failed
    - from: failed_attempt
      to: out_for_delivery
      trigger: retry_delivery
      conditions: [attempts_remaining]
      description: Retry delivery
    - from: failed_attempt
      to: returned
      trigger: return_to_sender
      conditions: [max_attempts_reached]
      description: Return to sender
    - from: in_transit
      to: lost
      trigger: mark_lost
      actions: [notify_customer, create_claim]
      description: Mark as lost
    - from: [label_created, picked_up]
      to: cancelled
      trigger: cancel
      actions: [void_label, update_order]
      description: Cancel shipment

indexes:
  - [shipment_number]
  - [order_id]
  - [tracking_number]
  - [carrier, tracking_number]
  - [status]
  - [shipped_at]
  - [delivered_at]
  - [estimated_delivery_at]

business_rules:
  - BR-SHP-001: Shipment number format SHP-YYYYMMDD-XXXX (auto-generated)
  - BR-SHP-002: tracking_number required before status = picked_up
  - BR-SHP-003: Maximum 3 delivery attempts before return
  - BR-SHP-004: COD amount must match order balance for COD orders
  - BR-SHP-005: Cannot cancel after picked_up status
  - BR-SHP-006: Delivered requires proof_of_delivery or signed_by
  - BR-SHP-007: tracking_events updated via carrier webhook
  - BR-SHP-008: Insurance required for shipments over value threshold
  - BR-SHP-009: Partial shipments create separate shipment records
  - BR-SHP-010: estimated_delivery_at calculated from carrier SLA

computed_fields:
  - name: is_delayed
    formula: NOW() > estimated_delivery_at AND status NOT IN (delivered, cancelled, returned)
    description: Whether shipment is delayed

  - name: transit_days
    formula: DATEDIFF(delivered_at OR NOW(), shipped_at)
    description: Days in transit

  - name: remaining_attempts
    formula: 3 - delivery_attempts
    description: Delivery attempts remaining

events:
  - name: shipment.created
    payload: [id, shipment_number, order_id, carrier]
    description: Fired when shipment is created

  - name: shipment.shipped
    payload: [id, shipment_number, tracking_number, carrier]
    description: Fired when shipment is handed to carrier

  - name: shipment.tracking_update
    payload: [id, shipment_number, status, location, timestamp]
    description: Fired when tracking is updated

  - name: shipment.delivered
    payload: [id, shipment_number, order_id, delivered_at, signed_by]
    description: Fired when shipment is delivered

  - name: shipment.failed
    payload: [id, shipment_number, attempt_number, reason]
    description: Fired when delivery attempt fails

  - name: shipment.returned
    payload: [id, shipment_number, return_reason]
    description: Fired when shipment is returned
