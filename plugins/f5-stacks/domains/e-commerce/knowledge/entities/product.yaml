name: Product
display_name: Product / Sản phẩm
description: |
  Core entity representing items for sale in the e-commerce platform.
  Products can be physical goods, digital downloads, services, or subscriptions.
  Each product can have multiple variants (size, color) and belong to multiple categories.

domain: e-commerce
category: core

attributes:
  - name: id
    type: uuid
    required: true
    description: Unique identifier of the product

  - name: sku
    type: string
    required: true
    description: Stock Keeping Unit - unique product code
    validation:
      pattern: "^[A-Z0-9-]{3,50}$"
    example: "SHIRT-BLU-001"

  - name: name
    type: string
    required: true
    description: Product name displayed to customers
    validation:
      min_length: 1
      max_length: 255
    example: "Men's Classic Blue Shirt"

  - name: slug
    type: string
    required: true
    description: URL-friendly product identifier
    validation:
      pattern: "^[a-z0-9-]+$"
      max_length: 255
    example: "mens-classic-blue-shirt"

  - name: description
    type: string
    required: false
    description: Full product description (supports HTML/Markdown)
    validation:
      max_length: 65535

  - name: short_description
    type: string
    required: false
    description: Brief product summary for listings
    validation:
      max_length: 500

  - name: product_type
    type: enum
    required: true
    description: Type of product determines handling and fulfillment
    validation:
      values: [physical, digital, service, subscription, bundle]
    default: physical

  - name: status
    type: enum
    required: true
    description: Product lifecycle status
    validation:
      values: [draft, pending_review, active, inactive, discontinued, out_of_stock]
    default: draft

  - name: visibility
    type: enum
    required: true
    description: Product visibility in storefront
    validation:
      values: [visible, catalog_only, search_only, hidden]
    default: visible

  - name: base_price
    type: decimal
    required: true
    description: Regular selling price before any discounts
    validation:
      min: 0
    example: 599000

  - name: sale_price
    type: decimal
    required: false
    description: Discounted price (when on sale)
    validation:
      min: 0

  - name: cost_price
    type: decimal
    required: false
    description: Cost of goods for profit calculation
    validation:
      min: 0

  - name: currency
    type: string
    required: true
    description: Price currency (ISO 4217)
    validation:
      pattern: "^[A-Z]{3}$"
    default: "VND"

  - name: tax_class
    type: enum
    required: true
    description: Tax classification for tax calculation
    validation:
      values: [standard, reduced, zero, exempt]
    default: standard

  - name: weight
    type: decimal
    required: false
    description: Product weight in grams (for shipping calculation)
    validation:
      min: 0

  - name: dimensions
    type: object
    required: false
    description: Product dimensions in cm (length, width, height)
    example:
      length: 30
      width: 20
      height: 5

  - name: brand_id
    type: uuid
    required: false
    description: Reference to brand entity

  - name: vendor_id
    type: uuid
    required: false
    description: Reference to vendor/seller (marketplace)

  - name: main_image_url
    type: string
    required: false
    description: Primary product image URL
    validation:
      format: url

  - name: gallery_images
    type: array
    required: false
    description: Additional product images
    example: ["https://cdn.example.com/img1.jpg", "https://cdn.example.com/img2.jpg"]

  - name: meta_title
    type: string
    required: false
    description: SEO meta title
    validation:
      max_length: 70

  - name: meta_description
    type: string
    required: false
    description: SEO meta description
    validation:
      max_length: 160

  - name: tags
    type: array
    required: false
    description: Product tags for filtering and search
    example: ["summer", "casual", "bestseller"]

  - name: is_featured
    type: boolean
    required: true
    description: Display in featured products section
    default: false

  - name: is_bestseller
    type: boolean
    required: true
    description: Mark as bestseller
    default: false

  - name: is_new_arrival
    type: boolean
    required: true
    description: Mark as new arrival
    default: false

  - name: allow_backorder
    type: boolean
    required: true
    description: Allow orders when out of stock
    default: false

  - name: min_order_quantity
    type: integer
    required: true
    description: Minimum quantity per order
    validation:
      min: 1
    default: 1

  - name: max_order_quantity
    type: integer
    required: false
    description: Maximum quantity per order
    validation:
      min: 1

  - name: sold_count
    type: integer
    required: true
    description: Total units sold
    validation:
      min: 0
    default: 0

  - name: view_count
    type: integer
    required: true
    description: Product page views
    validation:
      min: 0
    default: 0

  - name: average_rating
    type: decimal
    required: false
    description: Average customer rating (1-5)
    validation:
      min: 0
      max: 5

  - name: review_count
    type: integer
    required: true
    description: Total number of reviews
    validation:
      min: 0
    default: 0

  - name: published_at
    type: timestamp
    required: false
    description: When product was published

  - name: created_at
    type: timestamp
    required: true
    description: Record creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

relationships:
  - name: categories
    type: many_to_many
    entity: Category
    required: false
    description: Product categories (can belong to multiple)

  - name: brand
    type: belongs_to
    entity: Brand
    required: false
    description: Product brand

  - name: vendor
    type: belongs_to
    entity: Vendor
    required: false
    description: Seller/vendor (marketplace model)

  - name: variants
    type: has_many
    entity: ProductVariant
    required: false
    description: Product variants (size, color combinations)

  - name: inventory
    type: has_many
    entity: Inventory
    required: false
    description: Inventory records across locations

  - name: reviews
    type: has_many
    entity: Review
    required: false
    description: Customer reviews

  - name: related_products
    type: many_to_many
    entity: Product
    required: false
    description: Related/recommended products

  - name: wishlists
    type: many_to_many
    entity: Wishlist
    required: false
    description: Wishlists containing this product

state_machine:
  initial: draft
  states:
    - name: draft
      description: Product is being created/edited, not visible
    - name: pending_review
      description: Awaiting approval (marketplace)
    - name: active
      description: Product is live and available for purchase
    - name: inactive
      description: Temporarily hidden from storefront
    - name: discontinued
      description: No longer sold, kept for history
    - name: out_of_stock
      description: Sold out, may return to active when restocked
  transitions:
    - from: draft
      to: pending_review
      trigger: submit_for_review
      description: Submit product for marketplace approval
    - from: draft
      to: active
      trigger: publish
      description: Publish product directly (non-marketplace)
    - from: pending_review
      to: active
      trigger: approve
      description: Approve product listing
    - from: pending_review
      to: draft
      trigger: reject
      description: Reject product, return to draft
    - from: active
      to: inactive
      trigger: deactivate
      description: Temporarily hide product
    - from: active
      to: out_of_stock
      trigger: stock_depleted
      conditions: [inventory_zero]
      description: Auto-transition when stock reaches zero
    - from: inactive
      to: active
      trigger: activate
      description: Re-activate product
    - from: out_of_stock
      to: active
      trigger: restock
      conditions: [inventory_available]
      description: Return to active when restocked
    - from: [active, inactive, out_of_stock]
      to: discontinued
      trigger: discontinue
      description: Permanently discontinue product

indexes:
  - [sku]
  - [slug]
  - [status]
  - [product_type]
  - [brand_id]
  - [vendor_id]
  - [is_featured]
  - [is_bestseller]
  - [average_rating]
  - [sold_count]
  - [created_at]

business_rules:
  - BR-PRD-001: SKU must be unique across all products
  - BR-PRD-002: Slug must be unique and URL-safe
  - BR-PRD-003: sale_price must be less than base_price when set
  - BR-PRD-004: Products must have at least one category
  - BR-PRD-005: Physical products require weight for shipping calculation
  - BR-PRD-006: Published products must have main_image_url
  - BR-PRD-007: min_order_quantity must be <= max_order_quantity
  - BR-PRD-008: Average rating recalculated when reviews added/updated
  - BR-PRD-009: Discontinued products cannot be ordered
  - BR-PRD-010: Digital products do not require shipping info

computed_fields:
  - name: final_price
    formula: sale_price ?? base_price
    description: Effective selling price

  - name: discount_percentage
    formula: ((base_price - sale_price) / base_price) * 100
    description: Discount percentage when on sale

  - name: is_on_sale
    formula: sale_price IS NOT NULL AND sale_price < base_price
    description: Whether product is currently on sale

events:
  - name: product.created
    payload: [id, sku, name, vendor_id]
    description: Fired when a new product is created

  - name: product.published
    payload: [id, sku, name]
    description: Fired when product becomes active

  - name: product.price_changed
    payload: [id, old_price, new_price]
    description: Fired when price is updated

  - name: product.out_of_stock
    payload: [id, sku, name]
    description: Fired when product runs out of stock

  - name: product.discontinued
    payload: [id, sku, name]
    description: Fired when product is discontinued
