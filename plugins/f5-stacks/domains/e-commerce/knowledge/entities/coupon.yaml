name: Coupon
display_name: Coupon / Mã giảm giá
description: |
  Promotional coupon/voucher for order discounts.
  Supports various discount types, usage limits, and eligibility rules.
  Can be applied to entire orders or specific products/categories.

domain: e-commerce
category: supporting

attributes:
  - name: id
    type: uuid
    required: true
    description: Unique identifier of the coupon

  - name: code
    type: string
    required: true
    description: Coupon code (case-insensitive)
    validation:
      pattern: "^[A-Z0-9]{4,20}$"
    example: "SUMMER2024"

  - name: name
    type: string
    required: true
    description: Internal name for the coupon
    validation:
      max_length: 100

  - name: description
    type: string
    required: false
    description: Public description
    validation:
      max_length: 500

  - name: status
    type: enum
    required: true
    description: Coupon status
    validation:
      values: [draft, active, paused, expired, depleted]
    default: draft

  - name: type
    type: enum
    required: true
    description: Discount type
    validation:
      values: [percentage, fixed_amount, free_shipping, buy_x_get_y, fixed_price]

  - name: discount_value
    type: decimal
    required: true
    description: Discount value (percentage or amount)
    validation:
      min: 0

  - name: max_discount_amount
    type: decimal
    required: false
    description: Maximum discount cap (for percentage)
    validation:
      min: 0

  - name: minimum_order_amount
    type: decimal
    required: false
    description: Minimum order value required
    validation:
      min: 0

  - name: minimum_quantity
    type: integer
    required: false
    description: Minimum quantity required
    validation:
      min: 1

  - name: currency
    type: string
    required: true
    description: Currency for amount values
    validation:
      pattern: "^[A-Z]{3}$"
    default: "VND"

  - name: usage_limit_total
    type: integer
    required: false
    description: Total usage limit
    validation:
      min: 1

  - name: usage_limit_per_customer
    type: integer
    required: false
    description: Usage limit per customer
    validation:
      min: 1
    default: 1

  - name: used_count
    type: integer
    required: true
    description: Number of times used
    validation:
      min: 0
    default: 0

  - name: applies_to
    type: enum
    required: true
    description: What discount applies to
    validation:
      values: [all_products, specific_products, specific_categories, specific_collections]
    default: all_products

  - name: product_ids
    type: array
    required: false
    description: Specific product IDs (if applies_to = specific_products)

  - name: category_ids
    type: array
    required: false
    description: Specific category IDs (if applies_to = specific_categories)

  - name: collection_ids
    type: array
    required: false
    description: Specific collection IDs (if applies_to = specific_collections)

  - name: excluded_product_ids
    type: array
    required: false
    description: Products excluded from coupon

  - name: excluded_category_ids
    type: array
    required: false
    description: Categories excluded from coupon

  - name: customer_eligibility
    type: enum
    required: true
    description: Who can use this coupon
    validation:
      values: [all, specific_customers, specific_segments, first_order_only, vip_only]
    default: all

  - name: eligible_customer_ids
    type: array
    required: false
    description: Specific customer IDs (if customer_eligibility = specific_customers)

  - name: eligible_segments
    type: array
    required: false
    description: Customer segments (if customer_eligibility = specific_segments)
    example: ["gold_members", "newsletter_subscribers"]

  - name: start_date
    type: timestamp
    required: true
    description: Coupon valid from

  - name: end_date
    type: timestamp
    required: false
    description: Coupon expires at

  - name: is_combinable
    type: boolean
    required: true
    description: Can combine with other coupons
    default: false

  - name: priority
    type: integer
    required: true
    description: Application priority (higher = first)
    validation:
      min: 0
    default: 0

  - name: buy_quantity
    type: integer
    required: false
    description: Buy X quantity (for buy_x_get_y)
    validation:
      min: 1

  - name: get_quantity
    type: integer
    required: false
    description: Get Y quantity (for buy_x_get_y)
    validation:
      min: 1

  - name: get_discount_percentage
    type: decimal
    required: false
    description: Discount on Y items (for buy_x_get_y)
    validation:
      min: 0
      max: 100
    default: 100

  - name: channels
    type: array
    required: false
    description: Valid channels
    example: ["web", "mobile_app", "pos"]

  - name: is_auto_apply
    type: boolean
    required: true
    description: Automatically apply if eligible
    default: false

  - name: is_public
    type: boolean
    required: true
    description: Publicly visible/searchable
    default: false

  - name: terms_and_conditions
    type: string
    required: false
    description: Terms and conditions
    validation:
      max_length: 2000

  - name: created_by
    type: uuid
    required: true
    description: Admin who created

  - name: created_at
    type: timestamp
    required: true
    description: Record creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

relationships:
  - name: orders
    type: has_many
    entity: Order
    required: false
    description: Orders using this coupon

  - name: usage_history
    type: has_many
    entity: CouponUsage
    required: false
    description: Usage history records

  - name: products
    type: many_to_many
    entity: Product
    required: false
    description: Applicable products

  - name: categories
    type: many_to_many
    entity: Category
    required: false
    description: Applicable categories

state_machine:
  initial: draft
  states:
    - name: draft
      description: Coupon being configured
    - name: active
      description: Coupon is active and usable
    - name: paused
      description: Temporarily paused
    - name: expired
      description: Past end_date
    - name: depleted
      description: usage_limit_total reached
  transitions:
    - from: draft
      to: active
      trigger: activate
      conditions: [valid_configuration, start_date_reached]
      description: Activate coupon
    - from: active
      to: paused
      trigger: pause
      description: Pause coupon
    - from: paused
      to: active
      trigger: resume
      conditions: [not_expired, not_depleted]
      description: Resume coupon
    - from: active
      to: expired
      trigger: expire
      conditions: [end_date_passed]
      description: Auto-expire
    - from: active
      to: depleted
      trigger: deplete
      conditions: [usage_limit_reached]
      description: Usage limit reached

indexes:
  - [code]
  - [status]
  - [type]
  - [start_date, end_date]
  - [customer_eligibility]
  - [is_auto_apply]
  - [is_public]
  - [created_at]

business_rules:
  - BR-CPN-001: Code must be unique (case-insensitive)
  - BR-CPN-002: percentage discount max 100%
  - BR-CPN-003: max_discount_amount required for percentage > 50%
  - BR-CPN-004: Cannot edit active coupon code
  - BR-CPN-005: Auto-expire when end_date passes
  - BR-CPN-006: Auto-deplete when usage_limit_total reached
  - BR-CPN-007: Check usage_limit_per_customer before applying
  - BR-CPN-008: Validate minimum_order_amount before applying
  - BR-CPN-009: buy_x_get_y requires buy_quantity and get_quantity
  - BR-CPN-010: Non-combinable coupons reject other coupons
  - BR-CPN-011: Apply highest priority coupon first
  - BR-CPN-012: Discount cannot exceed order subtotal

computed_fields:
  - name: remaining_uses
    formula: usage_limit_total - used_count
    description: Remaining total uses

  - name: is_valid
    formula: status = 'active' AND NOW() >= start_date AND (end_date IS NULL OR NOW() <= end_date)
    description: Whether coupon is currently valid

  - name: is_expired
    formula: end_date IS NOT NULL AND NOW() > end_date
    description: Whether coupon is expired

  - name: utilization_rate
    formula: used_count / NULLIF(usage_limit_total, 0) * 100
    description: Usage percentage

events:
  - name: coupon.created
    payload: [id, code, type, discount_value]
    description: Fired when coupon is created

  - name: coupon.activated
    payload: [id, code, start_date, end_date]
    description: Fired when coupon is activated

  - name: coupon.used
    payload: [id, code, order_id, customer_id, discount_amount]
    description: Fired when coupon is used

  - name: coupon.expired
    payload: [id, code, used_count]
    description: Fired when coupon expires

  - name: coupon.depleted
    payload: [id, code, used_count]
    description: Fired when coupon is depleted
