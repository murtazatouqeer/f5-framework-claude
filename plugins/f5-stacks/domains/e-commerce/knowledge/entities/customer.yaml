name: Customer
display_name: Customer / Khách hàng
description: |
  Registered customer account in the e-commerce platform.
  Contains profile information, authentication data, loyalty status,
  and aggregated purchase history metrics.

domain: e-commerce
category: core

attributes:
  - name: id
    type: uuid
    required: true
    description: Unique identifier of the customer

  - name: customer_number
    type: string
    required: true
    description: Human-readable customer number
    validation:
      pattern: "^CUS[0-9]{8}$"
    example: "CUS00001234"

  - name: email
    type: string
    required: true
    description: Primary email address
    validation:
      format: email

  - name: phone
    type: string
    required: false
    description: Primary phone number
    validation:
      pattern: "^[0-9+\\-\\s]{8,20}$"

  - name: password_hash
    type: string
    required: false
    description: Hashed password (null for social login only)

  - name: status
    type: enum
    required: true
    description: Account status
    validation:
      values: [pending, active, suspended, banned, deleted]
    default: pending

  - name: type
    type: enum
    required: true
    description: Customer type
    validation:
      values: [individual, business]
    default: individual

  - name: first_name
    type: string
    required: false
    description: First name
    validation:
      max_length: 50

  - name: last_name
    type: string
    required: false
    description: Last name
    validation:
      max_length: 50

  - name: display_name
    type: string
    required: false
    description: Display name / nickname
    validation:
      max_length: 100

  - name: avatar_url
    type: string
    required: false
    description: Profile picture URL
    validation:
      format: url

  - name: gender
    type: enum
    required: false
    description: Gender
    validation:
      values: [male, female, other, prefer_not_to_say]

  - name: date_of_birth
    type: date
    required: false
    description: Date of birth

  - name: locale
    type: string
    required: true
    description: Preferred language locale
    validation:
      pattern: "^[a-z]{2}(-[A-Z]{2})?$"
    default: "vi-VN"

  - name: currency
    type: string
    required: true
    description: Preferred currency
    validation:
      pattern: "^[A-Z]{3}$"
    default: "VND"

  - name: timezone
    type: string
    required: false
    description: Timezone
    validation:
      max_length: 50
    default: "Asia/Ho_Chi_Minh"

  - name: company_name
    type: string
    required: false
    description: Company name (business customers)
    validation:
      max_length: 200

  - name: tax_id
    type: string
    required: false
    description: Tax ID / VAT number (business customers)
    validation:
      max_length: 50

  - name: accepts_marketing
    type: boolean
    required: true
    description: Opted in to marketing communications
    default: false

  - name: marketing_opt_in_at
    type: timestamp
    required: false
    description: When marketing was opted in

  - name: loyalty_points
    type: integer
    required: true
    description: Current loyalty points balance
    validation:
      min: 0
    default: 0

  - name: loyalty_tier
    type: enum
    required: true
    description: Loyalty program tier
    validation:
      values: [bronze, silver, gold, platinum, diamond]
    default: bronze

  - name: total_spent
    type: decimal
    required: true
    description: Lifetime total spent
    validation:
      min: 0
    default: 0

  - name: order_count
    type: integer
    required: true
    description: Total number of orders
    validation:
      min: 0
    default: 0

  - name: average_order_value
    type: decimal
    required: false
    description: Average order value
    validation:
      min: 0

  - name: auth_provider
    type: enum
    required: true
    description: Authentication provider
    validation:
      values: [email, google, facebook, apple, phone]
    default: email

  - name: auth_provider_id
    type: string
    required: false
    description: ID from auth provider
    validation:
      max_length: 255

  - name: email_verified
    type: boolean
    required: true
    description: Email verification status
    default: false

  - name: email_verified_at
    type: timestamp
    required: false
    description: When email was verified

  - name: phone_verified
    type: boolean
    required: true
    description: Phone verification status
    default: false

  - name: phone_verified_at
    type: timestamp
    required: false
    description: When phone was verified

  - name: two_factor_enabled
    type: boolean
    required: true
    description: 2FA enabled
    default: false

  - name: two_factor_secret
    type: string
    required: false
    description: 2FA secret (encrypted)

  - name: last_login_at
    type: timestamp
    required: false
    description: Last login timestamp

  - name: last_login_ip
    type: string
    required: false
    description: Last login IP address
    validation:
      max_length: 45

  - name: failed_login_attempts
    type: integer
    required: true
    description: Failed login attempt count
    validation:
      min: 0
    default: 0

  - name: locked_until
    type: timestamp
    required: false
    description: Account locked until (after too many failed attempts)

  - name: referral_code
    type: string
    required: false
    description: Customer's unique referral code
    validation:
      pattern: "^[A-Z0-9]{6,10}$"

  - name: referred_by
    type: uuid
    required: false
    description: Customer who referred this customer

  - name: referral_count
    type: integer
    required: true
    description: Number of successful referrals
    validation:
      min: 0
    default: 0

  - name: notes
    type: string
    required: false
    description: Admin notes about customer
    validation:
      max_length: 2000

  - name: tags
    type: array
    required: false
    description: Customer tags for segmentation
    example: ["vip", "wholesale", "influencer"]

  - name: created_at
    type: timestamp
    required: true
    description: Record creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

  - name: deleted_at
    type: timestamp
    required: false
    description: Soft delete timestamp

relationships:
  - name: addresses
    type: has_many
    entity: Address
    required: false
    description: Customer addresses

  - name: default_shipping_address
    type: has_one
    entity: Address
    required: false
    description: Default shipping address

  - name: default_billing_address
    type: has_one
    entity: Address
    required: false
    description: Default billing address

  - name: orders
    type: has_many
    entity: Order
    required: false
    description: Customer orders

  - name: cart
    type: has_one
    entity: Cart
    required: false
    description: Active shopping cart

  - name: wishlists
    type: has_many
    entity: Wishlist
    required: false
    description: Customer wishlists

  - name: reviews
    type: has_many
    entity: Review
    required: false
    description: Product reviews written

  - name: payment_methods
    type: has_many
    entity: PaymentMethod
    required: false
    description: Saved payment methods

  - name: referrer
    type: belongs_to
    entity: Customer
    required: false
    description: Customer who referred this customer

  - name: referrals
    type: has_many
    entity: Customer
    required: false
    description: Customers referred by this customer

state_machine:
  initial: pending
  states:
    - name: pending
      description: Account created, awaiting verification
    - name: active
      description: Account is active and can shop
    - name: suspended
      description: Account temporarily suspended
    - name: banned
      description: Account permanently banned
    - name: deleted
      description: Account deleted (soft delete)
  transitions:
    - from: pending
      to: active
      trigger: verify
      conditions: [email_or_phone_verified]
      description: Activate after verification
    - from: active
      to: suspended
      trigger: suspend
      description: Suspend account
    - from: suspended
      to: active
      trigger: unsuspend
      description: Reactivate suspended account
    - from: [active, suspended]
      to: banned
      trigger: ban
      description: Permanently ban account
    - from: banned
      to: active
      trigger: unban
      description: Lift ban
    - from: [pending, active, suspended]
      to: deleted
      trigger: delete
      description: Soft delete account

indexes:
  - [customer_number]
  - [email]
  - [phone]
  - [status]
  - [loyalty_tier]
  - [referral_code]
  - [referred_by]
  - [auth_provider, auth_provider_id]
  - [total_spent]
  - [created_at]

business_rules:
  - BR-CUS-001: Email must be unique (case-insensitive)
  - BR-CUS-002: Phone must be unique if provided
  - BR-CUS-003: customer_number auto-generated (CUS + 8 digits)
  - BR-CUS-004: referral_code auto-generated on registration
  - BR-CUS-005: Lock account after 5 failed login attempts (30 minutes)
  - BR-CUS-006: Loyalty tier based on total_spent thresholds
  - BR-CUS-007: average_order_value = total_spent / order_count
  - BR-CUS-008: Cannot delete customer with active orders
  - BR-CUS-009: Suspended customers cannot place orders
  - BR-CUS-010: Business customers require company_name and tax_id
  - BR-CUS-011: Marketing opt-in requires explicit consent timestamp
  - BR-CUS-012: Referral bonus awarded when referred customer completes first order

computed_fields:
  - name: full_name
    formula: CONCAT(first_name, ' ', last_name)
    description: Full name

  - name: average_order_value
    formula: total_spent / NULLIF(order_count, 0)
    description: Average order value

  - name: is_verified
    formula: email_verified OR phone_verified
    description: Whether customer is verified

  - name: days_since_last_order
    formula: DATEDIFF(NOW(), last_order_at)
    description: Days since last order

events:
  - name: customer.registered
    payload: [id, email, auth_provider, referral_code]
    description: Fired when customer registers

  - name: customer.verified
    payload: [id, email, verification_method]
    description: Fired when customer verifies account

  - name: customer.tier_upgraded
    payload: [id, old_tier, new_tier]
    description: Fired when loyalty tier changes

  - name: customer.suspended
    payload: [id, reason]
    description: Fired when customer is suspended

  - name: customer.referred
    payload: [id, referrer_id, referral_code]
    description: Fired when referral is completed
