name: Order
display_name: Order / Đơn hàng
description: |
  A confirmed purchase from a customer containing one or more items.
  Orders go through a lifecycle from pending to completed, with support
  for payment processing, fulfillment, shipping, and returns.

domain: e-commerce
category: core

attributes:
  - name: id
    type: uuid
    required: true
    description: Unique identifier of the order

  - name: order_number
    type: string
    required: true
    description: Human-readable order number
    validation:
      pattern: "^ORD-[0-9]{8}-[A-Z0-9]{4}$"
    example: "ORD-20240115-A1B2"

  - name: customer_id
    type: uuid
    required: false
    description: Customer who placed the order (null for guest)

  - name: status
    type: enum
    required: true
    description: Overall order status
    validation:
      values: [pending, confirmed, processing, shipped, delivered, completed, cancelled, returned]
    default: pending

  - name: payment_status
    type: enum
    required: true
    description: Payment status
    validation:
      values: [pending, authorized, paid, partially_refunded, refunded, failed]
    default: pending

  - name: fulfillment_status
    type: enum
    required: true
    description: Fulfillment/shipping status
    validation:
      values: [unfulfilled, partially_fulfilled, fulfilled, shipped, delivered]
    default: unfulfilled

  - name: currency
    type: string
    required: true
    description: Order currency (ISO 4217)
    validation:
      pattern: "^[A-Z]{3}$"
    default: "VND"

  - name: subtotal
    type: decimal
    required: true
    description: Sum of item prices before discounts/tax/shipping
    validation:
      min: 0

  - name: discount_amount
    type: decimal
    required: true
    description: Total discount applied
    validation:
      min: 0
    default: 0

  - name: shipping_amount
    type: decimal
    required: true
    description: Shipping cost
    validation:
      min: 0
    default: 0

  - name: tax_amount
    type: decimal
    required: true
    description: Total tax
    validation:
      min: 0
    default: 0

  - name: total_amount
    type: decimal
    required: true
    description: Grand total (subtotal - discount + shipping + tax)
    validation:
      min: 0

  - name: paid_amount
    type: decimal
    required: true
    description: Amount paid so far
    validation:
      min: 0
    default: 0

  - name: refunded_amount
    type: decimal
    required: true
    description: Amount refunded
    validation:
      min: 0
    default: 0

  - name: item_count
    type: integer
    required: true
    description: Total number of items
    validation:
      min: 1

  - name: shipping_method
    type: string
    required: false
    description: Selected shipping method code
    validation:
      max_length: 50

  - name: shipping_method_name
    type: string
    required: false
    description: Shipping method display name
    validation:
      max_length: 100

  - name: shipping_address
    type: object
    required: false
    description: Shipping address (embedded snapshot)
    example:
      name: "Nguyen Van A"
      phone: "0901234567"
      address_line1: "123 Le Loi Street"
      city: "Ho Chi Minh City"
      country: "VN"

  - name: billing_address
    type: object
    required: false
    description: Billing address (embedded snapshot)

  - name: tracking_number
    type: string
    required: false
    description: Shipment tracking number
    validation:
      max_length: 100

  - name: carrier
    type: string
    required: false
    description: Shipping carrier name
    validation:
      max_length: 50

  - name: coupon_code
    type: string
    required: false
    description: Applied coupon code
    validation:
      max_length: 50

  - name: coupon_id
    type: uuid
    required: false
    description: Reference to applied coupon

  - name: customer_email
    type: string
    required: true
    description: Customer email for notifications
    validation:
      format: email

  - name: customer_phone
    type: string
    required: false
    description: Customer phone number
    validation:
      pattern: "^[0-9+\\-\\s]{8,20}$"

  - name: customer_name
    type: string
    required: true
    description: Customer name
    validation:
      max_length: 100

  - name: customer_note
    type: string
    required: false
    description: Note from customer
    validation:
      max_length: 1000

  - name: admin_note
    type: string
    required: false
    description: Internal note from admin
    validation:
      max_length: 1000

  - name: source
    type: enum
    required: true
    description: Order source/channel
    validation:
      values: [web, mobile_app, pos, phone, marketplace, api]
    default: web

  - name: payment_method
    type: string
    required: false
    description: Payment method code
    validation:
      max_length: 50

  - name: payment_method_name
    type: string
    required: false
    description: Payment method display name
    validation:
      max_length: 100

  - name: cancellation_reason
    type: string
    required: false
    description: Reason for cancellation
    validation:
      max_length: 500

  - name: cancelled_by
    type: enum
    required: false
    description: Who cancelled the order
    validation:
      values: [customer, admin, system]

  - name: estimated_delivery_at
    type: timestamp
    required: false
    description: Estimated delivery date

  - name: confirmed_at
    type: timestamp
    required: false
    description: When order was confirmed

  - name: paid_at
    type: timestamp
    required: false
    description: When payment was completed

  - name: processing_at
    type: timestamp
    required: false
    description: When order started processing

  - name: shipped_at
    type: timestamp
    required: false
    description: When order was shipped

  - name: delivered_at
    type: timestamp
    required: false
    description: When order was delivered

  - name: completed_at
    type: timestamp
    required: false
    description: When order was marked completed

  - name: cancelled_at
    type: timestamp
    required: false
    description: When order was cancelled

  - name: ip_address
    type: string
    required: false
    description: Customer IP address
    validation:
      max_length: 45

  - name: created_at
    type: timestamp
    required: true
    description: Record creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

relationships:
  - name: customer
    type: belongs_to
    entity: Customer
    required: false
    description: Customer who placed the order

  - name: items
    type: has_many
    entity: OrderItem
    required: true
    description: Order line items

  - name: payments
    type: has_many
    entity: Payment
    required: false
    description: Payment transactions

  - name: shipments
    type: has_many
    entity: Shipment
    required: false
    description: Shipment records

  - name: coupon
    type: belongs_to
    entity: Coupon
    required: false
    description: Applied coupon

  - name: refunds
    type: has_many
    entity: Refund
    required: false
    description: Refund records

  - name: order_history
    type: has_many
    entity: OrderHistory
    required: false
    description: Order status history

  - name: returns
    type: has_many
    entity: Return
    required: false
    description: Return requests

state_machine:
  initial: pending
  states:
    - name: pending
      description: Order created, awaiting confirmation/payment
    - name: confirmed
      description: Order confirmed, awaiting processing
    - name: processing
      description: Order being prepared for shipment
    - name: shipped
      description: Order shipped to customer
    - name: delivered
      description: Order delivered to customer
    - name: completed
      description: Order completed (after return window)
    - name: cancelled
      description: Order cancelled
    - name: returned
      description: Order returned by customer
  transitions:
    - from: pending
      to: confirmed
      trigger: confirm
      conditions: [payment_authorized_or_cod]
      actions: [reserve_inventory, send_confirmation_email]
      description: Confirm order after payment authorization
    - from: pending
      to: cancelled
      trigger: cancel
      actions: [release_inventory, send_cancellation_email]
      description: Cancel pending order
    - from: confirmed
      to: processing
      trigger: start_processing
      actions: [deduct_inventory, notify_warehouse]
      description: Begin order processing
    - from: confirmed
      to: cancelled
      trigger: cancel
      actions: [release_inventory, refund_if_paid]
      description: Cancel confirmed order
    - from: processing
      to: shipped
      trigger: ship
      conditions: [tracking_number_set]
      actions: [send_shipping_notification]
      description: Mark as shipped
    - from: processing
      to: cancelled
      trigger: cancel
      actions: [restore_inventory, refund_if_paid]
      description: Cancel during processing
    - from: shipped
      to: delivered
      trigger: deliver
      actions: [send_delivery_notification]
      description: Mark as delivered
    - from: delivered
      to: completed
      trigger: complete
      conditions: [return_window_expired]
      actions: [add_loyalty_points]
      description: Complete order after return window
    - from: delivered
      to: returned
      trigger: initiate_return
      actions: [create_return_request]
      description: Customer initiates return

indexes:
  - [order_number]
  - [customer_id]
  - [status]
  - [payment_status]
  - [fulfillment_status]
  - [customer_email]
  - [tracking_number]
  - [coupon_code]
  - [source]
  - [created_at]
  - [shipped_at]

business_rules:
  - BR-ORD-001: Order number format ORD-YYYYMMDD-XXXX (auto-generated)
  - BR-ORD-002: total_amount = subtotal - discount_amount + shipping_amount + tax_amount
  - BR-ORD-003: Minimum order value may be required (configurable)
  - BR-ORD-004: Stock validated at order creation
  - BR-ORD-005: Prices locked at order creation (no price changes after)
  - BR-ORD-006: Order can be modified within 1 hour before processing
  - BR-ORD-007: Cancellation allowed before shipping
  - BR-ORD-008: After shipping, must use return process
  - BR-ORD-009: COD orders have maximum limit (5,000,000 VND default)
  - BR-ORD-010: Pending payment timeout after 24 hours
  - BR-ORD-011: Free shipping threshold (configurable)
  - BR-ORD-012: Auto-complete after 7 days of delivery
  - BR-ORD-013: Loyalty points awarded on completion
  - BR-ORD-014: Return window is 30 days from delivery

computed_fields:
  - name: total_amount
    formula: subtotal - discount_amount + shipping_amount + tax_amount
    description: Grand total

  - name: balance_due
    formula: total_amount - paid_amount
    description: Remaining amount to pay

  - name: is_paid
    formula: paid_amount >= total_amount
    description: Whether order is fully paid

  - name: can_cancel
    formula: status IN (pending, confirmed, processing)
    description: Whether order can be cancelled

  - name: can_return
    formula: status = delivered AND days_since_delivery <= 30
    description: Whether order can be returned

events:
  - name: order.created
    payload: [id, order_number, customer_id, total_amount]
    description: Fired when order is created

  - name: order.confirmed
    payload: [id, order_number]
    description: Fired when order is confirmed

  - name: order.paid
    payload: [id, order_number, paid_amount, payment_method]
    description: Fired when payment is completed

  - name: order.shipped
    payload: [id, order_number, tracking_number, carrier]
    description: Fired when order is shipped

  - name: order.delivered
    payload: [id, order_number, delivered_at]
    description: Fired when order is delivered

  - name: order.completed
    payload: [id, order_number, total_amount]
    description: Fired when order is completed

  - name: order.cancelled
    payload: [id, order_number, cancellation_reason, cancelled_by]
    description: Fired when order is cancelled

  - name: order.refunded
    payload: [id, order_number, refunded_amount]
    description: Fired when refund is processed
