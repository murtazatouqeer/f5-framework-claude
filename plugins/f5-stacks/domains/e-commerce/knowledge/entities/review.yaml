name: Review
display_name: Review / Đánh giá sản phẩm
description: |
  Customer review and rating for a purchased product.
  Includes star rating, text review, images/videos, and verification status.
  Supports helpful votes and seller responses.

domain: e-commerce
category: supporting

attributes:
  - name: id
    type: uuid
    required: true
    description: Unique identifier of the review

  - name: product_id
    type: uuid
    required: true
    description: Reference to reviewed product

  - name: variant_id
    type: uuid
    required: false
    description: Reference to specific variant reviewed

  - name: customer_id
    type: uuid
    required: true
    description: Reference to reviewing customer

  - name: order_id
    type: uuid
    required: false
    description: Reference to purchase order

  - name: order_item_id
    type: uuid
    required: false
    description: Reference to specific order item

  - name: status
    type: enum
    required: true
    description: Review status
    validation:
      values: [pending, approved, rejected, flagged, hidden]
    default: pending

  - name: rating
    type: integer
    required: true
    description: Star rating (1-5)
    validation:
      min: 1
      max: 5

  - name: title
    type: string
    required: false
    description: Review title/headline
    validation:
      max_length: 150

  - name: content
    type: string
    required: false
    description: Review text content
    validation:
      max_length: 5000

  - name: pros
    type: array
    required: false
    description: List of pros/positives
    example: ["Fast delivery", "Good quality", "Great value"]

  - name: cons
    type: array
    required: false
    description: List of cons/negatives
    example: ["Small size", "Limited colors"]

  - name: images
    type: array
    required: false
    description: Array of review image URLs
    validation:
      max_items: 10

  - name: videos
    type: array
    required: false
    description: Array of review video URLs
    validation:
      max_items: 3

  - name: is_verified_purchase
    type: boolean
    required: true
    description: Customer purchased this product
    default: false

  - name: verified_at
    type: timestamp
    required: false
    description: When purchase was verified

  - name: helpful_count
    type: integer
    required: true
    description: Number of helpful votes
    validation:
      min: 0
    default: 0

  - name: not_helpful_count
    type: integer
    required: true
    description: Number of not helpful votes
    validation:
      min: 0
    default: 0

  - name: report_count
    type: integer
    required: true
    description: Number of reports/flags
    validation:
      min: 0
    default: 0

  - name: seller_response
    type: string
    required: false
    description: Seller's response to review
    validation:
      max_length: 2000

  - name: seller_responded_at
    type: timestamp
    required: false
    description: When seller responded

  - name: is_featured
    type: boolean
    required: true
    description: Featured/highlighted review
    default: false

  - name: is_anonymous
    type: boolean
    required: true
    description: Show as anonymous
    default: false

  - name: display_name
    type: string
    required: false
    description: Custom display name
    validation:
      max_length: 50

  - name: purchase_date
    type: date
    required: false
    description: When product was purchased

  - name: variant_info
    type: string
    required: false
    description: Variant purchased (e.g., "Blue - XL")
    validation:
      max_length: 100

  - name: recommendation
    type: enum
    required: false
    description: Would recommend to others
    validation:
      values: [yes, no, maybe]

  - name: quality_rating
    type: integer
    required: false
    description: Product quality sub-rating
    validation:
      min: 1
      max: 5

  - name: value_rating
    type: integer
    required: false
    description: Value for money sub-rating
    validation:
      min: 1
      max: 5

  - name: shipping_rating
    type: integer
    required: false
    description: Shipping experience sub-rating
    validation:
      min: 1
      max: 5

  - name: rejection_reason
    type: string
    required: false
    description: Reason for rejection
    validation:
      max_length: 500

  - name: moderated_by
    type: uuid
    required: false
    description: Admin who moderated

  - name: moderated_at
    type: timestamp
    required: false
    description: When review was moderated

  - name: ip_address
    type: string
    required: false
    description: IP address at submission
    validation:
      max_length: 45

  - name: user_agent
    type: string
    required: false
    description: Browser user agent
    validation:
      max_length: 500

  - name: created_at
    type: timestamp
    required: true
    description: Record creation timestamp

  - name: updated_at
    type: timestamp
    required: true
    description: Last update timestamp

relationships:
  - name: product
    type: belongs_to
    entity: Product
    required: true
    description: Reviewed product

  - name: variant
    type: belongs_to
    entity: ProductVariant
    required: false
    description: Reviewed variant

  - name: customer
    type: belongs_to
    entity: Customer
    required: true
    description: Review author

  - name: order
    type: belongs_to
    entity: Order
    required: false
    description: Related purchase order

  - name: votes
    type: has_many
    entity: ReviewVote
    required: false
    description: Helpful votes

  - name: reports
    type: has_many
    entity: ReviewReport
    required: false
    description: Reports/flags

state_machine:
  initial: pending
  states:
    - name: pending
      description: Awaiting moderation
    - name: approved
      description: Approved and visible
    - name: rejected
      description: Rejected by moderator
    - name: flagged
      description: Flagged for review
    - name: hidden
      description: Hidden by system or admin
  transitions:
    - from: pending
      to: approved
      trigger: approve
      actions: [update_product_rating, notify_customer]
      description: Approve review
    - from: pending
      to: rejected
      trigger: reject
      conditions: [rejection_reason_provided]
      actions: [notify_customer_rejection]
      description: Reject review
    - from: approved
      to: flagged
      trigger: flag
      conditions: [report_threshold_reached]
      description: Flag for re-review
    - from: flagged
      to: approved
      trigger: approve
      description: Re-approve after review
    - from: flagged
      to: hidden
      trigger: hide
      actions: [update_product_rating]
      description: Hide flagged review
    - from: approved
      to: hidden
      trigger: hide
      actions: [update_product_rating]
      description: Admin hides review
    - from: hidden
      to: approved
      trigger: restore
      actions: [update_product_rating]
      description: Restore hidden review

indexes:
  - [product_id]
  - [product_id, status]
  - [customer_id]
  - [order_id]
  - [status]
  - [rating]
  - [is_verified_purchase]
  - [is_featured]
  - [helpful_count]
  - [created_at]

business_rules:
  - BR-REV-001: One review per customer per product (can update)
  - BR-REV-002: Verified purchase requires matching order_id
  - BR-REV-003: Auto-approve if customer has >5 approved reviews
  - BR-REV-004: Flag review if report_count >= 3
  - BR-REV-005: Rating required, content optional
  - BR-REV-006: Seller can respond once per review
  - BR-REV-007: Product rating recalculated on approve/hide
  - BR-REV-008: Cannot review products returned as defective
  - BR-REV-009: Review images scanned for inappropriate content
  - BR-REV-010: Incentivized reviews must be disclosed
  - BR-REV-011: Edit window is 30 days after submission

computed_fields:
  - name: helpful_score
    formula: helpful_count / NULLIF(helpful_count + not_helpful_count, 0)
    description: Helpful ratio

  - name: overall_sentiment
    formula: |
      CASE WHEN rating >= 4 THEN 'positive'
           WHEN rating = 3 THEN 'neutral'
           ELSE 'negative' END
    description: Sentiment category

  - name: has_media
    formula: images IS NOT NULL OR videos IS NOT NULL
    description: Whether review has media

  - name: is_detailed
    formula: LENGTH(content) > 100 OR pros IS NOT NULL OR cons IS NOT NULL
    description: Whether review is detailed

events:
  - name: review.submitted
    payload: [id, product_id, customer_id, rating]
    description: Fired when review is submitted

  - name: review.approved
    payload: [id, product_id, rating]
    description: Fired when review is approved

  - name: review.rejected
    payload: [id, product_id, customer_id, rejection_reason]
    description: Fired when review is rejected

  - name: review.seller_responded
    payload: [id, product_id, seller_response]
    description: Fired when seller responds

  - name: review.flagged
    payload: [id, product_id, report_count]
    description: Fired when review is flagged
