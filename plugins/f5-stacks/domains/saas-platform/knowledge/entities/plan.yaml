name: Plan
display_name: Plan / Gói dịch vụ
description: |
  Defines pricing plans and their associated features, limits, and billing terms.
  Plans determine what tenants can access and how much they pay.

domain: saas-platform
entity_type: reference
version: "1.0"

attributes:
  # Primary Identifiers
  - name: id
    type: uuid
    primary_key: true
    description: Internal unique identifier

  - name: name
    type: string
    required: true
    unique: true
    max_length: 100
    description: Internal plan identifier
    description_vi: Mã định danh gói nội bộ
    example: "professional-monthly"

  - name: display_name
    type: string
    required: true
    max_length: 255
    description: Public-facing plan name
    description_vi: Tên gói hiển thị công khai
    example: "Professional"

  - name: description
    type: text
    description: Plan description for marketing
    description_vi: Mô tả gói cho tiếp thị

  # Classification
  - name: tier
    type: enum
    values: [free, starter, professional, enterprise]
    required: true
    description: Plan tier level
    description_vi: Cấp độ gói

  - name: status
    type: enum
    values: [draft, active, deprecated, archived]
    default: draft
    description: Plan availability status
    description_vi: Trạng thái khả dụng của gói

  # Billing Configuration
  - name: billing_cycle
    type: enum
    values: [monthly, quarterly, annually, one_time, usage_based]
    required: true
    description: Billing frequency
    description_vi: Tần suất thanh toán

  - name: price
    type: decimal
    precision: 10
    scale: 2
    required: true
    description: Base price per billing cycle
    description_vi: Giá cơ bản mỗi chu kỳ thanh toán

  - name: currency
    type: string
    max_length: 3
    default: "USD"
    description: Pricing currency (ISO 4217)
    description_vi: Tiền tệ định giá

  - name: setup_fee
    type: decimal
    precision: 10
    scale: 2
    default: 0
    description: One-time setup fee
    description_vi: Phí thiết lập một lần

  # Seat-based Pricing
  - name: price_per_seat
    type: decimal
    precision: 10
    scale: 2
    description: Additional price per seat/user
    description_vi: Giá thêm mỗi chỗ/người dùng

  - name: included_seats
    type: integer
    default: 1
    description: Seats included in base price
    description_vi: Số chỗ bao gồm trong giá cơ bản

  - name: min_seats
    type: integer
    default: 1
    description: Minimum seats required
    description_vi: Số chỗ tối thiểu yêu cầu

  - name: max_seats
    type: integer
    description: Maximum seats allowed (null = unlimited)
    description_vi: Số chỗ tối đa cho phép

  # Usage-based Pricing
  - name: usage_pricing
    type: json
    description: Usage-based pricing configuration
    description_vi: Cấu hình định giá theo sử dụng
    schema:
      metrics:
        - metric: api_calls
          included: 100000
          tiers:
            - up_to: 500000
              price_per_unit: 0.0001
            - up_to: null
              price_per_unit: 0.00005
        - metric: storage_gb
          included: 50
          price_per_unit: 0.10
        - metric: bandwidth_gb
          included: 100
          price_per_unit: 0.05

  # Trial Configuration
  - name: trial_days
    type: integer
    default: 14
    description: Trial period in days
    description_vi: Thời gian dùng thử (ngày)

  - name: trial_requires_card
    type: boolean
    default: false
    description: Whether trial requires payment method
    description_vi: Dùng thử có yêu cầu phương thức thanh toán không

  # Features & Limits
  - name: features
    type: json
    description: Enabled features for this plan
    description_vi: Các tính năng được bật cho gói này
    schema:
      sso: boolean
      api_access: boolean
      custom_domain: boolean
      white_label: boolean
      advanced_analytics: boolean
      custom_reports: boolean
      priority_support: boolean
      dedicated_account_manager: boolean
      sla_guarantee: boolean
      audit_logs: boolean
      data_export: boolean
      integrations: boolean
      webhooks: boolean
      custom_roles: boolean
      ip_whitelist: boolean

  - name: limits
    type: json
    description: Resource limits for this plan
    description_vi: Giới hạn tài nguyên cho gói này
    schema:
      users: integer
      storage_gb: integer
      api_calls_per_month: integer
      api_rate_per_minute: integer
      projects: integer
      workspaces: integer
      file_upload_mb: integer
      retention_days: integer
      integrations: integer
      webhooks: integer
      custom_fields: integer

  # Display Configuration
  - name: is_popular
    type: boolean
    default: false
    description: Highlight as most popular option
    description_vi: Đánh dấu là lựa chọn phổ biến nhất

  - name: is_hidden
    type: boolean
    default: false
    description: Hidden from public pricing page
    description_vi: Ẩn khỏi trang giá công khai

  - name: sort_order
    type: integer
    default: 0
    description: Display order on pricing page
    description_vi: Thứ tự hiển thị trên trang giá

  - name: highlight_features
    type: json
    description: Key features to highlight on pricing page
    description_vi: Các tính năng chính để làm nổi bật
    example: ["Unlimited projects", "API access", "Priority support"]

  - name: comparison_notes
    type: text
    description: Notes for plan comparison
    description_vi: Ghi chú cho so sánh gói

  # Annual Discount
  - name: annual_discount_percent
    type: decimal
    precision: 5
    scale: 2
    default: 20
    description: Discount for annual billing
    description_vi: Giảm giá cho thanh toán năm

  # Upgrade/Downgrade
  - name: upgrade_path
    type: uuid
    foreign_key: plan.id
    description: Recommended upgrade plan
    description_vi: Gói nâng cấp được đề xuất

  - name: downgrade_path
    type: uuid
    foreign_key: plan.id
    description: Downgrade fallback plan
    description_vi: Gói hạ cấp dự phòng

  # Metadata
  - name: metadata
    type: json
    description: Additional plan configuration
    description_vi: Cấu hình gói bổ sung

  - name: stripe_price_id
    type: string
    max_length: 255
    description: Stripe Price ID for integration
    description_vi: ID Giá Stripe cho tích hợp

  - name: stripe_product_id
    type: string
    max_length: 255
    description: Stripe Product ID
    description_vi: ID Sản phẩm Stripe

  # Audit
  - name: created_at
    type: timestamp
    auto: true

  - name: updated_at
    type: timestamp
    auto: true

  - name: deprecated_at
    type: timestamp
    description: When plan was deprecated
    description_vi: Thời điểm gói bị ngừng hỗ trợ

relationships:
  - name: subscriptions
    type: has_many
    target: Subscription
    foreign_key: plan_id
    description: Subscriptions on this plan

  - name: feature_flags
    type: has_many
    target: Feature
    through: plan_features
    description: Feature flags enabled for this plan

  - name: upgrade_plan
    type: belongs_to
    target: Plan
    foreign_key: upgrade_path
    description: Next tier plan for upgrades

  - name: downgrade_plan
    type: belongs_to
    target: Plan
    foreign_key: downgrade_path
    description: Previous tier plan for downgrades

state_machine:
  field: status
  initial: draft
  states:
    draft:
      description: Plan being configured, not available
      description_vi: Gói đang được cấu hình, chưa khả dụng
    active:
      description: Available for new subscriptions
      description_vi: Có sẵn cho đăng ký mới
    deprecated:
      description: Not available for new subscriptions
      description_vi: Không có sẵn cho đăng ký mới
    archived:
      description: Completely hidden and inactive
      description_vi: Hoàn toàn ẩn và không hoạt động

  transitions:
    - from: draft
      to: active
      event: publish
      description: Make plan available
      conditions:
        - has_required_fields
        - stripe_integration_configured
      actions:
        - create_stripe_price
        - add_to_pricing_page

    - from: active
      to: deprecated
      event: deprecate
      description: Stop offering for new subscriptions
      actions:
        - set deprecated_at
        - notify_existing_subscribers
        - remove_from_pricing_page

    - from: deprecated
      to: active
      event: reactivate
      description: Make available again
      actions:
        - clear deprecated_at
        - add_to_pricing_page

    - from: deprecated
      to: archived
      event: archive
      description: Fully retire the plan
      conditions:
        - no_active_subscriptions
      actions:
        - archive_stripe_price
        - hide_completely

indexes:
  - name: idx_plan_name
    columns: [name]
    unique: true

  - name: idx_plan_tier_status
    columns: [tier, status]
    description: Filter plans by tier and status

  - name: idx_plan_status_sort
    columns: [status, sort_order]
    where: "status = 'active'"
    description: Pricing page display order

  - name: idx_plan_stripe_price
    columns: [stripe_price_id]
    unique: true
    where: "stripe_price_id IS NOT NULL"

business_rules:
  - id: BR-PLN-001
    name: Deprecated Plans Grandfathered
    description: Existing subscriptions continue on deprecated plans
    description_vi: Đăng ký hiện có tiếp tục trên các gói đã ngừng hỗ trợ

  - id: BR-PLN-002
    name: No New Deprecated Subscriptions
    description: Deprecated plans cannot accept new subscriptions
    description_vi: Gói đã ngừng không thể chấp nhận đăng ký mới
    condition: "status = 'active' FOR new subscriptions"

  - id: BR-PLN-003
    name: Free Plan No Billing
    description: Free tier has no billing cycle configuration
    description_vi: Gói miễn phí không có cấu hình chu kỳ thanh toán
    condition: "tier = 'free' IMPLIES price = 0"

  - id: BR-PLN-004
    name: Enterprise Custom Pricing
    description: Enterprise plans may have custom negotiated pricing
    description_vi: Gói enterprise có thể có giá đàm phán tùy chỉnh
    note: "Price on plan is starting/reference price"

  - id: BR-PLN-005
    name: Upgrade Path Validation
    description: Upgrade path must point to higher tier
    description_vi: Đường nâng cấp phải trỏ đến gói cao hơn
    validation: "upgrade_path.tier > self.tier"

  - id: BR-PLN-010
    name: Trial Free Only
    description: Only non-enterprise plans have self-service trials
    description_vi: Chỉ gói không phải enterprise có dùng thử tự phục vụ

  - id: BR-PLN-011
    name: Annual Discount Standard
    description: Standard annual discount is 20% (2 months free)
    description_vi: Giảm giá năm tiêu chuẩn là 20% (2 tháng miễn phí)

computed_fields:
  - name: monthly_equivalent
    formula: |
      CASE billing_cycle
        WHEN 'monthly' THEN price
        WHEN 'quarterly' THEN price / 3
        WHEN 'annually' THEN price / 12
        ELSE NULL
      END
    description: Monthly equivalent price for comparison

  - name: annual_price
    formula: |
      CASE billing_cycle
        WHEN 'monthly' THEN price * 12 * (1 - annual_discount_percent / 100)
        WHEN 'annually' THEN price
        ELSE NULL
      END
    description: Annual billing price with discount

  - name: subscriber_count
    formula: "COUNT(subscriptions WHERE status IN ('trialing', 'active'))"
    description: Active subscribers on this plan

  - name: mrr_contribution
    formula: "SUM(subscriptions.monthly_equivalent WHERE status = 'active')"
    description: Monthly recurring revenue from this plan

events:
  - name: plan.created
    description: New plan created
    payload: [plan_id, name, tier]

  - name: plan.published
    description: Plan made available
    payload: [plan_id, name]
    triggers: [sync_to_stripe, add_to_pricing_page]

  - name: plan.deprecated
    description: Plan deprecated
    payload: [plan_id, name, subscriber_count]
    triggers: [notify_subscribers, update_pricing_page]

  - name: plan.price_changed
    description: Plan price modified
    payload: [plan_id, old_price, new_price]
    note: "Only affects new subscriptions"

plan_templates:
  free:
    display_name: "Free"
    tier: free
    price: 0
    billing_cycle: monthly
    trial_days: 0
    features:
      api_access: false
      sso: false
      custom_domain: false
    limits:
      users: 3
      storage_gb: 1
      api_calls_per_month: 0
      projects: 2

  starter:
    display_name: "Starter"
    tier: starter
    price: 29
    billing_cycle: monthly
    trial_days: 14
    features:
      api_access: true
      sso: false
      custom_domain: false
      integrations: true
    limits:
      users: 10
      storage_gb: 10
      api_calls_per_month: 50000
      projects: 10

  professional:
    display_name: "Professional"
    tier: professional
    price: 99
    billing_cycle: monthly
    trial_days: 14
    is_popular: true
    features:
      api_access: true
      sso: true
      custom_domain: false
      advanced_analytics: true
      custom_reports: true
      integrations: true
      webhooks: true
    limits:
      users: 50
      storage_gb: 100
      api_calls_per_month: 500000
      projects: unlimited

  enterprise:
    display_name: "Enterprise"
    tier: enterprise
    price: 499  # Starting price, typically custom
    billing_cycle: annually
    trial_days: 0  # Custom trial via sales
    is_hidden: true  # Contact sales
    features:
      api_access: true
      sso: true
      custom_domain: true
      white_label: true
      advanced_analytics: true
      custom_reports: true
      priority_support: true
      dedicated_account_manager: true
      sla_guarantee: true
      audit_logs: true
      custom_roles: true
      ip_whitelist: true
    limits:
      users: unlimited
      storage_gb: unlimited
      api_calls_per_month: unlimited
      projects: unlimited
