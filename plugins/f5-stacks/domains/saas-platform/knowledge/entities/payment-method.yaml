name: PaymentMethod
display_name: Payment Method / Phương thức thanh toán
description: |
  Stores saved payment methods for tenants including credit cards,
  bank accounts, and other payment instruments.

domain: saas-platform
entity_type: reference
version: "1.0"

attributes:
  # Primary Identifiers
  - name: id
    type: uuid
    primary_key: true
    description: Internal unique identifier

  - name: tenant_id
    type: uuid
    foreign_key: tenant.id
    required: true
    description: Tenant this payment method belongs to
    description_vi: Khách thuê sở hữu phương thức thanh toán này

  # Type
  - name: type
    type: enum
    values: [card, bank_account, sepa_debit, ach_debit, wire_transfer]
    required: true
    description: Payment method type
    description_vi: Loại phương thức thanh toán

  # Status
  - name: status
    type: enum
    values: [pending, verified, failed, expired]
    default: pending
    description: Verification status
    description_vi: Trạng thái xác minh

  - name: is_default
    type: boolean
    default: false
    description: Is this the default payment method
    description_vi: Đây có phải phương thức thanh toán mặc định không

  - name: is_active
    type: boolean
    default: true
    description: Is payment method active
    description_vi: Phương thức thanh toán có hoạt động không

  # Card Details (for type = card)
  - name: card_brand
    type: enum
    values: [visa, mastercard, amex, discover, diners, jcb, unionpay]
    description: Card brand
    description_vi: Thương hiệu thẻ

  - name: card_last4
    type: string
    max_length: 4
    description: Last 4 digits of card number
    description_vi: 4 số cuối của số thẻ

  - name: card_exp_month
    type: integer
    min: 1
    max: 12
    description: Card expiration month
    description_vi: Tháng hết hạn thẻ

  - name: card_exp_year
    type: integer
    description: Card expiration year
    description_vi: Năm hết hạn thẻ

  - name: card_funding
    type: enum
    values: [credit, debit, prepaid, unknown]
    description: Card funding type
    description_vi: Loại thẻ

  - name: card_country
    type: string
    max_length: 2
    description: Card issuing country (ISO 3166-1)
    description_vi: Quốc gia phát hành thẻ

  # Bank Account Details (for type = bank_account, ach_debit)
  - name: bank_name
    type: string
    max_length: 255
    description: Bank name
    description_vi: Tên ngân hàng

  - name: bank_last4
    type: string
    max_length: 4
    description: Last 4 digits of account number
    description_vi: 4 số cuối của số tài khoản

  - name: bank_routing
    type: string
    max_length: 20
    description: Bank routing number (masked)
    description_vi: Số định tuyến ngân hàng

  - name: bank_account_type
    type: enum
    values: [checking, savings]
    description: Bank account type
    description_vi: Loại tài khoản ngân hàng

  # SEPA Details
  - name: sepa_last4
    type: string
    max_length: 4
    description: Last 4 digits of IBAN
    description_vi: 4 số cuối của IBAN

  - name: sepa_country
    type: string
    max_length: 2
    description: SEPA country
    description_vi: Quốc gia SEPA

  # Billing Details
  - name: billing_name
    type: string
    max_length: 255
    description: Name on payment method
    description_vi: Tên trên phương thức thanh toán

  - name: billing_email
    type: email
    description: Billing email
    description_vi: Email thanh toán

  - name: billing_address
    type: json
    description: Billing address
    description_vi: Địa chỉ thanh toán
    schema:
      line1: string
      line2: string
      city: string
      state: string
      postal_code: string
      country: string

  # External Integration
  - name: external_id
    type: string
    max_length: 255
    description: ID in payment processor (Stripe pm_xxx)
    description_vi: ID trong bộ xử lý thanh toán
    example: "pm_1234567890"

  - name: external_customer_id
    type: string
    max_length: 255
    description: Customer ID in payment processor
    description_vi: ID khách hàng trong bộ xử lý thanh toán

  # Security
  - name: fingerprint
    type: string
    max_length: 255
    description: Unique identifier for the card (for duplicate detection)
    description_vi: Mã định danh duy nhất của thẻ

  # Metadata
  - name: metadata
    type: json
    description: Additional payment method data
    description_vi: Dữ liệu phương thức thanh toán bổ sung

  # Audit
  - name: created_at
    type: timestamp
    auto: true

  - name: updated_at
    type: timestamp
    auto: true

  - name: verified_at
    type: timestamp
    description: When payment method was verified
    description_vi: Thời điểm xác minh phương thức thanh toán

  - name: expired_at
    type: timestamp
    description: When payment method expired
    description_vi: Thời điểm phương thức thanh toán hết hạn

  - name: created_by
    type: uuid
    foreign_key: user.id
    description: User who added this payment method
    description_vi: Người dùng đã thêm phương thức thanh toán này

relationships:
  - name: tenant
    type: belongs_to
    target: Tenant
    foreign_key: tenant_id
    description: Tenant owning this payment method

  - name: subscriptions
    type: has_many
    target: Subscription
    foreign_key: payment_method_id
    description: Subscriptions using this payment method

  - name: invoices
    type: has_many
    target: Invoice
    foreign_key: payment_method_id
    description: Invoices charged to this payment method

  - name: created_by_user
    type: belongs_to
    target: User
    foreign_key: created_by
    description: User who created this payment method

indexes:
  - name: idx_payment_method_tenant
    columns: [tenant_id]
    description: Tenant's payment methods

  - name: idx_payment_method_tenant_default
    columns: [tenant_id, is_default]
    where: "is_default = true AND is_active = true"
    description: Find default payment method

  - name: idx_payment_method_external
    columns: [external_id]
    unique: true
    where: "external_id IS NOT NULL"
    description: External ID lookup

  - name: idx_payment_method_fingerprint
    columns: [fingerprint]
    where: "fingerprint IS NOT NULL"
    description: Duplicate detection

  - name: idx_payment_method_expiry
    columns: [card_exp_year, card_exp_month]
    where: "type = 'card'"
    description: Expiring card queries

business_rules:
  - id: BR-PAY-001
    name: One Default Per Tenant
    description: Only one payment method can be default per tenant
    description_vi: Chỉ một phương thức thanh toán có thể là mặc định mỗi khách thuê

  - id: BR-PAY-002
    name: Card Data Not Stored
    description: Full card numbers are never stored, only last 4 and tokens
    description_vi: Số thẻ đầy đủ không bao giờ được lưu, chỉ 4 số cuối và token
    severity: critical
    compliance: [PCI-DSS]

  - id: BR-PAY-003
    name: Verification Required for Bank
    description: Bank accounts require micro-deposit verification
    description_vi: Tài khoản ngân hàng yêu cầu xác minh chuyển khoản nhỏ

  - id: BR-PAY-004
    name: Expired Card Notification
    description: Notify tenant 30 days before card expiration
    description_vi: Thông báo khách thuê 30 ngày trước khi thẻ hết hạn
    parameters:
      notification_days: [30, 7, 1]

  - id: BR-PAY-005
    name: Cannot Delete Default If Only
    description: Cannot delete default payment method if it's the only one
    description_vi: Không thể xóa phương thức mặc định nếu là phương thức duy nhất

  - id: BR-PAY-010
    name: Duplicate Detection
    description: Prevent adding duplicate payment methods using fingerprint
    description_vi: Ngăn thêm phương thức thanh toán trùng lặp bằng dấu vân tay

computed_fields:
  - name: is_expired
    formula: |
      CASE WHEN type = 'card' THEN
        MAKE_DATE(card_exp_year, card_exp_month, 1) + INTERVAL '1 month' - INTERVAL '1 day' < CURRENT_DATE
      ELSE false END
    description: Whether card has expired

  - name: expires_soon
    formula: |
      CASE WHEN type = 'card' THEN
        MAKE_DATE(card_exp_year, card_exp_month, 1) BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '30 days'
      ELSE false END
    description: Card expires within 30 days

  - name: display_name
    formula: |
      CASE type
        WHEN 'card' THEN CONCAT(card_brand, ' •••• ', card_last4)
        WHEN 'bank_account' THEN CONCAT(bank_name, ' •••• ', bank_last4)
        WHEN 'sepa_debit' THEN CONCAT('SEPA •••• ', sepa_last4)
        ELSE type
      END
    description: Human-readable display name

events:
  - name: payment_method.created
    payload: [payment_method_id, tenant_id, type]
    triggers: [verify_if_required]

  - name: payment_method.verified
    payload: [payment_method_id, type]

  - name: payment_method.set_default
    payload: [payment_method_id, tenant_id]

  - name: payment_method.expiring_soon
    payload: [payment_method_id, tenant_id, expires_at]
    triggers: [send_expiry_reminder]

  - name: payment_method.expired
    payload: [payment_method_id, tenant_id]
    triggers: [send_expired_notification, alert_account_owner]

  - name: payment_method.deleted
    payload: [payment_method_id, tenant_id, deleted_by]
