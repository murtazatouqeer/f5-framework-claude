name: Tenant
display_name: Tenant / Khách thuê
description: |
  Core entity representing a customer organization in the multi-tenant SaaS platform.
  Each tenant has isolated data, users, and configurations.
  Critical for multi-tenancy architecture and data isolation.

domain: saas-platform
entity_type: core
version: "1.0"

attributes:
  # Primary Identifiers
  - name: id
    type: uuid
    primary_key: true
    description: Internal unique identifier

  - name: tenant_id
    type: string
    unique: true
    immutable: true
    max_length: 50
    pattern: "^[a-z0-9][a-z0-9-]{2,48}[a-z0-9]$"
    description: Human-readable unique identifier (e.g., "acme-corp")
    description_vi: Mã định danh duy nhất dễ đọc
    example: "acme-corp"
    note: "Used in URLs, subdomains, and API paths"

  - name: name
    type: string
    required: true
    max_length: 255
    description: Organization display name
    description_vi: Tên hiển thị của tổ chức
    example: "Acme Corporation"

  - name: slug
    type: string
    unique: true
    immutable: true
    max_length: 100
    description: URL-friendly identifier
    derived_from: tenant_id

  # Status & Type
  - name: status
    type: enum
    values: [pending, active, suspended, cancelled, deleted]
    default: pending
    description: Current tenant status
    description_vi: Trạng thái hiện tại của khách thuê

  - name: type
    type: enum
    values: [trial, paying, enterprise, partner, internal]
    default: trial
    description: Tenant classification
    description_vi: Phân loại khách thuê

  - name: tier
    type: enum
    values: [free, starter, professional, enterprise]
    default: free
    description: Service tier determining features and limits
    description_vi: Cấp dịch vụ quyết định tính năng và giới hạn

  # Contact Information
  - name: email
    type: email
    required: true
    description: Primary contact email
    description_vi: Email liên hệ chính

  - name: phone
    type: string
    max_length: 20
    description: Contact phone number
    description_vi: Số điện thoại liên hệ

  - name: website
    type: url
    description: Company website URL
    description_vi: URL trang web công ty

  - name: address
    type: json
    description: Physical address
    schema:
      street: string
      city: string
      state: string
      postal_code: string
      country: string (ISO 3166-1 alpha-2)

  # Company Information
  - name: industry
    type: string
    max_length: 100
    description: Business industry/sector
    description_vi: Ngành/lĩnh vực kinh doanh
    examples: [technology, healthcare, finance, education, retail]

  - name: company_size
    type: enum
    values: ["1-10", "11-50", "51-200", "201-500", "501-1000", "1001+"]
    description: Number of employees
    description_vi: Số lượng nhân viên

  - name: tax_id
    type: string
    max_length: 50
    description: Tax identification number (VAT ID, EIN, etc.)
    description_vi: Mã số thuế

  # Branding & White-label
  - name: logo_url
    type: url
    description: Company logo URL
    description_vi: URL logo công ty

  - name: primary_color
    type: string
    pattern: "^#[0-9A-Fa-f]{6}$"
    description: Brand primary color (hex)
    description_vi: Màu chính của thương hiệu

  - name: custom_domain
    type: string
    max_length: 255
    description: Custom domain for white-label (enterprise only)
    description_vi: Tên miền tùy chỉnh cho white-label
    example: "app.acme.com"
    tier_required: enterprise

  # Localization
  - name: timezone
    type: string
    default: "UTC"
    description: Default timezone
    description_vi: Múi giờ mặc định
    example: "Asia/Ho_Chi_Minh"

  - name: locale
    type: string
    default: "en"
    max_length: 10
    description: Default language/locale
    description_vi: Ngôn ngữ/địa phương mặc định

  - name: currency
    type: string
    default: "USD"
    max_length: 3
    description: Default billing currency (ISO 4217)
    description_vi: Tiền tệ thanh toán mặc định

  - name: date_format
    type: string
    default: "YYYY-MM-DD"
    description: Preferred date format
    description_vi: Định dạng ngày ưa thích

  # Limits & Configuration
  - name: settings
    type: json
    description: Tenant-specific settings and feature flags
    description_vi: Cài đặt và cờ tính năng riêng của khách thuê
    schema:
      features:
        sso_enabled: boolean
        api_access: boolean
        custom_reports: boolean
        advanced_analytics: boolean
      limits:
        custom_user_limit: integer
        custom_storage_gb: integer
        custom_api_rate: integer
      integrations:
        slack: object
        webhook_urls: array

  - name: user_limit
    type: integer
    description: Maximum users allowed (from plan or custom)
    description_vi: Số người dùng tối đa được phép

  - name: storage_limit_gb
    type: decimal
    precision: 10
    scale: 2
    description: Storage limit in GB
    description_vi: Giới hạn lưu trữ (GB)

  - name: api_rate_limit
    type: integer
    description: API calls per minute limit
    description_vi: Giới hạn cuộc gọi API mỗi phút

  # Trial Management
  - name: trial_ends_at
    type: timestamp
    description: Trial expiration datetime
    description_vi: Thời điểm hết hạn dùng thử

  - name: trial_extended
    type: boolean
    default: false
    description: Whether trial has been extended
    description_vi: Dùng thử đã được gia hạn chưa

  - name: trial_extension_count
    type: integer
    default: 0
    description: Number of times trial was extended
    description_vi: Số lần dùng thử đã được gia hạn

  # Billing
  - name: billing_email
    type: email
    description: Email for billing communications
    description_vi: Email cho liên lạc thanh toán

  - name: payment_method_id
    type: uuid
    foreign_key: payment_method.id
    description: Default payment method
    description_vi: Phương thức thanh toán mặc định

  # Acquisition
  - name: source
    type: enum
    values: [organic, referral, paid_ads, partner, sales, unknown]
    default: unknown
    description: Customer acquisition source
    description_vi: Nguồn thu hút khách hàng

  - name: referrer_tenant_id
    type: uuid
    foreign_key: tenant.id
    description: Referring tenant for referral program
    description_vi: Khách thuê giới thiệu cho chương trình giới thiệu

  - name: utm_source
    type: string
    max_length: 100
    description: UTM source tracking

  - name: utm_campaign
    type: string
    max_length: 100
    description: UTM campaign tracking

  # Onboarding
  - name: onboarding_completed
    type: boolean
    default: false
    description: Whether onboarding is complete
    description_vi: Đã hoàn tất thiết lập ban đầu chưa

  - name: onboarding_completed_at
    type: timestamp
    description: When onboarding was completed
    description_vi: Thời điểm hoàn tất thiết lập

  - name: onboarding_step
    type: string
    max_length: 50
    description: Current onboarding step
    description_vi: Bước thiết lập hiện tại

  # Lifecycle Timestamps
  - name: activated_at
    type: timestamp
    description: When tenant became active
    description_vi: Thời điểm kích hoạt

  - name: suspended_at
    type: timestamp
    description: When tenant was suspended
    description_vi: Thời điểm tạm ngưng

  - name: suspension_reason
    type: string
    max_length: 500
    description: Reason for suspension
    description_vi: Lý do tạm ngưng

  - name: cancelled_at
    type: timestamp
    description: When subscription was cancelled
    description_vi: Thời điểm hủy

  - name: cancellation_reason
    type: string
    max_length: 500
    description: Reason for cancellation
    description_vi: Lý do hủy

  - name: cancellation_feedback
    type: text
    description: Detailed cancellation feedback
    description_vi: Phản hồi hủy chi tiết

  - name: deletion_scheduled_at
    type: timestamp
    description: When data deletion is scheduled
    description_vi: Thời điểm xóa dữ liệu theo lịch

  - name: deleted_at
    type: timestamp
    description: Soft delete timestamp
    description_vi: Thời điểm xóa mềm

  # Audit
  - name: created_at
    type: timestamp
    auto: true
    description: Record creation time
    description_vi: Thời điểm tạo

  - name: updated_at
    type: timestamp
    auto: true
    description: Last update time
    description_vi: Thời điểm cập nhật cuối

  - name: created_by
    type: uuid
    description: User who created the tenant
    description_vi: Người tạo khách thuê

relationships:
  - name: owner
    type: belongs_to
    target: User
    foreign_key: owner_id
    description: Tenant owner with full permissions
    description_vi: Chủ sở hữu khách thuê với toàn quyền

  - name: users
    type: has_many
    target: User
    foreign_key: tenant_id
    description: All users belonging to this tenant
    description_vi: Tất cả người dùng thuộc khách thuê này

  - name: subscription
    type: has_one
    target: Subscription
    foreign_key: tenant_id
    description: Current subscription
    description_vi: Gói đăng ký hiện tại

  - name: invoices
    type: has_many
    target: Invoice
    foreign_key: tenant_id
    description: All invoices for this tenant
    description_vi: Tất cả hóa đơn của khách thuê

  - name: payment_methods
    type: has_many
    target: PaymentMethod
    foreign_key: tenant_id
    description: Saved payment methods
    description_vi: Các phương thức thanh toán đã lưu

  - name: usage_records
    type: has_many
    target: UsageRecord
    foreign_key: tenant_id
    description: Usage tracking records
    description_vi: Bản ghi theo dõi sử dụng

  - name: audit_logs
    type: has_many
    target: AuditLog
    foreign_key: tenant_id
    description: Audit trail
    description_vi: Nhật ký kiểm toán

  - name: api_keys
    type: has_many
    target: ApiKey
    foreign_key: tenant_id
    description: API keys for integrations
    description_vi: Khóa API cho tích hợp

  - name: referred_tenants
    type: has_many
    target: Tenant
    foreign_key: referrer_tenant_id
    description: Tenants referred by this tenant
    description_vi: Khách thuê được giới thiệu bởi khách thuê này

state_machine:
  field: status
  initial: pending
  states:
    pending:
      description: Awaiting email verification or setup
      description_vi: Đang chờ xác minh email hoặc thiết lập
    active:
      description: Fully operational tenant
      description_vi: Khách thuê hoạt động đầy đủ
    suspended:
      description: Temporarily disabled (payment issue, policy violation)
      description_vi: Tạm ngưng (vấn đề thanh toán, vi phạm chính sách)
    cancelled:
      description: Subscription cancelled, in retention period
      description_vi: Đã hủy đăng ký, trong thời gian giữ lại
    deleted:
      description: Marked for deletion, data being removed
      description_vi: Đánh dấu xóa, dữ liệu đang được xóa

  transitions:
    - from: pending
      to: active
      event: activate
      description: Email verified, onboarding started
      actions:
        - set activated_at to now
        - start trial if applicable
        - send welcome email

    - from: active
      to: suspended
      event: suspend
      description: Suspend due to payment failure or policy violation
      conditions:
        - has_suspension_reason
      actions:
        - set suspended_at to now
        - restrict to read-only access
        - send suspension notice

    - from: suspended
      to: active
      event: reactivate
      description: Payment resolved or violation addressed
      conditions:
        - payment_resolved OR violation_resolved
      actions:
        - clear suspended_at
        - clear suspension_reason
        - restore full access
        - send reactivation notice

    - from: active
      to: cancelled
      event: cancel
      description: Voluntary cancellation or forced due to non-payment
      actions:
        - set cancelled_at to now
        - calculate deletion_scheduled_at (now + 30 days)
        - send cancellation confirmation
        - offer export option

    - from: suspended
      to: cancelled
      event: cancel
      description: Cancel from suspended state
      actions:
        - set cancelled_at to now
        - calculate deletion_scheduled_at
        - send cancellation notice

    - from: cancelled
      to: active
      event: reactivate
      description: Reactivate within retention period
      conditions:
        - within_retention_period (30 days)
        - valid_payment_method
      actions:
        - clear cancelled_at
        - clear deletion_scheduled_at
        - create new subscription
        - send reactivation welcome

    - from: cancelled
      to: deleted
      event: delete
      description: Permanent deletion after retention period
      conditions:
        - past_retention_period
      actions:
        - anonymize audit logs
        - delete all tenant data
        - set deleted_at to now

indexes:
  - name: idx_tenant_tenant_id
    columns: [tenant_id]
    unique: true
    description: Fast lookup by tenant_id

  - name: idx_tenant_slug
    columns: [slug]
    unique: true
    description: Fast lookup by slug

  - name: idx_tenant_email
    columns: [email]
    description: Lookup by contact email

  - name: idx_tenant_status
    columns: [status]
    description: Filter by status

  - name: idx_tenant_type_tier
    columns: [type, tier]
    description: Filter by type and tier combination

  - name: idx_tenant_custom_domain
    columns: [custom_domain]
    unique: true
    where: "custom_domain IS NOT NULL"
    description: Custom domain lookup

  - name: idx_tenant_trial_ends
    columns: [trial_ends_at]
    where: "status = 'active' AND type = 'trial'"
    description: Trial expiration queries

  - name: idx_tenant_deletion_scheduled
    columns: [deletion_scheduled_at]
    where: "status = 'cancelled' AND deletion_scheduled_at IS NOT NULL"
    description: Scheduled deletion queries

business_rules:
  - id: BR-TEN-001
    name: Tenant ID Immutability
    description: tenant_id and slug cannot be changed after creation
    description_vi: tenant_id và slug không thể thay đổi sau khi tạo
    severity: critical

  - id: BR-TEN-002
    name: Trial Duration
    description: Default trial is 14 days, maximum extension is 14 additional days
    description_vi: Dùng thử mặc định là 14 ngày, gia hạn tối đa 14 ngày thêm
    parameters:
      default_trial_days: 14
      max_extension_days: 14

  - id: BR-TEN-003
    name: Suspended Access
    description: Suspended tenants have read-only access to data
    description_vi: Khách thuê bị tạm ngưng chỉ có quyền đọc dữ liệu
    severity: high

  - id: BR-TEN-004
    name: Data Retention
    description: Data retained 30 days after cancellation before deletion
    description_vi: Dữ liệu giữ lại 30 ngày sau khi hủy trước khi xóa
    parameters:
      retention_days: 30

  - id: BR-TEN-005
    name: Custom Domain Tier
    description: Custom domain requires enterprise tier
    description_vi: Tên miền tùy chỉnh yêu cầu gói enterprise
    condition: "tier = 'enterprise'"

  - id: BR-TEN-006
    name: Owner Required
    description: Every tenant must have exactly one owner
    description_vi: Mỗi khách thuê phải có đúng một chủ sở hữu
    severity: critical

  - id: BR-TEN-007
    name: Unique Email
    description: Email must be unique across all tenants for primary contact
    description_vi: Email phải duy nhất trên tất cả khách thuê cho liên hệ chính
    severity: high

  - id: BR-TEN-010
    name: Trial Auto-Expiry
    description: Trial expires automatically if no payment method added
    description_vi: Dùng thử hết hạn tự động nếu không thêm phương thức thanh toán
    trigger: trial_ends_at reached
    action: transition to cancelled if no payment_method

  - id: BR-TEN-011
    name: Suspension Grace Period
    description: 7 days of suspended status before auto-cancellation
    description_vi: 7 ngày tạm ngưng trước khi tự động hủy
    parameters:
      grace_period_days: 7

computed_fields:
  - name: full_subdomain
    formula: "CONCAT(tenant_id, '.app.example.com')"
    description: Complete subdomain URL
    description_vi: URL subdomain hoàn chỉnh

  - name: user_count
    formula: "COUNT(users WHERE status != 'deleted')"
    description: Current active user count
    description_vi: Số người dùng đang hoạt động

  - name: storage_used_gb
    formula: "SUM(usage_records WHERE metric = 'storage') / 1024"
    description: Current storage usage in GB
    description_vi: Dung lượng lưu trữ đang sử dụng (GB)

  - name: is_trial
    formula: "type = 'trial' AND trial_ends_at > NOW()"
    description: Whether currently in trial period
    description_vi: Có đang trong thời gian dùng thử không

  - name: days_until_trial_end
    formula: "DATEDIFF(trial_ends_at, NOW())"
    description: Days remaining in trial
    description_vi: Số ngày còn lại trong dùng thử

  - name: is_over_user_limit
    formula: "user_count > user_limit"
    description: Whether user limit is exceeded
    description_vi: Có vượt quá giới hạn người dùng không

events:
  - name: tenant.created
    description: New tenant registered
    description_vi: Khách thuê mới đăng ký
    payload:
      - tenant_id
      - email
      - source
      - type
    triggers:
      - send_verification_email
      - create_audit_log
      - notify_sales_if_enterprise

  - name: tenant.activated
    description: Tenant fully activated
    description_vi: Khách thuê được kích hoạt đầy đủ
    payload:
      - tenant_id
      - activated_at
      - onboarding_completed
    triggers:
      - send_welcome_email
      - start_product_tour
      - track_activation_metric

  - name: tenant.suspended
    description: Tenant access suspended
    description_vi: Quyền truy cập khách thuê bị tạm ngưng
    payload:
      - tenant_id
      - suspension_reason
      - suspended_at
    triggers:
      - send_suspension_notice
      - alert_account_manager
      - restrict_access

  - name: tenant.cancelled
    description: Tenant subscription cancelled
    description_vi: Đăng ký khách thuê bị hủy
    payload:
      - tenant_id
      - cancellation_reason
      - cancellation_feedback
      - deletion_scheduled_at
    triggers:
      - send_cancellation_confirmation
      - offer_data_export
      - schedule_deletion_job
      - track_churn_metric

  - name: tenant.deleted
    description: Tenant data permanently deleted
    description_vi: Dữ liệu khách thuê bị xóa vĩnh viễn
    payload:
      - tenant_id
      - deleted_at
    triggers:
      - anonymize_audit_logs
      - remove_from_analytics
      - send_deletion_confirmation

  - name: tenant.trial_ending
    description: Trial period ending soon
    description_vi: Thời gian dùng thử sắp hết
    payload:
      - tenant_id
      - trial_ends_at
      - days_remaining
    triggers:
      - send_trial_reminder (7, 3, 1 days)
      - prompt_payment_method

  - name: tenant.upgraded
    description: Tenant upgraded to higher tier
    description_vi: Khách thuê nâng cấp lên gói cao hơn
    payload:
      - tenant_id
      - old_tier
      - new_tier
    triggers:
      - unlock_features
      - update_limits
      - send_upgrade_confirmation

  - name: tenant.downgraded
    description: Tenant downgraded to lower tier
    description_vi: Khách thuê hạ xuống gói thấp hơn
    payload:
      - tenant_id
      - old_tier
      - new_tier
      - effective_date
    triggers:
      - schedule_feature_restriction
      - send_downgrade_notice

validations:
  - field: tenant_id
    rules:
      - type: format
        pattern: "^[a-z0-9][a-z0-9-]{2,48}[a-z0-9]$"
        message: "Must be 4-50 characters, lowercase alphanumeric with hyphens"
      - type: unique
        scope: global
      - type: reserved_words
        list: [admin, api, app, www, mail, support, help, billing]

  - field: email
    rules:
      - type: email_format
      - type: unique
        scope: global
      - type: disposable_domain_blocked

  - field: custom_domain
    rules:
      - type: domain_format
      - type: unique
        scope: global
      - type: dns_verification_required

api_operations:
  - operation: create
    endpoint: POST /api/v1/tenants
    permissions: [platform_admin, self_service_signup]
    rate_limit: 10/hour
    validation: full

  - operation: read
    endpoint: GET /api/v1/tenants/{tenant_id}
    permissions: [tenant_admin, platform_admin]
    scoped_to_tenant: true

  - operation: update
    endpoint: PATCH /api/v1/tenants/{tenant_id}
    permissions: [tenant_admin]
    immutable_fields: [id, tenant_id, slug, created_at]
    scoped_to_tenant: true

  - operation: delete
    endpoint: DELETE /api/v1/tenants/{tenant_id}
    permissions: [tenant_owner, platform_admin]
    soft_delete: true
    confirmation_required: true

  - operation: list
    endpoint: GET /api/v1/tenants
    permissions: [platform_admin]
    filterable: [status, type, tier, created_at]
    sortable: [name, created_at, user_count]
    paginated: true
