name: User
display_name: User / Người dùng
description: |
  Represents an individual user within a tenant organization.
  Users are scoped to a tenant and have role-based permissions.

domain: saas-platform
entity_type: core
version: "1.0"

attributes:
  # Primary Identifiers
  - name: id
    type: uuid
    primary_key: true
    description: Internal unique identifier

  - name: tenant_id
    type: uuid
    foreign_key: tenant.id
    required: true
    description: Tenant this user belongs to
    description_vi: Khách thuê mà người dùng này thuộc về

  # Authentication
  - name: email
    type: email
    required: true
    max_length: 255
    description: User email (unique per tenant)
    description_vi: Email người dùng (duy nhất trong khách thuê)

  - name: phone
    type: string
    max_length: 20
    description: Phone number for 2FA
    description_vi: Số điện thoại cho 2FA

  - name: password_hash
    type: string
    max_length: 255
    private: true
    description: Hashed password (not exposed in API)
    description_vi: Mật khẩu đã băm

  - name: password_changed_at
    type: timestamp
    description: Last password change
    description_vi: Lần đổi mật khẩu cuối

  # Status
  - name: status
    type: enum
    values: [pending, active, suspended, deleted]
    default: pending
    description: User account status
    description_vi: Trạng thái tài khoản

  # Profile Information
  - name: first_name
    type: string
    max_length: 100
    description: First name
    description_vi: Tên

  - name: last_name
    type: string
    max_length: 100
    description: Last name
    description_vi: Họ

  - name: display_name
    type: string
    max_length: 255
    description: Display name (computed if not set)
    description_vi: Tên hiển thị

  - name: avatar_url
    type: url
    description: Profile picture URL
    description_vi: URL ảnh đại diện

  - name: job_title
    type: string
    max_length: 100
    description: Job title/position
    description_vi: Chức danh

  - name: department
    type: string
    max_length: 100
    description: Department
    description_vi: Phòng ban

  # Role & Permissions
  - name: role_id
    type: uuid
    foreign_key: role.id
    description: Assigned role
    description_vi: Vai trò được gán

  - name: is_owner
    type: boolean
    default: false
    description: Whether user is tenant owner
    description_vi: Người dùng có phải chủ sở hữu không
    note: "Exactly one owner per tenant"

  - name: custom_permissions
    type: json
    description: Additional permissions beyond role
    description_vi: Quyền bổ sung ngoài vai trò

  # Localization
  - name: timezone
    type: string
    default: "UTC"
    description: User's timezone
    description_vi: Múi giờ của người dùng

  - name: locale
    type: string
    default: "en"
    max_length: 10
    description: Preferred language
    description_vi: Ngôn ngữ ưa thích

  # Authentication Provider
  - name: auth_provider
    type: enum
    values: [email, google, microsoft, saml, github]
    default: email
    description: How user authenticates
    description_vi: Cách người dùng xác thực

  - name: auth_provider_id
    type: string
    max_length: 255
    description: ID from external auth provider
    description_vi: ID từ nhà cung cấp xác thực bên ngoài

  - name: email_verified
    type: boolean
    default: false
    description: Email verification status
    description_vi: Trạng thái xác minh email

  - name: email_verified_at
    type: timestamp
    description: When email was verified
    description_vi: Thời điểm xác minh email

  # Two-Factor Authentication
  - name: two_factor_enabled
    type: boolean
    default: false
    description: 2FA enabled status
    description_vi: Trạng thái bật 2FA

  - name: two_factor_secret
    type: string
    max_length: 255
    private: true
    description: TOTP secret (encrypted)
    description_vi: Bí mật TOTP (đã mã hóa)

  - name: two_factor_backup_codes
    type: json
    private: true
    description: Backup codes (hashed)
    description_vi: Mã dự phòng

  - name: two_factor_confirmed_at
    type: timestamp
    description: When 2FA was confirmed
    description_vi: Thời điểm xác nhận 2FA

  # Login Tracking
  - name: last_login_at
    type: timestamp
    description: Last successful login
    description_vi: Lần đăng nhập thành công cuối

  - name: last_login_ip
    type: string
    max_length: 45
    description: IP of last login
    description_vi: IP đăng nhập cuối

  - name: last_activity_at
    type: timestamp
    description: Last activity timestamp
    description_vi: Thời điểm hoạt động cuối

  - name: login_count
    type: integer
    default: 0
    description: Total login count
    description_vi: Tổng số lần đăng nhập

  # Security
  - name: failed_login_attempts
    type: integer
    default: 0
    description: Consecutive failed attempts
    description_vi: Số lần đăng nhập thất bại liên tiếp

  - name: locked_until
    type: timestamp
    description: Account locked until this time
    description_vi: Tài khoản bị khóa đến thời điểm này

  - name: lock_reason
    type: string
    max_length: 255
    description: Reason for account lock
    description_vi: Lý do khóa tài khoản

  # Invitation
  - name: invitation_token
    type: string
    max_length: 255
    private: true
    description: Token for accepting invitation
    description_vi: Token để chấp nhận lời mời

  - name: invitation_expires_at
    type: timestamp
    description: Invitation expiration
    description_vi: Thời hạn lời mời

  - name: invited_by
    type: uuid
    foreign_key: user.id
    description: User who sent the invitation
    description_vi: Người dùng đã gửi lời mời

  - name: invited_at
    type: timestamp
    description: When invitation was sent
    description_vi: Thời điểm gửi lời mời

  # Preferences
  - name: preferences
    type: json
    description: User preferences and settings
    description_vi: Tùy chọn và cài đặt người dùng
    schema:
      notifications:
        email_updates: boolean
        marketing: boolean
        product_news: boolean
      ui:
        theme: string
        sidebar_collapsed: boolean
        dashboard_layout: string

  # Audit
  - name: created_at
    type: timestamp
    auto: true

  - name: updated_at
    type: timestamp
    auto: true

  - name: deleted_at
    type: timestamp
    description: Soft delete timestamp

relationships:
  - name: tenant
    type: belongs_to
    target: Tenant
    foreign_key: tenant_id
    description: Tenant this user belongs to

  - name: role
    type: belongs_to
    target: Role
    foreign_key: role_id
    description: User's assigned role

  - name: inviter
    type: belongs_to
    target: User
    foreign_key: invited_by
    description: User who invited this user

  - name: invited_users
    type: has_many
    target: User
    foreign_key: invited_by
    description: Users invited by this user

  - name: audit_logs
    type: has_many
    target: AuditLog
    foreign_key: user_id
    description: Actions performed by this user

  - name: api_keys
    type: has_many
    target: ApiKey
    foreign_key: user_id
    description: API keys owned by this user

  - name: sessions
    type: has_many
    target: Session
    foreign_key: user_id
    description: Active sessions

state_machine:
  field: status
  initial: pending
  states:
    pending:
      description: Invited but not yet accepted
      description_vi: Đã mời nhưng chưa chấp nhận
    active:
      description: Active user with full access
      description_vi: Người dùng hoạt động với quyền đầy đủ
    suspended:
      description: Temporarily disabled
      description_vi: Tạm thời bị vô hiệu hóa
    deleted:
      description: Soft deleted, data retained
      description_vi: Xóa mềm, dữ liệu được giữ lại

  transitions:
    - from: pending
      to: active
      event: accept_invitation
      description: User accepts invitation and sets password
      conditions:
        - valid_invitation_token
        - invitation_not_expired
      actions:
        - clear invitation_token
        - set email_verified = true
        - send welcome email

    - from: active
      to: suspended
      event: suspend
      description: Admin suspends user
      actions:
        - revoke_all_sessions
        - send suspension notice

    - from: suspended
      to: active
      event: reactivate
      description: Admin reactivates user
      actions:
        - send reactivation notice

    - from: active
      to: deleted
      event: delete
      description: User is deleted
      actions:
        - revoke_all_sessions
        - anonymize_personal_data (if GDPR)
        - retain for audit purposes

    - from: pending
      to: deleted
      event: expire_invitation
      description: Invitation expired without acceptance
      conditions:
        - invitation_expires_at <= NOW()
      actions:
        - clear invitation data

indexes:
  - name: idx_user_tenant_email
    columns: [tenant_id, email]
    unique: true
    description: Email unique per tenant

  - name: idx_user_tenant_status
    columns: [tenant_id, status]
    description: Filter users by tenant and status

  - name: idx_user_email_global
    columns: [email]
    description: Cross-tenant email lookup for login

  - name: idx_user_invitation_token
    columns: [invitation_token]
    unique: true
    where: "invitation_token IS NOT NULL"
    description: Invitation token lookup

  - name: idx_user_auth_provider
    columns: [auth_provider, auth_provider_id]
    where: "auth_provider != 'email'"
    description: SSO provider lookup

  - name: idx_user_last_activity
    columns: [tenant_id, last_activity_at]
    description: Active user queries

business_rules:
  - id: BR-USR-001
    name: Email Unique Per Tenant
    description: Email must be unique within a tenant
    description_vi: Email phải duy nhất trong một khách thuê
    severity: critical

  - id: BR-USR-002
    name: Owner Cannot Be Deleted
    description: Tenant owner cannot be deleted, only transferred
    description_vi: Chủ sở hữu khách thuê không thể bị xóa, chỉ có thể chuyển nhượng
    severity: critical

  - id: BR-USR-003
    name: Account Lock After Failed Attempts
    description: Account locked after 5 consecutive failed login attempts
    description_vi: Tài khoản bị khóa sau 5 lần đăng nhập thất bại liên tiếp
    parameters:
      max_attempts: 5
      lock_duration_minutes: 30

  - id: BR-USR-004
    name: Invitation Expiry
    description: Invitations expire after 7 days
    description_vi: Lời mời hết hạn sau 7 ngày
    parameters:
      expiry_days: 7

  - id: BR-USR-005
    name: Password Requirements
    description: Password must be at least 8 characters with complexity
    description_vi: Mật khẩu phải ít nhất 8 ký tự với độ phức tạp
    parameters:
      min_length: 8
      require_uppercase: true
      require_lowercase: true
      require_number: true
      require_special: false

  - id: BR-USR-010
    name: Single Owner
    description: Exactly one user must be owner per tenant
    description_vi: Chính xác một người dùng phải là chủ sở hữu mỗi khách thuê
    severity: critical

  - id: BR-USR-011
    name: Owner Transfer
    description: Ownership can only be transferred, not removed
    description_vi: Quyền sở hữu chỉ có thể chuyển nhượng, không thể xóa

  - id: BR-USR-020
    name: SSO Users No Password
    description: SSO users cannot set local password
    description_vi: Người dùng SSO không thể đặt mật khẩu cục bộ
    condition: "auth_provider != 'email' IMPLIES password_hash IS NULL"

  - id: BR-USR-021
    name: 2FA Enforcement
    description: Enterprise tier may enforce 2FA for all users
    description_vi: Gói enterprise có thể bắt buộc 2FA cho tất cả người dùng

computed_fields:
  - name: full_name
    formula: "CONCAT(first_name, ' ', last_name)"
    description: Full name

  - name: effective_display_name
    formula: "COALESCE(display_name, full_name, email)"
    description: Name to display in UI

  - name: is_locked
    formula: "locked_until IS NOT NULL AND locked_until > NOW()"
    description: Whether account is currently locked

  - name: is_invited
    formula: "status = 'pending' AND invitation_token IS NOT NULL"
    description: Whether user has pending invitation

  - name: days_since_login
    formula: "DATEDIFF(NOW(), last_login_at)"
    description: Days since last login

  - name: is_inactive
    formula: "days_since_login > 90"
    description: User inactive for 90+ days

events:
  - name: user.created
    description: New user created (usually via invitation)
    payload: [user_id, tenant_id, email, invited_by]
    triggers: [send_invitation_email]

  - name: user.activated
    description: User accepted invitation and activated
    payload: [user_id, tenant_id]
    triggers: [send_welcome_email, track_activation]

  - name: user.logged_in
    description: Successful login
    payload: [user_id, tenant_id, ip, user_agent]
    triggers: [update_login_stats, check_suspicious_activity]

  - name: user.login_failed
    description: Failed login attempt
    payload: [email, ip, reason]
    triggers: [increment_failed_attempts, check_lock_threshold]

  - name: user.locked
    description: Account locked due to failed attempts
    payload: [user_id, locked_until, reason]
    triggers: [send_lock_notification, alert_admin]

  - name: user.suspended
    description: User suspended by admin
    payload: [user_id, suspended_by, reason]
    triggers: [revoke_sessions, send_suspension_email]

  - name: user.password_changed
    description: Password was changed
    payload: [user_id, changed_by]
    triggers: [revoke_other_sessions, send_password_changed_email]

  - name: user.two_factor_enabled
    description: 2FA enabled
    payload: [user_id]
    triggers: [log_security_event]

  - name: user.deleted
    description: User deleted
    payload: [user_id, deleted_by]
    triggers: [revoke_sessions, anonymize_if_required]
