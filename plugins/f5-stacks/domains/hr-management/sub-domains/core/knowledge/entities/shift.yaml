name: shift
display_name: Shift
description: |
  Work shift definition entity for managing different work schedules,
  timing, breaks, and shift-based attendance rules.

domain: hr-management
subdomain: core
category: entities
version: "1.0.0"
status: active

entity:
  name: Shift
  table_name: shifts
  primary_key: id

  attributes:
    # Identification
    identification:
      - name: id
        type: uuid
        required: true
        description: "System-generated unique identifier"

      - name: shift_code
        type: string
        required: true
        unique: true
        max_length: 20
        description: "Shift code"

      - name: name
        type: string
        required: true
        max_length: 100
        description: "Shift name"

      - name: description
        type: text
        description: "Shift description"

      - name: status
        type: enum
        required: true
        default: "active"
        values: [active, inactive]
        description: "Shift status"

    # Classification
    classification:
      - name: shift_type
        type: enum
        required: true
        values:
          - regular
          - split
          - rotating
          - flexible
          - night
        description: "Type of shift"

      - name: is_default
        type: boolean
        default: false
        description: "Whether this is the default shift"

      - name: is_night_shift
        type: boolean
        default: false
        description: "Whether this is a night shift"

    # Timing
    timing:
      - name: start_time
        type: time
        required: true
        description: "Shift start time"

      - name: end_time
        type: time
        required: true
        description: "Shift end time"

      - name: duration_hours
        type: decimal
        precision: 4
        scale: 2
        description: "Total shift duration in hours"

      - name: crosses_midnight
        type: boolean
        default: false
        description: "Whether shift crosses midnight"

      - name: grace_period_minutes
        type: integer
        default: 15
        description: "Grace period for check-in"

      - name: early_check_in_minutes
        type: integer
        default: 30
        description: "How early employees can check in"

      - name: late_check_out_minutes
        type: integer
        default: 60
        description: "Buffer for late check-out"

    # Break
    breaks:
      - name: break_duration_minutes
        type: integer
        default: 60
        description: "Standard break duration"

      - name: break_start_time
        type: time
        description: "Scheduled break start"

      - name: break_end_time
        type: time
        description: "Scheduled break end"

      - name: break_deducted
        type: boolean
        default: true
        description: "Whether break is deducted from hours"

      - name: multiple_breaks
        type: jsonb
        description: "Array of break periods"
        schema:
          type: array
          items:
            name: string
            start_time: time
            end_time: time
            duration_minutes: integer
            paid: boolean

    # Working Hours
    working_hours:
      - name: work_hours
        type: decimal
        precision: 4
        scale: 2
        description: "Net working hours (excluding breaks)"

      - name: minimum_hours
        type: decimal
        precision: 4
        scale: 2
        description: "Minimum hours for full day"

      - name: half_day_hours
        type: decimal
        precision: 4
        scale: 2
        description: "Hours for half day"

    # Working Days
    working_days:
      - name: working_days
        type: jsonb
        description: "Working days configuration"
        schema:
          monday: boolean
          tuesday: boolean
          wednesday: boolean
          thursday: boolean
          friday: boolean
          saturday: boolean
          sunday: boolean
        default:
          monday: true
          tuesday: true
          wednesday: true
          thursday: true
          friday: true
          saturday: true
          sunday: false

      - name: days_per_week
        type: integer
        default: 6
        description: "Working days per week"

    # Overtime
    overtime:
      - name: overtime_start_after
        type: decimal
        description: "Hours after which overtime begins"

      - name: auto_approve_overtime_minutes
        type: integer
        default: 0
        description: "Minutes of overtime auto-approved"

    # Attendance Rules
    attendance_rules:
      - name: late_threshold_minutes
        type: integer
        default: 15
        description: "Minutes after which marked late"

      - name: half_day_threshold_hours
        type: decimal
        default: 4
        description: "Hours for half-day attendance"

      - name: absent_if_less_than_hours
        type: decimal
        default: 2
        description: "Mark absent if worked less than X hours"

      - name: require_check_out
        type: boolean
        default: true
        description: "Whether check-out is required"

    # Flexibility
    flexibility:
      - name: flexible_start
        type: boolean
        default: false
        description: "Allow flexible start time"

      - name: flexible_start_window
        type: jsonb
        description: "Flexible start time window"
        schema:
          earliest: time
          latest: time

      - name: core_hours_start
        type: time
        description: "Core hours start (for flexible)"

      - name: core_hours_end
        type: time
        description: "Core hours end (for flexible)"

    # Display
    display:
      - name: color
        type: string
        description: "Color for calendar display"

      - name: sort_order
        type: integer
        default: 0
        description: "Display order"

    # System
    system:
      - name: created_at
        type: timestamp
        auto_generate: true

      - name: updated_at
        type: timestamp
        auto_update: true

      - name: created_by
        type: uuid
        foreign_key: users.id

      - name: updated_by
        type: uuid
        foreign_key: users.id

  relationships:
    - name: employees
      type: has_many
      entity: Employee
      foreign_key: work_schedule_id
      description: "Employees assigned to this shift"

    - name: attendance_records
      type: has_many
      entity: Attendance
      foreign_key: shift_id
      description: "Attendance records for this shift"

  indexes:
    - columns: [shift_code]
      unique: true
    - columns: [status]
    - columns: [shift_type]
    - columns: [is_default]

  seed_data:
    - shift_code: "DAY"
      name: "Ca ngày"
      description: "Standard day shift"
      shift_type: regular
      is_default: true
      start_time: "08:00"
      end_time: "17:00"
      duration_hours: 9
      break_duration_minutes: 60
      break_start_time: "12:00"
      break_end_time: "13:00"
      work_hours: 8
      working_days:
        monday: true
        tuesday: true
        wednesday: true
        thursday: true
        friday: true
        saturday: true
        sunday: false

    - shift_code: "NIGHT"
      name: "Ca đêm"
      description: "Night shift"
      shift_type: night
      is_night_shift: true
      start_time: "22:00"
      end_time: "06:00"
      duration_hours: 8
      crosses_midnight: true
      break_duration_minutes: 30
      work_hours: 7.5

    - shift_code: "FLEX"
      name: "Ca linh hoạt"
      description: "Flexible hours shift"
      shift_type: flexible
      flexible_start: true
      flexible_start_window:
        earliest: "07:00"
        latest: "10:00"
      core_hours_start: "10:00"
      core_hours_end: "16:00"
      work_hours: 8

  validations:
    - field: end_time
      rule: "valid_duration"
      message: "Shift must have valid duration"

    - field: work_hours
      rule: "max_8_standard"
      message: "Standard shift should not exceed 8 hours"

  hooks:
    before_create:
      - calculate_duration
      - validate_break_times

    after_update:
      - notify_affected_employees
      - recalculate_attendance

  audit:
    enabled: true
    tracked_fields:
      - start_time
      - end_time
      - work_hours
      - status
    retention: "permanent"
