name: position
display_name: Position
description: |
  Job position entity defining roles, responsibilities, requirements,
  and compensation bands within the organization.

domain: hr-management
subdomain: core
category: entities
version: "1.0.0"
status: active

entity:
  name: Position
  table_name: positions
  primary_key: id

  attributes:
    # Identification
    identification:
      - name: id
        type: uuid
        required: true
        description: "System-generated unique identifier"

      - name: position_code
        type: string
        required: true
        unique: true
        max_length: 20
        format: "POS-XXXX"
        description: "Position code"

      - name: title
        type: string
        required: true
        max_length: 200
        description: "Position title"

      - name: title_en
        type: string
        max_length: 200
        description: "Position title in English"

      - name: description
        type: text
        description: "Position description and purpose"

      - name: status
        type: enum
        required: true
        default: "active"
        values:
          - active
          - inactive
          - frozen
          - archived
        description: "Position status"

    # Classification
    classification:
      - name: job_family
        type: string
        description: "Job family grouping"
        examples:
          - Engineering
          - Finance
          - Human Resources
          - Sales
          - Operations

      - name: job_subfamily
        type: string
        description: "Job subfamily within family"

      - name: job_level
        type: enum
        required: true
        values:
          - intern
          - entry
          - junior
          - mid
          - senior
          - lead
          - manager
          - senior_manager
          - director
          - senior_director
          - vp
          - svp
          - c_level
        description: "Job level in career ladder"

      - name: grade_min
        type: string
        description: "Minimum grade for this position"

      - name: grade_max
        type: string
        description: "Maximum grade for this position"

      - name: is_management
        type: boolean
        default: false
        description: "Whether this is a management position"

      - name: is_key_position
        type: boolean
        default: false
        description: "Whether this is a key/critical position"

    # Organization
    organization:
      - name: department_id
        type: uuid
        required: true
        foreign_key: departments.id
        description: "Department this position belongs to"

      - name: reports_to_position_id
        type: uuid
        foreign_key: positions.id
        description: "Position this role reports to"

      - name: location_ids
        type: jsonb
        description: "Array of work location IDs where position exists"

    # Job Details
    job_details:
      - name: responsibilities
        type: jsonb
        description: "Array of key responsibilities"
        schema:
          type: array
          items:
            type: string

      - name: requirements
        type: jsonb
        description: "Array of job requirements"
        schema:
          type: array
          items:
            type: object
            properties:
              category: string  # education, experience, skill
              description: string
              required: boolean

      - name: competencies
        type: jsonb
        description: "Required competencies with levels"
        schema:
          type: array
          items:
            competency_id: uuid
            competency_name: string
            required_level: integer  # 1-5

      - name: qualifications
        type: jsonb
        description: "Required qualifications"
        schema:
          type: object
          properties:
            education_level: string
            certifications: array
            experience_years: integer

    # Compensation
    compensation:
      - name: salary_band_min
        type: decimal
        precision: 15
        scale: 2
        description: "Minimum salary for this position"

      - name: salary_band_mid
        type: decimal
        precision: 15
        scale: 2
        description: "Midpoint salary for this position"

      - name: salary_band_max
        type: decimal
        precision: 15
        scale: 2
        description: "Maximum salary for this position"

      - name: currency
        type: string
        default: "VND"
        description: "Salary currency"

      - name: bonus_target_percent
        type: decimal
        description: "Target bonus as percentage of salary"

    # Headcount
    headcount:
      - name: budgeted_headcount
        type: integer
        default: 1
        description: "Approved headcount for this position"

      - name: current_headcount
        type: integer
        computed: true
        description: "Current filled positions"

      - name: available_headcount
        type: integer
        computed: true
        formula: "budgeted_headcount - current_headcount"
        description: "Open positions available"

    # Work Details
    work_details:
      - name: work_type
        type: enum
        default: "on_site"
        values:
          - on_site
          - remote
          - hybrid
        description: "Work arrangement type"

      - name: travel_required
        type: enum
        default: "none"
        values:
          - none
          - occasional
          - frequent
          - extensive
        description: "Travel requirement"

      - name: work_hours
        type: string
        description: "Standard work hours"

      - name: overtime_eligible
        type: boolean
        default: true
        description: "Whether eligible for overtime pay"

    # System
    system:
      - name: effective_date
        type: date
        description: "Date position became active"

      - name: end_date
        type: date
        description: "Date position was deactivated"

      - name: created_at
        type: timestamp
        auto_generate: true

      - name: updated_at
        type: timestamp
        auto_update: true

      - name: created_by
        type: uuid
        foreign_key: users.id

      - name: updated_by
        type: uuid
        foreign_key: users.id

  relationships:
    - name: department
      type: belongs_to
      entity: Department
      foreign_key: department_id
      description: "Department this position belongs to"

    - name: reports_to
      type: belongs_to
      entity: Position
      foreign_key: reports_to_position_id
      description: "Superior position in hierarchy"

    - name: direct_reports
      type: has_many
      entity: Position
      foreign_key: reports_to_position_id
      description: "Positions that report to this one"

    - name: employees
      type: has_many
      entity: Employee
      foreign_key: position_id
      description: "Employees in this position"

    - name: job_postings
      type: has_many
      entity: JobPosting
      foreign_key: position_id
      description: "Active job postings for this position"

  indexes:
    - columns: [position_code]
      unique: true
    - columns: [department_id]
    - columns: [job_family]
    - columns: [job_level]
    - columns: [status]
    - columns: [reports_to_position_id]

  validations:
    - field: salary_band_max
      rule: "must_be_greater_than_min"
      message: "Maximum salary must be greater than minimum"

    - field: budgeted_headcount
      rule: "must_be_positive"
      message: "Budgeted headcount must be positive"

    - field: reports_to_position_id
      rule: "cannot_report_to_self"
      message: "Position cannot report to itself"

  hooks:
    before_create:
      - generate_position_code
      - validate_salary_band

    after_create:
      - update_department_positions
      - notify_hr_admin

    before_update:
      - validate_headcount_change
      - check_salary_band_impact

    after_update:
      - sync_employee_grades
      - update_org_chart

  audit:
    enabled: true
    tracked_fields:
      - title
      - department_id
      - job_level
      - salary_band_min
      - salary_band_max
      - budgeted_headcount
      - status
    retention: "permanent"
