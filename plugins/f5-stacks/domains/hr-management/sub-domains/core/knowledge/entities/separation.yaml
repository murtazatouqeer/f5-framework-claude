name: separation
display_name: Separation
description: |
  Separation entity for managing employee exits including resignation,
  termination, retirement, and the offboarding process.

domain: hr-management
subdomain: core
category: entities
version: "1.0.0"
status: active

compliance:
  vietnam_labor_code:
    notice_periods:
      indefinite_contract: "45 days"
      definite_contract: "30 days"
      probation: "3 days"
    final_settlement: "Within 14 days of separation"
    severance_pay: "0.5 month salary per year of service"
    unemployment_insurance: "Employee eligible to claim"

entity:
  name: Separation
  table_name: separations
  primary_key: id

  attributes:
    # Identification
    identification:
      - name: id
        type: uuid
        required: true
        description: "System-generated unique identifier"

      - name: separation_id
        type: string
        required: true
        unique: true
        format: "SEP-YYYY-XXXXXX"
        description: "Separation reference number"

      - name: employee_id
        type: uuid
        required: true
        foreign_key: employees.id
        description: "Separating employee"

      - name: status
        type: enum
        required: true
        default: "initiated"
        values:
          - initiated
          - notice_period
          - handover_in_progress
          - clearance_in_progress
          - exit_interview_pending
          - settlement_pending
          - completed
          - cancelled
        description: "Separation status"

    # Separation Type
    separation_type:
      - name: separation_type
        type: enum
        required: true
        values:
          - resignation
          - termination_for_cause
          - termination_without_cause
          - mutual_agreement
          - redundancy
          - end_of_contract
          - retirement
          - death
          - abandonment
        description: "Type of separation"

      - name: separation_category
        type: enum
        values:
          - voluntary
          - involuntary
          - other
        description: "Separation category"

      - name: initiated_by
        type: enum
        required: true
        values:
          - employee
          - employer
          - mutual
          - automatic
        description: "Who initiated separation"

    # Dates
    dates:
      - name: initiation_date
        type: date
        required: true
        description: "Date separation was initiated"

      - name: notice_date
        type: date
        description: "Date notice was given"

      - name: last_working_day
        type: date
        required: true
        description: "Last day of work"

      - name: effective_date
        type: date
        required: true
        description: "Separation effective date"

      - name: contract_end_date
        type: date
        description: "Original contract end date"

    # Notice Period
    notice:
      - name: required_notice_days
        type: integer
        description: "Required notice period (days)"

      - name: actual_notice_days
        type: integer
        computed: true
        description: "Actual notice given"

      - name: notice_shortfall_days
        type: integer
        computed: true
        description: "Days short of required notice"

      - name: notice_waived
        type: boolean
        default: false
        description: "Whether notice was waived"

      - name: waiver_reason
        type: text
        description: "Reason for waiving notice"

      - name: payment_in_lieu
        type: boolean
        default: false
        description: "Payment in lieu of notice"

      - name: garden_leave
        type: boolean
        default: false
        description: "On garden leave during notice"

    # Reason
    reason:
      - name: primary_reason
        type: enum
        values:
          - better_opportunity
          - career_change
          - relocation
          - personal_reasons
          - health_reasons
          - education
          - compensation
          - work_environment
          - management_issues
          - lack_of_growth
          - job_dissatisfaction
          - performance
          - misconduct
          - redundancy
          - business_closure
          - contract_completion
          - retirement_age
          - other
        description: "Primary reason for leaving"

      - name: secondary_reasons
        type: jsonb
        description: "Additional reasons"

      - name: reason_details
        type: text
        description: "Detailed explanation"

      - name: regrettable
        type: boolean
        description: "Whether loss is regrettable"

      - name: regrettable_reason
        type: text
        description: "Why considered regrettable"

    # Documentation
    documentation:
      - name: resignation_letter_url
        type: string
        description: "URL to resignation letter"

      - name: termination_letter_url
        type: string
        description: "URL to termination letter"

      - name: acceptance_letter_url
        type: string
        description: "URL to acceptance letter"

      - name: separation_agreement_url
        type: string
        description: "URL to separation agreement"

      - name: release_letter_url
        type: string
        description: "URL to release/experience letter"

    # Handover
    handover:
      - name: handover_required
        type: boolean
        default: true
        description: "Whether handover is required"

      - name: handover_to_id
        type: uuid
        foreign_key: employees.id
        description: "Person taking over responsibilities"

      - name: handover_plan
        type: text
        description: "Handover plan"

      - name: handover_items
        type: jsonb
        description: "Items to hand over"
        schema:
          type: array
          items:
            item: string
            status: string  # pending, in_progress, completed
            notes: string

      - name: handover_completed
        type: boolean
        default: false
        description: "Handover completed"

      - name: handover_completion_date
        type: date
        description: "When handover was completed"

    # Clearance
    clearance:
      - name: clearance_status
        type: jsonb
        description: "Departmental clearance status"
        schema:
          type: array
          items:
            department: string
            status: string  # pending, cleared, issue
            cleared_by: uuid
            cleared_date: date
            notes: string
        default:
          - department: "IT"
            status: "pending"
          - department: "Finance"
            status: "pending"
          - department: "Admin"
            status: "pending"
          - department: "HR"
            status: "pending"

      - name: all_cleared
        type: boolean
        computed: true
        description: "All departments cleared"

      - name: outstanding_items
        type: jsonb
        description: "Outstanding items to return"

    # Exit Interview
    exit_interview:
      - name: exit_interview_scheduled
        type: boolean
        default: false
        description: "Exit interview scheduled"

      - name: exit_interview_date
        type: date
        description: "Exit interview date"

      - name: exit_interview_completed
        type: boolean
        default: false
        description: "Exit interview completed"

      - name: exit_interviewer_id
        type: uuid
        foreign_key: employees.id
        description: "Who conducted interview"

      - name: exit_interview_notes
        type: text
        description: "Interview notes"

      - name: feedback_themes
        type: jsonb
        description: "Key feedback themes"

      - name: rehire_eligible
        type: boolean
        description: "Eligible for rehire"

      - name: rehire_notes
        type: text
        description: "Rehire eligibility notes"

    # Settlement
    settlement:
      - name: settlement_calculated
        type: boolean
        default: false
        description: "Settlement calculated"

      - name: settlement_components
        type: jsonb
        description: "Settlement breakdown"
        schema:
          remaining_salary: decimal
          notice_pay: decimal
          leave_encashment: decimal
          severance_pay: decimal
          bonus_prorated: decimal
          other_dues: decimal
          total_payable: decimal
          deductions: array
          loan_recovery: decimal
          advance_recovery: decimal
          other_deductions: decimal
          net_settlement: decimal

      - name: net_settlement_amount
        type: decimal
        precision: 15
        scale: 2
        description: "Net settlement amount"

      - name: settlement_currency
        type: string
        default: "VND"
        description: "Settlement currency"

      - name: settlement_approved
        type: boolean
        default: false
        description: "Settlement approved"

      - name: settlement_approved_by
        type: uuid
        foreign_key: employees.id
        description: "Who approved settlement"

      - name: settlement_paid
        type: boolean
        default: false
        description: "Settlement paid"

      - name: settlement_payment_date
        type: date
        description: "Payment date"

      - name: settlement_payment_reference
        type: string
        description: "Payment reference"

    # Approvals
    approvals:
      - name: manager_approved
        type: boolean
        default: false
        description: "Manager approved"

      - name: manager_approved_date
        type: date
        description: "Manager approval date"

      - name: hr_approved
        type: boolean
        default: false
        description: "HR approved"

      - name: hr_approved_date
        type: date
        description: "HR approval date"

      - name: final_approver_id
        type: uuid
        foreign_key: employees.id
        description: "Final approver"

      - name: final_approved_date
        type: date
        description: "Final approval date"

    # Post-Separation
    post_separation:
      - name: experience_letter_issued
        type: boolean
        default: false
        description: "Experience letter issued"

      - name: full_and_final_signed
        type: boolean
        default: false
        description: "Full and final signed"

      - name: insurance_terminated
        type: boolean
        default: false
        description: "Insurance terminated"

      - name: bhxh_book_returned
        type: boolean
        default: false
        description: "BHXH book returned"

      - name: tax_finalization_done
        type: boolean
        default: false
        description: "Tax finalization completed"

      - name: alumni_registered
        type: boolean
        default: false
        description: "Registered in alumni network"

    # System
    system:
      - name: created_at
        type: timestamp
        auto_generate: true

      - name: updated_at
        type: timestamp
        auto_update: true

      - name: created_by
        type: uuid
        foreign_key: users.id

      - name: updated_by
        type: uuid
        foreign_key: users.id

  relationships:
    - name: employee
      type: belongs_to
      entity: Employee
      foreign_key: employee_id
      description: "Separating employee"

    - name: handover_person
      type: belongs_to
      entity: Employee
      foreign_key: handover_to_id
      description: "Handover recipient"

    - name: exit_interviewer
      type: belongs_to
      entity: Employee
      foreign_key: exit_interviewer_id
      description: "Exit interviewer"

  state_machine:
    field: status
    initial: initiated
    transitions:
      - from: initiated
        to: notice_period
        event: accept_separation
        actions:
          - calculate_last_day
          - notify_stakeholders

      - from: notice_period
        to: handover_in_progress
        event: start_handover
        actions:
          - create_handover_tasks

      - from: handover_in_progress
        to: clearance_in_progress
        event: complete_handover
        actions:
          - initiate_clearance

      - from: clearance_in_progress
        to: exit_interview_pending
        event: complete_clearance
        conditions:
          - all_cleared

      - from: exit_interview_pending
        to: settlement_pending
        event: complete_exit_interview
        actions:
          - calculate_settlement

      - from: settlement_pending
        to: completed
        event: process_settlement
        conditions:
          - settlement_paid
        actions:
          - terminate_employee
          - revoke_access
          - archive_records

      - from: [initiated, notice_period]
        to: cancelled
        event: cancel_separation
        conditions:
          - cancellation_approved
        actions:
          - notify_stakeholders
          - restore_status

  indexes:
    - columns: [separation_id]
      unique: true
    - columns: [employee_id]
    - columns: [status]
    - columns: [separation_type]
    - columns: [last_working_day]
    - columns: [effective_date]

  validations:
    - field: last_working_day
      rule: "must_respect_notice_period"
      message: "Last working day must respect notice period"

    - field: effective_date
      rule: "must_be_on_or_after_last_working_day"
      message: "Effective date must be on or after last working day"

  hooks:
    before_create:
      - generate_separation_id
      - calculate_notice_requirement
      - determine_settlement_eligibility

    after_initiate:
      - notify_manager
      - notify_hr
      - block_new_assignments

    after_complete:
      - update_employee_status
      - generate_reports
      - update_headcount

  notifications:
    - event: initiated
      recipients: [manager, hr_admin]
      template: "separation_initiated"

    - event: last_day_reminder
      recipients: [employee, manager, hr_admin]
      template: "last_day_reminder"
      timing: "3 days before"

    - event: completed
      recipients: [hr_admin, finance]
      template: "separation_completed"

  audit:
    enabled: true
    tracked_fields:
      - status
      - last_working_day
      - net_settlement_amount
      - settlement_paid
    retention: "10 years"
