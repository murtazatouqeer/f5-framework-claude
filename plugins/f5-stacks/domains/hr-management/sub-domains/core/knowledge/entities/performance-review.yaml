name: performance-review
display_name: Performance Review
description: |
  Performance review entity for employee appraisals including self-assessment,
  manager evaluation, ratings, competency scores, and development planning.

domain: hr-management
subdomain: core
category: entities
version: "1.0.0"
status: active

entity:
  name: PerformanceReview
  table_name: performance_reviews
  primary_key: id

  attributes:
    # Identification
    identification:
      - name: id
        type: uuid
        required: true
        description: "System-generated unique identifier"

      - name: review_id
        type: string
        required: true
        unique: true
        format: "PR-YYYY-XXXXXX"
        description: "Review reference number"

      - name: employee_id
        type: uuid
        required: true
        foreign_key: employees.id
        description: "Employee being reviewed"

      - name: manager_id
        type: uuid
        required: true
        foreign_key: employees.id
        description: "Reviewing manager"

      - name: status
        type: enum
        required: true
        default: "draft"
        values:
          - draft
          - self_review
          - manager_review
          - calibration
          - pending_acknowledgment
          - completed
          - cancelled
        description: "Review status"

    # Review Type
    review_type:
      - name: review_type
        type: enum
        required: true
        values:
          - annual
          - mid_year
          - quarterly
          - probation
          - project
          - adhoc
        description: "Type of performance review"

      - name: review_cycle_id
        type: uuid
        description: "Reference to review cycle"

    # Period
    period:
      - name: review_period_start
        type: date
        required: true
        description: "Review period start date"

      - name: review_period_end
        type: date
        required: true
        description: "Review period end date"

      - name: review_year
        type: integer
        required: true
        description: "Review year"

      - name: review_quarter
        type: integer
        description: "Review quarter (1-4)"

    # Goals Performance
    goals:
      - name: goals
        type: jsonb
        description: "Array of goals and achievements"
        schema:
          type: array
          items:
            goal_id: uuid
            goal_title: string
            target: string
            achievement: string
            weight: decimal
            self_score: integer  # 1-5
            manager_score: integer  # 1-5
            final_score: integer
            comments: string

      - name: goals_weight
        type: integer
        default: 70
        description: "Weight of goals in overall rating"

      - name: goals_achievement_score
        type: decimal
        precision: 4
        scale: 2
        computed: true
        description: "Weighted goals achievement score"

    # Competencies
    competencies:
      - name: competency_scores
        type: jsonb
        description: "Competency assessment scores"
        schema:
          type: array
          items:
            competency_id: uuid
            competency_name: string
            expected_level: integer
            self_score: integer
            manager_score: integer
            final_score: integer
            examples: string

      - name: competencies_weight
        type: integer
        default: 30
        description: "Weight of competencies in overall rating"

      - name: competencies_average_score
        type: decimal
        precision: 4
        scale: 2
        computed: true
        description: "Average competency score"

    # Ratings
    ratings:
      - name: self_rating
        type: integer
        min: 1
        max: 5
        description: "Employee self-rating"

      - name: manager_rating
        type: integer
        min: 1
        max: 5
        description: "Manager's rating"

      - name: calibrated_rating
        type: integer
        min: 1
        max: 5
        description: "Rating after calibration"

      - name: final_rating
        type: integer
        min: 1
        max: 5
        description: "Final performance rating"

      - name: rating_label
        type: string
        computed: true
        description: "Rating label"
        mapping:
          1: "Needs Improvement"
          2: "Below Expectations"
          3: "Meets Expectations"
          4: "Exceeds Expectations"
          5: "Outstanding"

      - name: previous_rating
        type: integer
        description: "Rating from previous review"

      - name: rating_trend
        type: enum
        values: [improving, stable, declining]
        computed: true
        description: "Trend compared to previous"

    # Self Assessment
    self_assessment:
      - name: self_assessment
        type: text
        description: "Employee's self-assessment narrative"

      - name: achievements
        type: jsonb
        description: "Key achievements during period"
        schema:
          type: array
          items:
            achievement: string
            impact: string
            date: date

      - name: challenges
        type: text
        description: "Challenges faced during period"

      - name: support_needed
        type: text
        description: "Support needed from manager/company"

    # Manager Feedback
    manager_feedback:
      - name: manager_overall_feedback
        type: text
        description: "Manager's overall feedback"

      - name: strengths
        type: jsonb
        description: "Identified strengths"
        schema:
          type: array
          items:
            type: string

      - name: areas_for_improvement
        type: jsonb
        description: "Areas needing improvement"
        schema:
          type: array
          items:
            type: string

      - name: development_suggestions
        type: text
        description: "Manager's development suggestions"

    # Outcomes
    outcomes:
      - name: promotion_recommended
        type: boolean
        default: false
        description: "Whether promotion is recommended"

      - name: promotion_notes
        type: text
        description: "Notes on promotion recommendation"

      - name: salary_increase_recommended
        type: boolean
        default: false
        description: "Whether salary increase is recommended"

      - name: recommended_increase_percent
        type: decimal
        description: "Recommended salary increase percentage"

      - name: bonus_recommendation
        type: enum
        values:
          - no_bonus
          - partial_bonus
          - target_bonus
          - above_target
          - exceptional
        description: "Bonus recommendation"

      - name: pip_required
        type: boolean
        default: false
        description: "Whether PIP is required"

      - name: training_recommendations
        type: jsonb
        description: "Recommended training programs"

    # Development Plan
    development_plan:
      - name: development_goals
        type: jsonb
        description: "Development goals for next period"
        schema:
          type: array
          items:
            goal: string
            action_items: array
            timeline: string
            success_criteria: string

      - name: career_aspirations
        type: text
        description: "Employee's career aspirations"

      - name: manager_career_feedback
        type: text
        description: "Manager's feedback on career path"

    # Sign-off
    signoff:
      - name: employee_comments
        type: text
        description: "Employee's final comments"

      - name: employee_acknowledged
        type: boolean
        default: false
        description: "Employee has acknowledged"

      - name: employee_acknowledged_at
        type: timestamp
        description: "When employee acknowledged"

      - name: employee_agrees
        type: boolean
        description: "Whether employee agrees with rating"

      - name: disagreement_reason
        type: text
        description: "Reason if employee disagrees"

      - name: manager_signed_at
        type: timestamp
        description: "When manager signed off"

      - name: hr_reviewed_at
        type: timestamp
        description: "When HR reviewed"

      - name: hr_reviewer_id
        type: uuid
        foreign_key: employees.id
        description: "HR reviewer"

    # Calibration
    calibration:
      - name: calibrated
        type: boolean
        default: false
        description: "Whether review was calibrated"

      - name: calibration_session_id
        type: uuid
        description: "Calibration session reference"

      - name: pre_calibration_rating
        type: integer
        description: "Rating before calibration"

      - name: calibration_notes
        type: text
        description: "Notes from calibration"

    # Dates
    dates:
      - name: self_review_due_date
        type: date
        description: "Deadline for self-review"

      - name: self_review_completed_at
        type: timestamp
        description: "When self-review was completed"

      - name: manager_review_due_date
        type: date
        description: "Deadline for manager review"

      - name: manager_review_completed_at
        type: timestamp
        description: "When manager review was completed"

      - name: feedback_meeting_date
        type: date
        description: "Date of feedback meeting"

      - name: completed_at
        type: timestamp
        description: "When review was completed"

    # System
    system:
      - name: created_at
        type: timestamp
        auto_generate: true

      - name: updated_at
        type: timestamp
        auto_update: true

      - name: created_by
        type: uuid
        foreign_key: users.id

      - name: updated_by
        type: uuid
        foreign_key: users.id

  relationships:
    - name: employee
      type: belongs_to
      entity: Employee
      foreign_key: employee_id
      description: "Employee being reviewed"

    - name: manager
      type: belongs_to
      entity: Employee
      foreign_key: manager_id
      description: "Reviewing manager"

    - name: review_goals
      type: has_many
      entity: Goal
      foreign_key: review_id
      description: "Goals for this review period"

  state_machine:
    field: status
    initial: draft
    transitions:
      - from: draft
        to: self_review
        event: initiate
        actions:
          - notify_employee
          - set_deadlines

      - from: self_review
        to: manager_review
        event: submit_self_review
        conditions:
          - self_assessment_complete
        actions:
          - notify_manager

      - from: manager_review
        to: calibration
        event: submit_manager_review
        conditions:
          - manager_assessment_complete
        actions:
          - add_to_calibration_queue

      - from: calibration
        to: pending_acknowledgment
        event: complete_calibration
        actions:
          - finalize_rating
          - schedule_feedback_meeting

      - from: pending_acknowledgment
        to: completed
        event: employee_acknowledge
        conditions:
          - employee_signed
        actions:
          - finalize_review
          - trigger_outcomes

  indexes:
    - columns: [review_id]
      unique: true
    - columns: [employee_id]
    - columns: [manager_id]
    - columns: [status]
    - columns: [review_year]
    - columns: [review_type]
    - columns: [final_rating]

  validations:
    - field: review_period_end
      rule: "must_be_after_start"
      message: "End date must be after start date"

    - field: final_rating
      rule: "must_be_1_to_5"
      message: "Rating must be between 1 and 5"

  hooks:
    before_create:
      - generate_review_id
      - set_deadlines
      - copy_goals

    after_complete:
      - update_employee_record
      - create_development_tasks
      - trigger_salary_review
      - update_talent_profile

  notifications:
    - event: initiated
      recipients: [employee]
      template: "review_initiated"

    - event: self_review_submitted
      recipients: [manager]
      template: "self_review_ready"

    - event: completed
      recipients: [employee]
      template: "review_completed"

    - event: deadline_reminder
      recipients: [employee, manager]
      template: "review_deadline_reminder"

  audit:
    enabled: true
    tracked_fields:
      - status
      - self_rating
      - manager_rating
      - final_rating
    retention: "5 years"
