name: employee-payroll
display_name: Employee Payroll Profile
description: |
  Employee payroll profile containing compensation settings, bank details,
  tax information, and insurance configuration for payroll processing.

domain: hr-management
subdomain: payroll
category: entities
version: "1.0.0"
status: active

entity:
  name: EmployeePayroll
  table_name: employee_payrolls
  primary_key: id

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true

    - name: employee_id
      type: uuid
      required: true
      unique: true
      description: Reference to employee record

    - name: payroll_code
      type: string
      length: 20
      unique: true
      format: "EMP-{NNNNNN}"

    # Status
    - name: status
      type: enum
      values: [active, on_leave, suspended, terminated]
      default: active

    - name: payroll_type
      type: enum
      values: [monthly, bi_weekly, weekly, daily]
      default: monthly

    # Employment Details
    - name: hire_date
      type: date
      required: true

    - name: termination_date
      type: date

    - name: employment_type
      type: enum
      values: [full_time, part_time, contract, probation, intern]
      default: full_time

    - name: probation_end_date
      type: date

    - name: department_id
      type: uuid
      required: true

    - name: position_id
      type: uuid
      required: true

    - name: manager_id
      type: uuid

    - name: work_location_id
      type: uuid

    - name: cost_center_id
      type: uuid

    # Compensation
    - name: salary_structure_id
      type: uuid
      required: true

    - name: base_salary
      type: decimal
      precision: 15
      scale: 2
      required: true

    - name: currency
      type: string
      length: 3
      default: "VND"

    - name: salary_effective_date
      type: date
      required: true

    - name: payment_method
      type: enum
      values: [bank_transfer, cash, check]
      default: bank_transfer

    - name: pay_frequency
      type: enum
      values: [monthly, bi_weekly, weekly]
      default: monthly

    # Bank Details
    - name: bank_name
      type: string
      length: 200

    - name: bank_code
      type: string
      length: 20
      description: SWIFT/BIC code

    - name: account_number
      type: string
      length: 50
      encrypted: true

    - name: account_holder_name
      type: string
      length: 200

    - name: branch_code
      type: string
      length: 20

    - name: branch_name
      type: string
      length: 200

    # Tax Information
    - name: tax_id
      type: string
      length: 20
      description: Mã số thuế (MST)

    - name: tax_status
      type: enum
      values: [resident, non_resident]
      default: resident

    - name: tax_registration_date
      type: date

    - name: dependents_count
      type: integer
      default: 0
      description: Số người phụ thuộc

    - name: dependents
      type: jsonb
      description: Dependent details
      example: |
        [
          {
            "name": "Nguyen Van B",
            "relationship": "child",
            "id_number": "123456789",
            "birth_date": "2015-01-01",
            "registration_date": "2024-01-01",
            "deduction_amount": 4400000
          }
        ]

    - name: personal_deduction_amount
      type: decimal
      precision: 15
      scale: 2
      default: 11000000
      description: 11M VND per month

    # Insurance
    - name: social_insurance_number
      type: string
      length: 20
      description: Số sổ BHXH

    - name: health_insurance_number
      type: string
      length: 20
      description: Số thẻ BHYT

    - name: insurance_salary_base
      type: decimal
      precision: 15
      scale: 2
      description: Mức lương đóng BHXH

    - name: insurance_start_date
      type: date

    - name: insurance_region
      type: enum
      values: [region_1, region_2, region_3, region_4]
      description: Vùng lương tối thiểu

    - name: exempt_from_insurance
      type: boolean
      default: false

    - name: insurance_exemption_reason
      type: text

    # Work Schedule
    - name: standard_hours_per_day
      type: decimal
      precision: 4
      scale: 2
      default: 8.00

    - name: standard_hours_per_week
      type: decimal
      precision: 5
      scale: 2
      default: 40.00

    - name: standard_days_per_month
      type: integer
      default: 22

    # Allowances Configuration
    - name: allowances
      type: jsonb
      description: Additional allowances
      example: |
        {
          "housing": 2000000,
          "transportation": 500000,
          "meal": 730000,
          "phone": 300000,
          "responsibility": 1000000
        }

    # Deductions Configuration
    - name: fixed_deductions
      type: jsonb
      description: Recurring deductions
      example: |
        {
          "union_fee": 100000,
          "parking": 200000
        }

    # Metadata
    - name: notes
      type: text

    - name: created_at
      type: timestamp
      required: true
      default: now()

    - name: updated_at
      type: timestamp
      required: true
      default: now()

    - name: created_by
      type: uuid

    - name: updated_by
      type: uuid

  relationships:
    - name: employee
      type: belongs_to
      entity: Employee
      foreign_key: employee_id

    - name: salary_structure
      type: belongs_to
      entity: SalaryStructure
      foreign_key: salary_structure_id

    - name: department
      type: belongs_to
      entity: Department
      foreign_key: department_id

    - name: position
      type: belongs_to
      entity: Position
      foreign_key: position_id

    - name: manager
      type: belongs_to
      entity: Employee
      foreign_key: manager_id

    - name: payslips
      type: has_many
      entity: PaySlip
      foreign_key: employee_id

    - name: earnings
      type: has_many
      entity: Earnings
      foreign_key: employee_id

    - name: deductions
      type: has_many
      entity: Deduction
      foreign_key: employee_id

    - name: loans
      type: has_many
      entity: Loan
      foreign_key: employee_id

  indexes:
    - columns: [employee_id]
      unique: true
    - columns: [payroll_code]
      unique: true
    - columns: [status]
    - columns: [department_id]
    - columns: [tax_id]
    - columns: [social_insurance_number]

  validations:
    - field: base_salary
      rule: positive
      message: "Base salary must be positive"

    - field: base_salary
      rule: minimum_wage
      message: "Salary must meet minimum wage requirements"

    - field: tax_id
      rule: format
      pattern: "^[0-9]{10,13}$"
      message: "Invalid tax ID format"

    - field: dependents_count
      rule: non_negative
      message: "Dependents count cannot be negative"

  computed_fields:
    - name: hourly_rate
      formula: "base_salary / (standard_hours_per_day * standard_days_per_month)"

    - name: total_deduction_allowance
      formula: "personal_deduction_amount + (dependents_count * 4400000)"

    - name: insurance_contribution_base
      formula: "MIN(insurance_salary_base, 20 * minimum_wage)"

  hooks:
    on_salary_change:
      - log_salary_history
      - recalculate_insurance_base
      - notify_finance

    on_status_change:
      - update_payroll_inclusion
      - trigger_final_settlement_if_terminated

    on_dependent_change:
      - recalculate_tax_deduction
      - update_tax_registration

  audit:
    track:
      - base_salary
      - salary_structure_id
      - bank_account_number
      - tax_id
      - dependents_count
      - status

    retention: 10_years

compliance:
  - standard: Vietnam_Labor_Code
    requirement: Minimum wage compliance
  - standard: Tax_Law
    requirement: Tax registration and withholding
  - standard: BHXH_Law
    requirement: Insurance participation
