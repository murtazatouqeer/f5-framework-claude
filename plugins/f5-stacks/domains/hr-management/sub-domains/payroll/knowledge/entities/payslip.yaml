name: payslip
display_name: Pay Slip
description: |
  Employee pay statement showing earnings, deductions, tax calculations,
  and net pay for a specific payroll period.

domain: hr-management
subdomain: payroll
category: entities
version: "1.0.0"
status: active

entity:
  name: PaySlip
  table_name: payslips
  primary_key: id

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true

    - name: payslip_number
      type: string
      length: 30
      unique: true
      format: "PS-{YYYYMM}-{NNNNNN}"

    # References
    - name: employee_id
      type: uuid
      required: true

    - name: payroll_run_id
      type: uuid
      required: true

    - name: period_id
      type: uuid
      required: true

    # Status
    - name: status
      type: enum
      values: [draft, calculated, final, paid, void, corrected]
      default: draft

    # Employee Snapshot
    - name: employee_snapshot
      type: jsonb
      description: Employee details at time of payroll
      example: |
        {
          "employee_code": "EMP001",
          "full_name": "Nguyen Van A",
          "department": "Engineering",
          "position": "Senior Developer",
          "hire_date": "2020-01-15",
          "tax_id": "0123456789",
          "bank_account": "****1234"
        }

    # Working Time
    - name: working_days
      type: decimal
      precision: 5
      scale: 2
      description: Days worked in period

    - name: working_hours
      type: decimal
      precision: 7
      scale: 2
      description: Hours worked in period

    - name: absent_days
      type: decimal
      precision: 5
      scale: 2
      default: 0

    - name: leave_days
      type: decimal
      precision: 5
      scale: 2
      default: 0

    # Earnings
    - name: earnings
      type: jsonb
      description: Itemized earnings
      example: |
        [
          {
            "code": "BASIC",
            "name": "Lương cơ bản",
            "quantity": 1,
            "rate": 25000000,
            "amount": 25000000,
            "taxable": true,
            "si_contributable": true
          },
          {
            "code": "HOUSING",
            "name": "Phụ cấp nhà ở",
            "quantity": 1,
            "rate": 3000000,
            "amount": 3000000,
            "taxable": true
          },
          {
            "code": "OT_WEEKDAY",
            "name": "Làm thêm ngày thường",
            "quantity": 10,
            "rate": 170455,
            "amount": 1704550,
            "taxable": true
          }
        ]

    - name: gross_earnings
      type: decimal
      precision: 15
      scale: 2
      required: true

    # Deductions
    - name: deductions
      type: jsonb
      description: Itemized deductions
      example: |
        [
          {
            "code": "SI_EE",
            "name": "BHXH (NLĐ)",
            "amount": 2000000,
            "base": 25000000,
            "rate": 8
          },
          {
            "code": "HI_EE",
            "name": "BHYT (NLĐ)",
            "amount": 375000,
            "base": 25000000,
            "rate": 1.5
          },
          {
            "code": "UI_EE",
            "name": "BHTN (NLĐ)",
            "amount": 250000,
            "base": 25000000,
            "rate": 1
          },
          {
            "code": "PIT",
            "name": "Thuế TNCN",
            "amount": 1850000
          },
          {
            "code": "LOAN",
            "name": "Trừ nợ vay",
            "amount": 2000000
          }
        ]

    - name: total_deductions
      type: decimal
      precision: 15
      scale: 2
      required: true

    # Tax Details
    - name: taxable_income
      type: decimal
      precision: 15
      scale: 2

    - name: personal_deduction
      type: decimal
      precision: 15
      scale: 2
      default: 11000000

    - name: dependent_deduction
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: insurance_deduction
      type: decimal
      precision: 15
      scale: 2
      description: Insurance deducted before tax

    - name: assessable_income
      type: decimal
      precision: 15
      scale: 2
      description: Income after all deductions for tax

    - name: tax_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: tax_calculation_detail
      type: jsonb
      description: Tax bracket breakdown
      example: |
        {
          "gross_taxable": 28000000,
          "personal_deduction": 11000000,
          "dependent_deduction": 4400000,
          "insurance_deduction": 2625000,
          "assessable_income": 9975000,
          "brackets": [
            {"range": "0-5M", "rate": 5, "amount": 250000},
            {"range": "5M-10M", "rate": 10, "amount": 497500}
          ],
          "total_tax": 747500
        }

    # Insurance - Employee
    - name: si_employee
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Social insurance - employee contribution

    - name: hi_employee
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Health insurance - employee contribution

    - name: ui_employee
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Unemployment insurance - employee contribution

    - name: total_insurance_ee
      type: decimal
      precision: 15
      scale: 2
      default: 0

    # Insurance - Employer
    - name: si_employer
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: hi_employer
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: ui_employer
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: total_insurance_er
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: insurance_salary_base
      type: decimal
      precision: 15
      scale: 2
      description: Base for insurance calculation

    # Net Pay
    - name: net_pay
      type: decimal
      precision: 15
      scale: 2
      required: true

    # Employer Cost
    - name: total_employer_cost
      type: decimal
      precision: 15
      scale: 2
      description: Gross + employer contributions

    # Year-to-Date
    - name: ytd_gross
      type: decimal
      precision: 18
      scale: 2
      default: 0

    - name: ytd_tax
      type: decimal
      precision: 18
      scale: 2
      default: 0

    - name: ytd_insurance_ee
      type: decimal
      precision: 18
      scale: 2
      default: 0

    - name: ytd_net
      type: decimal
      precision: 18
      scale: 2
      default: 0

    # Payment Info
    - name: payment_method
      type: enum
      values: [bank_transfer, cash, check]
      default: bank_transfer

    - name: bank_account_masked
      type: string
      length: 20
      description: "e.g., ****1234"

    - name: payment_date
      type: date

    - name: payment_reference
      type: string
      length: 100

    - name: payment_status
      type: enum
      values: [pending, processing, completed, failed]
      default: pending

    # Corrections
    - name: is_correction
      type: boolean
      default: false

    - name: original_payslip_id
      type: uuid
      description: If correction, reference to original

    - name: correction_reason
      type: text

    # Distribution
    - name: distributed_at
      type: timestamp

    - name: distributed_via
      type: enum
      values: [email, portal, print]

    - name: viewed_by_employee
      type: boolean
      default: false

    - name: viewed_at
      type: timestamp

    # Metadata
    - name: notes
      type: text

    - name: created_at
      type: timestamp
      required: true
      default: now()

    - name: updated_at
      type: timestamp
      required: true
      default: now()

  relationships:
    - name: employee
      type: belongs_to
      entity: Employee
      foreign_key: employee_id

    - name: employee_payroll
      type: belongs_to
      entity: EmployeePayroll
      foreign_key: employee_id
      foreign_key_column: employee_id

    - name: payroll_run
      type: belongs_to
      entity: PayrollRun
      foreign_key: payroll_run_id

    - name: period
      type: belongs_to
      entity: PayrollPeriod
      foreign_key: period_id

    - name: tax_calculation
      type: has_one
      entity: TaxCalculation
      foreign_key: payslip_id

    - name: original_payslip
      type: belongs_to
      entity: PaySlip
      foreign_key: original_payslip_id

    - name: corrections
      type: has_many
      entity: PaySlip
      foreign_key: original_payslip_id

  indexes:
    - columns: [payslip_number]
      unique: true
    - columns: [employee_id, period_id]
      unique: true
    - columns: [payroll_run_id]
    - columns: [status]
    - columns: [payment_date]
    - columns: [payment_status]

  state_machine:
    field: status
    initial: draft
    transitions:
      - from: draft
        to: calculated
        action: calculate
        triggers: [compute_all_components]

      - from: calculated
        to: final
        action: finalize
        guards: [payroll_run_approved]
        triggers: [lock_amounts, update_ytd]

      - from: final
        to: paid
        action: mark_paid
        guards: [payment_confirmed]
        triggers: [record_payment, send_notification]

      - from: paid
        to: void
        action: void
        guards: [within_void_window, admin_approval]
        triggers: [reverse_ytd, create_correction]

      - from: paid
        to: corrected
        action: correct
        guards: [correction_processed]
        triggers: [link_correction]

  validations:
    - field: net_pay
      rule: equals
      compare_to: "gross_earnings - total_deductions"
      tolerance: 1
      message: "Net pay calculation mismatch"

    - field: net_pay
      rule: non_negative
      message: "Net pay cannot be negative"

  computed_fields:
    - name: total_insurance_ee
      formula: "si_employee + hi_employee + ui_employee"

    - name: total_insurance_er
      formula: "si_employer + hi_employer + ui_employer"

    - name: total_employer_cost
      formula: "gross_earnings + total_insurance_er"

  hooks:
    on_calculate:
      - compute_earnings
      - compute_insurance
      - compute_tax
      - compute_other_deductions
      - compute_net

    on_finalize:
      - update_ytd_totals
      - generate_payslip_pdf
      - lock_record

    on_distribute:
      - send_email_notification
      - log_distribution

  audit:
    track:
      - status
      - gross_earnings
      - total_deductions
      - net_pay
      - payment_status

    retention: 10_years

compliance:
  - standard: Vietnam_Labor_Code
    requirement: Payslip must show all components
  - standard: Tax_Law
    requirement: Tax calculation transparent
  - standard: BHXH_Law
    requirement: Insurance contributions shown
