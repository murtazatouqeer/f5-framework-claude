name: salary-structure
display_name: Salary Structure
description: |
  Defines salary component structures including earnings, deductions,
  and their calculation methods for different employee categories.

domain: hr-management
subdomain: payroll
category: entities
version: "1.0.0"
status: active

entity:
  name: SalaryStructure
  table_name: salary_structures
  primary_key: id

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true

    - name: structure_code
      type: string
      length: 20
      unique: true
      format: "SAL-{XXXX}"

    - name: name
      type: string
      length: 200
      required: true

    - name: description
      type: text

    # Status
    - name: status
      type: enum
      values: [active, inactive, draft]
      default: draft

    - name: structure_type
      type: enum
      values: [standard, executive, hourly, commission, contract]
      default: standard

    # Applicability
    - name: applicable_to
      type: jsonb
      description: Where this structure applies
      example: |
        {
          "departments": ["all"],
          "positions": ["all"],
          "levels": ["junior", "mid", "senior"],
          "employment_types": ["full_time", "part_time"]
        }

    - name: currency
      type: string
      length: 3
      default: "VND"

    # Components
    - name: components
      type: jsonb
      required: true
      description: Salary components definition
      example: |
        [
          {
            "code": "BASIC",
            "name": "Lương cơ bản",
            "name_en": "Basic Salary",
            "type": "earning",
            "category": "basic",
            "calculation": "fixed",
            "taxable": true,
            "si_contributable": true,
            "hi_contributable": true,
            "ui_contributable": true,
            "display_order": 1
          },
          {
            "code": "HOUSING",
            "name": "Phụ cấp nhà ở",
            "name_en": "Housing Allowance",
            "type": "earning",
            "category": "allowance",
            "calculation": "fixed",
            "taxable": true,
            "si_contributable": false,
            "display_order": 2
          },
          {
            "code": "TRANSPORT",
            "name": "Phụ cấp đi lại",
            "name_en": "Transportation Allowance",
            "type": "earning",
            "category": "allowance",
            "calculation": "fixed",
            "taxable": true,
            "si_contributable": false,
            "display_order": 3
          },
          {
            "code": "MEAL",
            "name": "Phụ cấp ăn trưa",
            "name_en": "Meal Allowance",
            "type": "earning",
            "category": "allowance",
            "calculation": "fixed",
            "taxable": false,
            "tax_exempt_limit": 730000,
            "si_contributable": false,
            "display_order": 4
          },
          {
            "code": "PHONE",
            "name": "Phụ cấp điện thoại",
            "name_en": "Phone Allowance",
            "type": "earning",
            "category": "allowance",
            "calculation": "fixed",
            "taxable": true,
            "si_contributable": false,
            "display_order": 5
          },
          {
            "code": "RESPONSIBILITY",
            "name": "Phụ cấp trách nhiệm",
            "name_en": "Responsibility Allowance",
            "type": "earning",
            "category": "allowance",
            "calculation": "fixed",
            "taxable": true,
            "si_contributable": false,
            "display_order": 6
          },
          {
            "code": "SI_EE",
            "name": "BHXH (NLĐ)",
            "name_en": "Social Insurance (Employee)",
            "type": "deduction",
            "category": "statutory",
            "calculation": "percentage",
            "percentage": 8,
            "base": "insurance_salary",
            "display_order": 10
          },
          {
            "code": "HI_EE",
            "name": "BHYT (NLĐ)",
            "name_en": "Health Insurance (Employee)",
            "type": "deduction",
            "category": "statutory",
            "calculation": "percentage",
            "percentage": 1.5,
            "base": "insurance_salary",
            "display_order": 11
          },
          {
            "code": "UI_EE",
            "name": "BHTN (NLĐ)",
            "name_en": "Unemployment Insurance (Employee)",
            "type": "deduction",
            "category": "statutory",
            "calculation": "percentage",
            "percentage": 1,
            "base": "insurance_salary",
            "display_order": 12
          },
          {
            "code": "PIT",
            "name": "Thuế TNCN",
            "name_en": "Personal Income Tax",
            "type": "deduction",
            "category": "statutory",
            "calculation": "progressive",
            "formula": "calculate_pit",
            "display_order": 13
          }
        ]

    # Employer Contributions (not deducted from employee)
    - name: employer_contributions
      type: jsonb
      description: Employer-side contributions
      example: |
        [
          {
            "code": "SI_ER",
            "name": "BHXH (NSDLĐ)",
            "name_en": "Social Insurance (Employer)",
            "calculation": "percentage",
            "percentage": 17.5,
            "base": "insurance_salary"
          },
          {
            "code": "HI_ER",
            "name": "BHYT (NSDLĐ)",
            "name_en": "Health Insurance (Employer)",
            "calculation": "percentage",
            "percentage": 3,
            "base": "insurance_salary"
          },
          {
            "code": "UI_ER",
            "name": "BHTN (NSDLĐ)",
            "name_en": "Unemployment Insurance (Employer)",
            "calculation": "percentage",
            "percentage": 1,
            "base": "insurance_salary"
          }
        ]

    # Overtime Rates
    - name: overtime_rates
      type: jsonb
      description: Overtime multipliers
      example: |
        {
          "weekday": 1.5,
          "weekend": 2.0,
          "holiday": 3.0,
          "night_shift_additional": 0.3
        }

    # Effective Period
    - name: effective_from
      type: date
      required: true

    - name: effective_to
      type: date

    # Metadata
    - name: created_at
      type: timestamp
      required: true
      default: now()

    - name: updated_at
      type: timestamp
      required: true
      default: now()

    - name: created_by
      type: uuid

    - name: updated_by
      type: uuid

  relationships:
    - name: employees
      type: has_many
      entity: EmployeePayroll
      foreign_key: salary_structure_id

  indexes:
    - columns: [structure_code]
      unique: true
    - columns: [status]
    - columns: [structure_type]
    - columns: [effective_from]

  validations:
    - field: name
      rule: not_empty
      message: "Structure name is required"

    - field: components
      rule: has_basic_salary
      message: "Must include basic salary component"

    - field: effective_from
      rule: not_future
      when: status == 'active'
      message: "Active structure must have current or past effective date"

  component_types:
    earnings:
      basic:
        - BASIC: Basic Salary
      allowances:
        - HOUSING: Housing Allowance
        - TRANSPORT: Transportation
        - MEAL: Meal Allowance
        - PHONE: Phone Allowance
        - RESPONSIBILITY: Responsibility
        - ATTENDANCE: Attendance Bonus
        - SKILL: Skill Allowance
        - HARDSHIP: Hardship Allowance
      bonuses:
        - PERFORMANCE: Performance Bonus
        - PROJECT: Project Bonus
        - THIRTEENTH: 13th Month

    deductions:
      statutory:
        - SI_EE: Social Insurance (Employee)
        - HI_EE: Health Insurance (Employee)
        - UI_EE: Unemployment Insurance (Employee)
        - PIT: Personal Income Tax
      voluntary:
        - UNION: Union Dues
        - PARKING: Parking Fee
        - INSURANCE_ADDON: Additional Insurance
      recovery:
        - LOAN: Loan Repayment
        - ADVANCE: Salary Advance

  calculation_methods:
    - method: fixed
      description: Fixed amount per period

    - method: percentage
      description: Percentage of base amount
      parameters: [percentage, base]

    - method: formula
      description: Custom formula
      parameters: [formula]

    - method: progressive
      description: Progressive rate calculation
      parameters: [brackets]

    - method: per_unit
      description: Rate per unit (hours, days)
      parameters: [rate, unit]

  hooks:
    before_activate:
      - validate_all_components
      - check_statutory_compliance
      - verify_minimum_requirements

    on_change:
      - version_structure
      - notify_affected_employees

  audit:
    track:
      - components
      - status
      - effective_from
      - effective_to

    retention: 10_years
