name: social-insurance
display_name: Social Insurance Contribution
description: |
  Social insurance (BHXH), health insurance (BHYT), and unemployment
  insurance (BHTN) contribution calculations per Vietnam regulations.

domain: hr-management
subdomain: payroll
category: entities
version: "1.0.0"
status: active

entity:
  name: SocialInsurance
  table_name: social_insurance_contributions
  primary_key: id

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true

    - name: employee_id
      type: uuid
      required: true

    - name: payslip_id
      type: uuid

    - name: period_id
      type: uuid
      required: true

    # Insurance Numbers
    - name: social_insurance_number
      type: string
      length: 20
      description: Số sổ BHXH

    - name: health_insurance_number
      type: string
      length: 20
      description: Số thẻ BHYT

    # Contribution Base
    - name: contribution_base
      type: decimal
      precision: 15
      scale: 2
      required: true
      description: Mức lương đóng BHXH

    - name: minimum_wage
      type: decimal
      precision: 15
      scale: 2
      required: true
      description: Regional minimum wage

    - name: wage_region
      type: enum
      values: [region_1, region_2, region_3, region_4]
      description: Vùng lương

    - name: max_contribution_base
      type: decimal
      precision: 15
      scale: 2
      description: 20 x minimum wage

    - name: actual_salary
      type: decimal
      precision: 15
      scale: 2
      description: Employee's actual salary

    # Social Insurance (BHXH)
    - name: si_rate_employee
      type: decimal
      precision: 5
      scale: 2
      default: 8.00
      description: 8% employee

    - name: si_rate_employer
      type: decimal
      precision: 5
      scale: 2
      default: 17.50
      description: 17.5% employer

    - name: si_employee
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: si_employer
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: si_total
      type: decimal
      precision: 15
      scale: 2
      default: 0

    # Health Insurance (BHYT)
    - name: hi_rate_employee
      type: decimal
      precision: 5
      scale: 2
      default: 1.50
      description: 1.5% employee

    - name: hi_rate_employer
      type: decimal
      precision: 5
      scale: 2
      default: 3.00
      description: 3% employer

    - name: hi_employee
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: hi_employer
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: hi_total
      type: decimal
      precision: 15
      scale: 2
      default: 0

    # Unemployment Insurance (BHTN)
    - name: ui_rate_employee
      type: decimal
      precision: 5
      scale: 2
      default: 1.00
      description: 1% employee

    - name: ui_rate_employer
      type: decimal
      precision: 5
      scale: 2
      default: 1.00
      description: 1% employer

    - name: ui_employee
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: ui_employer
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: ui_total
      type: decimal
      precision: 15
      scale: 2
      default: 0

    # Totals
    - name: total_employee
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Total employee contributions (10.5%)

    - name: total_employer
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Total employer contributions (21.5%)

    - name: grand_total
      type: decimal
      precision: 15
      scale: 2
      default: 0
      description: Total contributions (32%)

    # YTD
    - name: ytd_si_employee
      type: decimal
      precision: 18
      scale: 2
      default: 0

    - name: ytd_si_employer
      type: decimal
      precision: 18
      scale: 2
      default: 0

    - name: ytd_hi_employee
      type: decimal
      precision: 18
      scale: 2
      default: 0

    - name: ytd_hi_employer
      type: decimal
      precision: 18
      scale: 2
      default: 0

    - name: ytd_ui_employee
      type: decimal
      precision: 18
      scale: 2
      default: 0

    - name: ytd_ui_employer
      type: decimal
      precision: 18
      scale: 2
      default: 0

    # Exemptions
    - name: is_exempt
      type: boolean
      default: false

    - name: exemption_type
      type: enum
      values: [none, all, si_only, hi_only, ui_only]
      default: none

    - name: exemption_reason
      type: text

    # Adjustments
    - name: adjustment_amount
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: adjustment_reason
      type: text

    # Metadata
    - name: calculated_at
      type: timestamp
      required: true

    - name: notes
      type: text

    - name: created_at
      type: timestamp
      required: true
      default: now()

    - name: updated_at
      type: timestamp
      required: true
      default: now()

  relationships:
    - name: employee
      type: belongs_to
      entity: Employee
      foreign_key: employee_id

    - name: payslip
      type: belongs_to
      entity: PaySlip
      foreign_key: payslip_id

    - name: period
      type: belongs_to
      entity: PayrollPeriod
      foreign_key: period_id

  indexes:
    - columns: [employee_id, period_id]
      unique: true
    - columns: [payslip_id]
    - columns: [social_insurance_number]
    - columns: [period_id]

  contribution_rates_2024:
    social_insurance:
      employee: 8.0
      employer: 17.5
      total: 25.5
      breakdown_employer:
        retirement_death: 14.0
        sickness_maternity: 3.0
        occupational: 0.5

    health_insurance:
      employee: 1.5
      employer: 3.0
      total: 4.5

    unemployment_insurance:
      employee: 1.0
      employer: 1.0
      total: 2.0

    total:
      employee: 10.5
      employer: 21.5
      grand_total: 32.0

  minimum_wages_2024:
    region_1:
      monthly: 4680000
      hourly: 22500
      areas: "Hanoi, HCMC urban districts"

    region_2:
      monthly: 4160000
      hourly: 20000
      areas: "Provincial cities, industrial zones"

    region_3:
      monthly: 3640000
      hourly: 17500
      areas: "District towns"

    region_4:
      monthly: 3250000
      hourly: 15600
      areas: "Rural areas"

  contribution_limits:
    maximum_base: "20 x regional minimum wage"
    minimum_base: "regional minimum wage"
    example_region_1:
      max: 93600000  # 20 x 4,680,000

  eligibility:
    required_when:
      - employment_type: [full_time, part_time]
      - contract_duration: ">= 1 month"
      - labor_contract: true

    exempt_when:
      - employment_type: intern
      - contract_duration: "< 1 month"
      - age: "> retirement_age"
      - already_receiving_pension: true

  validations:
    - field: contribution_base
      rule: between
      range: [minimum_wage, max_contribution_base]
      message: "Contribution base out of valid range"

    - field: total_employee
      rule: equals
      compare_to: "si_employee + hi_employee + ui_employee"
      message: "Total employee contribution mismatch"

  computed_fields:
    - name: max_contribution_base
      formula: "minimum_wage * 20"

    - name: si_employee
      formula: "MIN(contribution_base, max_contribution_base) * si_rate_employee / 100"

    - name: si_employer
      formula: "MIN(contribution_base, max_contribution_base) * si_rate_employer / 100"

    - name: total_employee
      formula: "si_employee + hi_employee + ui_employee"

    - name: total_employer
      formula: "si_employer + hi_employer + ui_employer"

    - name: grand_total
      formula: "total_employee + total_employer"

  hooks:
    on_calculate:
      - determine_contribution_base
      - apply_caps
      - calculate_each_type
      - update_ytd

  audit:
    track:
      - contribution_base
      - total_employee
      - total_employer

    retention: 10_years

compliance:
  - standard: BHXH_Law_2014
    requirement: Mandatory participation
  - standard: Decree_115_2015
    requirement: Contribution rates
  - standard: Circular_59_2015
    requirement: Calculation rules
