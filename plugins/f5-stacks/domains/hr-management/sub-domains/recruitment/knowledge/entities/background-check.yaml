name: background-check
display_name: Background Check
description: |
  Pre-employment background verification including criminal history,
  employment verification, education verification, and reference checks.

domain: hr-management
subdomain: recruitment
category: entities
version: "1.0.0"
status: active

entity:
  name: BackgroundCheck
  table_name: background_checks
  primary_key: id

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true

    - name: check_id
      type: string
      length: 20
      unique: true
      format: "BGC-{YYYYMMDD}-{NNNN}"

    - name: application_id
      type: uuid
      required: true

    - name: candidate_id
      type: uuid
      required: true

    - name: offer_id
      type: uuid
      description: Associated offer

    # Status
    - name: status
      type: enum
      values: [pending_consent, consent_received, in_progress, completed, cancelled, disputed]
      default: pending_consent

    - name: overall_result
      type: enum
      values: [clear, consider, adverse, pending]
      description: Overall adjudication result

    # Provider
    - name: provider
      type: enum
      values: [checkr, hireright, sterling, goodhire, accurate, internal]
      required: true

    - name: provider_order_id
      type: string
      length: 100
      description: Provider's reference number

    - name: provider_report_url
      type: string
      length: 1000

    # Package
    - name: package_name
      type: string
      length: 100
      required: true
      description: Background check package type

    - name: checks_included
      type: jsonb
      description: What's included in the package
      example: |
        [
          "criminal_national",
          "criminal_county",
          "ssn_trace",
          "employment_verification",
          "education_verification",
          "reference_check",
          "credit_check",
          "drug_screen"
        ]

    # Consent
    - name: consent_form_sent_at
      type: timestamp

    - name: consent_received
      type: boolean
      default: false

    - name: consent_received_at
      type: timestamp

    - name: consent_document_url
      type: string
      length: 1000

    - name: disclosure_acknowledged
      type: boolean
      default: false

    # Timeline
    - name: initiated_at
      type: timestamp
      description: When check was started with provider

    - name: estimated_completion_date
      type: date

    - name: completed_at
      type: timestamp

    # Individual Checks
    - name: criminal_check
      type: jsonb
      description: Criminal history results
      example: |
        {
          "status": "clear",
          "searched_jurisdictions": ["national", "county_xyz"],
          "records_found": 0,
          "completed_at": "..."
        }

    - name: employment_verification
      type: jsonb
      description: Employment history verification
      example: |
        {
          "status": "verified",
          "employers_verified": [
            {"employer": "Tech Corp", "title": "Engineer", "dates": "2020-2023", "verified": true}
          ],
          "discrepancies": []
        }

    - name: education_verification
      type: jsonb
      description: Education verification
      example: |
        {
          "status": "verified",
          "degrees_verified": [
            {"institution": "State U", "degree": "BS CS", "year": "2015", "verified": true}
          ]
        }

    - name: reference_check
      type: jsonb
      description: Reference check results
      example: |
        {
          "status": "completed",
          "references_contacted": 3,
          "references_completed": 3,
          "overall_rating": "positive",
          "details": [...]
        }

    - name: credit_check
      type: jsonb
      description: Credit check results (if applicable)

    - name: drug_screen
      type: jsonb
      description: Drug screening results
      example: |
        {
          "status": "negative",
          "test_date": "...",
          "lab": "LabCorp",
          "substances_tested": ["marijuana", "cocaine", "opioids", "amphetamines"]
        }

    - name: ssn_verification
      type: jsonb
      description: SSN trace results

    - name: mvr_check
      type: jsonb
      description: Motor vehicle record (if applicable)

    - name: professional_license
      type: jsonb
      description: Professional license verification

    # Results Summary
    - name: issues_found
      type: jsonb
      description: Any flags or issues
      example: |
        [
          {"type": "criminal", "severity": "low", "description": "Minor traffic violation 2018"},
          {"type": "employment", "severity": "medium", "description": "Dates differ by 2 months"}
        ]

    - name: requires_review
      type: boolean
      default: false

    # Adjudication
    - name: adjudicated_by_id
      type: uuid

    - name: adjudicated_at
      type: timestamp

    - name: adjudication_notes
      type: text

    - name: adjudication_result
      type: enum
      values: [proceed, do_not_hire, pending_additional_info]

    # Adverse Action
    - name: adverse_action_required
      type: boolean
      default: false

    - name: pre_adverse_action_sent_at
      type: timestamp
      description: FCRA pre-adverse notice

    - name: pre_adverse_action_period_end
      type: date
      description: Waiting period end date

    - name: final_adverse_action_sent_at
      type: timestamp

    - name: adverse_action_reason
      type: text

    # Dispute
    - name: dispute_filed
      type: boolean
      default: false

    - name: dispute_filed_at
      type: timestamp

    - name: dispute_details
      type: text

    - name: dispute_resolved_at
      type: timestamp

    - name: dispute_resolution
      type: text

    # Cost
    - name: cost
      type: decimal
      precision: 10
      scale: 2

    - name: billed_at
      type: timestamp

    # Timestamps
    - name: created_at
      type: timestamp
      required: true
      default: now()

    - name: updated_at
      type: timestamp
      required: true
      default: now()

  relationships:
    - name: application
      type: belongs_to
      entity: Application
      foreign_key: application_id

    - name: candidate
      type: belongs_to
      entity: Candidate
      foreign_key: candidate_id

    - name: offer
      type: belongs_to
      entity: Offer
      foreign_key: offer_id

    - name: adjudicated_by
      type: belongs_to
      entity: User
      foreign_key: adjudicated_by_id

  indexes:
    - columns: [check_id]
      unique: true
    - columns: [application_id]
    - columns: [candidate_id]
    - columns: [status]
    - columns: [provider_order_id]

  state_machine:
    field: status
    initial: pending_consent
    transitions:
      - from: pending_consent
        to: consent_received
        action: receive_consent
        guards: [consent_form_signed]

      - from: consent_received
        to: in_progress
        action: initiate_check
        triggers: [submit_to_provider]

      - from: in_progress
        to: completed
        action: complete
        triggers: [process_results, determine_adjudication]

      - from: completed
        to: disputed
        action: file_dispute
        triggers: [notify_provider, pause_hiring]

      - from: disputed
        to: completed
        action: resolve_dispute

      - from: [pending_consent, consent_received, in_progress]
        to: cancelled
        action: cancel
        triggers: [notify_provider_if_started]

  validations:
    - field: consent_received
      rule: required
      before: in_progress
      message: "Consent required before initiating background check"

  audit:
    enabled: true
    fields: [status, overall_result, adjudication_result, adverse_action_required]

compliance:
  - standard: FCRA
    requirements:
      - Obtain written consent
      - Provide pre-adverse action notice
      - Allow dispute period (minimum 5 business days)
      - Send final adverse action notice
      - Maintain records for 5 years

  - standard: ban_the_box
    requirements:
      - Check jurisdiction-specific rules
      - Do not ask about criminal history before conditional offer
      - Conduct individualized assessment

  - standard: EEOC
    requirements:
      - Consider nature of offense
      - Consider time elapsed
      - Consider relevance to position
