name: offer
display_name: Job Offer
description: |
  A formal employment offer extended to a candidate. Tracks offer details,
  approval workflow, negotiation, and acceptance.

domain: hr-management
subdomain: recruitment
category: entities
version: "1.0.0"
status: active

entity:
  name: Offer
  table_name: offers
  primary_key: id
  natural_key: offer_id

  attributes:
    # Identity
    - name: id
      type: uuid
      primary_key: true

    - name: offer_id
      type: string
      length: 20
      unique: true
      format: "OFR-{YYYYMMDD}-{NNNN}"

    - name: application_id
      type: uuid
      required: true

    - name: candidate_id
      type: uuid
      required: true

    - name: requisition_id
      type: uuid
      required: true

    # Status
    - name: status
      type: enum
      values: [draft, pending_approval, approved, sent, viewed, accepted, declined, expired, rescinded, superseded]
      default: draft

    - name: offer_type
      type: enum
      values: [initial, revised, counter, final]
      default: initial

    - name: version
      type: integer
      default: 1
      description: Offer version number

    - name: previous_offer_id
      type: uuid
      description: If revised, reference to previous offer

    # Position Details
    - name: job_title
      type: string
      length: 200
      required: true

    - name: job_code
      type: string
      length: 50

    - name: department_id
      type: uuid
      required: true

    - name: reports_to_name
      type: string
      length: 200

    - name: reports_to_title
      type: string
      length: 200

    - name: location_id
      type: uuid
      required: true

    - name: location_name
      type: string
      length: 200

    - name: is_remote
      type: boolean
      default: false

    - name: remote_type
      type: enum
      values: [on_site, hybrid, fully_remote]

    - name: employment_type
      type: enum
      values: [full_time, part_time, contract, intern, temporary]
      required: true

    # Dates
    - name: proposed_start_date
      type: date
      required: true

    - name: offer_valid_until
      type: date
      required: true

    # Base Compensation
    - name: base_salary
      type: decimal
      precision: 15
      scale: 2
      required: true

    - name: salary_currency
      type: string
      length: 3
      default: "USD"

    - name: salary_frequency
      type: enum
      values: [hourly, monthly, annual]
      default: annual

    - name: pay_grade
      type: string
      length: 50

    - name: salary_range_min
      type: decimal
      precision: 15
      scale: 2

    - name: salary_range_max
      type: decimal
      precision: 15
      scale: 2

    - name: compa_ratio
      type: decimal
      precision: 5
      scale: 2
      description: Salary vs midpoint ratio

    # Variable Compensation
    - name: signing_bonus
      type: decimal
      precision: 15
      scale: 2
      default: 0

    - name: signing_bonus_terms
      type: text
      description: Conditions for signing bonus

    - name: annual_bonus_target_percent
      type: decimal
      precision: 5
      scale: 2
      description: Target bonus percentage

    - name: bonus_guarantee_first_year
      type: boolean
      default: false

    - name: commission_rate
      type: decimal
      precision: 5
      scale: 2
      description: For sales roles

    - name: commission_details
      type: text

    # Equity
    - name: equity_eligible
      type: boolean
      default: false

    - name: equity_type
      type: enum
      values: [stock_options, rsu, espp, phantom]

    - name: equity_shares
      type: integer
      description: Number of shares/units

    - name: equity_value
      type: decimal
      precision: 15
      scale: 2
      description: Estimated value

    - name: equity_vesting_schedule
      type: string
      length: 200
      description: e.g., "4 years with 1 year cliff"

    # Relocation
    - name: relocation_eligible
      type: boolean
      default: false

    - name: relocation_package
      type: decimal
      precision: 15
      scale: 2

    - name: relocation_details
      type: text

    # Benefits
    - name: benefits_package
      type: string
      length: 100
      description: Benefits tier/package name

    - name: benefits_summary
      type: text

    - name: vacation_days
      type: integer

    - name: sick_days
      type: integer

    - name: other_pto
      type: text

    # Probation
    - name: probation_months
      type: integer
      default: 3

    - name: probation_terms
      type: text

    # Total Compensation
    - name: total_cash_compensation
      type: decimal
      precision: 15
      scale: 2
      computed: true
      description: Base + bonus + signing

    - name: total_compensation_value
      type: decimal
      precision: 15
      scale: 2
      computed: true
      description: Including equity value

    # Contingencies
    - name: contingencies
      type: jsonb
      description: Conditions for offer
      example: |
        [
          {"type": "background_check", "status": "pending", "required": true},
          {"type": "reference_check", "status": "completed", "required": true},
          {"type": "drug_test", "status": "not_started", "required": false},
          {"type": "work_permit", "status": "pending", "required": true}
        ]

    - name: all_contingencies_cleared
      type: boolean
      default: false

    # Offer Letter
    - name: offer_letter_template_id
      type: uuid

    - name: offer_letter_url
      type: string
      length: 1000
      description: Generated offer letter

    - name: offer_letter_signed_url
      type: string
      length: 1000
      description: Signed version

    # Approval
    - name: approval_chain
      type: jsonb
      description: Array of approvers
      example: |
        [
          {"user_id": "xxx", "role": "recruiter", "status": "approved", "date": "..."},
          {"user_id": "yyy", "role": "hiring_manager", "status": "approved", "date": "..."},
          {"user_id": "zzz", "role": "hr", "status": "pending", "date": null}
        ]

    - name: final_approved_by_id
      type: uuid

    - name: final_approved_at
      type: timestamp

    # Sending
    - name: sent_at
      type: timestamp

    - name: sent_by_id
      type: uuid

    - name: sent_method
      type: enum
      values: [email, portal, in_person, docusign]

    - name: viewed_at
      type: timestamp
      description: When candidate first opened

    # Response
    - name: responded_at
      type: timestamp

    - name: response
      type: enum
      values: [accepted, declined, negotiating]

    - name: accepted_at
      type: timestamp

    - name: declined_at
      type: timestamp

    - name: decline_reason
      type: enum
      values: [compensation, role, location, timing, counter_offer, personal, other]

    - name: decline_reason_detail
      type: text

    - name: signed_at
      type: timestamp
      description: When candidate signed offer

    # Negotiation
    - name: negotiation_notes
      type: text

    - name: candidate_counter_offer
      type: jsonb
      description: Candidate's counter-proposal

    # Rescind
    - name: rescinded_at
      type: timestamp

    - name: rescinded_by_id
      type: uuid

    - name: rescind_reason
      type: text

    # Prepared By
    - name: prepared_by_id
      type: uuid
      required: true

    # Timestamps
    - name: created_at
      type: timestamp
      required: true
      default: now()

    - name: updated_at
      type: timestamp
      required: true
      default: now()

  relationships:
    - name: application
      type: belongs_to
      entity: Application
      foreign_key: application_id

    - name: candidate
      type: belongs_to
      entity: Candidate
      foreign_key: candidate_id

    - name: requisition
      type: belongs_to
      entity: JobRequisition
      foreign_key: requisition_id

    - name: prepared_by
      type: belongs_to
      entity: User
      foreign_key: prepared_by_id

    - name: sent_by
      type: belongs_to
      entity: User
      foreign_key: sent_by_id

    - name: previous_offer
      type: belongs_to
      entity: Offer
      foreign_key: previous_offer_id

    - name: background_check
      type: has_one
      entity: BackgroundCheck
      foreign_key: offer_id

  indexes:
    - columns: [offer_id]
      unique: true
    - columns: [application_id]
    - columns: [candidate_id]
    - columns: [requisition_id]
    - columns: [status]
    - columns: [offer_valid_until]

  state_machine:
    field: status
    initial: draft
    transitions:
      - from: draft
        to: pending_approval
        action: submit_for_approval
        guards: [has_required_fields, within_budget_or_exception]

      - from: pending_approval
        to: approved
        action: approve
        guards: [all_approvers_approved]

      - from: pending_approval
        to: draft
        action: return_for_revision
        triggers: [notify_preparer]

      - from: approved
        to: sent
        action: send
        triggers: [generate_letter, send_to_candidate, notify_stakeholders]

      - from: sent
        to: viewed
        action: mark_viewed
        triggers: [log_view_time]

      - from: [sent, viewed]
        to: accepted
        action: accept
        guards: [not_expired]
        triggers: [initiate_background_check, notify_hr, update_requisition]

      - from: [sent, viewed]
        to: declined
        action: decline
        triggers: [log_decline_reason, notify_stakeholders]

      - from: [sent, viewed]
        to: expired
        action: expire
        guards: [past_valid_date]
        triggers: [notify_recruiter]

      - from: [approved, sent, viewed]
        to: rescinded
        action: rescind
        triggers: [notify_candidate, log_reason]

      - from: [sent, viewed]
        to: superseded
        action: supersede
        guards: [new_offer_created]

  validations:
    - field: base_salary
      rule: within_range
      min_field: salary_range_min
      max_field: salary_range_max
      or: has_exception_approval
      message: "Base salary must be within approved range"

    - field: offer_valid_until
      rule: future_date
      when: status_in_draft_or_pending
      message: "Offer expiration must be in future"

    - field: proposed_start_date
      rule: after
      compare_to: sent_at
      message: "Start date must be after offer is sent"

  audit:
    enabled: true
    fields: [status, base_salary, signing_bonus, equity_shares, approval_chain]

compliance:
  - standard: pay_equity
    requirement: Document rationale for compensation decisions
  - standard: offer_letter
    requirement: Include required legal language by jurisdiction
