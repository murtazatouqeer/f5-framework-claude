# Formulary Entity
# F5 Framework v2.0 - Healthcare/Pharmacy
# Insurance formulary and drug coverage entity

entity:
  id: formulary
  name: Formulary
  name_ja: フォーミュラリー
  description: Insurance plan drug formulary and coverage information
  domain: healthcare
  subdomain: pharmacy
  version: "1.0.0"

  attributes:
    # Identifiers
    - name: formulary_id
      type: uuid
      primary_key: true
      description: Unique formulary entry ID
      
    - name: plan_id
      type: uuid
      required: true
      references: insurance_plan
      description: Associated insurance plan
      
    - name: formulary_code
      type: string
      length: 50
      description: Plan formulary identifier

    # Drug Information
    - name: ndc
      type: string
      length: 11
      references: drug
      description: Specific NDC (if applicable)
      
    - name: gpi
      type: string
      length: 14
      description: Generic Product Identifier
      
    - name: drug_name
      type: string
      length: 255
      required: true
      description: Drug name for display

    # Formulary Status
    - name: formulary_status
      type: enum
      values: [
        preferred_generic,
        non_preferred_generic,
        preferred_brand,
        non_preferred_brand,
        specialty,
        non_formulary,
        excluded
      ]
      required: true
      description: Formulary tier/status
      
    - name: tier
      type: integer
      min: 1
      max: 8
      description: Formulary tier number
      mapping:
        1: "Preferred generic - lowest copay"
        2: "Non-preferred generic"
        3: "Preferred brand"
        4: "Non-preferred brand"
        5: "Specialty"
        6: "Specialty tier 2"

    # Cost Sharing
    - name: copay_retail
      type: decimal
      precision: 10
      scale: 2
      description: Retail copay amount
      
    - name: copay_mail
      type: decimal
      precision: 10
      scale: 2
      description: Mail order copay amount
      
    - name: coinsurance_percent
      type: decimal
      precision: 5
      scale: 2
      description: Coinsurance percentage
      
    - name: deductible_applies
      type: boolean
      default: false
      description: Subject to deductible

    # Quantity Limits
    - name: quantity_limit
      type: decimal
      precision: 10
      scale: 2
      description: Maximum quantity allowed
      
    - name: quantity_limit_period
      type: enum
      values: [per_fill, per_30_days, per_month, per_year]
      description: Period for quantity limit
      
    - name: days_supply_limit
      type: integer
      description: Maximum days supply
      
    - name: fills_per_period
      type: integer
      description: Maximum fills in period

    # Requirements
    - name: prior_auth_required
      type: boolean
      default: false
      description: Prior authorization required
      
    - name: step_therapy_required
      type: boolean
      default: false
      description: Step therapy required
      
    - name: step_therapy_drugs
      type: json
      description: Drugs that must be tried first
      
    - name: specialty_pharmacy_required
      type: boolean
      default: false
      description: Must use specialty pharmacy
      
    - name: age_limit_min
      type: integer
      description: Minimum patient age
      
    - name: age_limit_max
      type: integer
      description: Maximum patient age
      
    - name: gender_limit
      type: enum
      values: [any, male, female]
      default: any
      description: Gender restriction
      
    - name: diagnosis_required
      type: json
      description: Required ICD-10 diagnosis codes

    # Alternative Information
    - name: preferred_alternative_ndc
      type: string
      length: 11
      description: Preferred alternative drug NDC
      
    - name: preferred_alternative_name
      type: string
      length: 255
      description: Preferred alternative drug name
      
    - name: therapeutic_alternatives
      type: json
      description: List of therapeutic alternatives

    # Coverage Notes
    - name: coverage_notes
      type: text
      description: Special coverage requirements
      
    - name: member_notes
      type: text
      description: Notes visible to members
      
    - name: pharmacy_notes
      type: text
      description: Notes for pharmacy staff

    # Effective Dates
    - name: effective_date
      type: date
      required: true
      description: Coverage start date
      
    - name: termination_date
      type: date
      description: Coverage end date

    # Status
    - name: status
      type: enum
      values: [active, pending, inactive]
      default: active
      
    - name: created_at
      type: timestamp
      auto: create
      
    - name: updated_at
      type: timestamp
      auto: update

  relationships:
    - name: insurance_plan
      type: many_to_one
      target: insurance_plan
      foreign_key: plan_id
      
    - name: drug
      type: many_to_one
      target: drug
      foreign_key: ndc
      
    - name: prior_authorizations
      type: one_to_many
      target: prior_authorization
      description: PA requests for this formulary item

  indexes:
    - fields: [plan_id, ndc]
      unique: true
      name: idx_formulary_plan_ndc
      
    - fields: [plan_id, gpi]
      name: idx_formulary_plan_gpi
      
    - fields: [formulary_status]
      name: idx_formulary_status
      
    - fields: [tier]
      name: idx_formulary_tier
      
    - fields: [effective_date, termination_date]
      name: idx_formulary_dates

  validations:
    - field: tier
      rule: range
      min: 1
      max: 8
      message: "Tier must be between 1 and 8"
      
    - field: coinsurance_percent
      rule: range
      min: 0
      max: 100
      message: "Coinsurance must be 0-100%"

  audit:
    enabled: true
    events: [create, update, delete]
    retention_days: 2555
