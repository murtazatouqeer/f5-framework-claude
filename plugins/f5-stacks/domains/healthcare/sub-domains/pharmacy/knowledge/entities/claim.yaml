# Claim Entity
# F5 Framework v2.0 - Healthcare/Pharmacy
# Insurance claim submission and adjudication entity

entity:
  id: claim
  name: Claim
  name_ja: 保険請求
  description: Pharmacy insurance claim submission and adjudication
  domain: healthcare
  subdomain: pharmacy
  version: "1.0.0"

  attributes:
    # Identifiers
    - name: claim_id
      type: uuid
      primary_key: true
      description: Unique claim identifier
      
    - name: transaction_id
      type: string
      length: 50
      description: NCPDP transaction ID
      
    - name: authorization_number
      type: string
      length: 50
      description: Payer authorization number
      
    - name: dispense_id
      type: uuid
      required: true
      references: dispense
      description: Associated dispense record
      
    - name: rx_number
      type: string
      required: true
      references: prescription

    # Patient Information
    - name: patient_id
      type: uuid
      required: true
      references: patient_profile
      
    - name: cardholder_id
      type: string
      length: 50
      required: true
      description: Insurance member ID
      
    - name: person_code
      type: string
      length: 3
      description: Person code on card
      
    - name: patient_relationship
      type: enum
      values: ["01", "02", "03", "04"]
      description: Relationship to cardholder
      mapping:
        "01": "Cardholder"
        "02": "Spouse"
        "03": "Child"
        "04": "Other"

    # Plan Information
    - name: plan_id
      type: uuid
      required: true
      references: insurance_plan
      
    - name: bin
      type: string
      length: 6
      required: true
      
    - name: pcn
      type: string
      length: 10
      
    - name: group_id
      type: string
      length: 20

    # Drug Information
    - name: ndc
      type: string
      length: 11
      required: true
      references: drug
      
    - name: quantity
      type: decimal
      precision: 10
      scale: 3
      required: true
      
    - name: days_supply
      type: integer
      required: true
      
    - name: compound_code
      type: enum
      values: ["0", "1", "2"]
      default: "0"
      description: 0=Not compound, 1=Compound, 2=Not specified
      
    - name: daw_code
      type: string
      length: 1
      required: true

    # Prescriber Information
    - name: prescriber_id
      type: string
      length: 15
      required: true
      description: Prescriber ID (NPI)
      
    - name: prescriber_id_qualifier
      type: string
      length: 2
      default: "01"
      description: 01=NPI, 12=DEA

    # Pricing Submitted
    - name: ingredient_cost_submitted
      type: decimal
      precision: 10
      scale: 2
      required: true
      
    - name: dispensing_fee_submitted
      type: decimal
      precision: 10
      scale: 2
      required: true
      
    - name: gross_amount_due
      type: decimal
      precision: 10
      scale: 2
      required: true
      
    - name: usual_customary_charge
      type: decimal
      precision: 10
      scale: 2
      description: U&C price
      
    - name: basis_of_cost
      type: enum
      values: ["01", "02", "03", "04", "05", "06", "07", "08"]
      description: Basis of ingredient cost submitted
      mapping:
        "01": "AWP"
        "02": "Local wholesaler"
        "03": "Direct"
        "04": "EAC"
        "05": "Acquisition"
        "06": "MAC"
        "07": "Usual & Customary"
        "08": "340B"

    # Response Pricing
    - name: ingredient_cost_paid
      type: decimal
      precision: 10
      scale: 2
      description: Payer paid ingredient cost
      
    - name: dispensing_fee_paid
      type: decimal
      precision: 10
      scale: 2
      description: Payer paid dispensing fee
      
    - name: total_amount_paid
      type: decimal
      precision: 10
      scale: 2
      description: Total payer payment
      
    - name: patient_pay_amount
      type: decimal
      precision: 10
      scale: 2
      description: Patient responsibility
      
    - name: copay_amount
      type: decimal
      precision: 10
      scale: 2
      
    - name: coinsurance_amount
      type: decimal
      precision: 10
      scale: 2
      
    - name: deductible_amount
      type: decimal
      precision: 10
      scale: 2
      
    - name: tax_amount
      type: decimal
      precision: 10
      scale: 2
      default: 0

    # Claim Status
    - name: status
      type: enum
      values: [
        pending, submitted, paid, rejected,
        reversed, resubmitted, partially_paid
      ]
      default: pending
      
    - name: response_code
      type: string
      length: 2
      description: NCPDP response status
      mapping:
        "A": "Approved"
        "C": "Captured - need to resubmit"
        "D": "Duplicate claim"
        "R": "Rejected"
        
    - name: rejection_codes
      type: json
      description: Array of rejection codes
      
    - name: rejection_messages
      type: json
      description: Array of rejection messages

    # Coordination of Benefits
    - name: other_coverage_code
      type: string
      length: 2
      description: Other coverage indicator
      
    - name: other_payer_amount
      type: decimal
      precision: 10
      scale: 2
      description: Amount paid by other payer
      
    - name: cob_sequence
      type: integer
      default: 1
      description: COB claim sequence

    # DUR Response
    - name: dur_pps_response
      type: json
      description: DUR response codes from payer

    # Timestamps
    - name: service_date
      type: date
      required: true
      description: Date of service
      
    - name: submission_datetime
      type: timestamp
      description: When claim was submitted
      
    - name: response_datetime
      type: timestamp
      description: When response received
      
    - name: reversal_datetime
      type: timestamp
      description: When claim was reversed

    # Audit
    - name: submitted_by
      type: uuid
      description: User who submitted claim
      
    - name: created_at
      type: timestamp
      auto: create
      
    - name: updated_at
      type: timestamp
      auto: update

  state_machine:
    initial: pending
    states:
      pending:
        description: Claim created, not yet submitted
        transitions:
          - to: submitted
            event: submit
            
      submitted:
        description: Claim submitted to payer
        transitions:
          - to: paid
            event: approve
          - to: rejected
            event: reject
          - to: partially_paid
            event: partial_pay
            
      paid:
        description: Claim paid by payer
        transitions:
          - to: reversed
            event: reverse
            
      rejected:
        description: Claim rejected by payer
        transitions:
          - to: resubmitted
            event: resubmit
            
      partially_paid:
        description: Claim partially paid
        transitions:
          - to: reversed
            event: reverse
            
      resubmitted:
        description: Claim resubmitted after correction
        transitions:
          - to: paid
            event: approve
          - to: rejected
            event: reject
            
      reversed:
        description: Claim reversed
        terminal: true

  relationships:
    - name: dispense
      type: many_to_one
      target: dispense
      foreign_key: dispense_id
      
    - name: prescription
      type: many_to_one
      target: prescription
      foreign_key: rx_number
      
    - name: patient
      type: many_to_one
      target: patient_profile
      foreign_key: patient_id
      
    - name: plan
      type: many_to_one
      target: insurance_plan
      foreign_key: plan_id
      
    - name: drug
      type: many_to_one
      target: drug
      foreign_key: ndc

  indexes:
    - fields: [claim_id]
      unique: true
      
    - fields: [transaction_id]
      name: idx_claim_transaction
      
    - fields: [dispense_id]
      name: idx_claim_dispense
      
    - fields: [patient_id, service_date]
      name: idx_claim_patient_date
      
    - fields: [status]
      name: idx_claim_status
      
    - fields: [service_date]
      name: idx_claim_service_date
      
    - fields: [bin, pcn, group_id]
      name: idx_claim_plan_ids

  validations:
    - field: quantity
      rule: positive
      message: "Quantity must be positive"
      
    - field: days_supply
      rule: range
      min: 1
      max: 365
      message: "Days supply must be 1-365"

  audit:
    enabled: true
    events: [create, submit, response, reverse]
    retention_days: 2555
    hipaa_compliant: true
