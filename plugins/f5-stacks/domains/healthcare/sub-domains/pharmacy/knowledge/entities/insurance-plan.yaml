# Insurance Plan Entity
# F5 Framework v2.0 - Healthcare/Pharmacy
# Insurance/PBM plan information entity

entity:
  id: insurance_plan
  name: Insurance Plan
  name_ja: 保険プラン
  description: Insurance and PBM plan configuration
  domain: healthcare
  subdomain: pharmacy
  version: "1.0.0"

  attributes:
    # Identifiers
    - name: plan_id
      type: uuid
      primary_key: true
      description: Unique plan identifier
      
    - name: plan_name
      type: string
      length: 255
      required: true
      description: Plan display name
      
    - name: plan_code
      type: string
      length: 50
      description: Internal plan code

    # NCPDP Identifiers
    - name: bin
      type: string
      length: 6
      required: true
      description: Bank Identification Number
      
    - name: pcn
      type: string
      length: 10
      description: Processor Control Number
      
    - name: group_id
      type: string
      length: 20
      description: Group identifier
      
    - name: help_desk_phone
      type: string
      length: 20
      description: Pharmacy help desk number

    # Plan Sponsor Information
    - name: pbm_name
      type: string
      length: 255
      required: true
      description: PBM/processor name (CVS Caremark, Express Scripts, etc.)
      
    - name: sponsor_name
      type: string
      length: 255
      description: Plan sponsor (employer, union, etc.)
      
    - name: plan_type
      type: enum
      values: [
        commercial, medicare_part_d, medicaid,
        workers_comp, tricare, discount_card,
        cash_card, manufacturer_coupon, copay_card
      ]
      required: true

    # Network Information
    - name: network_name
      type: string
      length: 100
      description: Network name
      
    - name: network_id
      type: string
      length: 50
      description: Network identifier
      
    - name: in_network
      type: boolean
      default: true
      description: Pharmacy is in network

    # Coverage Details
    - name: coverage_type
      type: enum
      values: [retail, mail, specialty, all]
      default: all
      description: Type of coverage
      
    - name: days_supply_retail
      type: integer
      default: 30
      description: Max days supply for retail
      
    - name: days_supply_mail
      type: integer
      default: 90
      description: Max days supply for mail order
      
    - name: refill_too_soon_days
      type: integer
      default: 7
      description: Days before refill allowed

    # Pricing Configuration
    - name: pricing_basis
      type: enum
      values: [mac, aac, awp, wac, usual_customary]
      default: mac
      description: Pricing basis for reimbursement
      
    - name: awp_discount
      type: decimal
      precision: 5
      scale: 2
      description: AWP discount percentage
      
    - name: dispensing_fee
      type: decimal
      precision: 10
      scale: 2
      description: Standard dispensing fee
      
    - name: generic_incentive_fee
      type: decimal
      precision: 10
      scale: 2
      description: Additional fee for generic dispense

    # Patient Cost Share Defaults
    - name: generic_copay
      type: decimal
      precision: 10
      scale: 2
      description: Default generic copay
      
    - name: brand_copay
      type: decimal
      precision: 10
      scale: 2
      description: Default brand copay
      
    - name: specialty_copay
      type: decimal
      precision: 10
      scale: 2
      description: Default specialty copay
      
    - name: coinsurance_percent
      type: decimal
      precision: 5
      scale: 2
      description: Coinsurance percentage
      
    - name: annual_deductible
      type: decimal
      precision: 10
      scale: 2
      description: Annual deductible amount
      
    - name: max_out_of_pocket
      type: decimal
      precision: 10
      scale: 2
      description: Annual out of pocket max

    # Claim Submission
    - name: claim_format
      type: enum
      values: [ncpdp_d0, ncpdp_51, paper]
      default: ncpdp_d0
      description: Claim submission format
      
    - name: submission_clarification
      type: string
      length: 2
      description: NCPDP submission clarification code
      
    - name: requires_diagnosis
      type: boolean
      default: false
      description: Diagnosis code required on claim
      
    - name: requires_prescriber_id
      type: boolean
      default: true
      description: Prescriber ID required
      
    - name: prescriber_id_qualifier
      type: enum
      values: [npi, dea, state_license]
      default: npi
      description: Primary prescriber ID type

    # Coordination of Benefits
    - name: cob_allowed
      type: boolean
      default: true
      description: COB claims accepted
      
    - name: cob_method
      type: enum
      values: [standard, carve_out, bypass]
      default: standard
      description: COB processing method

    # Specialty Requirements
    - name: limited_distribution
      type: boolean
      default: false
      description: Limited distribution drug coverage
      
    - name: specialty_pharmacy_only
      type: boolean
      default: false
      description: Specialty drugs require specialty pharmacy
      
    - name: specialty_network_id
      type: string
      description: Specialty network ID if different

    # Effective Dates
    - name: effective_date
      type: date
      required: true
      
    - name: termination_date
      type: date
      
    - name: contract_effective_date
      type: date
      description: Pharmacy contract effective date

    # Status
    - name: status
      type: enum
      values: [active, inactive, suspended, terminated]
      default: active
      
    - name: inactive_reason
      type: string

    # Notes
    - name: processing_notes
      type: text
      description: Notes for claim processing
      
    - name: billing_notes
      type: text
      description: Special billing instructions

    # Audit
    - name: created_at
      type: timestamp
      auto: create
      
    - name: updated_at
      type: timestamp
      auto: update

  relationships:
    - name: formulary
      type: one_to_many
      target: formulary
      foreign_key: plan_id
      description: Plan formulary entries
      
    - name: patients
      type: many_to_many
      target: patient_profile
      through: patient_insurance
      description: Patients with this plan
      
    - name: claims
      type: one_to_many
      target: claim
      foreign_key: plan_id
      description: Claims submitted to plan
      
    - name: prior_authorizations
      type: one_to_many
      target: prior_authorization
      foreign_key: plan_id

  indexes:
    - fields: [bin, pcn, group_id]
      name: idx_plan_identifiers
      
    - fields: [plan_name]
      name: idx_plan_name
      
    - fields: [pbm_name]
      name: idx_plan_pbm
      
    - fields: [plan_type]
      name: idx_plan_type
      
    - fields: [status]
      name: idx_plan_status

  validations:
    - field: bin
      rule: format
      pattern: "^[0-9]{6}$"
      message: "BIN must be 6 digits"
      
    - field: termination_date
      rule: after_or_null
      compare_field: effective_date
      message: "Termination must be after effective date"

  audit:
    enabled: true
    events: [create, update, delete]
    retention_days: 2555
