# Drug Recall Entity
# F5 Framework v2.0 - Healthcare/Pharmacy
# FDA drug recall management entity

entity:
  id: drug_recall
  name: Drug Recall
  name_ja: 医薬品リコール
  description: FDA drug recall tracking and management
  domain: healthcare
  subdomain: pharmacy
  version: "1.0.0"

  attributes:
    # Identifiers
    - name: recall_id
      type: uuid
      primary_key: true
      description: Unique recall record ID
      
    - name: fda_recall_number
      type: string
      length: 50
      description: FDA recall number
      
    - name: manufacturer_recall_number
      type: string
      length: 50
      description: Manufacturer's recall number

    # Drug Information
    - name: ndc
      type: string
      length: 11
      references: drug
      description: Recalled NDC (if specific)
      
    - name: drug_name
      type: string
      length: 255
      required: true
      description: Recalled drug name
      
    - name: manufacturer
      type: string
      length: 255
      required: true
      description: Manufacturer/labeler
      
    - name: lot_numbers
      type: json
      description: Affected lot numbers
      
    - name: expiration_dates
      type: json
      description: Affected expiration dates
      
    - name: ndc_range
      type: json
      description: Range of affected NDCs

    # Recall Classification
    - name: recall_class
      type: enum
      values: [I, II, III]
      required: true
      description: FDA recall classification
      mapping:
        I: "Dangerous or defective - could cause serious health problems or death"
        II: "May cause temporary health problems or slight threat of serious harm"
        III: "Not likely to cause adverse health reaction but violates FDA regulations"
        
    - name: recall_type
      type: enum
      values: [drug, device, biological]
      default: drug
      
    - name: voluntary
      type: boolean
      default: true
      description: Voluntary vs FDA-mandated recall

    # Recall Details
    - name: reason
      type: text
      required: true
      description: Reason for recall
      
    - name: description
      type: text
      description: Detailed recall description
      
    - name: distribution_pattern
      type: string
      description: Where product was distributed

    # Dates
    - name: recall_initiation_date
      type: date
      required: true
      description: Date recall was initiated
      
    - name: firm_press_release_date
      type: date
      description: Date of manufacturer press release
      
    - name: fda_notification_date
      type: date
      description: Date FDA notified
      
    - name: pharmacy_notified_date
      type: timestamp
      description: When pharmacy was notified
      
    - name: recall_termination_date
      type: date
      description: Date recall was terminated

    # Affected Inventory
    - name: inventory_checked
      type: boolean
      default: false
      description: Inventory has been checked
      
    - name: inventory_check_date
      type: timestamp
      description: When inventory was checked
      
    - name: inventory_check_by
      type: uuid
      description: Staff who checked inventory
      
    - name: affected_quantity
      type: decimal
      precision: 10
      scale: 2
      default: 0
      description: Quantity of affected product found
      
    - name: affected_inventory_ids
      type: json
      description: List of affected inventory records

    # Actions Taken
    - name: quarantined
      type: boolean
      default: false
      description: Product has been quarantined
      
    - name: quarantine_date
      type: timestamp
      description: When product was quarantined
      
    - name: quarantine_location
      type: string
      description: Quarantine storage location
      
    - name: returned_to_manufacturer
      type: boolean
      default: false
      description: Product returned to manufacturer
      
    - name: return_date
      type: date
      description: Date returned
      
    - name: return_tracking
      type: string
      description: Return shipment tracking number
      
    - name: credit_received
      type: boolean
      default: false
      description: Credit received from manufacturer
      
    - name: credit_amount
      type: decimal
      precision: 10
      scale: 2
      description: Credit amount received

    # Patient Notification
    - name: patients_affected
      type: boolean
      default: false
      description: Patients received affected product
      
    - name: patient_count
      type: integer
      description: Number of patients affected
      
    - name: patient_notification_required
      type: boolean
      default: false
      description: Patient notification is required
      
    - name: patients_notified
      type: boolean
      default: false
      description: Patients have been notified
      
    - name: notification_date
      type: date
      description: Date patients notified
      
    - name: notification_method
      type: enum
      values: [phone, letter, email, in_person]
      description: How patients were notified
      
    - name: notification_notes
      type: text
      description: Notes about patient notification

    # Documentation
    - name: documentation_complete
      type: boolean
      default: false
      description: All documentation complete
      
    - name: fda_form_3177
      type: boolean
      default: false
      description: FDA MedWatch Form 3177 submitted
      
    - name: attached_documents
      type: json
      description: List of attached documents

    # Status
    - name: status
      type: enum
      values: [
        new, acknowledged, checking_inventory,
        quarantined, returned, closed, no_impact
      ]
      default: new
      
    - name: priority
      type: enum
      values: [urgent, high, medium, low]
      description: Processing priority
      
    - name: closed_date
      type: date
      description: Date recall was closed for pharmacy
      
    - name: closed_by
      type: uuid
      description: Staff who closed recall

    # Notes
    - name: internal_notes
      type: text
      description: Internal pharmacy notes
      
    - name: action_summary
      type: text
      description: Summary of actions taken

    # Audit
    - name: created_at
      type: timestamp
      auto: create
      
    - name: updated_at
      type: timestamp
      auto: update
      
    - name: created_by
      type: uuid
      description: Staff who created record

  state_machine:
    initial: new
    states:
      new:
        description: Recall notification received
        transitions:
          - to: acknowledged
            event: acknowledge
            
      acknowledged:
        description: Recall acknowledged by pharmacy
        transitions:
          - to: checking_inventory
            event: start_check
          - to: no_impact
            event: no_affected_inventory
            
      checking_inventory:
        description: Checking for affected inventory
        transitions:
          - to: quarantined
            event: find_affected
          - to: no_impact
            event: none_found
            
      quarantined:
        description: Affected product quarantined
        transitions:
          - to: returned
            event: return_product
          - to: closed
            event: destroyed
            
      returned:
        description: Product returned to manufacturer
        transitions:
          - to: closed
            event: close
            guard: credit_received_or_waived
            
      no_impact:
        description: No affected inventory found
        transitions:
          - to: closed
            event: close
            
      closed:
        description: Recall fully processed
        terminal: true

  relationships:
    - name: drug
      type: many_to_one
      target: drug
      foreign_key: ndc
      
    - name: affected_inventory
      type: one_to_many
      target: drug_inventory
      description: Inventory records affected by recall
      
    - name: affected_dispenses
      type: one_to_many
      target: dispense
      description: Dispenses of recalled product

  indexes:
    - fields: [fda_recall_number]
      name: idx_recall_fda_number
      
    - fields: [ndc]
      name: idx_recall_ndc
      
    - fields: [recall_class]
      name: idx_recall_class
      
    - fields: [status]
      name: idx_recall_status
      
    - fields: [recall_initiation_date]
      name: idx_recall_date
      
    - fields: [manufacturer]
      name: idx_recall_manufacturer

  validations:
    - field: recall_class
      rule: in_list
      values: [I, II, III]
      message: "Recall class must be I, II, or III"
      
    - field: affected_quantity
      rule: non_negative
      message: "Quantity cannot be negative"

  audit:
    enabled: true
    events: [create, update, status_change, close]
    retention_days: 2555
    fda_compliant: true
