# Dispense Entity
# F5 Framework v2.0 - Healthcare/Pharmacy
# Medication dispensing record entity

entity:
  id: dispense
  name: Dispense
  name_ja: 調剤
  description: Record of medication dispensing event
  domain: healthcare
  subdomain: pharmacy
  version: "1.0.0"

  attributes:
    # Identifiers
    - name: dispense_id
      type: uuid
      primary_key: true
      description: Unique dispense record ID
      
    - name: rx_number
      type: string
      required: true
      references: prescription
      description: Associated prescription number
      
    - name: fill_number
      type: integer
      default: 0
      description: Fill number (0 = original, 1+ = refill)
      
    - name: partial_fill_sequence
      type: integer
      description: Sequence for partial fills

    # Drug Dispensed
    - name: ndc_dispensed
      type: string
      length: 11
      required: true
      references: drug
      description: Actual NDC dispensed
      
    - name: drug_name_dispensed
      type: string
      length: 255
      required: true
      
    - name: generic_substitution
      type: boolean
      default: false
      description: Generic substituted for brand
      
    - name: daw_code
      type: enum
      values: ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"]
      required: true

    # Quantity
    - name: quantity_dispensed
      type: decimal
      precision: 10
      scale: 2
      required: true
      description: Quantity dispensed
      
    - name: days_supply
      type: integer
      required: true
      description: Days supply dispensed
      
    - name: partial_fill
      type: boolean
      default: false
      description: Is partial fill
      
    - name: quantity_remaining
      type: decimal
      precision: 10
      scale: 2
      description: Remaining quantity for partial fills

    # Lot/Expiration Tracking
    - name: lot_number
      type: string
      length: 50
      description: Manufacturer lot number
      
    - name: drug_expiration_date
      type: date
      description: Drug product expiration date
      
    - name: inventory_id
      type: uuid
      references: drug_inventory
      description: Inventory record used

    # Pricing
    - name: ingredient_cost
      type: decimal
      precision: 10
      scale: 2
      description: Drug ingredient cost (AAC)
      
    - name: dispensing_fee
      type: decimal
      precision: 10
      scale: 2
      description: Pharmacy dispensing fee
      
    - name: gross_price
      type: decimal
      precision: 10
      scale: 2
      required: true
      description: Total gross price
      
    - name: discount
      type: decimal
      precision: 10
      scale: 2
      default: 0
      description: Applied discount
      
    - name: tax
      type: decimal
      precision: 10
      scale: 2
      default: 0
      description: Sales tax (OTC only)

    # Insurance/Payment
    - name: payment_type
      type: enum
      values: [insurance, cash, discount_card, assistance_program, workers_comp]
      required: true
      
    - name: plan_id
      type: uuid
      references: insurance_plan
      description: Insurance plan used
      
    - name: claim_id
      type: uuid
      references: claim
      description: Associated claim record
      
    - name: insurance_paid
      type: decimal
      precision: 10
      scale: 2
      default: 0
      description: Amount paid by insurance
      
    - name: patient_pay
      type: decimal
      precision: 10
      scale: 2
      required: true
      description: Patient responsibility (copay/coinsurance)
      
    - name: copay
      type: decimal
      precision: 10
      scale: 2
      description: Patient copay amount
      
    - name: coinsurance
      type: decimal
      precision: 10
      scale: 2
      description: Patient coinsurance amount
      
    - name: deductible_applied
      type: decimal
      precision: 10
      scale: 2
      description: Amount applied to deductible

    # Workflow Timestamps
    - name: fill_datetime
      type: timestamp
      description: When prescription was filled
      
    - name: verify_datetime
      type: timestamp
      description: When pharmacist verified
      
    - name: sold_datetime
      type: timestamp
      description: When dispensed to patient
      
    - name: will_call_datetime
      type: timestamp
      description: When placed in will call

    # Staff
    - name: filled_by
      type: uuid
      required: true
      description: Tech/clerk who filled
      
    - name: verified_by
      type: uuid
      description: Pharmacist who verified
      
    - name: sold_by
      type: uuid
      description: Staff who completed sale

    # Patient Interaction
    - name: counseling_offered
      type: boolean
      default: true
      description: Counseling offered to patient
      
    - name: counseling_accepted
      type: boolean
      description: Patient accepted counseling
      
    - name: counseling_notes
      type: text
      description: Counseling notes
      
    - name: patient_signature
      type: boolean
      default: false
      description: Patient signed for receipt
      
    - name: signature_type
      type: enum
      values: [electronic, paper, declined, hipaa_waiver]
      description: Type of signature obtained

    # Delivery
    - name: delivery_method
      type: enum
      values: [pickup, delivery, mail, drive_thru]
      default: pickup
      
    - name: delivery_address
      type: json
      description: Delivery address if applicable
      
    - name: pickup_person
      type: string
      description: Name of person picking up
      
    - name: pickup_relationship
      type: string
      description: Relationship to patient

    # Controlled Substance Specific
    - name: pdmp_reported
      type: boolean
      description: Reported to PDMP
      
    - name: pdmp_report_date
      type: timestamp
      description: When reported to PDMP
      
    - name: id_verified
      type: boolean
      description: Patient ID verified
      
    - name: id_type
      type: enum
      values: [drivers_license, state_id, passport, military_id, other]
      description: Type of ID used
      
    - name: id_number_hash
      type: string
      description: Hashed ID number (for tracking)

    # Status
    - name: status
      type: enum
      values: [
        pending_fill, filled, pending_verification, verified,
        ready, will_call, sold, returned, reversed, voided
      ]
      default: pending_fill
      
    - name: return_reason
      type: string
      description: Reason for return to stock
      
    - name: void_reason
      type: string
      description: Reason for voiding dispense

    # Audit
    - name: created_at
      type: timestamp
      auto: create
      
    - name: updated_at
      type: timestamp
      auto: update

  state_machine:
    initial: pending_fill
    states:
      pending_fill:
        description: Awaiting filling
        transitions:
          - to: filled
            event: fill_complete
          - to: voided
            event: void
            
      filled:
        description: Filled, awaiting verification
        transitions:
          - to: pending_verification
            event: submit_for_verification
          - to: pending_fill
            event: reject_fill
            
      pending_verification:
        description: Awaiting pharmacist verification
        transitions:
          - to: verified
            event: verify
            guard: pharmacist_only
          - to: filled
            event: reject
            
      verified:
        description: Verified, ready for pickup
        transitions:
          - to: ready
            event: move_to_ready
            
      ready:
        description: In will-call, ready for patient
        transitions:
          - to: will_call
            event: to_will_call
          - to: sold
            event: dispense
          - to: returned
            event: return_to_stock
            
      will_call:
        description: Stored in will-call area
        transitions:
          - to: sold
            event: dispense
          - to: returned
            event: return_to_stock
            guard: will_call_timeout
            
      sold:
        description: Dispensed to patient
        transitions:
          - to: reversed
            event: reverse
            guard: within_reversal_window
            
      returned:
        description: Returned to stock
        terminal: true
        
      reversed:
        description: Claim reversed
        terminal: true
        
      voided:
        description: Dispense voided
        terminal: true

  relationships:
    - name: prescription
      type: many_to_one
      target: prescription
      foreign_key: rx_number
      
    - name: drug
      type: many_to_one
      target: drug
      foreign_key: ndc_dispensed
      
    - name: inventory
      type: many_to_one
      target: drug_inventory
      foreign_key: inventory_id
      
    - name: claim
      type: one_to_one
      target: claim
      foreign_key: claim_id
      
    - name: controlled_substance_log
      type: one_to_one
      target: controlled_substance_log
      condition: "dea_schedule != 'unscheduled'"

  indexes:
    - fields: [dispense_id]
      unique: true
      
    - fields: [rx_number, fill_number]
      unique: true
      name: idx_dispense_rx_fill
      
    - fields: [ndc_dispensed]
      name: idx_dispense_ndc
      
    - fields: [sold_datetime]
      name: idx_dispense_sold
      
    - fields: [status]
      name: idx_dispense_status
      
    - fields: [filled_by]
      name: idx_dispense_filled_by
      
    - fields: [verified_by]
      name: idx_dispense_verified_by

  validations:
    - field: verified_by
      rule: required_if
      condition: "status in ['verified', 'ready', 'sold']"
      message: "Pharmacist verification required"
      
    - field: patient_pay
      rule: non_negative
      message: "Patient pay cannot be negative"
      
    - field: id_verified
      rule: required_if
      condition: "dea_schedule != 'unscheduled'"
      message: "ID verification required for controlled substances"

  audit:
    enabled: true
    events: [create, update, status_change, verify, dispense, void, reverse]
    retention_days: 2555
    hipaa_compliant: true
    dea_compliant: true
