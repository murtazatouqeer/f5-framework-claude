# Patient Profile Entity
# F5 Framework v2.0 - Healthcare/Pharmacy
# Pharmacy patient profile and medication history

entity:
  id: patient_profile
  name: Patient Profile
  name_ja: 患者プロファイル
  description: Pharmacy patient demographic and medication profile
  domain: healthcare
  subdomain: pharmacy
  version: "1.0.0"

  attributes:
    # Identifiers
    - name: patient_id
      type: uuid
      primary_key: true
      description: Unique patient identifier
      
    - name: external_patient_id
      type: string
      description: External system patient ID (EHR)
      
    - name: mrn
      type: string
      length: 50
      description: Medical record number

    # Demographics
    - name: first_name
      type: string
      length: 100
      required: true
      
    - name: middle_name
      type: string
      length: 100
      
    - name: last_name
      type: string
      length: 100
      required: true
      
    - name: suffix
      type: string
      length: 20
      
    - name: date_of_birth
      type: date
      required: true
      
    - name: gender
      type: enum
      values: [male, female, other, unknown]
      required: true
      
    - name: ssn_last4
      type: string
      length: 4
      encrypted: true
      description: Last 4 of SSN (encrypted)

    # Contact Information
    - name: address
      type: json
      required: true
      schema:
        street1: string
        street2: string
        city: string
        state: string
        zip: string
        country: string
        
    - name: phone_primary
      type: string
      length: 20
      required: true
      
    - name: phone_secondary
      type: string
      length: 20
      
    - name: email
      type: string
      length: 255
      format: email
      
    - name: preferred_contact_method
      type: enum
      values: [phone, email, sms, mail]
      default: phone

    # Clinical Information
    - name: allergies
      type: json
      description: List of allergies
      schema:
        items:
          allergen: string
          reaction: string
          severity: enum[mild, moderate, severe, life_threatening]
          onset_date: date
          
    - name: no_known_allergies
      type: boolean
      default: false
      description: Patient has no known allergies
      
    - name: health_conditions
      type: json
      description: Chronic conditions and diagnoses
      
    - name: pregnancy_status
      type: enum
      values: [not_pregnant, pregnant, breastfeeding, unknown, not_applicable]
      default: not_applicable

    # Preferences
    - name: preferred_language
      type: string
      length: 10
      default: "en"
      
    - name: requires_interpreter
      type: boolean
      default: false
      
    - name: preferred_pharmacy_location
      type: string
      description: Preferred pharmacy location ID
      
    - name: easy_open_caps
      type: boolean
      default: false
      description: Non-safety caps requested
      
    - name: large_print_labels
      type: boolean
      default: false
      
    - name: medication_sync_enrolled
      type: boolean
      default: false
      description: Enrolled in med sync program

    # Primary Care
    - name: pcp_npi
      type: string
      length: 10
      description: Primary care provider NPI
      
    - name: pcp_name
      type: string
      length: 255
      description: Primary care provider name
      
    - name: pcp_phone
      type: string
      length: 20

    # Emergency Contact
    - name: emergency_contact_name
      type: string
      length: 255
      
    - name: emergency_contact_phone
      type: string
      length: 20
      
    - name: emergency_contact_relationship
      type: string
      length: 50

    # Legal/Consent
    - name: hipaa_consent_date
      type: date
      description: Date HIPAA consent signed
      
    - name: hipaa_consent_on_file
      type: boolean
      default: false
      
    - name: medication_history_consent
      type: boolean
      default: false
      description: Consent to query medication history
      
    - name: authorized_representatives
      type: json
      description: People authorized to pick up medications
      schema:
        items:
          name: string
          relationship: string
          phone: string
          id_on_file: boolean

    # Controlled Substance Tracking
    - name: pdmp_consent
      type: boolean
      default: false
      description: Consent for PDMP query
      
    - name: controlled_substance_contract
      type: boolean
      default: false
      description: Pain management contract on file
      
    - name: contract_date
      type: date
      description: Contract effective date
      
    - name: contract_provider_npi
      type: string
      length: 10
      description: Contracted prescriber NPI

    # Status
    - name: status
      type: enum
      values: [active, inactive, deceased, transferred]
      default: active
      
    - name: inactive_reason
      type: string
      
    - name: inactive_date
      type: date
      
    - name: deceased_date
      type: date

    # Statistics
    - name: first_fill_date
      type: date
      description: Date of first prescription fill
      
    - name: last_fill_date
      type: date
      description: Date of most recent fill
      
    - name: total_fills
      type: integer
      default: 0
      description: Total prescriptions filled

    # Audit
    - name: created_at
      type: timestamp
      auto: create
      
    - name: updated_at
      type: timestamp
      auto: update
      
    - name: created_by
      type: uuid
      description: User who created profile

  relationships:
    - name: prescriptions
      type: one_to_many
      target: prescription
      foreign_key: patient_id
      
    - name: insurance_plans
      type: many_to_many
      target: insurance_plan
      through: patient_insurance
      description: Patient insurance coverage
      
    - name: prior_authorizations
      type: one_to_many
      target: prior_authorization
      foreign_key: patient_id
      
    - name: refills
      type: one_to_many
      target: refill
      foreign_key: patient_id

  indexes:
    - fields: [last_name, first_name, date_of_birth]
      name: idx_patient_name_dob
      
    - fields: [date_of_birth]
      name: idx_patient_dob
      
    - fields: [phone_primary]
      name: idx_patient_phone
      
    - fields: [external_patient_id]
      name: idx_patient_external
      
    - fields: [status]
      name: idx_patient_status

  validations:
    - field: date_of_birth
      rule: past_date
      message: "Date of birth must be in the past"
      
    - field: allergies
      rule: required_if_not
      condition: "no_known_allergies == false"
      message: "Allergies required or mark no known allergies"
      
    - field: hipaa_consent_on_file
      rule: required
      value: true
      message: "HIPAA consent must be on file"

  audit:
    enabled: true
    events: [create, update, delete, access]
    retention_days: 2555
    hipaa_compliant: true
    phi_fields: [first_name, last_name, date_of_birth, ssn_last4, address, phone_primary, allergies]
