name: Consent
display_name: Consent / Sự đồng ý
description: |
  Patient consent entity documenting authorization for treatment,
  procedures, data sharing, and research participation.
  Supports HIPAA authorization requirements.

domain: healthcare
sub_domain: ehr
entity_type: legal
version: "1.0"
status: active

# =============================================================================
# IDENTIFIERS
# =============================================================================
identifiers:
  primary:
    name: id
    type: uuid

  business:
    - name: consent_id
      display_name: Consent ID
      type: string
      pattern: "^CON-[0-9]{12}$"
      auto_generated: true

# =============================================================================
# STATUS
# =============================================================================
status_field:
  name: status
  type: enum
  values:
    - value: pending
      description: Awaiting patient signature

    - value: active
      description: Currently valid consent

    - value: expired
      description: Consent has expired

    - value: revoked
      description: Consent withdrawn by patient

    - value: superseded
      description: Replaced by newer consent

    - value: entered_in_error
      description: Entered in error

  default: pending

# =============================================================================
# ATTRIBUTES
# =============================================================================
attributes:
  classification:
    - name: consent_type
      type: enum
      required: true
      values:
        - value: treatment
          description: General consent to treatment

        - value: procedure
          description: Specific procedure consent

        - value: surgery
          description: Surgical consent

        - value: anesthesia
          description: Anesthesia consent

        - value: blood_transfusion
          description: Blood product consent

        - value: research
          description: Research participation

        - value: hipaa_authorization
          description: HIPAA disclosure authorization

        - value: data_sharing
          description: Health information sharing

        - value: immunization
          description: Vaccine consent

        - value: telehealth
          description: Telehealth services

        - value: photography
          description: Medical photography

        - value: advance_directive
          description: Living will/healthcare directive

        - value: dnr
          description: Do Not Resuscitate

        - value: organ_donation
          description: Organ/tissue donation

        - value: mental_health
          description: Mental health treatment

        - value: substance_abuse
          description: Substance abuse treatment

    - name: consent_category
      type: enum
      values:
        - treatment
        - procedure
        - disclosure
        - research
        - administrative

  context:
    - name: patient_id
      type: uuid
      required: true
      references: Patient

    - name: encounter_id
      type: uuid
      references: Encounter

    - name: procedure_id
      type: uuid
      references: Procedure
      description: For procedure-specific consent

    - name: research_study_id
      type: string
      description: IRB-approved study ID

  content:
    - name: consent_title
      type: string
      required: true
      max_length: 255

    - name: consent_description
      type: text
      required: true

    - name: consent_description_vi
      type: text

    - name: purpose
      type: text
      description: Purpose of treatment/procedure/disclosure

    - name: benefits
      type: text
      description: Expected benefits

    - name: risks
      type: text
      description: Known risks and complications

    - name: alternatives
      type: text
      description: Alternative treatments/options

    - name: right_to_refuse
      type: boolean
      default: true

    - name: questions_answered
      type: boolean
      default: true

  disclosure_specific:
    - name: information_to_disclose
      type: array
      items:
        type: enum
        values:
          - demographics
          - diagnoses
          - medications
          - lab_results
          - imaging
          - clinical_notes
          - mental_health
          - substance_abuse
          - hiv_status
          - genetic_info
          - entire_record

    - name: disclosure_recipient
      type: string
      description: Who will receive the information

    - name: disclosure_purpose
      type: string
      description: Purpose of disclosure

    - name: disclosure_expiration
      type: date

  validity:
    - name: effective_date
      type: date
      required: true

    - name: expiration_date
      type: date

    - name: no_expiration
      type: boolean
      default: false

    - name: valid_for_encounter_only
      type: boolean
      default: false

    - name: renewal_required
      type: boolean
      default: false

    - name: renewal_period_months
      type: integer

  signature:
    - name: signed_by
      type: string
      description: Name of person signing

    - name: signed_by_relationship
      type: enum
      values:
        - patient
        - parent
        - legal_guardian
        - healthcare_proxy
        - power_of_attorney
        - spouse
        - next_of_kin

    - name: signature_date
      type: date

    - name: signature_time
      type: time

    - name: signature_type
      type: enum
      values:
        - written
        - electronic
        - verbal
        - implied

    - name: signature_image_url
      type: string

    - name: witness_name
      type: string

    - name: witness_signature_date
      type: date

    - name: interpreter_used
      type: boolean
      default: false

    - name: interpreter_name
      type: string

    - name: interpreter_language
      type: string

  provider_attestation:
    - name: obtaining_provider_id
      type: uuid
      references: Provider

    - name: obtaining_provider_name
      type: string

    - name: provider_attestation
      type: text
      description: Provider statement that consent was informed

    - name: provider_signature_date
      type: date

  capacity:
    - name: patient_has_capacity
      type: boolean
      default: true

    - name: capacity_assessment_note
      type: text

    - name: substitute_decision_maker
      type: boolean
      default: false

    - name: substitute_name
      type: string

    - name: substitute_relationship
      type: string

    - name: legal_authority_document
      type: string
      description: POA, guardianship papers, etc.

  revocation:
    - name: revoked_date
      type: date

    - name: revoked_by
      type: string

    - name: revocation_reason
      type: text

    - name: revocation_applies_to
      type: text
      description: What specifically is revoked

  documentation:
    - name: form_version
      type: string

    - name: form_language
      type: string
      default: "en"

    - name: document_url
      type: string
      description: Scanned consent form

    - name: verbal_consent_note
      type: text
      description: Documentation for verbal consent

  emergency:
    - name: emergency_consent
      type: boolean
      default: false

    - name: emergency_circumstances
      type: text

    - name: unable_to_consent_reason
      type: text

    - name: two_physician_certification
      type: boolean

# =============================================================================
# RELATIONSHIPS
# =============================================================================
relationships:
  - name: patient
    type: many_to_one
    target: Patient
    foreign_key: patient_id

  - name: encounter
    type: many_to_one
    target: Encounter
    foreign_key: encounter_id

  - name: procedure
    type: many_to_one
    target: Procedure
    foreign_key: procedure_id

  - name: obtaining_provider
    type: many_to_one
    target: Provider
    foreign_key: obtaining_provider_id

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  - id: BR-CON-001
    name: Signature Required
    description: Consent must be signed to be active
    rule: |
      status = 'active'
      REQUIRES signed_by IS NOT NULL AND signature_date IS NOT NULL

  - id: BR-CON-002
    name: Informed Consent Elements
    description: Surgical consent requires all informed consent elements
    rule: |
      consent_type IN ('surgery', 'procedure')
      REQUIRES purpose IS NOT NULL
      AND risks IS NOT NULL
      AND alternatives IS NOT NULL
      AND questions_answered = TRUE

  - id: BR-CON-003
    name: Witness for Surgery
    description: Surgical consent requires witness
    rule: |
      consent_type IN ('surgery', 'anesthesia')
      REQUIRES witness_name IS NOT NULL

  - id: BR-CON-004
    name: Capacity Assessment
    description: Document capacity when using substitute
    rule: |
      substitute_decision_maker = TRUE
      REQUIRES capacity_assessment_note IS NOT NULL

  - id: BR-CON-005
    name: HIPAA Authorization Elements
    description: HIPAA authorization requires specific elements
    rule: |
      consent_type = 'hipaa_authorization'
      REQUIRES information_to_disclose IS NOT EMPTY
      AND disclosure_recipient IS NOT NULL
      AND disclosure_purpose IS NOT NULL
      AND (expiration_date IS NOT NULL OR no_expiration = TRUE)

  - id: BR-CON-006
    name: Research Consent
    description: Research consent requires study ID and IRB approval
    rule: |
      consent_type = 'research'
      REQUIRES research_study_id IS NOT NULL

  - id: BR-CON-007
    name: Emergency Consent Documentation
    description: Emergency consent requires documentation
    rule: |
      emergency_consent = TRUE
      REQUIRES emergency_circumstances IS NOT NULL
      AND unable_to_consent_reason IS NOT NULL

  - id: BR-CON-008
    name: Mental Health Consent
    description: Mental health consent has special requirements
    rule: |
      consent_type = 'mental_health'
      REQUIRES specific_mental_health_authorization

  - id: BR-CON-009
    name: Interpreter Documentation
    description: Document interpreter when used
    rule: |
      interpreter_used = TRUE
      REQUIRES interpreter_name IS NOT NULL
      AND interpreter_language IS NOT NULL

  - id: BR-CON-010
    name: Consent Expiration
    description: Check consent validity before procedure
    rule: |
      ON_PROCEDURE: verify_consent_valid(procedure_id)
      IF consent.status != 'active' OR consent.expiration_date < CURRENT_DATE
      THEN block_procedure

# =============================================================================
# INDEXES
# =============================================================================
indexes:
  - name: idx_consent_id
    columns: [consent_id]
    unique: true

  - name: idx_consent_patient
    columns: [patient_id]

  - name: idx_consent_encounter
    columns: [encounter_id]

  - name: idx_consent_procedure
    columns: [procedure_id]

  - name: idx_consent_type
    columns: [consent_type]

  - name: idx_consent_status
    columns: [status]

  - name: idx_consent_active
    columns: [patient_id, consent_type, status]
    condition: "status = 'active'"

  - name: idx_consent_expiring
    columns: [expiration_date]
    condition: "status = 'active' AND expiration_date IS NOT NULL"

# =============================================================================
# AUDIT
# =============================================================================
audit:
  enabled: true
  immutable_after_sign: true
  track_all_access: true
  logged_events:
    - consent_created
    - consent_signed
    - consent_revoked
    - consent_accessed
  retention_years: permanent
