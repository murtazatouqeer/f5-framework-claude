name: Medication
display_name: Medication / Thuá»‘c
description: |
  Medication catalog entity representing drugs in the formulary
  with dosing information, drug interactions, and clinical alerts.
  Serves as the master medication reference for prescribing.

domain: healthcare
sub_domain: ehr
entity_type: reference
version: "1.0"
status: active

# =============================================================================
# IDENTIFIERS
# =============================================================================
identifiers:
  primary:
    name: id
    type: uuid

  business:
    - name: medication_code
      display_name: Medication Code
      type: string
      pattern: "^MED-[0-9]{8}$"
      auto_generated: true

    - name: ndc
      display_name: National Drug Code
      type: string
      pattern: "^[0-9]{5}-[0-9]{4}-[0-9]{2}$"
      description: NDC-11 format

    - name: rxnorm_cui
      display_name: RxNorm CUI
      type: string
      description: RxNorm Concept Unique Identifier

# =============================================================================
# STATUS
# =============================================================================
status_field:
  name: status
  type: enum
  values:
    - value: active
      description: Available for prescribing

    - value: inactive
      description: No longer available

    - value: discontinued
      description: Discontinued by manufacturer

    - value: recalled
      description: Recalled - do not dispense

  default: active

# =============================================================================
# ATTRIBUTES
# =============================================================================
attributes:
  identification:
    - name: brand_name
      type: string
      max_length: 255

    - name: generic_name
      type: string
      required: true
      max_length: 255

    - name: generic_name_vi
      type: string
      max_length: 255

    - name: display_name
      type: string
      computed: true
      formula: "generic_name + ' (' + brand_name + ')'"

    - name: manufacturer
      type: string

    - name: labeler
      type: string

  classification:
    - name: drug_class
      type: array
      items:
        type: string
      description: Therapeutic drug class

    - name: pharmacologic_class
      type: array
      items:
        type: string

    - name: therapeutic_category
      type: string

    - name: atc_code
      type: string
      description: Anatomical Therapeutic Chemical code

    - name: is_brand
      type: boolean
      default: true

    - name: is_generic
      type: boolean
      default: false

    - name: is_otc
      type: boolean
      default: false
      description: Over-the-counter availability

  formulation:
    - name: dosage_form
      type: enum
      required: true
      values:
        - tablet
        - capsule
        - solution
        - suspension
        - syrup
        - injection
        - powder
        - cream
        - ointment
        - gel
        - patch
        - suppository
        - inhaler
        - drops
        - spray
        - lozenge
        - film

    - name: strength
      type: string
      max_length: 100
      example: "500 mg"

    - name: strength_value
      type: decimal
      precision: 10
      scale: 4

    - name: strength_unit
      type: string
      max_length: 50

    - name: route
      type: enum
      values:
        - oral
        - sublingual
        - topical
        - transdermal
        - intravenous
        - intramuscular
        - subcutaneous
        - inhalation
        - nasal
        - ophthalmic
        - otic
        - rectal
        - vaginal
        - intrathecal
        - epidural

    - name: package_size
      type: string

    - name: package_unit
      type: string

  controlled_substance:
    - name: is_controlled
      type: boolean
      default: false

    - name: dea_schedule
      type: enum
      values:
        - I
        - II
        - IIN
        - III
        - IIIN
        - IV
        - V

    - name: schedule_description
      type: string

    - name: epcs_required
      type: boolean
      default: false
      description: Electronic Prescribing for Controlled Substances required

  dosing:
    - name: typical_dose
      type: object
      properties:
        adult:
          type: object
          properties:
            min_dose:
              type: decimal
            max_dose:
              type: decimal
            unit:
              type: string
            frequency:
              type: string
        pediatric:
          type: object
          properties:
            dose_per_kg:
              type: decimal
            max_dose:
              type: decimal
            unit:
              type: string
            min_age:
              type: integer
            max_age:
              type: integer
        geriatric:
          type: object
          properties:
            dose_adjustment:
              type: string
            precautions:
              type: string

    - name: max_daily_dose
      type: decimal
      precision: 10
      scale: 4

    - name: max_daily_dose_unit
      type: string

    - name: renal_adjustment
      type: boolean
      default: false

    - name: hepatic_adjustment
      type: boolean
      default: false

  clinical_alerts:
    - name: black_box_warning
      type: boolean
      default: false

    - name: black_box_warning_text
      type: text

    - name: pregnancy_category
      type: enum
      values: [A, B, C, D, X, N]

    - name: lactation_safety
      type: enum
      values: [safe, caution, contraindicated, unknown]

    - name: contraindications
      type: array
      items:
        type: string

    - name: precautions
      type: array
      items:
        type: string

    - name: adverse_reactions
      type: array
      items:
        type: object
        properties:
          reaction:
            type: string
          frequency:
            type: enum
            values: [common, uncommon, rare, very_rare]

  interactions:
    - name: drug_interactions
      type: array
      items:
        type: object
        properties:
          interacting_drug_id:
            type: uuid
            references: Medication
          interacting_drug_name:
            type: string
          severity:
            type: enum
            values: [minor, moderate, major, contraindicated]
          description:
            type: string
          clinical_effect:
            type: string

    - name: food_interactions
      type: array
      items:
        type: string

    - name: lab_interactions
      type: array
      items:
        type: object
        properties:
          test_name:
            type: string
          effect:
            type: string

  formulary:
    - name: formulary_status
      type: enum
      values:
        - preferred
        - non_preferred
        - prior_auth_required
        - specialty
        - not_covered
      default: preferred

    - name: formulary_tier
      type: integer
      description: Formulary tier (1 = lowest cost)

    - name: prior_authorization_required
      type: boolean
      default: false

    - name: step_therapy_required
      type: boolean
      default: false

    - name: quantity_limit
      type: integer

    - name: quantity_limit_period
      type: enum
      values: [day, week, month, fill]

  substitution:
    - name: substitution_allowed
      type: boolean
      default: true

    - name: therapeutic_alternatives
      type: array
      items:
        type: uuid
        references: Medication

    - name: generic_equivalent_id
      type: uuid
      references: Medication

  storage:
    - name: storage_conditions
      type: string

    - name: refrigeration_required
      type: boolean
      default: false

    - name: light_sensitive
      type: boolean
      default: false

    - name: stability_info
      type: string

# =============================================================================
# RELATIONSHIPS
# =============================================================================
relationships:
  - name: generic_equivalent
    type: many_to_one
    target: Medication
    foreign_key: generic_equivalent_id

  - name: therapeutic_alternatives
    type: many_to_many
    target: Medication
    through: MedicationAlternative

  - name: drug_interactions
    type: many_to_many
    target: Medication
    through: DrugInteraction

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  - id: BR-MED-001
    name: Generic Name Required
    description: Every medication must have a generic name
    rule: generic_name IS NOT NULL

  - id: BR-MED-002
    name: Schedule for Controlled
    description: Controlled substances must have DEA schedule
    rule: |
      is_controlled = TRUE
      REQUIRES dea_schedule IS NOT NULL

  - id: BR-MED-003
    name: Black Box Alert
    description: Black box warnings must be displayed prominently
    rule: |
      black_box_warning = TRUE
      TRIGGERS display_black_box_alert(black_box_warning_text)

  - id: BR-MED-004
    name: Pregnancy Warning
    description: Category D and X drugs require pregnancy warning
    rule: |
      pregnancy_category IN ('D', 'X')
      TRIGGERS pregnancy_warning_check

  - id: BR-MED-005
    name: Drug Interaction Check
    description: Check drug interactions before prescribing
    rule: |
      ON_PRESCRIBE: check_drug_interactions(patient.active_medications)

  - id: BR-MED-006
    name: Formulary Check
    description: Non-preferred drugs trigger formulary alert
    rule: |
      formulary_status IN ('non_preferred', 'prior_auth_required', 'not_covered')
      TRIGGERS formulary_alert

  - id: BR-MED-007
    name: Renal Dose Adjustment
    description: Check renal function for medications requiring adjustment
    rule: |
      renal_adjustment = TRUE
      TRIGGERS check_renal_function_and_adjust

# =============================================================================
# INDEXES
# =============================================================================
indexes:
  - name: idx_medication_ndc
    columns: [ndc]
    unique: true
    condition: "ndc IS NOT NULL"

  - name: idx_medication_rxnorm
    columns: [rxnorm_cui]

  - name: idx_medication_generic
    columns: [generic_name]

  - name: idx_medication_brand
    columns: [brand_name]

  - name: idx_medication_class
    columns: [therapeutic_category]

  - name: idx_medication_controlled
    columns: [is_controlled, dea_schedule]

  - name: idx_medication_formulary
    columns: [formulary_status]

# =============================================================================
# SEED DATA - COMMON MEDICATIONS
# =============================================================================
seed_data:
  common_medications:
    - generic: Metformin
      brand: Glucophage
      class: Biguanides
      form: tablet
      strengths: [500, 850, 1000]
      unit: mg
      route: oral
      indication: Type 2 diabetes

    - generic: Lisinopril
      brand: Zestril
      class: ACE Inhibitors
      form: tablet
      strengths: [2.5, 5, 10, 20, 40]
      unit: mg
      route: oral
      indication: Hypertension

    - generic: Atorvastatin
      brand: Lipitor
      class: Statins
      form: tablet
      strengths: [10, 20, 40, 80]
      unit: mg
      route: oral
      indication: Hyperlipidemia

    - generic: Omeprazole
      brand: Prilosec
      class: Proton Pump Inhibitors
      form: capsule
      strengths: [10, 20, 40]
      unit: mg
      route: oral
      indication: GERD

    - generic: Amoxicillin
      brand: Amoxil
      class: Penicillins
      form: capsule
      strengths: [250, 500]
      unit: mg
      route: oral
      indication: Bacterial infections
