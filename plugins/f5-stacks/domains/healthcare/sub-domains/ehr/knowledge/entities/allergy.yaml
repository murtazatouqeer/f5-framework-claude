name: Allergy
display_name: Allergy / Dị ứng
description: |
  Patient allergy and adverse reaction entity documenting drug, food,
  and environmental allergies with severity and reaction details
  for clinical decision support and safety alerts.

domain: healthcare
sub_domain: ehr
entity_type: clinical
version: "1.0"
status: active

# =============================================================================
# IDENTIFIERS
# =============================================================================
identifiers:
  primary:
    name: id
    type: uuid

  business:
    - name: allergy_id
      display_name: Allergy ID
      type: string
      pattern: "^ALG-[0-9]{10}$"
      auto_generated: true

# =============================================================================
# STATUS
# =============================================================================
status_field:
  name: status
  type: enum
  values:
    - value: active
      description: Currently active allergy

    - value: inactive
      description: No longer clinically relevant

    - value: resolved
      description: Allergy has resolved (outgrown, desensitized)

    - value: entered_in_error
      description: Entered in error

  default: active

# =============================================================================
# ATTRIBUTES
# =============================================================================
attributes:
  classification:
    - name: allergy_type
      type: enum
      required: true
      values:
        - value: drug
          description: Medication allergy

        - value: food
          description: Food allergy

        - value: environmental
          description: Environmental allergen

        - value: biologic
          description: Biologic agent (vaccine, blood product)

        - value: latex
          description: Latex allergy

        - value: contrast
          description: Contrast media allergy

        - value: other
          description: Other allergen type

    - name: category
      type: enum
      values:
        - allergy
        - intolerance
        - adverse_reaction
        - sensitivity

    - name: criticality
      type: enum
      values:
        - low
        - high
        - unable_to_assess
      default: unable_to_assess

  patient:
    - name: patient_id
      type: uuid
      required: true
      references: Patient

  allergen:
    - name: allergen_name
      type: string
      required: true
      max_length: 500

    - name: allergen_name_vi
      type: string
      max_length: 500

    - name: allergen_code
      type: string
      description: RxNorm code for drugs, SNOMED for others

    - name: allergen_code_system
      type: enum
      values: [rxnorm, snomed, ndf_rt, unii, local]

    - name: allergen_class
      type: string
      description: Drug class for class-wide allergy (e.g., Penicillins)

    - name: allergen_class_code
      type: string

  drug_specific:
    - name: medication_id
      type: uuid
      references: Medication
      description: For drug allergies

    - name: ndc_code
      type: string
      description: National Drug Code

    - name: drug_class_allergy
      type: boolean
      default: false
      description: Allergy to entire drug class

    - name: cross_reactivity
      type: array
      items:
        type: object
        properties:
          drug_name:
            type: string
          drug_code:
            type: string
          likelihood:
            type: enum
            values: [definite, probable, possible]

  reaction:
    - name: reactions
      type: array
      items:
        type: object
        properties:
          reaction_description:
            type: string
          reaction_code:
            type: string
            description: SNOMED code
          reaction_severity:
            type: enum
            values: [mild, moderate, severe]
          reaction_onset:
            type: enum
            values: [immediate, delayed, unknown]

    - name: reaction_description
      type: string
      max_length: 1000
      description: Free-text reaction description

    - name: reaction_severity
      type: enum
      required: true
      values:
        - value: mild
          description: Minor localized reaction

        - value: moderate
          description: Systemic reaction, manageable

        - value: severe
          description: Severe systemic reaction

        - value: life_threatening
          description: Anaphylaxis, life-threatening

    - name: reaction_type
      type: array
      items:
        type: enum
        values:
          - rash
          - urticaria
          - hives
          - itching
          - swelling
          - angioedema
          - anaphylaxis
          - bronchospasm
          - difficulty_breathing
          - hypotension
          - nausea
          - vomiting
          - diarrhea
          - abdominal_pain
          - headache
          - dizziness
          - other

    - name: anaphylaxis_history
      type: boolean
      default: false

  verification:
    - name: verification_status
      type: enum
      values:
        - unconfirmed
        - confirmed
        - refuted
        - presumed
      default: unconfirmed

    - name: verification_method
      type: enum
      values:
        - patient_reported
        - provider_documented
        - allergy_test
        - challenge_test
        - medical_record_review

  history:
    - name: onset_date
      type: date
      description: When allergy was first identified

    - name: onset_age
      type: integer

    - name: last_occurrence_date
      type: date
      description: Last known reaction

    - name: resolution_date
      type: date
      description: If allergy resolved

  documentation:
    - name: reported_by
      type: enum
      values:
        - patient
        - family
        - provider
        - pharmacy
        - medical_record

    - name: recorded_by_id
      type: uuid
      references: User

    - name: recorded_at
      type: timestamp
      auto_set: on_create

    - name: last_reviewed_by
      type: uuid
      references: Provider

    - name: last_reviewed_at
      type: timestamp

    - name: source_encounter_id
      type: uuid
      references: Encounter

    - name: comments
      type: text

# =============================================================================
# RELATIONSHIPS
# =============================================================================
relationships:
  - name: patient
    type: many_to_one
    target: Patient
    foreign_key: patient_id

  - name: medication
    type: many_to_one
    target: Medication
    foreign_key: medication_id

  - name: recorder
    type: many_to_one
    target: User
    foreign_key: recorded_by_id

  - name: source_encounter
    type: many_to_one
    target: Encounter
    foreign_key: source_encounter_id

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  - id: BR-ALG-001
    name: Allergen Required
    description: Allergy must specify the allergen
    rule: allergen_name IS NOT NULL

  - id: BR-ALG-002
    name: Severity Required
    description: Reaction severity must be documented
    rule: reaction_severity IS NOT NULL

  - id: BR-ALG-003
    name: Drug Allergy Warning
    description: Drug allergies trigger prescription warnings
    rule: |
      allergy_type = 'drug' AND status = 'active'
      TRIGGERS prescription_allergy_check

  - id: BR-ALG-004
    name: Life-Threatening Alert
    description: Life-threatening allergies prominently displayed
    rule: |
      reaction_severity = 'life_threatening' OR anaphylaxis_history = TRUE
      TRIGGERS critical_allergy_alert

  - id: BR-ALG-005
    name: Class Allergy Expansion
    description: Drug class allergy checks all class members
    rule: |
      drug_class_allergy = TRUE
      TRIGGERS check_all_class_members(allergen_class)

  - id: BR-ALG-006
    name: Cross-Reactivity Check
    description: Check for cross-reactive drugs
    rule: |
      cross_reactivity IS NOT EMPTY
      TRIGGERS cross_reactivity_warning

  - id: BR-ALG-007
    name: NKDA Documentation
    description: No Known Drug Allergies must be documented
    rule: |
      patient.allergies.WHERE(allergy_type='drug' AND status='active').count = 0
      REQUIRES nkda_documented = TRUE OR allergy_review_completed = TRUE

  - id: BR-ALG-008
    name: Annual Review
    description: Allergies should be reviewed annually
    rule: |
      last_reviewed_at < CURRENT_DATE - INTERVAL '1 year'
      TRIGGERS allergy_review_reminder

# =============================================================================
# INDEXES
# =============================================================================
indexes:
  - name: idx_allergy_patient
    columns: [patient_id]

  - name: idx_allergy_status
    columns: [patient_id, status]

  - name: idx_allergy_type
    columns: [allergy_type]

  - name: idx_allergy_allergen
    columns: [allergen_code]

  - name: idx_allergy_medication
    columns: [medication_id]

  - name: idx_allergy_severity
    columns: [reaction_severity]
    condition: "status = 'active'"

# =============================================================================
# SEED DATA - COMMON ALLERGIES
# =============================================================================
seed_data:
  common_drug_allergies:
    - name: Penicillin
      class: Penicillins
      rxnorm: "733"
      cross_reactivity: [Amoxicillin, Ampicillin, Cephalosporins]

    - name: Sulfa drugs
      class: Sulfonamides
      rxnorm: "10831"

    - name: Aspirin
      class: NSAIDs
      rxnorm: "1191"
      cross_reactivity: [Ibuprofen, Naproxen]

    - name: Codeine
      class: Opioids
      rxnorm: "2670"

    - name: Iodine contrast
      class: Contrast media
      reactions: [rash, anaphylaxis]

  common_food_allergies:
    - name: Peanuts
      reactions: [anaphylaxis, hives, swelling]
      severity: life_threatening

    - name: Tree nuts
      reactions: [anaphylaxis, hives]

    - name: Shellfish
      reactions: [anaphylaxis, hives, nausea]

    - name: Eggs
      reactions: [hives, nausea, vomiting]

    - name: Milk
      reactions: [nausea, diarrhea, hives]

    - name: Wheat
      reactions: [hives, nausea, anaphylaxis]

    - name: Soy
      reactions: [hives, swelling]

  environmental_allergies:
    - name: Latex
      severity: moderate_to_severe
      cross_reactivity: [Banana, Avocado, Kiwi]

    - name: Bee sting
      reactions: [anaphylaxis, swelling]

    - name: Dust mites
      reactions: [rhinitis, asthma]

    - name: Pollen
      reactions: [rhinitis, conjunctivitis]
