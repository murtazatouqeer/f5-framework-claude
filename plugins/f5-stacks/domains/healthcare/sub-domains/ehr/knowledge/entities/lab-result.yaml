name: LabResult
display_name: Lab Result / Kết quả xét nghiệm
description: |
  Laboratory test result entity containing test values, reference ranges,
  interpretations, and critical value handling. Supports HL7/FHIR
  diagnostic report standards.

domain: healthcare
sub_domain: ehr
entity_type: observation
version: "1.0"
status: active

# =============================================================================
# IDENTIFIERS
# =============================================================================
identifiers:
  primary:
    name: id
    type: uuid

  business:
    - name: result_id
      display_name: Result ID
      type: string
      pattern: "^LR-[0-9]{12}$"
      auto_generated: true

    - name: observation_id
      type: string
      description: External observation identifier

# =============================================================================
# STATUS
# =============================================================================
status_field:
  name: status
  type: enum
  values:
    - value: registered
      description: Order received, no result yet

    - value: preliminary
      description: Initial result, may change

    - value: final
      description: Verified final result

    - value: amended
      description: Changed after final

    - value: corrected
      description: Error correction after final

    - value: cancelled
      description: Test cancelled

    - value: entered_in_error
      description: Result entered in error

  default: registered

# =============================================================================
# ATTRIBUTES
# =============================================================================
attributes:
  context:
    - name: order_id
      type: uuid
      required: true
      references: LabOrder

    - name: patient_id
      type: uuid
      required: true
      references: Patient

    - name: encounter_id
      type: uuid
      references: Encounter

  test_identification:
    - name: test_code
      type: string
      required: true
      description: LOINC code

    - name: test_name
      type: string
      required: true

    - name: test_name_vi
      type: string

    - name: test_category
      type: enum
      values:
        - chemistry
        - hematology
        - coagulation
        - urinalysis
        - microbiology
        - serology
        - immunology
        - blood_gas
        - toxicology
        - therapeutic_drug
        - endocrine
        - tumor_marker
        - genetics

    - name: test_subcategory
      type: string

  result_value:
    - name: value
      type: string
      description: Result value (can be numeric or text)

    - name: value_numeric
      type: decimal
      precision: 15
      scale: 5
      description: Numeric value if applicable

    - name: value_type
      type: enum
      values:
        - numeric
        - text
        - coded
        - narrative
        - ratio
        - range

    - name: unit
      type: string
      description: UCUM unit

    - name: unit_display
      type: string
      description: Display-friendly unit

  reference_range:
    - name: reference_range_low
      type: decimal
      precision: 15
      scale: 5

    - name: reference_range_high
      type: decimal
      precision: 15
      scale: 5

    - name: reference_range_text
      type: string
      description: Text description when range is complex

    - name: reference_range_type
      type: enum
      values:
        - normal
        - recommended
        - treatment
        - endocrine
        - pre_puberty
        - follicular
        - midcycle
        - luteal
        - postmenopausal

    - name: age_specific_range
      type: boolean
      default: false

    - name: gender_specific_range
      type: boolean
      default: false

  interpretation:
    - name: interpretation
      type: enum
      values:
        - value: N
          description: Normal
        - value: L
          description: Low
        - value: H
          description: High
        - value: LL
          description: Critical Low
        - value: HH
          description: Critical High
        - value: A
          description: Abnormal
        - value: AA
          description: Critical Abnormal
        - value: POS
          description: Positive
        - value: NEG
          description: Negative
        - value: IND
          description: Indeterminate
        - value: S
          description: Susceptible
        - value: R
          description: Resistant
        - value: I
          description: Intermediate

    - name: interpretation_text
      type: string

    - name: is_abnormal
      type: boolean
      computed: true
      formula: "interpretation NOT IN ('N', 'NEG')"

  critical_value:
    - name: is_critical
      type: boolean
      default: false

    - name: critical_value_type
      type: enum
      values:
        - critical_low
        - critical_high
        - critical_abnormal

    - name: critical_low_threshold
      type: decimal
      precision: 15
      scale: 5

    - name: critical_high_threshold
      type: decimal
      precision: 15
      scale: 5

    - name: critical_notified
      type: boolean
      default: false

    - name: critical_notified_to
      type: uuid
      references: Provider

    - name: critical_notified_at
      type: timestamp

    - name: critical_acknowledged
      type: boolean
      default: false

    - name: critical_acknowledged_by
      type: uuid
      references: Provider

    - name: critical_acknowledged_at
      type: timestamp

    - name: critical_action_taken
      type: text

  timing:
    - name: specimen_collected_at
      type: timestamp

    - name: specimen_received_at
      type: timestamp

    - name: resulted_at
      type: timestamp

    - name: verified_at
      type: timestamp

    - name: released_at
      type: timestamp

    - name: turnaround_time_hours
      type: decimal
      computed: true
      formula: "TIMESTAMPDIFF(HOUR, specimen_collected_at, released_at)"

  personnel:
    - name: performing_lab_id
      type: uuid
      references: Laboratory

    - name: performing_lab_name
      type: string

    - name: resulted_by
      type: uuid
      references: User

    - name: resulted_by_name
      type: string

    - name: verified_by
      type: uuid
      references: User

    - name: verified_by_name
      type: string

    - name: ordering_provider_id
      type: uuid
      references: Provider

  specimen:
    - name: specimen_type
      type: string

    - name: specimen_source
      type: string

    - name: specimen_condition
      type: enum
      values:
        - satisfactory
        - hemolyzed
        - lipemic
        - icteric
        - clotted
        - quantity_not_sufficient
        - contaminated

    - name: specimen_rejection_reason
      type: string

  methodology:
    - name: method
      type: string
      description: Test methodology/technique

    - name: instrument
      type: string

    - name: reagent_lot
      type: string

    - name: calibration_date
      type: date

  comments:
    - name: result_comment
      type: text

    - name: lab_comment
      type: text

    - name: specimen_comment
      type: text

  amendment:
    - name: original_value
      type: string
      description: Original value if amended/corrected

    - name: amendment_reason
      type: string

    - name: amended_by
      type: uuid
      references: User

    - name: amended_at
      type: timestamp

# =============================================================================
# RELATIONSHIPS
# =============================================================================
relationships:
  - name: order
    type: many_to_one
    target: LabOrder
    foreign_key: order_id

  - name: patient
    type: many_to_one
    target: Patient
    foreign_key: patient_id

  - name: encounter
    type: many_to_one
    target: Encounter
    foreign_key: encounter_id

  - name: ordering_provider
    type: many_to_one
    target: Provider
    foreign_key: ordering_provider_id

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  - id: BR-LR-001
    name: Value Required for Final
    description: Final results must have a value
    rule: |
      status = 'final'
      REQUIRES value IS NOT NULL

  - id: BR-LR-002
    name: Verification Required
    description: Final results require verification
    rule: |
      status = 'final'
      REQUIRES verified_by IS NOT NULL AND verified_at IS NOT NULL

  - id: BR-LR-003
    name: Critical Notification
    description: Critical values require immediate notification
    rule: |
      is_critical = TRUE
      TRIGGERS notify_ordering_provider
      WITHIN 30 minutes

  - id: BR-LR-004
    name: Critical Acknowledgment
    description: Critical values require acknowledgment within 1 hour
    rule: |
      is_critical = TRUE AND critical_notified = TRUE
      REQUIRES critical_acknowledged = TRUE
      WITHIN 60 minutes

  - id: BR-LR-005
    name: Amendment Documentation
    description: Amendments must include reason and original value
    rule: |
      status IN ('amended', 'corrected')
      REQUIRES amendment_reason IS NOT NULL AND
               original_value IS NOT NULL

  - id: BR-LR-006
    name: Reference Range Check
    description: Automatically flag abnormal values
    rule: |
      IF value_numeric < reference_range_low THEN interpretation = 'L'
      IF value_numeric > reference_range_high THEN interpretation = 'H'
      IF value_numeric < critical_low_threshold THEN interpretation = 'LL' AND is_critical = TRUE
      IF value_numeric > critical_high_threshold THEN interpretation = 'HH' AND is_critical = TRUE

  - id: BR-LR-007
    name: Result Immutability
    description: Final results cannot be changed, only amended
    rule: |
      status = 'final'
      PREVENTS UPDATE
      EXCEPT VIA amendment_workflow

  - id: BR-LR-008
    name: Specimen Quality
    description: Poor specimen quality requires documentation
    rule: |
      specimen_condition NOT IN ('satisfactory')
      REQUIRES specimen_comment IS NOT NULL

# =============================================================================
# INDEXES
# =============================================================================
indexes:
  - name: idx_lab_result_id
    columns: [result_id]
    unique: true

  - name: idx_lab_result_order
    columns: [order_id]

  - name: idx_lab_result_patient
    columns: [patient_id]

  - name: idx_lab_result_test
    columns: [test_code]

  - name: idx_lab_result_status
    columns: [status]

  - name: idx_lab_result_critical
    columns: [is_critical]
    condition: "is_critical = TRUE"

  - name: idx_lab_result_abnormal
    columns: [patient_id, interpretation]
    condition: "interpretation NOT IN ('N', 'NEG')"

  - name: idx_lab_result_date
    columns: [resulted_at]

# =============================================================================
# REFERENCE RANGES - COMMON TESTS
# =============================================================================
reference_ranges:
  - test_code: "2345-7"
    test_name: Glucose
    unit: mg/dL
    ranges:
      - type: normal
        low: 70
        high: 100
        critical_low: 40
        critical_high: 400
      - type: diabetic_target
        low: 80
        high: 130

  - test_code: "2160-0"
    test_name: Creatinine
    unit: mg/dL
    ranges:
      - gender: male
        low: 0.7
        high: 1.3
      - gender: female
        low: 0.6
        high: 1.1

  - test_code: "2823-3"
    test_name: Potassium
    unit: mEq/L
    ranges:
      - type: normal
        low: 3.5
        high: 5.0
        critical_low: 2.5
        critical_high: 6.5

  - test_code: "718-7"
    test_name: Hemoglobin
    unit: g/dL
    ranges:
      - gender: male
        low: 13.5
        high: 17.5
        critical_low: 7.0
        critical_high: 20.0
      - gender: female
        low: 12.0
        high: 16.0
        critical_low: 7.0
        critical_high: 20.0
