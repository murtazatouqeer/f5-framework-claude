name: ClinicalNote
display_name: Clinical Note / Ghi chú lâm sàng
description: |
  Clinical documentation entity for progress notes, H&P, discharge
  summaries, and other narrative clinical documentation. Supports
  structured templates and SOAP format.

domain: healthcare
sub_domain: ehr
entity_type: document
version: "1.0"
status: active

# =============================================================================
# IDENTIFIERS
# =============================================================================
identifiers:
  primary:
    name: id
    type: uuid

  business:
    - name: note_id
      display_name: Note ID
      type: string
      pattern: "^NOTE-[0-9]{12}$"
      auto_generated: true

# =============================================================================
# STATUS
# =============================================================================
status_field:
  name: status
  type: enum
  values:
    - value: draft
      description: Note in progress

    - value: pending_signature
      description: Awaiting author signature

    - value: pending_cosign
      description: Awaiting co-signature

    - value: signed
      description: Signed and finalized

    - value: addended
      description: Addendum added

    - value: entered_in_error
      description: Marked as error

  default: draft

# =============================================================================
# ATTRIBUTES
# =============================================================================
attributes:
  classification:
    - name: note_type
      type: enum
      required: true
      values:
        - value: progress_note
          description: Daily progress note

        - value: history_and_physical
          description: Initial H&P examination

        - value: admission_note
          description: Hospital admission documentation

        - value: consultation_note
          description: Specialty consultation

        - value: operative_note
          description: Surgical/operative report

        - value: procedure_note
          description: Non-surgical procedure documentation

        - value: discharge_summary
          description: Hospital discharge documentation

        - value: transfer_note
          description: Patient transfer documentation

        - value: emergency_note
          description: ED encounter note

        - value: telephone_encounter
          description: Phone consultation

        - value: nursing_note
          description: Nursing documentation

        - value: therapy_note
          description: PT/OT/Speech therapy

        - value: social_work_note
          description: Social work assessment

        - value: case_management_note
          description: Case management documentation

        - value: death_note
          description: Death summary

    - name: note_category
      type: enum
      values:
        - clinical
        - nursing
        - ancillary
        - administrative

    - name: specialty
      type: string

  context:
    - name: patient_id
      type: uuid
      required: true
      references: Patient

    - name: encounter_id
      type: uuid
      required: true
      references: Encounter

    - name: author_id
      type: uuid
      required: true
      references: Provider

    - name: author_name
      type: string

    - name: author_role
      type: string

    - name: author_credentials
      type: string

    - name: department_id
      type: uuid
      references: Department

    - name: facility_id
      type: uuid
      references: Facility

  timing:
    - name: service_date
      type: date
      required: true

    - name: service_time
      type: time

    - name: created_at
      type: timestamp
      auto_set: on_create

    - name: last_modified_at
      type: timestamp
      auto_set: on_update

    - name: signed_at
      type: timestamp

    - name: cosigned_at
      type: timestamp

  content:
    - name: title
      type: string
      max_length: 255

    - name: content_format
      type: enum
      values:
        - free_text
        - soap
        - template
        - structured
      default: free_text

    - name: template_id
      type: uuid
      references: NoteTemplate

    - name: template_name
      type: string

  soap_format:
    - name: subjective
      type: text
      description: Patient's reported symptoms and history

    - name: chief_complaint
      type: string
      max_length: 500

    - name: history_present_illness
      type: text

    - name: review_of_systems
      type: object
      properties:
        constitutional:
          type: text
        eyes:
          type: text
        ears_nose_throat:
          type: text
        cardiovascular:
          type: text
        respiratory:
          type: text
        gastrointestinal:
          type: text
        genitourinary:
          type: text
        musculoskeletal:
          type: text
        skin:
          type: text
        neurological:
          type: text
        psychiatric:
          type: text
        endocrine:
          type: text
        hematologic:
          type: text
        allergic:
          type: text

    - name: objective
      type: text
      description: Provider's examination findings

    - name: physical_exam
      type: object
      properties:
        general:
          type: text
        vital_signs:
          type: text
        heent:
          type: text
        neck:
          type: text
        cardiovascular:
          type: text
        pulmonary:
          type: text
        abdomen:
          type: text
        extremities:
          type: text
        neurological:
          type: text
        skin:
          type: text
        psychiatric:
          type: text

    - name: assessment
      type: text
      description: Provider's clinical assessment

    - name: diagnoses
      type: array
      items:
        type: object
        properties:
          diagnosis_id:
            type: uuid
          icd10_code:
            type: string
          description:
            type: string
          status:
            type: string

    - name: plan
      type: text
      description: Treatment plan

    - name: orders_placed
      type: array
      items:
        type: object
        properties:
          order_type:
            type: enum
            values: [medication, lab, imaging, referral, procedure]
          order_id:
            type: uuid
          description:
            type: string

    - name: patient_education
      type: text

    - name: follow_up
      type: text

  additional_sections:
    - name: past_medical_history
      type: text

    - name: past_surgical_history
      type: text

    - name: family_history
      type: text

    - name: social_history
      type: text

    - name: medications_reviewed
      type: boolean

    - name: allergies_reviewed
      type: boolean

    - name: data_reviewed
      type: text
      description: Labs, imaging, other data reviewed

  authentication:
    - name: signed_by
      type: uuid
      references: Provider

    - name: signature_type
      type: enum
      values:
        - electronic
        - digital
        - verbal_order

    - name: cosign_required
      type: boolean
      default: false

    - name: cosigned_by
      type: uuid
      references: Provider

    - name: attestation_statement
      type: text

  amendments:
    - name: addenda
      type: array
      items:
        type: object
        properties:
          addendum_id:
            type: uuid
          added_at:
            type: timestamp
          added_by:
            type: uuid
          added_by_name:
            type: string
          content:
            type: text
          reason:
            type: string

    - name: late_entry
      type: boolean
      default: false

    - name: late_entry_reason
      type: string

  billing:
    - name: time_spent_minutes
      type: integer
      description: Time spent for time-based billing

    - name: complexity_level
      type: enum
      values:
        - straightforward
        - low
        - moderate
        - high
      description: MDM complexity for E/M coding

    - name: mdm_elements
      type: object
      properties:
        problems_addressed:
          type: integer
        data_reviewed:
          type: enum
          values: [minimal, limited, moderate, extensive]
        risk_level:
          type: enum
          values: [minimal, low, moderate, high]

# =============================================================================
# RELATIONSHIPS
# =============================================================================
relationships:
  - name: patient
    type: many_to_one
    target: Patient
    foreign_key: patient_id

  - name: encounter
    type: many_to_one
    target: Encounter
    foreign_key: encounter_id

  - name: author
    type: many_to_one
    target: Provider
    foreign_key: author_id

  - name: signer
    type: many_to_one
    target: Provider
    foreign_key: signed_by

  - name: cosigner
    type: many_to_one
    target: Provider
    foreign_key: cosigned_by

  - name: template
    type: many_to_one
    target: NoteTemplate
    foreign_key: template_id

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  - id: BR-NOTE-001
    name: Author Required
    description: Every note must have an author
    rule: author_id IS NOT NULL

  - id: BR-NOTE-002
    name: Signature Required
    description: Notes must be signed for final status
    rule: |
      status = 'signed'
      REQUIRES signed_by IS NOT NULL AND signed_at IS NOT NULL

  - id: BR-NOTE-003
    name: Cosign for Trainees
    description: Trainee notes require co-signature
    rule: |
      author.classification IN ('resident', 'fellow', 'intern', 'student')
      REQUIRES cosign_required = TRUE

  - id: BR-NOTE-004
    name: Timeliness - Progress Notes
    description: Progress notes due within 24 hours
    rule: |
      note_type = 'progress_note'
      REQUIRES signed_at <= service_date + INTERVAL '24 hours'
      WARN IF signed_at > service_date + INTERVAL '24 hours'

  - id: BR-NOTE-005
    name: Timeliness - H&P
    description: H&P due within 24 hours of admission
    rule: |
      note_type = 'history_and_physical'
      REQUIRES signed_at <= encounter.admission_time + INTERVAL '24 hours'

  - id: BR-NOTE-006
    name: Timeliness - Operative Note
    description: Operative notes due immediately post-op
    rule: |
      note_type = 'operative_note'
      REQUIRES signed_at <= procedure.end_time + INTERVAL '24 hours'

  - id: BR-NOTE-007
    name: Timeliness - Discharge Summary
    description: Discharge summary due within 48 hours
    rule: |
      note_type = 'discharge_summary'
      REQUIRES signed_at <= encounter.discharge_time + INTERVAL '48 hours'

  - id: BR-NOTE-008
    name: Late Entry Marking
    description: Late entries must be clearly marked
    rule: |
      IF created_at > service_date + INTERVAL '24 hours'
      THEN late_entry = TRUE
      AND late_entry_reason IS REQUIRED

  - id: BR-NOTE-009
    name: Allergy Review
    description: Clinical notes should document allergy review
    rule: |
      note_type IN ('history_and_physical', 'admission_note')
      REQUIRES allergies_reviewed = TRUE

  - id: BR-NOTE-010
    name: Medication Review
    description: Clinical notes should document medication review
    rule: |
      note_type IN ('history_and_physical', 'admission_note', 'discharge_summary')
      REQUIRES medications_reviewed = TRUE

# =============================================================================
# INDEXES
# =============================================================================
indexes:
  - name: idx_note_id
    columns: [note_id]
    unique: true

  - name: idx_note_patient
    columns: [patient_id]

  - name: idx_note_encounter
    columns: [encounter_id]

  - name: idx_note_author
    columns: [author_id]

  - name: idx_note_type
    columns: [note_type]

  - name: idx_note_status
    columns: [status]

  - name: idx_note_service_date
    columns: [service_date]

  - name: idx_note_pending_cosign
    columns: [cosign_required, status]
    condition: "cosign_required = TRUE AND status = 'pending_cosign'"
