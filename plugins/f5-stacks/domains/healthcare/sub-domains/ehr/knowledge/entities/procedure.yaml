name: Procedure
display_name: Procedure / Thủ thuật
description: |
  Clinical procedure entity representing medical, surgical, and diagnostic
  procedures performed on patients. Supports CPT, HCPCS, and ICD-10-PCS coding.

domain: healthcare
sub_domain: ehr
entity_type: clinical
version: "1.0"
status: active

# =============================================================================
# IDENTIFIERS
# =============================================================================
identifiers:
  primary:
    name: id
    type: uuid

  business:
    - name: procedure_id
      display_name: Procedure ID
      type: string
      pattern: "^PRC-[0-9]{10}$"
      auto_generated: true

# =============================================================================
# STATUS
# =============================================================================
status_field:
  name: status
  type: enum
  values:
    - value: planned
      description: Scheduled but not started

    - value: in_progress
      description: Currently being performed

    - value: completed
      description: Successfully completed

    - value: cancelled
      description: Cancelled before start

    - value: aborted
      description: Stopped before completion

    - value: entered_in_error
      description: Entered in error

  default: planned

# =============================================================================
# ATTRIBUTES
# =============================================================================
attributes:
  classification:
    - name: procedure_type
      type: enum
      required: true
      values:
        - diagnostic
        - therapeutic
        - surgical
        - preventive
        - laboratory
        - imaging
        - evaluation
        - counseling

    - name: procedure_category
      type: enum
      values:
        - major_surgery
        - minor_surgery
        - invasive
        - non_invasive
        - ambulatory
        - bedside

    - name: surgical_approach
      type: enum
      values:
        - open
        - laparoscopic
        - robotic
        - endoscopic
        - percutaneous
        - not_applicable

  context:
    - name: patient_id
      type: uuid
      required: true
      references: Patient

    - name: encounter_id
      type: uuid
      required: true
      references: Encounter

    - name: performing_provider_id
      type: uuid
      required: true
      references: Provider

    - name: assistant_providers
      type: array
      items:
        type: uuid
        references: Provider

    - name: anesthesiologist_id
      type: uuid
      references: Provider

  coding:
    - name: cpt_code
      type: string
      pattern: "^[0-9]{5}$"
      description: CPT-4 code

    - name: cpt_description
      type: string

    - name: cpt_description_vi
      type: string

    - name: hcpcs_code
      type: string
      description: HCPCS Level II code

    - name: icd10_pcs_code
      type: string
      description: ICD-10-PCS code (inpatient)

    - name: snomed_code
      type: string

    - name: modifier_codes
      type: array
      items:
        type: string
      description: CPT modifiers (e.g., 25, 59)

  clinical:
    - name: procedure_name
      type: string
      required: true
      max_length: 500

    - name: procedure_name_vi
      type: string

    - name: clinical_indication
      type: string
      description: Reason for procedure

    - name: diagnosis_ids
      type: array
      items:
        type: uuid
        references: Diagnosis
      description: Associated diagnoses

    - name: body_site
      type: string

    - name: laterality
      type: enum
      values: [left, right, bilateral, not_applicable]

  timing:
    - name: scheduled_date
      type: date

    - name: scheduled_time
      type: time

    - name: performed_date
      type: date
      required_when: "status IN ('completed', 'aborted')"

    - name: start_time
      type: timestamp

    - name: end_time
      type: timestamp

    - name: duration_minutes
      type: integer
      computed: true
      formula: "TIMESTAMPDIFF(MINUTE, start_time, end_time)"

  location:
    - name: facility_id
      type: uuid
      references: Facility

    - name: department_id
      type: uuid
      references: Department

    - name: room_number
      type: string

    - name: procedure_room_type
      type: enum
      values:
        - operating_room
        - procedure_room
        - exam_room
        - bedside
        - radiology_suite
        - endoscopy_suite
        - cath_lab

  anesthesia:
    - name: anesthesia_type
      type: enum
      values:
        - none
        - local
        - regional
        - sedation
        - general
        - spinal
        - epidural

    - name: anesthesia_start
      type: timestamp

    - name: anesthesia_end
      type: timestamp

    - name: asa_class
      type: enum
      values:
        - ASA_I
        - ASA_II
        - ASA_III
        - ASA_IV
        - ASA_V
        - ASA_VI
      description: ASA Physical Status Classification

  documentation:
    - name: pre_procedure_notes
      type: text

    - name: procedure_notes
      type: text
      description: Operative/procedure report

    - name: findings
      type: text

    - name: complications
      type: array
      items:
        type: string

    - name: specimens_collected
      type: array
      items:
        type: object
        properties:
          specimen_type:
            type: string
          collection_site:
            type: string
          sent_to:
            type: enum
            values: [pathology, lab, microbiology]

    - name: implants_used
      type: array
      items:
        type: object
        properties:
          device_name:
            type: string
          manufacturer:
            type: string
          lot_number:
            type: string
          serial_number:
            type: string
          udi:
            type: string
            description: Unique Device Identifier

    - name: blood_loss_ml
      type: integer

    - name: fluids_given_ml
      type: integer

  consent:
    - name: consent_obtained
      type: boolean
      required: true

    - name: consent_id
      type: uuid
      references: Consent

    - name: consent_obtained_by
      type: uuid
      references: Provider

    - name: consent_obtained_at
      type: timestamp

  outcomes:
    - name: outcome
      type: enum
      values:
        - successful
        - partially_successful
        - unsuccessful
        - inconclusive

    - name: disposition
      type: enum
      values:
        - discharge_home
        - observation
        - admission
        - transfer
        - pacu
        - icu

    - name: follow_up_required
      type: boolean

    - name: follow_up_instructions
      type: text

# =============================================================================
# RELATIONSHIPS
# =============================================================================
relationships:
  - name: patient
    type: many_to_one
    target: Patient
    foreign_key: patient_id

  - name: encounter
    type: many_to_one
    target: Encounter
    foreign_key: encounter_id

  - name: performing_provider
    type: many_to_one
    target: Provider
    foreign_key: performing_provider_id

  - name: diagnoses
    type: many_to_many
    target: Diagnosis
    description: Diagnoses justifying the procedure

  - name: consent
    type: many_to_one
    target: Consent
    foreign_key: consent_id

  - name: operative_report
    type: one_to_one
    target: MedicalRecord
    condition: "document_class = 'operative_report'"

# =============================================================================
# BUSINESS RULES
# =============================================================================
business_rules:
  - id: BR-PRC-001
    name: Consent Required
    description: Procedures require documented consent
    rule: |
      procedure_category IN ('major_surgery', 'invasive')
      REQUIRES consent_obtained = TRUE AND consent_id IS NOT NULL

  - id: BR-PRC-002
    name: CPT Code Required
    description: Completed procedures must have CPT code
    rule: |
      status = 'completed' REQUIRES cpt_code IS NOT NULL

  - id: BR-PRC-003
    name: Performing Provider Required
    description: Must document who performed the procedure
    rule: performing_provider_id IS NOT NULL

  - id: BR-PRC-004
    name: Operative Report Timeline
    description: Operative report required within 24 hours
    rule: |
      procedure_category = 'major_surgery' AND status = 'completed'
      REQUIRES operative_report EXISTS
      WITHIN 24 hours of end_time

  - id: BR-PRC-005
    name: Laterality Documentation
    description: Procedures on paired organs require laterality
    rule: |
      body_site IN PAIRED_ORGANS_LIST
      REQUIRES laterality IS NOT NULL AND laterality != 'not_applicable'

  - id: BR-PRC-006
    name: Anesthesia Documentation
    description: Procedures with anesthesia require complete documentation
    rule: |
      anesthesia_type NOT IN ('none', 'local')
      REQUIRES anesthesiologist_id IS NOT NULL AND
               anesthesia_start IS NOT NULL AND
               anesthesia_end IS NOT NULL

  - id: BR-PRC-007
    name: Implant Tracking
    description: Implants must be tracked with UDI
    rule: |
      implants_used IS NOT EMPTY
      REQUIRES EACH implant.udi IS NOT NULL OR implant.lot_number IS NOT NULL

  - id: BR-PRC-008
    name: Complication Documentation
    description: Complications must be documented
    rule: |
      outcome IN ('partially_successful', 'unsuccessful')
      REQUIRES complications IS NOT EMPTY OR procedure_notes CONTAINS complication_documentation

# =============================================================================
# INDEXES
# =============================================================================
indexes:
  - name: idx_procedure_patient
    columns: [patient_id]

  - name: idx_procedure_encounter
    columns: [encounter_id]

  - name: idx_procedure_provider
    columns: [performing_provider_id]

  - name: idx_procedure_cpt
    columns: [cpt_code]

  - name: idx_procedure_date
    columns: [performed_date]

  - name: idx_procedure_status
    columns: [status]

# =============================================================================
# SEED DATA - COMMON PROCEDURES
# =============================================================================
seed_data:
  common_procedures:
    - cpt: "99213"
      description: Office visit, established patient, low complexity
      description_vi: Khám tái khám, độ phức tạp thấp

    - cpt: "99214"
      description: Office visit, established patient, moderate complexity
      description_vi: Khám tái khám, độ phức tạp trung bình

    - cpt: "36415"
      description: Collection of venous blood by venipuncture
      description_vi: Lấy máu tĩnh mạch

    - cpt: "71046"
      description: Chest X-ray, 2 views
      description_vi: X-quang ngực 2 phim

    - cpt: "93000"
      description: Electrocardiogram, complete
      description_vi: Điện tâm đồ hoàn chỉnh

    - cpt: "43239"
      description: Upper GI endoscopy with biopsy
      description_vi: Nội soi tiêu hóa trên có sinh thiết

    - cpt: "27447"
      description: Total knee replacement
      description_vi: Thay khớp gối toàn phần
