# VitalReading Entity
# F5 Framework v2.0 - Healthcare/Telemedicine
# Remote vital sign measurements from monitoring devices

entity:
  id: vital-reading
  name: VitalReading
  name_ja: バイタルサイン測定
  description: Vital sign readings from remote monitoring devices
  domain: healthcare
  subdomain: telemedicine

  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true
      description: Unique identifier

    - name: reading_id
      type: string
      format: "VR-{YYYYMMDD}-{XXXX}"
      unique: true
      indexed: true
      description: Human-readable reading ID

    - name: patient_id
      type: uuid
      required: true
      indexed: true
      foreign_key: patient.id
      description: Patient who provided reading

    - name: device_id
      type: uuid
      nullable: true
      indexed: true
      foreign_key: remote_monitoring_device.id
      description: Device that captured reading

    - name: visit_id
      type: uuid
      nullable: true
      indexed: true
      foreign_key: tele_visit.id
      description: Associated telehealth visit (if during visit)

    # Reading Type & Values
    - name: reading_type
      type: enum
      values:
        - blood_pressure
        - blood_glucose
        - pulse_oximetry
        - weight
        - temperature
        - heart_rate
        - respiratory_rate
        - peak_flow
        - bmi
        - body_fat
        - ecg
        - activity
        - sleep
      required: true
      indexed: true
      description: Type of vital reading

    - name: value
      type: decimal
      precision: 10
      scale: 2
      required: true
      description: Primary measurement value

    - name: value_secondary
      type: decimal
      precision: 10
      scale: 2
      nullable: true
      description: Secondary value (e.g., diastolic BP, SpO2 pulse)

    - name: value_tertiary
      type: decimal
      precision: 10
      scale: 2
      nullable: true
      description: Tertiary value (e.g., MAP for BP)

    - name: unit
      type: string
      required: true
      description: Unit of measurement

    - name: unit_secondary
      type: string
      nullable: true
      description: Secondary unit if different

    # Timing
    - name: reading_time
      type: datetime
      required: true
      indexed: true
      description: When measurement was taken

    - name: received_time
      type: datetime
      required: true
      default: now()
      description: When system received reading

    - name: timezone
      type: string
      default: "America/New_York"
      description: Patient's timezone

    # Context
    - name: context
      type: enum
      values:
        - fasting
        - post_meal
        - pre_meal
        - before_medication
        - after_medication
        - resting
        - active
        - sleeping
        - standing
        - sitting
        - lying_down
        - exercise
        - unknown
      default: unknown
      description: Context of measurement

    - name: context_details
      type: string
      nullable: true
      max_length: 500
      description: Additional context notes

    - name: meal_timing_minutes
      type: integer
      nullable: true
      description: Minutes since/before meal

    # Data Source
    - name: source_type
      type: enum
      values:
        - device_automatic
        - device_manual
        - patient_reported
        - provider_entered
        - imported
      required: true
      default: device_automatic
      description: How reading was captured

    - name: source_confidence
      type: enum
      values:
        - high
        - medium
        - low
        - unverified
      default: high
      description: Confidence in reading accuracy

    # Status & Flags
    - name: status
      type: enum
      values:
        - submitted
        - validated
        - reviewed
        - flagged
        - acknowledged
        - escalated
        - archived
      required: true
      default: submitted
      indexed: true
      description: Processing status

    - name: is_abnormal
      type: boolean
      required: true
      default: false
      indexed: true
      description: Reading outside normal range

    - name: abnormal_type
      type: enum
      values:
        - high
        - low
        - critical_high
        - critical_low
        - irregular
      nullable: true
      description: Type of abnormality

    - name: alert_triggered
      type: boolean
      default: false
      description: Triggered provider alert

    - name: alert_level
      type: enum
      values:
        - informational
        - attention
        - urgent
        - critical
      nullable: true
      description: Alert severity level

    # Reference Ranges
    - name: reference_range_low
      type: decimal
      precision: 10
      scale: 2
      nullable: true
      description: Normal range lower bound

    - name: reference_range_high
      type: decimal
      precision: 10
      scale: 2
      nullable: true
      description: Normal range upper bound

    - name: patient_target_low
      type: decimal
      precision: 10
      scale: 2
      nullable: true
      description: Patient-specific target low

    - name: patient_target_high
      type: decimal
      precision: 10
      scale: 2
      nullable: true
      description: Patient-specific target high

    # Review
    - name: reviewed_by
      type: uuid
      nullable: true
      foreign_key: provider.id
      description: Provider who reviewed

    - name: reviewed_at
      type: datetime
      nullable: true
      description: When reviewed

    - name: review_notes
      type: text
      nullable: true
      description: Provider notes on reading

    - name: follow_up_action
      type: enum
      values:
        - none
        - patient_education
        - medication_adjustment
        - schedule_visit
        - urgent_contact
        - emergency_services
      nullable: true
      description: Action taken after review

    # Patient Notes
    - name: patient_notes
      type: text
      nullable: true
      max_length: 1000
      description: Notes from patient

    - name: symptoms_reported
      type: jsonb
      default: "[]"
      description: |
        Associated symptoms:
        [{symptom: string, severity: 1-10}]

    # Raw Data
    - name: raw_device_data
      type: jsonb
      nullable: true
      description: Original device data payload

    # Timestamps
    - name: created_at
      type: datetime
      required: true
      default: now()

    - name: updated_at
      type: datetime
      required: true
      default: now()
      on_update: now()

  relationships:
    - name: patient
      type: belongs_to
      entity: patient
      foreign_key: patient_id

    - name: device
      type: belongs_to
      entity: remote_monitoring_device
      foreign_key: device_id

    - name: visit
      type: belongs_to
      entity: tele_visit
      foreign_key: visit_id

    - name: reviewer
      type: belongs_to
      entity: provider
      foreign_key: reviewed_by

  computed_fields:
    - name: deviation_from_target
      expression: |
        CASE 
          WHEN value > patient_target_high THEN value - patient_target_high
          WHEN value < patient_target_low THEN patient_target_low - value
          ELSE 0
        END
      type: decimal
      description: How far outside target range

    - name: formatted_reading
      expression: |
        CASE reading_type
          WHEN 'blood_pressure' THEN value || '/' || value_secondary || ' ' || unit
          ELSE value || ' ' || unit
        END
      type: string
      description: Human-readable formatted reading

  indexes:
    - name: idx_vitalreading_patient_type
      columns: [patient_id, reading_type, reading_time]
      
    - name: idx_vitalreading_abnormal
      columns: [is_abnormal, status]
      
    - name: idx_vitalreading_device
      columns: [device_id, reading_time]
      
    - name: idx_vitalreading_status
      columns: [status, alert_triggered]

  validations:
    - name: valid_value
      rule: value IS NOT NULL AND value > 0
      message: Reading value must be positive

    - name: secondary_for_bp
      rule: reading_type != 'blood_pressure' OR value_secondary IS NOT NULL
      message: Blood pressure requires diastolic value

    - name: valid_ranges
      rule: reference_range_low IS NULL OR reference_range_high IS NULL OR reference_range_low < reference_range_high
      message: Invalid reference range

  audit:
    enabled: true
    fields:
      - value
      - value_secondary
      - status
      - is_abnormal
      - reviewed_by
    retention_days: 2555
