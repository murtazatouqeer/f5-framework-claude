# VisitSummary Entity
# F5 Framework v2.0 - Healthcare/Telemedicine
# After-visit summary for patient communication

entity:
  id: visit-summary
  name: VisitSummary
  name_ja: 診療サマリー
  description: After-visit summary document sent to patients
  domain: healthcare
  subdomain: telemedicine

  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true
      description: Unique identifier

    - name: summary_number
      type: string
      format: "AVS-{YYYYMMDD}-{XXXX}"
      unique: true
      indexed: true
      description: Summary document number

    - name: visit_id
      type: uuid
      required: true
      unique: true
      indexed: true
      foreign_key: tele_visit.id
      description: Associated telehealth visit

    - name: patient_id
      type: uuid
      required: true
      indexed: true
      foreign_key: patient.id
      description: Patient receiving summary

    - name: provider_id
      type: uuid
      required: true
      foreign_key: provider.id
      description: Provider who conducted visit

    # Visit Details
    - name: visit_date
      type: datetime
      required: true
      description: When visit occurred

    - name: visit_type
      type: string
      required: true
      description: Type of visit

    - name: chief_complaint
      type: string
      required: true
      description: Reason for visit

    # Clinical Summary
    - name: diagnoses
      type: jsonb
      default: "[]"
      description: |
        Diagnoses discussed:
        [{
          code: "ICD-10",
          description: string,
          is_primary: bool,
          patient_friendly: string
        }]

    - name: assessment
      type: text
      nullable: true
      description: Provider's assessment summary

    - name: assessment_patient_friendly
      type: text
      nullable: true
      description: Patient-friendly assessment

    # Treatment Plan
    - name: treatment_plan
      type: jsonb
      default: "[]"
      description: |
        Treatment recommendations:
        [{
          type: "medication|therapy|lifestyle|procedure|referral",
          description: string,
          instructions: string,
          priority: "high|medium|low"
        }]

    - name: medications_prescribed
      type: jsonb
      default: "[]"
      description: |
        New/changed medications:
        [{
          name: string,
          dosage: string,
          frequency: string,
          instructions: string,
          purpose: string
        }]

    - name: medications_continued
      type: jsonb
      default: "[]"
      description: Continued medications

    - name: medications_stopped
      type: jsonb
      default: "[]"
      description: |
        Discontinued medications:
        [{name: string, reason: string}]

    # Patient Instructions
    - name: self_care_instructions
      type: jsonb
      default: "[]"
      description: |
        Self-care instructions:
        [{
          category: "diet|activity|medication|monitoring|other",
          instruction: string,
          importance: "required|recommended|optional"
        }]

    - name: warning_signs
      type: jsonb
      default: "[]"
      description: |
        When to seek care:
        [{
          symptom: string,
          action: "call_office|urgent_care|emergency"
        }]

    - name: activity_restrictions
      type: text
      nullable: true
      description: Activity limitations

    - name: dietary_guidance
      type: text
      nullable: true
      description: Diet recommendations

    # Follow-up
    - name: follow_up_instructions
      type: jsonb
      nullable: true
      description: |
        Follow-up care:
        {
          needed: bool,
          type: "telehealth|in_person|either",
          timeframe: string,
          with_provider: string,
          reason: string,
          scheduled: bool,
          scheduled_date: datetime
        }

    - name: referrals
      type: jsonb
      default: "[]"
      description: |
        Specialist referrals:
        [{
          specialty: string,
          provider_name: string,
          reason: string,
          urgency: string,
          referral_id: uuid
        }]

    # Orders
    - name: lab_orders
      type: jsonb
      default: "[]"
      description: |
        Lab tests ordered:
        [{
          test_name: string,
          reason: string,
          fasting_required: bool,
          instructions: string
        }]

    - name: imaging_orders
      type: jsonb
      default: "[]"
      description: |
        Imaging ordered:
        [{
          type: string,
          body_part: string,
          reason: string,
          preparation: string
        }]

    # Vitals (from visit)
    - name: vitals_recorded
      type: jsonb
      nullable: true
      description: |
        Vitals during visit:
        {
          blood_pressure: string,
          heart_rate: int,
          weight: string,
          temperature: string,
          oxygen_saturation: int
        }

    # Educational Materials
    - name: education_materials
      type: jsonb
      default: "[]"
      description: |
        Attached education:
        [{
          title: string,
          topic: string,
          url: string,
          format: "pdf|video|web"
        }]

    # Status
    - name: status
      type: enum
      values:
        - draft
        - pending_review
        - approved
        - sent
        - viewed
        - acknowledged
      required: true
      default: draft
      indexed: true
      description: Summary status

    # Delivery
    - name: delivery_method
      type: enum
      values:
        - patient_portal
        - email
        - print
        - mail
        - multiple
      nullable: true
      description: How summary was delivered

    - name: sent_at
      type: datetime
      nullable: true
      description: When sent to patient

    - name: viewed_at
      type: datetime
      nullable: true
      description: When patient viewed

    - name: acknowledged_at
      type: datetime
      nullable: true
      description: When patient acknowledged

    # Provider Sign-off
    - name: approved_by
      type: uuid
      nullable: true
      foreign_key: provider.id
      description: Provider who approved

    - name: approved_at
      type: datetime
      nullable: true
      description: Approval timestamp

    # Language
    - name: language
      type: string
      default: "en"
      description: Summary language

    - name: reading_level
      type: enum
      values:
        - standard
        - simplified
        - pediatric
      default: standard
      description: Reading level adaptation

    # Document
    - name: document_url
      type: string
      nullable: true
      description: PDF document URL

    - name: document_version
      type: integer
      default: 1
      description: Document version

    # Timestamps
    - name: created_at
      type: datetime
      required: true
      default: now()

    - name: updated_at
      type: datetime
      required: true
      default: now()
      on_update: now()

  relationships:
    - name: visit
      type: belongs_to
      entity: tele_visit
      foreign_key: visit_id

    - name: patient
      type: belongs_to
      entity: patient
      foreign_key: patient_id

    - name: provider
      type: belongs_to
      entity: provider
      foreign_key: provider_id

    - name: approver
      type: belongs_to
      entity: provider
      foreign_key: approved_by

  state_machine:
    field: status
    initial: draft
    transitions:
      - from: draft
        to: pending_review
        trigger: submit_for_review
        
      - from: pending_review
        to: approved
        trigger: provider_approves
        action: set_approved_at
        
      - from: pending_review
        to: draft
        trigger: request_changes
        
      - from: approved
        to: sent
        trigger: send_to_patient
        action: set_sent_at
        
      - from: sent
        to: viewed
        trigger: patient_views
        action: set_viewed_at
        
      - from: viewed
        to: acknowledged
        trigger: patient_acknowledges
        action: set_acknowledged_at

  indexes:
    - name: idx_visitsummary_visit
      columns: [visit_id]
      unique: true
      
    - name: idx_visitsummary_patient
      columns: [patient_id, created_at]
      
    - name: idx_visitsummary_status
      columns: [status]

  validations:
    - name: approved_before_send
      rule: status != 'sent' OR approved_by IS NOT NULL
      message: Summary must be approved before sending

    - name: has_content
      rule: assessment IS NOT NULL OR treatment_plan != '[]'
      message: Summary must have clinical content

  audit:
    enabled: true
    fields:
      - status
      - diagnoses
      - medications_prescribed
      - approved_by
    retention_days: 2555
