# TeleVisit Entity
# F5 Framework v2.0 - Healthcare/Telemedicine
# Core entity for virtual visit/consultation records

entity:
  id: tele-visit
  name: TeleVisit
  name_ja: 遠隔診療
  description: Virtual healthcare visit/consultation record with full clinical and technical tracking
  domain: healthcare
  subdomain: telemedicine

  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true
      description: Unique identifier

    - name: visit_id
      type: string
      format: "TV-{YYYYMMDD}-{XXXX}"
      unique: true
      indexed: true
      description: Human-readable visit identifier

    - name: external_id
      type: string
      nullable: true
      description: External system reference (EHR visit ID)

    # Participants
    - name: patient_id
      type: uuid
      required: true
      indexed: true
      foreign_key: patient.id
      description: Patient receiving care

    - name: provider_id
      type: uuid
      required: true
      indexed: true
      foreign_key: provider.id
      description: Healthcare provider conducting visit

    - name: interpreter_id
      type: uuid
      nullable: true
      foreign_key: interpreter.id
      description: Language interpreter if needed

    - name: caregiver_id
      type: uuid
      nullable: true
      foreign_key: user.id
      description: Caregiver/family member present

    # Visit Type & Modality
    - name: visit_type
      type: enum
      values:
        - scheduled
        - on_demand
        - follow_up
        - urgent
        - second_opinion
        - specialist_referral
      required: true
      indexed: true
      description: Type of telehealth visit

    - name: modality
      type: enum
      values:
        - video
        - audio_only
        - chat
        - asynchronous
        - hybrid
      required: true
      indexed: true
      description: Communication modality

    - name: status
      type: enum
      values:
        - scheduled
        - confirmed
        - waiting
        - in_progress
        - on_hold
        - completed
        - no_show
        - cancelled
        - technical_failure
        - rescheduled
      required: true
      indexed: true
      default: scheduled
      description: Current visit status

    # Scheduling
    - name: scheduled_start
      type: datetime
      required: true
      indexed: true
      description: Scheduled start time

    - name: scheduled_end
      type: datetime
      required: true
      description: Scheduled end time

    - name: scheduled_duration_minutes
      type: integer
      required: true
      default: 15
      validation:
        min: 5
        max: 120
      description: Planned visit duration

    - name: actual_start
      type: datetime
      nullable: true
      description: Actual start time

    - name: actual_end
      type: datetime
      nullable: true
      description: Actual end time

    - name: actual_duration_minutes
      type: integer
      nullable: true
      computed: true
      description: Actual visit duration

    - name: timezone
      type: string
      required: true
      default: "America/New_York"
      description: Patient's timezone

    # Clinical Information
    - name: chief_complaint
      type: text
      required: true
      max_length: 1000
      description: Primary reason for visit

    - name: reason_for_visit
      type: text
      nullable: true
      max_length: 2000
      description: Detailed visit reason

    - name: visit_priority
      type: enum
      values:
        - routine
        - urgent
        - emergent
      required: true
      default: routine
      description: Clinical priority

    - name: specialty
      type: string
      nullable: true
      indexed: true
      description: Medical specialty

    - name: diagnoses
      type: jsonb
      default: "[]"
      description: |
        Array of diagnosis objects:
        [{code: "ICD-10", description: "", primary: bool}]

    - name: prescriptions
      type: jsonb
      default: "[]"
      description: |
        Array of prescription references:
        [{prescription_id: uuid, medication: "", status: ""}]

    - name: orders
      type: jsonb
      default: "[]"
      description: |
        Array of order objects:
        [{type: "lab|imaging|referral", details: {}}]

    - name: clinical_notes
      type: text
      nullable: true
      encrypted: true
      description: Provider clinical notes (PHI)

    # Technical Details
    - name: video_session_id
      type: uuid
      nullable: true
      foreign_key: video_session.id
      description: Associated video session

    - name: connection_quality
      type: enum
      values:
        - excellent
        - good
        - fair
        - poor
        - failed
      nullable: true
      description: Overall connection quality

    - name: technical_issues
      type: jsonb
      default: "[]"
      description: |
        Array of technical issues:
        [{timestamp: datetime, type: "", description: "", resolved: bool}]

    - name: patient_device_info
      type: jsonb
      nullable: true
      description: Patient device/browser information

    # Consent
    - name: tele_consent_id
      type: uuid
      nullable: true
      foreign_key: tele_consent.id
      description: Telehealth consent record

    - name: consent_verified
      type: boolean
      required: true
      default: false
      description: Consent verification status

    - name: consent_verified_at
      type: datetime
      nullable: true
      description: When consent was verified

    - name: recording_consent
      type: boolean
      required: true
      default: false
      description: Consent for visit recording

    # Location (for licensing)
    - name: patient_location_state
      type: string
      required: true
      length: 2
      indexed: true
      description: Patient's state (for licensing verification)

    - name: patient_location_type
      type: enum
      values:
        - home
        - office
        - clinic
        - nursing_facility
        - other
      required: true
      default: home
      description: Type of patient location

    - name: patient_location_address
      type: jsonb
      nullable: true
      description: Full patient location for emergency services

    - name: provider_location_state
      type: string
      required: true
      length: 2
      description: Provider's state

    # Billing
    - name: billing_code
      type: string
      nullable: true
      description: CPT code for telehealth visit

    - name: modifier
      type: string
      nullable: true
      description: Billing modifier (95, 93, GT, etc.)

    - name: place_of_service
      type: enum
      values:
        - "02"  # Telehealth provided other than in patient's home
        - "10"  # Telehealth provided in patient's home
      nullable: true
      description: CMS place of service code

    - name: insurance_verified
      type: boolean
      required: true
      default: false
      description: Insurance telehealth coverage verified

    - name: copay_amount
      type: decimal
      precision: 10
      scale: 2
      nullable: true
      description: Patient copay amount

    - name: copay_collected
      type: boolean
      default: false
      description: Copay collection status

    # Follow-up
    - name: follow_up_needed
      type: boolean
      required: true
      default: false
      description: Follow-up visit recommended

    - name: follow_up_type
      type: enum
      values:
        - telehealth
        - in_person
        - either
      nullable: true
      description: Recommended follow-up type

    - name: follow_up_timeframe
      type: string
      nullable: true
      description: Recommended timeframe (e.g., "2 weeks")

    - name: follow_up_scheduled_at
      type: datetime
      nullable: true
      description: Scheduled follow-up date

    # Satisfaction
    - name: patient_satisfaction_score
      type: integer
      nullable: true
      validation:
        min: 1
        max: 5
      description: Patient satisfaction rating

    - name: patient_feedback
      type: text
      nullable: true
      description: Patient feedback comments

    # Timestamps
    - name: created_at
      type: datetime
      required: true
      default: now()
      description: Record creation time

    - name: updated_at
      type: datetime
      required: true
      default: now()
      on_update: now()
      description: Last update time

    - name: cancelled_at
      type: datetime
      nullable: true
      description: Cancellation timestamp

    - name: cancellation_reason
      type: string
      nullable: true
      description: Reason for cancellation

  relationships:
    - name: patient
      type: belongs_to
      entity: patient
      foreign_key: patient_id
      description: Patient receiving care

    - name: provider
      type: belongs_to
      entity: provider
      foreign_key: provider_id
      description: Healthcare provider

    - name: video_session
      type: has_one
      entity: video_session
      foreign_key: video_session_id
      description: Video call session

    - name: consent
      type: has_one
      entity: tele_consent
      foreign_key: tele_consent_id
      description: Telehealth consent

    - name: prescriptions
      type: has_many
      entity: e_prescription
      foreign_key: visit_id
      description: Electronic prescriptions

    - name: visit_summary
      type: has_one
      entity: visit_summary
      foreign_key: visit_id
      description: After-visit summary

    - name: chat_messages
      type: has_many
      entity: chat_message
      through: video_session
      description: In-session messages

    - name: vital_readings
      type: has_many
      entity: vital_reading
      foreign_key: visit_id
      description: Vitals collected during visit

  state_machine:
    field: status
    initial: scheduled
    transitions:
      - from: scheduled
        to: confirmed
        trigger: patient_confirms
        
      - from: [scheduled, confirmed]
        to: waiting
        trigger: patient_checks_in
        guard: consent_verified == true
        
      - from: waiting
        to: in_progress
        trigger: provider_admits
        action: set_actual_start
        
      - from: in_progress
        to: on_hold
        trigger: temporary_pause
        
      - from: on_hold
        to: in_progress
        trigger: resume_visit
        
      - from: in_progress
        to: completed
        trigger: end_visit
        action: set_actual_end
        
      - from: [scheduled, confirmed]
        to: no_show
        trigger: mark_no_show
        guard: scheduled_start + 15min < now()
        
      - from: [scheduled, confirmed, waiting]
        to: cancelled
        trigger: cancel_visit
        action: set_cancelled_at
        
      - from: [waiting, in_progress]
        to: technical_failure
        trigger: technical_issue
        
      - from: [no_show, cancelled, technical_failure]
        to: rescheduled
        trigger: reschedule

  indexes:
    - name: idx_televisit_patient_date
      columns: [patient_id, scheduled_start]
      
    - name: idx_televisit_provider_date
      columns: [provider_id, scheduled_start]
      
    - name: idx_televisit_status
      columns: [status, scheduled_start]
      
    - name: idx_televisit_state
      columns: [patient_location_state]

  validations:
    - name: valid_schedule
      rule: scheduled_end > scheduled_start
      message: End time must be after start time

    - name: valid_duration
      rule: scheduled_duration_minutes >= 5
      message: Minimum visit duration is 5 minutes

    - name: consent_before_visit
      rule: status != 'in_progress' OR consent_verified == true
      message: Consent must be verified before visit starts

    - name: provider_licensed
      rule: provider.is_licensed_in(patient_location_state)
      message: Provider must be licensed in patient's state

  audit:
    enabled: true
    fields:
      - status
      - diagnoses
      - prescriptions
      - clinical_notes
    retention_days: 2555  # 7 years for medical records
