# ePrescription Entity
# F5 Framework v2.0 - Healthcare/Telemedicine
# Electronic prescriptions from telehealth visits

entity:
  id: e-prescription
  name: ePrescription
  name_ja: 電子処方箋
  description: Electronic prescription generated during telehealth visits
  domain: healthcare
  subdomain: telemedicine

  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true
      description: Unique identifier

    - name: prescription_number
      type: string
      format: "ERX-{YYYYMMDD}-{XXXX}"
      unique: true
      indexed: true
      description: Prescription number

    - name: external_rx_id
      type: string
      nullable: true
      description: External pharmacy system ID

    # Visit & Patient
    - name: visit_id
      type: uuid
      required: true
      indexed: true
      foreign_key: tele_visit.id
      description: Associated telehealth visit

    - name: patient_id
      type: uuid
      required: true
      indexed: true
      foreign_key: patient.id
      description: Patient receiving prescription

    - name: provider_id
      type: uuid
      required: true
      indexed: true
      foreign_key: provider.id
      description: Prescribing provider

    # Medication
    - name: medication_name
      type: string
      required: true
      description: Medication name

    - name: medication_generic
      type: string
      nullable: true
      description: Generic name

    - name: medication_brand
      type: string
      nullable: true
      description: Brand name

    - name: ndc_code
      type: string
      nullable: true
      description: National Drug Code

    - name: rxnorm_code
      type: string
      nullable: true
      description: RxNorm identifier

    # Prescription Details
    - name: strength
      type: string
      required: true
      description: Medication strength (e.g., "500mg")

    - name: strength_unit
      type: string
      required: true
      description: Strength unit

    - name: form
      type: enum
      values:
        - tablet
        - capsule
        - liquid
        - injection
        - patch
        - cream
        - inhaler
        - drops
        - spray
        - suppository
        - other
      required: true
      description: Medication form

    - name: quantity
      type: decimal
      precision: 10
      scale: 2
      required: true
      description: Quantity prescribed

    - name: quantity_unit
      type: string
      required: true
      description: Quantity unit

    - name: days_supply
      type: integer
      required: true
      description: Days of supply

    - name: refills
      type: integer
      required: true
      default: 0
      validation:
        min: 0
        max: 12
      description: Number of refills

    - name: refills_remaining
      type: integer
      required: true
      default: 0
      description: Refills remaining

    # Instructions
    - name: sig
      type: text
      required: true
      description: Prescription instructions (sig)

    - name: sig_structured
      type: jsonb
      nullable: true
      description: |
        Structured instructions:
        {
          dose: string,
          route: string,
          frequency: string,
          duration: string,
          additional: string
        }

    - name: instructions
      type: text
      nullable: true
      description: Additional patient instructions

    - name: pharmacy_notes
      type: text
      nullable: true
      description: Notes for pharmacist

    # Controlled Substance
    - name: is_controlled
      type: boolean
      required: true
      default: false
      description: Is controlled substance

    - name: schedule
      type: enum
      values:
        - schedule_ii
        - schedule_iii
        - schedule_iv
        - schedule_v
        - non_controlled
      required: true
      default: non_controlled
      description: DEA schedule

    - name: epcs_compliant
      type: boolean
      default: false
      description: EPCS compliant (for controlled)

    # Dispensing
    - name: dispense_as_written
      type: boolean
      default: false
      description: DAW - no substitution

    - name: substitution_allowed
      type: boolean
      default: true
      description: Generic substitution allowed

    # Status
    - name: status
      type: enum
      values:
        - draft
        - pending_signature
        - signed
        - transmitted
        - received_by_pharmacy
        - in_progress
        - ready_for_pickup
        - dispensed
        - partially_dispensed
        - cancelled
        - denied
        - expired
      required: true
      default: draft
      indexed: true
      description: Prescription status

    # Pharmacy
    - name: pharmacy_id
      type: uuid
      nullable: true
      foreign_key: pharmacy.id
      description: Selected pharmacy

    - name: pharmacy_name
      type: string
      nullable: true
      description: Pharmacy name

    - name: pharmacy_ncpdp
      type: string
      nullable: true
      description: NCPDP ID

    - name: pharmacy_address
      type: jsonb
      nullable: true
      description: Pharmacy address

    - name: pharmacy_phone
      type: string
      nullable: true
      description: Pharmacy phone

    # Transmission
    - name: transmission_method
      type: enum
      values:
        - surescripts
        - fax
        - print
        - phone
        - manual
      nullable: true
      description: How Rx was sent

    - name: transmitted_at
      type: datetime
      nullable: true
      description: When transmitted to pharmacy

    - name: transmission_status
      type: enum
      values:
        - pending
        - sent
        - acknowledged
        - error
        - rejected
      nullable: true
      description: Transmission status

    - name: transmission_error
      type: string
      nullable: true
      description: Transmission error message

    # Signature
    - name: signed_at
      type: datetime
      nullable: true
      description: When provider signed

    - name: signature_method
      type: enum
      values:
        - electronic
        - biometric
        - two_factor
      nullable: true
      description: Signature method

    - name: signature_verified
      type: boolean
      default: false
      description: Signature verified

    # Clinical
    - name: diagnosis_codes
      type: jsonb
      default: "[]"
      description: |
        Associated diagnoses:
        [{code: "ICD-10", description: ""}]

    - name: indication
      type: string
      nullable: true
      description: Indication for use

    - name: prn
      type: boolean
      default: false
      description: As needed (PRN)

    - name: prn_reason
      type: string
      nullable: true
      description: PRN reason

    # Safety
    - name: drug_interactions_checked
      type: boolean
      default: false
      description: Drug interaction check done

    - name: allergies_checked
      type: boolean
      default: false
      description: Allergy check done

    - name: warnings
      type: jsonb
      default: "[]"
      description: |
        Safety warnings:
        [{type: string, severity: string, message: string, overridden: bool}]

    # Dates
    - name: effective_date
      type: date
      required: true
      default: current_date
      description: When Rx becomes effective

    - name: expiration_date
      type: date
      nullable: true
      description: When Rx expires

    - name: last_fill_date
      type: date
      nullable: true
      description: Most recent fill

    # Timestamps
    - name: created_at
      type: datetime
      required: true
      default: now()

    - name: updated_at
      type: datetime
      required: true
      default: now()
      on_update: now()

  relationships:
    - name: visit
      type: belongs_to
      entity: tele_visit
      foreign_key: visit_id

    - name: patient
      type: belongs_to
      entity: patient
      foreign_key: patient_id

    - name: provider
      type: belongs_to
      entity: provider
      foreign_key: provider_id

    - name: pharmacy
      type: belongs_to
      entity: pharmacy
      foreign_key: pharmacy_id

  state_machine:
    field: status
    initial: draft
    transitions:
      - from: draft
        to: pending_signature
        trigger: submit_for_signature
        
      - from: pending_signature
        to: signed
        trigger: provider_signs
        action: set_signed_at
        guard: drug_interactions_checked AND allergies_checked
        
      - from: signed
        to: transmitted
        trigger: send_to_pharmacy
        action: set_transmitted_at
        
      - from: transmitted
        to: received_by_pharmacy
        trigger: pharmacy_acknowledges
        
      - from: received_by_pharmacy
        to: in_progress
        trigger: pharmacy_processing
        
      - from: in_progress
        to: ready_for_pickup
        trigger: ready
        
      - from: [ready_for_pickup, in_progress]
        to: dispensed
        trigger: dispense
        action: set_last_fill_date
        
      - from: [draft, pending_signature, signed, transmitted]
        to: cancelled
        trigger: cancel
        
      - from: transmitted
        to: denied
        trigger: pharmacy_denies
        
      - from: signed
        to: expired
        trigger: expiration_reached
        guard: expiration_date < current_date

  indexes:
    - name: idx_erx_patient
      columns: [patient_id, created_at]
      
    - name: idx_erx_visit
      columns: [visit_id]
      
    - name: idx_erx_status
      columns: [status, effective_date]
      
    - name: idx_erx_controlled
      columns: [is_controlled, schedule]

  validations:
    - name: controlled_requires_epcs
      rule: is_controlled == false OR epcs_compliant == true
      message: Controlled substances require EPCS compliance

    - name: valid_refills_controlled
      rule: schedule != 'schedule_ii' OR refills == 0
      message: Schedule II cannot have refills

    - name: pharmacy_for_transmission
      rule: status == 'draft' OR pharmacy_id IS NOT NULL
      message: Pharmacy required to transmit

  audit:
    enabled: true
    fields:
      - status
      - signed_at
      - quantity
      - refills
      - pharmacy_id
    retention_days: 2555
