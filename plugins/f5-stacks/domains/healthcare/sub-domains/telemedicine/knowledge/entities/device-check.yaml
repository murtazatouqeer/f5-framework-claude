# DeviceCheck Entity
# F5 Framework v2.0 - Healthcare/Telemedicine
# Pre-visit device and connectivity verification

entity:
  id: device-check
  name: DeviceCheck
  name_ja: デバイスチェック
  description: Device and connectivity verification for telehealth readiness
  domain: healthcare
  subdomain: telemedicine

  attributes:
    # Identification
    - name: id
      type: uuid
      primary_key: true
      description: Unique identifier

    - name: user_id
      type: uuid
      required: true
      indexed: true
      foreign_key: user.id
      description: User performing the check

    - name: visit_id
      type: uuid
      nullable: true
      indexed: true
      foreign_key: tele_visit.id
      description: Associated visit (if pre-visit check)

    # Check Type & Status
    - name: check_type
      type: enum
      values:
        - pre_visit
        - troubleshooting
        - initial_setup
        - periodic
      required: true
      default: pre_visit
      description: Type of device check

    - name: status
      type: enum
      values:
        - pending
        - in_progress
        - passed
        - failed
        - partial
        - skipped
      required: true
      default: pending
      indexed: true
      description: Overall check status

    - name: checked_at
      type: datetime
      nullable: true
      description: When check was completed

    # Camera Tests
    - name: camera_available
      type: boolean
      nullable: true
      description: Camera detected

    - name: camera_working
      type: boolean
      nullable: true
      description: Camera functional

    - name: camera_name
      type: string
      nullable: true
      description: Camera device name

    - name: camera_resolution
      type: string
      nullable: true
      description: Camera resolution capability

    - name: camera_error
      type: string
      nullable: true
      description: Camera error message if failed

    # Microphone Tests
    - name: microphone_available
      type: boolean
      nullable: true
      description: Microphone detected

    - name: microphone_working
      type: boolean
      nullable: true
      description: Microphone functional

    - name: microphone_name
      type: string
      nullable: true
      description: Microphone device name

    - name: microphone_level
      type: integer
      nullable: true
      validation:
        min: 0
        max: 100
      description: Microphone input level

    - name: microphone_error
      type: string
      nullable: true
      description: Microphone error message

    # Speaker Tests
    - name: speaker_available
      type: boolean
      nullable: true
      description: Speaker/audio output detected

    - name: speaker_working
      type: boolean
      nullable: true
      description: Speaker functional

    - name: speaker_name
      type: string
      nullable: true
      description: Speaker device name

    - name: speaker_error
      type: string
      nullable: true
      description: Speaker error message

    # Browser & OS
    - name: browser_supported
      type: boolean
      nullable: true
      description: Browser meets requirements

    - name: browser_name
      type: string
      nullable: true
      description: Browser name

    - name: browser_version
      type: string
      nullable: true
      description: Browser version

    - name: os_type
      type: enum
      values:
        - windows
        - macos
        - linux
        - ios
        - android
        - other
      nullable: true
      description: Operating system

    - name: os_version
      type: string
      nullable: true
      description: OS version

    - name: device_type
      type: enum
      values:
        - desktop
        - laptop
        - tablet
        - smartphone
        - other
      nullable: true
      description: Device type

    # Network Tests
    - name: bandwidth_download_mbps
      type: decimal
      precision: 6
      scale: 2
      nullable: true
      description: Download speed

    - name: bandwidth_upload_mbps
      type: decimal
      precision: 6
      scale: 2
      nullable: true
      description: Upload speed

    - name: bandwidth_sufficient
      type: boolean
      nullable: true
      description: Meets minimum bandwidth (1.5 Mbps)

    - name: latency_ms
      type: integer
      nullable: true
      description: Network latency

    - name: jitter_ms
      type: integer
      nullable: true
      description: Network jitter

    - name: packet_loss_percent
      type: decimal
      precision: 5
      scale: 2
      nullable: true
      description: Packet loss percentage

    - name: network_type
      type: enum
      values:
        - wifi
        - cellular_5g
        - cellular_4g
        - cellular_3g
        - ethernet
        - unknown
      nullable: true
      description: Network connection type

    - name: network_stable
      type: boolean
      nullable: true
      description: Connection stability assessment

    # WebRTC Support
    - name: webrtc_supported
      type: boolean
      nullable: true
      description: WebRTC available

    - name: webrtc_data_channel
      type: boolean
      nullable: true
      description: Data channel support

    - name: webrtc_screen_share
      type: boolean
      nullable: true
      description: Screen sharing support

    # Permissions
    - name: camera_permission
      type: enum
      values:
        - granted
        - denied
        - prompt
        - not_requested
      nullable: true
      description: Camera permission status

    - name: microphone_permission
      type: enum
      values:
        - granted
        - denied
        - prompt
        - not_requested
      nullable: true
      description: Microphone permission status

    - name: notification_permission
      type: enum
      values:
        - granted
        - denied
        - prompt
        - not_requested
      nullable: true
      description: Notification permission status

    # Issues & Recommendations
    - name: issues_detected
      type: jsonb
      default: "[]"
      description: |
        Array of detected issues:
        [{
          type: "camera|microphone|speaker|browser|network|permission",
          severity: "critical|warning|info",
          code: string,
          message: string
        }]

    - name: recommendations
      type: jsonb
      default: "[]"
      description: |
        Recommended fixes:
        [{
          issue_code: string,
          recommendation: string,
          help_url: string
        }]

    - name: critical_issues_count
      type: integer
      default: 0
      computed: true
      description: Number of critical issues

    # Raw Data
    - name: raw_diagnostics
      type: jsonb
      nullable: true
      description: Full diagnostic data from browser APIs

    # Timestamps
    - name: created_at
      type: datetime
      required: true
      default: now()

    - name: started_at
      type: datetime
      nullable: true
      description: When check started

    - name: completed_at
      type: datetime
      nullable: true
      description: When check completed

    - name: duration_seconds
      type: integer
      nullable: true
      computed: true
      description: Check duration

  relationships:
    - name: user
      type: belongs_to
      entity: user
      foreign_key: user_id

    - name: visit
      type: belongs_to
      entity: tele_visit
      foreign_key: visit_id

  computed_fields:
    - name: overall_ready
      expression: |
        camera_working == true AND
        microphone_working == true AND
        speaker_working == true AND
        bandwidth_sufficient == true AND
        browser_supported == true
      type: boolean
      description: Ready for telehealth

    - name: can_proceed_with_issues
      expression: |
        (camera_working == true OR audio_only_fallback) AND
        microphone_working == true AND
        speaker_working == true
      type: boolean
      description: Can proceed with minor issues

  methods:
    - name: run_check
      returns: device_check_result
      description: Execute all device checks

    - name: retest_component
      parameters:
        - component: string
      returns: boolean
      description: Retest specific component

    - name: generate_troubleshooting_guide
      returns: string
      description: Generate help based on issues

  validations:
    - name: valid_bandwidth
      rule: bandwidth_download_mbps IS NULL OR bandwidth_download_mbps >= 0
      message: Bandwidth must be non-negative

  indexes:
    - name: idx_devicecheck_user
      columns: [user_id, created_at]
      
    - name: idx_devicecheck_visit
      columns: [visit_id]
      
    - name: idx_devicecheck_status
      columns: [status]

  audit:
    enabled: true
    fields:
      - status
      - issues_detected
    retention_days: 90
