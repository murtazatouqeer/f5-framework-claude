# Kubernetes Secret Template
# F5 Framework - Infrastructure Stack
#
# Variables:
#   {{app_name}}     - Application name
#   {{namespace}}    - Kubernetes namespace
#   {{secret_data}}  - Secret key-value pairs (base64 encoded)
#   {{labels}}       - Additional labels
#   {{annotations}}  - Additional annotations
#
# IMPORTANT: In production, use external secret management:
# - External Secrets Operator
# - Sealed Secrets
# - HashiCorp Vault
# - AWS Secrets Manager / GCP Secret Manager / Azure Key Vault

apiVersion: v1
kind: Secret
metadata:
  name: {{app_name}}-secrets
  namespace: {{namespace}}
  labels:
    app.kubernetes.io/name: {{app_name}}
    app.kubernetes.io/instance: {{app_name}}
    app.kubernetes.io/component: secrets
    app.kubernetes.io/managed-by: f5-framework
    {{labels}}
  annotations:
    f5.io/template: "k8s-secret"
    f5.io/version: "1.0.0"
    # Indicate this should be managed externally in production
    f5.io/secret-management: "external-secrets-recommended"
    {{annotations}}
type: Opaque
data:
  # Base64 encoded values
  # echo -n 'value' | base64
  {{secret_data}}

# Using stringData for plain text (Kubernetes will encode)
stringData:
  # Database credentials (placeholder - use external secrets in production)
  DATABASE_URL: "{{database_url | default: postgresql://user:pass@host:5432/db}}"
  DATABASE_PASSWORD: "{{database_password | default: CHANGE_ME}}"

  # API keys (placeholder - use external secrets in production)
  API_KEY: "{{api_key | default: CHANGE_ME}}"
  JWT_SECRET: "{{jwt_secret | default: CHANGE_ME}}"

  # External service credentials
  {{secret_string_data}}

---
# Docker registry credentials
apiVersion: v1
kind: Secret
metadata:
  name: {{app_name}}-registry
  namespace: {{namespace}}
  labels:
    app.kubernetes.io/name: {{app_name}}
    app.kubernetes.io/component: registry-credentials
type: kubernetes.io/dockerconfigjson
data:
  # Generate with: kubectl create secret docker-registry --dry-run=client -o yaml
  .dockerconfigjson: {{docker_config_json}}

---
# TLS certificate secret
apiVersion: v1
kind: Secret
metadata:
  name: {{app_name}}-tls
  namespace: {{namespace}}
  labels:
    app.kubernetes.io/name: {{app_name}}
    app.kubernetes.io/component: tls
  annotations:
    # If using cert-manager
    cert-manager.io/issuer-kind: "{{issuer_kind | default: ClusterIssuer}}"
    cert-manager.io/issuer-name: "{{issuer_name | default: letsencrypt-prod}}"
type: kubernetes.io/tls
data:
  # Base64 encoded certificate and key
  tls.crt: {{tls_cert}}
  tls.key: {{tls_key}}

---
# Basic auth secret (for ingress)
apiVersion: v1
kind: Secret
metadata:
  name: {{app_name}}-basic-auth
  namespace: {{namespace}}
  labels:
    app.kubernetes.io/name: {{app_name}}
    app.kubernetes.io/component: basic-auth
type: Opaque
data:
  # Generate with: htpasswd -nb user password | base64
  auth: {{basic_auth_data}}

---
# SSH key secret (for git operations)
{{#if ssh_key}}
apiVersion: v1
kind: Secret
metadata:
  name: {{app_name}}-ssh-key
  namespace: {{namespace}}
  labels:
    app.kubernetes.io/name: {{app_name}}
    app.kubernetes.io/component: ssh-credentials
type: kubernetes.io/ssh-auth
data:
  ssh-privatekey: {{ssh_private_key}}
{{/if}}

---
# Service account token (for external services)
{{#if service_account_key}}
apiVersion: v1
kind: Secret
metadata:
  name: {{app_name}}-sa-key
  namespace: {{namespace}}
  labels:
    app.kubernetes.io/name: {{app_name}}
    app.kubernetes.io/component: service-account
type: Opaque
data:
  # GCP service account key
  sa-key.json: {{service_account_key}}
{{/if}}

---
# External Secrets Operator - AWS Secrets Manager
{{#if use_external_secrets_aws}}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{app_name}}-external
  namespace: {{namespace}}
  labels:
    app.kubernetes.io/name: {{app_name}}
    app.kubernetes.io/component: external-secret
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: {{app_name}}-secrets
    creationPolicy: Owner
  data:
    - secretKey: DATABASE_URL
      remoteRef:
        key: {{aws_secret_name | default: "{{app_name}}/database"}}
        property: url
    - secretKey: DATABASE_PASSWORD
      remoteRef:
        key: {{aws_secret_name | default: "{{app_name}}/database"}}
        property: password
    - secretKey: API_KEY
      remoteRef:
        key: {{aws_secret_name | default: "{{app_name}}/api"}}
        property: key
{{/if}}

---
# External Secrets Operator - HashiCorp Vault
{{#if use_external_secrets_vault}}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{app_name}}-vault
  namespace: {{namespace}}
  labels:
    app.kubernetes.io/name: {{app_name}}
    app.kubernetes.io/component: vault-secret
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: {{app_name}}-secrets
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: secret/data/{{app_name}}/{{environment | default: production}}
{{/if}}

---
# Sealed Secret (Bitnami)
{{#if use_sealed_secrets}}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: {{app_name}}-sealed
  namespace: {{namespace}}
  labels:
    app.kubernetes.io/name: {{app_name}}
    app.kubernetes.io/component: sealed-secret
spec:
  encryptedData:
    # Seal with: kubeseal --format yaml < secret.yaml > sealed-secret.yaml
    DATABASE_PASSWORD: {{sealed_database_password}}
    API_KEY: {{sealed_api_key}}
  template:
    metadata:
      name: {{app_name}}-secrets
      namespace: {{namespace}}
      labels:
        app.kubernetes.io/name: {{app_name}}
    type: Opaque
{{/if}}
