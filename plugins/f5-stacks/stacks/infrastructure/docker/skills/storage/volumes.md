---
name: docker-volumes
description: Docker named volumes for persistent data storage
applies_to: docker
---

# Docker Volumes

## Volume Overview

Docker volumes are the preferred mechanism for persisting data generated by containers.

### Volume vs Bind Mount vs tmpfs

| Feature | Volume | Bind Mount | tmpfs |
|---------|--------|------------|-------|
| Location | Docker-managed | Host filesystem | Memory |
| Persistence | Yes | Yes | No |
| Portability | High | Low | N/A |
| Performance | Best | Good | Fastest |
| Backup | Docker commands | Standard tools | N/A |

## Creating Volumes

### CLI Commands

```bash
# Create volume
docker volume create my-volume

# Create with options
docker volume create \
  --driver local \
  --opt type=none \
  --opt device=/data/postgres \
  --opt o=bind \
  postgres-data

# Create with labels
docker volume create \
  --label project=myapp \
  --label environment=production \
  app-data
```

### Using Volumes

```bash
# Mount volume to container
docker run -d \
  -v my-volume:/app/data \
  myapp

# Read-only mount
docker run -d \
  -v my-volume:/app/data:ro \
  myapp

# Named volume with create
docker run -d \
  -v postgres-data:/var/lib/postgresql/data \
  postgres
```

## Volume in Docker Compose

### Basic Definition

```yaml
services:
  db:
    image: postgres:16-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:  # Volume definition required
```

### Volume Options

```yaml
volumes:
  # Simple volume
  app_data:

  # With driver
  postgres_data:
    driver: local

  # With driver options
  nfs_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=192.168.1.100,rw
      device: ":/path/to/dir"

  # External volume (pre-existing)
  existing_data:
    external: true
    name: my-existing-volume

  # With labels
  labeled_data:
    labels:
      - "com.example.description=Database data"
      - "com.example.backup=daily"
```

### Volume Access Modes

```yaml
services:
  primary:
    volumes:
      - shared_data:/data  # Read-write (default)

  replica:
    volumes:
      - shared_data:/data:ro  # Read-only

volumes:
  shared_data:
```

## Common Volume Patterns

### Database Persistence

```yaml
services:
  postgres:
    image: postgres:16-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: secret

  mysql:
    image: mysql:8.0
    volumes:
      - mysql_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: secret

  mongodb:
    image: mongo:7
    volumes:
      - mongo_data:/data/db

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

volumes:
  postgres_data:
  mysql_data:
  mongo_data:
  redis_data:
```

### Application Data

```yaml
services:
  app:
    build: .
    volumes:
      # User uploads
      - uploads:/app/uploads
      # Application logs
      - logs:/app/logs
      # Generated content
      - generated:/app/generated

volumes:
  uploads:
  logs:
  generated:
```

### Shared Volumes

```yaml
services:
  uploader:
    volumes:
      - uploads:/app/uploads

  processor:
    volumes:
      - uploads:/app/uploads:ro

  cdn:
    volumes:
      - uploads:/usr/share/nginx/html/uploads:ro

volumes:
  uploads:
```

### Init Data Pattern

```yaml
services:
  db:
    image: postgres:16-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Init scripts (run once on first start)
      - ./init-scripts:/docker-entrypoint-initdb.d:ro

volumes:
  postgres_data:
```

## Volume Management

### Listing Volumes

```bash
# List all volumes
docker volume ls

# Filter by label
docker volume ls --filter label=project=myapp

# Filter by driver
docker volume ls --filter driver=local

# Filter dangling (unused)
docker volume ls --filter dangling=true
```

### Inspecting Volumes

```bash
# Inspect volume
docker volume inspect my-volume

# Output:
# [
#   {
#     "Name": "my-volume",
#     "Driver": "local",
#     "Mountpoint": "/var/lib/docker/volumes/my-volume/_data",
#     "Labels": {},
#     "Scope": "local"
#   }
# ]

# Get mountpoint
docker volume inspect my-volume --format '{{.Mountpoint}}'
```

### Removing Volumes

```bash
# Remove specific volume
docker volume rm my-volume

# Remove multiple
docker volume rm vol1 vol2 vol3

# Remove unused (dangling) volumes
docker volume prune

# Force prune
docker volume prune -f

# Remove with compose
docker compose down -v  # Removes volumes too
```

## Volume Backup and Restore

### Backup Volume

```bash
# Backup to tar file
docker run --rm \
  -v my-volume:/source:ro \
  -v $(pwd):/backup \
  alpine tar cvf /backup/backup.tar -C /source .

# Backup with compression
docker run --rm \
  -v my-volume:/source:ro \
  -v $(pwd):/backup \
  alpine tar czvf /backup/backup.tar.gz -C /source .

# Backup with timestamp
docker run --rm \
  -v postgres_data:/source:ro \
  -v $(pwd)/backups:/backup \
  alpine tar czvf /backup/postgres_$(date +%Y%m%d_%H%M%S).tar.gz -C /source .
```

### Restore Volume

```bash
# Restore from tar
docker run --rm \
  -v my-volume:/target \
  -v $(pwd):/backup \
  alpine tar xvf /backup/backup.tar -C /target

# Restore with overwrite
docker run --rm \
  -v my-volume:/target \
  -v $(pwd):/backup \
  alpine sh -c "rm -rf /target/* && tar xvf /backup/backup.tar -C /target"
```

### Database-Specific Backup

```yaml
services:
  db:
    image: postgres:16-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data

  backup:
    image: postgres:16-alpine
    volumes:
      - ./backups:/backups
    command: >
      sh -c "pg_dump -h db -U postgres mydb > /backups/dump_$$(date +%Y%m%d).sql"
    depends_on:
      - db
    profiles:
      - backup

volumes:
  postgres_data:
```

```bash
# Run backup
docker compose --profile backup run --rm backup
```

## Volume Drivers

### Local Driver (Default)

```bash
# Standard local volume
docker volume create --driver local my-volume

# With bind to specific location
docker volume create \
  --driver local \
  --opt type=none \
  --opt device=/data/myapp \
  --opt o=bind \
  my-volume
```

### NFS Volume

```yaml
volumes:
  nfs-data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=192.168.1.100,rw,nfsvers=4
      device: ":/exports/data"
```

### CIFS/SMB Volume

```yaml
volumes:
  smb-data:
    driver: local
    driver_opts:
      type: cifs
      o: username=user,password=pass,addr=192.168.1.100
      device: "//192.168.1.100/share"
```

### tmpfs Volume

```yaml
volumes:
  tmpfs-cache:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=100m,uid=1000
```

## Volume Best Practices

### 1. Use Named Volumes for Persistence

```yaml
# Good - named volume
volumes:
  - postgres_data:/var/lib/postgresql/data

# Avoid - anonymous volume (harder to manage)
volumes:
  - /var/lib/postgresql/data
```

### 2. Separate Data from Code

```yaml
services:
  app:
    volumes:
      # Application data (persistent)
      - app_data:/app/data
      # Development code (bind mount) - not in production
```

### 3. Use Labels for Organization

```yaml
volumes:
  postgres_data:
    labels:
      - "backup.schedule=daily"
      - "backup.retention=7d"
      - "project=myapp"
```

### 4. Document Volume Purpose

```yaml
volumes:
  # PostgreSQL database files
  postgres_data:

  # User uploaded files (images, documents)
  uploads:

  # Application cache (can be recreated)
  cache:
```

### 5. Plan for Backup

```yaml
volumes:
  # Critical - backup daily
  postgres_data:
    labels:
      - "backup=critical"

  # Important - backup weekly
  uploads:
    labels:
      - "backup=important"

  # Non-critical - no backup needed
  cache:
    labels:
      - "backup=none"
```

## Troubleshooting

### Volume Not Persisting

```bash
# Check volume exists
docker volume ls | grep my-volume

# Check container is using volume
docker inspect container --format '{{json .Mounts}}'

# Verify data in volume
docker run --rm -v my-volume:/data alpine ls -la /data
```

### Permission Issues

```bash
# Check permissions in volume
docker run --rm -v my-volume:/data alpine ls -la /data

# Fix permissions
docker run --rm -v my-volume:/data alpine chown -R 1000:1000 /data

# In Dockerfile
RUN chown -R appuser:appgroup /app/data
```

### Volume Full

```bash
# Check volume size
docker system df -v

# Find large files
docker run --rm -v my-volume:/data alpine du -sh /data/*

# Clean up
docker run --rm -v my-volume:/data alpine rm -rf /data/tmp/*
```

## Complete Example

```yaml
services:
  api:
    build: ./api
    volumes:
      # Application data
      - api_data:/app/data
      # User uploads
      - uploads:/app/uploads
      # Logs (for log aggregation)
      - api_logs:/app/logs

  db:
    image: postgres:16-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d:ro
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  backup:
    image: postgres:16-alpine
    volumes:
      - ./backups:/backups
      - postgres_data:/var/lib/postgresql/data:ro
    command: >
      sh -c "pg_dump -h db -U postgres app > /backups/app_$$(date +%Y%m%d).sql"
    profiles:
      - backup

volumes:
  # Critical data - backup hourly
  postgres_data:
    labels:
      - "backup.schedule=hourly"
      - "backup.retention=30d"

  # Important data - backup daily
  api_data:
    labels:
      - "backup.schedule=daily"
      - "backup.retention=14d"

  uploads:
    labels:
      - "backup.schedule=daily"
      - "backup.retention=14d"

  # Non-critical - no backup
  api_logs:
    labels:
      - "backup.schedule=none"

  redis_data:
    labels:
      - "backup.schedule=none"
```

## Related Skills
- storage/bind-mounts
- storage/tmpfs
- compose/volumes
