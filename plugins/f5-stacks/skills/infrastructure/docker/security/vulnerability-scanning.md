---
name: docker-vulnerability-scanning
description: Container image vulnerability scanning and remediation
applies_to: docker
---

# Docker Vulnerability Scanning

## Scanning Overview

Vulnerability scanning detects security issues in:
- Base images
- Application dependencies
- System packages
- Configuration issues

## Docker Scout

### Enable Scout

```bash
# Docker Scout is built into Docker Desktop
# For CLI, enable:
docker scout version

# Login for additional features
docker login
```

### Quick Scan

```bash
# Scan local image
docker scout cves myimage:latest

# Scan with severity filter
docker scout cves --only-severity critical,high myimage:latest

# Scan specific image from registry
docker scout cves nginx:alpine
```

### Detailed Analysis

```bash
# Full quickview
docker scout quickview myimage:latest

# Recommendations
docker scout recommendations myimage:latest

# Compare to base image
docker scout compare myimage:latest --to nginx:alpine
```

### SBOM (Software Bill of Materials)

```bash
# Generate SBOM
docker scout sbom myimage:latest

# Export as JSON
docker scout sbom --format json myimage:latest > sbom.json

# SPDX format
docker scout sbom --format spdx myimage:latest
```

## Trivy

### Installation

```bash
# macOS
brew install trivy

# Linux
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

# Docker
docker run --rm aquasec/trivy image myimage:latest
```

### Scan Image

```bash
# Basic scan
trivy image myimage:latest

# Severity filter
trivy image --severity HIGH,CRITICAL myimage:latest

# Ignore unfixed vulnerabilities
trivy image --ignore-unfixed myimage:latest

# Output formats
trivy image --format json myimage:latest > results.json
trivy image --format sarif myimage:latest > results.sarif
```

### Scan Dockerfile

```bash
# Scan Dockerfile for misconfigurations
trivy config Dockerfile

# Scan directory
trivy config .
```

### Scan Filesystem

```bash
# Scan node_modules, requirements.txt, etc.
trivy fs --scanners vuln,secret .
```

### CI Integration

```yaml
# GitHub Actions
- name: Run Trivy scanner
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: 'myimage:latest'
    format: 'sarif'
    output: 'trivy-results.sarif'
    severity: 'CRITICAL,HIGH'

- name: Upload results
  uses: github/codeql-action/upload-sarif@v2
  with:
    sarif_file: 'trivy-results.sarif'
```

## Grype

### Installation

```bash
# macOS
brew install grype

# Linux
curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
```

### Scan Image

```bash
# Basic scan
grype myimage:latest

# Severity filter
grype myimage:latest --only-fixed --fail-on high

# Output formats
grype myimage:latest -o json > results.json
grype myimage:latest -o cyclonedx > sbom.xml
```

### Generate SBOM with Syft

```bash
# Install Syft
brew install syft

# Generate SBOM
syft myimage:latest -o json > sbom.json
syft myimage:latest -o spdx-json > sbom-spdx.json

# Scan SBOM with Grype
grype sbom:sbom.json
```

## Snyk

### Installation

```bash
# Install CLI
npm install -g snyk

# Authenticate
snyk auth
```

### Scan Image

```bash
# Scan image
snyk container test myimage:latest

# Monitor for new vulnerabilities
snyk container monitor myimage:latest

# With Dockerfile for recommendations
snyk container test myimage:latest --file=Dockerfile
```

### CI Integration

```yaml
# GitHub Actions
- name: Run Snyk
  uses: snyk/actions/docker@master
  env:
    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  with:
    image: myimage:latest
    args: --severity-threshold=high
```

## Scan in CI/CD Pipeline

### GitHub Actions

```yaml
name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: docker build -t myapp:${{ github.sha }} .

      - name: Docker Scout
        uses: docker/scout-action@v1
        with:
          command: cves
          image: myapp:${{ github.sha }}
          only-severities: critical,high
          exit-code: true

      - name: Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: myapp:${{ github.sha }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
```

### GitLab CI

```yaml
container_scanning:
  stage: test
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - trivy image --exit-code 1 --severity HIGH,CRITICAL $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  allow_failure: false
```

### Jenkins

```groovy
pipeline {
  agent any
  stages {
    stage('Scan') {
      steps {
        sh 'docker build -t myapp:${BUILD_NUMBER} .'
        sh 'trivy image --exit-code 1 --severity HIGH,CRITICAL myapp:${BUILD_NUMBER}'
      }
    }
  }
}
```

## Remediation Strategies

### Update Base Image

```dockerfile
# Before: old base image
FROM node:18-alpine

# After: updated base image
FROM node:20-alpine
```

### Update Dependencies

```bash
# Node.js
npm update
npm audit fix

# Python
pip install --upgrade -r requirements.txt
pip-audit

# Go
go get -u ./...
```

### Multi-Stage Build

```dockerfile
# Use minimal runtime image
FROM node:20 AS builder
WORKDIR /app
COPY . .
RUN npm ci && npm run build

# Minimal production image
FROM node:20-alpine
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
USER node
CMD ["node", "dist/server.js"]
```

### Pin Versions

```dockerfile
# Pin base image digest
FROM node:20-alpine@sha256:abc123...

# Pin package versions
RUN apk add --no-cache \
    curl=8.5.0-r0 \
    openssl=3.1.4-r0
```

## Scanning Policy

### Severity Levels

| Severity | Action | Timeline |
|----------|--------|----------|
| Critical | Block deployment | Immediate |
| High | Block deployment | 24 hours |
| Medium | Track for fix | 7 days |
| Low | Best effort | 30 days |

### Policy File (Trivy)

```yaml
# .trivy.yaml
severity:
  - CRITICAL
  - HIGH

ignore-policy: .trivyignore

exit-code: 1
```

### Ignore File

```yaml
# .trivyignore
# Accepted risks with justification
CVE-2023-12345  # False positive - not exploitable in our context
CVE-2023-67890  # Mitigation in place - WAF blocks attack vector
```

## Continuous Monitoring

### Registry Scanning

```yaml
# Harbor registry scanning
apiVersion: goharbor.io/v1beta1
kind: HarborProject
spec:
  projectName: myproject
  scanner:
    enable: true
    trigger: OnPush
```

### Scheduled Scans

```yaml
# GitHub Actions - scheduled scan
name: Scheduled Security Scan

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Scan production images
        run: |
          trivy image myregistry/myapp:latest --severity HIGH,CRITICAL
```

## Complete Security Pipeline

```yaml
name: Build and Scan

on: [push, pull_request]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: myapp:${{ github.sha }}

      # Scan 1: Docker Scout
      - name: Docker Scout CVEs
        uses: docker/scout-action@v1
        with:
          command: cves
          image: myapp:${{ github.sha }}
          sarif-file: scout-results.sarif
          exit-code: true

      # Scan 2: Trivy
      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: myapp:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          exit-code: '1'

      # Scan 3: Trivy config scan
      - name: Trivy config scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          hide-progress: true
          exit-code: '1'

      # Upload results
      - name: Upload Scout results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: scout-results.sarif

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: trivy-results.sarif

      # Push if scans pass
      - name: Push to registry
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: myregistry/myapp:latest
```

## Scanning Checklist

### Build Time

- [ ] Scan Dockerfile for misconfigurations
- [ ] Scan dependencies (npm audit, pip-audit)
- [ ] Use minimal base images
- [ ] Pin dependency versions

### CI/CD

- [ ] Scan all images before push
- [ ] Block critical/high vulnerabilities
- [ ] Generate SBOM for each image
- [ ] Upload results to security dashboard

### Registry

- [ ] Enable automatic scanning on push
- [ ] Set vulnerability policies
- [ ] Monitor for new CVEs
- [ ] Alert on critical findings

### Production

- [ ] Regular scheduled scans
- [ ] Monitor for new vulnerabilities
- [ ] Track remediation timeline
- [ ] Document accepted risks

## Related Skills
- security/image-security
- security/runtime-security
- dockerfile/best-practices
