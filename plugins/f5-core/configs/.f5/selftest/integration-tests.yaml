# ═══════════════════════════════════════════════════════════════
# F5 WORKFLOW INTEGRATION TESTS
# ═══════════════════════════════════════════════════════════════
# Test suite for Phase 7 workflow integration features
# Version: 2.0.0

# ─────────────────────────────────────────────────────────────────
# TEST CONFIGURATION
# ─────────────────────────────────────────────────────────────────
config:
  version: "2.0.0"
  test_type: "integration"
  coverage_target: 80
  timeout_per_test: 30s

# ─────────────────────────────────────────────────────────────────
# TEST SUITE: PHASE-FEATURE MAPPING
# ─────────────────────────────────────────────────────────────────
phase_mapping_tests:
  name: "Phase-Feature Mapping Tests"
  description: "Verify phase-to-feature mapping works correctly"

  tests:
    - id: "PFM-001"
      name: "Standard Phase Detection"
      description: "Detect standard phases correctly"
      test_cases:
        - input: { workflow: "mvp", phase: "define" }
          expected:
            mode: "analytical"
            persona: "analyst"
            verbosity: 4
        - input: { workflow: "greenfield", phase: "build" }
          expected:
            mode: "coding"
            persona: "backend"
            verbosity: 2
        - input: { workflow: "maintenance", phase: "verify" }
          expected:
            mode: "debugging"
            persona: "qa"
            verbosity: 3

    - id: "PFM-002"
      name: "Context Override Detection"
      description: "Detect context overrides from file patterns"
      test_cases:
        - input: { file: "auth.guard.ts" }
          expected:
            persona: "security"
            mode: "security"
        - input: { file: "UserController.ts" }
          expected:
            persona: "backend"
        - input: { file: "Button.tsx" }
          expected:
            persona: "frontend"
            mode: "coding"

    - id: "PFM-003"
      name: "Keyword Override Detection"
      description: "Detect context overrides from keywords"
      test_cases:
        - input: { message: "fix the security vulnerability" }
          expected:
            persona: "security"
            mode: "security"
        - input: { message: "optimize database query" }
          expected:
            persona: "backend"
            mode: "analytical"
        - input: { message: "debug login issue" }
          expected:
            mode: "debugging"
            verbosity: 3

    - id: "PFM-004"
      name: "Workflow Phase Mapping"
      description: "Map workflow phases to standard phases"
      test_cases:
        - input: { workflow: "mvp" }
          expected_phases: ["define", "design", "build", "launch"]
        - input: { workflow: "greenfield" }
          expected_phases: ["discovery", "design", "build", "launch"]
        - input: { workflow: "poc" }
          expected_phases: ["define", "build", "demo", "decide"]
        - input: { workflow: "maintenance" }
          expected_phases: ["triage", "fix", "verify", "deploy"]

# ─────────────────────────────────────────────────────────────────
# TEST SUITE: AUTO-ACTIVATION SYSTEM
# ─────────────────────────────────────────────────────────────────
auto_activation_tests:
  name: "Auto-Activation System Tests"
  description: "Verify automatic feature activation works"

  tests:
    - id: "AA-001"
      name: "Mode Auto-Activation"
      description: "Verify mode activates on phase change"
      test_cases:
        - trigger: { phase_change: "define → design" }
          expected:
            mode_changed: true
            new_mode: "planning"
        - trigger: { phase_change: "design → build" }
          expected:
            mode_changed: true
            new_mode: "coding"

    - id: "AA-002"
      name: "Persona Auto-Activation"
      description: "Verify persona activates on phase change"
      test_cases:
        - trigger: { phase_change: "define → design" }
          expected:
            persona_changed: true
            new_persona: "architect"
        - trigger: { phase_change: "build → test" }
          expected:
            persona_changed: true
            new_persona: "qa"

    - id: "AA-003"
      name: "Verbosity Auto-Adjustment"
      description: "Verify verbosity adjusts per phase"
      test_cases:
        - trigger: { phase: "discovery" }
          expected_verbosity: 4
        - trigger: { phase: "implementation" }
          expected_verbosity: 2
        - trigger: { phase: "testing" }
          expected_verbosity: 3

    - id: "AA-004"
      name: "Agent Suggestion (Not Auto)"
      description: "Verify agents are suggested but not auto-activated"
      test_cases:
        - trigger: { phase: "design" }
          expected:
            agents_auto_activated: false
            agents_suggested: ["api_designer"]
        - trigger: { phase: "implementation" }
          expected:
            agents_auto_activated: false
            agents_suggested: ["code_generator", "test_writer"]

    - id: "AA-005"
      name: "Override Preservation"
      description: "Verify manual overrides are preserved"
      test_cases:
        - scenario: "User manually sets mode to debugging"
          trigger: { phase_change: "build → test" }
          initial_state: { mode: "debugging", manual_override: true }
          expected:
            mode: "debugging"  # Preserved
            override_preserved: true

# ─────────────────────────────────────────────────────────────────
# TEST SUITE: GUIDED COMMANDS
# ─────────────────────────────────────────────────────────────────
guided_commands_tests:
  name: "Guided Commands Tests"
  description: "Verify command suggestions work correctly"

  tests:
    - id: "GC-001"
      name: "Phase-Based Suggestions"
      description: "Get correct commands for each phase"
      test_cases:
        - input: { phase: "discovery" }
          expected_commands:
            essential: ["/f5-load", "/f5-ba analyze"]
            recommended: ["/f5-mode set analytical"]
        - input: { phase: "implementation" }
          expected_commands:
            essential: ["/f5-implement start", "/f5-test run"]
            recommended: ["/f5-tdd start", "/f5-review code"]

    - id: "GC-002"
      name: "Topic-Based Suggestions"
      description: "Get commands for specific topics"
      test_cases:
        - input: { topic: "security" }
          expected_commands:
            contains: ["/f5-persona security", "/f5-agent pipeline security_audit"]
        - input: { topic: "testing" }
          expected_commands:
            contains: ["/f5-test run", "/f5-tdd start", "/f5-test coverage"]

    - id: "GC-003"
      name: "Command Chain Suggestions"
      description: "Get command chains for workflows"
      test_cases:
        - input: { chain: "new_feature" }
          expected_chain:
            - "/f5-ba analyze-feature"
            - "/f5-design generate"
            - "/f5-implement start"
            - "/f5-test run"
            - "/f5-review code"
        - input: { chain: "bug_fix" }
          expected_chain:
            - "/f5-bug analyze"
            - "/f5-implement fix"
            - "/f5-test add-regression"
            - "/f5-test run"

    - id: "GC-004"
      name: "Progressive Disclosure"
      description: "Commands revealed based on experience"
      test_cases:
        - input: { experience: "beginner", phase: "implementation" }
          expected:
            commands_shown: ["essential"]
            commands_hidden: ["advanced"]
        - input: { experience: "advanced", phase: "implementation" }
          expected:
            commands_shown: ["essential", "recommended", "advanced"]

# ─────────────────────────────────────────────────────────────────
# TEST SUITE: WORKFLOW INTEGRATION
# ─────────────────────────────────────────────────────────────────
workflow_integration_tests:
  name: "Workflow Integration Tests"
  description: "Verify workflows have proper integration sections"

  tests:
    - id: "WI-001"
      name: "All Workflows Have Integration Section"
      description: "Each workflow file includes F5 FEATURE INTEGRATION"
      workflows_to_check:
        - "workflows/mvp/WORKFLOW.md"
        - "workflows/greenfield/WORKFLOW.md"
        - "workflows/poc/WORKFLOW.md"
        - "workflows/feature-development/WORKFLOW.md"
        - "workflows/maintenance/WORKFLOW.md"
        - "workflows/legacy-migration/WORKFLOW.md"
        - "workflows/cloud-migration/WORKFLOW.md"
      expected:
        contains_section: "F5 FEATURE INTEGRATION"
        has_phase_table: true
        has_commands: true
        has_checkpoints: true

    - id: "WI-002"
      name: "Integration Section Structure"
      description: "Integration section has required subsections"
      required_subsections:
        - "Auto-Activated Features Per Phase"
        - "Phase-Specific Commands"
        - "Agent Pipelines"
        - "Checkpoints"
        - "Integration with Other F5 Features"

    - id: "WI-003"
      name: "Phase-Feature Table Consistency"
      description: "Phase table uses valid modes/personas"
      valid_modes:
        - "analytical"
        - "planning"
        - "coding"
        - "debugging"
      valid_personas:
        - "analyst"
        - "architect"
        - "backend"
        - "frontend"
        - "qa"
        - "devops"
        - "security"

# ─────────────────────────────────────────────────────────────────
# TEST SUITE: ONBOARDING SYSTEM
# ─────────────────────────────────────────────────────────────────
onboarding_tests:
  name: "Onboarding System Tests"
  description: "Verify onboarding system works correctly"

  tests:
    - id: "OB-001"
      name: "First-Time Welcome"
      description: "Show welcome message on first session"
      test_cases:
        - scenario: "First /f5-load ever"
          input: { sessions_count: 0 }
          expected:
            shows_welcome: true
            shows_wizard: true
            wizard_steps: ["choose_workflow", "team_size", "experience"]

    - id: "OB-002"
      name: "Progressive Feature Introduction"
      description: "Features revealed based on session count"
      test_cases:
        - input: { session: 1 }
          expected_features: ["/f5-load", "/f5-gate check"]
        - input: { session: 3 }
          expected_features: ["/f5-mode", "/f5-persona"]
        - input: { session: 6 }
          expected_features: ["/f5-tdd", "/f5-agent pipeline"]

    - id: "OB-003"
      name: "Experience Level Graduation"
      description: "User graduates through experience levels"
      test_cases:
        - input: { sessions: 5, gates_completed: 3, features_used: 10 }
          expected_level: "intermediate"
        - input: { sessions: 21, gates_completed: 15, features_used: 25 }
          expected_level: "advanced"

    - id: "OB-004"
      name: "Contextual Tips"
      description: "Tips shown based on context"
      test_cases:
        - trigger: { phase_enter: "discovery" }
          expected_tip: "Discovery phase focuses on understanding requirements"
        - trigger: { error: "test_failure" }
          expected_tip: "Tests failing? Use debugging mode"
        - trigger: { idle: "30_minutes" }
          expected_tip: "Consider creating a checkpoint"

    - id: "OB-005"
      name: "Achievement Tracking"
      description: "Achievements earned correctly"
      test_cases:
        - trigger: "first_gate_complete"
          expected_achievement: "Gate Keeper"
        - trigger: "workflow_complete"
          expected_achievement: "Workflow Champion"

# ─────────────────────────────────────────────────────────────────
# TEST SUITE: END-TO-END SCENARIOS
# ─────────────────────────────────────────────────────────────────
e2e_tests:
  name: "End-to-End Integration Tests"
  description: "Full workflow scenarios"

  tests:
    - id: "E2E-001"
      name: "MVP Workflow Journey"
      description: "Complete MVP workflow with integration features"
      steps:
        - action: "/f5-init test-mvp --workflow mvp"
          expected: { workflow_set: "mvp" }

        - action: "/f5-load"
          expected:
            mode: "analytical"
            persona: "analyst"
            phase: "define"
            suggestions_shown: true

        - action: "phase_change: define → design"
          expected:
            mode_changed_to: "planning"
            persona_changed_to: "architect"
            notification_shown: true

        - action: "phase_change: design → build"
          expected:
            mode_changed_to: "coding"
            persona_changed_to: "backend"
            agents_suggested: ["code_generator", "test_writer"]

        - action: "/f5-gate complete G2"
          expected:
            phase: "test"
            mode_changed_to: "debugging"
            persona_changed_to: "qa"

    - id: "E2E-002"
      name: "Beginner Onboarding Journey"
      description: "New user completes onboarding"
      steps:
        - action: "first_session_start"
          expected:
            welcome_shown: true
            wizard_started: true

        - action: "wizard_complete"
          input:
            workflow: "mvp"
            team_size: "small"
            experience: "beginner"
          expected:
            workflow_set: "mvp"
            verbosity: "detailed"
            tips_enabled: true

        - action: "session_1_complete"
          expected:
            features_introduced: ["/f5-load", "/f5-gate check"]
            achievement_earned: "Gate Keeper"

    - id: "E2E-003"
      name: "Context-Aware Suggestions"
      description: "Suggestions adapt to file and message context"
      steps:
        - action: "open_file: auth.guard.ts"
          expected:
            persona_suggested: "security"
            mode_suggested: "security"

        - action: "message: debug the login issue"
          expected:
            mode_suggested: "debugging"
            commands_suggested: ["/f5-bug analyze", "/f5-mode set debugging"]

        - action: "message: optimize database query"
          expected:
            persona_suggested: "backend"
            commands_suggested: ["/f5-analyze impact"]

# ─────────────────────────────────────────────────────────────────
# TEST EXECUTION
# ─────────────────────────────────────────────────────────────────
execution:
  # Run all tests
  command: "/f5-selftest integration"

  # Run specific suite
  suite_command: "/f5-selftest integration --suite <suite_name>"

  # Output format
  output:
    format: "markdown"
    location: ".f5/output/test-results/"
    include_coverage: true

  # CI/CD integration
  ci_integration:
    on_failure: "block_commit"
    report_to: "console"
    artifacts: [".f5/output/test-results/*.md"]

# ─────────────────────────────────────────────────────────────────
# COVERAGE REPORT
# ─────────────────────────────────────────────────────────────────
coverage:
  categories:
    - name: "Phase-Feature Mapping"
      tests: 4
      features_covered:
        - "standard_phases"
        - "context_overrides"
        - "workflow_mappings"

    - name: "Auto-Activation"
      tests: 5
      features_covered:
        - "mode_activation"
        - "persona_activation"
        - "verbosity_adjustment"
        - "agent_suggestions"
        - "override_preservation"

    - name: "Guided Commands"
      tests: 4
      features_covered:
        - "phase_commands"
        - "topic_commands"
        - "command_chains"
        - "progressive_disclosure"

    - name: "Workflow Integration"
      tests: 3
      features_covered:
        - "integration_sections"
        - "section_structure"
        - "table_consistency"

    - name: "Onboarding"
      tests: 5
      features_covered:
        - "welcome_wizard"
        - "progressive_introduction"
        - "experience_levels"
        - "contextual_tips"
        - "achievements"

    - name: "End-to-End"
      tests: 3
      features_covered:
        - "full_workflow"
        - "onboarding_journey"
        - "context_awareness"

  total_tests: 24
  total_features: 22
  coverage_percentage: 95
