{
  "id": "f5-file-upload",
  "name": "Secure File Upload Workflow",
  "description": "File upload with validation, virus scanning, and storage management",
  "version": "1.0.0",
  "f5Metadata": {
    "domain": "file-management",
    "category": "upload",
    "complexity": "medium",
    "estimatedDuration": "15-20 minutes",
    "requiredSkills": ["f5-backend", "f5-security"],
    "mcpServers": ["github", "serena"],
    "qualityGates": ["D3", "G2", "G2.5", "G3"],
    "argumentHint": "Implement secure file upload with validation for {{projectName}}"
  },
  "nodes": [
    {
      "id": "start-1",
      "type": "start",
      "position": { "x": 300, "y": 50 },
      "data": {
        "label": "File Upload Request"
      }
    },
    {
      "id": "subagent-validate-file",
      "type": "subAgent",
      "position": { "x": 300, "y": 150 },
      "data": {
        "label": "Validate File",
        "description": "Validate file metadata and content",
        "prompt": "Validate file:\n1. Check file size against limits\n2. Validate MIME type matches extension\n3. Check magic bytes for true file type\n4. Validate filename (sanitize, check length)\n5. Check for duplicate uploads\n6. Return validation result",
        "agentType": "security-engineer",
        "outputPorts": ["valid", "invalid", "duplicate"]
      }
    },
    {
      "id": "ifelse-valid",
      "type": "ifElse",
      "position": { "x": 300, "y": 290 },
      "data": {
        "label": "File Valid?",
        "description": "Check if file passed validation",
        "condition": "File passed all validation checks"
      }
    },
    {
      "id": "subagent-scan-virus",
      "type": "subAgent",
      "position": { "x": 150, "y": 420 },
      "data": {
        "label": "Virus Scan",
        "description": "Scan file for malware",
        "prompt": "Scan file:\n1. Submit to virus scanner (ClamAV/VirusTotal)\n2. Wait for scan completion\n3. Check scan results\n4. If malware found, quarantine file\n5. Return scan result with details",
        "agentType": "security-engineer",
        "outputPorts": ["clean", "infected", "scan_failed"]
      }
    },
    {
      "id": "prompt-validation-error",
      "type": "prompt",
      "position": { "x": 450, "y": 420 },
      "data": {
        "label": "Return Validation Error",
        "description": "Return file validation error",
        "prompt": "Return validation error:\n- HTTP 400 Bad Request\n- Include specific validation failure\n- Include allowed file types\n- Include size limits",
        "outputPorts": ["done"]
      }
    },
    {
      "id": "ifelse-clean",
      "type": "ifElse",
      "position": { "x": 150, "y": 560 },
      "data": {
        "label": "File Clean?",
        "description": "Check if file passed virus scan",
        "condition": "Virus scan returned clean result"
      }
    },
    {
      "id": "subagent-process-file",
      "type": "subAgent",
      "position": { "x": 50, "y": 690 },
      "data": {
        "label": "Process File",
        "description": "Process and optimize file",
        "prompt": "Process file:\n1. Generate unique file ID\n2. For images: resize, create thumbnails, strip EXIF\n3. For documents: extract metadata, generate preview\n4. Compress if beneficial\n5. Generate file hash for integrity\n6. Return processed file data",
        "agentType": "backend-architect",
        "outputPorts": ["processed", "error"]
      }
    },
    {
      "id": "prompt-virus-error",
      "type": "prompt",
      "position": { "x": 250, "y": 690 },
      "data": {
        "label": "Return Virus Error",
        "description": "Return malware detection error",
        "prompt": "Return virus error:\n- HTTP 422 Unprocessable Entity\n- Generic message (don't reveal scan details)\n- Log security event with full details\n- Quarantine file for analysis",
        "outputPorts": ["done"]
      }
    },
    {
      "id": "mcp-upload-storage",
      "type": "mcp",
      "position": { "x": 50, "y": 830 },
      "data": {
        "label": "Upload to Storage",
        "description": "Upload file to cloud storage",
        "serverName": "github",
        "toolName": "create_or_update_file",
        "mode": "structured",
        "parameters": {
          "path": "uploads/",
          "message": "File uploaded to cloud storage (S3/GCS/Azure)"
        },
        "outputPorts": ["uploaded", "failed"]
      }
    },
    {
      "id": "subagent-create-record",
      "type": "subAgent",
      "position": { "x": 50, "y": 970 },
      "data": {
        "label": "Create File Record",
        "description": "Create database record for file",
        "prompt": "Create file record:\n1. Store file metadata\n2. Store storage path/URL\n3. Set access permissions\n4. Link to user/entity\n5. Create audit trail\n6. Return file record with access URL",
        "agentType": "backend-architect",
        "outputPorts": ["created", "error"]
      }
    },
    {
      "id": "qualitygate-security",
      "type": "qualityGate",
      "position": { "x": 50, "y": 1100 },
      "data": {
        "label": "G2.5: Security Review",
        "description": "Security review for file upload",
        "gateId": "G2.5",
        "gateName": "Security Review",
        "checklistItems": [
          "File type validation robust",
          "Size limits enforced",
          "Virus scanning functional",
          "Secure storage configured",
          "Access control implemented"
        ],
        "outputPorts": ["passed", "failed"]
      }
    },
    {
      "id": "prompt-success",
      "type": "prompt",
      "position": { "x": 50, "y": 1230 },
      "data": {
        "label": "Return Upload Success",
        "description": "Return successful upload response",
        "prompt": "Return success:\n- HTTP 201 Created\n- Include file ID\n- Include access URL (signed if private)\n- Include file metadata\n- Include thumbnail URL if applicable",
        "outputPorts": ["done"]
      }
    },
    {
      "id": "end-success",
      "type": "end",
      "position": { "x": 50, "y": 1360 },
      "data": {
        "label": "Upload Complete"
      }
    },
    {
      "id": "end-validation-error",
      "type": "end",
      "position": { "x": 450, "y": 560 },
      "data": {
        "label": "Validation Failed"
      }
    },
    {
      "id": "end-virus-error",
      "type": "end",
      "position": { "x": 250, "y": 830 },
      "data": {
        "label": "Malware Detected"
      }
    }
  ],
  "connections": [
    {
      "id": "conn-1",
      "source": "start-1",
      "target": "subagent-validate-file",
      "sourceHandle": "output",
      "targetHandle": "input"
    },
    {
      "id": "conn-2",
      "source": "subagent-validate-file",
      "target": "ifelse-valid",
      "sourceHandle": "output-valid",
      "targetHandle": "input"
    },
    {
      "id": "conn-3",
      "source": "ifelse-valid",
      "target": "subagent-scan-virus",
      "sourceHandle": "branch-0",
      "targetHandle": "input",
      "label": "Valid"
    },
    {
      "id": "conn-4",
      "source": "ifelse-valid",
      "target": "prompt-validation-error",
      "sourceHandle": "branch-1",
      "targetHandle": "input",
      "label": "Invalid"
    },
    {
      "id": "conn-5",
      "source": "prompt-validation-error",
      "target": "end-validation-error",
      "sourceHandle": "output-done",
      "targetHandle": "input"
    },
    {
      "id": "conn-6",
      "source": "subagent-scan-virus",
      "target": "ifelse-clean",
      "sourceHandle": "output-clean",
      "targetHandle": "input"
    },
    {
      "id": "conn-7",
      "source": "ifelse-clean",
      "target": "subagent-process-file",
      "sourceHandle": "branch-0",
      "targetHandle": "input",
      "label": "Clean"
    },
    {
      "id": "conn-8",
      "source": "ifelse-clean",
      "target": "prompt-virus-error",
      "sourceHandle": "branch-1",
      "targetHandle": "input",
      "label": "Infected"
    },
    {
      "id": "conn-9",
      "source": "prompt-virus-error",
      "target": "end-virus-error",
      "sourceHandle": "output-done",
      "targetHandle": "input"
    },
    {
      "id": "conn-10",
      "source": "subagent-process-file",
      "target": "mcp-upload-storage",
      "sourceHandle": "output-processed",
      "targetHandle": "input"
    },
    {
      "id": "conn-11",
      "source": "mcp-upload-storage",
      "target": "subagent-create-record",
      "sourceHandle": "output-uploaded",
      "targetHandle": "input"
    },
    {
      "id": "conn-12",
      "source": "subagent-create-record",
      "target": "qualitygate-security",
      "sourceHandle": "output-created",
      "targetHandle": "input"
    },
    {
      "id": "conn-13",
      "source": "qualitygate-security",
      "target": "prompt-success",
      "sourceHandle": "branch-0",
      "targetHandle": "input"
    },
    {
      "id": "conn-14",
      "source": "prompt-success",
      "target": "end-success",
      "sourceHandle": "output-done",
      "targetHandle": "input"
    }
  ]
}
