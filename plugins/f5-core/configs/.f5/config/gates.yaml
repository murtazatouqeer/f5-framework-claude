# .f5/gates.yaml
# F5 Framework Gate Configuration
# Version: 1.0.0

# ═══════════════════════════════════════════════════════════════
# METADATA
# ═══════════════════════════════════════════════════════════════

version: "1.0.0"
description: "Gate definitions with automated checks and evidence requirements"
enforcement_mode: "strict"  # strict | warn | permissive

# ═══════════════════════════════════════════════════════════════
# GLOBAL SETTINGS
# ═══════════════════════════════════════════════════════════════

global:
  # Default thresholds (can be overridden per gate)
  thresholds:
    code_coverage: 80
    branch_coverage: 75
    function_coverage: 80
    line_coverage: 80
    complexity_max: 10
    complexity_avg: 5
    duplication_max: 5
    lint_errors: 0
    lint_warnings: 10
    type_errors: 0
    test_pass_rate: 100
    security_critical: 0
    security_high: 0

  # Evidence storage
  evidence:
    directory: ".f5/gates"
    retention_days: 90
    format: "markdown"  # markdown | json | html
    auto_collect: true
    include_artifacts: true

  # Notification settings
  notifications:
    slack_webhook: "${SLACK_WEBHOOK_URL}"
    email: "${TEAM_EMAIL}"
    on_pass: false
    on_fail: true
    on_warn: true

  # Timeout settings
  timeouts:
    lint: 120        # seconds
    test: 600        # seconds
    coverage: 300    # seconds
    security: 300    # seconds
    build: 600       # seconds

# ═══════════════════════════════════════════════════════════════
# DESIGN GATES (D1-D4)
# ═══════════════════════════════════════════════════════════════

gates:
  # ─────────────────────────────────────────────────────────────
  # D1: RESEARCH COMPLETE
  # ─────────────────────────────────────────────────────────────
  D1:
    name: "Research Complete"
    name_ja: "調査完了"
    description: "Verify all research and analysis is complete"
    phase: "design"

    prerequisites: []  # No prerequisites for D1

    checklist:
      required:
        - id: "d1_market_research"
          name: "Market Research"
          name_ja: "市場調査"
          description: "Market analysis and competitor research completed"
          evidence_type: "document"
          evidence_path: "docs/research/market-analysis.md"

        - id: "d1_tech_research"
          name: "Technology Research"
          name_ja: "技術調査"
          description: "Technology stack evaluation completed"
          evidence_type: "document"
          evidence_path: "docs/research/tech-evaluation.md"

        - id: "d1_stakeholder"
          name: "Stakeholder Interviews"
          name_ja: "ステークホルダーインタビュー"
          description: "Key stakeholder interviews conducted"
          evidence_type: "document"
          evidence_path: "docs/research/stakeholder-interviews.md"

        - id: "d1_feasibility"
          name: "Feasibility Study"
          name_ja: "実現可能性調査"
          description: "Technical and business feasibility documented"
          evidence_type: "document"
          evidence_path: "docs/research/feasibility-study.md"

      optional:
        - id: "d1_poc"
          name: "Proof of Concept"
          name_ja: "概念実証"
          description: "Technical POC completed (if applicable)"
          evidence_type: "code"
          evidence_path: "poc/"

        - id: "d1_risk_assessment"
          name: "Risk Assessment"
          name_ja: "リスク評価"
          description: "Initial risk assessment"
          evidence_type: "document"
          evidence_path: "docs/research/risk-assessment.md"

    automated_checks: []  # D1 is primarily document-based

    approvers:
      - role: "tech_lead"
        required: true
      - role: "product_owner"
        required: true

    outputs:
      - "docs/research/market-analysis.md"
      - "docs/research/tech-evaluation.md"
      - "docs/research/stakeholder-interviews.md"
      - "docs/research/feasibility-study.md"

  # ─────────────────────────────────────────────────────────────
  # D2: SRS APPROVED
  # ─────────────────────────────────────────────────────────────
  D2:
    name: "SRS Approved"
    name_ja: "SRS承認済"
    description: "Software Requirements Specification approved"
    phase: "design"

    prerequisites:
      - gate: "D1"
        status: "passed"

    checklist:
      required:
        - id: "d2_srs_document"
          name: "SRS Document"
          name_ja: "SRS文書"
          description: "Complete SRS document with all sections"
          evidence_type: "document"
          evidence_path: "docs/srs/SRS.md"
          validation:
            required_sections:
              - "1. Introduction"
              - "2. Overall Description"
              - "3. Functional Requirements"
              - "4. Non-Functional Requirements"
              - "5. External Interface Requirements"
              - "6. System Features"

        - id: "d2_use_cases"
          name: "Use Cases"
          name_ja: "ユースケース"
          description: "All use cases documented"
          evidence_type: "document"
          evidence_path: "docs/srs/use-cases/"

        - id: "d2_requirements_matrix"
          name: "Requirements Traceability Matrix"
          name_ja: "要件トレーサビリティマトリックス"
          description: "RTM linking requirements to features"
          evidence_type: "document"
          evidence_path: "docs/srs/rtm.md"

        - id: "d2_acceptance_criteria"
          name: "Acceptance Criteria"
          name_ja: "受入基準"
          description: "Clear acceptance criteria for all requirements"
          evidence_type: "document"
          evidence_path: "docs/srs/acceptance-criteria.md"

        - id: "d2_glossary"
          name: "Glossary"
          name_ja: "用語集"
          description: "Business and technical terms defined"
          evidence_type: "document"
          evidence_path: "docs/srs/glossary.md"

      optional:
        - id: "d2_prototypes"
          name: "UI Prototypes"
          name_ja: "UIプロトタイプ"
          description: "Wireframes or prototypes"
          evidence_type: "link"
          evidence_path: "docs/srs/prototypes.md"

        - id: "d2_user_stories"
          name: "User Stories"
          name_ja: "ユーザーストーリー"
          description: "User stories with acceptance criteria"
          evidence_type: "document"
          evidence_path: "docs/srs/user-stories/"

    automated_checks:
      - id: "check_srs_sections"
        name: "SRS Section Validation"
        command: "f5 validate srs-sections"
        required: true

      - id: "check_req_coverage"
        name: "Requirements Coverage"
        command: "f5 validate req-coverage"
        required: true
        threshold:
          min_requirements: 5
          coverage: 100

      - id: "check_req_ids"
        name: "Requirement ID Format"
        command: "f5 validate req-ids"
        required: true

    approvers:
      - role: "tech_lead"
        required: true
      - role: "product_owner"
        required: true
      - role: "customer"
        required: true

    outputs:
      - "docs/srs/SRS.md"
      - "docs/srs/use-cases/"
      - "docs/srs/rtm.md"
      - "docs/srs/acceptance-criteria.md"

  # ─────────────────────────────────────────────────────────────
  # D3: BASIC DESIGN APPROVED
  # ─────────────────────────────────────────────────────────────
  D3:
    name: "Basic Design Approved"
    name_ja: "基本設計承認済"
    description: "High-level architecture and design approved"
    phase: "design"

    prerequisites:
      - gate: "D2"
        status: "passed"

    checklist:
      required:
        - id: "d3_architecture"
          name: "System Architecture"
          name_ja: "システムアーキテクチャ"
          description: "High-level architecture document"
          evidence_type: "document"
          evidence_path: "docs/design/architecture.md"
          validation:
            required_diagrams:
              - "system-context"
              - "container-diagram"
              - "component-diagram"

        - id: "d3_data_model"
          name: "Data Model"
          name_ja: "データモデル"
          description: "Database schema design"
          evidence_type: "document"
          evidence_path: "docs/design/data-model.md"

        - id: "d3_api_design"
          name: "API Design"
          name_ja: "API設計"
          description: "API specifications"
          evidence_type: "document"
          evidence_path: "docs/design/api-design.md"

        - id: "d3_security_design"
          name: "Security Design"
          name_ja: "セキュリティ設計"
          description: "Security architecture and considerations"
          evidence_type: "document"
          evidence_path: "docs/design/security-design.md"

        - id: "d3_tech_stack"
          name: "Technology Stack"
          name_ja: "技術スタック"
          description: "Finalized technology choices"
          evidence_type: "document"
          evidence_path: "docs/design/tech-stack.md"

        - id: "d3_integration"
          name: "Integration Design"
          name_ja: "インテグレーション設計"
          description: "External system integration approach"
          evidence_type: "document"
          evidence_path: "docs/design/integration-design.md"

      optional:
        - id: "d3_performance"
          name: "Performance Requirements"
          name_ja: "性能要件"
          description: "Performance targets and approach"
          evidence_type: "document"
          evidence_path: "docs/design/performance-requirements.md"

        - id: "d3_scalability"
          name: "Scalability Plan"
          name_ja: "スケーラビリティ計画"
          description: "Scaling strategy"
          evidence_type: "document"
          evidence_path: "docs/design/scalability-plan.md"

    automated_checks:
      - id: "check_diagrams"
        name: "Architecture Diagrams Exist"
        command: "f5 validate diagrams"
        required: true

      - id: "check_api_spec"
        name: "API Specification Valid"
        command: "f5 validate openapi"
        required: false

      - id: "check_erd"
        name: "ERD Valid"
        command: "f5 validate erd"
        required: false

    approvers:
      - role: "architect"
        required: true
      - role: "tech_lead"
        required: true
      - role: "security_lead"
        required: true
      - role: "customer"
        required: true

    outputs:
      - "docs/design/architecture.md"
      - "docs/design/data-model.md"
      - "docs/design/api-design.md"
      - "docs/design/security-design.md"
      - "docs/design/tech-stack.md"

  # ─────────────────────────────────────────────────────────────
  # D4: DETAIL DESIGN APPROVED
  # ─────────────────────────────────────────────────────────────
  D4:
    name: "Detail Design Approved"
    name_ja: "詳細設計承認済"
    description: "Detailed design ready for implementation"
    phase: "design"

    prerequisites:
      - gate: "D3"
        status: "passed"

    checklist:
      required:
        - id: "d4_module_design"
          name: "Module Design"
          name_ja: "モジュール設計"
          description: "Detailed module/component design"
          evidence_type: "document"
          evidence_path: "docs/design/modules/"

        - id: "d4_class_design"
          name: "Class/Interface Design"
          name_ja: "クラス/インターフェース設計"
          description: "Class diagrams and interfaces"
          evidence_type: "document"
          evidence_path: "docs/design/class-diagrams/"

        - id: "d4_db_schema"
          name: "Database Schema"
          name_ja: "データベーススキーマ"
          description: "Complete database schema with migrations"
          evidence_type: "document"
          evidence_path: "docs/design/db-schema.md"

        - id: "d4_api_contracts"
          name: "API Contracts"
          name_ja: "APIコントラクト"
          description: "Detailed API contracts (OpenAPI/Swagger)"
          evidence_type: "file"
          evidence_path: "docs/api/openapi.yaml"

        - id: "d4_error_handling"
          name: "Error Handling Strategy"
          name_ja: "エラーハンドリング戦略"
          description: "Error codes and handling approach"
          evidence_type: "document"
          evidence_path: "docs/design/error-handling.md"

        - id: "d4_test_strategy"
          name: "Test Strategy"
          name_ja: "テスト戦略"
          description: "Testing approach and coverage targets"
          evidence_type: "document"
          evidence_path: "docs/design/test-strategy.md"

        - id: "d4_coding_standards"
          name: "Coding Standards"
          name_ja: "コーディング規約"
          description: "Code style and conventions"
          evidence_type: "document"
          evidence_path: "docs/design/coding-standards.md"

      optional:
        - id: "d4_sequence_diagrams"
          name: "Sequence Diagrams"
          name_ja: "シーケンス図"
          description: "Key process flows"
          evidence_type: "document"
          evidence_path: "docs/design/sequence-diagrams/"

        - id: "d4_state_diagrams"
          name: "State Diagrams"
          name_ja: "状態遷移図"
          description: "State machines for complex entities"
          evidence_type: "document"
          evidence_path: "docs/design/state-diagrams/"

    automated_checks:
      - id: "check_openapi_valid"
        name: "OpenAPI Specification Valid"
        command: "npx @redocly/cli lint docs/api/openapi.yaml"
        required: true

      - id: "check_db_schema"
        name: "Database Schema Valid"
        command: "f5 validate db-schema"
        required: true

      - id: "check_module_coverage"
        name: "All Modules Documented"
        command: "f5 validate module-docs"
        required: true

    approvers:
      - role: "architect"
        required: true
      - role: "tech_lead"
        required: true
      - role: "dev_lead"
        required: true
      - role: "customer"
        required: true

    outputs:
      - "docs/design/modules/"
      - "docs/api/openapi.yaml"
      - "docs/design/db-schema.md"
      - "docs/design/test-strategy.md"
      - "docs/design/error-handling.md"

  # ─────────────────────────────────────────────────────────────
  # G2: IMPLEMENTATION READY
  # ─────────────────────────────────────────────────────────────
  G2:
    name: "Implementation Ready"
    name_ja: "実装完了"
    description: "Code implementation meets quality standards"
    phase: "implementation"

    prerequisites:
      - gate: "D4"
        status: "passed"

    checklist:
      required:
        - id: "g2_code_complete"
          name: "Code Implementation Complete"
          name_ja: "コード実装完了"
          description: "All features implemented per design"
          evidence_type: "code"

        - id: "g2_unit_tests"
          name: "Unit Tests Written"
          name_ja: "単体テスト作成完了"
          description: "Unit tests for all components"
          evidence_type: "code"
          evidence_path: "**/*.spec.ts"

        - id: "g2_code_review"
          name: "Code Review Completed"
          name_ja: "コードレビュー完了"
          description: "All code reviewed and approved"
          evidence_type: "pr"

        - id: "g2_documentation"
          name: "Code Documentation"
          name_ja: "コードドキュメント"
          description: "Code is properly documented"
          evidence_type: "code"

        - id: "g2_traceability"
          name: "Requirements Traceability"
          name_ja: "要件トレーサビリティ"
          description: "All code traces to requirements"
          evidence_type: "report"
          evidence_path: ".f5/gates/G2/traceability.md"

    automated_checks:
      - id: "lint"
        name: "Lint Check"
        name_ja: "Lintチェック"
        command: "npm run lint"
        required: true
        threshold:
          errors: 0
          warnings: 10

      - id: "type_check"
        name: "Type Check"
        name_ja: "型チェック"
        command: "npm run type-check"
        required: true
        threshold:
          errors: 0

      - id: "unit_tests"
        name: "Unit Tests"
        name_ja: "単体テスト"
        command: "npm run test"
        required: true
        threshold:
          pass_rate: 100

      - id: "coverage"
        name: "Code Coverage"
        name_ja: "コードカバレッジ"
        command: "npm run test:cov"
        required: true
        threshold:
          statements: 80
          branches: 75
          functions: 80
          lines: 80

      - id: "security_audit"
        name: "Security Audit"
        name_ja: "セキュリティ監査"
        command: "npm audit --audit-level=high"
        required: true
        threshold:
          high: 0
          critical: 0

      - id: "complexity"
        name: "Code Complexity"
        name_ja: "コード複雑度"
        command: "npx complexity-report --format json src/"
        required: false
        threshold:
          max_complexity: 10
          avg_complexity: 5

      - id: "duplication"
        name: "Code Duplication"
        name_ja: "コード重複"
        command: "npx jscpd src/ --reporters json"
        required: false
        threshold:
          max_percentage: 5

      - id: "traceability"
        name: "Traceability Validation"
        name_ja: "トレーサビリティ検証"
        command: "f5 strict validate"
        required: true
        threshold:
          coverage: 100

    approvers:
      - role: "dev_lead"
        required: true
      - role: "tech_lead"
        required: true

    outputs:
      - "src/**"
      - "coverage/lcov-report/index.html"
      - ".f5/gates/G2-report.md"

  # ─────────────────────────────────────────────────────────────
  # G2.5: VERIFICATION COMPLETE
  # ─────────────────────────────────────────────────────────────
  G2.5:
    name: "Verification Complete"
    name_ja: "検証完了"
    description: "All verification checks passed before testing"
    phase: "verification"

    prerequisites:
      - gate: "G2"
        status: "passed"

    checklist:
      required:
        - id: "g25_asset_verification"
          name: "Asset Verification"
          name_ja: "アセット検証"
          description: "All assets (images, icons, fonts) exist and load correctly"
          evidence_type: "report"
          evidence_path: ".f5/gates/G2.5/asset-verification.md"
          command: "/f5-verify assets"

        - id: "g25_integration_check"
          name: "Integration Check"
          name_ja: "インテグレーションチェック"
          description: "Navigation, routes, and links are correct"
          evidence_type: "report"
          evidence_path: ".f5/gates/G2.5/integration-check.md"
          command: "/f5-verify integration"

        - id: "g25_visual_qa"
          name: "Visual QA"
          name_ja: "ビジュアルQA"
          description: "Implementation matches Figma design within threshold"
          evidence_type: "report"
          evidence_path: ".f5/gates/G2.5/visual-qa.md"
          command: "/f5-test-visual --compare-figma"
          threshold:
            max_diff_percent: 5

        - id: "g25_bug_fixes"
          name: "Bug Fixes Complete"
          name_ja: "バグ修正完了"
          description: "All critical issues from verification resolved"
          evidence_type: "report"
          evidence_path: ".f5/gates/G2.5/bug-fixes.md"
          command: "/f5-verify bugs"

      optional:
        - id: "g25_accessibility_check"
          name: "Accessibility Check"
          name_ja: "アクセシビリティチェック"
          description: "Basic accessibility compliance verified"
          evidence_type: "report"
          evidence_path: ".f5/gates/G2.5/accessibility-check.md"

        - id: "g25_performance_baseline"
          name: "Performance Baseline"
          name_ja: "パフォーマンスベースライン"
          description: "Initial performance metrics captured"
          evidence_type: "report"
          evidence_path: ".f5/gates/G2.5/performance-baseline.md"

    automated_checks:
      - id: "verify_assets"
        name: "Asset Verification"
        name_ja: "アセット検証"
        command: "f5 verify assets"
        required: true

      - id: "verify_integration"
        name: "Integration Verification"
        name_ja: "インテグレーション検証"
        command: "f5 verify integration"
        required: true

      - id: "visual_regression"
        name: "Visual Regression Test"
        name_ja: "ビジュアルリグレッションテスト"
        command: "f5 test visual --compare-figma --ci"
        required: true
        threshold:
          max_diff_percent: 5

      - id: "bug_status"
        name: "Bug Status Check"
        name_ja: "バグステータスチェック"
        command: "f5 verify bugs --blocking-only"
        required: true
        threshold:
          open_critical: 0
          open_high: 0

    approvers:
      - role: "dev_lead"
        required: true
      - role: "qa_lead"
        required: false

    outputs:
      - ".f5/gates/G2.5-report.md"
      - ".f5/visual/reports/"
      - ".f5/bugs/"

  # ─────────────────────────────────────────────────────────────
  # G3: TESTING COMPLETE
  # ─────────────────────────────────────────────────────────────
  G3:
    name: "Testing Complete"
    name_ja: "テスト完了"
    description: "All testing completed with acceptable results"
    phase: "testing"

    prerequisites:
      - gate: "G2.5"
        status: "passed"

    checklist:
      required:
        - id: "g3_unit_tests"
          name: "Unit Tests Passing"
          name_ja: "単体テスト合格"
          description: "All unit tests pass"
          evidence_type: "report"
          evidence_path: ".f5/gates/G3/unit-test-report.md"

        - id: "g3_integration_tests"
          name: "Integration Tests Passing"
          name_ja: "結合テスト合格"
          description: "All integration tests pass"
          evidence_type: "report"
          evidence_path: ".f5/gates/G3/integration-test-report.md"

        - id: "g3_e2e_tests"
          name: "E2E Tests Passing"
          name_ja: "E2Eテスト合格"
          description: "All E2E tests pass"
          evidence_type: "report"
          evidence_path: ".f5/gates/G3/e2e-test-report.md"

        - id: "g3_security_tests"
          name: "Security Tests Passing"
          name_ja: "セキュリティテスト合格"
          description: "Security scan completed"
          evidence_type: "report"
          evidence_path: ".f5/gates/G3/security-test-report.md"

        - id: "g3_performance_tests"
          name: "Performance Tests"
          name_ja: "性能テスト"
          description: "Performance benchmarks met"
          evidence_type: "report"
          evidence_path: ".f5/gates/G3/performance-test-report.md"

        - id: "g3_regression_tests"
          name: "Regression Tests"
          name_ja: "リグレッションテスト"
          description: "No regression issues found"
          evidence_type: "report"
          evidence_path: ".f5/gates/G3/regression-test-report.md"

        - id: "g3_visual_tests"
          name: "Visual Regression Tests"
          name_ja: "ビジュアルリグレッションテスト"
          description: "Visual regression tests pass"
          evidence_type: "report"
          evidence_path: ".f5/visual/reports/visual-report.html"

    automated_checks:
      - id: "unit_tests"
        name: "Unit Tests"
        name_ja: "単体テスト"
        command: "npm run test"
        required: true
        threshold:
          pass_rate: 100

      - id: "integration_tests"
        name: "Integration Tests"
        name_ja: "結合テスト"
        command: "npm run test:integration"
        required: true
        threshold:
          pass_rate: 100

      - id: "e2e_tests"
        name: "E2E Tests"
        name_ja: "E2Eテスト"
        command: "npm run test:e2e"
        required: true
        threshold:
          pass_rate: 100

      - id: "coverage_total"
        name: "Total Code Coverage"
        name_ja: "総コードカバレッジ"
        command: "npm run test:cov"
        required: true
        threshold:
          statements: 80
          branches: 75
          functions: 80
          lines: 80

      - id: "security_scan"
        name: "Security Scan"
        name_ja: "セキュリティスキャン"
        command: "npm run security:scan"
        required: true
        threshold:
          critical: 0
          high: 0

      - id: "performance"
        name: "Performance Benchmark"
        name_ja: "性能ベンチマーク"
        command: "npm run test:perf"
        required: false
        threshold:
          avg_response_time_ms: 200
          p95_response_time_ms: 500
          p99_response_time_ms: 1000

      - id: "accessibility"
        name: "Accessibility Tests"
        name_ja: "アクセシビリティテスト"
        command: "npm run test:a11y"
        required: false
        threshold:
          violations: 0

      - id: "visual_regression"
        name: "Visual Regression Tests"
        name_ja: "ビジュアルリグレッションテスト"
        command: "f5 test visual --ci --threshold 5"
        required: true
        threshold:
          max_diff_percent: 5
          pages_pass_rate: 100

    approvers:
      - role: "qa_lead"
        required: true
      - role: "dev_lead"
        required: true
      - role: "security_lead"
        required: false

    outputs:
      - ".f5/gates/G3-report.md"
      - "coverage/"
      - "test-results/"

  # ─────────────────────────────────────────────────────────────
  # G4: DEPLOYMENT READY
  # ─────────────────────────────────────────────────────────────
  G4:
    name: "Deployment Ready"
    name_ja: "デプロイ準備完了"
    description: "Ready for production deployment"
    phase: "deployment"

    prerequisites:
      - gate: "G2"
        status: "passed"
      - gate: "G3"
        status: "passed"

    checklist:
      required:
        - id: "g4_staging_deployed"
          name: "Staging Deployment"
          name_ja: "ステージング環境デプロイ"
          description: "Successfully deployed to staging"
          evidence_type: "deployment"
          evidence_path: ".f5/gates/G4/staging-deployment.md"

        - id: "g4_uat_approved"
          name: "UAT Approved"
          name_ja: "UAT承認"
          description: "User Acceptance Testing passed"
          evidence_type: "approval"
          evidence_path: ".f5/gates/G4/uat-approval.md"

        - id: "g4_release_notes"
          name: "Release Notes"
          name_ja: "リリースノート"
          description: "Release notes prepared"
          evidence_type: "document"
          evidence_path: "CHANGELOG.md"

        - id: "g4_rollback_plan"
          name: "Rollback Plan"
          name_ja: "ロールバック計画"
          description: "Rollback procedure documented"
          evidence_type: "document"
          evidence_path: "docs/deployment/rollback-plan.md"

        - id: "g4_runbook"
          name: "Operations Runbook"
          name_ja: "運用手順書"
          description: "Runbook for operations team"
          evidence_type: "document"
          evidence_path: "docs/deployment/runbook.md"

        - id: "g4_monitoring"
          name: "Monitoring Setup"
          name_ja: "監視設定"
          description: "Monitoring and alerting configured"
          evidence_type: "config"
          evidence_path: "monitoring/"

        - id: "g4_backup"
          name: "Backup Strategy"
          name_ja: "バックアップ戦略"
          description: "Backup and recovery procedures"
          evidence_type: "document"
          evidence_path: "docs/deployment/backup-strategy.md"

        - id: "g4_security_review"
          name: "Final Security Review"
          name_ja: "最終セキュリティレビュー"
          description: "Security team sign-off"
          evidence_type: "approval"
          evidence_path: ".f5/gates/G4/security-review.md"

    automated_checks:
      - id: "staging_health"
        name: "Staging Health Check"
        name_ja: "ステージングヘルスチェック"
        command: "curl -f ${STAGING_URL}/health"
        required: true

      - id: "staging_smoke"
        name: "Staging Smoke Tests"
        name_ja: "ステージングスモークテスト"
        command: "npm run test:smoke -- --env staging"
        required: true
        threshold:
          pass_rate: 100

      - id: "db_migration_check"
        name: "Database Migration Check"
        name_ja: "データベースマイグレーションチェック"
        command: "npm run migration:check"
        required: true

      - id: "dependency_check"
        name: "Dependency Vulnerability Check"
        name_ja: "依存関係脆弱性チェック"
        command: "npm audit --production"
        required: true
        threshold:
          critical: 0
          high: 0

      - id: "dockerfile_lint"
        name: "Dockerfile Lint"
        name_ja: "Dockerfile Lint"
        command: "hadolint Dockerfile"
        required: false

      - id: "k8s_validate"
        name: "Kubernetes Manifests Validation"
        name_ja: "Kubernetesマニフェスト検証"
        command: "kubectl apply --dry-run=client -f k8s/"
        required: false

      - id: "terraform_validate"
        name: "Terraform Validation"
        name_ja: "Terraform検証"
        command: "terraform validate"
        required: false

      - id: "secrets_check"
        name: "Secrets Detection"
        name_ja: "シークレット検出"
        command: "gitleaks detect --source . --verbose"
        required: true
        threshold:
          leaks: 0

    approvers:
      - role: "dev_lead"
        required: true
      - role: "qa_lead"
        required: true
      - role: "ops_lead"
        required: true
      - role: "product_owner"
        required: true
      - role: "customer"
        required: true

    outputs:
      - ".f5/gates/G4-report.md"
      - "CHANGELOG.md"
      - "docs/deployment/"

# ═══════════════════════════════════════════════════════════════
# STACK-SPECIFIC COMMANDS
# ═══════════════════════════════════════════════════════════════

stack_commands:
  # Node.js / TypeScript Stacks
  nestjs:
    lint: "npm run lint"
    type_check: "npm run build"
    test: "npm run test"
    test_integration: "npm run test:e2e"
    test_cov: "npm run test:cov"
    security: "npm audit"
    build: "npm run build"

  express:
    lint: "npm run lint"
    type_check: "npm run build"
    test: "npm run test"
    test_integration: "npm run test:integration"
    test_cov: "npm run test:cov"
    security: "npm audit"
    build: "npm run build"

  nextjs:
    lint: "npm run lint"
    type_check: "npm run build"
    test: "npm run test"
    test_e2e: "npm run test:e2e"
    test_cov: "npm run test:cov"
    security: "npm audit"
    build: "npm run build"

  react:
    lint: "npm run lint"
    type_check: "npm run type-check"
    test: "npm run test"
    test_e2e: "npm run test:e2e"
    test_cov: "npm run test:cov"
    security: "npm audit"
    build: "npm run build"

  vue:
    lint: "npm run lint"
    type_check: "vue-tsc --noEmit"
    test: "npm run test:unit"
    test_e2e: "npm run test:e2e"
    test_cov: "npm run test:cov"
    security: "npm audit"
    build: "npm run build"

  # Java Stacks
  spring:
    lint: "./mvnw checkstyle:check"
    type_check: "./mvnw compile"
    test: "./mvnw test"
    test_integration: "./mvnw verify -Pintegration"
    test_cov: "./mvnw jacoco:report"
    security: "./mvnw dependency-check:check"
    build: "./mvnw package -DskipTests"

  spring_gradle:
    lint: "./gradlew checkstyleMain"
    type_check: "./gradlew compileJava"
    test: "./gradlew test"
    test_integration: "./gradlew integrationTest"
    test_cov: "./gradlew jacocoTestReport"
    security: "./gradlew dependencyCheckAnalyze"
    build: "./gradlew build -x test"

  # Python Stacks
  django:
    lint: "flake8 ."
    type_check: "mypy ."
    test: "pytest"
    test_integration: "pytest -m integration"
    test_cov: "pytest --cov=. --cov-report=html"
    security: "safety check"
    build: "python setup.py build"

  fastapi:
    lint: "ruff check ."
    type_check: "mypy ."
    test: "pytest"
    test_integration: "pytest -m integration"
    test_cov: "pytest --cov=. --cov-report=html"
    security: "safety check"
    build: "pip install -e ."

  flask:
    lint: "flake8 ."
    type_check: "mypy ."
    test: "pytest"
    test_integration: "pytest -m integration"
    test_cov: "pytest --cov=. --cov-report=html"
    security: "safety check"
    build: "pip install -e ."

  # Go Stack
  go:
    lint: "golangci-lint run"
    type_check: "go build ./..."
    test: "go test ./..."
    test_integration: "go test -tags=integration ./..."
    test_cov: "go test -coverprofile=coverage.out ./..."
    security: "gosec ./..."
    build: "go build -o bin/app ./cmd/..."

  # Rust Stack
  rust:
    lint: "cargo clippy -- -D warnings"
    type_check: "cargo check"
    test: "cargo test"
    test_integration: "cargo test --test '*'"
    test_cov: "cargo tarpaulin --out Html"
    security: "cargo audit"
    build: "cargo build --release"

  # .NET Stack
  dotnet:
    lint: "dotnet format --verify-no-changes"
    type_check: "dotnet build"
    test: "dotnet test"
    test_integration: "dotnet test --filter Category=Integration"
    test_cov: "dotnet test /p:CollectCoverage=true"
    security: "dotnet list package --vulnerable"
    build: "dotnet publish -c Release"

  # PHP Stack
  laravel:
    lint: "./vendor/bin/phpcs"
    type_check: "./vendor/bin/phpstan analyse"
    test: "./vendor/bin/phpunit"
    test_integration: "./vendor/bin/phpunit --testsuite Integration"
    test_cov: "./vendor/bin/phpunit --coverage-html coverage"
    security: "composer audit"
    build: "composer install --no-dev"

  # Ruby Stack
  rails:
    lint: "rubocop"
    type_check: "srb tc"
    test: "bundle exec rspec"
    test_integration: "bundle exec rspec spec/integration"
    test_cov: "COVERAGE=true bundle exec rspec"
    security: "bundle audit check --update"
    build: "bundle install --deployment"

# ═══════════════════════════════════════════════════════════════
# EVIDENCE TEMPLATES
# ═══════════════════════════════════════════════════════════════

evidence_templates:
  gate_report: |
    # Gate {{gate_id}} Report

    **Date:** {{date}}
    **Project:** {{project_name}}
    **Version:** {{version}}

    ## Summary
    | Metric | Target | Actual | Status |
    |--------|--------|--------|--------|
    {{#each metrics}}
    | {{name}} | {{target}} | {{actual}} | {{status}} |
    {{/each}}

    ## Checklist
    {{#each checklist}}
    - [{{#if completed}}x{{else}} {{/if}}] {{name}}
    {{/each}}

    ## Automated Checks
    {{#each checks}}
    ### {{name}}
    - Command: `{{command}}`
    - Status: {{status}}
    - Output: {{output}}
    {{/each}}

    ## Approvals
    {{#each approvers}}
    - {{role}}: {{#if approved}}✅ Approved{{else}}⏳ Pending{{/if}}
    {{/each}}

    ## Gate Status: {{overall_status}}

  check_summary: |
    # Gate {{gate_id}} Check Summary

    **Timestamp:** {{timestamp}}
    **Commit:** {{commit_sha}}
    **Branch:** {{branch}}

    ## Results
    | Check | Required | Status | Duration |
    |-------|----------|--------|----------|
    {{#each checks}}
    | {{name}} | {{required}} | {{status}} | {{duration}} |
    {{/each}}

    ## Metrics
    {{#each metrics}}
    - **{{name}}:** {{actual}} (target: {{target}}) {{status}}
    {{/each}}

    ## Overall: {{overall_status}}

  ci_output: |
    {
      "gate": "{{gate_id}}",
      "status": "{{status}}",
      "timestamp": "{{timestamp}}",
      "checks": {
        "total": {{checks_total}},
        "passed": {{checks_passed}},
        "failed": {{checks_failed}},
        "warnings": {{checks_warnings}}
      },
      "metrics": {
        {{#each metrics}}
        "{{key}}": {{value}}{{#unless @last}},{{/unless}}
        {{/each}}
      },
      "evidence_path": "{{evidence_path}}"
    }

# ═══════════════════════════════════════════════════════════════
# CUSTOM GATE DEFINITIONS (Project-Specific)
# ═══════════════════════════════════════════════════════════════

custom_gates:
  # Example: Custom security gate
  # SEC1:
  #   name: "Security Review"
  #   prerequisites:
  #     - gate: "G2"
  #       status: "passed"
  #   checklist:
  #     required:
  #       - id: "sec1_pentest"
  #         name: "Penetration Test"
  #         evidence_type: "report"
  #   automated_checks:
  #     - id: "owasp_scan"
  #       name: "OWASP ZAP Scan"
  #       command: "zap-cli quick-scan --self-contained"
  #       required: true

# ═══════════════════════════════════════════════════════════════
# GATE WORKFLOW CONFIGURATION
# ═══════════════════════════════════════════════════════════════

workflow:
  # Standard flow
  standard_flow:
    - D1
    - D2
    - D3
    - D4
    - G2
    - G2.5
    - G3
    - G4

  # Quick flow (for small changes)
  quick_flow:
    - G2
    - G2.5
    - G3
    - G4

  # Feature development flow
  feature_flow:
    - D3
    - G2
    - G2.5
    - G3

  # Hotfix flow
  hotfix_flow:
    - G2
    - G4

  # Design-only flow
  design_flow:
    - D1
    - D2
    - D3
    - D4

# ═══════════════════════════════════════════════════════════════
# SKIP CONDITIONS
# ═══════════════════════════════════════════════════════════════

skip_conditions:
  # Allow skipping optional checks with commit message
  commit_keywords:
    - "[skip-lint]"
    - "[skip-tests]"
    - "[skip-coverage]"
    - "[hotfix]"

  # Environment-based skips
  environments:
    development:
      skip_optional: true
      enforce_required: true
    staging:
      skip_optional: false
      enforce_required: true
    production:
      skip_optional: false
      enforce_required: true

# ═══════════════════════════════════════════════════════════════
# REPORTING CONFIGURATION
# ═══════════════════════════════════════════════════════════════

reporting:
  formats:
    - markdown
    - json
    - html

  output_directory: ".f5/gates"

  include:
    - check_results
    - metrics
    - approvals
    - artifacts
    - timestamps

  archive:
    enabled: true
    format: "zip"
    retention_days: 365
