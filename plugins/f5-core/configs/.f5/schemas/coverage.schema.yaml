# ============================================================================
# COVERAGE DECLARATION SCHEMA V2.1
# ============================================================================
# Schema định nghĩa cấu trúc của Coverage Declaration
# File này dùng để validate _coverage.yaml được tạo bởi f5-classify
#
# Version: 2.1
# Last Updated: 2024-12-25
# Changes: Added statistics, extracted_items_summary, technical_limitations,
#          classification_quality_level
# ============================================================================

$schema: "http://json-schema.org/draft-07/schema#"
$id: "f5-framework/coverage-declaration"
title: "Coverage Declaration Schema V2.1"
description: "Schema for f5-classify coverage declaration output with quality metrics"
version: "2.1"

type: object
required:
  - metadata
  - analyzed_sources
  - confidence
  - approval
  - statistics
  - classification_quality_level

properties:
  # ==========================================================================
  # 1. METADATA
  # ==========================================================================
  metadata:
    type: object
    description: "Thông tin về lần classify"
    required:
      - generated_at
      - generated_by
      - version
      - source_path
    properties:
      generated_at:
        type: string
        format: date-time
        description: "Thời điểm tạo (ISO 8601)"
        example: "2025-12-25T10:00:00+09:00"
      
      generated_by:
        type: string
        description: "Tool/command đã tạo file này"
        enum: ["f5-classify"]
        default: "f5-classify"
      
      version:
        type: integer
        description: "Version number (tăng khi re-classify)"
        minimum: 1
        default: 1
      
      source_path:
        type: string
        description: "Đường dẫn nguồn đã classify"
        example: ".f5/input/raw/excel/0203/"
      
      workflow_template:
        type: string
        description: "Workflow template đang sử dụng"
        example: "f026-app"
      
      expected_sections_file:
        type: string
        description: "File expected-sections.yaml đã dùng"
        example: "workflows/f026-app/expected-sections.yaml"

  # ==========================================================================
  # 2. ANALYZED SOURCES
  # ==========================================================================
  analyzed_sources:
    type: array
    description: "Danh sách các nguồn đã phân tích"
    minItems: 1
    items:
      type: object
      required:
        - file
        - type
        - status
      properties:
        file:
          type: string
          description: "Tên file"
        type:
          type: string
          enum: ["excel", "pdf", "word", "markdown", "csv", "other"]
        classification:
          type: string
          enum: ["DI-SCR", "DD", "DB", "BR", "CONST", "UI-HINT", "OTHER"]
        sheets_processed:
          type: integer
          minimum: 0
        sheets_total:
          type: integer
          minimum: 0
        pages_processed:
          type: integer
          minimum: 0
        pages_total:
          type: integer
          minimum: 0
        scope:
          type: string
        status:
          type: string
          enum: ["complete", "partial", "failed", "classified"]
        note:
          type: string

  # ==========================================================================
  # 3. CLASSIFICATION SUMMARY
  # ==========================================================================
  classification_summary:
    type: object
    description: "Tổng hợp phân loại theo type"
    properties:
      DI-SCR:
        type: integer
        minimum: 0
      DD:
        type: integer
        minimum: 0
      DB:
        type: integer
        minimum: 0
      BR:
        type: integer
        minimum: 0
      CONST:
        type: integer
        minimum: 0
      UI-HINT:
        type: integer
        minimum: 0
      total:
        type: integer
        minimum: 0

  # ==========================================================================
  # 4. CONFIDENCE LEVELS
  # ==========================================================================
  confidence:
    type: object
    description: "Mức độ tin cậy theo loại nội dung"
    additionalProperties:
      type: object
      required:
        - level
      properties:
        level:
          type: string
          enum: ["HIGH", "MEDIUM", "LOW"]
        reason:
          type: string
        issues:
          type: array
          items:
            type: string

  # ==========================================================================
  # 5. MISSING SECTIONS
  # ==========================================================================
  missing_sections:
    type: array
    description: "Các sections expected nhưng không tìm thấy"
    items:
      type: object
      required:
        - key
        - name
        - severity
      properties:
        key:
          type: string
        name:
          type: string
        name_ja:
          type: string
        name_vi:
          type: string
        severity:
          type: string
          enum: ["HIGH", "MEDIUM", "LOW"]
        auto_raise_qa:
          type: boolean
          default: false
        reason:
          type: string
        acknowledged:
          type: boolean
          default: false
        acknowledged_by:
          type: string
        acknowledged_at:
          type: string
          format: date-time
        qa_id:
          type: string

  # ==========================================================================
  # 6. CONFIRMATIONS NEEDED
  # ==========================================================================
  confirmations_needed:
    type: array
    description: "Các điểm cần xác nhận với KH/BA"
    items:
      type: object
      required:
        - id
        - description
        - priority
      properties:
        id:
          type: string
          pattern: "^CONFIRM-[0-9]{3}$"
        description:
          type: string
        source:
          type: object
          properties:
            file:
              type: ["string", "null"]
            location:
              type: string
        priority:
          type: string
          enum: ["HIGH", "MEDIUM", "LOW"]
        resolved:
          type: boolean
          default: false
        resolution:
          type: string
        resolved_by:
          type: string
        resolved_at:
          type: string
          format: date-time

  # ==========================================================================
  # 7. UNCERTAINTIES
  # ==========================================================================
  uncertainties:
    type: array
    description: "Các điểm không chắc chắn"
    items:
      type: object
      required:
        - id
        - severity
        - description
      properties:
        id:
          type: string
          pattern: "^U-[0-9]{3}$"
        severity:
          type: string
          enum: ["high", "medium", "low"]
        impact:
          type: string
          enum: ["core_content", "missing_section", "ambiguity", "technical"]
        description:
          type: string
        source:
          type: string
        suggestion:
          type: string
        status:
          type: string
          enum: ["open", "resolved", "acknowledged"]

  # ==========================================================================
  # 8. STATISTICS (NEW in V2.1)
  # ==========================================================================
  statistics:
    type: object
    description: "Thống kê tổng hợp - Trả lời: Classify tốt tới mức nào?"
    required:
      - total_files_analyzed
      - coverage_percentage
    properties:
      # File metrics
      total_files_analyzed:
        type: integer
        description: "Tổng số files đã xử lý"
        minimum: 0
      
      files_by_type:
        type: object
        description: "Số files theo loại"
        properties:
          excel:
            type: integer
            minimum: 0
          pdf:
            type: integer
            minimum: 0
          markdown:
            type: integer
            minimum: 0
          word:
            type: integer
            minimum: 0
          csv:
            type: integer
            minimum: 0
      
      # Classification metrics
      items_classified:
        type: integer
        description: "Số items đã phân loại"
        minimum: 0
      
      items_by_classification:
        type: object
        description: "Số items theo classification type"
        additionalProperties:
          type: integer
          minimum: 0
      
      # Coverage metrics
      sections_expected:
        type: integer
        description: "Số sections expected (từ expected-sections.yaml)"
        minimum: 0
      
      sections_found:
        type: integer
        description: "Số sections đã tìm thấy"
        minimum: 0
      
      sections_missing:
        type: integer
        description: "Số sections thiếu"
        minimum: 0
      
      sections_missing_by_severity:
        type: object
        description: "Số sections thiếu theo severity"
        properties:
          HIGH:
            type: integer
            minimum: 0
          MEDIUM:
            type: integer
            minimum: 0
          LOW:
            type: integer
            minimum: 0
      
      coverage_percentage:
        type: number
        description: "% coverage = sections_found / sections_expected * 100"
        minimum: 0
        maximum: 100
      
      # Quality metrics
      confidence_distribution:
        type: object
        description: "Phân bố confidence levels"
        properties:
          HIGH:
            type: integer
            minimum: 0
          MEDIUM:
            type: integer
            minimum: 0
          LOW:
            type: integer
            minimum: 0
      
      average_confidence:
        type: string
        description: "Confidence trung bình"
        enum: ["HIGH", "MEDIUM", "LOW"]
      
      # Action items
      confirmations_total:
        type: integer
        minimum: 0
      
      confirmations_resolved:
        type: integer
        minimum: 0
      
      uncertainties_total:
        type: integer
        minimum: 0
      
      uncertainties_resolved:
        type: integer
        minimum: 0

  # ==========================================================================
  # 9. EXTRACTED ITEMS SUMMARY (NEW in V2.1)
  # ==========================================================================
  extracted_items_summary:
    type: object
    description: "Tóm tắt extraction - Trả lời: Vì sao một số thứ chưa làm được?"
    required:
      - extraction_status
    properties:
      # Overall metrics
      total_items_expected:
        type: integer
        description: "Số items expected (estimate)"
        minimum: 0
      
      total_items_extracted:
        type: integer
        description: "Số items thực sự extracted"
        minimum: 0
      
      extraction_rate_percentage:
        type: number
        description: "% extraction = extracted / expected * 100"
        minimum: 0
        maximum: 100
      
      # Status explanation
      extraction_status:
        type: string
        description: "Trạng thái extraction tổng thể"
        enum: ["full", "partial", "structure_only", "failed"]
      
      extraction_notes:
        type: array
        description: "Ghi chú về extraction"
        items:
          type: string
      
      # What was extracted
      structure_extracted:
        type: array
        description: "Những gì đã extract được"
        items:
          type: object
          properties:
            type:
              type: string
            count:
              type: integer
              minimum: 0
            confidence:
              type: string
              enum: ["HIGH", "MEDIUM", "LOW", "N/A"]
            description:
              type: string
      
      # What was not extracted
      content_not_extracted:
        type: array
        description: "Những gì KHÔNG extract được"
        items:
          type: object
          required:
            - type
            - reason
          properties:
            type:
              type: string
            reason:
              type: string
            workaround:
              type: string
      
      # Reference to detailed files
      detailed_mappings_available_in:
        type: array
        description: "Files chứa source mapping chi tiết"
        items:
          type: string

  # ==========================================================================
  # 10. TECHNICAL LIMITATIONS (NEW in V2.1)
  # ==========================================================================
  technical_limitations:
    type: object
    description: "Giới hạn kỹ thuật - Minh bạch thay vì che giấu"
    required:
      - has_limitations
    properties:
      has_limitations:
        type: boolean
        description: "Có giới hạn kỹ thuật không"
      
      limitations:
        type: array
        description: "Danh sách các giới hạn"
        items:
          type: object
          required:
            - id
            - type
            - description
            - severity
          properties:
            id:
              type: string
              pattern: "^LIMIT-[0-9]{3}$"
            type:
              type: string
              enum: ["file_format", "size", "encoding", "api", "timeout", "other"]
            name:
              type: string
            description:
              type: string
            affected_files:
              type: integer
              minimum: 0
            affected_percentage:
              type: number
              minimum: 0
              maximum: 100
            impact:
              type: string
            workaround:
              type: string
            status:
              type: string
              enum: ["known_limitation", "temporary", "will_fix"]
            severity:
              type: string
              enum: ["HIGH", "MEDIUM", "LOW"]
      
      # Capability matrix
      extraction_capabilities:
        type: object
        description: "Ma trận khả năng extraction"
        additionalProperties:
          type: object
          properties:
            supported:
              type: boolean
            confidence:
              type: string
              enum: ["HIGH", "MEDIUM", "LOW", "N/A"]
            note:
              type: string

  # ==========================================================================
  # 11. CLASSIFICATION QUALITY LEVEL (NEW in V2.1)
  # ==========================================================================
  classification_quality_level:
    type: object
    description: "Mức chất lượng - ONE-GLANCE DECISION"
    required:
      - level
      - recommendation
    properties:
      # ⭐ PRIMARY FIELD
      level:
        type: string
        description: "Mức chất lượng tổng thể"
        enum: ["HIGH", "MEDIUM", "LOW"]
      
      # Score breakdown
      scores:
        type: object
        description: "Chi tiết điểm từng component"
        properties:
          coverage:
            type: number
            minimum: 0
            maximum: 100
          confidence:
            type: number
            minimum: 0
            maximum: 100
          extraction:
            type: number
            minimum: 0
            maximum: 100
          composite:
            type: number
            minimum: 0
            maximum: 100
      
      # Penalties
      penalties:
        type: array
        description: "Các penalty đã áp dụng"
        items:
          type: object
          properties:
            reason:
              type: string
            points:
              type: number
      
      # Final calculation
      raw_score:
        type: number
        minimum: 0
        maximum: 100
      
      penalty_total:
        type: number
        maximum: 0
      
      adjusted_score:
        type: number
        minimum: 0
        maximum: 100
      
      # Thresholds
      thresholds:
        type: object
        properties:
          HIGH:
            type: string
          MEDIUM:
            type: string
          LOW:
            type: string
      
      # Explanation
      determined_by:
        type: string
      
      level_explanation:
        type: string
      
      # ⭐ HUMAN-READABLE SUMMARY (4 lines max)
      summary:
        type: string
        description: "Tóm tắt 4 dòng để đọc nhanh"
      
      # Recommendation
      recommendation:
        type: string
        description: "Khuyến nghị hành động"
        enum: [
          "auto_approve",
          "review_and_approve",
          "review_and_acknowledge",
          "manual_intervention_required"
        ]
      
      recommendation_details:
        type: array
        description: "Chi tiết khuyến nghị"
        items:
          type: string
      
      # Gate impact
      can_auto_approve:
        type: boolean
        description: "Có thể auto approve không"
      
      requires_acknowledgment:
        type: boolean
        description: "Cần acknowledge missing sections không"
      
      blocks_d1_gate:
        type: boolean
        description: "Có block D1 gate không"

  # ==========================================================================
  # 12. APPROVAL STATUS
  # ==========================================================================
  approval:
    type: object
    description: "Trạng thái approval"
    required:
      - approved
    properties:
      approved:
        type: boolean
        default: false
      
      approved_by:
        type: ["string", "null"]
      
      approved_at:
        type: ["string", "null"]
        format: date-time
      
      note:
        type: ["string", "null"]
      
      acknowledged_missing:
        type: array
        items:
          type: string
      
      previous_versions:
        type: array
        description: "Audit trail"
        items:
          type: object
          properties:
            version:
              type: integer
            approved_by:
              type: string
            approved_at:
              type: string
              format: date-time
            note:
              type: string

# ============================================================================
# EXAMPLES
# ============================================================================
examples:
  - metadata:
      generated_at: "2025-12-25T10:00:00+09:00"
      generated_by: "f5-classify"
      version: 1
      source_path: ".f5/input/raw/excel/0203/"
      workflow_template: "f026-app"
    
    statistics:
      total_files_analyzed: 8
      coverage_percentage: 26.7
      sections_expected: 15
      sections_found: 4
      sections_missing_by_severity:
        HIGH: 2
        MEDIUM: 2
        LOW: 0
    
    classification_quality_level:
      level: MEDIUM
      summary: |
        ✓ File classification: 8/8 files (100%)
        ⚠ Content extraction: 0% (Excel binary)
        ⚠ Coverage: 4/15 sections (26.7%)
        ⚠ 2 HIGH severity sections missing
      recommendation: "review_and_acknowledge"
      can_auto_approve: false
    
    approval:
      approved: false
