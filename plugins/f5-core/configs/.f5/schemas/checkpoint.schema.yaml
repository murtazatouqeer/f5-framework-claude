# Checkpoint Schema
# Defines the structure for session checkpoints

$schema: "http://json-schema.org/draft-07/schema#"
title: "F5 Checkpoint Schema"
description: "Schema for session state checkpoints"
type: object

required:
  - name
  - created_at
  - version
  - session_id

properties:
  name:
    type: string
    pattern: "^[a-z0-9][a-z0-9-_]*$"
    description: "Unique checkpoint name (lowercase, alphanumeric with hyphens/underscores)"
    minLength: 1
    maxLength: 64

  created_at:
    type: string
    format: date-time
    description: "ISO 8601 timestamp of checkpoint creation"

  version:
    type: string
    pattern: "^\\d+\\.\\d+\\.\\d+$"
    description: "F5 Framework version at checkpoint time"

  session_id:
    type: string
    pattern: "^sess_\\d{8}_\\d{6}$"
    description: "Parent session identifier"

  description:
    type: string
    maxLength: 500
    description: "Human-readable description of checkpoint state"

  tags:
    type: array
    items:
      type: string
      pattern: "^[a-z0-9-]+$"
    maxItems: 10
    description: "Categorization tags (e.g., milestone, backup, feature)"

  auto_generated:
    type: boolean
    default: false
    description: "Whether checkpoint was auto-generated"

  contents:
    type: object
    properties:
      conversation:
        type: object
        properties:
          token_count:
            type: integer
            minimum: 0
          turn_count:
            type: integer
            minimum: 0
          summary_hash:
            type: string
        description: "Conversation state summary"

      tasks:
        type: object
        properties:
          pending:
            type: integer
            minimum: 0
          in_progress:
            type: integer
            minimum: 0
          completed:
            type: integer
            minimum: 0
          total:
            type: integer
            minimum: 0
        description: "TodoWrite task statistics"

      gates:
        type: object
        properties:
          current:
            type: string
            enum: ["D1", "D2", "D3", "D4", "G2", "G3", "G4"]
          progress:
            type: object
            additionalProperties:
              type: string
              enum: ["pending", "in_progress", "passed", "failed"]
        description: "Quality gate status"

      memory:
        type: object
        properties:
          count:
            type: integer
            minimum: 0
          categories:
            type: object
            additionalProperties:
              type: integer
          snapshot_ref:
            type: string
        description: "Memory state reference"

      codebase:
        type: object
        properties:
          indexed_at:
            type: string
            format: date-time
          document_count:
            type: integer
            minimum: 0
          project_id:
            type: string
        description: "Codebase index reference"

      context:
        type: object
        properties:
          files:
            type: array
            items:
              type: string
            maxItems: 50
          recent_edits:
            type: array
            items:
              type: string
            maxItems: 20
        description: "File context state"

      decisions:
        type: array
        items:
          type: object
          properties:
            id:
              type: string
            summary:
              type: string
            timestamp:
              type: string
              format: date-time
        maxItems: 50
        description: "Architectural decisions made"

      blockers:
        type: array
        items:
          type: object
          properties:
            id:
              type: string
            description:
              type: string
            severity:
              type: string
              enum: ["low", "medium", "high", "critical"]
        maxItems: 10
        description: "Active blockers or issues"

  metadata:
    type: object
    properties:
      size_bytes:
        type: integer
        minimum: 0
      files:
        type: array
        items:
          type: string
      restore_count:
        type: integer
        minimum: 0
        default: 0
    description: "Checkpoint metadata"

# Examples
examples:
  - name: "pre-refactor"
    created_at: "2024-01-15T14:30:00Z"
    version: "1.2.4"
    session_id: "sess_20240115_143022"
    description: "Before auth system refactoring"
    tags: ["milestone", "architecture"]
    auto_generated: false
    contents:
      conversation:
        token_count: 25000
        turn_count: 15
        summary_hash: "abc123"
      tasks:
        pending: 3
        in_progress: 1
        completed: 5
        total: 9
      gates:
        current: "G2"
        progress:
          D1: "passed"
          D2: "passed"
          D3: "passed"
          G2: "in_progress"
      memory:
        count: 12
        categories:
          preferences: 3
          context: 5
          decisions: 4
      codebase:
        indexed_at: "2024-01-15T10:00:00Z"
        document_count: 423
        project_id: "user-management"
      context:
        files:
          - "src/auth/auth.service.ts"
          - "src/auth/auth.controller.ts"
      decisions:
        - id: "dec_001"
          summary: "Use RS256 for JWT signing"
          timestamp: "2024-01-15T14:00:00Z"
      blockers: []
    metadata:
      size_bytes: 15360
      files:
        - "metadata.yaml"
        - "conversation.md"
        - "tasks.yaml"
        - "memory.json"
      restore_count: 0
